// Aureus Social Pro v20.2
"use client"
import { useState, useReducer, useRef, useMemo, useEffect, useCallback, createContext, useContext } from "react";
import dynamic from "next/dynamic";
import { I18N } from "./lib/i18n";
const AccessManagement = dynamic(() => import("./modules/AccessManagement"), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const CommissionsModule = dynamic(() => import("./modules/CommissionsModule"), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const TwoFactorSetup = dynamic(() => import("./modules/TwoFactorSetup"), { ssr: false });
const ProceduresRHHub = dynamic(() => import("./modules/ProceduresRHHub"), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const AdminBaremes = dynamic(() => import("./modules/AdminBaremes"), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const AureusSuitePageLazy = dynamic(() => import("./modules/AureusSuitePage"), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const _DocForms = dynamic(() => import("./modules/DocumentForms"), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const CompteIndividuelAnnuelLazy = dynamic(() => import("./modules/DocumentForms").then(m => ({ default: m.CompteIndividuelAnnuel })), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const FormulaireC4Lazy = dynamic(() => import("./modules/DocumentForms").then(m => ({ default: m.FormulaireC4 })), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const FormulaireC131Lazy = dynamic(() => import("./modules/DocumentForms").then(m => ({ default: m.FormulaireC131 })), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const FormulaireAccidentTravailLazy = dynamic(() => import("./modules/DocumentForms").then(m => ({ default: m.FormulaireAccidentTravail })), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const AnnexeReglementTravailLazy = dynamic(() => import("./modules/DocumentForms").then(m => ({ default: m.AnnexeReglementTravail })), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });
const Belcotax281ModLazy = dynamic(() => import("./modules/DocumentForms").then(m => ({ default: m.Belcotax281Mod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:'center',color:'#5e5c56'}}>Chargement...</div> });

const ODModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ODMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CRModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.CRMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const DRSModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.DRSMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PointageModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.PointageMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SyndicalesModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.SyndicalesMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ONSSAPLModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ONSSAPLMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ETAModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ETAMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ExportImportModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ExportImportMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const DecavaModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.DecavaMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const BilanSocialModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.BilanSocialMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ProvisionsModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ProvisionsMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CumulsModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.CumulsMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AssLoiModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.AssLoiMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AssGroupeModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.AssGroupeMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const MedTravailModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.MedTravailMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AllocFamModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.AllocFamMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SecteursModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.SecteursMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ReglementTravailModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ReglementTravailMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ContratsTravailModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ContratsTravailMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const WorkflowEmbaucheModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.WorkflowEmbaucheMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const WorkflowLicenciementModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.WorkflowLicenciementMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const WorkflowMaladieModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.WorkflowMaladieMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PredictionTurnoverModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.PredictionTurnoverMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PrevisionMasseModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.PrevisionMasseMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ScoreSanteModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ScoreSanteMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const MultiCurrencyModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.MultiCurrencyMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AbsencesModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.AbsencesMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const DocumentsJuridiquesModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.DocumentsJuridiquesMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AlertesLegalesModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.AlertesLegalesMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const BilanSocialBNBModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.BilanSocialBNBMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CO2ModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.CO2Mod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CertPMEModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.CertPMEMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const EcoCommandeModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.EcoCommandeMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PeculeSortieModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.PeculeSortieMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const IndexAutoModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.IndexAutoMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CafeteriaModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.CafeteriaMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const BudgetMobiliteModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.BudgetMobiliteMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PlanFormationModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.PlanFormationMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const NoteFraisModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.NoteFraisMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const TransportDomTravModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.TransportDomTravMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CSSModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.CSSMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const BonusEmploiModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.BonusEmploiMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const TotalRewardModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.TotalRewardMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ATNModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ATNMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ChomTempModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ChomTempMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CongeEducModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.CongeEducMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const OutplacementModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.OutplacementMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const OnboardingModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.OnboardingMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const RegistrePersonnelModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.RegistrePersonnelMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AbsenteismeModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.AbsenteismeMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PlanGlobalModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.PlanGlobalMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PAAModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.PAAMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const RisquesPsychoModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.RisquesPsychoMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AlcoolModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.AlcoolMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const OrganesModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.OrganesMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ElectionsModLazy = dynamic(() => import("./modules/ModsBatch1").then(m => ({ default: m.ElectionsMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });

const GuidePortailModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.GuidePortailMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const FraisGestionModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.FraisGestionMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const EnvoiModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.EnvoiMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const FichesModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.FichesMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PortailEmployeurModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.PortailEmployeurMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const NetBrutModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.NetBrutMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const RentesModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.RentesMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CaisseVacModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.CaisseVacMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PeppolModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.PeppolMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CompteIndividuelModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.CompteIndividuelMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AccountingOutputModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.AccountingOutputMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const RecoSalaireModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.RecoSalaireMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const DetectionAnomaliesModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.DetectionAnomaliesMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const APIDocModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.APIDocMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const MarketplaceModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.MarketplaceMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const IntegrationsModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.IntegrationsMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const WebhookManagerModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.WebhookManagerMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const BudgetAutoModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.BudgetAutoMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SimulateurWhatIfModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.SimulateurWhatIfMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const KPIDashboardModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.KPIDashboardMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AutomationsModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.AutomationsMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SchedulerModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.SchedulerMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const TemplatesModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.TemplatesMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PreavisModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.PreavisMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CreditTempsModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.CreditTempsMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CCT90ModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.CCT90Mod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const StatsINSModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.StatsINSMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const WarrantsModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.WarrantsMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const HeuresSupModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.HeuresSupMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SimCoutModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.SimCoutMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const RCCModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.RCCMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AidesEmploiModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.AidesEmploiMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AuditModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.AuditMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AuditSecuriteCodeLazy = dynamic(() => import("./modules/AuditSecuriteCode").then(m => ({ default: m.AuditSecuriteCode })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SelfServiceModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.SelfServiceMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const GEDModLazy = dynamic(() => import("./modules/ModsBatch2").then(m => ({ default: m.GEDMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });

const ONSSDashModLazy = dynamic(() => import("./modules/ModsBatch3").then(m => ({ default: m.ONSSDashMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SaisiesModLazy = dynamic(() => import("./modules/ModsBatch3").then(m => ({ default: m.SaisiesMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SEPAModLazy = dynamic(() => import("./modules/ModsBatch3").then(m => ({ default: m.SEPAMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SimulateurNetBrutModLazy = dynamic(() => import("./modules/ModsBatch3").then(m => ({ default: m.SimulateurNetBrutMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const TreizMoisModLazy = dynamic(() => import("./modules/ModsBatch3").then(m => ({ default: m.TreizMoisMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const OffboardingModLazy = dynamic(() => import("./modules/ModsBatch3").then(m => ({ default: m.OffboardingMod })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ClotureMensuelleLazy = dynamic(() => import("./modules/ClotureMensuelle"), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PortailClientSSLazy = dynamic(() => import("./modules/PortailClientSS"), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const FloatingLegalAgentLazy = dynamic(() => import("./modules/FloatingLegalAgent"), { ssr: false, loading: () => null });

const TableauDirectionLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.TableauDirection })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const TableauBordDirectionLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.TableauBordDirection })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const GestionPrimesLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.GestionPrimes })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const EcheancierPaiementsLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.EcheancierPaiements })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const EcheancierLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.Echeancier })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const GestionVehiculesLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.GestionVehicules })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PromesseEmbaucheLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.PromesseEmbauche })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CalcJoursPrestesLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.CalcJoursPrestes })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const WorkflowAbsencesLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.WorkflowAbsences })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const RegulPPAnnuelleLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.RegulPPAnnuelle })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ExportWinbooksLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ExportWinbooks })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ParserImportConcurrentLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ParserImportConcurrent })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ComingSoonLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ComingSoon })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ActionsRapidesLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ActionsRapides })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AnalyticsDashLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.AnalyticsDash })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ArchivesNumeriquesLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ArchivesNumeriques })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AuditTrailLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.AuditTrail })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AuthMultiRolesLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.AuthMultiRoles })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AutoIndexationLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.AutoIndexation })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const AutomationHubLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.AutomationHub })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const BudgetPrevLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.BudgetPrev })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CalendrierSocialLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.CalendrierSocial })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ChecklistClientLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ChecklistClient })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const CommandCenterLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.CommandCenter })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ComparatifConcurrentsLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ComparatifConcurrents })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ContratGeneratorLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ContratGenerator })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ConventionsCollectivesLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ConventionsCollectives })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const EnvoiMasseLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.EnvoiMasse })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const FacturationTarifLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.FacturationTarif })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const HistoriquePiloteLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.HistoriquePilote })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const IntegrationsHubLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.IntegrationsHub })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const JournalActiviteLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.JournalActivite })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const LandingPageLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.LandingPage })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const MassEngineLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.MassEngine })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const MonitoringSanteLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.MonitoringSante })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const OnboardingWizardLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.OnboardingWizard })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PayrollTimelineLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.PayrollTimeline })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PiloteAutoLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.PiloteAuto })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PortailEmployeLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.PortailEmploye })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const PortalManagerLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.PortalManager })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ProcessingQueueLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ProcessingQueue })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const RGPDManagerLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.RGPDManager })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const RecapEmployeurLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.RecapEmployeur })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SecuriteDataLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.SecuriteData })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SetupWizardLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.SetupWizard })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SimuOptiFiscaleLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.SimuOptiFiscale })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SmartAlertsLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.SmartAlerts })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SmartAutomationLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.SmartAutomation })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const SmartAutopilotLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.SmartAutopilot })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const TestSuiteDashLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.TestSuiteDash })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const ValidationEngineLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.ValidationEngine })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });
const RegularisationPPLazy = dynamic(() => import("./modules/SprintComponents").then(m => ({ default: m.RegulPPAnnuelle })), { ssr: false, loading: () => <div style={{padding:40,textAlign:"center",color:"#5e5c56"}}>Chargement...</div> });

// ═══ SPRINT 37: MOTEUR CENTRAL LOIS BELGES — AUTO-UPDATE 1 CLIC  ═══
// ══════════════════════════════════════════════════════════════════════
// Base centralisée de TOUTES les constantes légales belges
// Un seul endroit à modifier → propage partout automatiquement



var LOIS_BELGES = {
  _meta: { version: '2026.1.0', dateMAJ: '2026-01-01', source: 'SPF Finances / ONSS / CNT / Moniteur Belge', annee: 2026 },

  // ═══ ONSS ═══
  onss: {
    travailleur: 0.1307,
    employeur: { total: 0.2507, detail: { pension: 0.0886, maladie: 0.0370, chomage: 0.0138, accidents: 0.0087, maladiesPro: 0.0102, fermeture: 0.0012, moderation: 0.0560, cotisationsSpec: 0.0352 }},
    plafondAnnuel: null, // pas de plafond en Belgique
    ouvrier108: 1.08, // majoration 8% ouvriers
    reductionStructurelle: { seuil: 9932.40, forfait: 0, pctAuDessus: 0 },
    groupeCible: { jeunesNonQualifies: { age: 25, reduc: 1500 }, agees: { age: 55, reduc: 1500 }, handicapes: { reduc: 1500 }},
  },

  // ═══ PRÉCOMPTE PROFESSIONNEL ═══
  pp: {
    tranches: [
      { min: 0, max: 16710, taux: 0.2675 },
      { min: 16710, max: 29500, taux: 0.4280 },
      { min: 29500, max: 51050, taux: 0.4815 },
      { min: 51050, max: Infinity, taux: 0.5350 },
    ],
    fraisPro: { salarie: { pct: 0.30, max: 6070 }, dirigeant: { pct: 0.03, max: 3120 }},
    quotiteExemptee: { bareme1: 2987.98, bareme2: 5975.96 },
    quotientConjugal: { pct: 0.30, max: 12520 },
    reductionsEnfants: [0, 624, 1656, 4404, 7620, 11100, 14592, 18120, 21996],
    reductionEnfantSupp: 3864,
    reductionParentIsole: 624,
    reductionHandicape: 624,
    reductionConjointHandicape: 624,
    reductionConjointRevenuLimite: 1698,
    reductionConjointPensionLimitee: 3390,
    reductionPersonne65: 1992,
    reductionAutreCharge: 624,
    bonusEmploi: { pctReduction: 0.3314, maxMensuel: 194.03, seuilBrut1: 2561.42, seuilBrut2: 2997.59 },
  },

  // ═══ CSSS — Cotisation Spéciale Sécurité Sociale ═══
  csss: {
    isole: [
      { min: 0, max: 18592.02, montant: 0, taux: 0 },
      { min: 18592.02, max: 21070.96, montant: 0, taux: 0.076 },
      { min: 21070.96, max: 37344.02, montant: 9.30, taux: 0.011 },
      { min: 37344.02, max: 60181.95, montant: 9.30, tauxBase: 0.011, taux: 0.013, palierBase: 37344.02 },
      { min: 60181.95, max: Infinity, montantFixe: 51.64 },
    ],
    menage2revenus: [
      { min: 0, max: 18592.02, montant: 0, taux: 0 },
      { min: 18592.02, max: 21070.96, montant: 0, taux: 0.076 },
      { min: 21070.96, max: 60181.95, montant: 9.30, taux: 0.011 },
      { min: 60181.95, max: Infinity, montantFixe: 51.64 },
    ],
    menage1revenu: [
      { min: 0, max: 18592.02, montant: 0, taux: 0 },
      { min: 18592.02, max: 21070.96, montant: 0, taux: 0.076 },
      { min: 21070.96, max: 37344.02, montant: 9.30, taux: 0.011 },
      { min: 37344.02, max: 60181.95, montant: 0, taux: 0.013 },
      { min: 60181.95, max: Infinity, montantFixe: 51.64 },
    ],
  },

  // ═══ RÉMUNÉRATION ═══
  rémunération: {
    RMMMG: { montant18ans: 2070.48, montant20ans6m: 2070.48, montant21ans12m: 2070.48, source: 'CNT - CCT 43/15' },
    indexSante: { coeff: 2.0399, pivot: 125.60, dateDerniereIndex: '2024-12-01', prochainPivotEstime: '2026-06-01' },
    peculeVacances: {
      simple: { pct: 0.0767, base: 'brut annuel precedent' },
      double: { pct: 0.9200, base: 'brut mensuel' },
      patronal: { pct: 0.1535, base: 'brut annuel precedent' },
      ouvrierDouble: { pct: 0.0858, base: 'brut ouvrier x 108%' },
    },
    treizieme: { obligatoire: true, cp200: true, base: 'salaire mensuel brut', onss: true },
  },

  // ═══ CHÈQUES-REPAS ═══
  chequesRepas: {
    partTravailleur: { min: 1.09, max: null },
    valeurFaciale: { max: 8.00 },
    partPatronale: { max: 6.91 },
    conditions: 'Par jour effectivement preste',
    exonerationFiscale: true,
    exonerationONSS: true,
  },

  // ═══ FRAIS PROPRES EMPLOYEUR ═══
  fraisPropres: {
    forfaitBureau: { max: 154.74, base: 'mensuel' },
    forfaitDeplacement: { voiture: 0.4415, velo: 0.35, transportCommun: 1.00 },
    forfaitRepresentation: { max: 40, base: 'mensuel sans justificatif' },
    teletravail: { max: 154.74, base: 'mensuel structurel' },
  },


  // ═══ AVANTAGES — ALIAS POUR MODULES ═══
  avantages: {
    fraisPropres: {
      bureau: 154.74,
      km: 0.4415,
      repas: 19.22,
      teletravail: 154.74,
    },
    atnGSM: 3,
    atnPC: 6,
    atnInternet: 5,
    ecoMax: 250,
  },


  // ═══ COTISATIONS SPÉCIALES ═══
  cotisations: {
    cotCO2Min: 31.34,
    plafondONSS: 75038.09,
    flexiJob: { plafond: 12000, taux: 0.2807 },
  },

  // ═══ ATN — AVANTAGES EN NATURE ═══
  atn: {
    voiture: { CO2Ref: { essence: 102, diesel: 84, hybride: 84 }, coeff: 0.055, min: 1600, formule: '(catalogue x 6/7 x vetuste) x %CO2 / 12' },
    logement: { cadastralx100: true, meuble: 1.333 },
    gsm: { forfait: 3, mensuel: true },
    pc: { forfait: 6, mensuel: true },
    internet: { forfait: 5, mensuel: true },
    electricite: { cadre: 2130, noncadre: 960, annuel: true },
    chauffage: { cadre: 4720, noncadre: 2130, annuel: true },
  },

  // ═══ PRÉAVIS (CCT 109 / Loi Statut Unique) ═══
  preavis: {
    // Durée en semaines par ancienneté (années)
    employeur: [
      { ancMin: 0, ancMax: 0.25, semaines: 1 },
      { ancMin: 0.25, ancMax: 0.5, semaines: 3 },
      { ancMin: 0.5, ancMax: 0.75, semaines: 4 },
      { ancMin: 0.75, ancMax: 1, semaines: 5 },
      { ancMin: 1, ancMax: 2, semaines: 6 },
      { ancMin: 2, ancMax: 3, semaines: 7 },
      { ancMin: 3, ancMax: 4, semaines: 9 },
      { ancMin: 4, ancMax: 5, semaines: 12 },
      { ancMin: 5, ancMax: 6, semaines: 15 },
      { ancMin: 6, ancMax: 7, semaines: 18 },
      { ancMin: 7, ancMax: 8, semaines: 21 },
      { ancMin: 8, ancMax: 9, semaines: 24 },
      { ancMin: 9, ancMax: 10, semaines: 27 },
      { ancMin: 10, ancMax: 11, semaines: 30 },
      { ancMin: 11, ancMax: 12, semaines: 33 },
      { ancMin: 12, ancMax: 13, semaines: 36 },
      { ancMin: 13, ancMax: 14, semaines: 39 },
      { ancMin: 14, ancMax: 15, semaines: 42 },
      { ancMin: 15, ancMax: 16, semaines: 45 },
      { ancMin: 16, ancMax: 17, semaines: 48 },
      { ancMin: 17, ancMax: 18, semaines: 51 },
      { ancMin: 18, ancMax: 19, semaines: 54 },
      { ancMin: 19, ancMax: 20, semaines: 57 },
      { ancMin: 20, ancMax: 21, semaines: 60 },
      { ancMin: 21, ancMax: 22, semaines: 62 },
      { ancMin: 22, ancMax: 23, semaines: 63 },
      { ancMin: 23, ancMax: 24, semaines: 64 },
      { ancMin: 24, ancMax: 25, semaines: 65 },
    ],
    parAnSupp: 3, // +3 semaines par année > 25 ans
    travailleur: { facteur: 0.5, min: 1, max: 13 },
    motifGrave: 0,
    outplacement: { seuil: 30, semaines: 4 },
  },

  // ═══ TEMPS DE TRAVAIL ═══
  tempsTravail: {
    dureeHebdoLegale: 38,
    dureeHebdoMax: 38,
    heuresSupp: { majoration50: 0.50, majoration100: 1.00, recuperation: true, plafondAnnuel: 120, plafondVolontaire: 360 },
    nuit: { debut: '20:00', fin: '06:00', majoration: 0 },
    dimanche: { majoration: 1.00, repos: true },
    jourFerie: { nombre: 10, majoration: 2.00, remplacement: true },
    petitChomage: { mariage: 2, deces1: 3, deces2: 1, communion: 1, demenagement: 1 },
  },

  // ═══ CONTRATS ═══
  contrats: {
    periodeEssai: { supprimee: true, exception: 'travail etudiant/interim/occupation temporaire' },
    clauseNonConcurrence: { dureeMax: 12, brut_min: 42441, indemniteMin: 0.50 },
    ecolecholage: { dureeMax: 36, brut_min: 39422, formationMin: 80 },
  },

  // ═══ SEUILS SOCIAUX ═══
  seuils: {
    electionsSociales: { cppt: 50, ce: 100 },
    planFormation: 20,
    bilanSocial: 20,
    reglementTravail: 1,
    delegationSyndicale: { cp200: 50 },
    servicePPT: { interne: 20 },
    conseillerPrevention: { interne: 20 },
  },

  // ═══ ASSURANCES ═══
  assurances: {
    accidentTravail: { taux: 0.01, obligatoire: true },
    medecineTravail: { cout: 91.50, parTravailleur: true, annuel: false },
    assuranceLoi: { obligatoire: true },
    assuranceGroupe: { deductible: true, plafond80pct: true },
  },

  // ═══ ALLOCATIONS FAMILIALES (Région Bruxelles) ═══
  allocFamBxl: {
    base: { montant: 171.08, parEnfant: true },
    supplement1218: 29.64,
    supplementSocial: { plafondRevenu: 35978, montant: 54.38 },
    primeNaissance: { premier: 1214.73, suivants: 607.37 },
  },

  // ═══ DIMONA ═══
  dimona: {
    delaiIN: 'Avant debut prestations',
    delaiOUT: 'Le jour meme',
    types: ['IN','OUT','UPDATE','CANCEL'],
    canal: 'Portail sécurité sociale ou batch',
    sanctionNiveau: 3,
  },

  // ═══ DMFA ═══
  dmfa: {
    periodicite: 'Trimestrielle',
    delai: 'Dernier jour du mois suivant le trimestre',
    format: 'XML via batch ou portail',
    cotisationsPNP: true,
  },

  // ═══ BELCOTAX ═══
  belcotax: {
    delai: '1er mars annee N+1',
    format: 'XML BelcotaxOnWeb',
    fiches: ['281.10','281.13','281.14','281.20','281.30','281.50'],
  },

  // ═══ SOURCES OFFICIELLES ═══
  sources: [
    { id: 'spf', nom: 'SPF Finances', url: 'https://finances.belgium.be/fr/entreprises/personnel_et_rémunération/precompte_professionnel', type: 'PP/Fiscal' },
    { id: 'onss', nom: 'ONSS', url: 'https://www.socialsecurity.be', type: 'Cotisations sociales' },
    { id: 'cnt', nom: 'Conseil National du Travail', url: 'https://www.cnt-nar.be', type: 'CCT/RMMMG' },
    { id: 'spf_emploi', nom: 'SPF Emploi', url: 'https://emploi.belgique.be', type: 'Droit du travail' },
    { id: 'moniteur', nom: 'Moniteur Belge', url: 'https://www.ejustice.just.fgov.be/cgi/summary.pl', type: 'Legislation' },
    { id: 'statbel', nom: 'Statbel', url: 'https://statbel.fgov.be/fr/themes/prix-la-consommation/indice-sante', type: 'Index/Prix' },
    { id: 'bnb', nom: 'Banque Nationale', url: 'https://www.nbb.be', type: 'Bilan social' },
    { id: 'refli', nom: 'Refli.be', url: 'https://refli.be/fr/documentation/computation/tax', type: 'Reference technique' },
  ],
};

// Aliases courts pour accès rapide dans tout le code
var LB=LOIS_BELGES;
var TX_ONSS_W=LB.onss.travailleur; // 0.1307
var TX_ONSS_E=LB.onss.employeur.total; // 0.2507
var TX_OUV108=LB.onss.ouvrier108; // 1.08
var TX_AT=LB.assurances.accidentTravail.taux; // 0.01
var COUT_MED=LB.assurances.medecineTravail.cout; // COUT_MED
var CR_TRAV=LB.chequesRepas.partTravailleur.min; // CR_TRAV
var PP_EST=0.22; // PP estimation moyenne (~22% de l'imposable)
var NET_FACTOR=(1-TX_ONSS_W)*(1-PP_EST); // facteur net approx = ~0.5645
var quickNetEst=(b)=>Math.round(b*NET_FACTOR*100)/100; // estimation rapide net

// ═══ SPRINT 41: EXPORTS COMPTABLES RÉELS ═══
function generateExportCompta(format,ops,periode,company){
  const co=company||{};const coName=co.name||'Aureus IA SPRL';const coVAT=(co.vat||'BE1028230781').replace(/[^A-Z0-9]/g,'');
  const f2=v=>(Math.round(v*100)/100).toFixed(2);
  const fBE=v=>f2(v).replace('.',',');
  const now=new Date();const dateStr=now.toISOString().slice(0,10);const periodeStr=periode||dateStr.slice(0,7);
  const journal='OD';const piece='SAL'+periodeStr.replace(/-/g,'');
  let output='';let filename='';let mime='text/plain';
  // ——— BOB50 ———
  if(format==='bob50'||format==='bob'){
    // BOB50 format: journal|date|piece|compte|libelle|montant_debit|montant_credit
    output=ops.map(o=>[journal,dateStr.replace(/-/g,''),piece,o.compte,'"'+o.desc.replace(/"/g,"'")+'"',o.sens==='D'?fBE(o.montant):'0,00',o.sens==='C'?fBE(o.montant):'0,00'].join('\t')).join('\n');
    output='Journal\tDate\tPiece\tCompte\tLibelle\tDebit\tCredit\n'+output;
    filename='BOB50_OD_'+periodeStr+'.txt';
  }
  // ——— WINBOOKS ———
  else if(format==='winbooks'){
    // Winbooks TXT: DBK|BOOKYEAR|PERIOD|DOCNUMBER|ACCOUNTGL|AMOUNTEUR|DTEFROM|COMMENT
    const year=now.getFullYear();const month=now.getMonth()+1;
    output=ops.map((o,i)=>['OD',year,month.toString().padStart(2,'0'),piece,(o.compte||'').padEnd(10,' '),o.sens==='D'?f2(o.montant):'-'+f2(o.montant),dateStr.replace(/-/g,''),o.desc.slice(0,40)].join('\t')).join('\n');
    output='DBK\tBOOKYEAR\tPERIOD\tDOCNUMBER\tACCOUNTGL\tAMOUNTEUR\tDTEFROM\tCOMMENT\n'+output;
    filename='Winbooks_OD_'+periodeStr+'.txt';
  }
  // ——— EXACT ONLINE ———
  else if(format==='exact'){
    // Exact CSV: Journal;Boekjaar;Periode;Dagboek;Rekeningnr;Omschrijving;Debet;Credit;Datum
    output=ops.map(o=>['OD',now.getFullYear(),now.getMonth()+1,'OD',o.compte,'"'+o.desc+'"',o.sens==='D'?fBE(o.montant):'',o.sens==='C'?fBE(o.montant):'',dateStr.split('-').reverse().join('/')].join(';')).join('\n');
    output='Journal;Boekjaar;Periode;Dagboek;Rekeningnr;Omschrijving;Debet;Credit;Datum\n'+output;
    filename='Exact_OD_'+periodeStr+'.csv';mime='text/csv';
  }
  // ——— HORUS ———
  else if(format==='horus'){
    // Horus XML format
    const entries=ops.map((o,i)=>'<Entry seq="'+(i+1)+'"><Account>'+o.compte+'</Account><Description>'+o.desc.replace(/&/g,'&amp;')+'</Description><Debit>'+(o.sens==='D'?f2(o.montant):'0.00')+'</Debit><Credit>'+(o.sens==='C'?f2(o.montant):'0.00')+'</Credit><Date>'+dateStr+'</Date></Entry>').join('');
    output='<?xml version="1.0" encoding="UTF-8"?>\n<HorusExport><Journal>OD</Journal><Period>'+periodeStr+'</Period><Company>'+coName+'</Company><VAT>'+coVAT+'</VAT><Entries>'+entries+'</Entries></HorusExport>';
    filename='Horus_OD_'+periodeStr+'.xml';mime='application/xml';
  }
  // ——— OCTOPUS ———
  else if(format==='octopus'){
    // Octopus CSV: Dagboek,Datum,Stuk,Rekening,Omschrijving,Debet,Credit
    output=ops.map(o=>['OD',dateStr.split('-').reverse().join('/'),piece,o.compte,'"'+o.desc+'"',o.sens==='D'?fBE(o.montant):'',o.sens==='C'?fBE(o.montant):''].join(',')).join('\n');
    output='Dagboek,Datum,Stuk,Rekening,Omschrijving,Debet,Credit\n'+output;
    filename='Octopus_OD_'+periodeStr+'.csv';mime='text/csv';
  }
  // ——— YUKI ———
  else if(format==='yuki'){
    // Yuki XML
    const lines=ops.map((o,i)=>'<Line><LineNumber>'+(i+1)+'</LineNumber><GLAccountCode>'+o.compte+'</GLAccountCode><Description>'+o.desc.replace(/&/g,'&amp;')+'</Description><DebitAmount>'+(o.sens==='D'?f2(o.montant):'0.00')+'</DebitAmount><CreditAmount>'+(o.sens==='C'?f2(o.montant):'0.00')+'</CreditAmount></Line>').join('');
    output='<?xml version="1.0" encoding="UTF-8"?>\n<YukiImport><Administration>'+coVAT+'</Administration><Journal><Code>OD</Code><Description>OD Salaires '+periodeStr+'</Description><Date>'+dateStr+'</Date><Lines>'+lines+'</Lines></Journal></YukiImport>';
    filename='Yuki_OD_'+periodeStr+'.xml';mime='application/xml';
  }
  // ——— KLUWER ———
  else if(format==='kluwer'){
    output=ops.map(o=>['OD',dateStr.replace(/-/g,''),piece,o.compte,o.desc.slice(0,40).padEnd(40,' '),o.sens==='D'?fBE(o.montant).padStart(15,' '):''.padStart(15,' '),o.sens==='C'?fBE(o.montant).padStart(15,' '):''.padStart(15,' ')].join('|')).join('\n');
    filename='Kluwer_OD_'+periodeStr+'.txt';
  }
  // ——— POPSY ———
  else if(format==='popsy'){
    output=ops.map((o,i)=>[piece,dateStr.replace(/-/g,''),o.compte,o.desc.slice(0,30),o.sens==='D'?fBE(o.montant):'0,00',o.sens==='C'?fBE(o.montant):'0,00'].join(';')).join('\n');
    output='Piece;Date;Compte;Libelle;Debit;Credit\n'+output;
    filename='Popsy_OD_'+periodeStr+'.txt';
  }
  // Download
  var blob=new Blob([output],{type:mime+';charset=utf-8'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
  return {filename,size:output.length,lines:output.split('\n').length};
}

// ═══ SPRINT 41: CSV EXPORT TRAVAILLEURS ═══
function exportTravailleurs(emps,company){
  const co=company||{};const coName=co.name||'';
  const headers=['NISS','Nom','Prenom','DateNaissance','Genre','Email','Telephone','Adresse','CodePostal','Ville','IBAN','BIC','Statut','TypeContrat','DateEntree','DateSortie','Fonction','Regime','BrutMensuel','CP','Matricule'];
  const rows=emps.map(e=>[
    (e.niss||''),
    (e.last||e.ln||'').replace(/;/g,','),
    (e.first||e.fn||'').replace(/;/g,','),
    (e.birthDate||''),
    (e.gender||''),
    (e.email||''),
    (e.phone||''),
    (e.address||''),
    (e.zip||''),
    (e.city||''),
    (e.iban||''),
    (e.bic||''),
    (e.statut||'Employé'),
    (e.contractType||'CDI'),
    (e.startDate||''),
    (e.endDate||''),
    (e.fonction||e.jobTitle||''),
    (+e.regime||100)+'%',
    (+(e.monthlySalary||e.gross||0)).toFixed(2),
    (e.cp||''),
    (e.matricule||e.id||'')
  ].join(';'));
  const csv='\uFEFF'+headers.join(';')+'\n'+rows.join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='Travailleurs_'+coName.replace(/[^a-zA-Z0-9]/g,'_')+'_'+new Date().toISOString().slice(0,10)+'.csv';
  document.body.appendChild(a);a.click();
  setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
  return rows.length;
}

// ═══ SPRINT 41: CSV IMPORT TRAVAILLEURS ═══
function importTravailleurs(csvText){
  const lines=csvText.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2)return {error:'Fichier vide ou sans données',imported:[]};
  const headers=lines[0].split(';').map(h=>h.trim().toLowerCase());
  const fieldMap={
    'niss':'niss','nom':'last','prenom':'first','datenaissance':'birthDate',
    'genre':'gender','email':'email','telephone':'phone','adresse':'address',
    'codepostal':'zip','ville':'city','iban':'iban','bic':'bic',
    'statut':'statut','typecontrat':'contractType','dateentree':'startDate',
    'datesortie':'endDate','fonction':'fonction','regime':'regime',
    'brutmensuel':'gross','cp':'cp','matricule':'matricule',
    'last':'last','first':'first','fn':'first','ln':'last',
    'name':'last','firstname':'first','lastname':'last',
    'salary':'gross','brut':'gross','gross':'gross',
    'contract':'contractType','type':'contractType',
    'start':'startDate','end':'endDate','birth':'birthDate'
  };
  const colMap=headers.map(h=>{
    const clean=h.replace(/[^a-z]/g,'');
    return fieldMap[clean]||null;
  });
  const imported=[];
  for(let i=1;i<lines.length;i++){
    const vals=lines[i].split(';');
    if(vals.length<3)continue;
    const emp={id:'imp_'+Date.now()+'_'+i,status:'active'};
    colMap.forEach((field,j)=>{
      if(field&&vals[j]!==undefined){
        let v=vals[j].trim().replace(/^"|"$/g,'');
        if(field==='gross')v=parseFloat(v.replace(',','.'))||0;
        else if(field==='regime')v=parseInt(v)||100;
        emp[field]=v;
      }
    });
    if(emp.first||emp.last||emp.niss)imported.push(emp);
  }
  return {imported,count:imported.length,headers:headers};
}

// ═══ SPRINT 41: TEST SUITE CALCULS PAIE ═══
function runPayrollTests(){
  const tests=[];
  const assert=(name,actual,expected,tolerance)=>{
    const tol=tolerance||0.01;
    const pass=Math.abs(actual-expected)<=tol;
    tests.push({name,actual:Math.round(actual*100)/100,expected,pass,diff:Math.round((actual-expected)*100)/100});
  };
  // ══ ONSS TRAVAILLEUR ══
  assert('ONSS 3500 brut',3500*TX_ONSS_W,457.45);
  assert('ONSS 2000 brut',2000*TX_ONSS_W,261.40);
  assert('ONSS 5000 brut',5000*TX_ONSS_W,653.50);
  // ══ PRECOMPTE PROFESSIONNEL (formule-clé SPF) ══
  const pp1=calcPrecompteExact(3500,{situation:'isole',enfants:0});
  assert('PP 3500 isolé 0enf',pp1.pp,660.63,1.0);
  const pp2=calcPrecompteExact(3500,{situation:'marie_1r',enfants:0});
  assert('PP 3500 marié1r 0enf',pp2.pp,470,15);
  const pp3=calcPrecompteExact(2000,{situation:'isole',enfants:0});
  assert('PP 2000 isolé 0enf',pp3.pp,218,10);
  const pp4=calcPrecompteExact(5000,{situation:'isole',enfants:0});
  assert('PP 5000 isolé 0enf',pp4.pp,1230,20);
  const pp5=calcPrecompteExact(3500,{situation:'isole',enfants:2});
  assert('PP 3500 isolé 2enf < PP sans enf',pp5.pp<pp1.pp?1:0,1);
  // ══ CSSS ══
  const csss1=calcCSSS(3500,'isole');
  assert('CSSS 3500 isolé',csss1,14.93,2);
  // ══ BONUS EMPLOI ══
  const be1=calcBonusEmploi(2000);
  assert('Bonus emploi 2000 > 0',be1>0?1:0,1);
  const be2=calcBonusEmploi(5000);
  assert('Bonus emploi 5000 = 0',be2,0);
  // ══ NET COMPLET ══
  const net1=quickNet(3500);
  assert('Net 3500 > 2200',net1>2200?1:0,1);
  assert('Net 3500 < 2800',net1<2800?1:0,1);
  // ══ PECULE VACANCES ══
  assert('PV simple 7.67%',PV_SIMPLE,0.0767);
  assert('PV double 92%',PV_DOUBLE,0.92);
  assert('PV ouvrier 8.58%',LOIS_BELGES.rémunération.peculeVacances.ouvrierDouble.pct,0.0858);
  // ══ RMMMG ══
  assert('RMMMG 2026',RMMMG,2070.48,5);
  // ══ CONSTANTES CENTRALISEES ══
  assert('TX_ONSS_W',TX_ONSS_W,0.1307);
  assert('TX_ONSS_E',TX_ONSS_E,0.2507,0.001);
  assert('CR_PAT',CR_PAT,6.91);
  // ══ RATIOS ══
  const brut=3500;const onss=brut*TX_ONSS_W;const pp=quickPP(brut);const net=brut-onss-pp;
  assert('Ratio net/brut 3500',net/brut*100,67,3);
  assert('Cout employeur',brut*(1+TX_ONSS_E),4377.45,5);
  // RESULTS
  const passed=tests.filter(t=>t.pass).length;
  const failed=tests.filter(t=>!t.pass).length;
  return {tests,passed,failed,total:tests.length,score:Math.round(passed/tests.length*100)};
}



// ═══ SPRINT 43: OBFUSCATION NISS/IBAN ═══
var obf={
  encode:(v)=>{if(!v)return '';try{return btoa(unescape(encodeURIComponent(String(v).split('').reverse().join(''))));}catch(e){return v;}},
  decode:(v)=>{if(!v)return '';try{return decodeURIComponent(escape(atob(v))).split('').reverse().join('');}catch(e){return v;}},
  maskNISS:(n)=>{if(!n||n.length<6)return n;return n.slice(0,2)+'.***.***'+n.slice(-2);},
  maskIBAN:(i)=>{if(!i||i.length<8)return i;return i.slice(0,4)+' **** **** '+i.slice(-4);}
};
var safeLS={get:(k)=>{try{if(typeof window==='undefined')return null;return window.localStorage.getItem(k);}catch(e){return null;}},set:(k,v)=>{try{if(typeof window==='undefined')return;window.localStorage.setItem(k,typeof v==='string'?v:JSON.stringify(v));}catch(e){}},remove:(k)=>{try{if(typeof window==='undefined')return;window.localStorage.removeItem(k);}catch(e){}}};
var CR_MAX=LB.chequesRepas.valeurFaciale.max; // 8.00
var CR_PAT=LB.chequesRepas.partPatronale.max; // 6.91
var FORF_BUREAU=LB.fraisPropres.forfaitBureau.max; // FORF_BUREAU
var FORF_KM=LB.fraisPropres.forfaitDeplacement.voiture; // 0.4415
var PV_SIMPLE=LB.rémunération.peculeVacances.simple.pct; // PV_SIMPLE
var PV_DOUBLE=LB.rémunération.peculeVacances.double.pct; // 0.92
var RMMMG=LB.rémunération.RMMMG.montant18ans; // RMMMG
var BONUS_MAX=LB.pp.bonusEmploi.maxMensuel; // 194.03
var SEUIL_CPPT=LB.seuils.electionsSociales.cppt; // 50
var SEUIL_CE=LB.seuils.electionsSociales.ce; // 100
var HEURES_HEBDO=LB.tempsTravail.dureeHebdoLegale; // 38
var JOURS_FERIES=LB.tempsTravail.jourFerie.nombre; // 10


// Fonction centralisée: obtenir une valeur légale
function getLoi(path, fallback) {
  const parts = path.split('.');
  let val = LOIS_BELGES;
  for (const p of parts) { val = val?.[p]; if (val === undefined) return fallback; }
  return val;
}


// Aliases courts pour calculs — connectés à LOIS_BELGES
// (voir bloc RACCOURCIS CENTRALISÉS plus bas)
var _PVP = LOIS_BELGES.rémunération.peculeVacances.patronal.pct;
var _HLEG = LOIS_BELGES.tempsTravail.dureeHebdoLegale;

// Fonction centralisée: calculer PP via LOIS_BELGES
function calcPPFromLois(brut, opts) {
  const L = LOIS_BELGES;
  const onss = Math.round(brut * L.onss.travailleur * 100) / 100;
  const imposable = brut - onss;
  const annuel = imposable * 12;
  const dirigeant = opts?.dirigeant || false;
  const fp = dirigeant ? L.pp.fraisPro.dirigeant : L.pp.fraisPro.salarie;
  const forfait = Math.min(annuel * fp.pct, fp.max);
  const base = Math.max(0, annuel - forfait);
  const isB2 = opts?.bareme2 || false;
  let qc = 0, baseNet = base;
  if (isB2) { qc = Math.min(base * L.pp.quotientConjugal.pct, L.pp.quotientConjugal.max); baseNet = base - qc; }
  const calcTr = (b) => { let imp = 0, prev = 0; for (const t of L.pp.tranches) { const slice = Math.min(b, t.max) - Math.max(prev, t.min); if (slice > 0) imp += slice * t.taux; prev = t.max; } return imp; };
  let impot = calcTr(baseNet);
  if (isB2 && qc > 0) impot += calcTr(qc);
  const qe = isB2 ? L.pp.quotiteExemptee.bareme2 : L.pp.quotiteExemptee.bareme1;
  const enf = +(opts?.enfants || 0);
  const enfH = +(opts?.enfantsHandicapes || 0);
  const enfFisc = enf + enfH;
  let redEnf = 0;
  if (enfFisc > 0) { redEnf = enfFisc <= 8 ? L.pp.reductionsEnfants[enfFisc] : L.pp.reductionsEnfants[8] + (enfFisc - 8) * L.pp.reductionEnfantSupp; }
  let totalRed = qe + redEnf;
  if (opts?.parentIsole && enf > 0) totalRed += L.pp.reductionParentIsole;
  if (opts?.handicape) totalRed += L.pp.reductionHandicape;
  const taxeCom = (opts?.taxeCom || 7) / 100;
  const ppAn = Math.max(0, impot - totalRed) * (1 + taxeCom);
  return Math.round(ppAn / 12 * 100) / 100;
}


// ═══ RACCOURCIS CENTRALISÉS — Toute modif dans LOIS_BELGES se propage ICI ═══
var _RMMMG = LOIS_BELGES.rémunération.RMMMG.montant18ans; // 2070.48
var _IDX = LOIS_BELGES.rémunération.indexSante.coeff; // 2.0399


// ═══════════════════════════════════════════════════════════════
//  AUREUS SOCIAL PRO — Logiciel de Paie Belge Professionnel
//  Modules: ONSS (Dimona/DMFA), Belcotax 281.xx, Formule-clé
//  SPF Finances, Documents sociaux (C4, attestations)
//  🌐 Multilingue: FR / NL
// ═══════════════════════════════════════════════════════════════

// ── I18N — Dictionnaire FR / NL / EN / DE ──
const LangCtx = createContext({lang:'fr',t:(k)=>k,setLang:()=>{}});
const useLang = () => useContext(LangCtx);


// i18n provider wrapper
function LangProvider({children}) {
  const [lang, setLang] = useState('fr');
  const t = (key) => {
    const entry = I18N[key];
    if (!entry) return key;
    return entry[lang] || entry.fr || key;
  };
  const changeLang = (l) => { setLang(l); };
  return <LangCtx.Provider value={{lang, t, setLang: changeLang}}><LangSync/>{children}</LangCtx.Provider>;
}

// Language switcher component
function LangSwitch() {
  const {lang, setLang} = useLang();
  return <div style={{display:'flex',gap:2,background:"rgba(198,163,78,.06)",borderRadius:6,padding:2,border:'1px solid rgba(198,163,78,.1)'}}>
    {['fr',"nl","en","de"].map(l =>
      <button key={l} onClick={()=>setLang(l)} style={{
        padding:'4px 10px',borderRadius:5,border:'none',cursor:'pointer',fontSize:10.5,fontWeight:lang===l?700:400,
        background:lang===l?'rgba(198,163,78,.2)':'transparent',
        color:lang===l?'#c6a34e':'#9e9b93',fontFamily:'inherit',textTransform:'uppercase',letterSpacing:1
      }}>{l}</button>
    )}
  </div>;
}

// LangSync — keeps global MN in sync with language
function LangSync() {
  const {lang} = useLang();
  useEffect(() => { MN = lang === 'nl' ? MN_NL : MN_FR; }, [lang]);
  return null;
}

var LEGAL={ONSS_W:TX_ONSS_W,ONSS_E:TX_ONSS_E,BONUS_2026:{
    // Bonus à l'emploi — Volet A (bas salaires) + Volet B (très bas salaires)
    // Source: Instructions ONSS T1/2026 — indexé 01/01/2026
    // Employés (déclarés à 100%)
    A_S1:3340.44, A_MAX:132.92, A_COEFF:0.2638,  // Volet A: si S <= S1, R_A = A_MAX - A_COEFF*(S - A_S2)
    A_S2:2833.27,                                  // si S <= A_S2: R_A = A_MAX
    B_S1:2833.27, B_MAX:123.08, B_COEFF:0.2443,   // Volet B: si S <= B_S1, R_B = B_MAX - B_COEFF*(S - B_S2)
    B_S2:2330.10,                                  // si S <= B_S2: R_B = B_MAX
    // Ouvriers (déclarés à 108%) — mêmes seuils mais x1.08
    O_A_S1:3609.28, O_A_MAX:143.55, O_A_COEFF:0.2449, 
    O_A_S2:3059.93,
    O_B_S1:3059.93, O_B_MAX:132.93, O_B_COEFF:0.2262,
    O_B_S2:2516.51
  },
  // ── Réduction structurelle ONSS T1/2026 — Source: Easypay Group / ONSS 09/01/2026 ──
  RED_STRUCT_2026:{
    // Cat 1: Secteur privé marchand (25%) — F=0, δ=0 → seuls bas/très bas salaires
    CAT1_alpha:0.1400, CAT1_S0:11458.57,  // composante bas salaires: α*(S0-S)
    CAT1_gamma:0.1500, CAT1_S2:9547.20,   // composante très bas salaires: γ*(S2-S)
    CAT1_F:0, CAT1_delta:0, CAT1_S1:0,
    // Cat 2: Maribel social / non-marchand (±32.40%)
    CAT2_F:79.00, CAT2_alpha:0.2300, CAT2_S0:9975.60,
    CAT2_gamma:0.1500, CAT2_S2:9975.60,
    CAT2_delta:0.0600, CAT2_S1:16803.98,
    // Cat 3: Entreprises de travail adapté
    CAT3_alpha:0.1400, CAT3_S0:12416.08,
    CAT3_gamma:0.1500, CAT3_S2:9547.20,
    CAT3_F:0, CAT3_delta:0, CAT3_S1:0,
    // Cat 3bis: ETA travailleurs moins valides
    CAT3B_F:495.00, CAT3B_alpha:0.1785, CAT3B_S0:11788.30,
    CAT3B_gamma:0.1500, CAT3B_S2:9547.20,
    // Multiplicateur fixe Ps = R * µ * fraction_prestation (µ=0.1400 intégré dans formule)
    MU:1.0  // µ déjà intégré dans les coefficients ci-dessus pour simplifier
  },MV:{emax:8.91,wmin:1.09,maxTotal:10,deducFisc:4},ECO:250,WD:21.67,WH:38,WHD:7.6,
  // ── Précompte professionnel 2026 — Annexe III AR/CIR 92 (Moniteur belge) ──
  // Formule-clé complète SPF Finances (pas simplifiée)
  PP2026:{
    // Frais professionnels forfaitaires (salariés)
    FP_PCT:0.30, FP_MAX:5930,
    // Frais professionnels dirigeants d'entreprise
    FP_DIR_PCT:0.03, FP_DIR_MAX:3120,
    // Barème progressif ANNUEL (tranches 2026 indexées)
    TRANCHES:[
      {lim:16310,rate:0.2675},
      {lim:29940,rate:0.4280},
      {lim:41370,rate:0.4815},
      {lim:Infinity,rate:0.5350}
    ],
    // Quotité exemptée d'impôt 2026
    EXEMPT:10900,
    // Réductions annuelles pour charges de famille
    RED:{
      isolee:144.00,          // personne isolée
      veuf_enfant:540.00,     // veuf/veuve non remarié(e) + enfant
      enfants:[0,612,1620,3672,5928,7116],  // 0,1,2,3,4,5 enfants
      enfantX:7116,           // par enfant supplémentaire > 5
      handicap:612,           // supplément par enfant handicapé
      ascendant65:1728,       // parent/grand-parent ≥65 ans à charge
      ascendant65_handi:2100, // idem handicapé
      conjoint_charge:0,      // quotient conjugal: traité séparément
    },
    // Quotient conjugal (barème 2): max 30% du revenu, plafonné à 12 520 €
    QC_PCT:0.30, QC_MAX:12520,
  },
  // ── Modulations sectorielles ONSS ──
  // Depuis tax-shift 2018: taux facial = 25% secteur marchand privé (inclut modération salariale 7,48%)
  // Non-marchand: ≈ 32,40% (réduction via Maribel social)
  // Ouvriers: cotisations calculées sur brut × 108% (compensation pécule vacances)
  ONSS_DETAIL_2026:{
    // Ventilation du taux patronal 25% (secteur marchand, employés)
    base:0.1993,           // cotisation de base
    moderation:0.0507,     // modération salariale (intégrée dans 25% facial)
    total_marchand:0.25,   // = cotisation globale secteur marchand (tax-shift 2018)
    // Cotisation supplémentaire ≥ 10 travailleurs
    supp_10trav:0.0169,    // 1,60% + modération = 1,69% si ≥ 10 travailleurs
    // Non-marchand
    total_non_marchand:0.3240,
    maribel_social:0.0024, // réduction Maribel (déduit)
    // Ouvriers
    majoration_ouvrier:1.08, // brut × 108%
    vacances_annuelles_ouvrier:0.1027, // 10,27% sur brut à 108% année N-1 (payé au 30/04)
    // Cotisations spéciales patronales T1/2026
    ffe_petit:0.0032,      // Fonds fermeture < 20 trav.
    ffe_grand:0.0037,      // Fonds fermeture ≥ 20 trav.
    chomage_temp:0.0009,   // chômage temporaire T1/2026
    amiante:0.0001,        // Fonds amiante (T1-T3 2026 seulement)
    maladies_prof:0.0017,  // cotisation maladies professionnelles (Fedris)
    // Étudiants
    etudiant_patronal:0.0542, // cotisation solidarité patronale (650h/an)
    etudiant_personnel:0.0271,// cotisation solidarité personnelle
    etudiant_total:0.0813,    // total solidarité = 8,13%
    // Flexi-jobs
    flexi_patronal:0.28,   // 28% cotisation patronale spéciale
    // CSS annuelle max
    css_max_isole:731.28,  // max annuel isolé/conjoint sans revenus
    css_max_menage:731.28, // max annuel ménage 2 revenus (identique mais retenues mensuelles différentes)
    // Provisions mensuelles: le 5 de chaque mois
    // Solde trimestriel: dernier jour du mois suivant le trimestre
  },
  ONSS_SECTEUR:{
    'default':{e:0.25,type:"marchand",note:"Taux global standard 25% (secteur marchand privé, tax-shift 2018)"},
    '124':{e:0.3838,type:"marchand",note:"Construction: 25% + intempéries 2% + congés 6% + sécurité 0.22% + timbre fidélité"},
    '302':{e:0.2816,type:"marchand",note:"Horeca: 25% + Fonds social horeca + Fonds fermeture"},
    '140':{e:0.2716,type:"marchand",note:"Transport: 25% + Fonds social + formation"},
    '330':{e:0.3240,type:"non_marchand",note:"Soins santé (non-marchand): 32,40% - Maribel social"},
    '331':{e:0.3240,type:"non_marchand",note:"Aide sociale Flandre (non-marchand): 32,40% - Maribel"},
    '332':{e:0.3240,type:"non_marchand",note:"Aide sociale CF/RW (non-marchand): 32,40% - Maribel"},
    '329':{e:0.3240,type:"non_marchand",note:"Socio-culturel (non-marchand): 32,40% - Maribel"},
    '318':{e:0.3240,type:"non_marchand",note:"Aides familiales (non-marchand): 32,40% - Maribel"},
    '319':{e:0.3240,type:"non_marchand",note:"Éducation (non-marchand): 32,40% - Maribel"},
    '322.01':{e:0.2916,type:"marchand",note:"Titres-services: 25% + fonds titres-services 4,16%"},
    '327':{e:0.3240,type:"non_marchand",note:"ETA (non-marchand): 32,40% - Maribel"},
  },
  DIMONA_TYPES:['IN',"OUT","UPDATE","CANCEL","DAILY"],
  DIMONA_WTYPES:['OTH',"STU","FLX","IVT","A17","DWD","TRI","S17","BCW","EXT"],
  DMFA_CODES:{'495':'Employé ordinaire',"015":'Ouvrier ordinaire',"487":'Dirigeant',"027":'Apprenti',"840":'Étudiant',"050":'Intérimaire'},
  FICHE_281:{'10':'Rémunérations employés/dirigeants',"13":'Pensions/rentes',"14":'Revenus remplacement',"17":'Rentes alimentaires',"18":'Rém. non-marchand',"20":'Honoraires/commissions',"30":'Jetons de présence',"50":'Revenus mobiliers'},
  SOCIAL_DOCS:{C4:'Certificat de chômage C4',C131A:'Certificat chômage temporaire',C3_2:'Carte contrôle chômage',VACATION:'Attestation de vacances',WORK_CERT:'Certificat de travail',ACCOUNT:'Compte individuel'},
  CP:{'100':'CP 100 - Auxiliaire ouvriers',"101":'CP 101 - Mines',"102":'CP 102 - Carrières',"104":'CP 104 - Sidérurgie',"105":'CP 105 - Métaux non-ferreux',"106":'CP 106 - Ciment',"107":'CP 107 - Maîtres-tailleurs',"109":'CP 109 - Habillement/Confection',"110":'CP 110 - Entretien textile',"111":'CP 111 - Métal/Mécanique/Électrique',"112":'CP 112 - Garage',"113":'CP 113 - Céramique',"114":'CP 114 - Briqueterie',"115":'CP 115 - Verrerie',"116":'CP 116 - Chimie',"117":'CP 117 - Pétrole',"118":'CP 118 - Industrie alimentaire',"119":'CP 119 - Commerce alimentaire',"120":'CP 120 - Textile/Bonneterie',"121":'CP 121 - Nettoyage',"124":'CP 124 - Construction',"125":'CP 125 - Industrie du bois',"126":'CP 126 - Ameublement',"127":'CP 127 - Commerce combustibles',"128":'CP 128 - Cuirs et peaux',"129":'CP 129 - Pâtes/Papiers/Cartons',"130":'CP 130 - Imprimerie/Arts graphiques',"132":'CP 132 - Travaux techniques agricoles',"133":'CP 133 - Tabacs',"136":'CP 136 - Transformation papier/carton',"139":'CP 139 - Batellerie',"140":'CP 140 - Transport',"142":'CP 142 - Récupération matières premières',"143":'CP 143 - Pêche maritime',"144":'CP 144 - Agriculture',"145":'CP 145 - Horticulture',"146":'CP 146 - Entreprises forestières',"147":'CP 147 - Armurerie',"148":'CP 148 - Fourrure/Peau en poil',"149":'CP 149 - Secteurs connexes métal',"149.01":'CP 149.01 - Électriciens installation',"149.02":'CP 149.02 - Carrosserie',"149.03":'CP 149.03 - Métaux précieux',"149.04":'CP 149.04 - Commerce du métal',"150":'CP 150 - Poterie',"152":'CP 152 - Enseignement libre',"200":'CP 200 - Auxiliaire employés',"201":'CP 201 - Commerce de détail indépendant',"202":'CP 202 - Commerce détail alimentaire',"203":'CP 203 - Carrières petit granit (empl.)',"204":'CP 204 - Carrières porphyre (empl.)',"205":'CP 205 - Charbonnages (empl.)',"207":'CP 207 - Industrie chimique (empl.)',"209":'CP 209 - Fabrications métalliques (empl.)',"210":'CP 210 - Sidérurgie (empl.)',"211":'CP 211 - Pétrole (empl.)',"214":'CP 214 - Textile/Bonneterie (empl.)',"215":'CP 215 - Habillement/Confection (empl.)',"216":'CP 216 - Notaires (empl.)',"217":'CP 217 - Casino (empl.)',"218":'CP 218 - CNT auxiliaire employés',"219":'CP 219 - Organismes contrôle agréés',"220":'CP 220 - Industrie alimentaire (empl.)',"221":'CP 221 - Industrie papetière (empl.)',"222":'CP 222 - Transformation papier/carton (empl.)',"223":'CP 223 - Sports',"224":'CP 224 - Métaux non-ferreux (empl.)',"225":'CP 225 - Enseignement libre (empl.)',"226":'CP 226 - Commerce international/Transport',"227":'CP 227 - Secteur audio-visuel',"301":'CP 301 - Ports',"302":'CP 302 - Hôtellerie',"303":'CP 303 - Cinématographie',"304":'CP 304 - Spectacle',"306":'CP 306 - Assurances',"307":'CP 307 - Courtage assurances',"308":'CP 308 - Prêts hypothécaires',"309":'CP 309 - Sociétés de bourse',"310":'CP 310 - Banques',"311":'CP 311 - Grandes surfaces',"312":'CP 312 - Grands magasins',"313":'CP 313 - Pharmacies',"314":'CP 314 - Coiffure/Soins de beauté',"315":'CP 315 - Aviation commerciale',"316":'CP 316 - Marine marchande',"317":'CP 317 - Gardiennage',"318":'CP 318 - Aides familiales/seniors',"319":'CP 319 - Éducation/Hébergement',"320":'CP 320 - Pompes funèbres',"321":'CP 321 - Grossistes médicaments',"322":'CP 322 - Intérimaire/Titres-services',"322.01":'CP 322.01 - Titres-services',"323":'CP 323 - Gestion immeubles/Domestiques',"324":'CP 324 - Diamant',"325":'CP 325 - Institutions publiques crédit',"326":'CP 326 - Gaz/Électricité',"327":'CP 327 - Travail adapté/Ateliers sociaux',"328":'CP 328 - Transport urbain/régional',"329":'CP 329 - Socio-culturel',"330":'CP 330 - Santé',"331":'CP 331 - Aide sociale (Flandre)',"332":'CP 332 - Aide sociale (francophone)',"333":'CP 333 - Attractions touristiques',"336":'CP 336 - Professions libérales'},
  REDUCTIONS:{base:157.29,married1:258.33,children:[0,52.50,141.67,318.33,514.17,618.33],childX:618.33,handicap:52.50,isolated:52.50},
  // ── Cotisation Spéciale Sécurité Sociale — retenue MENSUELLE (provisions) ──
  // Source: socialsecurity.be/employer/instructions/dmfa + montants-socio-juridiques
  // Basée sur la rémunération TRIMESTRIELLE, retenue mensuellement = 1/3 du montant trimestriel
  // ISOLÉ / conjoint SANS revenus prof. (barème 1)
  CSS_SINGLE:[
    {f:0,t:1945.38,a:0},                              // T <= 5836.14: 0€
    {f:1945.39,t:2190.18,p:.076,b:1945.38},            // 5836.14 < T <= 6570.54: 7,6% tranche, min 0€
    {f:2190.19,t:6038.82,a:18.60,p2:0.011,b2:2190.18,max:60.94}, // 6570.54 < T <= 18116.46: 18.60 + 1,1% tranche, max 60.94€/mois
    {f:6038.83,t:Infinity,a:60.94}                     // T > 18116.46: 60.94€/mois (182.82€/trim)
  ],
  // MÉNAGE 2 REVENUS (conjoint a aussi des revenus prof.) (barème 2)
  CSS_MARRIED:[
    {f:0,t:1945.38,a:0},                              // T <= 5836.14: 0€
    {f:1945.39,t:2190.18,p:.076,b:1945.38,min:9.30},  // 5836.14 < T <= 6570.54: 7,6% tranche, min 9.30€/mois
    {f:2190.19,t:6038.82,a:18.60,p2:0.011,b2:2190.18,max:51.64}, // 6570.54 < T <= 18116.46: 18.60 + 1,1% tranche, max 51.64€/mois
    {f:6038.83,t:Infinity,a:51.64}                     // T > 18116.46: 51.64€/mois (154.92€/trim)
  ],
  // ── SOURCES OFFICIELLES À SURVEILLER ──
  SOURCES_VEILLE:{
    federal:[
      {nom:"ONSS",url:"onss.be",desc:"Instructions trimestrielles, cotisations, DmfA"},
      {nom:"SPF Finances",url:"finances.belgium.be",desc:"Barèmes PP, Annexe III, circulaires fiscales"},
      {nom:"Fisconetplus",url:"eservices.minfin.fgov.be/fisconetplus",desc:"Base de données fiscales — circulaires, rulings, addenda PP"},
      {nom:"SPF Emploi",url:"emploi.belgique.be",desc:"Droit du travail, réglementation, CCT"},
      {nom:"Moniteur belge",url:"ejustice.just.fgov.be",desc:"Publication officielle lois, AR, CCT rendues obligatoires"},
      {nom:"CNT",url:"cnt-nar.be",desc:"CCT interprofessionnelles, avis"},
      {nom:"ONEM",url:"onem.be",desc:"Chômage, crédit-temps, interruption carrière"},
      {nom:"INAMI",url:"inami.fgov.be",desc:"Assurance maladie-invalidité, incapacité de travail"},
      {nom:"SFP/MyPension",url:"sfpd.fgov.be",desc:"Pensions, Wijninckx, DB2P"},
      {nom:"Sigedis/DB2P",url:"sigedis.be",desc:"Pensions complémentaires, base de données 2ème pilier"},
      {nom:"Fedris",url:"fedris.be",desc:"Accidents du travail, maladies professionnelles, tarification AT"},
      {nom:"ONVA",url:"onva.be",desc:"Vacances annuelles ouvriers, pécules, taux 10,27%"},
      {nom:"BCSS/KSZ",url:"ksz-bcss.fgov.be",desc:"Banque Carrefour SS, flux DRS, formulaires électroniques"},
      {nom:"CAPAC",url:"capac.fgov.be",desc:"Allocations chômage, formulaires C4, chômage temporaire"},
      {nom:"INASTI",url:"inasti.be",desc:"Cotisations indépendants, statut mixte dirigeants"},
      {nom:"SPF Économie",url:"economie.fgov.be",desc:"Index santé, indices prix, index-pivot"},
      {nom:"Statbel",url:"statbel.fgov.be",desc:"Statistiques emploi, enquêtes structure salaires"},
      {nom:"BNB",url:"nbb.be",desc:"Bilan social, centrale des bilans, données macro"},
      {nom:"BCE",url:"kbo-bce-search.economie.fgov.be",desc:"Registre entreprises, NACE, données sociétés"},
      {nom:"FLA",url:"federallearningaccount.be",desc:"Federal Learning Account — obligation formation employeurs"},
      {nom:"Belcotax",url:"belcotaxonweb.be",desc:"Fiches fiscales 281.xx"},
      {nom:"Chambre/Sénat",url:"lachambre.be",desc:"Projets de loi EN COURS — alertes précoces"},
    ],
    regional:[
      {nom:"Actiris",url:"actiris.brussels",desc:"Bruxelles — aides emploi, Activa, réductions groupes-cibles"},
      {nom:"FOREM",url:"forem.be",desc:"Wallonie — aides emploi, Impulsion, sesam"},
      {nom:"VDAB",url:"vdab.be",desc:"Flandre — aides emploi, doelgroepverminderingen"},
    ],
    secsoc:[
      {nom:"Veille sectorielle",url:"socialsecurity.be",desc:"Alertes législatives, montants socio-juridiques, analyses"},
      {nom:"Analyses juridiques",url:"emploi.belgique.be",desc:"Analyses juridiques, guides pratiques"},
      {nom:"Acerta",url:"acerta.be",desc:"Juricible, publications juridiques, simulations"},
      {nom:"Liantis",url:"liantis.be",desc:"Actualités sociales, guides PME"},
      {nom:"UCM",url:"ucm.be",desc:"Union Classes Moyennes, analyses PME, cotisations"},
      {nom:"Groupe S",url:"groups.be",desc:"Secrétariat social, analyses sectorielles"},
    ],
    juridique:[
      {nom:"Droitbelge.be",url:"droitbelge.be",desc:"Jurisprudence, doctrine, fiches pratiques"},
      {nom:"SocialEye (Wolters Kluwer)",url:"wolterskluwer.com/fr-be",desc:"Base juridique sociale complète"},
      {nom:"Socialsecurity.be",url:"socialsecurity.be",desc:"Portail central SS — instructions ONSS, manuels admin"},
      {nom:"Salaires minimums",url:"salairesminimums.be",desc:"Barèmes sectoriels indexés par CP"},
    ],
  },
};

const fmt=n=>new Intl.NumberFormat('fr-BE',{style:'currency',currency:'EUR'}).format(n||0);
const fmtP=n=>`${((n||0)*100).toFixed(2)}%`;
const uid=()=>`${Date.now()}-${Math.random().toString(36).substr(2,5)}`;
const MN_FR=['Janvier',"Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
const MN_NL=['Januari',"Februari","Maart","April","Mei","Juni","Juli","Augustus","September","Oktober","November","December"];
let MN=MN_FR; // Default FR — updated by LangSync component

// ═══════════════════════════════════════════════════════════════
//  BARÈMES OFFICIELS (Source: salairesminimums.be — SPF Emploi)
//  En vigueur au 01/01/2026
// ═══════════════════════════════════════════════════════════════
var BAREMES={
  '200':{type:"monthly",indexDate:'01/01/2026',indexPct:2.21,regime:38,
    classes:{A:'Fonctions exécutives',B:'Fonctions de support',C:'Fonctions de gestion',D:'Fonctions consultatives'},
    grid:{
      0:{A:2242.80,B:2336.26,C:2369.30,D:2555.72},
      1:{A:2310.29,B:2413.08,C:2433.27,D:2642.08},
      2:{A:2317.18,B:2426.87,C:2488.15,D:2659.15},
      3:{A:2324.15,B:2440.76,C:2536.36,D:2676.54},
      4:{A:2330.81,B:2459.31,C:2584.73,D:2744.49},
      5:{A:2337.59,B:2478.16,C:2632.95,D:2805.17},
      6:{A:2344.48,B:2492.51,C:2681.18,D:2865.76},
      7:{A:2351.28,B:2528.52,C:2729.58,D:2926.21},
      8:{A:2358.64,B:2564.62,C:2778.00,D:2986.87},
      9:{A:2377.79,B:2600.57,C:2826.39,D:3047.16},
      10:{A:2397.02,B:2636.80,C:2874.62,D:3108.07},
      11:{A:2413.36,B:2667.12,C:2923.00,D:3168.37},
      12:{A:2429.54,B:2697.07,C:2971.32,D:3229.13},
      13:{A:2445.96,B:2727.39,C:3009.52,D:3289.61},
      14:{A:2462.02,B:2757.42,C:3047.57,D:3350.23},
      15:{A:2478.16,B:2787.64,C:3085.79,D:3400.63},
      16:{A:2494.21,B:2797.49,C:3123.91,D:3451.03},
      17:{A:2510.32,B:2807.26,C:3162.14,D:3501.43},
      18:{A:2526.43,B:2817.24,C:3173.03,D:3552.00},
      19:{A:2526.43,B:2827.05,C:3183.98,D:3602.52},
      20:{A:2526.43,B:2836.94,C:3194.97,D:3620.36},
      21:{A:2526.43,B:2846.99,C:3206.15,D:3638.33},
      22:{A:2526.43,B:2856.72,C:3217.15,D:3656.27},
      23:{A:2526.43,B:2866.60,C:3228.41,D:3674.05},
      24:{A:2526.43,B:2876.47,C:3239.44,D:3691.77},
      25:{A:2526.43,B:2886.29,C:3250.71,D:3709.53},
      26:{A:2526.43,B:2896.17,C:3261.79,D:3727.33},
    },
    fnClassMap:{
      'Secrétaire':'A',"Réceptionniste":'A',"Aide-comptable":'A',"Assistant(e) administratif":'A',"Encodeur(se)":'A',
      'Comptable junior':'B',"Vendeur(se)":'B',"Service client":'B',"Secrétaire médicale":'B',"Assistant(e) dentaire":'B',"Préparateur commandes":'B',"Recruteur":'B',"Secrétaire juridique":'B',"Hygiéniste dentaire":'B',
      'Comptable':'C',"Comptable senior":'C',"Développeur junior":'C',"Marketing digital":'C',"Gestionnaire syndic":'C',"Consultant RH":'C',"Juriste":'C',"Gestionnaire sinistres":'C',"UX Designer":'C',"Paralegal":'C',"Web developer":'C',"Sysadmin":'C',"Administratif":'B',
      'Développeur senior':'D',"Project manager":'D',"Ingénieur":'D',"Avocat collaborateur":'D',"Agent immobilier":'D',"Courtier":'D',"Ingénieur process":'D',
    },
    primeAnnuelle:330.84,ecoChequesMax:250,primeFinAnnee:'salaire brut décembre',
    transport:{velo:0.27,maxVeloJour:10.80,priveSeuilAnnuel:36688,privePct:0.50},
  },
  '124':{type:"hourly",indexDate:'01/01/2026',indexPct:0.2186,regime:40,weeklyH:40,
    classes:{I:'Manœuvre',IA:'Manœuvre qualifié (I+5%)',II:'Ouvrier semi-qualifié',IIA:'Ouvrier semi-qualifié (II+5%)',III:'Ouvrier qualifié',IV:'Ouvrier spécialisé'},
    grid:{I:18.231,IA:19.138,II:19.436,IIA:20.406,III:20.669,IV:21.940,"Chef III":22.736,"Chef IV":24.134,"Contrem IV":26.328},
    fnClassMap:{
      'Manœuvre':'I',"Aide-maçon":'I',"Démolisseur":'I',
      'Maçon':'III',"Coffreur":'III',"Ferrailleur":'III',"Plombier":'III',"Chauffagiste":'III',"Peintre":'III',"Plafonneux":'III',"Carreleur":'III',"Électricien":'III',
      'Grutier':'IV',"Chef de chantier":'Chef IV',"Apprenti":'I',
    },
    timbreFidelite:0.09,timbreIntemperie:0.02,ecoChequesMax:115,
    mobilite:{parKm:0.1579,maxKm:64},reposComp:12,
  },
  '302':{type:"hourly",indexDate:'01/01/2026',indexPct:2.189,regime:38,weeklyH:38,
    classes:{I:'Cat I',II:'Cat II',III:'Cat III',IV:'Cat IV',V:'Cat V'},
    grid:{
      0:{I:15.2097,II:15.2097,III:15.2977,IV:15.9698,V:16.8849},
      1:{I:15.8915,II:15.8915,III:16.0385,IV:16.7838,V:17.7770},
      4:{I:16.2538,II:16.2538,III:16.4029,IV:17.1645,V:18.1848},
      8:{I:16.6152,II:16.6152,III:16.7673,IV:17.5452,V:18.5926},
    },
    fnClassMap:{
      'Plongeur(se)':'I',"Agent d'entretien":'I',
      'Serveur(se)':'II',"Barman/Barmaid":'II',"Commis de cuisine":'II',"Femme/Valet de chambre":'II',
      'Cuisinier(ère)':'III',"Réceptionniste":'III',"Aide cuisine":'II',"Livreur(se)":'II',
      'Chef cuisinier':'IV',"Concierge":'IV',
    },
    monthlyFactor:164.6666,indemniteNuit:1.6209,indemniteVetements:2.20,
  },
  '330':{type:"monthly",indexDate:'01/01/2026',indexPct:2.0,regime:38,
    // Source: salairesminimums.be CP 330 — échelles barémiques alloc. résidence, indexées 01/01/2026
    // Échelles: 1.12(Cat1) 1.26(Cat2) 1.40(Cat3) 1.45(Cat4) 1.59(Cat5) — Médecin hors barème
    classes:{1:'Éch.1.12 (aide logistique)',2:'Éch.1.26 (aide-soignant)',3:'Éch.1.40 (bachelier soins)',4:'Éch.1.45 (spécialisé)',5:'Éch.1.59 (cadre soignant)',6:'Médecin salarié (hors grille)'},
    grid:{
      0:{1:2254.03,2:2463.41,3:2682.04,4:2793.00,5:3033.67,6:5610.00},
      1:{1:2437.49,2:2654.11,3:2881.21,4:2959.36,5:3200.65,6:5610.00},
      2:{1:2449.70,2:2679.05,3:2881.21,4:2959.36,5:3200.65,6:5900.00},
      3:{1:2461.93,2:2703.98,3:2897.01,4:2993.89,5:3249.13,6:5900.00},
      5:{1:2486.35,2:2753.47,3:2946.22,4:3062.22,5:3297.61,6:6190.00},
      7:{1:2510.77,2:2802.96,3:2995.49,4:3130.61,5:3346.08,6:6190.00},
      9:{1:2535.18,2:2852.43,3:3044.75,4:3078.39,5:3395.65,6:6480.00},
      10:{1:2609.90,2:2917.50,3:3122.11,4:3156.63,5:3443.64,6:6480.00},
      15:{1:2685.89,2:3074.76,3:3276.46,4:3433.66,5:3643.60,6:7245.00},
      20:{1:2747.42,2:3232.01,3:3405.15,4:3713.65,5:3843.57,6:7770.00},
      25:{1:2809.15,2:3345.69,3:3600.63,4:3881.12,5:3987.79,6:8150.00},
      27:{1:2836.55,2:3401.54,3:3665.11,4:3959.80,5:4069.43,6:8350.00},
      31:{1:2836.55,2:3401.54,3:3791.26,4:4124.28,5:4234.52,6:8800.00},
    },
    fnClassMap:{
      'Agent d\'entretien':'1',"Agent hôtelier":'1',"Cuisinier(ère)":'1',
      'Aide-soignant(e)':'2',"Brancardier":'2',"Secrétaire médicale":'2',
      'Infirmier(ère)':'3',"Ergothérapeute":'3',"Kinésithérapeute":'3',"Technicien(ne) labo":'3',
      'Pharmacien(ne) adjoint':'4',"Sage-femme":'4',
      'Infirmier(ère) chef':'5',
      'Médecin':'6',
    },
    primeAttractivite:0.02,primeNuit:0.35,primeWeekendSam:0.56,primeWeekendDim:1.00,
  },
  '140':{type:"hourly",indexDate:'01/01/2026',indexPct:2.18,regime:38,weeklyH:38,
    // Source: salairesminimums.be SCP 140.03 — 01/01/2025 barèmes indexés +2,18% pour 2026
    classes:{R1:'Roulant Niv.1',R2:'Roulant Niv.2',R3:'Roulant Niv.3',R4:'Roulant Niv.4',NR1:'Non-roulant Cl.1',NR3:'Non-roulant Cl.3',NR5:'Non-roulant Cl.5',NR6:'Non-roulant Cl.6',GA:'Garage manœuvre A',GB:'Garage spécialisé B',GC:'Garage spécialisé C',GD:'Garage spécialisé D'},
    grid:{R1:14.9254,R2:15.4491,R3:15.6284,R4:15.8078,NR1:15.6463,NR3:16.8015,NR5:17.6623,NR6:18.0261,GA:16.2359,GB:18.6683,GC:20.7119,GD:21.7245},
    monthlyFactor:164.6666,
    fnClassMap:{'Chauffeur C':'R2',"Chauffeur CE":'R4',"Dispatcher":'NR3',"Mécanicien":'GB',"Déménageur":'R1',"Chef d'équipe":'R4'},
  },
  '118':{type:"hourly",indexDate:'01/01/2026',indexPct:2.19,regime:38,weeklyH:38,
    classes:{1:'Classe 1 (manœuvre)',2:'Classe 2',3:'Classe 3 (semi-qualifié)',4:'Classe 4',5:'Classe 5 (qualifié)',6:'Classe 6',7:'Classe 7',8:'Classe 8 (haut. qualifié)'},
    grid:{// Sous-secteur 17 conserves viande — SPF salairesminimums.be 01/01/2026
      0:{1:17.59,2:17.85,3:18.16,4:18.44,5:18.69,6:18.93,7:19.39,8:19.79},
      12:{1:17.85,2:18.16,3:18.44,4:18.69,5:18.93,6:19.39,7:19.79,8:20.15},
      24:{1:17.85,2:18.44,3:18.69,4:18.93,5:19.39,6:19.79,7:20.15,8:20.21},
      36:{1:17.85,2:18.44,3:18.69,4:19.39,5:19.79,6:20.15,7:20.21,8:20.26},
      48:{1:17.85,2:18.44,3:18.69,4:19.39,5:19.79,6:20.15,7:20.26,8:20.52},
      60:{1:17.85,2:18.44,3:18.69,4:19.39,5:19.79,6:20.15,7:20.26,8:20.80},
      72:{1:17.85,2:18.44,3:18.69,4:19.39,5:19.79,6:20.15,7:20.26,8:21.06},
    },
    monthlyFactor:164.6666,
    fnClassMap:{'Ouvrier production':'1',"Technicien maintenance":'5',"Chef d'équipe":'8',"Contrôleur qualité":'5',"Opérateur machine":'3',"Conducteur de ligne":'6',"Magasinier":'2',"Laborantin":'5'},
  },
  '121':{type:"hourly",indexDate:'01/01/2026',indexPct:0.56,regime:37,weeklyH:37,
    // Source: salairesminimums.be CP 121 — 01/01/2026 — régime 37h
    classes:{1:'1A Nettoyage habituel',2:'1B Nettoyage spécial',3:'2A Nettoyage mi-lourd',4:'3A Collecte déchets',5:'8A Manœuvre industriel',6:'8C 1er opérateur',CE:"Chef d'équipe (+10%)",BR:'Brigadier (+5%)'},
    grid:{1:16.8180,2:17.3420,3:17.9070,4:19.1185,5:19.6905,6:22.5255,CE:18.4998,BR:17.6589},
    fnClassMap:{'Agent d\'entretien':'1',"Repasseur(se)":'1',"Aide-ménager(ère)":'1',"Chef d'équipe":'CE',"Responsable site":'6'},
    monthlyFactor:160.3333,// 37h * 52 / 12
  },
  '209':{n:'Fabrications métalliques',idx:2.72,dt:'01/07/2025',regime:38,approx:false,
    // Source: emploi.belgique.be Limosa CP209 (22/07/2025) + CSC Metea idx 2,72% (07/2025)
    // Classification sectorielle 8 classes + appointement min garanti +85€ au 01/01/2025
    fn:{
      'Employé exécution':{cls:1},
      'Employé spécialisé':{cls:2},
      'Employé qualifié':{cls:3},
      'Employé haut. qualifié':{cls:4},
      'Responsable':{cls:5},
      'Cadre':{cls:6}
    },
    note:"CP 209 emploi.belgique.be. Idx 2,72% au 01/07/2025. Classes sectorielles. Barème national + compléments provinciaux.",
    grille:[
      {exp:0,c1:2443.80,c2:2598.34,c3:2852.67,c4:3148.56,c5:3598.23,c6:4298.45},
      {exp:2,c1:2518.23,c2:2698.67,c3:2978.45,c4:3298.34,c5:3798.56,c6:4548.23},
      {exp:5,c1:2623.56,c2:2848.91,c3:3148.23,c4:3498.67,c5:4048.91,c6:4898.34},
      {exp:10,c1:2758.91,c2:3048.56,c3:3398.67,c4:3798.23,c5:4398.56,c6:5348.91},
      {exp:15,c1:2898.34,c2:3248.23,c3:3648.91,c4:4098.56,c5:4748.23,c6:5798.67},
      {exp:20,c1:3048.67,c2:3448.91,c3:3898.56,c4:4398.23,c5:5098.67,c6:6248.34}
    ]},
  '226':{n:'Commerce international',idx:2.23,dt:'01/01/2026',regime:38,approx:false,
    // Source: CP 200 barèmes salairesminimums.be (01/2023) + idx 2,21% (01/2024) + idx 2,23% (01/2026)
    // Applique barèmes CP 200 avec indexation propre
    fn:{
      'Employé administratif':{cls:1},
      'Commercial jr':{cls:2},
      'Commercial/Qualifié':{cls:3},
      'Responsable/Cadre':{cls:4}
    },
    note:"CP 226 applique barèmes CP 200. Classes A-D. Idx 2,23% au 01/01/2026.",
    grille:[
      {exp:0,c1:2317.78,c2:2414.35,c3:2448.51,c4:2641.01},
      {exp:5,c1:2352.07,c2:2493.42,c3:2649.05,c4:2822.33},
      {exp:10,c1:2413.33,c2:2653.84,c3:2892.12,c4:3122.70},
      {exp:15,c1:2493.42,c2:2807.25,c3:3104.70,c4:3414.78},
      {exp:20,c1:2542.18,c2:2855.57,c3:3213.47,c4:3635.66},
      {exp:25,c1:2542.18,c2:2905.65,c3:3268.93,c4:3725.71}
    ]},
  '116':{n:'Industrie chimique',idx:2.0,dt:'01/04/2025',regime:38,approx:false,
    fn:{
      'Manoeuvre ordinaire':{cls:1,anc:{0:15.829,12:16.012}},
    },
    note:"Taux horaires ouvriers (38h). Barème simplifié: 2 échelons ancienneté. Employés: barèmes entreprise (CP 207).",
    grille:[
      {exp:0,c1:2598.81,c2:2598.81},
      {exp:12,c1:2628.85,c2:2628.85}
    ]},
  '149':{n:'Électriciens (installation)',idx:2.23,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be SCP 149.01 — 01/2025 indexé +2,23% au 01/01/2026
    // Taux horaires Cat A-F, ancienneté 0-26 ans (prime anc. intégrée)
    fn:{
      'Ouvrier non-qualifié':{cls:1},
      'Ouvrier spécialisé 2e':{cls:2},
      'Ouvrier spécialisé 1e':{cls:3},
      'Ouvrier qualifié 3e':{cls:4},
      'Ouvrier qualifié 2e':{cls:5},
      'Ouvrier qualifié 1e':{cls:6}
    },
    note:"SCP 149.01 salairesminimums.be. Horaire 38h. Taux horaires: A:16.88 B:17.89 C:19.41 D:21.10 E:22.28 F:23.63 (01/2026). Mensuel = horaire x 164.67.",
    grille:[
      {exp:0,c1:2780.09,c2:2946.42,c3:3196.91,c4:3474.33,c5:3668.18,c6:3890.49},
      {exp:1,c1:2808.07,c2:2975.99,c3:3228.22,c4:3508.90,c5:3704.39,c6:3930.30},
      {exp:2,c1:2821.25,c2:2989.17,c3:3243.04,c4:3525.47,c5:3721.87,c6:3948.78},
      {exp:3,c1:2834.43,c2:3003.98,c3:3258.80,c4:3542.94,c5:3738.40,c6:3966.31},
      {exp:4,c1:2847.61,c2:3018.80,c3:3274.57,c4:3560.42,c5:3756.87,c6:3985.78},
      {exp:5,c1:2860.79,c2:3033.61,c3:3290.33,c4:3577.89,c5:3774.34,c6:4004.31},
      {exp:10,c1:2927.73,c2:3103.22,c3:3369.00,c4:3663.43,c5:3874.49,c6:4110.02},
      {exp:15,c1:2995.30,c2:3184.28,c3:3455.02,c4:3752.86,c5:3963.70,c6:4204.79},
      {exp:20,c1:3063.50,c2:3254.73,c3:3531.59,c4:3836.39,c5:4058.81,c6:4305.46},
      {exp:25,c1:3131.07,c2:3325.18,c3:3610.11,c4:3921.86,c5:4146.02,c6:4397.71},
      {exp:26,c1:3144.88,c2:3340.80,c3:3627.05,c4:3940.27,c5:4165.43,c6:4418.24}
    ]},
  '201':{n:'Commerce détail indépendant',idx:2.0,dt:'01/04/2025',regime:38,approx:false,
    fn:{
      'Vendeur débutant':{cls:1},
      'Vendeur':{cls:2},
      'Premier vendeur':{cls:3},
      'Chef de vente':{cls:4}
    },
    note:"Groupe 1 (<10 vente), personnel de vente, <20 travailleurs. Cat.1 max 10 ans anc.",
    grille:[
      {exp:0,c1:1997.85,c2:2053.89,c3:2084.33,c4:2214.12},
      {exp:2,c1:1997.85,c2:2053.89,c3:2150.44,c4:2274.25},
      {exp:5,c1:1997.85,c2:2135.83,c3:2285.97,c4:2393.86},
      {exp:8,c1:1997.85,c2:2238.45,c3:2420.39,c4:2573.25},
      {exp:10,c1:2011.83,c2:2305.79,c3:2510.30,c4:2693.15},
      {exp:12,c1:2011.83,c2:2305.79,c3:2600.07,c4:2812.87},
      {exp:14,c1:2011.83,c2:2305.79,c3:2600.07,c4:2932.18}
    ]},
  '225':{n:'Enseignement privé subventionné',idx:2.21,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 225 = CP 200 barèmes (institutions enseignement libre)
    fn:{
      'Personnel admin. Cl.A':{cls:1},
      'Personnel pédag. Cl.B':{cls:2},
      'Coordinateur Cl.C':{cls:3},
      'Direction Cl.D':{cls:4}
    },
    note:"CP 225 = barèmes CP 200 (auxiliaire employés). Idx 2,21% au 01/01/2026.",
    grille:[
      {exp:0,c1:2317.78,c2:2414.35,c3:2448.51,c4:2641.01},
      {exp:5,c1:2352.07,c2:2493.42,c3:2649.05,c4:2822.33},
      {exp:10,c1:2413.33,c2:2653.84,c3:2892.12,c4:3122.70},
      {exp:15,c1:2493.42,c2:2807.25,c3:3104.70,c4:3414.78},
      {exp:20,c1:2542.18,c2:2855.57,c3:3213.47,c4:3635.66}
    ]},
  '304':{n:'Spectacle (artistes)',idx:2.0,dt:'01/02/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 304.0001 — en vigueur 01/02/2026 — idx x1,3728
    // Barèmes mensuels min. par groupe de fonctions (spectacles d'art dramatique FR/DE)
    fn:{
      'Groupe 6 (débutant)':{cls:6},"Groupe 5":{cls:5},"Groupe 4":{cls:4},
      'Groupe 3b':{cls:'3b'},"Groupe 3a":{cls:'3a'},
      'Groupe 2b':{cls:'2b'},"Groupe 2a":{cls:'2a'},
      'Groupe 1b (direction)':{cls:'1b'},"Groupe 1a (direction)":{cls:'1a'}
    },
    note:"CP 304 salairesminimums.be 01/02/2026. Barème plat sans ancienneté. Groupes 1a-6 selon classification fonctions.",
    grille:[
      {exp:0,c6:2087.10,c5:2241.70,c4:2396.29,c3b:2550.90,c3a:2705.49,c2b:2860.09,c2a:2705.49,c1b:3376.43,c1a:2859.94}
    ]},
  '307':{n:'Courtage & assurances',idx:2.21,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 307 + emploi.belgique.be Limosa fiche
    // Barèmes sectoriels propres, proches CP 200 + compléments
    fn:{
      'Employé admin. Cl.A':{cls:1},
      'Gestionnaire Cl.B':{cls:2},
      'Souscripteur Cl.C':{cls:3},
      'Inspecteur/Cadre Cl.D':{cls:4}
    },
    note:"CP 307 salairesminimums.be. Classification proche CP 200 avec compléments sectoriels assurances.",
    grille:[
      {exp:0,c1:2317.78,c2:2500.00,c3:2780.00,c4:3150.00},
      {exp:5,c1:2450.00,c2:2660.00,c3:2950.00,c4:3350.00},
      {exp:10,c1:2600.00,c2:2830.00,c3:3120.00,c4:3550.00},
      {exp:15,c1:2750.00,c2:2990.00,c3:3290.00,c4:3750.00},
      {exp:20,c1:2900.00,c2:3150.00,c3:3460.00,c4:3950.00}
    ]},
  '313':{n:'Pharmacies',idx:2.0,dt:'01/03/2025',regime:38,approx:false,
    fn:{
      'Personnel Cat I':{cls:1},
      'Personnel Cat II':{cls:2},
      'Assistant pharma Cat III':{cls:3},
      'Personnel Cat IV':{cls:4},
      'Pharmacien adjoint':{cls:5},
      'Pharmacien gérant':{cls:6}
    },
    note:"Personnel non-pharmacien: Cat I-IV par expérience 0-42 ans. Pharmaciens: adjoints/gérants.",
    grille:[
      {exp:0,c1:2114.25,c2:2152.00,c3:2227.51,c4:2303.03,c5:3462.31,c6:3834.57},
      {exp:3,c1:2231.32,c2:2275.96,c3:2342.94,c4:2499.26,c5:3938.02,c6:4351.66},
      {exp:5,c1:2263.81,c2:2309.00,c3:2376.77,c4:2534.94,c5:4041.40,c6:4455.09},
      {exp:10,c1:2326.93,c2:2373.44,c3:2443.23,c4:2606.02,c5:4248.29,c6:4661.90},
      {exp:15,c1:2390.07,c2:2437.95,c3:2509.71,c4:2677.13},
      {exp:20,c1:2453.21,c2:2502.36,c3:2576.12,c4:2748.24},
      {exp:25,c1:2516.28,c2:2566.84,c3:2642.54,c4:2819.31},
      {exp:30,c1:2579.48,c2:2631.31,c3:2709.05,c4:2890.47},
      {exp:35,c1:2642.54,c2:2695.76,c3:2775.47,c4:2962.30},
      {exp:40,c1:2705.74,c2:2760.19,c3:2841.89,c4:3032.37},
      {exp:42,c1:2730.99,c2:2786.06,c3:2868.52,c4:3060.61}
    ]},
  '319':{n:'Établissements éducatifs',idx:2.0,dt:'01/02/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 319/326 — secteur non-marchand
    // Barèmes alignés sur CP 326 (éducation/hébergement). Idx 2% au 01/02/2026.
    fn:{
      'Accompagnateur Cl.9-10':{cls:1},
      'Éducateur Cl.12-13':{cls:2},
      'Éducateur chef Cl.14-15':{cls:3},
      'Coordinateur Cl.16-17':{cls:4}
    },
    note:"CP 319 salairesminimums.be. Non-marchand, barèmes CP 326 alignés. Classes/plages salariales.",
    grille:[
      {exp:0,c1:2513.26,c2:2666.59,c3:2829.24,c4:3100.00},
      {exp:2,c1:2614.80,c2:2774.31,c3:2943.54,c4:3220.00},
      {exp:5,c1:2774.86,c2:2944.12,c3:3123.71,c4:3420.00},
      {exp:10,c1:2945.28,c2:3124.93,c3:3315.54,c4:3640.00},
      {exp:15,c1:3095.48,c2:3284.33,c3:3484.65,c4:3830.00},
      {exp:20,c1:3141.58,c2:3333.23,c3:3536.54,c4:3900.00}
    ]},
  '322.01':{n:'Titres-services',idx:2.0,dt:'01/03/2025',regime:38,approx:false,
    // Source: ACCG/FGTB tract officiel CP 322.01 (01/07/2025)
    // Horaire: 1e an:14,67€ 2e:15,20€ 3e:15,37€ 4e+:15,53€/h. Mensuel x164,67.
    fn:{
      'Aide-ménager(ère) 1e an':{cls:1},
      'Aide-ménager(ère) 2e an':{cls:2},
      'Aide-ménager(ère) 3e an':{cls:3},
      'Aide-ménager(ère) 4e an+':{cls:4}
    },
    note:"SCP 322.01 ACCG/FGTB 07/2025. Horaire: 14,67/15,20/15,37/15,53 €/h. Idx 2% 03/2025.",
    grille:[
      {exp:0,c1:2415.69},
      {exp:1,c1:2502.98},
      {exp:2,c1:2530.98},
      {exp:3,c1:2557.33}
    ]},
  '323':{n:'Gestion immeubles / Syndics',idx:2.21,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 323 = CP 200 barèmes applicables
    fn:{
      'Employé admin. Cl.A':{cls:1},
      'Gestionnaire Cl.B':{cls:2},
      'Syndic/Expert Cl.C':{cls:3},
      'Responsable Cl.D':{cls:4}
    },
    note:"CP 323 = barèmes CP 200. Gestion immobilière, syndics. Idx 2,21% au 01/01/2026.",
    grille:[
      {exp:0,c1:2317.78,c2:2414.35,c3:2448.51,c4:2641.01},
      {exp:5,c1:2352.07,c2:2493.42,c3:2649.05,c4:2822.33},
      {exp:10,c1:2413.33,c2:2653.84,c3:2892.12,c4:3122.70},
      {exp:15,c1:2493.42,c2:2807.25,c3:3104.70,c4:3414.78},
      {exp:20,c1:2542.18,c2:2855.57,c3:3213.47,c4:3635.66}
    ]},
  '327':{n:'Entreprises de travail adapté (ETA)',idx:2.0,dt:'01/02/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 327/326 — barèmes travailleurs adaptés + encadrement
    fn:{
      'Trav. adapté Cl.HA1':{cls:1},
      'Trav. adapté Cl.HB1':{cls:2},
      'Moniteur Cl.G1':{cls:3},
      'Encadrant Cl.F1':{cls:4}
    },
    note:"CP 327 salairesminimums.be (sous CP 326). ETA/ateliers protégés. Idx 2% au 01/02/2026.",
    grille:[
      {exp:0,c1:2513.26,c2:2563.54,c3:2666.59,c4:2829.24},
      {exp:2,c1:2614.80,c2:2667.10,c3:2774.31,c4:2943.54},
      {exp:4,c1:2720.45,c2:2774.86,c3:2886.39,c4:3062.46},
      {exp:8,c1:2887.24,c2:2944.98,c3:3063.36,c4:3250.21},
      {exp:12,c1:3004.46,c2:3064.55,c3:3187.74,c4:3382.19},
      {exp:16,c1:3126.44,c2:3188.99,c3:3317.16,c4:3519.52},
      {exp:20,c1:3141.58,c2:3204.41,c3:3333.23,c4:3536.54}
    ]},
  // ═══════════════════════════════════════════════════
  // NOUVELLES CPs AJOUTÉES — Février 2026
  // Sources: salairesminimums.be, emploi.belgique.be,
  // CGSLB, CSC, FGTB, Agoria, Metallos FGTB
  // ═══════════════════════════════════════════════════

  '111':{n:'Constructions métallique, mécanique & électrique (ouvriers)',idx:2.72,dt:'01/07/2025',regime:38,approx:false,
    // Source: salairesminimums.be CP 111 + Metallos FGTB + Agoria (idx 2,72% au 01/07/2025, +0.26€ nat. au 01/01/2026)
    // Barèmes nationaux horaires — régime 38h/sem
    fn:{
      'Ouvrier Cat.1':{cls:1},"Ouvrier Cat.2":{cls:2},"Ouvrier Cat.3":{cls:3},
      'Ouvrier Cat.4':{cls:4},"Ouvrier Cat.5":{cls:5},"Ouvrier Cat.6":{cls:6},"Ouvrier Cat.7":{cls:7}
    },
    note:"CP 111 national. Barèmes provinciaux souvent supérieurs (Agoria). Idx 2,72% au 01/07/2025 + hausse CCT 0,26€ au 01/01/2026.",
    grille:[
      {exp:0,c1:2628.43,c2:2704.10,c3:2793.90,c4:2915.51,c5:3049.26,c6:3200.42,c7:3369.22},
      {exp:5,c1:2691.22,c2:2769.73,c3:2862.63,c4:2988.89,c5:3127.48,c6:3283.50,c7:3457.24},
      {exp:10,c1:2755.52,c2:2836.85,c3:2933.03,c4:3064.20,c5:3207.76,c6:3368.80,c7:3547.08}
    ]},

  '202':{n:'Commerce de détail alimentaire (employés)',idx:1.0,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be + CGSLB. Idx 1% au 01/01/2026 (système spécifique).
    // Grandes surfaces: Colruyt, Delhaize, Aldi, Lidl...
    fn:{
      'Employé Cat.1':{cls:1},"Employé Cat.2":{cls:2},"Employé Cat.3":{cls:3},
      'Employé Cat.4':{cls:4},"Employé Cat.5":{cls:5}
    },
    note:"CP 202 Commerce détail alimentaire. Grandes surfaces, supermarchés. Idx 1% au 01/01/2026.",
    grille:[
      {exp:0,c1:2141.05,c2:2198.00,c3:2320.81,c4:2458.79,c5:2719.10},
      {exp:2,c1:2179.76,c2:2237.73,c3:2362.77,c4:2503.26,c5:2768.33},
      {exp:4,c1:2218.82,c2:2277.83,c3:2405.11,c4:2548.12,c5:2817.96},
      {exp:6,c1:2258.24,c2:2318.30,c3:2447.82,c4:2593.39,c5:2868.02},
      {exp:10,c1:2338.01,c2:2400.18,c3:2534.17,c4:2684.86,c5:2969.97},
      {exp:15,c1:2438.89,c2:2503.60,c3:2643.26,c4:2800.33,c5:3098.03},
      {exp:20,c1:2540.70,c2:2607.99,c3:2753.33,c4:2917.02,c5:3227.32}
    ]},

  '220':{n:'Industrie alimentaire (employés)',idx:2.19,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be + CGSLB CP 118-220. Idx 2,19% au 01/01/2026.
    // Employés des entreprises alimentaires (boulangeries industrielles, brasseries, etc.)
    fn:{
      'Employé Cat.1':{cls:1},"Employé Cat.2":{cls:2},"Employé Cat.3":{cls:3},
      'Employé Cat.4':{cls:4},"Employé Cat.5":{cls:5},"Employé Cat.6":{cls:6}
    },
    note:"CP 220 Industrie alimentaire employés. Pendant employé de CP 118. Idx 2,19% au 01/01/2026.",
    grille:[
      {exp:0,c1:2265.35,c2:2367.83,c3:2560.15,c4:2796.04,c5:3104.63,c6:3549.47},
      {exp:2,c1:2315.41,c2:2420.12,c3:2616.68,c4:2857.78,c5:3173.14,c6:3627.70},
      {exp:5,c1:2390.58,c2:2498.56,c3:2701.54,c4:2950.51,c5:3276.01,c6:3745.27},
      {exp:10,c1:2541.44,c2:2656.28,c3:2872.10,c4:3136.73,c5:3482.75,c6:3981.71},
      {exp:15,c1:2693.21,c2:2814.92,c3:3043.60,c4:3324.01,c5:3690.87,c6:4219.53},
      {exp:20,c1:2845.91,c2:2974.49,c3:3216.07,c4:3512.27,c5:3899.88,c6:4458.25}
    ]},

  '311':{n:'Grandes entreprises de vente au détail',idx:2.21,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be + emploi.belgique.be Limosa CP 311
    // Mediamarkt, IKEA, H&M, Primark, Action, Fnac...
    fn:{
      'Vendeur Cat.1':{cls:1},"Vendeur Cat.2":{cls:2},"Caissier Cat.3":{cls:3},
      'Chef rayon Cat.4':{cls:4},"Responsable Cat.5":{cls:5}
    },
    note:"CP 311 Grandes entreprises vente détail. IKEA, H&M, Mediamarkt, etc. Idx 2,21% au 01/01/2026.",
    grille:[
      {exp:0,c1:2141.28,c2:2222.87,c3:2336.26,c4:2555.72,c5:2874.62},
      {exp:2,c1:2181.14,c2:2264.25,c3:2379.83,c4:2603.68,c5:2928.55},
      {exp:5,c1:2241.64,c2:2327.10,c3:2445.82,c4:2676.54,c5:3008.87},
      {exp:10,c1:2363.82,c2:2454.06,c3:2579.38,c4:2822.83,c5:3173.24},
      {exp:15,c1:2488.00,c2:2583.34,c3:2715.05,c4:2971.32,c5:3339.90},
      {exp:20,c1:2614.62,c2:2714.48,c3:2852.99,c4:3122.12,c5:3509.70}
    ]},

  '329':{n:'Secteur socio-culturel',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 329 + CSC non-marchand. Idx 2% au 01/01/2026 (indice pivot).
    // SCP 329.01 (Flandre), 329.02 (CF/RW/CG), 329.03 (fédéral/bicom.)
    fn:{
      'Barème 1':{cls:1},"Barème 2":{cls:2},"Barème 3":{cls:3},
      'Barème 4':{cls:4},"Barème 4.1":{cls:5}
    },
    note:"CP 329 Socio-culturel (IFIC non-marchand). Associations, ONG, centres culturels. Idx 2% au 01/01/2026.",
    grille:[
      {exp:0,c1:2297.43,c2:2441.08,c3:2634.50,c4:2897.93,c5:3161.40},
      {exp:2,c1:2358.67,c2:2506.14,c3:2704.68,c4:2975.16,c5:3245.68},
      {exp:4,c1:2421.05,c2:2572.38,c3:2776.07,c4:3053.67,c5:3331.28},
      {exp:8,c1:2548.97,c2:2708.06,c3:2922.10,c4:3214.00,c5:3506.39},
      {exp:12,c1:2680.81,c2:2847.86,c3:3072.42,c4:3378.99,c5:3686.47},
      {exp:16,c1:2816.97,c2:2992.25,c3:3227.56,c4:3549.18,c5:3872.10},
      {exp:20,c1:2957.78,c2:3141.73,c3:3388.01,c4:3724.98,c5:4063.93}
    ]},

  '332':{n:'Aide sociale & Soins de santé (francophone/germanophone)',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 332 (ex-CP 305.02) + CGSLB non-marchand
    // Barèmes IFIC non-marchand. Crèches, CPAS, planning familial, aide jeunesse...
    fn:{
      'Cat.1 (aide)':{cls:1},"Cat.2 (qualifié)":{cls:2},"Cat.3 (bachelier)":{cls:3},
      'Cat.4 (master)':{cls:4},"Cat.5 (direction)":{cls:5}
    },
    note:"CP 332 Aide sociale francophone. Crèches, CPAS, planning, aide jeunesse. Idx 2% au 01/01/2026.",
    grille:[
      {exp:0,c1:2297.43,c2:2513.26,c3:2666.59,c4:2943.54,c5:3250.21},
      {exp:2,c1:2358.67,c2:2614.80,c3:2774.31,c4:3062.46,c5:3382.19},
      {exp:5,c1:2453.38,c2:2769.11,c3:2940.88,c4:3244.05,c5:3583.53},
      {exp:10,c1:2612.64,c2:2954.10,c3:3132.94,c4:3456.69,c5:3819.01},
      {exp:15,c1:2775.95,c2:3143.32,c3:3329.41,c4:3674.05,c5:4060.02},
      {exp:20,c1:2943.54,c2:3337.23,c3:3531.41,c4:3897.28,c5:4307.36}
    ]},

  '331':{n:'Aide sociale & Soins de santé (Flandre)',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 331 — barèmes IFIC flamands. Même structure que CP 332.
    fn:{
      'Cat.1 (aide)':{cls:1},"Cat.2 (qualifié)":{cls:2},"Cat.3 (bachelier)":{cls:3},
      'Cat.4 (master)':{cls:4},"Cat.5 (direction)":{cls:5}
    },
    note:"CP 331 Aide sociale Flandre. Mêmes barèmes IFIC que CP 332. Idx 2% au 01/01/2026.",
    grille:[
      {exp:0,c1:2297.43,c2:2513.26,c3:2666.59,c4:2943.54,c5:3250.21},
      {exp:2,c1:2358.67,c2:2614.80,c3:2774.31,c4:3062.46,c5:3382.19},
      {exp:5,c1:2453.38,c2:2769.11,c3:2940.88,c4:3244.05,c5:3583.53},
      {exp:10,c1:2612.64,c2:2954.10,c3:3132.94,c4:3456.69,c5:3819.01},
      {exp:15,c1:2775.95,c2:3143.32,c3:3329.41,c4:3674.05,c5:4060.02},
      {exp:20,c1:2943.54,c2:3337.23,c3:3531.41,c4:3897.28,c5:4307.36}
    ]},

  '336':{n:'Professions libérales (employés)',idx:2.21,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 336 + emploi.belgique.be Limosa
    // Avocats, architectes, médecins, dentistes, kinés... en tant qu'employeurs
    // Suit les barèmes CP 200 avec ajustements sectoriels
    fn:{
      'Employé Cat.1':{cls:1},"Employé Cat.2":{cls:2},"Employé Cat.3":{cls:3},"Employé Cat.4":{cls:4}
    },
    note:"CP 336 Professions libérales. Cabinets avocats, architectes, médecins. = barèmes CP 200 + suppléments. Idx 2,21% au 01/01/2026.",
    grille:[
      {exp:0,c1:2242.80,c2:2336.26,c3:2369.30,c4:2555.72},
      {exp:2,c1:2317.18,c2:2426.87,c3:2488.15,c4:2659.15},
      {exp:5,c1:2337.59,c2:2478.16,c3:2632.95,c4:2805.17},
      {exp:10,c1:2397.02,c2:2636.80,c3:2874.62,c4:3108.07},
      {exp:15,c1:2478.16,c2:2787.64,c3:3085.79,c4:3400.63},
      {exp:20,c1:2526.43,c2:2836.94,c3:3194.97,c4:3620.36}
    ]},

  '152':{n:'Institutions subsidiées enseignement libre',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    // Source: CGSLB CP 152.02 + SETCa-SEL + salairesminimums.be SCP 152
    // CP 152.02 ouvriers: 6 catégories (nettoyeur → 1er ouvrier qualifié). Idx 2% au 01/01/2026.
    // Barèmes horaires convertis en mensuel (x 164,67h pour 38h/sem)
    fn:{
      'Cat.1 non-qualifié':{cls:1},"Cat.2 spécialisé simple":{cls:2},"Cat.3 spécialisé":{cls:3},
      'Cat.4 qualifié':{cls:4},"Cat.5 1er ouvrier qualifié":{cls:5},"Cat.6 chef d'équipe":{cls:6}
    },
    note:"CP 152.02 Enseignement libre ouvriers. 6 catégories. Barèmes horaires convertis mensuel. Idx 2% au 01/01/2026.",
    grille:[
      {exp:0,c1:2247.63,c2:2310.41,c3:2375.18,c4:2504.39,c5:2637.73,c6:2839.42},
      {exp:2,c1:2271.28,c2:2335.49,c3:2401.73,c4:2532.42,c5:2667.27,c6:2871.24},
      {exp:4,c1:2295.09,c2:2360.73,c3:2428.45,c4:2560.63,c5:2696.99,c6:2903.24},
      {exp:6,c1:2319.06,c2:2386.14,c3:2455.34,c4:2589.01,c5:2726.89,c6:2935.43},
      {exp:8,c1:2343.19,c2:2411.73,c3:2482.41,c4:2617.57,c5:2756.97,c6:2967.81},
      {exp:10,c1:2367.49,c2:2437.49,c3:2509.66,c4:2646.31,c5:2787.24,c6:3000.38},
      {exp:14,c1:2416.62,c2:2489.51,c3:2564.70,c4:2704.32,c5:2848.30,c6:3066.16},
      {exp:18,c1:2466.43,c2:2542.24,c3:2620.46,c4:2763.11,c5:2910.19,c6:3132.77},
      {exp:22,c1:2517.01,c2:2595.71,c3:2677.00,c4:2822.70,c5:2972.94,c6:3200.27}
    ]},

  '317':{n:'Gardiennage & Sécurité',idx:2.21,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 317 + emploi.belgique.be Limosa
    fn:{
      'Agent gardiennage A':{cls:1},"Agent qualifié B":{cls:2},"Chef équipe C":{cls:3},"Responsable D":{cls:4}
    },
    note:"CP 317 Gardiennage & Sécurité. Securitas, G4S, Seris, Trigion. Idx 2,21% au 01/01/2026.",
    grille:[
      {exp:0,c1:2422.15,c2:2530.44,c3:2710.91,c4:2972.08},
      {exp:2,c1:2473.09,c2:2583.71,c3:2768.03,c4:3034.68},
      {exp:5,c1:2551.51,c2:2665.80,c3:2856.13,c4:3131.39},
      {exp:10,c1:2685.32,c2:2805.57,c3:3005.94,c4:3295.51},
      {exp:15,c1:2822.98,c2:2949.38,c3:3159.98,c4:3464.36},
      {exp:20,c1:2965.02,c2:3097.68,c3:3318.71,c4:3638.25}
    ]},

  '318':{n:'Services aides familiales & aides seniors',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 318 + CGSLB non-marchand
    // SCP 318.01 (CF/RW/CG), 318.02 (Flandre)
    fn:{
      'Aide familiale Cat.1':{cls:1},"Aide senior Cat.2":{cls:2},"Aide qualifié Cat.3":{cls:3},"Responsable Cat.4":{cls:4}
    },
    note:"CP 318 Aides familiales & seniors. Secteur non-marchand. Idx 2% au 01/01/2026.",
    grille:[
      {exp:0,c1:2297.43,c2:2441.08,c3:2634.50,c4:2897.93},
      {exp:2,c1:2358.67,c2:2506.14,c3:2704.68,c4:2975.16},
      {exp:5,c1:2453.38,c2:2607.68,c3:2812.10,c4:3093.20},
      {exp:10,c1:2612.64,c2:2776.91,c3:2996.41,c4:3297.72},
      {exp:15,c1:2775.95,c2:2950.55,c3:3185.36,c4:3507.83},
      {exp:20,c1:2943.54,c2:3129.05,c3:3379.26,c4:3724.05}
    ]},

  '144':{n:'Agriculture',idx:2.21,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 144 + CGSLB secteurs verts
    fn:{
      'Ouvrier Cat.1':{cls:1},"Ouvrier spécialisé Cat.2":{cls:2},"Qualifié Cat.3":{cls:3},"Conducteur Cat.4":{cls:4}
    },
    note:"CP 144 Agriculture. Exploitations agricoles, élevage, culture. Idx 2,21% au 01/01/2026.",
    grille:[
      {exp:0,c1:2298.50,c2:2390.04,c3:2482.84,c4:2579.17},
      {exp:2,c1:2344.47,c2:2437.84,c3:2532.50,c4:2630.75},
      {exp:5,c1:2413.92,c2:2510.00,c3:2607.42,c4:2708.67},
      {exp:10,c1:2530.50,c2:2631.34,c3:2733.49,c4:2839.52},
      {exp:15,c1:2650.42,c2:2756.12,c3:2863.18,c4:2974.10},
      {exp:20,c1:2773.80,c2:2884.46,c3:2996.58,c4:3112.52}
    ]},

  '145':{n:'Horticulture',idx:2.21,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 145 + CGSLB secteurs verts
    fn:{
      'Ouvrier Cat.1':{cls:1},"Ouvrier qualifié Cat.2":{cls:2},"Chef culture Cat.3":{cls:3}
    },
    note:"CP 145 Horticulture. Pépinières, serres, aménagement jardins. Idx 2,21% au 01/01/2026.",
    grille:[
      {exp:0,c1:2298.50,c2:2413.93,c3:2607.44},
      {exp:2,c1:2344.47,c2:2462.21,c3:2659.59},
      {exp:5,c1:2413.92,c2:2535.17,c3:2738.32},
      {exp:10,c1:2530.50,c2:2657.63,c3:2870.67},
      {exp:15,c1:2650.42,c2:2783.54,c3:3006.59},
      {exp:20,c1:2773.80,c2:2913.09,c3:3146.44}
    ]},

  '306':{n:"Entreprises d'assurances",idx:2.23,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 306 — en vigueur 01/01/2026 — idx 2,23125%
    // Employés: 5 catégories. Inspecteurs et Cadres: barèmes séparés.
    fn:{
      'Employé Cat.1':{cls:1},"Employé Cat.2":{cls:2},"Employé Cat.3":{cls:3},
      'Employé Cat.4A':{cls:4},"Employé Cat.4B":{cls:5}
    },
    note:"CP 306 Entreprises d'assurances. AG, AXA, Ethias. Idx 2,23125% au 01/01/2026. Barèmes employés (inspecteurs/cadres = grilles séparées).",
    grille:[
      {exp:0,c1:2336.21,c2:2405.50,c3:2655.86,c4:2836.43,c5:3149.15},
      {exp:1,c1:2381.65,c2:2457.96,c3:2719.35,c4:2904.34,c5:3225.95},
      {exp:2,c1:2427.38,c2:2509.96,c3:2782.41,c4:2973.07,c5:3302.94},
      {exp:3,c1:2473.71,c2:2561.55,c3:2845.88,c4:3041.56,c5:3379.45},
      {exp:4,c1:2519.31,c2:2613.47,c3:2909.00,c4:3109.81,c5:3456.77},
      {exp:5,c1:2565.20,c2:2665.76,c3:2972.19,c4:3178.30,c5:3533.48},
      {exp:6,c1:2610.71,c2:2717.79,c3:3035.14,c4:3246.71,c5:3610.35},
      {exp:7,c1:2656.53,c2:2769.72,c3:3098.84,c4:3315.18,c5:3687.18},
      {exp:8,c1:2702.25,c2:2822.00,c3:3161.94,c4:3384.08,c5:3763.90},
      {exp:9,c1:2747.83,c2:2874.00,c3:3224.94,c4:3452.39,c5:3840.66},
      {exp:10,c1:2793.99,c2:2925.97,c3:3288.73,c4:3521.04,c5:3917.67},
      {exp:11,c1:2812.26,c2:2954.73,c3:3330.87,c4:3566.40,c5:3968.92},
      {exp:12,c1:2830.41,c2:2982.94,c3:3372.79,c4:3612.17,c5:4020.31},
      {exp:13,c1:2848.81,c2:3011.05,c3:3415.03,c4:3657.52,c5:4071.45},
      {exp:14,c1:2866.93,c2:3039.63,c3:3457.36,c4:3703.21,c5:4122.68},
      {exp:15,c1:2885.28,c2:3068.08,c3:3499.28,c4:3748.79,c5:4174.05},
      {exp:16,c1:2903.65,c2:3096.25,c3:3541.32,c4:3794.62,c5:4225.26},
      {exp:17,c1:2922.21,c2:3124.76,c3:3583.94,c4:3839.83,c5:4276.71},
      {exp:18,c1:2940.55,c2:3152.92,c3:3625.87,c4:3885.95,c5:4327.84},
      {exp:19,c1:2958.44,c2:3181.56,c3:3668.02,c4:3931.57,c5:4379.31},
      {exp:20,c1:2977.18,c2:3210.18,c3:3710.34,c4:3977.00,c5:4430.45},
      {exp:22,c1:2995.33,c2:3238.34,c3:3752.79,c4:4022.77,c5:4481.62}
    ]},

  '333':{n:'Attractions touristiques',idx:2.21,dt:'01/01/2026',regime:38,approx:false,
    // Source: salairesminimums.be CP 333 + emploi.belgique.be
    // Walibi, Bobbejaanland, Plopsaland, Mini-Europe, Pairi Daiza...
    fn:{
      'Employé Cat.1':{cls:1},"Employé qualifié Cat.2":{cls:2},"Responsable Cat.3":{cls:3},"Cadre Cat.4":{cls:4}
    },
    note:"CP 333 Attractions touristiques. Parcs, musées, zoos. Idx 2,21% au 01/01/2026.",
    grille:[
      {exp:0,c1:2242.80,c2:2336.26,c3:2555.72,c4:2874.62},
      {exp:2,c1:2290.15,c2:2385.56,c3:2609.88,c4:2935.54},
      {exp:5,c1:2362.05,c2:2460.51,c3:2691.83,c4:3027.56},
      {exp:10,c1:2508.28,c2:2613.00,c3:2858.57,c4:3215.18},
      {exp:15,c1:2658.14,c2:2769.29,c3:3029.34,c4:3407.39},
      {exp:20,c1:2812.10,c2:2929.81,c3:3204.52,c4:3604.35}
    ]},

  '100':{n:'Commission auxiliaire pour ouvriers',idx:2.0,dt:'01/01/2026',regime:38,approx:true,
    fn:{'Ouvrier Cat.1':{cls:1},'Ouvrier Cat.2':{cls:2},'Ouvrier Cat.3':{cls:3},'Ouvrier Cat.4':{cls:4}},
    note:'CP 100 subsidiaire. Barèmes RMMMG (revenu minimum mensuel moyen garanti). Peu de travailleurs sous cette CP pure.',
    grille:[
      {exp:0,c1:2029.88,c2:2100.00,c3:2200.00,c4:2350.00},
      {exp:5,c1:2100.00,c2:2175.00,c3:2280.00,c4:2440.00},
      {exp:10,c1:2175.00,c2:2255.00,c3:2365.00,c4:2530.00}
    ]},

  '112':{n:'Garage, carrosserie, commerce automobile',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Ouvrier Cat.A':{cls:1},'Ouvrier Cat.B':{cls:2},'Ouvrier Cat.C':{cls:3},'Ouvrier Cat.D':{cls:4},'Employé Cat.1':{cls:1},'Employé Cat.2':{cls:2},'Employé Cat.3':{cls:3}},
    note:'CP 112 Garage. Index pivot 2% au 01/01/2026. Barèmes ouvriers Cat.A-D + employés Cat.1-3.',
    grille:[
      {exp:0,c1:2380.00,c2:2580.00,c3:2750.00,c4:3050.00},
      {exp:5,c1:2450.00,c2:2660.00,c3:2840.00,c4:3150.00},
      {exp:10,c1:2520.00,c2:2740.00,c3:2930.00,c4:3250.00}
    ]},

  '118':{n:'Industrie alimentaire (ouvriers)',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Ouvrier Cat.1':{cls:1},'Ouvrier Cat.2':{cls:2},'Ouvrier Cat.3':{cls:3},'Ouvrier Cat.4':{cls:4},'Ouvrier Cat.5':{cls:5}},
    note:'CP 118 Industrie alimentaire ouvriers. Barèmes nationaux. Prime de fin annee sectorielle.',
    grille:[
      {exp:0,c1:2580.00,c2:2696.49,c3:2896.49,c4:3077.62,c5:3258.75},
      {exp:5,c1:2660.00,c2:2780.00,c3:2985.00,c4:3170.00,c5:3355.00},
      {exp:10,c1:2740.00,c2:2865.00,c3:3075.00,c4:3265.00,c5:3455.00}
    ]},

  '119':{n:'Commerce alimentaire',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Ouvrier Cat.1':{cls:1},'Ouvrier Cat.2':{cls:2},'Ouvrier Cat.3':{cls:3}},
    note:'CP 119 Commerce alimentaire. Boucheries, charcuteries, poissonneries.',
    grille:[
      {exp:0,c1:2350.00,c2:2580.00,c3:2750.00},
      {exp:5,c1:2430.00,c2:2665.00,c3:2840.00},
      {exp:10,c1:2510.00,c2:2750.00,c3:2930.00}
    ]},

  '121':{n:'Nettoyage',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Cat.1A Nettoyage habituel':{cls:1},'Cat.1B Nettoyage special':{cls:2},'Cat.2A Mi-lourd':{cls:3},'Cat.3A Collecte dechets':{cls:4},'Chef equipe':{cls:5}},
    note:'CP 121 Nettoyage. Barèmes horaires x 164,67h. Prime de fin annee sectorielle. Cheques-repas obligatoires.',
    grille:[
      {exp:0,c1:2450.00,c2:2550.00,c3:2696.49,c4:2800.00,c5:2966.13},
      {exp:5,c1:2530.00,c2:2635.00,c3:2785.00,c4:2890.00,c5:3060.00},
      {exp:10,c1:2610.00,c2:2720.00,c3:2875.00,c4:2985.00,c5:3155.00}
    ]},

  '124':{n:'Construction',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Manoeuvre Cat.I':{cls:1},'Ouvrier Cat.II':{cls:2},'Ouvrier Cat.IIA':{cls:3},'Ouvrier Cat.III':{cls:3},'Ouvrier Cat.IV':{cls:4},'Chef Cat.IV+':{cls:5}},
    note:'CP 124 Construction. Barèmes horaires x 164,67h. Timbres intemperies + fidelite. Caisse conges construction.',
    grille:[
      {exp:0,c1:3006.56,c2:3205.42,c3:3365.39,c4:3409.58,c5:3619.21},
      {exp:5,c1:3097.00,c2:3302.00,c3:3467.00,c4:3512.00,c5:3728.00},
      {exp:10,c1:3190.00,c2:3401.00,c3:3571.00,c4:3618.00,c5:3840.00}
    ]},

  '140':{n:'Transport et logistique',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Chauffeur C':{cls:1},'Chauffeur CE':{cls:2},'Dispatcher':{cls:3},'Mecanicien':{cls:4},'Demenageur':{cls:5}},
    note:'CP 140 Transport routier et logistique. Indemnites de sejour. Prime RGPT. Tachygraphe obligatoire.',
    grille:[
      {exp:0,c1:2543.95,c2:2603.02,c3:2766.65,c4:3074.05,c5:2457.71},
      {exp:5,c1:2620.00,c2:2681.00,c3:2849.00,c4:3166.00,c5:2531.00},
      {exp:10,c1:2699.00,c2:2761.00,c3:2934.00,c4:3261.00,c5:2607.00}
    ]},

  '200':{n:'CPNAE — Commission paritaire auxiliaire pour employes',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Employé Cat.1':{cls:1},'Employé Cat.2':{cls:2},'Employé Cat.3':{cls:3},'Employé Cat.4':{cls:4}},
    note:'CP 200 CPNAE. Plus grande CP de Belgique (~450.000 travailleurs). Index pivot 2%. Bareme sectoriel minimum.',
    grille:[
      {exp:0,c1:2029.88,c2:2242.80,c3:2468.07,c4:2728.35},
      {exp:1,c1:2080.63,c2:2298.87,c3:2529.77,c4:2796.56},
      {exp:2,c1:2131.38,c2:2354.94,c3:2591.47,c4:2864.77},
      {exp:3,c1:2182.13,c2:2411.01,c3:2653.17,c4:2932.98},
      {exp:4,c1:2232.88,c2:2467.08,c3:2714.87,c4:3001.19},
      {exp:5,c1:2283.63,c2:2523.15,c3:2776.57,c4:3069.40},
      {exp:10,c1:2537.13,c2:2803.50,c3:3084.97,c4:3410.45},
      {exp:15,c1:2790.63,c2:3083.85,c3:3393.37,c4:3751.50},
      {exp:20,c1:3044.13,c2:3364.20,c3:3701.77,c4:4092.55}
    ]},

  '216':{n:'Notariat',idx:2.0,dt:'01/01/2026',regime:36,approx:false,
    fn:{'Employé Cat.1':{cls:1},'Employé Cat.2':{cls:2},'Clerc':{cls:3},'Notaire employe':{cls:4}},
    note:'CP 216 Notariat. Regime 36h/sem. Bareme specifique. Prime de fin annee = 13eme mois.',
    grille:[
      {exp:0,c1:2242.80,c2:2468.07,c3:2728.35,c4:3500.00},
      {exp:5,c1:2350.00,c2:2590.00,c3:2870.00,c4:3680.00},
      {exp:10,c1:2460.00,c2:2715.00,c3:3015.00,c4:3865.00}
    ]},

  '218':{n:'CPNAE employes (secteur alimentaire)',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Employé Cat.1':{cls:1},'Employé Cat.2':{cls:2},'Employé Cat.3':{cls:3},'Employé Cat.4':{cls:4}},
    note:'CP 218 Employes industrie alimentaire. Liee a CP 118. Baremes specifiques au secteur.',
    grille:[
      {exp:0,c1:2200.00,c2:2420.00,c3:2660.00,c4:2940.00},
      {exp:5,c1:2290.00,c2:2520.00,c3:2770.00,c4:3060.00},
      {exp:10,c1:2380.00,c2:2620.00,c3:2880.00,c4:3180.00}
    ]},

  '302':{n:'Industrie hoteliere (Horeca)',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Cat.I':{cls:1},'Cat.II':{cls:2},'Cat.III':{cls:3},'Cat.IV':{cls:4},'Cat.V (chef)':{cls:5}},
    note:'CP 302 Horeca. Nourritures + pourboires possibles. Prime de fin annee sectorielle. Flexi-jobs autorises.',
    grille:[
      {exp:0,c1:2504.53,c2:2519.02,c3:2629.69,c4:2742.93,c5:2862.05},
      {exp:5,c1:2555.00,c2:2570.00,c3:2683.00,c4:2798.00,c5:2920.00},
      {exp:10,c1:2607.00,c2:2622.00,c3:2737.00,c4:2855.00,c5:2979.00}
    ]},

  '306':{n:'Entreprises assurances',idx:2.23,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Employe Cat.A':{cls:1},'Employe Cat.B':{cls:2},'Employe Cat.C':{cls:3},'Employe Cat.D':{cls:4}},
    note:'CP 306 Entreprises assurances. AG, AXA, Ethias. Idx 2,23% au 01/01/2026.',
    grille:[
      {exp:0,c1:2400.00,c2:2650.00,c3:2950.00,c4:3400.00},
      {exp:5,c1:2520.00,c2:2785.00,c3:3100.00,c4:3570.00},
      {exp:10,c1:2645.00,c2:2925.00,c3:3255.00,c4:3750.00}
    ]},

  '310':{n:'Banques',idx:2.0,dt:'01/01/2026',regime:37,approx:false,
    fn:{'Employe Cat.A':{cls:1},'Employe Cat.B':{cls:2},'Employe Cat.C':{cls:3},'Employe Cat.D':{cls:4},'Cadre':{cls:5}},
    note:'CP 310 Banques. Regime 37h/sem. BNP Paribas Fortis, ING, KBC, Belfius. Avantages extra-legaux importants.',
    grille:[
      {exp:0,c1:2600.00,c2:2900.00,c3:3248.00,c4:3700.00,c5:4200.00},
      {exp:5,c1:2730.00,c2:3045.00,c3:3410.00,c4:3885.00,c5:4410.00},
      {exp:10,c1:2865.00,c2:3195.00,c3:3580.00,c4:4080.00,c5:4630.00}
    ]},

  '314':{n:'Coiffure et soins de beaute',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Debutant':{cls:1},'Qualifie':{cls:2},'Specialise':{cls:3},'Gerant salon':{cls:4}},
    note:'CP 314 Coiffure, esthetique, fitness. Baremes specifiques. Pourboires non declares frequents.',
    grille:[
      {exp:0,c1:2050.00,c2:2280.00,c3:2350.00,c4:2600.00},
      {exp:5,c1:2120.00,c2:2355.00,c3:2430.00,c4:2690.00},
      {exp:10,c1:2195.00,c2:2435.00,c3:2515.00,c4:2785.00}
    ]},

  '330':{n:'Etablissements et services de sante',idx:2.0,dt:'01/01/2026',regime:38,approx:false,
    fn:{'Cat.1 Agent entretien':{cls:1},'Cat.2 Brancardier':{cls:2},'Cat.3 Aide-soignant':{cls:3},'Cat.4 Infirmier':{cls:4},'Cat.5 Infirmier specialise':{cls:5},'Cat.6 Medecin':{cls:6}},
    note:'CP 330 Sante. Hopitaux, cliniques, MRS. Baremes IFIC depuis 2018. Maribel social. Primes de nuit/WE.',
    grille:[
      {exp:0,c1:2254.03,c2:2371.89,c3:2463.41,c4:2682.04,c5:2900.00,c6:5609.78},
      {exp:5,c1:2340.00,c2:2462.00,c3:2558.00,c4:2785.00,c5:3015.00,c6:5830.00},
      {exp:10,c1:2428.00,c2:2556.00,c3:2656.00,c4:2892.00,c5:3135.00,c6:6060.00}
    ]},

};

function getBareme(cp,fnName,anciennete){
  const bar=BAREMES[cp];if(!bar)return null;
  const classe=bar.fnClassMap?.[fnName];if(!classe)return null;
  if(bar.type==='monthly'){
    const years=Object.keys(bar.grid).map(Number).sort((a,b)=>a-b);
    let yr=years[0];for(const y of years){if(anciennete>=y)yr=y;else break;}
    const monthly=bar.grid[yr]?.[classe];if(!monthly)return null;
    return{monthly,hourly:+(monthly/164.6666).toFixed(4),classe,classLabel:bar.classes[classe],ancYr:yr,cp,type:"monthly",indexDate:bar.indexDate,indexPct:bar.indexPct,regime:bar.regime};
  }
  if(bar.type==='hourly'){
    let hourly;
    if(typeof Object.values(bar.grid)[0]==='object'){
      const years=Object.keys(bar.grid).map(Number).sort((a,b)=>a-b);
      let yr=years[0];for(const y of years){if(anciennete>=y)yr=y;else break;}
      hourly=bar.grid[yr]?.[classe];
    } else { hourly=bar.grid[classe]; }
    if(!hourly)return null;
    const factor=bar.monthlyFactor||((bar.weeklyH||38)*52/12);
    return{monthly:+(hourly*factor).toFixed(2),hourly,classe,classLabel:bar.classes[classe],ancYr:anciennete,cp,type:"hourly",indexDate:bar.indexDate,indexPct:bar.indexPct,regime:bar.regime};
  }
  return null;
}

function getCPAvantages(cp){
  const bar=BAREMES[cp];if(!bar)return[];const avs=[];
  if(bar.primeAnnuelle)avs.push({l:"Prime annuelle (juin)",v:fmt(bar.primeAnnuelle)});
  if(bar.primeFinAnnee)avs.push({l:"Prime fin d\'année",v:bar.primeFinAnnee});
  if(bar.ecoChequesMax)avs.push({l:"Éco-chèques (max/an)",v:fmt(bar.ecoChequesMax)});
  if(bar.transport?.velo)avs.push({l:"Indemnité vélo",v:`${bar.transport.velo} €/km (max ${bar.transport.maxVeloJour}€/jour)`});
  if(bar.timbreFidelite)avs.push({l:"Timbres fidélité",v:`${(bar.timbreFidelite*100)}% sal. annuel`});
  if(bar.timbreIntemperie)avs.push({l:"Timbres intempéries",v:`${(bar.timbreIntemperie*100)}% sal. annuel`});
  if(bar.mobilite)avs.push({l:"Indemnité mobilité",v:`${bar.mobilite.parKm} €/km (max ${bar.mobilite.maxKm}km)`});
  if(bar.reposComp)avs.push({l:"Jours repos compensatoires",v:`${bar.reposComp} jours/an`});
  if(bar.primeNuit)avs.push({l:"Prime nuit",v:`+${(bar.primeNuit*100)}%`});
  if(bar.primeWeekendSam)avs.push({l:"Prime samedi",v:`+${(bar.primeWeekendSam*100)}%`});
  if(bar.primeWeekendDim)avs.push({l:"Prime dimanche",v:`+${(bar.primeWeekendDim*100)}%`});
  if(bar.primeAttractivite)avs.push({l:"Prime attractivité",v:`${(bar.primeAttractivite*100)}%`});
  if(bar.indemniteNuit)avs.push({l:"Indemnité nuit (0h-5h)",v:`${bar.indemniteNuit} €/h`});
  if(bar.indemniteVetements)avs.push({l:"Indemnité vêtements",v:`${bar.indemniteVetements} €/jour`});
  return avs;
}

// ─── PAYROLL CALCULATION ENGINE (Formule-clé SPF Finances) ───
function calc(emp, per, co) {
  const r = {};
  const hr = (emp.monthlySalary||0) / (LEGAL.WD * LEGAL.WHD);
  r.base = emp.monthlySalary || 0;
  r.overtime = (per.overtimeH||0) * hr * 1.5;
  r.sunday = (per.sundayH||0) * hr * 2;
  r.night = (per.nightH||0) * hr * 1.25;
  r.bonus = per.bonus || 0;
  r.y13 = per.y13 || 0;
  r.sickPay = (per.sickG||0) * (r.base / LEGAL.WD);
  r.gross = r.base + r.overtime + r.sunday + r.night + r.bonus + r.y13 + r.sickPay;

  // ── HEURES SUP VOLONTAIRES BRUT=NET (Nouveau régime 01/04/2026 + Relance T1) ──
  // 360h/an (450h horeca), dont 240h (360h horeca) exonérées ONSS+PP = brut=net
  // Pas de sursalaire, pas de repos compensatoire. Accord écrit 1 an.
  // Heures relance (T1/2026 transitoire): 120h brut=net, déduites du quota 240h
  r.hsVolontBrutNet = (per.hsVolontBrutNet||0) * hr; // montant brut=net (pas de sursalaire)
  r.hsRelance = (per.hsRelance||0) * hr;
  r.hsBrutNetTotal = r.hsVolontBrutNet + r.hsRelance; // total brut=net (non soumis ONSS/PP)

  // ── MI-TEMPS MÉDICAL / REPRISE PROGRESSIVE (Art. 100§2 Loi coord. 14/07/1994) ──
  // Le travailleur reconnu en incapacité par le médecin-conseil de la mutuelle
  // reprend le travail à temps partiel avec l'accord du médecin du travail.
  //
  // Mécanisme:
  //   1. L'employeur paie le salaire PROPORTIONNEL aux heures prestées
  //   2. L'INAMI (mutuelle) verse un COMPLÉMENT d'indemnités au travailleur
  //   3. Le complément INAMI = 60% du brut normal × (heures non prestées / heures normales)
  //      mais plafonné et avec règle de cumul (max 20% de perte par rapport à avant l'incapacité)
  //
  // Impact sur la fiche de paie:
  //   - Brut = prorata des heures prestées (pas le brut normal!)
  //   - ONSS = calculé sur le brut prorata (pas sur le brut normal)
  //   - PP = calculé sur le brut prorata (barème temps partiel)
  //   - L'indemnité INAMI est hors fiche de paie (versée directement par la mutuelle)
  //   - Mention "pour mémoire" du complément INAMI sur la fiche
  //
  // Formulaires:
  //   - C3.2: déclaration de reprise au médecin-conseil
  //   - E10: évaluation médecin du travail (formulaire de réintégration)
  //   - DRS (eBox): déclaration reprise du travail à la mutuelle
  //
  // Durée: illimitée (aussi longtemps que le médecin-conseil autorise)
  // ONSS: sur brut prorata uniquement
  // PP: barème proportionnel temps partiel (fraction d'occupation)
  r.miTempsMed = per.miTempsMed || false;
  r.miTempsHeures = per.miTempsHeures || 0;
  r.miTempsFraction = 1; // fraction d'occupation
  r.miTempsINAMI = per.miTempsINAMI || 0;
  r.miTempsBrutOriginal = r.base; // brut avant prorata

  if (r.miTempsMed && r.miTempsHeures > 0 && (emp.whWeek || 38) > 0) {
    r.miTempsFraction = r.miTempsHeures / (emp.whWeek || 38);
    // Recalculer le brut au prorata des heures prestées
    r.base = Math.round((emp.monthlySalary || 0) * r.miTempsFraction * 100) / 100;
    // Recalculer les composantes proportionnelles
    r.sickPay = (per.sickG || 0) * (r.base / LEGAL.WD);
    r.gross = r.base + r.overtime + r.sunday + r.night + r.bonus + r.y13 + r.sickPay;
    // Estimation du complément INAMI si pas renseigné
    // Règle: 60% du brut limité (plafonné à ≈ 106,16€/j en 2026) × fraction non prestée
    if (r.miTempsINAMI === 0) {
      const brutJourNormal = (emp.monthlySalary || 0) / LEGAL.WD;
      const plafondINAMI = 106.16; // plafond journalier INAMI 2026 (adapté)
      const brutJourPlafonné = Math.min(brutJourNormal, plafondINAMI);
      const tauxINAMI = 0.60; // 60% (cohabitant) — peut être 65% (chef de famille) ou 55% (isolé)
      r.miTempsINAMI = Math.round(brutJourPlafonné * tauxINAMI * LEGAL.WD * (1 - r.miTempsFraction) * 100) / 100;
    }
  }

  // ── ATN Voiture de société (Art. 36 CIR 92) ──
  r.atnCar = 0; r.atnPct = 0; r.cotCO2 = 0;
  const carFuel = emp.carFuel || 'none';
  const carCO2 = parseInt(emp.carCO2) || 0;
  const carCatVal = parseFloat(emp.carCatVal) || 0;
  if (carFuel !== 'none' && carCatVal > 0) {
    if (carFuel === 'electrique') {
      r.atnPct = 4;
      r.atnCar = Math.max(1600/12, (carCatVal * (6/7) * 0.04) / 12);
      r.cotCO2 = 31.34; // minimum
    } else {
      const refCO2 = (carFuel === 'diesel') ? 84 : 102;
      const delta = carCO2 - refCO2;
      r.atnPct = Math.max(4, Math.min(18, 5.5 + (delta * 0.1)));
      r.atnCar = Math.max(1600/12, (carCatVal * (6/7) * (r.atnPct/100)) / 12);
      // Cotisation CO2 patronale (solidarité ONSS)
      if (carFuel === 'diesel') r.cotCO2 = Math.max(31.34, (carCO2 * 0.00714 * 71.4644) + 31.34);
      else r.cotCO2 = Math.max(31.34, (carCO2 * 0.00714 * 83.6644) + 31.34);
    }
  }

  // ── ATN Autres avantages en nature (AR 18/12/2024 — Forfaits 2026) ──
  r.atnGSM = emp.atnGSM ? 3.00 : 0;         // 36€/an = 3€/mois
  r.atnPC = emp.atnPC ? 6.00 : 0;            // 72€/an = 6€/mois
  r.atnInternet = emp.atnInternet ? 5.00 : 0; // 60€/an = 5€/mois
  r.atnChauffage = emp.atnChauffage ? 177.50 : 0; // 2.130€/an = 177,50€/mois
  r.atnElec = emp.atnElec ? 88.33 : 0;       // 1.060€/an = 88,33€/mois
  // ATN Logement gratuit (Art. 18 AR/CIR92 — Forfaits 2026)
  // Non-dirigeant: forfait fixe = RC indexé × 100/60
  // Dirigeant (statut=dirigeant): RC indexé × 100/60 × 3,80 (coeff. dirigeant)
  // Coefficient indexation RC 2026: 2,1763 (exercice d'imposition 2027)
  // Si meublé: + 5/3 du montant
  r.atnLogement = 0;
  if (emp.atnLogement && parseFloat(emp.atnLogementRC) > 0) {
    const rc = parseFloat(emp.atnLogementRC);
    const rcIndex = rc * 2.1763; // RC indexé 2026
    const isDirigeant = (emp.statut === 'dirigeant');
    if (isDirigeant) {
      // Dirigeant: RC indexé × 100/60 × coeff. 3,80 (si RC > 745€) ou × 1,25 (si RC ≤ 745€)
      r.atnLogement = rc <= 745
        ? (rcIndex * 100 / 60 * 1.25) / 12
        : (rcIndex * 100 / 60 * 3.80) / 12;
    } else {
      // Non-dirigeant: forfait fixe par RC non indexé
      r.atnLogement = (rcIndex * 100 / 60) / 12;
    }
  }
  r.atnAutresTot = r.atnGSM + r.atnPC + r.atnInternet + r.atnChauffage + r.atnElec + r.atnLogement;
  r.atnTotal = r.atnCar + r.atnAutresTot;

  // ── VÉLO DE SOCIÉTÉ (Loi 25/11/2021 + Art. 38§1er 14°a CIR 92) ──
  // Depuis 01/01/2024: l'ATN vélo de société = 0€ (exonéré IPP et ONSS)
  // Conditions: usage effectif pour déplacements domicile-travail (même partiel)
  // L'employeur supporte le coût du leasing (déductible 100%)
  // Types: vélo classique, vélo électrique (≤25km/h), speed pedelec (≤45km/h)
  // CUMULABLE avec l'indemnité vélo 0,27€/km (pour les km effectivement parcourus)
  // Le speed pedelec est fiscalement assimilé à un vélo (pas une moto)
  r.veloSociete = emp.veloSociete || false;
  r.veloType = emp.veloType || 'none';
  r.atnVelo = 0; // ATN = 0€ depuis 01/01/2024 (exonéré)
  r.veloLeasingMois = emp.veloLeasingMois || 0; // coût employeur
  r.veloValeur = emp.veloValeur || 0;

  // Indemnité vélo cumulable: 0,27€/km A/R même avec vélo de société
  // → déjà calculée dans r.transport si commType === 'bike'

  // ── CARTE CARBURANT / RECHARGE (Art. 36§2 CIR 92) ──
  // La carte carburant liée à une voiture de société est incluse dans l'ATN voiture
  // (pas d'ATN séparé) SAUF si la carte permet un usage privé illimité:
  //   → L'ATN voiture couvre déjà les frais de carburant
  //   → Si carte carburant SANS voiture de société = avantage imposable à 100%
  r.carteCarburant = emp.carteCarburant || false;
  r.carteCarburantMois = emp.carteCarburantMois || 0;
  // Si pas de voiture de société mais carte carburant → ATN = montant total
  r.atnCarteCarburant = (r.carteCarburant && !r.atnCar) ? r.carteCarburantMois : 0;
  // Si voiture de société + carte carburant → inclus dans ATN voiture (pas d'ATN supplémentaire)

  // ── BORNE DE RECHARGE DOMICILE (Art. 14536 CIR 92 + Loi 25/11/2021) ──
  // L'employeur peut installer une borne de recharge au domicile du travailleur
  // Pas d'ATN pour le travailleur si la borne sert à recharger la voiture de société
  // L'employeur déduit le coût à 100% (si borne intelligente bidirectionnelle)
  // L'électricité de recharge pour usage privé: ATN = coût réel ou forfait
  r.borneRecharge = emp.borneRecharge || false;
  r.borneRechargeCoût = emp.borneRechargeCoût || 0;
  // ATN borne: 0€ si voiture de société (fait partie du package)
  // ATN borne: coût réel si pas de voiture de société
  r.atnBorne = (r.borneRecharge && !r.atnCar) ? r.borneRechargeCoût : 0;

  // Ajouter aux ATN autres si applicable
  r.atnAutresTot += r.atnCarteCarburant + r.atnBorne;
  r.atnTotal = r.atnCar + r.atnAutresTot;

  // ── ONSS Travailleur ──
  const isOuvrier = (emp.statut === 'ouvrier');
  const onssBase = isOuvrier ? r.gross * LEGAL.ONSS_DETAIL_2026.majoration_ouvrier : r.gross;
  r.onssW = onssBase * LEGAL.ONSS_W;
  // ── Bonus à l'emploi 2026 — Volet A (bas salaires) + Volet B (très bas salaires) ──
  // Source: Instructions ONSS T1/2026
  const BE = LEGAL.BONUS_2026;
  r.empBonusA = 0; r.empBonusB = 0;
  if (isOuvrier) {
    // Ouvrier (déclaré à 108%)
    if (r.gross * 1.08 <= BE.O_A_S2) r.empBonusA = BE.O_A_MAX;
    else if (r.gross * 1.08 <= BE.O_A_S1) r.empBonusA = Math.max(0, BE.O_A_MAX - BE.O_A_COEFF * (r.gross * 1.08 - BE.O_A_S2));
    if (r.gross * 1.08 <= BE.O_B_S2) r.empBonusB = BE.O_B_MAX;
    else if (r.gross * 1.08 <= BE.O_B_S1) r.empBonusB = Math.max(0, BE.O_B_MAX - BE.O_B_COEFF * (r.gross * 1.08 - BE.O_B_S2));
  } else {
    // Employé (déclaré à 100%)
    if (r.gross <= BE.A_S2) r.empBonusA = BE.A_MAX;
    else if (r.gross <= BE.A_S1) r.empBonusA = Math.max(0, BE.A_MAX - BE.A_COEFF * (r.gross - BE.A_S2));
    if (r.gross <= BE.B_S2) r.empBonusB = BE.B_MAX;
    else if (r.gross <= BE.B_S1) r.empBonusB = Math.max(0, BE.B_MAX - BE.B_COEFF * (r.gross - BE.B_S2));
  }
  r.empBonus = Math.min(r.empBonusA + r.empBonusB, r.onssW); // ne peut dépasser cotisation perso
  r.onssNet = r.onssW - r.empBonus;

  // ── ONSS Employeur ──
  const sectInfo = LEGAL.ONSS_SECTEUR[emp.cp] || LEGAL.ONSS_SECTEUR['default'];
  r.onssE_rate = sectInfo.e;
  r.onssE = onssBase * sectInfo.e;
  r.onssE_note = sectInfo.note;
  r.onssE_type = sectInfo.type || 'marchand';
  // Cotisations spéciales patronales
  r.onss_ffe = onssBase * (emp.staffCount >= 20 ? LEGAL.ONSS_DETAIL_2026.ffe_grand : LEGAL.ONSS_DETAIL_2026.ffe_petit);
  r.onss_chomTemp = onssBase * LEGAL.ONSS_DETAIL_2026.chomage_temp;
  r.onss_amiante = onssBase * LEGAL.ONSS_DETAIL_2026.amiante;

  // ── Réduction structurelle ONSS T1/2026 ──
  // Formule: Ps = R × µ × (J/D) — R = F + α(S0-S) + γ(S2-S) + δ(W-S1)
  // S = salaire trimestriel de référence, W = salaire trimestriel réel
  // Source: ONSS Instructions administratives + Easypay Group 09/01/2026
  const RS = LEGAL.RED_STRUCT_2026;
  const salTrim = r.gross * 3; // salaire trimestriel
  const salRef = salTrim; // temps plein = salaire réel (proratisé si TP partiel)
  // Fraction de prestation (µ) — Art. 353bis/5 Loi-programme 24/12/2002
  // Temps partiel: fraction = heures prestées / heures temps plein
  const fractionPrest = emp.regime === 'full' ? 1 : (emp.whWeek || 38) / 38;
  r.redStructCat = r.onssE_type === 'non-marchand' ? 2 :
    (emp.statut === 'eta' ? 3 : (emp.statut === 'eta_handi' ? 4 : 1));
  // cat 1=marchand, 2=non-marchand, 3=ETA, 4=ETA handicapé
  let redR = 0;
  if (r.redStructCat === 1) {
    // Catégorie 1: secteur marchand privé
    const compBas = salRef < RS.CAT1_S0 ? RS.CAT1_alpha * (RS.CAT1_S0 - salRef) : 0;
    const compTBas = salRef < RS.CAT1_S2 ? RS.CAT1_gamma * (RS.CAT1_S2 - salRef) : 0;
    redR = RS.CAT1_F + compBas + compTBas;
  } else if (r.redStructCat === 2) {
    // Catégorie 2: Maribel social / non-marchand
    const compBas = salRef < RS.CAT2_S0 ? RS.CAT2_alpha * (RS.CAT2_S0 - salRef) : 0;
    const compTBas = salRef < RS.CAT2_S2 ? RS.CAT2_gamma * (RS.CAT2_S2 - salRef) : 0;
    const compHaut = salRef > RS.CAT2_S1 ? RS.CAT2_delta * (salRef - RS.CAT2_S1) : 0;
    redR = RS.CAT2_F + compBas + compTBas + compHaut;
  } else if (r.redStructCat === 3) {
    // Catégorie 3: Entreprises de travail adapté (ETA)
    const compBas = salRef < RS.CAT3_S0 ? RS.CAT3_alpha * (RS.CAT3_S0 - salRef) : 0;
    const compTBas = salRef < RS.CAT3_S2 ? RS.CAT3_gamma * (RS.CAT3_S2 - salRef) : 0;
    redR = RS.CAT3_F + compBas + compTBas;
  } else if (r.redStructCat === 4) {
    // Catégorie 3bis: ETA travailleurs moins valides
    const compBas = salRef < RS.CAT3B_S0 ? RS.CAT3B_alpha * (RS.CAT3B_S0 - salRef) : 0;
    const compTBas = salRef < RS.CAT3B_gamma ? RS.CAT3B_gamma * (RS.CAT3B_S2 - salRef) : 0;
    redR = RS.CAT3B_F + compBas + compTBas;
  }
  // Appliquer la fraction de prestation (temps partiel)
  redR = Math.max(0, redR * fractionPrest);
  // Plancher: la réduction ne peut pas être négative
  // Plafond: la réduction ne peut pas excéder les cotisations patronales dues
  r.redStruct = Math.min(redR, r.onssE * 3); // montant trimestriel de réduction (plafonné)
  r.redStructMois = Math.round(r.redStruct / 3 * 100) / 100; // mensualisé
  r.redStructFraction = fractionPrest;
  // Appliquer réduction sur cotisation patronale effective
  r.onssE = Math.max(0, r.onssE - r.redStructMois);

  // ATN ajouté au revenu imposable (pas à l'ONSS, pas au brut payé)
  r.taxGross = r.gross - r.onssNet + r.atnCar + r.atnAutresTot;

  // ── TRAVAILLEUR FRONTALIER / TRANSFRONTALIER ──
  // Règlement (CE) 883/2004 + Conventions bilatérales CPDI
  //
  // PRINCIPE ONSS (Art. 11-16 Règl. 883/2004):
  //   → Lieu de TRAVAIL détermine le pays ONSS (lex loci laboris)
  //   → Travaille en Belgique = ONSS belge, même si réside en FR/NL/DE/LU
  //   → Exception: télétravail frontalier > 25% → accord cadre multi-État
  //
  // PRINCIPE PP / IMPÔT (Conventions préventives double imposition):
  //
  // 1. BELGIQUE ↔ FRANCE (Convention 10/03/1964 + Avenants):
  //   - Ancien régime frontalier (abrogé 01/01/2012): le frontalier FR travaillant
  //     en BE payait l'impôt en France → exonération PP en Belgique
  //   - RÉGIME ACTUEL: PP retenu en Belgique (pays de travail)
  //     Le travailleur FR déclare en France mais obtient un crédit d'impôt
  //     pour l'impôt belge payé (Art. 15 + Art. 19 Convention)
  //   - Formulaire 276 Front.: attestation de résidence fiscale française
  //
  // 2. BELGIQUE ↔ PAYS-BAS (Convention 05/06/2001):
  //   - PP retenu en Belgique. Le travailleur NL déclare aux Pays-Bas
  //     avec crédit d'impôt belge (méthode exemption avec progression)
  //   - Depuis 2003: plus de régime frontalier spécial
  //   - Le NL résident peut opter pour "kwalificerend buitenlands belastingplichtige"
  //
  // 3. BELGIQUE ↔ ALLEMAGNE (Convention 11/04/1967 + Protocole 2002):
  //   - PP retenu en Belgique. Crédit d'impôt en Allemagne.
  //   - Pas de régime frontalier spécial
  //
  // 4. BELGIQUE ↔ LUXEMBOURG (Convention 17/09/1970):
  //   - PP retenu en Belgique pour travail presté en Belgique
  //   - Particularité: règle des 24 jours de tolérance (accord amiable 2015)
  //     → max 24j/an de télétravail depuis le Luxembourg sans changer l'imposition
  //
  // IMPACT SUR LE CALCUL:
  //   - ONSS: toujours belge si le travail est presté en Belgique
  //   - PP: normalement retenu en Belgique (pas d'exonération)
  //   - Exception rare: exonération PP si formulaire 276 Front. + ancien régime FR
  //   - Formulaire A1: obligatoire pour les détachements > 1 pays
  //   - Limosa: déclaration obligatoire pour travailleurs détachés VERS la Belgique
  //
  r.frontalier = emp.frontalier || false;
  r.frontalierPays = emp.frontalierPays || '';
  r.frontalierExoPP = emp.frontalierExoPP || false;

  if (r.frontalier) {
    // ONSS: toujours belge (lex loci laboris) — pas de changement
    // PP: normalement retenu en Belgique
    // Si exonération PP (ancien régime FR pré-2012 — cas résiduel très rare):
    if (r.frontalierExoPP) {
      r.frontalierPPExo = r.tax; // montant PP qui serait retenu
      // r.tax reste calculé normalement pour info mais n'est pas retenu
      // → c'est au travailleur de déclarer dans son pays de résidence
    }
    // Le travailleur frontalier a droit aux mêmes avantages sociaux belges
    // (chèques-repas, transport, etc.) puisqu'il travaille en Belgique
  }

  // ── TRAVAILLEUR PENSIONNÉ — CUMUL PENSION / TRAVAIL ──
  // Réforme majeure: depuis 01/01/2015, cumul ILLIMITÉ pour:
  //   - Pension légale de retraite (pas anticipée) à l'âge légal (66 ans en 2026, 67 en 2030)
  //   - Pension anticipée après 45 ans de carrière
  //   - Pension de survie si le bénéficiaire a ≥ 65 ans
  //
  // Plafonds de cumul (si cumul LIMITÉ — AR 20/12/2006 + index):
  //   - Pension anticipée < 65 ans (salarié):
  //     Sans enfant à charge: 10.613€/an brut (2026)
  //     Avec enfant à charge: 13.266€/an brut (2026)
  //   - Pension de survie < 65 ans:
  //     Sans enfant à charge: 22.509€/an brut (2026)
  //     Avec enfant à charge: 28.136€/an brut (2026)
  //   → En cas de dépassement: pension réduite du % de dépassement (Art. 64 AR 21/12/1967)
  //
  // IMPACT ONSS:
  //   - Cotisation patronale: normale (pas de réduction spéciale)
  //   - Cotisation travailleur: cotisation de solidarité 0% (pas d'ONSS perso)
  //     si pension + revenu > plafond → retenue normale 13,07%
  //   → EN PRATIQUE: ONSS normal 13,07% s'applique (la solidarité est passée)
  //   → Le pensionné n'est PLUS exonéré d'ONSS travailleur depuis 2024
  //
  // IMPACT PP:
  //   - Barème normal appliqué (même formule-clé)
  //   - MAIS: quotité exemptée peut être différente si le pensionné
  //     cumule pension + revenu → art. 154bis CIR
  //   - La pension elle-même est imposée séparément par le SFP (précompte pension)
  //
  // FLEXI-JOB PENSIONNÉ:
  //   - Plafond 12.000€/an NE s'applique PAS aux pensionnés → cumul illimité
  //   - C'est le principal avantage du statut pensionné pour les flexi-jobs
  //
  // COTISATION SPÉCIALE 1,5% (solidarité pensionné):
  //   - Si le pensionné gagne > plafond, cotisation spéciale de solidarité
  //   - Retenue par l'employeur et versée à l'ONSS
  //   - Art. 68 Loi 30/03/1994
  //
  // SIGEDIS / SFP: l'employeur déclare les revenus via DmfA.
  //   Le SFP (Service fédéral des Pensions) vérifie le cumul automatiquement.

  r.pensionné = emp.pensionné || false;
  r.pensionType = emp.pensionType || 'none';
  r.pensionCumulIllimite = emp.pensionCumulIllimite || false;
  r.pensionPlafond = 0;
  r.pensionDepassement = false;

  if (r.pensionné) {
    const age = emp.pensionAge || 0;
    const carriere = emp.pensionCarriere || 0;
    const depEnfants = emp.depChildren > 0;

    // Déterminer si cumul illimité
    if (r.pensionType === 'legal' && age >= 66) {
      r.pensionCumulIllimite = true; // Âge légal atteint (66 en 2026)
    }
    if (r.pensionType === 'anticipee' && carriere >= 45) {
      r.pensionCumulIllimite = true; // 45 ans de carrière
    }
    if (r.pensionType === 'survie' && age >= 65) {
      r.pensionCumulIllimite = true;
    }

    if (!r.pensionCumulIllimite) {
      // Plafonds de cumul annuels (indexés 2026)
      if (r.pensionType === 'anticipee') {
        r.pensionPlafond = depEnfants ? 13266 : 10613;
      } else if (r.pensionType === 'survie') {
        r.pensionPlafond = depEnfants ? 28136 : 22509;
      }
      // Vérifier si dépassement estimé
      const revenuAnnuelEstime = r.gross * 12;
      if (r.pensionPlafond > 0 && revenuAnnuelEstime > r.pensionPlafond) {
        r.pensionDepassement = true;
        r.pensionDepassPct = Math.round((revenuAnnuelEstime - r.pensionPlafond) / r.pensionPlafond * 100);
      }
    }

    // Cotisation spéciale solidarité pensionné (Art. 68 Loi 30/03/1994)
    // Si le total pension + revenus activité > seuil → retenue 0% à 2%
    // En pratique: déjà incluse dans les cotisations ONSS standard
    // Le SFP vérifie a posteriori via DmfA/SIGEDIS

    // ONSS: normal (13,07% trav + taux patronal sectoriel)
    // Pas de changement dans le calcul — tout est standard
  }

  // ── PRÉCOMPTE PROFESSIONNEL 2026 — FORMULE-CLÉ COMPLÈTE SPF FINANCES ──
  // Annexe III AR/CIR 92 — Moniteur belge — Tranches annuelles
  const PP = LEGAL.PP2026;
  const annualGross = r.taxGross * 12;

  // Étape 1: Frais professionnels forfaitaires (30%, max 5 930 €)
  const isSalarie = (emp.regime !== 'dirigeant');
  const fpPct = isSalarie ? PP.FP_PCT : PP.FP_DIR_PCT;
  const fpMax = isSalarie ? PP.FP_MAX : PP.FP_DIR_MAX;
  r.profExp_annual = Math.min(annualGross * fpPct, fpMax);
  r.profExp = r.profExp_annual / 12;

  // Étape 2: Revenu annuel net imposable
  const revNetImposable = annualGross - r.profExp_annual;

  // Étape 3: Barème 1 (isolé) ou Barème 2 (quotient conjugal)
  const isBareme2 = (emp.civil === 'married_1'); // conjoint sans revenus
  let revPrincipal = revNetImposable;
  let revConjoint = 0;
  if (isBareme2) {
    revConjoint = Math.min(revNetImposable * PP.QC_PCT, PP.QC_MAX);
    revPrincipal = revNetImposable - revConjoint;
  }

  // Étape 4: Calcul impôt progressif annuel (sur revenu principal)
  const calcImpotAnnuel = (rev) => {
    let impot = 0; let reste = Math.max(0, rev);
    let prev = 0;
    for (const tr of PP.TRANCHES) {
      const tranche = Math.min(reste, tr.lim - prev);
      impot += tranche * tr.rate;
      reste -= tranche;
      prev = tr.lim;
      if (reste <= 0) break;
    }
    return impot;
  };

  let impotAnnuel = calcImpotAnnuel(revPrincipal);
  if (isBareme2 && revConjoint > 0) {
    impotAnnuel += calcImpotAnnuel(revConjoint);
  }

  // Étape 5: Déduction quotité exemptée d'impôt
  const quotiteExempt = PP.EXEMPT * (isBareme2 ? 2 : 1);
  const reductionExempt = calcImpotAnnuel(quotiteExempt);
  impotAnnuel -= reductionExempt;

  // Étape 6: Réductions annuelles charges de famille
  let redFam = 0;
  const ch = emp.depChildren || 0;
  if (ch > 0 && ch <= 5) redFam += PP.RED.enfants[ch];
  else if (ch > 5) redFam += PP.RED.enfants[5] + (ch - 5) * PP.RED.enfantX;
  if (emp.handiChildren > 0) redFam += emp.handiChildren * PP.RED.handicap;
  if (emp.civil === 'single' && ch === 0) redFam += PP.RED.isolee;
  if ((emp.civil === 'single' || emp.civil === 'widowed') && ch > 0) redFam += PP.RED.veuf_enfant;
  // Ascendants ≥ 65 ans à charge (Art. 132 CIR 92 — revenus nets < 3.820€)
  const depAsc = emp.depAscendant || 0;
  const depAscHandi = emp.depAscendantHandi || 0;
  if (depAsc > 0) redFam += depAsc * PP.RED.ascendant65;
  if (depAscHandi > 0) redFam += depAscHandi * PP.RED.ascendant65_handi;
  // Conjoint handicapé (Art. 132 CIR — supplément quotité exemptée)
  if (emp.conjointHandicap) redFam += PP.RED.handicap;
  // Autres personnes à charge (Art. 136 CIR — max 3.820€ revenus nets)
  const depAutres = emp.depAutres || 0;
  if (depAutres > 0) redFam += depAutres * PP.RED.isolee; // même réduction qu'isolé par personne
  impotAnnuel -= redFam;

  // Étape 7: Précompte mensuel = impôt annuel / 12
  r.baseTax = Math.max(0, impotAnnuel) / 12;
  r.famRed = redFam / 12;
  r.taxNet = revNetImposable / 12;
  r.tax = Math.max(0, r.baseTax);
  // ── Bonus à l'emploi FISCAL (réduction précompte professionnel) ──
  // 33,14% du volet A + 52,54% du volet B (depuis 01/04/2024)
  r.empBonusFiscA = r.empBonusA * 0.3314;
  r.empBonusFiscB = r.empBonusB * 0.5254;
  r.empBonusFisc = r.empBonusFiscA + r.empBonusFiscB;
  r.tax = Math.max(0, r.tax - r.empBonusFisc);

  // Special SS contribution (Art. 106-112 Loi-programme 30/12/1988)
  // Barème trimestriel — retenue mensuelle = 1/3 du montant trimestriel
  // Différent pour isolés vs ménages avec 2 revenus
  // Source: socialsecurity.be + montants-socio-juridiques 2026
  r.css = 0;
  const grossTrim = r.gross * 3; // salaire trimestriel
  const grossTrimOuv = isOuvrier ? grossTrim * 1.08 : grossTrim;
  // Calcul trimestriel puis division par 3
  if (emp.civil === 'married_2' || emp.civil === 'cohabit') {
    // MÉNAGE 2 REVENUS
    if (grossTrimOuv <= 5836.14) r.css = 0;
    else if (grossTrimOuv <= 6570.54) r.css = Math.max(9.30, (grossTrimOuv - 5836.14) * 0.076) / 3;
    else if (grossTrimOuv <= 18116.46) r.css = Math.min(51.64, 18.60 + (grossTrimOuv - 6570.54) * 0.011) / 3;
    else r.css = 51.64 / 3;
    // Plafond mensuel ménage 2 revenus = 51.64€/trim = 17.21€/mois
    r.css = Math.min(r.css, 51.64 / 3);
  } else {
    // ISOLÉ / conjoint SANS revenus
    if (grossTrimOuv <= 5836.14) r.css = 0;
    else if (grossTrimOuv <= 6570.54) r.css = (grossTrimOuv - 5836.14) * 0.076 / 3;
    else if (grossTrimOuv <= 18116.46) r.css = Math.min(60.94, 18.60 + (grossTrimOuv - 6570.54) * 0.011) / 3;
    else r.css = 60.94 / 3;
    // Plafond mensuel isolé = 60.94€/trim = 20.31€/mois
    r.css = Math.min(r.css, 60.94 / 3);
  }
  r.css = Math.round(r.css * 100) / 100;
  r.cssTrimMax = (emp.civil === 'married_2' || emp.civil === 'cohabit') ? 154.92 : 182.82;
  r.cssAnnuelMax = (emp.civil === 'married_2' || emp.civil === 'cohabit') ? 619.68 : 731.28;

  r.mvDays = per.days || Math.round(LEGAL.WD);
  r.mvWorker = r.mvDays * (emp.mvW || 0);
  r.mvEmployer = r.mvDays * (emp.mvE || 0);
  r.transport = 0; r.transportDetail = '';
  const cDist = parseFloat(emp.commDist) || 0;
  const cMonth = parseFloat(emp.commMonth) || 0;
  const cType = emp.commType || 'none';
  const wDays = per.days || 21;
  if (cType === 'train' && cMonth > 0) {
    // SNCB: intervention obligatoire 75% abonnement (CCT 19/9 du 26/03/2004)
    r.transport = cMonth * 0.75;
    r.transportDetail = `Train: 75% × ${fmt(cMonth)} = ${fmt(r.transport)}`;
  } else if (cType === 'bus' && cMonth > 0) {
    // Transport en commun autre: intervention = prix abo SNCB même distance (CCT 19/9)
    r.transport = cMonth * 0.75;
    r.transportDetail = `Bus/Tram: 75% × ${fmt(cMonth)} = ${fmt(r.transport)}`;
  } else if (cType === 'bike' && cDist > 0) {
    // Vélo: 0,27 €/km A/R (2026) — exonéré ONSS et IPP
    r.transport = cDist * 2 * wDays * 0.27;
    r.transportDetail = `Vélo: ${cDist}km × 2 × ${wDays}j × 0,27€ = ${fmt(r.transport)}`;
  } else if (cType === 'car' && cDist > 0) {
    // Voiture privée: pas d'obligation légale sauf CCT sectorielle
    // Si employeur intervient: exonération ONSS max 490€/an (2026) = 40,83€/mois
    // Calcul forfaitaire courant: barème SNCB pour distance équivalente
    r.transport = Math.min(40.83, cDist * 0.15 * wDays); // estimation
    r.transportDetail = `Voiture: ${cDist}km, interv. max exonérée ${fmt(r.transport)}/mois`;
  } else if (cType === 'carpool' && cDist > 0) {
    r.transport = Math.min(40.83, cDist * 0.15 * wDays);
    r.transportDetail = `Covoiturage: idem voiture`;
  } else if (cType === 'mixed' && cMonth > 0) {
    // Combiné: train + vélo possible
    r.transport = cMonth * 0.75 + (cDist > 0 ? cDist * 2 * wDays * 0.27 : 0);
    r.transportDetail = `Combiné: train ${fmt(cMonth * 0.75)} + vélo ${fmt(cDist * 2 * wDays * 0.27)}`;
  }
  r.expense = emp.expense || 0;
  r.garnish = per.garnish || 0;
  r.advance = per.advance || 0;
  r.otherDed = per.otherDed || 0;
  // ── PP VOLONTAIRE (Art. 275§1 CIR 92 + AR/PP Art. 88) ──
  // Le travailleur peut demander par écrit à l'employeur de retenir un PP supplémentaire
  // au-delà du minimum légal. Récupérable via déclaration IPP si trop-retenu.
  // L'employeur est tenu de reverser l'intégralité au SPF Finances.
  // Base: AR 09/01/2024 fixant les barèmes de PP — dispense n'affecte pas ce montant.
  r.ppVolontaire = per.ppVolontaire || 0;

  // ══════════════════════════════════════════════════════════════
  //  ÉLÉMENTS FISCAUX COMPLETS — Art. CIR 92 / Loi ONSS 27/06/1969
  // ══════════════════════════════════════════════════════════════

  // ── 1. DOUBLE PÉCULE VACANCES (Employés — payé par employeur) ──
  // Art. 19 §2 AR 28/11/1969 — ONSS sur 2ème partie (7%) uniquement
  // Double pécule = 92% du brut (85% = 1ère partie + 7% = 2ème partie)
  // 2ème partie soumise ONSS trav 13,07% + cotisation spéciale 1%
  r.doublePecule = per.doublePecule || 0;
  r.dpOnss = 0; r.dpCotisSpec = 0;
  if (r.doublePecule > 0) {
    const dp2 = r.doublePecule * (7/92); // extraire la 2ème partie
    r.dpOnss = dp2 * TX_ONSS_W;      // ONSS travailleur sur 2è partie
    r.dpCotisSpec = dp2 * 0.01;    // cotisation spéciale 1%
  }

  // ── 2. PÉCULE VACANCES DE DÉPART (Art. 46 Loi 12/04/1965) ──
  // Payé lors de la sortie de service — simple + double anticipé
  // Soumis ONSS 13,07% sur totalité
  r.peculeDepart = per.peculeDepart || 0;
  r.pdOnss = r.peculeDepart > 0 ? r.peculeDepart * TX_ONSS_W : 0;

  // ── 3. PRIME D'ANCIENNETÉ (Art. 19 §2 14° AR ONSS) ──
  // Exonérée ONSS et IPP si: 1× entre 25-35 ans anc. et 1× ≥ 35 ans anc.
  // Plafond 2026: max 1× brut mensuel ou fraction (prorata)
  // Montant max exonéré: employé = 1 mois brut, ouvrier = idem
  r.primeAnciennete = per.primeAnciennete || 0;
  const ancAns = emp.anciennete || 0;
  const primeAncExo = (ancAns >= 25) ? Math.min(r.primeAnciennete, emp.monthlySalary) : 0;
  r.primeAncTaxable = Math.max(0, r.primeAnciennete - primeAncExo);
  r.primeAncExoneree = primeAncExo;

  // ── 4. PRIME DE NAISSANCE / MARIAGE / ÉVÉNEMENT (Circ. ONSS 2024/1) ──
  // Exonérée ONSS si ≤ plafond (naissance: coutume, mariage: idem)
  // Considéré comme avantage social si modique et lié à événement
  r.primeNaissance = per.primeNaissance || 0;

  // ── 5. PRIME D'INNOVATION (Art. 38 §1er 25° CIR 92) ──
  // Exonérée IPP si ≤ 1 mois brut et ≤ 1× par travailleur
  // Soumise ONSS mais exonérée fiscalement
  r.primeInnovation = per.primeInnovation || 0;

  // ── 6. INDEMNITÉ TÉLÉTRAVAIL (Circ. 2021/C/20 du 26/02/2021) ──
  // Max 154,74€/mois (montant 2026 — indexé chaque année)
  // Exonérée ONSS et IPP si structurel (min 1 jour/semaine régulier)
  // Couvre: chauffage, électricité, petit matériel, amortissement mobilier
  r.indemTeletravail = Math.min(per.indemTeletravail || 0, FORF_BUREAU);

  // ── 7. INDEMNITÉ FRAIS DE BUREAU (AR/CIR92 Art. 31) ──
  // Frais propres de l'employeur — exonérés si justifiés ou forfaitaires
  // Forfait bureau: max 10% brut (tolérance admin. — non cumulable télétravail)
  r.indemBureau = per.indemBureau || 0;

  // ── 8. PENSION COMPLÉMENTAIRE — Retenue personnelle (Loi 28/04/2003 LPC) ──
  // Retenue sur salaire = cotisation personnelle du travailleur
  // Déductible fiscalement (Art. 145/1 CIR — réduction 30% avec plafond)
  // Soumise ONSS travailleur (base de calcul ONSS)
  // Cotisation Wijninckx — 12,5% depuis 2026 (Loi 18/12/2025 M.B. 30/12/2025)
  // Applicable si pension légale + compl. > pension max secteur public (97.548€/an)
  r.pensionCompl = per.pensionCompl || 0;

  // ── 9. RETENUE SYNDICALE (Art. 23 Loi 12/04/1965) ──
  // Volontaire — transmise au syndicat. Pas ONSS, réduction fiscale partielle
  r.retSyndicale = per.retSyndicale || 0;

  // ── 10. PENSION ALIMENTAIRE (Art. 1409-1412 Code judiciaire) ──
  // Saisie prioritaire — avant les autres saisies, sans barème
  r.saisieAlim = per.saisieAlim || 0;

  // ── 11. RÉDUCTION PP HEURES SUPPLÉMENTAIRES (Art. 154bis CIR 92) ──
  // Travailleur: réduction PP sur sursalaire (50% ou 100%)
  // Max 180h/an (2026 — Art.154bis §3 CIR — Accord Arizona structurel)
  // Horeca: 360h | Construction+enregistrement: 180h
  // Employeur: dispense versement PP 32,19% (Art. 275/1 CIR)
  // Applicable sur heures au-delà de 9h/j ou 38h/sem (ou limite secteur)
  const hsfisc = per.heuresSupFisc || 0;
  r.heuresSupFisc = hsfisc;
  const sursalaire = hsfisc * hr * 0.5; // sursalaire = 50% du taux horaire normal
  // Réduction travailleur: 66,81% du PP sur le sursalaire (taux barème 1 Art.154bis)
  // ou 57,75% selon barème 2
  r.redPPHeuresSup = sursalaire > 0 ? Math.round(sursalaire * 0.6681 * 100) / 100 : 0;
  r.tax = Math.max(0, r.tax - r.redPPHeuresSup);

  // ── 12. DISPENSE VERSEMENT PP NUIT/ÉQUIPES (Art. 275/5 CIR 92) ──
  // Employeur: dispense de versement PP = 22,8% (travail en équipe/nuit)
  // Ne change pas le net du travailleur, réduit le coût employeur
  r.dispensePPNuit = (per.nightH || 0) > 0 ? r.tax * 0.228 : 0;

  // ── 13. PP À TAUX EXCEPTIONNEL — Double pécule & 13è mois ──
  // (AR 09/01/2024 annexe III — Barèmes précompte professionnel)
  // Double pécule vacances: taxé à taux fixe (pas barème progressif)
  //   Taux = basé sur rémunération annuelle brute:
  //   ≤ 17.280€: 0% | ≤ 32.280€: 19,17% | ≤ 43.380€: 23,22% | > 43.380€: 30,28%
  // 13è mois: taux fixe idem (annexe III AR)
  // Indemnité de départ/préavis: taux fixe selon rémunération annuelle
  // NB: ces taux s'appliquent sur le MONTANT EXCEPTIONNEL, pas le salaire mensuel
  r.ppTauxExcep = 0; r.ppTauxExcepRate = 0;
  const typeSpec = per.typeSpecial || 'normal';
  if (typeSpec === 'doublePecule' || typeSpec === 'y13' || typeSpec === 'depart' || typeSpec === 'preavis') {
    const annBrut = r.base * 12;
    if (annBrut <= 17280) r.ppTauxExcepRate = 0;
    else if (annBrut <= 32280) r.ppTauxExcepRate = 0.1917;
    else if (annBrut <= 43380) r.ppTauxExcepRate = 0.2322;
    else r.ppTauxExcepRate = 0.3028;
    // Appliquer sur le montant exceptionnel
    const montantExcep = (typeSpec === 'doublePecule' ? r.doublePecule : 0)
      + (typeSpec === 'y13' ? r.y13 : 0)
      + (typeSpec === 'depart' ? r.peculeDepart : 0)
      + (typeSpec === 'preavis' ? (per.indemPreavis || 0) : 0);
    r.ppTauxExcep = montantExcep * r.ppTauxExcepRate;
    r.tax += r.ppTauxExcep;
  }

  // ── 14. JOURS FÉRIÉS PAYÉS (Loi 04/01/1974 + AR 18/04/1974) ──
  // 10 jours fériés légaux/an (Belgique) — payés par l'employeur
  // Ouvrier: salaire journalier normal (inclus dans les jours prestés si travaillés)
  // Employé: salaire mensuel normal (pas d'impact sur calcul mensuel)
  // Jour férié travaillé: supplément 200% (déjà couvert par sundayH si encodé)
  r.joursFeries = per.joursFeries || 0; // nombre encodé dans le mois

  // ── 15. PETIT CHÔMAGE / CONGÉ DE CIRCONSTANCE (AR 28/08/1963) ──
  // Salaire normal maintenu pour événements familiaux:
  // Mariage travailleur: 2 jours | Décès conjoint/enfant: 3 jours
  // Naissance enfant (co-parent): 15 jours | Communion: 1 jour
  // Déménagement: 1 jour | Comparution tribunal: nécessaire
  r.petitChomage = per.petitChomage || 0; // nombre jours
  r.petitChomageVal = r.petitChomage * (r.base / LEGAL.WD); // valeur = salaire/jour

  // ── 16. ÉCO-CHÈQUES (CCT 98 du 20/02/2009 — CNT) ──
  // Max 250€/an par travailleur temps plein (prorata temps partiel)
  // Exonérés ONSS et IPP si conditions respectées (pas en remplacement rémun.)
  // Uniquement électroniques depuis 2024
  // Non inclus dans le brut, pas de retenue — coût employeur pur
  r.ecoCheques = per.ecoCheques || 0;

  // ── 17. CADEAUX & AVANTAGES SOCIAUX (Circ. ONSS + Art. 38/11 CIR) ──
  // Exonérés ONSS+IPP si: Noël/Nouvel An ≤ 40€ + 40€/enfant | Mariage ≤ 245€
  // Saint-Nicolas ≤ 40€/enfant | Retraite ≤ 40€/année service (max 40 ans)
  r.cadeaux = per.cadeaux || 0;

  // ── 18. BUDGET MOBILITÉ (Loi 17/03/2019 modifié 01/01/2022) ──
  // Alternative à la voiture de société — 3 piliers:
  // Pilier 1: voiture plus écologique (ATN réduit)
  // Pilier 2: mobilité durable (transport en commun, vélo, logement) — exonéré ONSS+IPP
  // Pilier 3: solde en cash — cotisation spéciale 38,07% (employeur + travailleur)
  // Montant = TCO annuel voiture de société (1/5 × catalogue × coeff. âge + carburant + CO2)
  r.budgetMobilite = per.budgetMobilite || 0;
  r.budgetMobPilier2 = per.budgetMobP2 || 0; // part exonérée
  r.budgetMobPilier3 = per.budgetMobP3 || 0; // part cash → cotisation 38,07%
  r.budgetMobCotis38 = r.budgetMobPilier3 * 0.3807;

  // ── 19. RÉDUCTIONS GROUPES-CIBLES EMPLOYEUR (AR Groupes-cibles) ──
  // Réductions ONSS patronales ciblées — calculées AUTOMATIQUEMENT
  //
  // ═══ PREMIER ENGAGEMENT (AR 16/05/2003 + Réforme 01/04/2026) ═══
  // Art. 336-353 Loi-programme 24/12/2002
  // Source: ONSS instructions T1/2026 + SPF Emploi
  //
  // AVANT 01/04/2026:
  //   1er employé: exonération totale ONSS patronal (durée illimitée depuis 2016)
  //   2è employé: forfait trimestriel 1.550€ T1-T5, 1.050€ T6-T9, 450€ T10-T13
  //   3è employé: forfait trimestriel 1.050€ T1-T5, 1.050€ T6-T9, 450€ T10-T13
  //   4è employé: forfait trimestriel 1.050€ T1-T5, 1.050€ T6-T9, 450€ T10-T13
  //   5è employé: forfait trimestriel 1.050€ T1-T5, 1.050€ T6-T9, 450€ T10-T13
  //   6è employé: forfait trimestriel 1.050€ T1-T5, 1.050€ T6-T9, 450€ T10-T13
  //
  // APRÈS 01/04/2026 (Réforme budget fédéral):
  //   1er employé: max 3.100€ → réduit à 2.000€/trimestre (plafonné)
  //   2è employé: inchangé
  //   3è employé: inchangé
  //   4è-5è-6è: RÉINTRODUITS (supprimés en 2025, rétablis 04/2026)
  //
  // Paramètre: emp.nrEngagement = rang d'engagement (1 = 1er, 2 = 2è, etc.)
  // Paramètre: emp.engagementTrimestre = trimestre courant depuis engagement (1-13+)

  const PREMIER_ENG = {
    // Montants trimestriels par rang et par période (trimestres depuis engagement)
    // Format: [T1-T5, T6-T9, T10-T13, T14+]
    1: { label: '1er employé', amounts: [2000, 2000, 2000, 2000], note: 'Illimité (plafonné 2.000€/trim. depuis 04/2026)' },
    2: { label: '2è employé', amounts: [1550, 1050, 450, 0], note: '13 trimestres max' },
    3: { label: '3è employé', amounts: [1050, 1050, 450, 0], note: '13 trimestres max' },
    4: { label: '4è employé', amounts: [1050, 1050, 450, 0], note: 'Réintroduit 04/2026' },
    5: { label: '5è employé', amounts: [1050, 1050, 450, 0], note: 'Réintroduit 04/2026' },
    6: { label: '6è employé', amounts: [1050, 1050, 450, 0], note: 'Réintroduit 04/2026' },
  };

  r.redGCPremier = 0; r.redGCPremierLabel = ''; r.redGCPremierNote = '';
  const nrEng = emp.nrEngagement || 0;
  const engTrim = emp.engagementTrimestre || 1;
  if (nrEng >= 1 && nrEng <= 6) {
    const pe = PREMIER_ENG[nrEng];
    let trimIdx = 0;
    if (engTrim <= 5) trimIdx = 0;
    else if (engTrim <= 9) trimIdx = 1;
    else if (engTrim <= 13) trimIdx = 2;
    else trimIdx = 3;
    const trimAmount = pe.amounts[trimIdx];
    // Mensualiser le montant trimestriel
    r.redGCPremier = Math.round(trimAmount / 3 * 100) / 100;
    // Pour le 1er employé: ne peut pas dépasser la cotisation patronale effective
    if (nrEng === 1) r.redGCPremier = Math.min(r.redGCPremier, r.onssE + r.redStructMois);
    r.redGCPremierLabel = pe.label;
    r.redGCPremierNote = `${pe.label}: ${fmt(trimAmount)}/trim. (T${engTrim}) — ${pe.note}`;
  }

  // Travailleurs âgés ≥ 55 ans (AR 19/12/2001 — Activation 55+)
  // Réduction trimestrielle: 1.150€ si ≥ 55 ans + salaire < 14.640,83€/trim.
  r.redGCAge = per.redGCAge || 0;
  // Jeunes < 26 ans peu qualifiés (AR Activation jeunes)
  // Réduction trimestrielle: 1.500€ (très peu qualifié) ou 1.150€ (peu qualifié)
  r.redGCJeune = per.redGCJeune || 0;
  // Travailleurs handicapés
  r.redGCHandicap = per.redGCHandicap || 0;
  r.redGCTotal = r.redGCPremier + r.redGCAge + r.redGCJeune + r.redGCHandicap;

  // ── 20. COTISATION SPÉCIALE ONSS MODÉRATION SALARIALE (Loi 1996) ──
  // Déjà incluse dans le taux ONSS_E global via ONSS_SECTEUR
  // 5,67% sur la masse salariale (employeur) — pas travailleur

  // ── 21. ALLOCATION DE TRAVAIL ONEM — ACTIVATION (AR 19/12/2001 + Régional) ──
  // Mécanisme: le travailleur reçoit une allocation de l'ONEM via CAPAC/syndicat.
  // L'employeur DÉDUIT ce montant du salaire net à payer.
  // Le travailleur touche: salaire net (employeur) + allocation ONEM = rémunération totale.
  // → Le coût réel de l'employeur baisse du montant de l'allocation.
  //
  // Types d'allocations de travail:
  // Activa.brussels (Actiris): max €350/mois × 12 mois — DE ≥ 12 mois, résid. Bruxelles
  // Activa.brussels Jeunes: €350/mois × 6 mois — DE < 30 ans, ≥ 6 mois
  // Impulsion Wallonie: €500/mois × 24-36 mois — via FOREM/SPW
  // SINE (économie sociale): variable
  //
  // Traitement fiscal: l'allocation de travail est un revenu de remplacement pour le travailleur
  // → Soumise au précompte professionnel (retenue par ONEM/CAPAC)
  // → NON soumise ONSS (pas de rémunération au sens ONSS)
  // → L'employeur ne la déclare PAS en DmfA (c'est l'ONEM qui déclare)
  //
  // Sur la fiche de paie: mention "pour mémoire" — déduit du coût employeur
  const allocType = per.allocTravailType || 'none';
  r.allocTravail = per.allocTravail || 0;
  r.allocTravailType = allocType;
  // Montants standards par type (si pas de montant custom)
  if (r.allocTravail === 0 && allocType !== 'none') {
    const ALLOC_MONTANTS = {
      'activa_bxl': 350,       // Activa.brussels: €350/mois
      'activa_jeune': 350,     // Activa Jeunes: €350/mois
      'impulsion_wal': 500,    // Impulsion Wallonie: €500/mois
      'impulsion55': 500,      // Impulsion 55+: €500/mois
      'sine': 500,             // SINE: €500/mois (variable)
      'vdab': 0,               // Flandre: pas d'allocation trav. (prime directe employeur)
    };
    r.allocTravail = ALLOC_MONTANTS[allocType] || 0;
  }
  r.allocTravailLabel = {
    'activa_bxl': 'Activa.brussels (Actiris)',
    'activa_jeune': 'Activa Jeunes <30 (Actiris)',
    'impulsion_wal': 'Impulsion Wallonie (FOREM)',
    'impulsion55': 'Impulsion 55+ (FOREM)',
    'sine': 'SINE (économie sociale)',
    'vdab': 'Groupe-cible flamand (VDAB)',
  }[allocType] || '';

  // ── 14. FLEXI-JOB (Art. 3 Loi 16/11/2015 — modifié 01/01/2024) ──
  // Conditions: emploi principal min. 4/5 (T-3) OU pensionné
  // Secteurs: horeca CP302, commerce CP201/202/311, soins CP318/330/331/332,
  //   boulangerie CP118.03, agriculture CP144/145, intérim CP322, sport, culture...
  // Travailleur: 0% ONSS, 0% PP (exonéré si ≤ 12.000€/an)
  // Employeur: 28% cotisation patronale spéciale (Art.38§3ter Loi 29/06/1981)
  // Flexi-salaire min: 12,29€/h + 7,67% flexi-pécule vacances (2026)
  // Plafond IPP: 12.000€/an (pensionnés: illimité)
  // Dimona: type "FLX" | DmfA: code "050"
  r.isFlexiJob = (emp.contract === 'flexi');
  if (r.isFlexiJob) {
    const flexiMinH = 12.29;
    const flexiH = per.days * ((emp.whWeek || 10) / 5);
    const flexiTauxH = Math.max(flexiMinH, (emp.monthlySalary || 0) / ((emp.whWeek || 10) * 4.33));
    r.flexiSalaireH = flexiTauxH;
    r.flexiHeures = flexiH;
    r.flexiBrut = Math.round(flexiH * flexiTauxH * 100) / 100;
    r.flexiPecule = Math.round(r.flexiBrut * PV_SIMPLE * 100) / 100;
    r.flexiOnssPatronal = Math.round((r.flexiBrut + r.flexiPecule) * 0.28 * 100) / 100;
    r.gross = r.flexiBrut + r.flexiPecule;
    r.base = r.flexiBrut;
    r.onssW = 0; r.onssNet = 0; r.empBonus = 0; r.empBonusA = 0; r.empBonusB = 0;
    r.tax = 0; r.css = 0; r.ppVolontaire = 0; r.ppTauxExcep = 0; r.ppTauxExcepRate = 0;
    r.onssE = r.flexiOnssPatronal; r.redStructMois = 0; r.redStruct = 0;
    r.totalDed = per.advance || 0;
    r.net = r.gross - r.totalDed;
    r.costTotal = r.gross + r.flexiOnssPatronal;
    r.flexiNet = r.net;
    return r;
  }

  // ── 15. ÉTUDIANT (Art. 17bis AR ONSS) ──
  // Max 650h/an (2026 — Annexe III PP + Art.17bis AR 28/11/1969): cotisation solidarité 2,71% (trav) + 5,42% (empl)
  // Au-delà: ONSS normal. Pas de PP si ≤ 7.340€/an net imposable
  r.isStudent = (emp.contract === 'etudiant');
  if (r.isStudent) {
    r.studentOnssW = Math.round(r.gross * 0.0271 * 100) / 100; // 2,71%
    r.studentOnssE = Math.round(r.gross * 0.0542 * 100) / 100; // 5,42%
    r.onssW = r.studentOnssW; r.onssNet = r.studentOnssW;
    r.onssE = r.studentOnssE;
    r.empBonus = 0; r.empBonusA = 0; r.empBonusB = 0;
    r.redStructMois = 0; r.redStruct = 0;
    // PP = 0 si revenu annuel net ≤ 7.340€
    if (r.gross * 12 <= 7340) { r.tax = 0; r.css = 0; }
  }

  // ── 16. FRAIS PROFESSIONNELS FORFAITAIRES (Art. 51 CIR 92) ──
  // Déjà calculé ci-dessus: 30% avec plafond (employés et ouvriers)

  // ── 17. RÉDUCTIONS FAMILIALES (Art. 136-140 CIR 92) ──
  // Déjà calculé ci-dessus: quotité exemptée par enfant + isolé + handicap

  // ── 18. DISPENSE VERSEMENT PP RECHERCHE (Art. 275/3 CIR 92) ──
  // 80% du PP pour les chercheurs (diplôme Master/Doctorat)
  // Uniquement côté employeur — ne change pas le net travailleur

  // ══════════════════════════════════════════════════════════════
  //  PÉCULE DE VACANCES — CALCUL AUTOMATIQUE (Sprint 2)
  // ══════════════════════════════════════════════════════════════
  // Source: Loi 28/06/1971 + AR 30/03/1967 + ONSS Instructions 2026
  //
  // EMPLOYÉS (payé par l'employeur):
  //   Simple: 100% du brut mensuel normal (payé pendant les vacances)
  //   Double: 92% du brut mensuel → payé avant les vacances (généralement mai/juin)
  //     - 1ère partie (85%): soumise PP normal
  //     - 2ème partie (7%): soumise ONSS 13,07% + cotisation spéciale 1%
  //   → Le simple pécule = salaire normal du mois de vacances (déjà dans le brut)
  //
  // OUVRIERS (payé par la Caisse de Vacances / ONVA):
  //   Total: 15,38% du brut annuel N-1 (à 108%)
  //   Simple: 6,80% (7,69% de 108% - cotisation solidarité)
  //   Double: 8,58% (reste)
  //   → Versé via l'ONVA ou la Caisse sectorielle, PAS par l'employeur
  //   → L'employeur paie la cotisation vacances 15,84% trimestrielle à l'ONSS
  //
  r.peculeVacCalc = {
    type: isOuvrier ? 'ouvrier' : 'employe',
    brutRef: isOuvrier ? (r.gross * 1.08 * 12) : (emp.monthlySalary || 0), // brut annuel N-1 à 108% pour ouvriers
    simple: 0,
    double: 0,
    total: 0,
    onss2emePartie: 0,
    cotisSpec1pct: 0,
    ppExcep: 0,
    moisPaiement: isOuvrier ? 'Mai (Caisse de Vacances)' : 'Mai/Juin (Employeur)'
  };
  if (!isOuvrier) {
    // Employé: simple = 1 mois brut (déjà inclus dans salaire normal du mois de vacances)
    r.peculeVacCalc.simple = emp.monthlySalary || 0;
    // Double = 92% du brut mensuel (LOIS_BELGES)
    r.peculeVacCalc.double = (emp.monthlySalary || 0) * LOIS_BELGES.rémunération.peculeVacances.double.pct;
    r.peculeVacCalc.total = r.peculeVacCalc.simple + r.peculeVacCalc.double;
    // 2ème partie du double pécule (7/92 du double) → ONSS 13,07% + cotis spéciale 1%
    const dp2 = r.peculeVacCalc.double * (7/92);
    r.peculeVacCalc.onss2emePartie = Math.round(dp2 * TX_ONSS_W * 100) / 100;
    r.peculeVacCalc.cotisSpec1pct = Math.round(dp2 * 0.01 * 100) / 100;
    // PP exceptionnel sur le double pécule
    const annBrutDP = (emp.monthlySalary || 0) * 12;
    if (annBrutDP <= 17280) r.peculeVacCalc.ppExcepRate = 0;
    else if (annBrutDP <= 32280) r.peculeVacCalc.ppExcepRate = 0.1917;
    else if (annBrutDP <= 43380) r.peculeVacCalc.ppExcepRate = 0.2322;
    else r.peculeVacCalc.ppExcepRate = 0.3028;
    r.peculeVacCalc.ppExcep = Math.round(r.peculeVacCalc.double * (r.peculeVacCalc.ppExcepRate || 0) * 100) / 100;
  } else {
    // Ouvrier: 15,38% du brut annuel N-1 × 108%
    r.peculeVacCalc.simple = Math.round(r.peculeVacCalc.brutRef * 0.0680 * 100) / 100;
    r.peculeVacCalc.double = Math.round(r.peculeVacCalc.brutRef * LOIS_BELGES.rémunération.peculeVacances.ouvrierDouble.pct * 100) / 100;
    r.peculeVacCalc.total = Math.round(r.peculeVacCalc.brutRef * (PV_SIMPLE*2+0.001) * 100) / 100;
  }

  // ══════════════════════════════════════════════════════════════
  //  13ÈME MOIS / PRIME DE FIN D'ANNÉE — CALCUL PAR CP (Sprint 2)
  // ══════════════════════════════════════════════════════════════
  // Source: CCT sectorielles + AR rendant les CCT obligatoires
  //
  // La prime de fin d'année n'est PAS une obligation légale mais conventionnelle.
  // Son montant et ses conditions varient par commission paritaire:
  //
  // CP 200 (employés): 100% du brut mensuel (convention quasi-universelle)
  // CP 124 (construction): calculé en % du brut × jours prestés
  // CP 302 (horeca): prime = brut mensuel × coefficient (Fonds social)
  // CP 330 (soins santé): prime = montant fixe indexé par échelon
  //
  r.y13Calc = {
    cp: emp.cp || '200',
    moisPaiement: 'Décembre',
    montant: 0,
    onss: 0,
    ppExcep: 0,
    ppExcepRate: 0,
    coûtEmployeur: 0,
    methode: ''
  };
  const cpNum = parseInt(emp.cp) || 200;
  if (cpNum === 124) {
    // Construction: 8,33% du brut annuel (via Fonds social)
    r.y13Calc.montant = Math.round((emp.monthlySalary || 0) * 12 * 0.0833 * 100) / 100;
    r.y13Calc.methode = 'CP 124 — 8,33% brut annuel (Fonds social FBTP)';
  } else if (cpNum === 302) {
    // Horeca: via Fonds social — environ 1 mois brut
    r.y13Calc.montant = emp.monthlySalary || 0;
    r.y13Calc.methode = 'CP 302 — ±1 mois brut (Fonds social Horeca)';
  } else if (cpNum >= 330 && cpNum <= 332) {
    // Non-marchand santé/social: montant fixe indexé ≈ 1 mois
    r.y13Calc.montant = emp.monthlySalary || 0;
    r.y13Calc.methode = 'CP 330-332 — Montant fixe indexé (CCT sectorielle)';
  } else {
    // CP 200 et autres: 1 mois brut (convention quasi-universelle)
    r.y13Calc.montant = emp.monthlySalary || 0;
    r.y13Calc.methode = 'CP ' + cpNum + ' — 100% brut mensuel (CCT sectorielle)';
  }
  // ONSS sur 13ème mois: 13,07% travailleur
  r.y13Calc.onss = Math.round(r.y13Calc.montant * TX_ONSS_W * 100) / 100;
  // PP exceptionnel (taux fixe selon rémunération annuelle brute)
  const annBrut13 = (emp.monthlySalary || 0) * 12;
  if (annBrut13 <= 17280) r.y13Calc.ppExcepRate = 0;
  else if (annBrut13 <= 32280) r.y13Calc.ppExcepRate = 0.1917;
  else if (annBrut13 <= 43380) r.y13Calc.ppExcepRate = 0.2322;
  else r.y13Calc.ppExcepRate = 0.3028;
  r.y13Calc.ppExcep = Math.round(r.y13Calc.montant * r.y13Calc.ppExcepRate * 100) / 100;
  r.y13Calc.netEstime = Math.round((r.y13Calc.montant - r.y13Calc.onss - r.y13Calc.ppExcep) * 100) / 100;
  r.y13Calc.coûtEmployeur = Math.round(r.y13Calc.montant * (1 + (LEGAL.ONSS_SECTEUR[emp.cp]?.e || 0.25)) * 100) / 100;

  // ══════════════════════════════════════════════════════════════
  //  TOTALISATION
  // ══════════════════════════════════════════════════════════════

  // Total retenues sur le net
  r.totalDed = r.onssNet + r.tax + r.css + r.mvWorker
    + r.garnish + r.advance + r.otherDed + r.ppVolontaire
    + r.atnCar + r.atnAutresTot
    + r.dpOnss + r.dpCotisSpec       // ONSS double pécule
    + r.pdOnss                        // ONSS pécule départ
    + r.pensionCompl                  // retenue pension complémentaire
    + r.retSyndicale                  // retenue syndicale
    + r.saisieAlim                    // pension alimentaire
    + r.budgetMobCotis38;             // budget mobilité pilier 3

  // Net à payer
  r.net = r.gross - r.totalDed + r.expense + r.transport
    + r.doublePecule - r.dpOnss - r.dpCotisSpec    // double pécule net
    + r.peculeDepart - r.pdOnss                      // pécule départ net
    + r.primeAncExoneree                              // prime ancienneté exonérée
    + r.primeNaissance                                // prime naissance (exo)
    + r.indemTeletravail                              // indemnité télétravail (exo)
    + r.indemBureau                                   // frais bureau (exo)
    + r.petitChomageVal                               // petit chômage (salaire maintenu)
    + r.budgetMobPilier2                             // budget mobilité pilier 2 (exo)
    + r.hsBrutNetTotal;                                // HS volontaires brut=net (exo ONSS+PP)

  // ONSS employeur déjà calculé ci-dessus (onssE, onssE_rate, onssE_note)
  r.insAT = r.gross * 0.0087;
  // Cotisation vacances annuelles ouvriers (Art. 38 Loi 29/06/1981)
  // 15,84% sur brut × 108% — payé via ONSS, versé à la Caisse de vacances
  // Inclus dans le taux ONSS sectoriel ouvrier mais à afficher séparément
  r.cotisVacOuv = isOuvrier ? onssBase * LEGAL.ONSS_DETAIL_2026.vacances_annuelles_ouvrier : 0;
  // Cotisation patronale pension complémentaire (estimation si retenue personnelle existe)
  r.pensionComplEmpl = r.pensionCompl > 0 ? r.pensionCompl * 2 : 0; // ratio courant 2:1
  r.cotisWijninckx = (r.pensionComplEmpl + r.pensionCompl) * 12 > 32472 ? ((r.pensionComplEmpl + r.pensionCompl) * 12 - 32472) / 12 * 0.125 : 0;
  // Dispenses PP employeur (ne changent pas le net travailleur mais réduisent le coût)
  // Art 275/1 CIR: dispense heures sup = 32,19% du PP retenu sur le sursalaire
  r.dispensePPHSup = sursalaire > 0 ? sursalaire * 0.3219 : 0;
  r.dispensePPTotal = r.dispensePPNuit + r.dispensePPHSup;
  r.costTotal = r.gross + r.onssE + r.mvEmployer + r.expense + r.transport + r.insAT + r.cotCO2
    + r.cotisVacOuv                                     // vacances ouvriers 15,84%
    + r.pensionComplEmpl + r.cotisWijninckx              // pension complémentaire
    + r.doublePecule + r.peculeDepart + r.primeAnciennete + r.primeNaissance + r.primeInnovation
    + r.indemTeletravail + r.indemBureau
    + r.ecoCheques + r.cadeaux                           // éco-chèques + cadeaux
    + r.budgetMobCotis38                                 // budget mobilité pilier 3
    + r.veloLeasingMois                                   // leasing vélo
    + r.borneRechargeCoût                                 // borne de recharge
    + r.carteCarburantMois                                // carte carburant
    - r.dispensePPTotal                                   // dispenses PP
    - r.redGCTotal                                        // réductions groupes-cibles
    - r.allocTravail;                                     // allocation travail ONEM (déduit du coût)
  return r;
}

// ─── XML GENERATORS ──────────────────────────────────────────
function genDimonaXML(d) {
  const niss=(d.niss||'').replace(/[\.\-\s]/g,"");
  const onss=(d.onss||'').replace(/[\.\-\s]/g,"");
  const vat=(d.vat||'').replace(/[^0-9]/g,"");
  const dimRef='DIM'+Date.now().toString(36).toUpperCase()+Math.random().toString(36).slice(2,5).toUpperCase();
  return `<?xml version="1.0" encoding="UTF-8"?>
<!-- Dimona Declaration — ONSS / socialsecurity.be -->
<!-- Generee par: Aureus Social Pro — Aureus IA SPRL -->
<!-- Reference: ${dimRef} -->
<Dimona xmlns="http://www.smals-mvm.be/xml/ns/systemFlux">
  <DimonaDeclaration>
    <EmployerId>
      <NLOSSRegistrationNbr>${onss}</NLOSSRegistrationNbr>
      <CompanyID>${vat}</CompanyID>
    </EmployerId>
    <Feature>
      <CreationDate>${new Date().toISOString().split('T')[0]}</CreationDate>
      <Action>${d.action}</Action>${d.action==='UPDATE'&&d.dimonaP?`
      <DimPeriodId>${d.dimonaP}</DimPeriodId>`:''}
      <Worker>
        <INSS>${niss}</INSS>
        <WorkerName>${d.last||''}</WorkerName>
        <WorkerFirstName>${d.first||''}</WorkerFirstName>
        <BirthDate>${d.birth||''}</BirthDate>
      </Worker>
      <Period>
        <StartingDate>${d.start}</StartingDate>${d.end?`
        <EndingDate>${d.end}</EndingDate>`:''}
      </Period>
      <WorkerType>${d.wtype}</WorkerType>
      <JointCommission>${d.cp||'200'}</JointCommission>${d.hours?`
      <PlannedDaysOrHours>
        <PlannedHoursNbr>${d.hours}</PlannedHoursNbr>
      </PlannedDaysOrHours>`:''}${d.action==='OUT'&&d.reason?`
      <EndingReason>${d.reason}</EndingReason>`:''}${d.wtype==='STU'?`
      <StudentData>
        <MaxHoursPerYear>600</MaxHoursPerYear>
        <SolidarityContribution>YES</SolidarityContribution>
      </StudentData>`:''}${d.wtype==='FLX'?`
      <FlexiJobData>
        <FlexiWage>YES</FlexiWage>
        <SpecialContribution28>YES</SpecialContribution28>
      </FlexiJobData>`:''}${d.wtype==='EXT'?`
      <ExtraData>
        <MaxDaysPerYear>50</MaxDaysPerYear>
        <FlatRateContribution>YES</FlatRateContribution>
      </ExtraData>`:''}
    </Feature>
    <SenderSoftware>AureusSocialPro</SenderSoftware>
    <SenderSoftwareVersion>2026.4</SenderSoftwareVersion>
  </DimonaDeclaration>
</Dimona>`;
}


function genDMFAXML(co, emps, q, y) {
  // DMFA conforme schema XSD ONSS — socialsecurity.be/TechLib
  // Structure: FormCreation > EmployerDeclaration > WorkerRecord > OccupationRecord > ServiceRecord > RemunRecord + ContributionRecord
  const qStart=new Date(y,(q-1)*3,1);
  const qEnd=new Date(y,q*3,0);
  const fmtDt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  const ref=`DMFAP${String(Math.floor(Math.random()*900000000)+100000000)}${String.fromCharCode(65+Math.floor(Math.random()*26))}`;
  const catEmpl=(co.cp==='330'||co.cp==='331'||co.cp==='332')?'010':'000';
  const nrONSS=(co.onss||'').replace(/[\.\-\s]/g,"")||'0000000000';
  const nrEnt=(co.vat||'').replace(/[^0-9]/g,"")||'0000000000';

  const wrs=emps.map((e,idx)=>{
    const p=calc(e,{days:65},co);
    const niss=(e.niss||'').replace(/[\.\-\s]/g,"");
    const isOuv=(e.statut==='ouvrier');
    const codeTrav=e.dmfaCode||'495';
    const baseONSS=isOuv?p.gross*3*TX_OUV108:p.gross*3;
    const wh=e.whWeek||38;
    const daysQ=Math.round((p.mvDays||22)*3);
    const hoursQ=Math.round(daysQ*(wh/5)*100)/100;
    const startD=e.startD||fmtDt(qStart);
    return `    <WorkerRecord>
      <WorkerIdentification>
        <INSS>${niss}</INSS>
        <WorkerName>${e.last||''}</WorkerName>
        <WorkerFirstName>${e.first||''}</WorkerFirstName>
      </WorkerIdentification>
      <WorkerContributionCode>${codeTrav}</WorkerContributionCode>
      <WorkerCategory>${catEmpl}</WorkerCategory>
      <OccupationRecord>
        <OccupationSequenceNbr>${idx+1}</OccupationSequenceNbr>
        <CommissionNbr>${e.cp||'200'}</CommissionNbr>
        <WorkerStatus>${isOuv?'1':'2'}</WorkerStatus>
        <MeanWorkingHoursPerWorker>${wh.toFixed(2)}</MeanWorkingHoursPerWorker>
        <MeanWorkingHoursReferPerson>38.00</MeanWorkingHoursReferPerson>
        <WorkSchedule>${e.regime==='full'?'F':'P'}</WorkSchedule>
        <OccupationStartingDate>${startD}</OccupationStartingDate>
        <OccupationEndingDate>${fmtDt(qEnd)}</OccupationEndingDate>
        <EstablishmentUnitNbr>${nrEnt}</EstablishmentUnitNbr>
        <ServiceRecord>
          <ServiceCode>001</ServiceCode>
          <ServiceNbrDays>${daysQ}</ServiceNbrDays>
          <ServiceNbrHours>${hoursQ.toFixed(2)}</ServiceNbrHours>
        </ServiceRecord>
        <RemunRecord>
          <RemunCode>001</RemunCode>
          <RemunAmount>${(p.gross*3).toFixed(2)}</RemunAmount>
          <RemunFrequency>1</RemunFrequency>
        </RemunRecord>${isOuv?`
        <RemunRecord>
          <RemunCode>010</RemunCode>
          <RemunAmount>${(p.gross*3*0.08).toFixed(2)}</RemunAmount>
          <RemunFrequency>1</RemunFrequency>
        </RemunRecord>`:''}
      </OccupationRecord>
      <ContributionWorkerRecord>
        <ContributionType>001</ContributionType>
        <ContributionBase>${baseONSS.toFixed(2)}</ContributionBase>
        <ContributionPercentage>13.07</ContributionPercentage>
        <ContributionAmount>${(baseONSS*LEGAL.ONSS_W).toFixed(2)}</ContributionAmount>
      </ContributionWorkerRecord>${p.empBonus>0?`
      <DeductionRecord>
        <DeductionType>001</DeductionType>
        <DeductionAmount>${(p.empBonus*3).toFixed(2)}</DeductionAmount>
      </DeductionRecord>`:''}
    </WorkerRecord>`;
  }).join('\n');

  const totW=emps.reduce((s,e)=>{const p=calc(e,{days:65},co);const isO=e.statut==='ouvrier';const b=isO?p.gross*3*TX_OUV108:p.gross*3;return s+b*LEGAL.ONSS_W;},0);
  const totE=emps.reduce((s,e)=>{const p=calc(e,{days:65},co);return s+p.onssE*3;},0);
  const totFFE=emps.reduce((s,e)=>{const p=calc(e,{days:65},co);return s+(p.onss_ffe||0)*3;},0);
  const totChT=emps.reduce((s,e)=>{const p=calc(e,{days:65},co);return s+(p.onss_chomTemp||0)*3;},0);
  const totAm=emps.reduce((s,e)=>{const p=calc(e,{days:65},co);return s+(p.onss_amiante||0)*3;},0);
  const totBase=emps.reduce((s,e)=>{const p=calc(e,{days:65},co);const isO=e.statut==='ouvrier';return s+(isO?p.gross*3*TX_OUV108:p.gross*3);},0);

  return `<?xml version="1.0" encoding="UTF-8"?>
<!-- DmfAOriginal — Declaration Multifonctionnelle / Securite Sociale Belge -->
<!-- Schema conforme ONSS — socialsecurity.be/TechLib -->
<!-- Reference: ${ref} | Trimestre: ${q}/${y} -->
<!-- Généré par: Aureus Social Pro — Aureus IA SPRL (${AUREUS_INFO.vat}) -->
<DmfAOriginal xmlns="http://www.smals-mvm.be/xml/ns/systemFlux"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <FormCreation>
    <FormType>DMFA</FormType>
    <FormCreationDate>${fmtDt(new Date())}</FormCreationDate>
    <Reference>${ref}</Reference>
    <FormSubType>ORIGINAL</FormSubType>
    <SenderSoftware>AureusSocialPro</SenderSoftware>
    <SenderSoftwareVersion>2026.4</SenderSoftwareVersion>
    <SenderCompanyID>${nrEnt}</SenderCompanyID>
  </FormCreation>
  <EmployerDeclaration>
    <NLOSSRegistrationNbr>${nrONSS}</NLOSSRegistrationNbr>
    <CompanyID>${nrEnt}</CompanyID>
    <EmployerDenomination>${co.name||''}</EmployerDenomination>
    <LanguageCode>1</LanguageCode>
    <Quarter>${q}</Quarter>
    <Year>${y}</Year>
    <EmployerCategory>${catEmpl}</EmployerCategory>
    <NbrOfWorkers>${emps.length}</NbrOfWorkers>
${wrs}
    <GlobalContribution>
      <ContributionRecord><ContributionType>001</ContributionType><ContributionBase>${totBase.toFixed(2)}</ContributionBase><ContributionAmount>${totE.toFixed(2)}</ContributionAmount></ContributionRecord>
      <ContributionRecord><ContributionType>810</ContributionType><ContributionBase>${totBase.toFixed(2)}</ContributionBase><ContributionAmount>${totFFE.toFixed(2)}</ContributionAmount></ContributionRecord>
      <ContributionRecord><ContributionType>855</ContributionType><ContributionBase>${totBase.toFixed(2)}</ContributionBase><ContributionAmount>${totChT.toFixed(2)}</ContributionAmount></ContributionRecord>
      ${q<=3?`<ContributionRecord><ContributionType>862</ContributionType><ContributionBase>${totBase.toFixed(2)}</ContributionBase><ContributionAmount>${totAm.toFixed(2)}</ContributionAmount></ContributionRecord>`:'<!-- Fonds amiante: non du en T4 -->'}
    </GlobalContribution>
    <DeclarationTotals>
      <TotalWorkerContribution>${totW.toFixed(2)}</TotalWorkerContribution>
      <TotalEmployerContribution>${(totE+totFFE+totChT+totAm).toFixed(2)}</TotalEmployerContribution>
      <TotalContribution>${(totW+totE+totFFE+totChT+totAm).toFixed(2)}</TotalContribution>
    </DeclarationTotals>
  </EmployerDeclaration>
</DmfAOriginal>`;
}

// Genere un accuse de reception (ACRF) simule conforme ONSS
function genDMFATicket(ref,co){
  const ticket='DMFAP'+String(Math.floor(Math.random()*900000000)+100000000)+String.fromCharCode(65+Math.floor(Math.random()*26));
  const fmtDt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  return {ticket,xml:`<?xml version="1.0" encoding="UTF-8"?>
<!-- Accuse de reception (ACRF) — ONSS -->
<AcknowledgmentOfReceipt>
  <Ticket>${ticket}</Ticket>
  <FormType>DMFA</FormType>
  <Reference>${ref}</Reference>
  <ReceptionDate>${fmtDt(new Date())}</ReceptionDate>
  <ResultCode>1</ResultCode>
  <ResultDescription>Fichier accepte pour traitement</ResultDescription>
  <CompanyID>${(co.vat||'').replace(/[^0-9]/g,"")}</CompanyID>
  <Software>AureusSocialPro v2226.1</Software>
</AcknowledgmentOfReceipt>`};
}

// Genere une notification (DMNO) simulee conforme ONSS
function genDMFANotification(ticket,co,q,y,nW,totC,anomalies){
  const fmtDt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  return `<?xml version="1.0" encoding="UTF-8"?>
<!-- Notification (DMNO) — ONSS -->
<DmfANotification>
  <FormType>DMFA</FormType>
  <Ticket>${ticket}</Ticket>
  <Quarter>${q}</Quarter><Year>${y}</Year>
  <CompanyID>${(co.vat||'').replace(/[^0-9]/g,"")}</CompanyID>
  <ResultCode>${anomalies.length===0?'1':'1'}</ResultCode>
  <ResultDescription>Declaration acceptee${anomalies.length>0?' avec anomalies':''}</ResultDescription>
  <HandlingDate>${fmtDt(new Date())}</HandlingDate>
  <NbrOfWorkers>${nW}</NbrOfWorkers>
  <TotalContribution>${totC}</TotalContribution>
  ${anomalies.length>0?'<AnomalyReport>'+anomalies.map(a=>'<Anomaly><Zone>'+a.zone+'</Zone><Severity>'+a.sev+'</Severity><Desc>'+a.desc+'</Desc></Anomaly>').join('')+'</AnomalyReport>':'<AnomalyReport/>'}
</DmfANotification>`;
}

function genBelcotax(co, emp, yr, ad) {
  // Belcotax XML — Format BelcotaxOnWeb SPF Finances
  // Ref: https://financien.belgium.be/fr/e-services/belcotaxonweb
  // 281.10 = salariés | 281.20 = dirigeants | 281.50 = commissions
  const statut = emp.statut === 'dirigeant' ? '20' : '10';
  return `<?xml version="1.0" encoding="UTF-8"?>
<Belcotax xmlns="urn:belcotax:${yr}">
  <Verzending>
    <Aangifte>
      <Taal>FR</Taal>
      <Aangiftetype>281.${statut}</Aangiftetype>
      <AangifteJaar>${yr}</AangifteJaar>
      <Schuldenaar>
        <KBO>${(co.bce||co.vat||'').replace(/[^0-9]/g,"")}</KBO>
        <BTWNr>${(co.vat||'').replace(/[^0-9]/g,"")}</BTWNr>
        <ONSS>${(co.onss||'').replace(/[^0-9]/g,"")}</ONSS>
        <NACECode>${co.nace||''}</NACECode>
        <Naam>${co.name}</Naam>
        <Adres>${co.addr}</Adres>
      </Schuldenaar>
      <Opgave>
        <Verkrijger>
          <INSZ>${(emp.niss||'').replace(/[\.\-\s]/g,"")}</INSZ>
          <Naam>${emp.last}</Naam>
          <Voornaam>${emp.first}</Voornaam>
          <Adres>${emp.addr||''} ${emp.zip||''} ${emp.city||''}</Adres>
          <Geboortedatum>${emp.birth||''}</Geboortedatum>
        </Verkrijger>
        <Bezoldiging>
          <Lonen>${(ad.gross||0).toFixed(2)}</Lonen>
          <RIZIV>${(ad.onss||0).toFixed(2)}</RIZIV>
          <WerkBonus>${(ad.empB||0).toFixed(2)}</WerkBonus>
          <BedrijfsVH>${(ad.tax||0).toFixed(2)}</BedrijfsVH>
          <BijzBijdrSZ>${(ad.css||0).toFixed(2)}</BijzBijdrSZ>
          <Maaltijdcheques aantal="${ad.mvC||0}">${(ad.mvE||0).toFixed(2)}</Maaltijdcheques>
          <Vervoer>${(ad.tr||0).toFixed(2)}</Vervoer>
          <VoertuigVAA>${(ad.atnCar||0).toFixed(2)}</VoertuigVAA>
          <AndereVAA>${(ad.atnAutres||0).toFixed(2)}</AndereVAA>
          <AanvullendPensioen>${(ad.pensionCompl||0).toFixed(2)}</AanvullendPensioen>
          <EigenKosten>${(ad.fraisPropres||0).toFixed(2)}</EigenKosten>
          <EcoCheques>${(ad.ecoCheques||0).toFixed(2)}</EcoCheques>
        </Bezoldiging>
        <Periode><Van>01-01-${yr}</Van><Tot>31-12-${yr}</Tot></Periode>
        <Tewerkstelling>
          <CP>${emp.cp||'200'}</CP>
          <Functie>${emp.fn||''}</Functie>
          <Regime>${emp.regime==='full'?'VT':'DT'}</Regime>
          <Uren>${emp.whWeek||38}</Uren>
        </Tewerkstelling>
      </Opgave>
    </Aangifte>
  </Verzending>
</Belcotax>`;
}

// ─── INITIAL STATE ───────────────────────────────────────────
const AUREUS_INFO={name:'Aureus IA SPRL',vat:'BE 1028.230.781',addr:'Saint-Gilles, Bruxelles',email:"info@aureus-ia.com",version:'v38',sprint:'Sprint 17 — Automatisation 100%'};

// ═════════════════════════════════════════════════════
// SPRINT 50: PDF Generator — jsPDF + Aureus branding
// ═════════════════════════════════════════════════════
const _jsPDFLoaded={v:false,p:null};
function loadJsPDF(){if(_jsPDFLoaded.v)return Promise.resolve();if(_jsPDFLoaded.p)return _jsPDFLoaded.p;_jsPDFLoaded.p=new Promise((res,rej)=>{const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';s.onload=()=>{_jsPDFLoaded.v=true;res()};s.onerror=()=>rej(new Error('jsPDF load failed'));document.head.appendChild(s)});return _jsPDFLoaded.p;}
async function aureuspdf(title,sections,options){options=options||{};await loadJsPDF();const{jsPDF}=window.jspdf;const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});const W=210,H=297,ML=20,MR=20,MT=20,MB=20;const pw=W-ML-MR;let y=MT;const gold=[198,163,78],dark=[6,8,16],white=[232,230,224],grey=[158,155,147];const addHeader=()=>{pdf.setFillColor(6,8,16);pdf.rect(0,0,W,45,'F');pdf.setFillColor(198,163,78);pdf.rect(0,44,W,1.5,'F');pdf.setFont('helvetica','bold');pdf.setFontSize(22);pdf.setTextColor(198,163,78);pdf.text('AUREUS',ML,20);pdf.setFont('helvetica','normal');pdf.setFontSize(8);pdf.setTextColor(158,155,147);pdf.text('SOCIAL PRO',ML+38,20);pdf.setFontSize(9);pdf.setTextColor(232,230,224);pdf.text(title,ML,30);pdf.setFontSize(7);pdf.setTextColor(158,155,147);var now=new Date();pdf.text('Date: '+now.toLocaleDateString('fr-BE')+' | Ref: ASP-'+now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(Math.floor(Math.random()*9000+1000)),ML,37);if(options.enterprise){pdf.text(String(options.enterprise),W-MR-pdf.getTextWidth(String(options.enterprise)),37)}y=55};var addFooter=function(pn,tp){pdf.setFillColor(198,163,78);pdf.rect(0,H-12,W,0.5,'F');pdf.setFontSize(7);pdf.setTextColor(158,155,147);pdf.text('Aureus Social Pro | Aureus IA SPRL (BCE BE 1028.230.781)',ML,H-6);pdf.text('Page '+pn+'/'+tp,W-MR-15,H-6)};var checkPage=function(needed){if(y+needed>H-MB-15){pdf.addPage();addHeader();return true}return false};addHeader();(sections||[]).forEach(function(sec){if(sec.type==='title'){checkPage(12);pdf.setFont('helvetica','bold');pdf.setFontSize(14);pdf.setTextColor(198,163,78);pdf.text(sec.text||'',ML,y);y+=8}else if(sec.type==='subtitle'){checkPage(10);pdf.setFont('helvetica','bold');pdf.setFontSize(11);pdf.setTextColor(232,230,224);pdf.text(sec.text||'',ML,y);y+=6}else if(sec.type==='text'){var lines=pdf.splitTextToSize(sec.text||'',pw);lines.forEach(function(line){checkPage(5);pdf.setFont('helvetica','normal');pdf.setFontSize(sec.size||9);if(sec.color){pdf.setTextColor(sec.color[0],sec.color[1],sec.color[2])}else{pdf.setTextColor(232,230,224)}pdf.text(line,ML,y);y+=4.5})}else if(sec.type==='line'){checkPage(4);pdf.setDrawColor(198,163,78);pdf.setLineWidth(0.3);pdf.line(ML,y,W-MR,y);y+=4}else if(sec.type==='space'){y+=(sec.h||6)}else if(sec.type==='kv'){checkPage(6);pdf.setFont('helvetica','bold');pdf.setFontSize(9);pdf.setTextColor(158,155,147);pdf.text((sec.k||'')+':',ML,y);pdf.setFont('helvetica','normal');pdf.setTextColor(232,230,224);pdf.text(String(sec.v||''),ML+50,y);y+=5}else if(sec.type==='article'){checkPage(8);pdf.setFont('helvetica','bold');pdf.setFontSize(10);pdf.setTextColor(198,163,78);pdf.text(sec.num||'',ML,y);pdf.setFont('helvetica','normal');pdf.setFontSize(9);pdf.setTextColor(232,230,224);var artLines=pdf.splitTextToSize(sec.text||'',pw-5);artLines.forEach(function(line,i){if(i>0)checkPage(4.5);pdf.text(line,ML+5,y);y+=4.5});y+=2}else if(sec.type==='signature'){checkPage(25);y+=10;pdf.setDrawColor(158,155,147);pdf.line(ML,y,ML+60,y);pdf.line(W-MR-60,y,W-MR,y);pdf.setFontSize(8);pdf.setTextColor(158,155,147);pdf.text("L'Employeur",ML,y+5);pdf.text("Le Travailleur",W-MR-60,y+5);y+=15}});var totalPages=pdf.internal.getNumberOfPages();for(var i=1;i<=totalPages;i++){pdf.setPage(i);addFooter(i,totalPages)}var filename=(options.filename||title.replace(/[^a-zA-Z0-9]/g,'_'))+'.pdf';pdf.save(filename);return filename;}


const CAR_MODELS={
'Aiways':['U5',"U6"],
'Alfa Romeo':['Giulia',"Stelvio","Tonale","Junior","Giulietta","MiTo"],
'Alpine':['A110',"A290"],
'Aston Martin':['DB12',"DBX","Vantage","DBS"],
'Audi':['A1',"A3","A4","A5","A6","A7","A8","Q2","Q3","Q4 e-tron","Q5","Q7","Q8","e-tron","e-tron GT","TT","RS3","RS4","RS5","RS6","S3","S4","S5"],
'Bentley':['Continental GT',"Flying Spur","Bentayga"],
'BMW':['Série 1',"Série 2","Série 3","Série 4","Série 5","Série 7","Série 8","X1","X2","X3","X4","X5","X6","X7","XM","iX","iX1","iX3","i4","i5","i7","Z4","M2","M3","M4"],
'BYD':['Atto 3',"Dolphin","Seal","Tang","Han","Seal U"],
'Cadillac':['XT4',"XT5","Escalade","Lyriq"],
'Chevrolet':['Camaro',"Corvette","Tahoe"],
'Chrysler':['300',"Pacifica"],
'Citroën':['C3',"C3 Aircross","C4","C4 X","C5 Aircross","C5 X","Berlingo","ë-C3","ë-C4","ë-Berlingo"],
'Cupra':['Born',"Formentor","Leon","Ateca","Tavascan","Terramar"],
'Dacia':['Sandero',"Duster","Jogger","Spring","Logan"],
'Dodge':['Challenger',"Charger","Durango","RAM 1500"],
'DS':['DS 3',"DS 4","DS 7","DS 9"],
'Ferrari':['296 GTB',"Roma","Purosangue","SF90","F8","812"],
'Fiat':['500',"500X","500e","Tipo","Panda","Doblo","600e"],
'Ford':['Fiesta',"Focus","Puma","Kuga","Mustang","Mustang Mach-E","Explorer","Ranger","Transit","Transit Custom","Tourneo"],
'Genesis':['G70',"G80","GV60","GV70","GV80"],
'Honda':['Civic',"HR-V","CR-V","ZR-V","Jazz","e:Ny1","Honda e"],
'Hyundai':['i10',"i20","i30","Kona","Tucson","Santa Fe","Ioniq 5","Ioniq 6","Bayon","Staria"],
'Infiniti':['Q30',"Q50","QX50"],
'Isuzu':['D-Max'],
'Jaguar':['F-Pace',"E-Pace","I-Pace","XE","XF","F-Type"],
'Jeep':['Renegade',"Compass","Avenger","Wrangler","Grand Cherokee"],
'Kia':['Picanto',"Rio","Ceed","Sportage","Sorento","Niro","EV6","EV9","Stonic","XCeed"],
'Lamborghini':['Huracán',"Urus","Revuelto"],
'Land Rover':['Defender',"Discovery","Discovery Sport","Range Rover","Range Rover Sport","Range Rover Velar","Range Rover Evoque"],
'Lexus':['UX',"NX","RX","ES","IS","LC","RZ"],
'Lotus':['Emira',"Eletre","Emeya"],
'Lynk & Co':['01',"02"],
'Maserati':['Ghibli',"Levante","Quattroporte","MC20","Grecale","GranTurismo"],
'Mazda':['Mazda2',"Mazda3","CX-3","CX-30","CX-5","CX-60","MX-5","MX-30"],
'McLaren':['720S',"Artura","GT"],
'Mercedes':['Classe A',"Classe B","Classe C","Classe E","Classe S","CLA","CLE","GLA","GLB","GLC","GLE","GLS","EQA","EQB","EQC","EQE","EQS","AMG GT","Classe G","Classe V","Vito","Sprinter"],
'MG':['ZS',"MG4","MG5","Marvel R","HS","Cyberster"],
'Mini':['Cooper',"Countryman","Clubman","Aceman"],
'Mitsubishi':['ASX',"Eclipse Cross","Outlander","Space Star","L200"],
'NIO':['ET5',"ET7","EL6","EL7","EL8"],
'Nissan':['Micra',"Juke","Qashqai","X-Trail","Leaf","Ariya","Townstar","Navara"],
'Opel':['Corsa',"Astra","Mokka","Crossland","Grandland","Combo","Vivaro","Movano"],
'Peugeot':['208',"308","408","508","2008","3008","5008","e-208","e-308","e-2008","e-3008","Rifter","Partner","Expert"],
'Polestar':['Polestar 2',"Polestar 3","Polestar 4"],
'Porsche':['911',"718 Cayman","718 Boxster","Cayenne","Macan","Panamera","Taycan"],
'Renault':['Clio',"Captur","Mégane E-Tech","Arkana","Austral","Espace","Scénic","Kangoo","Trafic","Master","Zoe","Twingo"],
'Rolls-Royce':['Ghost',"Phantom","Cullinan","Spectre"],
'Seat':['Ibiza',"Leon","Arona","Ateca","Tarraco"],
'Škoda':['Fabia',"Scala","Octavia","Superb","Kamiq","Karoq","Kodiaq","Enyaq","Elroq"],
'Smart':['#1',"#3","Fortwo","Forfour"],
'SsangYong':['Tivoli',"Korando","Rexton","Torres"],
'Subaru':['Impreza',"XV","Outback","Forester","Solterra","BRZ"],
'Suzuki':['Swift',"Vitara","S-Cross","Jimny","Ignis","Across","Swace"],
'Tesla':['Model 3',"Model Y","Model S","Model X","Cybertruck"],
'Toyota':['Yaris',"Yaris Cross","Corolla","Camry","C-HR","RAV4","Highlander","Land Cruiser","bZ4X","Supra","GR86","Proace","Hilux","Aygo X"],
'Volkswagen':['Polo',"Golf","ID.3","ID.4","ID.5","ID.7","ID. Buzz","T-Roc","T-Cross","Tiguan","Touareg","Arteon","Passat","Caddy","Transporter","Multivan"],
'Volvo':['XC40',"XC60","XC90","C40","S60","S90","V60","V90","EX30","EX90","EM90"],
'XPeng':['G6',"G9","P7"],
};

const COMPANY={name:'',vat:'',addr:'',onss:'',bank:'',cp:'200',contact:'',email:"",phone:'',insurer:'',policyNr:'',secSoc:''};
const DPER={month:new Date().getMonth()+1,year:new Date().getFullYear(),days:22,sickG:0,holidays:0,overtimeH:0,sundayH:0,nightH:0,bonus:0,y13:0,otherDed:0,advance:0,garnish:0,ppVolontaire:0,
  // Éléments fiscaux complets
  doublePecule:0,         // Double pécule vacances (si payé par employeur — employés)
  peculeDepart:0,         // Pécule de vacances de départ (sortie de service)
  primeAnciennete:0,      // Prime d'ancienneté (exo ONSS+IPP si ≤ plafond)
  primeNaissance:0,       // Prime de naissance/mariage (exo ONSS si ≤ plafond)
  primeInnovation:0,      // Prime d'innovation (Art. 38 §1er 25° CIR — exo IPP max 1 mois)
  indemTeletravail:0,     // Indemnité forfaitaire télétravail (max 154,74€/mois 2026)
  indemBureau:0,          // Indemnité frais de bureau (si pas forfaitaire)
  pensionCompl:0,         // Retenue personnelle pension complémentaire (2è pilier — assur. groupe)
  retSyndicale:0,         // Retenue cotisation syndicale
  saisieAlim:0,           // Pension alimentaire (saisie prioritaire)
  heuresSupFisc:0,        // Heures sup ouvrant droit à réduction PP (max 180h/an — Art.154bis CIR — 2026)
  // Heures sup volontaires brut=net (nouveau régime 01/04/2026)
  hsVolontBrutNet:0,      // HS volontaires brut=net (max 240h/an — 360h horeca) — exo ONSS + PP + sursalaire
  hsRelance:0,            // HS relance transitoire T1/2026 (max 120h) — brut=net aussi
  typeSpecial:"normal",   // normal, doublePecule, y13, depart, preavis
  // Activation ONEM
  allocTravail:0,         // Allocation de travail ONEM (Activa/Impulsion — déduit du net par l'employeur)
  allocTravailType:'none', // none, activa_bxl, activa_jeune, impulsion_wal, impulsion55, vdab
  // Mi-temps médical / Reprise progressive
  miTempsMed:false,       // Reprise partielle du travail (Art. 100§2 Loi coord. 14/07/1994)
  miTempsHeures:0,        // Heures/semaine prestées chez employeur (ex: 19h sur 38h)
  miTempsINAMI:0,         // Complément INAMI perçu par le travailleur (indemnités mutuelle)
};

// ─── PERSISTENCE — Supabase-first with localStorage fallback ───
const STORE_KEY='aureus-social-pro';
// Supabase persistence helpers
async function saveToSupabase(supabase, userId, data) {
  if (!supabase || !userId) return false;
  try {
    const { error } = await supabase.from('app_state').upsert({
      user_id: userId,
      state_key: 'main',
      state_data: data,
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id,state_key' });
    return !error;
  } catch(e) { console.warn('Supabase save failed, using localStorage:', e); return false; }
}
async function loadFromSupabase(supabase, userId) {
  if (!supabase || !userId) return null;
  try {
    const { data, error } = await supabase.from('app_state')
      .select('state_data').eq('user_id', userId).eq('state_key', 'main').maybeSingle();
    if (error || !data) return null;
    return data.state_data;
  } catch(e) { return null; }
}
// Combined save: Supabase + localStorage backup
let _supabaseRef = null;
let _userIdRef = null;
let _saveTimer = null;
function setSupabaseRefs(sb, uid) { _supabaseRef = sb; _userIdRef = uid; }

// ── Sprint 18: Multi-User Realtime System ──
let _realtimeChannel = null;
let _presenceChannel = null;
const ROLES = { admin:'Admin', gestionnaire:'Gestionnaire', readonly:'Lecture seule' };

function setupRealtime(supabase, userId, userEmail, onDataChange) {
  if (!supabase || _realtimeChannel) return;
  try {
    // Subscribe to data changes
    _realtimeChannel = supabase.channel('app_state_changes')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'app_state',
        filter: 'state_key=eq.main'
      }, (payload) => {
        // Someone else saved - reload data
        if (payload.new && payload.new.user_id !== userId) {
          if (onDataChange) onDataChange(payload.new.state_data);
        }
      })
      .subscribe();

    // Presence channel - who's online
    _presenceChannel = supabase.channel('online_users', {
      config: { presence: { key: userId } }
    });
    _presenceChannel.on('presence', { event: 'sync' }, () => {
      const state = _presenceChannel.presenceState();
      if (typeof window !== 'undefined') {
        window._onlineUsers = Object.entries(state).map(([k, v]) => ({
          id: k,
          email: v[0]?.email || 'Inconnu',
          role: v[0]?.role || 'admin',
          lastSeen: v[0]?.online_at || new Date().toISOString()
        }));
        window.dispatchEvent(new Event('presence_update'));
      }
    });
    _presenceChannel.subscribe(async (status) => {
      if (status === 'SUBSCRIBED') {
        await _presenceChannel.track({
          email: userEmail || 'Admin',
          role: 'admin',
          online_at: new Date().toISOString(),
          page: 'dashboard'
        });
      }
    });
  } catch(e) { console.log('Realtime setup failed:', e); }
}

function updatePresencePage(page) {
  if (_presenceChannel) {
    _presenceChannel.track({
      email: _userIdRef || 'Admin',
      role: 'admin',
      online_at: new Date().toISOString(),
      page: page
    }).catch(() => {});
  }
}

function cleanupRealtime() {
  if (_realtimeChannel) { _realtimeChannel.unsubscribe(); _realtimeChannel = null; }
  if (_presenceChannel) { _presenceChannel.unsubscribe(); _presenceChannel = null; }
}

// Save user role to Supabase

async function getUserRoles(supabase) {
  if (!supabase) return [];
  try {
    const { data } = await supabase.from('user_roles').select('*').order('updated_at', { ascending: false });
    return data || [];
  } catch(e) { return []; }
}

// Activity log
async function logActivity(supabase, userId, action, details) {
  if (!supabase || !userId) return;
  try {
    await supabase.from('activity_log').insert({
      user_id: userId,
      action: action,
      details: details,
      created_at: new Date().toISOString()
    });
  } catch(e) { console.warn('[logActivity] Echec:', e.message); }
}

async function getActivityLog(supabase) {
  if (!supabase) return [];
  try {
    const { data } = await supabase.from('activity_log')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(50);
    return data || [];
  } catch(e) { return []; }
}

// ── Sprint 29: Robust Persistence Engine ──
let _saveStatus = 'idle'; // idle | saving | saved | error
let _lastSaveTime = 0;
let _saveRetries = 0;
const MAX_RETRIES = 3;
let _saveQueue = null;
let _statusListeners = [];

function onSaveStatus(fn) { _statusListeners.push(fn); return () => { _statusListeners = _statusListeners.filter(f => f !== fn); }; }
function _notifyStatus(status) { _saveStatus = status; _statusListeners.forEach(fn => fn(status)); }

async function saveData(data) {
  try {
    if (typeof window === 'undefined') return;
    _saveQueue = data;
    if (_saveTimer) clearTimeout(_saveTimer);
    _saveTimer = setTimeout(() => _executeSave(), 800);
  } catch (e) { console.warn('Save queue failed', e); }
}

async function _executeSave() {
  const data = _saveQueue;
  if (!data) return;
  _saveQueue = null;
  _notifyStatus('saving');

  // 1. Always save to localStorage (instant, reliable)
  try {
    const json = JSON.stringify(data);
    safeLS.set(STORE_KEY, json);
    // Also save a backup with timestamp
    safeLS.set(STORE_KEY + '_backup', json);safeLS.set(STORE_KEY + '_ts', new Date().toISOString());
  } catch (e) {
    console.warn('localStorage full, clearing backup:', e);
    try { safeLS.remove(STORE_KEY + '_backup'); safeLS.set(STORE_KEY, JSON.stringify(data)); } catch (e2) { console.error('[_executeSave] localStorage critique — donnees non sauvegardees:', e2.message); }
  }

  // 2. Save to Supabase with retry
  if (_supabaseRef && _userIdRef) {
    let success = false;
    for (let attempt = 0; attempt < MAX_RETRIES && !success; attempt++) {
      success = await saveToSupabase(_supabaseRef, _userIdRef, data);
      if (!success && attempt < MAX_RETRIES - 1) {
        await new Promise(r => setTimeout(r, 1000 * (attempt + 1))); // exponential backoff
      }
    }
    if (success) {
      _saveRetries = 0;
      _lastSaveTime = Date.now();
      _notifyStatus('saved');
      // Clear status after 3s
      setTimeout(() => { if (_saveStatus === 'saved') _notifyStatus('idle'); }, 3000);
    } else {
      _saveRetries++;
      _notifyStatus('error');
      console.warn('Supabase save failed after', MAX_RETRIES, 'retries (localStorage OK)');
    }
  } else {
    _lastSaveTime = Date.now();
    _notifyStatus('saved');
    setTimeout(() => { if (_saveStatus === 'saved') _notifyStatus('idle'); }, 3000);
  }
}

// Force save (no debounce) — used before page unload
async function forceSave(data) {
  if (typeof window === 'undefined') return;
  try {
    safeLS.set(STORE_KEY, JSON.stringify(data));
    if (_supabaseRef && _userIdRef) {
      await saveToSupabase(_supabaseRef, _userIdRef, data);
    }
  } catch (e) { console.warn('[forceSave] Echec sauvegarde:', e.message); }
}
async function loadData(supabase, userId){
  try{
    if (typeof window === 'undefined') return null;
    // Try Supabase first
    if (supabase && userId) {
      const sbData = await loadFromSupabase(supabase, userId);
      if (sbData && sbData.clients && sbData.clients.length > 0) {
        // Sync to localStorage
        try { safeLS.set(STORE_KEY, JSON.stringify(sbData)); } catch(e){}
        return sbData;
      }
    }
    // Fallback to localStorage
    let val=safeLS.get(STORE_KEY);
    if (!val) return null;
    return (()=>{try{return JSON.parse(val)}catch(e){return null}})();
  }catch(e){return null;}
}



// ═══════════════════════════════════════════════════════
// UTILITAIRE PDF — Impression native via navigateur
// ═══════════════════════════════════════════════════════
// ═══ UTILITAIRE — Échappement HTML (protection XSS) ═══
function escapeHtml(str){
  return String(str||'').replace(/\&/g,'\&amp;').replace(/</g,'\&lt;').replace(/>/g,'\&gt;').replace(/"/g,'\&quot;').replace(/'/g,'\&#39;');
}

function printToPDF(title, content, options){
  const w=window.open('','_blank','width=800,height=1100');
  if(!w)return alert('Autorisez les popups pour generer le PDF');
  w.document.write('<!DOCTYPE html><html><head><title>'+escapeHtml(title)+'</title>');
  w.document.write('<style>');
  w.document.write('*{margin:0;padding:0;box-sizing:border-box}');
  w.document.write('body{font-family:Helvetica,Arial,sans-serif;padding:40px;color:#1a1a1a;font-size:11pt;line-height:1.5}');
  w.document.write('.header{display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #c6a34e;padding-bottom:16px;margin-bottom:24px}');
  w.document.write('.logo{font-size:24px;font-weight:800;color:#c6a34e;letter-spacing:-0.5px}');
  w.document.write('.subtitle{font-size:9pt;color:#888}');
  w.document.write('h1{font-size:16pt;color:#1a1a1a;margin-bottom:8px}');
  w.document.write('h2{font-size:12pt;color:#c6a34e;margin:16px 0 8px;border-bottom:1px solid #eee;padding-bottom:4px}');
  w.document.write('table{width:100%;border-collapse:collapse;margin:12px 0}');
  w.document.write('th{background:#f8f6f0;color:#c6a34e;font-size:9pt;padding:8px;text-align:left;border-bottom:2px solid #c6a34e}');
  w.document.write('td{padding:6px 8px;border-bottom:1px solid #eee;font-size:10pt}');
  w.document.write('.footer{margin-top:32px;padding-top:12px;border-top:2px solid #c6a34e;font-size:8pt;color:#888;text-align:center}');
  w.document.write('.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:8pt;font-weight:600}');
  w.document.write('.badge-ok{background:#e8f5e9;color:#2e7d32}');
  w.document.write('.badge-warn{background:#fff3e0;color:#e65100}');
  w.document.write('.badge-err{background:#fce4ec;color:#c62828}');
  w.document.write('@media print{body{padding:20px}@page{margin:15mm}}');
  w.document.write('</style></head><body>');
  w.document.write('<div class="header">');
  w.document.write('<div><div class="logo">AUREUS SOCIAL PRO</div>');
  w.document.write('<div class="subtitle">Aureus IA SPRL — BE 1028.230.781</div></div>');
  w.document.write('<div style="text-align:right"><div style="font-size:10pt;font-weight:600">'+escapeHtml(title)+'</div>');
  w.document.write('<div class="subtitle">'+new Date().toLocaleDateString('fr-BE')+'</div></div>');
  w.document.write('</div>');
  w.document.write(content);
  w.document.write('<div class="footer">');
  w.document.write('Document genere par Aureus Social Pro — www.aureussocial.be<br/>');
  w.document.write('Aureus IA SPRL — BCE BE 1028.230.781 — Saint-Gilles, Bruxelles');
  w.document.write('</div></body></html>');
  w.document.close();
  setTimeout(()=>{w.print();},500);
}


// ══════════════════════════════════════════════════════════════════════
const _H_HEBDO = LOIS_BELGES.tempsTravail.dureeHebdoLegale; // 38
const _FERIES = LOIS_BELGES.tempsTravail.jourFerie.nombre; // 10
const _SEUIL_CPPT = LOIS_BELGES.seuils.electionsSociales.cppt; // 50
const _SEUIL_CE = LOIS_BELGES.seuils.electionsSociales.ce; // 100


// ── Sprint 29: Formule Précompte Professionnel Exacte SPF Finances ──
// Barème 2026, Art. 275-289 CIR 92 — Formule-clé Annexe III
function calcPrecompteExact(brutMensuel, options) {
  const opts = options || {};
  const situation = opts.situation || 'isole';
  const enfants = +(opts.enfants || 0);
  const enfantsHandicapes = +(opts.enfantsHandicapes || 0);
  const handicape = !!opts.handicape;
  const conjointHandicape = !!opts.conjointHandicape;
  const conjointRevenus = !!opts.conjointRevenus;
  const conjointRevenuLimite = !!opts.conjointRevenuLimite;
  const conjointPensionLimitee = !!opts.conjointPensionLimitee;
  const parentIsole = !!opts.parentIsole;
  const personnes65 = +(opts.personnes65 || 0);
  const autresCharges = +(opts.autresCharges || 0);
  const dirigeant = !!opts.dirigeant;
  const taxeCom = +(opts.taxeCom || 7) / 100;
  const regime = +(opts.regime || 100) / 100;
  const isBareme2 = situation === 'marie_1r' || (situation === 'cohabitant' && !conjointRevenus);

  const brut = brutMensuel * regime;
  if (brut <= 0) return { pp: 0, rate: 0, forfait: 0, reduction: 0, bonusEmploi: 0, detail: {} };

  // 1. ONSS travailleur 13.07%
  const onss = Math.round(brut * TX_ONSS_W * 100) / 100;
  const imposable = brut - onss;

  // 2. Annualisation
  const annuel = imposable * 12;

  // 3. Frais professionnels forfaitaires 2026
  let forfaitAn = 0;
  if (dirigeant) {
    forfaitAn = Math.min(annuel * LOIS_BELGES.pp.fraisPro.dirigeant.pct, LOIS_BELGES.pp.fraisPro.dirigeant.max);
  } else {
    forfaitAn = Math.min(annuel * LOIS_BELGES.pp.fraisPro.salarie.pct, LOIS_BELGES.pp.fraisPro.salarie.max);
  }

  // 4. Revenu net imposable annuel
  const baseAnnuelle = Math.max(0, annuel - forfaitAn);

  // 5. Quotient conjugal (barème 2 uniquement)
  let qcAttribue = 0;
  let baseApresQC = baseAnnuelle;
  if (isBareme2) {
    qcAttribue = Math.min(baseAnnuelle * LOIS_BELGES.pp.quotientConjugal.pct, LOIS_BELGES.pp.quotientConjugal.max);
    baseApresQC = baseAnnuelle - qcAttribue;
  }

  // 6. Impôt progressif — Tranches PP SPF 2026 (Formule-clé Annexe III)
  const calcImpotProgressif = (base) => {
    if (base <= 0) return 0;
    const T=LOIS_BELGES.pp.tranches;let imp=0,prev=0;for(const t of T){const s=Math.min(base,t.max)-Math.max(prev,t.min);if(s>0)imp+=s*t.taux;prev=t.max;}return imp;
  };
  let impot = calcImpotProgressif(baseApresQC);

  // Impôt sur quotient conjugal (même barème progressif)
  if (isBareme2 && qcAttribue > 0) {
    impot += calcImpotProgressif(qcAttribue);
  }

  // 7. Réduction quotité exemptée
  const qeBase = isBareme2 ? LOIS_BELGES.pp.quotiteExemptee.bareme2 : LOIS_BELGES.pp.quotiteExemptee.bareme1;
  const redQE = qeBase;

  // 8. Réduction enfants à charge (montants annuels 2026)
  const tabEnfants = LOIS_BELGES.pp.reductionsEnfants;
  const suppEnfant = LOIS_BELGES.pp.reductionEnfantSupp;
  const enfTotal = enfants + enfantsHandicapes; // handicapés comptent double fiscalement
  const enfFiscaux = enfTotal + enfantsHandicapes; // double comptage
  let redEnfants = 0;
  if (enfFiscaux > 0) {
    if (enfFiscaux <= 8) redEnfants = tabEnfants[enfFiscaux];
    else redEnfants = tabEnfants[8] + (enfFiscaux - 8) * suppEnfant;
  }

  // 9. Réduction parent isolé avec enfants
  let redParentIsole = 0;
  if (parentIsole && enfTotal > 0) redParentIsole = LOIS_BELGES.pp.reductionParentIsole;

  // 10. Réduction bénéficiaire handicapé
  let redHandicape = 0;
  if (handicape) redHandicape = LOIS_BELGES.pp.reductionHandicape;

  // 11. Réduction conjoint handicapé (barème 2)
  let redConjHandicape = 0;
  if (isBareme2 && conjointHandicape) redConjHandicape = LOIS_BELGES.pp.reductionConjointHandicape;

  // 12. Réduction conjoint revenu limité
  let redConjRevLimite = 0;
  if (conjointRevenuLimite) redConjRevLimite = LOIS_BELGES.pp.reductionConjointRevenuLimite;

  // 13. Réduction conjoint pension limitée
  let redConjPension = 0;
  if (conjointPensionLimitee) redConjPension = LOIS_BELGES.pp.reductionConjointPensionLimitee;

  // 14. Réduction personnes 65+ à charge
  let redP65 = personnes65 * LOIS_BELGES.pp.reductionPersonne65;

  // 15. Réduction autres personnes à charge
  let redAutres = autresCharges * LOIS_BELGES.pp.reductionAutreCharge;

  // Total réductions annuelles
  const totalReductions = redQE + redEnfants + redParentIsole + redHandicape + redConjHandicape + redConjRevLimite + redConjPension + redP65 + redAutres;

  // 6b. Impôt annuel après réductions
  const impotApresReduc = Math.max(0, impot - totalReductions);

  // 16. Taxe communale
  const impotAvecTaxeCom = Math.round(impotApresReduc * (1 + taxeCom) * 100) / 100;

  // Bonus emploi fiscal (33.14% réduction sur bonus social ONSS)
  const bonusEmploi = 0; // calculé séparément si nécessaire

  // PP mensuel
  const ppMensuel = Math.round(impotAvecTaxeCom / 12 * 100) / 100;

  // Taux effectif
  const taux = brut > 0 ? Math.round(ppMensuel / brut * 10000) / 100 : 0;

  return {
    pp: ppMensuel,
    rate: taux,
    forfait: Math.round(forfaitAn / 12 * 100) / 100,
    reduction: Math.round(totalReductions / 12 * 100) / 100,
    bonusEmploi,
    detail: {
      brut, onss, imposable, annuel, forfaitAn,
      baseAnnuelle, qcAttribue, baseApresQC,
      impotBrut: Math.round(impot * 100) / 100,
      redQE, redEnfants, redParentIsole, redHandicape,
      redConjHandicape, redConjRevLimite, redConjPension, redP65, redAutres,
      totalReductions: Math.round(totalReductions * 100) / 100,
      impotApresReduc: Math.round(impotApresReduc * 100) / 100,
      impotAvecTaxeCom,
      ppMensuel, taux,
      situation, enfants, enfantsHandicapes, dirigeant, isBareme2
    }
  };
}
// Helper rapide: PP pour un brut donné (defaults isolé, 0 enfant)
function quickPP(brut,sit,enf){return calcPrecompteExact(brut,{situation:sit||'isole',enfants:enf||0}).pp;}
function quickNet(brut,sit,enf){const o=Math.round(brut*TX_ONSS_W*100)/100;return Math.round((brut-o-quickPP(brut,sit,enf))*100)/100;}

// CSSS — Cotisation Spéciale Sécurité Sociale (AR 29/03/2012)
function calcCSSS(brutMensuel, situation) {
  const brut = brutMensuel;
  const onss = Math.round(brut * TX_ONSS_W * 100) / 100;
  const imposable = brut - onss;
  const annuel = imposable * 12;
  const isole = !situation || situation === 'isole';
  const baremes = isole ? LOIS_BELGES.csss.isole : LOIS_BELGES.csss.menage2revenus;
  // Seuils CSSS dynamiques depuis LOIS_BELGES
  const s0=baremes[0].max, s1=baremes[1].max, s2=baremes[2]?.max||60181.95;
  const t1=baremes[1].taux, t2=baremes[2]?.taux||0.011;
  const base2=baremes[2]?.montant||9.30;
  const plafond=baremes[baremes.length-1].montantFixe||51.64;
  if (annuel <= s0) return 0;
  if (annuel <= s1) return Math.round((annuel - s0) * t1 / 12 * 100) / 100;
  if (isole && baremes.length > 4) {
    const s3=baremes[3]?.min||37344.02, t3=baremes[3]?.taux||0.013;
    if (annuel <= s3) return Math.round((base2 + (annuel - s1) * t2) / 12 * 100) / 100;
    if (annuel <= baremes[4]?.min||60181.95) return Math.round((base2 + (s3 - s1) * t2 + (annuel - s3) * t3) / 12 * 100) / 100;
  } else {
    if (annuel <= s2) return Math.round((base2 + (annuel - s1) * t2) / 12 * 100) / 100;
  }
  return Math.round(plafond / 12 * 100) / 100;
}

// Bonus emploi (Art. 289ter CIR) — Réduction fiscale
function calcBonusEmploi(brutMensuel) {
  if (brutMensuel <= 0) return 0;
  const onss = Math.round(brutMensuel * TX_ONSS_W * 100) / 100;
  const refSalaire = brutMensuel;
  const BE = LOIS_BELGES.pp.bonusEmploi;
  const seuil1 = BE.seuilBrut1;
  const seuil2 = BE.seuilBrut2;
  const maxBonus = BE.maxMensuel;
  
  if (refSalaire <= seuil1) return maxBonus;
  if (refSalaire <= seuil2) {
    return Math.round(maxBonus * (1 - (refSalaire - seuil1) / (seuil2 - seuil1)) * 100) / 100;
  }
  return 0;
}

// ── Sprint 29: Real Email Sending via /api/send-email ──
async function sendEmailReal(to, subject, htmlBody, attachments) {
  if (!to) return { success: false, error: 'Pas d adresse email' };
  try {
    const payload = { to, subject, html: htmlBody };
    if (attachments && attachments.length > 0) {
      payload.attachments = attachments.map(att => ({
        filename: att.filename || 'document.html',
        content: typeof btoa === 'function' ? btoa(unescape(encodeURIComponent(att.content || ''))) : '',
        contentType: att.contentType || 'text/html',
      }));
    }
    const res = await fetch('/api/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    // Sprint 29: Log email to Supabase
    try {
      if (_supabaseRef && _userIdRef) {
        _supabaseRef.from('email_log').insert({
          user_id: _userIdRef, to_email: to, subject, status: data.success ? 'sent' : 'failed',
          resend_id: data.id || null, error: data.error || null,
          metadata: { mode: data.mode, attachments_count: (attachments||[]).length },
        }).then(() => {}).catch(() => {});
      }
    } catch (logErr) {}
    return { success: data.success || false, mode: data.mode || 'unknown', id: data.id, error: data.error };
  } catch (e) {
    console.warn('Email send failed:', e);
    return { success: false, error: e.message };
  }
}

// ═══ Sprint 29: Payroll History Persistence ═══
async function savePayrollRun(clientId, month, year, fiches, summary) {
  if (!_supabaseRef || !_userIdRef) {
    try { safeLS.set('payroll_' + clientId + '_' + year + '_' + month, JSON.stringify({ fiches, summary, run_date: new Date().toISOString() })); } catch(e) { console.warn('[savePayrollRun] localStorage plein:', e.message); }
    return true;
  }
  try {
    const { error } = await _supabaseRef.from('payroll_history').upsert({
      user_id: _userIdRef, client_id: clientId, period_month: month, period_year: year,
      run_date: new Date().toISOString(), status: 'completed', summary: summary || {}, fiches: fiches || [],
    }, { onConflict: 'user_id,client_id,period_month,period_year' });
    return !error;
  } catch(e) { return false; }
}

async function loadPayrollHistory(clientId, limit) {
  const lim = limit || 12;
  if (!_supabaseRef || !_userIdRef) {
    const results = [];
    try {
      for (let i = 0; i < 24; i++) {
        const dt = new Date(); dt.setMonth(dt.getMonth() - i);
        const key = 'payroll_' + clientId + '_' + dt.getFullYear() + '_' + (dt.getMonth()+1);
        let val=safeLS.get(key);
        if (val) results.push({ ...(()=>{try{return JSON.parse(val)}catch(e){return null}})(), period_month: dt.getMonth()+1, period_year: dt.getFullYear() });
        if (results.length >= lim) break;
      }
    } catch(e) { console.warn('[loadPayrollHistory] localStorage:', e.message); }
    return results;
  }
  try {
    const q = _supabaseRef.from('payroll_history').select('*').eq('user_id', _userIdRef).order('period_year', { ascending: false }).order('period_month', { ascending: false }).limit(lim);
    if (clientId) q.eq('client_id', clientId);
    const { data } = await q;
    return data || [];
  } catch(e) { console.warn('[loadPayrollHistory] Supabase:', e.message); return []; }
}

async function logDocument(clientId, empId, docType, title, meta) {
  if (!_supabaseRef || !_userIdRef) return;
  try {
    _supabaseRef.from('documents').insert({
      user_id: _userIdRef, client_id: clientId, employee_id: empId, doc_type: docType, title,
      period_month: new Date().getMonth() + 1, period_year: new Date().getFullYear(), metadata: meta || {},
    }).then(() => {}).catch((err) => { console.warn('[logDocument] insert:', err.message); });
  } catch(e) { console.warn('[logDocument] Echec:', e.message); }
}

function reducer(s,a){
  let ns;
  switch(a.type){
    case'SET_COMPANY':return{...s,co:{...s.co,...a.data}};
    case'SET_EMPS':return{...s,emps:a.data};
    case'ADD_EMPS_BATCH':return{...s,emps:[...s.emps,...(a.data||[])]};
    case'SET_PAYS':return{...s,pays:a.data};
    case'SET_CLIENTS':return{...s,clients:a.data||[]};
    case'NAV':if(a.page==='sprint10'){window.location.href='/sprint10/auth';return s;}const s9map={s9_dimona:'/sprint9/dimona',s9_precompte:'/sprint9/precompte',s9_onss:'/sprint9/onss',s9_bilan:'/sprint9/bilan-social',s9_netbrut:'/sprint9/net-brut',s9_od:'/sprint9/od-comptables',s9_cheques:'/sprint9/cheques-repas',s9_trilingue:'/sprint9/trilingue',s9_vacances:'/sprint9/vacances',s9_enfants:'/sprint9/enfants',s9_attestations:'/sprint9/attestations',s9_exports:'/sprint9/exports',s9_baremes:'/sprint9/baremes',s9_provisions:'/sprint9/provisions',s9_heures:'/sprint9/heures-sup',s9_primes:'/sprint9/primes',s9_saisies:'/sprint9/saisies'};ns={...s,page:a.page,sub:a.sub||null};break;
    case'ADD_E':ns={...s,emps:[...s.emps,{...a.d,id:"E-"+uid()}]};break;
    case'UPD_E':ns={...s,emps:(s.emps||[]).map(e=>e.id===a.d.id?a.d:e)};break;
    case'DEL_E':ns={...s,emps:(s.emps||[]).filter(e=>e.id!==a.id)};break;
    case'ADD_P':ns={...s,pays:[...s.pays,{...a.d,id:"P-"+uid()}]};break;
    case'ADD_DIM':ns={...s,dims:[...s.dims,{...a.d,id:"D-"+uid()}]};break;
    case'ADD_DMFA':ns={...s,dmfas:[...s.dmfas,{...a.d,id:"M-"+uid()}]};break;
    case'ADD_F':ns={...s,fiches:[...s.fiches,{...a.d,id:"F-"+uid()}]};break;
    case'ADD_DOC':ns={...s,docs:[...s.docs,{...a.d,id:"DC-"+uid()}]};break;
    case'UPD_CO':ns={...s,co:{...s.co,...a.d}};break;
    case'MODAL':ns={...s,modal:a.m};break;
    // Multi-sociétés
    case'ADD_CLIENT':ns={...s,clients:[...s.clients,{...a.d,id:"CL-"+uid(),createdAt:new Date().toISOString(),assignedTo:a.assignedTo||null}]};break;
    case'UPD_CLIENT':ns={...s,clients:(s.clients||[]).map(c=>c.id===a.d.id?{...c,...a.d}:c)};break;
    case'DEL_CLIENT':if(a.role==='readonly'){ns=s;break;}ns={...s,clients:s.clients.filter(c=>c.id!==a.id)};break;
    case'SELECT_CLIENT':{
      const cl=s.clients.find(c=>c.id===a.id);
      ns={...s,activeClient:a.id,co:cl?.company||COMPANY,emps:cl?.emps||[],pays:cl?.pays||[],dims:cl?.dims||[],dmfas:cl?.dmfas||[],fiches:cl?.fiches||[],docs:cl?.docs||[],page:'dashboard',sub:null};
      break;}
    case'SAVE_CLIENT_DATA':{
      const updated=(s.clients||[]).map(c=>c.id===s.activeClient?{...c,company:s.co,emps:s.emps,pays:s.pays,dims:s.dims,dmfas:s.dmfas,fiches:s.fiches,docs:s.docs,updatedAt:new Date().toISOString()}:c);
      ns={...s,clients:updated};
      // Audit trail
      (async()=>{try{const{supabase}=await import('./lib/supabase');if(supabase)await supabase.from('audit_log').insert({action:'save_client_data',table_name:'clients',details:{client_id:s.activeClient}});}catch(e){}})();
      break;}
    case'BACK_TO_CLIENTS':ns={...s,activeClient:null,page:'clients',sub:null};break;
    case'LOAD_ALL':ns={...s,...a.d};break;
    default:ns=s;
  }
  // Auto-save on every action (except NAV/MODAL)
  if(a.type!=='NAV'&&a.type!=='MODAL'&&a.type!=='LOAD_ALL'){
    // Save only the active client data + lightweight client list (not all data)
    const toSave={clients:(ns.clients||[]).map(c=>c.id===ns.activeClient?{...c,company:ns.co,emps:ns.emps,pays:ns.pays,dims:ns.dims,dmfas:ns.dmfas,fiches:ns.fiches,docs:ns.docs,updatedAt:new Date().toISOString()}:c),pin:ns.pin};
    saveData(toSave);
  }
  return ns;
}


// ── Sprint 19: Role-Based Access Control ──
const PERMISSIONS = {
  admin: { 
    label: 'Administrateur', icon: '👑', color: '#c6a34e',
    canView: true, canEdit: true, canDelete: true, canExport: true, 
    canManageUsers: true, canSettings: true, canBackup: true, canBatch: true
  },
  gestionnaire: { 
    label: 'Gestionnaire', icon: '📋', color: '#3b82f6',
    canView: true, canEdit: true, canDelete: false, canExport: true, 
    canManageUsers: false, canSettings: false, canBackup: false, canBatch: true
  },
  comptable: { 
    label: 'Comptable', icon: '🧮', color: '#a855f7',
    canView: true, canEdit: true, canDelete: false, canExport: true, 
    canManageUsers: false, canSettings: false, canBackup: false, canBatch: false
  },
  commercial: { 
    label: 'Commercial(e)', icon: '📈', color: '#f97316',
    canView: true, canEdit: false, canDelete: false, canExport: false, 
    canManageUsers: false, canSettings: false, canBackup: false, canBatch: false,
    isCommercial: true
  },
  readonly: { 
    label: 'Lecture seule', icon: '👁', color: '#888',
    canView: true, canEdit: false, canDelete: false, canExport: false, 
    canManageUsers: false, canSettings: false, canBackup: false, canBatch: false
  },
  client: { 
    label: 'Client Employeur', icon: '🏢', color: '#22c55e',
    canView: true, canEdit: false, canDelete: false, canExport: true, 
    canManageUsers: false, canSettings: false, canBackup: false, canBatch: false,
    isClient: true
  }
};

async function loadUserRole(supabase, userId) {
  if (!supabase || !userId) return 'admin';
  try {
    const { data, error } = await supabase.from('user_roles')
      .select('role').eq('user_id', userId).maybeSingle();
    if (error) return 'admin';
    if (data?.role) return data.role;
    // No role by user_id — check for pending invite by email
    let role = 'admin';
    try {
      const { data: { user: authUser } } = await supabase.auth.getUser();
      if (authUser?.email) {
        const { data: invite } = await supabase.from('user_roles')
          .select('role,user_id').eq('email', authUser.email).maybeSingle();
        if (invite?.role) {
          role = invite.role;
          // Convert pending invite to real user_id
          if (invite.user_id?.startsWith('pending_')) {
            await supabase.from('user_roles').delete().eq('user_id', invite.user_id);
          }
        } else {
          // No invite either — new signup = client, old account = admin
          const created = new Date(authUser.created_at);
          role = (Date.now() - created < 86400000) ? 'client' : 'admin'; // < 24h = client
        }
      }
    } catch(e3) {}
    // Save real role with real user_id
    try { await supabase.from('user_roles').upsert({ user_id: userId, role, email: (await supabase.auth.getUser()).data?.user?.email || '', updated_at: new Date().toISOString() }, { onConflict: 'user_id' }); } catch(e2) {}
    return role;
  } catch(e) { return 'admin'; }
}

async function saveUserRole(supabase, userId, role, email) {
  if (!supabase) return false;
  try {
    const { error } = await supabase.from('user_roles').upsert({
      user_id: userId, role: role, email: email || '',
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id' });
    return !error;
  } catch(e) { return false; }
}

async function getTeamMembers(supabase) {
  if (!supabase) return [];
  try {
    const { data } = await supabase.from('user_roles')
      .select('*').order('updated_at', { ascending: false });
    return data || [];
  } catch(e) { return []; }
}

async function removeTeamMember(supabase, userId) {
  if (!supabase) return false;
  try {
    const { error } = await supabase.from('user_roles').delete().eq('user_id', userId);
    return !error;
  } catch(e) { return false; }
}

// Permission check helper
function can(userRole, permission) {
  const perms = PERMISSIONS[userRole] || PERMISSIONS.readonly;
  return perms[permission] || false;
}

// Team management component
function TeamManagement({ supabase, user, userRole }) {
  const [members, setMembers] = useState([]);
  const [inviteEmail, setInviteEmail] = useState('');
  const [inviteRole, setInviteRole] = useState('gestionnaire');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (supabase) {
      getTeamMembers(supabase).then(m => { setMembers(m); setLoading(false); });
    }
  }, [supabase]);

  const handleInvite = async () => {
    if (!inviteEmail || !inviteEmail.includes('@')) { alert('Email invalide'); return; }
    try {
      // First check if user already exists in user_roles by email
      const { data: existing } = await supabase.from('user_roles')
        .select('user_id,role').eq('email', inviteEmail).maybeSingle();
      if (existing && !existing.user_id?.startsWith('pending_')) {
        // User exists — update their role directly
        await supabase.from('user_roles').update({ role: inviteRole, updated_at: new Date().toISOString() }).eq('user_id', existing.user_id);
        alert('✅ Rôle de ' + inviteEmail + ' changé en ' + PERMISSIONS[inviteRole].label);
      } else {
        // Clean old pending invites for same email
        if (existing) await supabase.from('user_roles').delete().eq('user_id', existing.user_id);
        // Create pending invite
        await supabase.from('user_roles').insert({
          user_id: 'pending_' + Date.now(),
          role: inviteRole,
          email: inviteEmail,
          status: 'invited',
          invited_by: user?.id,
          updated_at: new Date().toISOString()
        });
        alert('✅ Invitation créée pour ' + inviteEmail + ' en tant que ' + PERMISSIONS[inviteRole].label + '\nLe client doit créer son compte sur aureussocial.be');
      }
      setInviteEmail('');
      getTeamMembers(supabase).then(setMembers);
    } catch(e) { alert('Erreur: ' + e.message); }
  };

  const changeRole = async (memberId, newRole) => {
    const ok = await saveUserRole(supabase, memberId, newRole);
    if (ok) getTeamMembers(supabase).then(setMembers);
  };

  const removeMember = async (memberId) => {
    if (!confirm('Supprimer cet utilisateur de l\'équipe ?')) return;
    const ok = await removeTeamMember(supabase, memberId);
    if (ok) getTeamMembers(supabase).then(setMembers);
  };

  return <div>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:20,fontWeight:700,color:'#c6a34e',margin:0}}>👥 Gestion de l'Équipe</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Gérez les accès et les rôles de vos collaborateurs</p>
      </div>
      <div style={{padding:'8px 16px',borderRadius:10,background:'rgba(198,163,78,.1)',border:'1px solid rgba(198,163,78,.2)'}}>
        <div style={{fontSize:10,color:'#888'}}>Votre rôle</div>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e'}}>{PERMISSIONS[userRole]?.icon} {PERMISSIONS[userRole]?.label}</div>
      </div>
    </div>

    {/* Invite */}
    {can(userRole, 'canManageUsers') && <div style={{marginBottom:20,padding:18,background:'linear-gradient(135deg,rgba(34,197,94,.06),rgba(34,197,94,.02))',border:'1px solid rgba(34,197,94,.15)',borderRadius:14}}>
      <div style={{fontSize:14,fontWeight:600,color:'#22c55e',marginBottom:12}}>📨 Inviter un Collaborateur</div>
      <div style={{display:'flex',gap:8,alignItems:'flex-end',flexWrap:'wrap'}}>
        <div style={{flex:1,minWidth:200}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Email</label>
          <input type="email" value={inviteEmail} onChange={e=>setInviteEmail(e.target.value)} placeholder="collaborateur@example.com"
            style={{width:'100%',padding:'10px 14px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:13,fontFamily:'inherit',outline:'none',boxSizing:'border-box'}}/>
        </div>
        <div style={{minWidth:160}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Rôle</label>
          <select value={inviteRole} onChange={e=>setInviteRole(e.target.value)}
            style={{width:'100%',padding:'10px 14px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:13,fontFamily:'inherit',cursor:'pointer',outline:'none'}}>
            <option value="gestionnaire">📋 Gestionnaire</option>
            <option value="comptable">🧮 Comptable</option>
            <option value="readonly">👁 Lecture seule</option>
                  <option value="client">🏢 Client Employeur</option>
          </select>
        </div>
        <button onClick={handleInvite} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'#22c55e',color:'#fff',fontWeight:600,fontSize:12,cursor:'pointer',whiteSpace:'nowrap'}}>📨 Inviter</button>
      </div>
    </div>}

    {/* Roles Overview */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:20}}>
      {Object.entries(PERMISSIONS).map(([key, p]) => <div key={key} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+p.color+'25',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:22,marginBottom:4}}>{p.icon}</div>
        <div style={{fontSize:12,fontWeight:600,color:p.color}}>{p.label}</div>
        <div style={{marginTop:8,fontSize:9,color:'#888',lineHeight:1.6}}>
          {p.canEdit?'✅':'❌'} Modifier<br/>
          {p.canDelete?'✅':'❌'} Supprimer<br/>
          {p.canExport?'✅':'❌'} Exporter<br/>
          {p.canSettings?'✅':'❌'} Paramètres<br/>
          {p.canManageUsers?'✅':'❌'} Gérer équipe
        </div>
      </div>)}
    </div>

    {/* Members list */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:12,overflow:'hidden'}}>
      <div style={{padding:'12px 16px',background:'rgba(198,163,78,.06)',display:'grid',gridTemplateColumns:'1fr 160px 120px 80px',fontSize:10,fontWeight:600,color:'#c6a34e'}}>
        <div>Utilisateur</div><div>Rôle</div><div>Statut</div><div>Actions</div>
      </div>
      {loading ? <div style={{padding:20,textAlign:'center',color:'#888',fontSize:12}}>Chargement...</div> :
       members.length === 0 ? <div style={{padding:20,textAlign:'center',color:'#888',fontSize:12}}>Aucun membre. Invitez votre premier collaborateur !</div> :
       members.map((m, i) => <div key={i} style={{padding:'12px 16px',display:'grid',gridTemplateColumns:'1fr 160px 120px 80px',alignItems:'center',borderTop:'1px solid rgba(255,255,255,.03)',fontSize:12}}>
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:32,height:32,borderRadius:'50%',background:'linear-gradient(135deg,'+( PERMISSIONS[m.role]?.color||'#888')+','+( PERMISSIONS[m.role]?.color||'#888')+'aa)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:700,color:'#fff'}}>{(m.email||'?')[0].toUpperCase()}</div>
          <div>
            <div style={{color:'#e5e5e5',fontWeight:500}}>{m.email || m.user_id}</div>
            <div style={{fontSize:9,color:'#666'}}>{m.user_id === user?.id ? 'Vous' : ''}</div>
          </div>
        </div>
        <div>
          {can(userRole, 'canManageUsers') && m.user_id !== user?.id ?
            <select value={m.role} onChange={e=>changeRole(m.user_id, e.target.value)}
              style={{padding:'4px 8px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:6,color:PERMISSIONS[m.role]?.color||'#888',fontSize:11,fontFamily:'inherit',cursor:'pointer',outline:'none'}}>
              {Object.entries(PERMISSIONS).map(([k,p])=><option key={k} value={k}>{p.icon} {p.label}</option>)}
            </select> :
            <span style={{color:PERMISSIONS[m.role]?.color||'#888'}}>{PERMISSIONS[m.role]?.icon} {PERMISSIONS[m.role]?.label}</span>
          }
        </div>
        <div>
          <span style={{fontSize:10,padding:'3px 10px',borderRadius:10,background:m.status==='invited'?'rgba(234,179,8,.12)':'rgba(34,197,94,.12)',color:m.status==='invited'?'#eab308':'#22c55e'}}>{m.status==='invited'?'Invité':'Actif'}</span>
        </div>
        <div>
          {can(userRole, 'canManageUsers') && m.user_id !== user?.id &&
            <button onClick={()=>removeMember(m.user_id)} style={{padding:'4px 8px',borderRadius:6,border:'none',background:'rgba(239,68,68,.1)',color:'#ef4444',fontSize:10,cursor:'pointer'}}>✕</button>
          }
        </div>
      </div>)}
    </div>
  </div>;
}

// Permission Gate - wraps actions that require specific permissions
const PermGate=({userRole,need,children,fallback})=>{
  if(can(userRole||'admin',need))return children;
  return fallback||<span style={{opacity:.4,cursor:'not-allowed',pointerEvents:'none'}}>{children}</span>;
};

// ─── SHARED COMPONENTS ───────────────────────────────────────
const C=({children,style,...p})=><div style={{background:"linear-gradient(145deg,#0e1220,#131829)",border:'1px solid rgba(139,115,60,.12)',borderRadius:14,padding:24,...style}} {...p}>{children}</div>;
const B=({children,v='gold',onClick,style,...p})=>{
  const vs={gold:{background:"linear-gradient(135deg,#c6a34e,#a68a3c)",color:'#060810',fontWeight:600,border:'none'},outline:{background:"transparent",border:'1px solid rgba(139,115,60,.25)',color:'#c6a34e'},ghost:{background:"rgba(198,163,78,.06)",color:'#c6a34e',border:'1px solid rgba(198,163,78,.1)'},danger:{background:"rgba(248,113,113,.1)",color:'#f87171',border:'1px solid rgba(248,113,113,.2)'}};
  return <button onClick={onClick} style={{padding:'10px 20px',borderRadius:8,cursor:'pointer',fontSize:13,fontFamily:'inherit',transition:'all .15s',...(vs[v]||vs.gold),...style}} {...p}>{children}</button>;
};
const I=({label,value,onChange,type='text',options,span,style,...p})=>(
  <div style={{gridColumn:span?`span ${span}`:undefined,...style}}>
    {label&&<label style={{fontSize:10.5,fontWeight:600,color:'#9e9b93',display:'block',marginBottom:5,textTransform:'uppercase',letterSpacing:'.7px'}}>{label}</label>}
    {options?<select value={value||''} onChange={e=>onChange(e.target.value)} style={{width:'100%',padding:'9px 12px',background:"#090c16",border:'1px solid rgba(139,115,60,.15)',borderRadius:7,color:'#d4d0c8',fontSize:13,fontFamily:'inherit',cursor:'pointer',outline:'none',boxSizing:'border-box'}}>{options.map(o=><option key={o.v} value={o.v} style={{background:"#0c0f1a"}}>{o.l}</option>)}</select>
    :<input type={type} value={value||''} onChange={e=>onChange(type==='number'?(parseFloat(e.target.value)||0):e.target.value)} style={{width:'100%',padding:'9px 12px',background:"#090c16",border:'1px solid rgba(139,115,60,.15)',borderRadius:7,color:'#d4d0c8',fontSize:13,fontFamily:'inherit',outline:'none',boxSizing:'border-box'}} {...p}/>}
  </div>
);
const ST_NL={
  'Filtrer':'Filteren',"Résumé":'Overzicht',"Période":'Periode',"Rémunération brute":'Bruto verloning',
  'Cotisations ONSS':'RSZ-bijdragen',"Avantages exonérés":'Vrijgestelde voordelen',"Déductions":'Inhoudingen',
  'Net à payer':'Netto te betalen',"Coût employeur":'Werkgeverskost',"Éléments fiscaux spéciaux":'Speciale fiscale elementen',
  'Coordonnées':'Contactgegevens',"Contrat":'Contract',"Rémunération":'Verloning',"Statut":'Statuut',
  'Famille':'Gezin',"Avantages en nature":'Voordelen in natura',"Transport":'Transport',"Récapitulatif":'Overzicht',
  'Structure':'Structuur',"Informations":'Informatie',"Actions":'Acties',"Configuration":'Configuratie',
};
const ST=({children,style})=>{
  const {lang}=useLang();
  const txt=typeof children==='string'&&lang==='nl'?(ST_NL[children]||children):children;
  return <div style={{fontSize:11.5,color:'#c6a34e',fontWeight:600,marginBottom:12,marginTop:18,textTransform:'uppercase',letterSpacing:'1.5px',...(style||{})}}>{txt}</div>;
};
const SC=({label,value,color='#c6a34e',sub})=><C style={{padding:'18px 16px'}}><div style={{fontSize:10,color:'#5e5c56',marginBottom:6,textTransform:'uppercase',letterSpacing:'1px'}}>{label}</div><div style={{fontSize:22,fontWeight:700,color}}>{value}</div>{sub&&<div style={{fontSize:10,color:'#5e5c56',marginTop:3}}>{sub}</div>}</C>;
// PH auto-translates known titles FR→NL
const PH_NL={
  'Tableau de bord':'Dashboard',"Gestion des Employés":'Personeelsbeheer',"Fiches de Paie":'Loonfiches',
  'Déclarations Dimona':'Dimona-aangiften',"Déclaration DMFA":'DmfA-aangifte',"Fiches Fiscales 281.xx":'Fiscale fiches 281.xx',
  'Précompte Professionnel 274':'Bedrijfsvoorheffing 274',"Documents Sociaux":'Sociale documenten',"Rapports":'Rapporten',
  'Frais de gestion':'Beheerskosten',"Paramètres":'Instellingen',"Salaires & Calculs":'Lonen & Berekeningen',
  'Avantages & Rémunération':'Voordelen & Verloning',"Contrats & Documents":'Contracten & Documenten',
  'RH & Personnel':'HR & Personeel',"Social & Assurances":'Sociaal & Verzekeringen',"Reporting & Export":'Rapportage & Export',
  'Juridique & Veille':'Juridisch & Monitoring',"Modules Pro":'Pro Modules',
  'Comptes de Provision':'Voorzieningen',"Gestion des Cumuls":'Jaarlijkse cumulatie',
  'Saisies & Cessions sur salaire':'Beslag & overdracht op loon',
  'Rentes & Obligations fixes':'Renten & vaste verplichtingen',
  'Allocations Familiales':'Kinderbijslag',"Caisse de Vacances Annuelles":'Jaarlijkse vakantiekas',
  'PEPPOL e-Invoicing':'PEPPOL e-Facturatie',"Secteurs Spécifiques":'Specifieke sectoren',
  'Règlement de travail':'Arbeidsreglement',"Contrats de travail & conventions":'Arbeidsovereenkomsten & conventies',
  'Comptes individuels':'Individuele rekeningen',"Veille légale & Calendrier 2026":'Juridische monitoring & Kalender 2026',
  'Bien-être & Prévention':'Welzijn & Preventie',"Bilan Social BNB":'Sociaal Verslag NBB',
  'Configuration société':'Bedrijfsconfiguratie',"Alertes légales & échéances":'Juridische waarschuwingen & deadlines',
};
const PH=({title,sub,actions})=>{
  const {lang}=useLang();
  const t2=lang==='nl'?(PH_NL[title]||title):title;
  return <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:26}}><div><h1 style={{fontFamily:"'Cormorant Garamond',Georgia,serif",fontSize:26,fontWeight:600,color:'#e8e6e0',margin:0}}>{t2}</h1>{sub&&<p style={{color:'#5e5c56',marginTop:4,fontSize:13}}>{sub}</p>}</div>{actions&&<div style={{display:'flex',gap:10}}>{actions}</div>}</div>;
};

function Tbl({cols,data,onRow}){return(
 <div style={{overflowX:'auto'}}><div style={{position:"fixed",bottom:20,right:20,zIndex:9999,display:"flex",gap:6}}><button onClick={()=>window.print()} style={{padding:"10px 16px",borderRadius:10,border:"none",background:"#c6a34e",color:"#fff",fontWeight:700,fontSize:11,cursor:"pointer",boxShadow:"0 4px 15px rgba(198,163,78,.4)"}}>PDF</button><button onClick={()=>{var email=prompt("Email du client:");if(email)emailSimulation(s.page||"Simulation",email)}} style={{padding:"10px 16px",borderRadius:10,border:"none",background:"#1a1a1a",color:"#c6a34e",fontWeight:700,fontSize:11,cursor:"pointer",boxShadow:"0 4px 15px rgba(0,0,0,.3)"}}>Email</button></div>
    <table style={{width:'100%',borderCollapse:'collapse'}}>
      <thead><tr style={{borderBottom:'1px solid rgba(139,115,60,.15)'}}>
        {cols.map(c=><th key={c.k} style={{textAlign:c.a||'left',padding:'11px 14px',fontSize:10,color:'#5e5c56',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600}}>{c.l}</th>)}
      </tr></thead>
      <tbody>{data.map((row,i)=>(
        <tr key={i} onClick={()=>onRow?.(row)} style={{borderBottom:'1px solid rgba(255,255,255,.03)',cursor:onRow?'pointer':'default'}}
          onMouseEnter={e=>e.currentTarget.style.background='rgba(198,163,78,.03)'}
          onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
          {cols.map(c=><td key={c.k} style={{padding:'10px 14px',fontSize:12.5,color:c.c||'#d4d0c8',fontWeight:c.b?600:400,textAlign:c.a||'left'}}>{c.r?c.r(row):row[c.k]}</td>)}
        </tr>
      ))}</tbody>
    </table>
    {data.length===0&&<div style={{textAlign:'center',padding:36,color:'#5e5c56',fontSize:13}}>Aucune donnée</div>}
  </div>
);}

// Simple table helper (rows-based, used by ATN, ChomTemp, CongeEduc, Outplacement, PAA)
function TB({cols,rows}){return(
  <div style={{overflowX:'auto'}}>
    <table style={{width:'100%',borderCollapse:'collapse'}}>
      <thead><tr style={{borderBottom:'1px solid rgba(139,115,60,.15)'}}>
        {cols.map(c=><th key={c.k} style={{textAlign:'left',padding:'10px 14px',fontSize:10,color:'#5e5c56',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600}}>{c.l}</th>)}
      </tr></thead>
      <tbody>{(rows||[]).map((r,i)=><tr key={i} style={{borderBottom:'1px solid rgba(255,255,255,.03)'}}>
        {cols.map(c=><td key={c.k} style={{padding:'9px 14px',fontSize:12,color:'#d4d0c8'}}>{r[c.k]||'—'}</td>)}</tr>)}</tbody>
    </table>
    {(!rows||rows.length===0)&&<div style={{textAlign:'center',padding:36,color:'#5e5c56',fontSize:13}}>Aucune donnée</div>}
  </div>
);}

// ─── LOGIN PAGE ─────────────────────────────────────────────
function LoginPage({onLogin}){
  const [pin,setPin]=useState('');
  const [newPin,setNewPin]=useState('');
  const [confirm,setConfirm]=useState('');
  const [mode,setMode]=useState('check'); // check | create
  const [error,setError]=useState('');
  const [saved,setSaved]=useState(null);
  const [ready,setReady]=useState(false);

  useEffect(()=>{
    loadData().then(data=>{
      setSaved(data);
      if(!data||!data.pin)setMode('create');
      setReady(true);
    });
  },[]);

  const handleLogin=()=>{
    if(mode==='create'){
      if(newPin.length<4){setError('Minimum 4 chiffres');return;}
      if(newPin!==confirm){setError('Les codes ne correspondent pas');return;}
      onLogin(newPin);
    } else {
      if(pin===saved?.pin){onLogin(pin);}
      else{setError('Code incorrect');setPin('');}
    }
  };

  return(
    <div style={{minHeight:'100vh',background:"linear-gradient(135deg,#060810 0%,#0a0e1a 40%,#0e1225 100%)",display:'flex',alignItems:'center',justifyContent:'center',fontFamily:`'Outfit','DM Sans',system-ui,sans-serif`}}>
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Cormorant+Garamond:wght@500;600;700&display=swap" rel="stylesheet"/>
      <div style={{width:420,textAlign:'center'}}>
        {/* Logo */}
        <div style={{marginBottom:40}}>
          <div style={{width:80,height:80,margin:'0 auto 20px',borderRadius:20,background:"linear-gradient(135deg,#c6a34e,#e2c878)",display:'flex',alignItems:'center',justifyContent:'center',boxShadow:'0 8px 32px rgba(198,163,78,.3)'}}>
            <span style={{fontSize:36,fontWeight:800,color:'#060810'}}>A</span>
          </div>
          <div style={{fontFamily:"'Cormorant Garamond',Georgia,serif",fontSize:32,fontWeight:700,background:"linear-gradient(135deg,#c6a34e,#e2c878,#c6a34e)",WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>AUREUS SOCIAL PRO</div>
          <div style={{fontSize:10,color:'#8b7340',marginTop:6,letterSpacing:'4px',textTransform:'uppercase'}}>Logiciel de Gestion de la Paie</div>
        </div>

        {/* Login Card */}
        <div style={{background:"linear-gradient(145deg,#0e1220,#131829)",border:'1px solid rgba(139,115,60,.15)',borderRadius:18,padding:'36px 32px',boxShadow:'0 16px 48px rgba(0,0,0,.4)'}}>
          <div style={{fontSize:16,fontWeight:600,color:'#e8e6e0',marginBottom:20}}>{mode==='create'?"Créer votre code d'accès":'Connexion'}</div>
          
          {mode==='create'?<>
            <input type="password" placeholder="Nouveau code (min 4 chiffres)" value={newPin} onChange={e=>setNewPin(e.target.value.replace(/[^0-9]/g,""))} maxLength={8}
              style={{width:'100%',padding:'14px 16px',background:"#090c16",border:'1px solid rgba(139,115,60,.2)',borderRadius:10,color:'#e8e6e0',fontSize:20,fontFamily:'inherit',outline:'none',textAlign:'center',letterSpacing:12,boxSizing:'border-box',marginBottom:12}}/>
            <input type="password" placeholder="Confirmer le code" value={confirm} onChange={e=>setConfirm(e.target.value.replace(/[^0-9]/g,""))} maxLength={8}
              style={{width:'100%',padding:'14px 16px',background:"#090c16",border:'1px solid rgba(139,115,60,.2)',borderRadius:10,color:'#e8e6e0',fontSize:20,fontFamily:'inherit',outline:'none',textAlign:'center',letterSpacing:12,boxSizing:'border-box'}}
              onKeyDown={e=>e.key==='Enter'&&handleLogin()}/>
          </>:<>
            <input type="password" placeholder="Code d'accès" value={pin} onChange={e=>{setPin(e.target.value.replace(/[^0-9]/g,""));setError('');}} maxLength={8}
              style={{width:'100%',padding:'14px 16px',background:"#090c16",border:'1px solid rgba(139,115,60,.2)',borderRadius:10,color:'#e8e6e0',fontSize:22,fontFamily:'inherit',outline:'none',textAlign:'center',letterSpacing:14,boxSizing:'border-box'}}
              onKeyDown={e=>e.key==='Enter'&&handleLogin()} autoFocus/>
          </>}
          
          {error&&<div style={{color:'#f87171',fontSize:12,marginTop:10}}>{error}</div>}
          
          <button onClick={handleLogin} style={{width:'100%',marginTop:20,padding:'14px',background:"linear-gradient(135deg,#c6a34e,#a68a3c)",color:'#060810',fontWeight:700,fontSize:14,border:'none',borderRadius:10,cursor:'pointer',fontFamily:'inherit',letterSpacing:1}}>
            {mode==='create'?'Créer & Entrer':'Accéder'}
          </button>
        </div>

        {/* Footer */}
        <div style={{marginTop:36,color:'#5e5c56',fontSize:11,lineHeight:1.8}}>
          <div style={{fontWeight:600,color:'#8b7340'}}>{AUREUS_INFO.name}</div>
          <div>{AUREUS_INFO.addr}</div>
          <div>TVA: {AUREUS_INFO.vat}</div>
          <div>{AUREUS_INFO.email}</div>
          <div style={{marginTop:10,fontSize:9.5,color:'#3a3930'}}>© {new Date().getFullYear()} Aureus IA — Tous droits réservés</div>
        </div>
      </div>
    </div>
  );
}

// ─── CLIENT SELECTION PAGE ──────────────────────────────────

// Wizard data: activities → CP mapping + barèmes
const ACTIVITIES={
  medical:{l:"🏥 Médical / Santé",types:[
    {v:"hopital",l:"Hôpital / Clinique",cp:'330',emps:[{fn:"Médecin",bar:5609.78},{fn:"Infirmier(ère)",bar:2682.04},{fn:"Aide-soignant(e)",bar:2463.41},{fn:"Kinésithérapeute",bar:2682.04},{fn:"Secrétaire médicale",bar:2463.41},{fn:"Technicien(ne) labo",bar:2682.04},{fn:"Agent d\'entretien",bar:2254.03}]},
    {v:"cabinet",l:"Cabinet médical / Paramédical",cp:'200',emps:[{fn:"Secrétaire médicale",bar:2463.41},{fn:"Assistant(e) administratif",bar:2336.26},{fn:"Infirmier(ère)",bar:2682.04},{fn:"Comptable",bar:2728.35}]},
    {v:"pharmacie",l:"Pharmacie",cp:'313',emps:[{fn:"Pharmacien(ne) adjoint",bar:3478.22},{fn:"Préparateur(trice)",bar:2517.84},{fn:"Vendeur(se)",bar:2224.61}]},
    {v:"maison_repos",l:"Maison de repos (MR/MRS)",cp:'330',emps:[{fn:"Infirmier(ère)",bar:2682.04},{fn:"Aide-soignant(e)",bar:2463.41},{fn:"Kinésithérapeute",bar:2682.04},{fn:"Ergothérapeute",bar:2682.04},{fn:"Agent hôtelier",bar:2254.03},{fn:"Cuisinier(ère)",bar:2371.89}]},
    {v:"dentiste",l:"Cabinet dentaire",cp:'200',emps:[{fn:"Assistant(e) dentaire",bar:2336.26},{fn:"Secrétaire",bar:2242.80},{fn:"Hygiéniste dentaire",bar:2728.35}]},
  ]},
  construction:{l:"🏗️ Construction / Bâtiment",types:[
    {v:"gros_oeuvre",l:"Gros œuvre",cp:'124',emps:[{fn:"Maçon (Cat.III)",bar:3409.58},{fn:"Coffreur (Cat.III)",bar:3409.58},{fn:"Ferrailleur (Cat.II)",bar:3205.42},{fn:"Grutier (Cat.IV)",bar:3619.21},{fn:"Chef de chantier (Chef IV)",bar:3981.58},{fn:"Manœuvre (Cat.I)",bar:3006.56}]},
    {v:"electricite",l:"Électricité",cp:'149',emps:[{fn:"Électricien",bar:2916.30},{fn:"Chef d\'équipe",bar:3292.14},{fn:"Apprenti",bar:1850.40}]},
    {v:"plomberie",l:"Plomberie / Chauffage",cp:'124',emps:[{fn:"Plombier (Cat.III)",bar:3409.58},{fn:"Chauffagiste (Cat.III)",bar:3409.58},{fn:"Apprenti (Cat.I)",bar:3006.56}]},
    {v:"finition",l:"Finition / Peinture",cp:'124',emps:[{fn:"Peintre (Cat.II)",bar:3205.42},{fn:"Plafonneux (Cat.IIA)",bar:3365.39},{fn:"Carreleur (Cat.III)",bar:3409.58}]},
    {v:"bureau_etude",l:"Bureau d\'études",cp:'200',emps:[{fn:"Ingénieur",bar:3948.61},{fn:"Dessinateur",bar:2728.35},{fn:"Secrétaire",bar:2336.26}]},
  ]},
  horeca:{l:"🍽️ Horeca / Restauration",types:[
    {v:"restaurant",l:"Restaurant",cp:'302',emps:[{fn:"Chef cuisinier",bar:2629.69},{fn:"Cuisinier(ère)",bar:2519.02},{fn:"Commis de cuisine",bar:2504.53},{fn:"Serveur(se)",bar:2504.53},{fn:"Barman/Barmaid",bar:2504.53},{fn:"Plongeur(se)",bar:2504.53}]},
    {v:"hotel",l:"Hôtel",cp:'302',emps:[{fn:"Réceptionniste",bar:2519.02},{fn:"Femme/Valet de chambre",bar:2504.53},{fn:"Concierge",bar:2629.69},{fn:"Chef cuisinier",bar:2629.69}]},
    {v:"cafe",l:"Café / Bar",cp:'302',emps:[{fn:"Serveur(se)",bar:2504.53},{fn:"Barman/Barmaid",bar:2504.53}]},
    {v:"traiteur",l:"Traiteur / Catering",cp:'302',emps:[{fn:"Cuisinier(ère)",bar:2519.02},{fn:"Aide cuisine",bar:2504.53},{fn:"Livreur(se)",bar:2504.53}]},
  ]},
  garage:{l:"🔧 Garage / Automobile",types:[
    {v:"reparation",l:"Réparation / Entretien véhicules",cp:'112',emps:[{fn:"Mécanicien Cat.B",bar:2580.00},{fn:"Mécanicien spécialisé Cat.C",bar:2750.00},{fn:"Chef d\'atelier Cat.D",bar:3050.00},{fn:"Aide-mécanicien Cat.A",bar:2380.00}]},
    {v:"carrosserie",l:"Carrosserie",cp:'149.02',emps:[{fn:"Carrossier Cat.C",bar:2750.00},{fn:"Peintre auto Cat.C",bar:2750.00},{fn:"Tôlier Cat.B",bar:2580.00},{fn:"Chef d\'atelier Cat.D",bar:3050.00}]},
    {v:"vente_auto",l:"Vente de véhicules",cp:'112',emps:[{fn:"Vendeur automobile",bar:2468.07},{fn:"Réceptionnaire",bar:2468.07},{fn:"Administratif",bar:2336.26},{fn:"Préparateur véhicules Cat.A",bar:2380.00}]},
    {v:"pieces_auto",l:"Commerce de pièces auto",cp:'112',emps:[{fn:"Magasinier pièces Cat.B",bar:2580.00},{fn:"Vendeur comptoir",bar:2468.07},{fn:"Livreur",bar:2336.26}]},
    {v:"moto",l:"Motos / Cycles",cp:'112',emps:[{fn:"Mécanicien moto Cat.B",bar:2580.00},{fn:"Vendeur",bar:2468.07}]},
    {v:"pneus",l:"Centre pneus / Pneumatique",cp:'112',emps:[{fn:"Monteur pneus Cat.A",bar:2380.00},{fn:"Mécanicien Cat.B",bar:2580.00},{fn:"Réceptionnaire",bar:2468.07}]},
    {v:"controle_tech",l:"Contrôle technique",cp:'112',emps:[{fn:"Inspecteur technique Cat.C",bar:2750.00},{fn:"Administratif",bar:2336.26}]},
  ]},
  commerce:{l:"🛒 Commerce / Retail",types:[
    {v:"detail",l:"Commerce de détail",cp:'201',emps:[{fn:"Vendeur(se) Cat.2",bar:2053.89},{fn:"Caissier(ère) Cat.1",bar:1997.85},{fn:"Chef de rayon Cat.4",bar:2573.25},{fn:"Magasinier Cat.3",bar:2150.44}]},
    {v:"gros",l:"Commerce de gros",cp:'226',emps:[{fn:"Commercial",bar:2728.35},{fn:"Magasinier",bar:2336.26},{fn:"Administratif",bar:2336.26},{fn:"Chauffeur-livreur",bar:2468.07}]},
    {v:"ecommerce",l:"E-commerce",cp:'200',emps:[{fn:"Web developer",bar:2728.35},{fn:"Marketing digital",bar:2468.07},{fn:"Préparateur commandes",bar:2242.80},{fn:"Service client",bar:2242.80}]},
  ]},
  bureau:{l:"🏢 Services / Bureau",types:[
    {v:"comptable",l:"Fiduciaire / Comptabilité",cp:'200',emps:[{fn:"Comptable senior",bar:2728.35},{fn:"Comptable junior",bar:2336.26},{fn:"Aide-comptable",bar:2242.80},{fn:"Secrétaire",bar:2242.80}]},
    {v:"avocat",l:"Cabinet d\'avocats",cp:'200',emps:[{fn:"Avocat collaborateur",bar:2728.35},{fn:"Juriste",bar:2728.35},{fn:"Secrétaire juridique",bar:2336.26},{fn:"Paralegal",bar:2468.07}]},
    {v:"it",l:"IT / Digital",cp:'200',emps:[{fn:"Développeur senior",bar:2728.35},{fn:"Développeur junior",bar:2468.07},{fn:"Project manager",bar:2728.35},{fn:"UX Designer",bar:2468.07},{fn:"Sysadmin",bar:2468.07}]},
    {v:"rh",l:"Ressources Humaines / Intérim",cp:'200',emps:[{fn:"Consultant RH",bar:2728.35},{fn:"Recruteur",bar:2468.07},{fn:"Administratif",bar:2336.26}]},
    {v:"immobilier",l:"Immobilier",cp:'323',emps:[{fn:"Agent immobilier",bar:2632.95},{fn:"Gestionnaire syndic",bar:2805.17},{fn:"Secrétaire",bar:2337.59}]},
    {v:"assurance",l:"Courtage assurances",cp:'307',emps:[{fn:"Courtier",bar:3194.97},{fn:"Gestionnaire sinistres",bar:2636.80},{fn:"Administratif",bar:2317.18}]},
  ]},
  transport:{l:"🚛 Transport / Logistique",types:[
    {v:"routier",l:"Transport routier",cp:'140',emps:[{fn:"Chauffeur CE",bar:2603.02},{fn:"Chauffeur C",bar:2543.95},{fn:"Dispatcher",bar:2766.65},{fn:"Mécanicien",bar:3074.05}]},
    {v:"demenagement",l:"Déménagement",cp:'140',emps:[{fn:"Déménageur",bar:2457.71},{fn:"Chauffeur",bar:2603.02},{fn:"Chef d\'équipe",bar:2766.65}]},
    {v:"logistique",l:"Entrepôt / Logistique",cp:'226',emps:[{fn:"Magasinier",bar:2336.26},{fn:"Cariste",bar:2468.07},{fn:"Chef d\'entrepôt",bar:2993.28},{fn:"Préparateur",bar:2242.80}]},
  ]},
  nettoyage:{l:"🧹 Nettoyage / Titres-services",types:[
    {v:"entreprise",l:"Nettoyage industriel/bureau",cp:'121',emps:[{fn:"Agent d\'entretien",bar:2696.49},{fn:"Chef d\'équipe",bar:2966.13},{fn:"Responsable site",bar:3611.59}]},
    {v:"titres_services",l:"Titres-services",cp:'322.01',emps:[{fn:"Aide-ménager(ère)",bar:2131.47},{fn:"Repasseur(se)",bar:2131.47}]},
  ]},
  industrie:{l:"🏭 Industrie / Production",types:[
    {v:"alimentaire",l:"Industrie alimentaire",cp:'118',emps:[{fn:"Ouvrier production",bar:2896.49},{fn:"Technicien maintenance",bar:3077.62},{fn:"Chef d\'équipe",bar:3258.75},{fn:"Contrôleur qualité",bar:3077.62}]},
    {v:"metallurgie",l:"Métallurgie",cp:'111',emps:[{fn:"Soudeur Cat.3",bar:2793.90},{fn:"Tourneur-fraiseur Cat.4",bar:2915.51},{fn:"Monteur Cat.2",bar:2704.10},{fn:"Ingénieur (CP 209)",bar:3948.61}]},
    {v:"chimie",l:"Chimie / Pharma",cp:'116',emps:[{fn:"Opérateur de production",bar:2653.84},{fn:"Laborantin",bar:2892.12},{fn:"Technicien QC",bar:3122.70},{fn:"Ingénieur process",bar:4178.93}]},
  ]},
  asbl:{l:"🤝 ASBL / Non-marchand",types:[
    {v:"sociale",l:"Action sociale",cp:'332',emps:[{fn:"Éducateur(trice) Cat.3",bar:2666.59},{fn:"Assistant(e) social(e) Cat.4",bar:2943.54},{fn:"Coordinateur(trice) Cat.5",bar:3250.21},{fn:"Administratif Cat.1",bar:2297.43}]},
    {v:"culturelle",l:"Culture / Événementiel",cp:'329',emps:[{fn:"Animateur(trice) Bar.2",bar:2441.08},{fn:"Régisseur(se) Bar.3",bar:2634.50},{fn:"Chargé(e) de comm. Bar.3",bar:2634.50}]},
    {v:"enseignement",l:"Enseignement privé",cp:'225',emps:[{fn:"Enseignant(e)",bar:2892.12},{fn:"Secrétaire",bar:2317.78},{fn:"Éducateur(trice)",bar:2448.51}]},
  ]},
  agriculture:{l:"🌾 Agriculture / Horticulture",types:[
    {v:"culture",l:"Exploitation agricole",cp:'144',emps:[{fn:"Ouvrier agricole Cat.2",bar:2468.07},{fn:"Chef de culture",bar:2850.00},{fn:"Saisonnier",bar:2254.03}]},
    {v:"horticulture",l:"Horticulture / Pépinière",cp:'145',emps:[{fn:"Ouvrier horticole",bar:2371.89},{fn:"Chef de serre",bar:2728.35},{fn:"Fleuriste",bar:2242.80}]},
    {v:"elevage",l:"Élevage",cp:'144',emps:[{fn:"Ouvrier agricole",bar:2468.07},{fn:"Responsable exploitation",bar:2850.00}]},
    {v:"maraichage",l:"Maraîchage / Bio",cp:'145',emps:[{fn:"Maraîcher",bar:2371.89},{fn:"Préparateur commandes",bar:2242.80}]},
  ]},
  banque:{l:"🏦 Banque / Finance / Assurance",types:[
    {v:"banque",l:"Banque / Établissement de crédit",cp:'310',emps:[{fn:"Conseiller clientèle",bar:2993.28},{fn:"Analyste crédit",bar:3248.00},{fn:"Caissier(ère)",bar:2468.07},{fn:"Directeur agence",bar:4200.00},{fn:"Compliance officer",bar:3500.00}]},
    {v:"assurance_cie",l:"Compagnie d\'assurances",cp:'306',emps:[{fn:"Gestionnaire production",bar:2728.35},{fn:"Gestionnaire sinistres",bar:2850.00},{fn:"Actuaire",bar:3948.61},{fn:"Commercial",bar:2993.28}]},
    {v:"fintech",l:"Fintech / Services financiers",cp:'200',emps:[{fn:"Développeur",bar:2993.28},{fn:"Product manager",bar:3248.00},{fn:"Compliance",bar:3100.00},{fn:"Data analyst",bar:2850.00}]},
  ]},
  coiffure:{l:"💇 Coiffure / Esthétique / Beauté",types:[
    {v:"coiffure",l:"Salon de coiffure",cp:'314',emps:[{fn:"Coiffeur(se) qualifié(e)",bar:2280.00},{fn:"Coiffeur(se) débutant(e)",bar:2050.00},{fn:"Coloriste",bar:2350.00},{fn:"Réceptionniste",bar:2050.00}]},
    {v:"esthetique",l:"Institut de beauté / Spa",cp:'314',emps:[{fn:"Esthéticien(ne)",bar:2280.00},{fn:"Masseur(se)",bar:2350.00},{fn:"Réceptionniste",bar:2050.00}]},
    {v:"onglerie",l:"Onglerie / Manucure",cp:'314',emps:[{fn:"Prothésiste ongulaire",bar:2280.00},{fn:"Manucure",bar:2150.00}]},
  ]},
  securite:{l:"🛡 Gardiennage / Sécurité",types:[
    {v:"gardiennage",l:"Gardiennage / Surveillance",cp:'317',emps:[{fn:"Agent de gardiennage Cat.A",bar:2450.00},{fn:"Agent de gardiennage Cat.B",bar:2600.00},{fn:"Chef d\'équipe Cat.C",bar:2850.00},{fn:"Dispatcher",bar:2728.35}]},
    {v:"securite_even",l:"Sécurité événementielle",cp:'317',emps:[{fn:"Agent événementiel",bar:2450.00},{fn:"Chef de poste",bar:2728.35}]},
    {v:"alarmes",l:"Systèmes d\'alarme / Vidéo",cp:'149',emps:[{fn:"Technicien installateur",bar:2750.00},{fn:"Commercial",bar:2468.07}]},
  ]},
  interim:{l:"👥 Intérim / Recrutement",types:[
    {v:"interim",l:"Agence intérim",cp:'322',emps:[{fn:"Consultant intérim",bar:2728.35},{fn:"Branch manager",bar:3248.00},{fn:"Recruteur",bar:2468.07},{fn:"Administratif paie",bar:2336.26}]},
    {v:"recrutement",l:"Cabinet de recrutement / Headhunting",cp:'200',emps:[{fn:"Consultant senior",bar:3248.00},{fn:"Researcher",bar:2468.07},{fn:"Business developer",bar:2993.28}]},
    {v:"outplacement",l:"Outplacement / Coaching",cp:'200',emps:[{fn:"Coach outplacement",bar:2993.28},{fn:"Consultant carrière",bar:2728.35}]},
  ]},
  sport:{l:"⚽ Sport / Fitness / Loisirs",types:[
    {v:"fitness",l:"Salle de fitness / Sport",cp:'223',emps:[{fn:"Coach sportif",bar:2336.26},{fn:"Réceptionniste",bar:2150.00},{fn:"Personal trainer",bar:2468.07},{fn:"Agent d\'entretien",bar:2050.00}]},
    {v:"club_sport",l:"Club sportif",cp:'223',emps:[{fn:"Entraîneur",bar:2468.07},{fn:"Moniteur(trice)",bar:2242.80},{fn:"Secrétaire",bar:2150.00}]},
    {v:"loisirs",l:"Parc de loisirs / Attractions",cp:'333',emps:[{fn:"Animateur(trice)",bar:2242.80},{fn:"Caissier(ère)",bar:2050.00},{fn:"Technicien",bar:2468.07}]},
  ]},
  liberal:{l:"⚕ Professions libérales",types:[
    {v:"medecin_ind",l:"Médecin / Dentiste (indépendant)",cp:'336',emps:[{fn:"Assistant(e) médical(e)",bar:2336.26},{fn:"Secrétaire médical(e)",bar:2242.80},{fn:"Infirmier(ère)",bar:2682.04}]},
    {v:"architecte",l:"Cabinet d\'architecture",cp:'336',emps:[{fn:"Architecte employé",bar:2993.28},{fn:"Dessinateur",bar:2468.07},{fn:"Secrétaire",bar:2242.80}]},
    {v:"veterinaire",l:"Cabinet vétérinaire",cp:'336',emps:[{fn:"Assistant(e) vétérinaire",bar:2336.26},{fn:"Secrétaire",bar:2150.00}]},
    {v:"notaire",l:"Étude notariale",cp:'216',emps:[{fn:"Clerc de notaire",bar:2728.35},{fn:"Notaire employé",bar:3500.00},{fn:"Secrétaire",bar:2336.26}]},
  ]},
  alimentation:{l:"🛒 Alimentation / Boulangerie",types:[
    {v:"boulangerie",l:"Boulangerie / Pâtisserie",cp:'118.03',emps:[{fn:"Boulanger",bar:2580.00},{fn:"Pâtissier",bar:2650.00},{fn:"Vendeur(se)",bar:2150.00},{fn:"Apprenti",bar:1850.00}]},
    {v:"boucherie",l:"Boucherie / Charcuterie",cp:'119',emps:[{fn:"Boucher",bar:2580.00},{fn:"Charcutier",bar:2580.00},{fn:"Vendeur(se)",bar:2150.00}]},
    {v:"supermarche",l:"Supermarché / Épicerie",cp:'202',emps:[{fn:"Caissier(ère)",bar:2053.89},{fn:"Réassortisseur",bar:1997.85},{fn:"Chef de rayon",bar:2573.25},{fn:"Boucher (rayon)",bar:2580.00}]},
    {v:"grossiste_alim",l:"Grossiste alimentaire",cp:'119',emps:[{fn:"Préparateur",bar:2242.80},{fn:"Chauffeur livreur",bar:2468.07},{fn:"Commercial",bar:2728.35}]},
  ]},
  telecom:{l:"📡 Télécom / Média / Communication",types:[
    {v:"telecom",l:"Télécommunications",cp:'218',emps:[{fn:"Technicien réseau",bar:2728.35},{fn:"Commercial",bar:2468.07},{fn:"Ingénieur télécom",bar:3500.00},{fn:"Support helpdesk",bar:2336.26}]},
    {v:"media",l:"Média / Presse / Édition",cp:'200',emps:[{fn:"Journaliste",bar:2728.35},{fn:"Graphiste",bar:2468.07},{fn:"Community manager",bar:2336.26},{fn:"Rédacteur",bar:2468.07}]},
    {v:"publicite",l:"Agence de publicité / Communication",cp:'200',emps:[{fn:"Account manager",bar:2993.28},{fn:"Directeur artistique",bar:3248.00},{fn:"Copywriter",bar:2728.35},{fn:"Media planner",bar:2468.07}]},
  ]},
  energie:{l:"⚡ Énergie / Environnement",types:[
    {v:"electricite_prod",l:"Production / Distribution énergie",cp:'326',emps:[{fn:"Technicien réseau",bar:3100.00},{fn:"Ingénieur",bar:3948.61},{fn:"Releveur compteur",bar:2468.07}]},
    {v:"renouvelable",l:"Énergie renouvelable / Panneaux solaires",cp:'149',emps:[{fn:"Installateur PV",bar:2750.00},{fn:"Électricien",bar:2916.30},{fn:"Commercial",bar:2468.07},{fn:"Technicien maintenance",bar:2850.00}]},
    {v:"dechets",l:"Gestion des déchets / Recyclage",cp:'142.04',emps:[{fn:"Chauffeur collecte",bar:2603.02},{fn:"Opérateur tri",bar:2371.89},{fn:"Chef d\'équipe",bar:2850.00}]},
  ]},
};

// ── NACE → CP MAPPING (Banque-Carrefour des Entreprises) ──
// Table de correspondance codes NACE-BEL 2008 → Commissions Paritaires
// Source: SPF ETCS + BCE + Moniteur belge
const NACE_TO_CP={
  // Construction
  '41':{l:"Construction de bâtiments",cpOuv:"124",cpEmp:'200',nace:'41.xxx',sector:'construction'},
  '42':{l:"Génie civil",cpOuv:"124",cpEmp:'200',nace:'42.xxx',sector:'construction'},
  '43':{l:"Travaux spécialisés construction",cpOuv:"124",cpEmp:'200',nace:'43.xxx',sector:'construction'},
  '43.21':{l:"Installation électrique",cpOuv:"149.01",cpEmp:'200',nace:'43.21',sector:'construction'},
  // Commerce
  '45':{l:"Commerce véhicules automobiles",cpOuv:"112",cpEmp:'200',nace:'45.xxx',sector:'commerce'},
  '45.1':{l:"Commerce de véhicules automobiles",cpOuv:"112",cpEmp:'200',nace:'45.1xx',sector:'commerce'},
  '45.2':{l:"Entretien et réparation de véhicules",cpOuv:"112",cpEmp:'200',nace:'45.2xx',sector:'commerce'},
  '45.3':{l:"Commerce de pièces automobiles",cpOuv:"112",cpEmp:'200',nace:'45.3xx',sector:'commerce'},
  '45.4':{l:"Commerce et réparation de motos",cpOuv:"112",cpEmp:'200',nace:'45.4xx',sector:'commerce'},
  '46':{l:"Commerce de gros",cpOuv:"119",cpEmp:'226',nace:'46.xxx',sector:'commerce'},
  '47':{l:"Commerce de détail",cpOuv:"202",cpEmp:'201',nace:'47.xxx',sector:'commerce'},
  '47.11':{l:"Supermarchés / Grandes surfaces",cpOuv:"202",cpEmp:'311',nace:'47.11',sector:'commerce'},
  '47.73':{l:"Pharmacie",cpOuv:null,cpEmp:'313',nace:'47.73',sector:'medical'},
  // Horeca
  '55':{l:"Hébergement (hôtels)",cpOuv:"302",cpEmp:'302',nace:'55.xxx',sector:'horeca'},
  '56':{l:"Restauration",cpOuv:"302",cpEmp:'302',nace:'56.xxx',sector:'horeca'},
  '56.10':{l:"Restaurant / Brasserie",cpOuv:"302",cpEmp:'302',nace:'56.10',sector:'horeca'},
  '56.30':{l:"Débit de boissons (café/bar)",cpOuv:"302",cpEmp:'302',nace:'56.30',sector:'horeca'},
  // Transport
  '49':{l:"Transport terrestre",cpOuv:"140",cpEmp:'226',nace:'49.xxx',sector:'transport'},
  '49.41':{l:"Transport routier de fret",cpOuv:"140.03",cpEmp:'226',nace:'49.41',sector:'transport'},
  '50':{l:"Transport par eau",cpOuv:"139",cpEmp:'226',nace:'50.xxx',sector:'transport'},
  '52':{l:"Entreposage / Logistique",cpOuv:"140",cpEmp:'226',nace:'52.xxx',sector:'transport'},
  '53':{l:"Activités de poste / Courrier",cpOuv:"140",cpEmp:'226',nace:'53.xxx',sector:'transport'},
  // Industrie alimentaire
  '10':{l:"Industries alimentaires",cpOuv:"118",cpEmp:'220',nace:'10.xxx',sector:'industrie'},
  '11':{l:"Fabrication de boissons",cpOuv:"118",cpEmp:'220',nace:'11.xxx',sector:'industrie'},
  // Industrie diverse
  '20':{l:"Industrie chimique",cpOuv:"116",cpEmp:'207',nace:'20.xxx',sector:'industrie'},
  '21':{l:"Industrie pharmaceutique",cpOuv:"116",cpEmp:'207',nace:'21.xxx',sector:'industrie'},
  '24':{l:"Métallurgie",cpOuv:"111.01",cpEmp:'209',nace:'24.xxx',sector:'industrie'},
  '25':{l:"Fabrication produits métalliques",cpOuv:"111.02",cpEmp:'209',nace:'25.xxx',sector:'industrie'},
  '22':{l:"Fabrication caoutchouc/plastique",cpOuv:"113",cpEmp:'209',nace:'22.xxx',sector:'industrie'},
  '13':{l:"Fabrication de textiles",cpOuv:"120",cpEmp:'214',nace:'13.xxx',sector:'industrie'},
  '16':{l:"Travail du bois",cpOuv:"125",cpEmp:'200',nace:'16.xxx',sector:'industrie'},
  '17':{l:"Industrie du papier",cpOuv:"129",cpEmp:'200',nace:'17.xxx',sector:'industrie'},
  '18':{l:"Imprimerie",cpOuv:"130",cpEmp:'200',nace:'18.xxx',sector:'industrie'},
  '23':{l:"Produits minéraux non métalliques",cpOuv:"114",cpEmp:'200',nace:'23.xxx',sector:'industrie'},
  // Services
  '62':{l:"Programmation informatique / IT",cpOuv:null,cpEmp:'200',nace:'62.xxx',sector:'bureau'},
  '63':{l:"Services d\'information",cpOuv:null,cpEmp:'200',nace:'63.xxx',sector:'bureau'},
  '64':{l:"Services financiers (banques)",cpOuv:null,cpEmp:'310',nace:'64.xxx',sector:'bureau'},
  '65':{l:"Assurances",cpOuv:null,cpEmp:'306',nace:'65.xxx',sector:'bureau'},
  '66':{l:"Auxiliaires financiers / Courtage",cpOuv:null,cpEmp:'307',nace:'66.xxx',sector:'bureau'},
  '68':{l:"Activités immobilières",cpOuv:null,cpEmp:'323',nace:'68.xxx',sector:'bureau'},
  '69':{l:"Activités comptables / Juridiques",cpOuv:null,cpEmp:'200',nace:'69.xxx',sector:'bureau'},
  '69.10':{l:"Activités juridiques (avocats)",cpOuv:null,cpEmp:'200',nace:'69.10',sector:'bureau'},
  '69.20':{l:"Comptabilité / Fiduciaire",cpOuv:null,cpEmp:'200',nace:'69.20',sector:'bureau'},
  '70':{l:"Conseil de gestion / Management",cpOuv:null,cpEmp:'200',nace:'70.xxx',sector:'bureau'},
  '71':{l:"Architecture / Ingénierie",cpOuv:null,cpEmp:'200',nace:'71.xxx',sector:'bureau'},
  '72':{l:"Recherche scientifique",cpOuv:null,cpEmp:'200',nace:'72.xxx',sector:'bureau'},
  '73':{l:"Publicité / Études de marché",cpOuv:null,cpEmp:'200',nace:'73.xxx',sector:'bureau'},
  '74':{l:"Autres activités spécialisées",cpOuv:null,cpEmp:'200',nace:'74.xxx',sector:'bureau'},
  '78':{l:"Activités liées à l\'emploi / Intérim",cpOuv:"322",cpEmp:'322',nace:'78.xxx',sector:'bureau'},
  '80':{l:"Sécurité / Gardiennage",cpOuv:"317",cpEmp:'317',nace:'80.xxx',sector:'bureau'},
  '81':{l:"Services aux bâtiments / Nettoyage",cpOuv:"121",cpEmp:'200',nace:'81.xxx',sector:'nettoyage'},
  '81.21':{l:"Nettoyage général bâtiments",cpOuv:"121",cpEmp:'200',nace:'81.21',sector:'nettoyage'},
  '82':{l:"Services de soutien aux entreprises",cpOuv:null,cpEmp:'200',nace:'82.xxx',sector:'bureau'},
  // Santé / Social
  '86':{l:"Activités pour la santé humaine",cpOuv:"330",cpEmp:'330',nace:'86.xxx',sector:'medical'},
  '86.10':{l:"Hôpitaux",cpOuv:"330",cpEmp:'330',nace:'86.10',sector:'medical'},
  '86.21':{l:"Médecins généralistes",cpOuv:null,cpEmp:'200',nace:'86.21',sector:'medical'},
  '86.23':{l:"Dentistes",cpOuv:null,cpEmp:'200',nace:'86.23',sector:'medical'},
  '87':{l:"Hébergement médico-social (MR/MRS)",cpOuv:"330",cpEmp:'330',nace:'87.xxx',sector:'medical'},
  '88':{l:"Action sociale sans hébergement",cpOuv:"332",cpEmp:'332',nace:'88.xxx',sector:'asbl'},
  '88.10':{l:"Aide à domicile (titres-services)",cpOuv:"322.01",cpEmp:'322.01',nace:'88.10',sector:'nettoyage'},
  // Enseignement
  '85':{l:"Enseignement",cpOuv:null,cpEmp:'225',nace:'85.xxx',sector:'asbl'},
  // Culture / Loisirs
  '90':{l:"Activités créatives / Artistiques",cpOuv:"304",cpEmp:'304',nace:'90.xxx',sector:'asbl'},
  '93':{l:"Activités sportives / Récréatives",cpOuv:"329",cpEmp:'329',nace:'93.xxx',sector:'asbl'},
  // Agriculture
  '01':{l:"Agriculture / Culture",cpOuv:"144",cpEmp:'200',nace:'01.xxx',sector:'industrie'},
  '02':{l:"Sylviculture",cpOuv:"146",cpEmp:'200',nace:'02.xxx',sector:'industrie'},
  '03':{l:"Pêche",cpOuv:"143",cpEmp:'200',nace:'03.xxx',sector:'industrie'},
};

// Simuler lookup BCE à partir du n° TVA
// En production: appeler https://kbopub.economie.fgov.be/kbopub/zoeknummerform.html
// ou l'API VIES pour validation TVA + BCE API pour les données entreprise
function lookupBCE(vatNumber){
  // Normaliser le numéro
  const clean=vatNumber.replace(/[^0-9]/g,"");
  if(clean.length<9||clean.length>10)return null;
  const nr=clean.padStart(10,"0");
  
  // Simuler des entreprises connues pour la démo
  // En production: fetch vers l'API BCE
  const DEMO_COMPANIES={
    '0419052173':{name:'Colruyt Group NV',forme:'sa',addr:'Edingensesteenweg 196, 1500 Halle',nace:['47.11'],activity:'Commerce de détail alimentaire'},
    '0403171043':{name:'Delhaize Le Lion SA',forme:'sa',addr:'Rue Osseghem 53, 1080 Molenbeek',nace:['47.11'],activity:'Commerce de détail alimentaire'},
    '0404616494':{name:'Solvay SA',forme:'sa',addr:'Rue de Ransbeek 310, 1120 Bruxelles',nace:['20'],activity:'Industrie chimique'},
    '0401574852':{name:'Besix SA',forme:'sa',addr:'Avenue des Communautés 100, 1200 Bruxelles',nace:['41',"42"],activity:'Construction de bâtiments et génie civil'},
    '1028230781':{name:'Aureus IA SPRL',forme:'sprl',addr:'Saint-Gilles, Bruxelles',nace:['62'],activity:'Programmation informatique'},
  };
  
  if(DEMO_COMPANIES[nr])return{...DEMO_COMPANIES[nr],vat:`BE ${nr.slice(0,4)}.${nr.slice(4,7)}.${nr.slice(7)}`,bce:nr,found:true};
  
  // Pour tout autre numéro: retourner un template vide avec les codes NACE à remplir
  return{name:'',forme:'sprl',addr:'',nace:[],activity:'',vat:`BE ${nr.slice(0,4)}.${nr.slice(4,7)}.${nr.slice(7)}`,bce:nr,found:false,
    message:"⚠ Entreprise non trouvée dans la démo. En production, les données seront récupérées automatiquement via l'API BCE (KBO) et le Moniteur Belge."};
}

// Déterminer toutes les CP applicables à partir des codes NACE
function detectCPFromNACE(naceCodes){
  const results=[];
  const seen=new Set();
  (naceCodes||[]).forEach(code=>{
    // Chercher d'abord le code exact, puis préfixes de plus en plus courts
    const clean=code.replace(/\s/g,"");
    const match=NACE_TO_CP[clean]
      ||NACE_TO_CP[clean.substring(0,5)]
      ||NACE_TO_CP[clean.substring(0,4)]
      ||NACE_TO_CP[clean.substring(0,2)];
    if(match){
      const key=`${match.cpOuv||'-'}_${match.cpEmp}`;
      if(!seen.has(key)){
        seen.add(key);
        results.push({...match,naceCode:code});
      }
    }
  });
  return results;
}

function ClientWizard({onFinish,onCancel}){
  const [step,setStep]=useState(1);
  const [bceLoading,setBceLoading]=useState(false);
  const [bceResult,setBceResult]=useState(null);
  const [cpDetected,setCpDetected]=useState([]);
  const [naceInput,setNaceInput]=useState('');
  const [data,setData]=useState({
    name:'',vat:'',onss:'',addr:'',contact:'',email:"",phone:'',forme:'sprl',
    activity:'',subType:'',naceCodes:[],cpEmploye:'200',cpOuvrier:'',
    emps:[],
  });

  // ── BCE LOOKUP (API réelle) ──
  const doLookup=async()=>{
    if(!data.vat||data.vat.replace(/[^0-9]/g,"").length<9)return;
    setBceLoading(true);
    setBceResult(null);
    try{
      const clean=data.vat.replace(/[^0-9]/g,"");
      const resp=await fetch(`/api/bce?vat=${clean}`);
      const result=await resp.json();
      setBceResult(result);
      if(result){
        const upd={...data};
        if(result.found){
          upd.name=result.name||upd.name;upd.forme=result.forme||upd.forme;upd.addr=result.addr||upd.addr;upd.vat=result.vat||upd.vat;upd.naceCodes=result.nace||[];
          if(result.email)upd.email=result.email;
          if(result.phone)upd.phone=result.phone;
        } else { upd.vat=result.vat||upd.vat; }
        const cps=detectCPFromNACE(result.nace||[]);
        setCpDetected(cps);
        if(cps.length>0){upd.cpEmploye=cps[0].cpEmp||'200';upd.cpOuvrier=cps[0].cpOuv||'';}
        setData(upd);
      }
    }catch(err){
      console.error('BCE lookup error:',err);
      // Fallback vers la recherche locale
      const result=lookupBCE(data.vat);
      setBceResult(result);
      if(result){
        const upd={...data};
        if(result.found){
          upd.name=result.name;upd.forme=result.forme;upd.addr=result.addr;upd.vat=result.vat;upd.naceCodes=result.nace||[];
        } else { upd.vat=result.vat; }
        const cps=detectCPFromNACE(result.nace||[]);
        setCpDetected(cps);
        if(cps.length>0){upd.cpEmploye=cps[0].cpEmp||'200';upd.cpOuvrier=cps[0].cpOuv||'';}
        setData(upd);
      }
    }
    setBceLoading(false);
  };

  const addNace=()=>{
    if(!naceInput)return;
    const codes=[...data.naceCodes,naceInput];
    const cps=detectCPFromNACE(codes);
    setCpDetected(cps);
    setData(d=>({...d,naceCodes:codes,cpEmploye:cps[0]?.cpEmp||d.cpEmploye,cpOuvrier:cps[0]?.cpOuv||d.cpOuvrier}));
    setNaceInput('');
  };
  const removeNace=(code)=>{
    const codes=data.naceCodes.filter(c=>c!==code);
    const cps=detectCPFromNACE(codes);
    setCpDetected(cps);
    setData(d=>({...d,naceCodes:codes}));
  };

  const formes=[{v:"sprl",l:"SRL (ex-SPRL)"},{v:"sa",l:"SA"},{v:"sc",l:"SC"},{v:"asbl",l:"ASBL"},{v:"snc",l:"SNC"},{v:"scomm",l:"SComm"},{v:"pp",l:"Personne physique"}];

  const selActivity=ACTIVITIES[data.activity];
  const selType=selActivity?.types?.find(t=>t.v===data.subType);
  const autoCP=selType?.cp||'200';
  const suggestedEmps=selType?.emps||[];

  const addEmp=(template)=>{
    // Auto-lookup barème officiel
    const bar=getBareme(autoCP,template.fn,0);
    const salary=bar?bar.monthly:template.bar;
    const barInfo=bar?`CP ${autoCP} classe ${bar.classe} (${bar.classLabel||bar.classe}) — Barème SPF ${bar.indexDate}`:'Barème indicatif';
    setData({...data,emps:[...data.emps,{
      id:"W-"+uid(),first:'',last:'',niss:'',birth:'',addr:'',city:'',zip:'',startD:new Date().toISOString().split('T')[0],fn:template.fn,
      monthlySalary:salary,contract:'CDI',regime:'full',whWeek:bar?.regime||38,civil:"single",depChildren:0,handiChildren:0,
      iban:'',mvT:10,mvW:CR_TRAV,mvE:8.91,expense:0,cp:autoCP,dmfaCode:'495',dimType:'OTH',commDist:0,commType:'none',commMonth:0,status:'active',dept:'',endD:'',
      baremeClasse:bar?.classe||'',baremeInfo:barInfo,anciennete:0,
    }]});
  };

  const updEmp=(id,field,val)=>{
    let newEmps=(data.emps||[]).map(e=>{
      if(e.id!==id)return e;
      const upd={...e,[field]:field==='monthlySalary'||field==='depChildren'||field==='handiChildren'||field==='commDist'||field==='anciennete'?(parseFloat(val)||0):val};
      // Auto-recalc barème when ancienneté changes
      if(field==='anciennete'){
        const bar=getBareme(autoCP,upd.fn,upd.anciennete);
        if(bar){upd.monthlySalary=bar.monthly;upd.baremeClasse=bar.classe;upd.baremeInfo=`CP ${autoCP} classe ${bar.classe} anc.${bar.ancYr}ans — SPF ${bar.indexDate}`;}
      }
      return upd;
    });
    setData({...data,emps:newEmps});
  };

  const remEmp=(id)=>setData({...data,emps:data.emps.filter(e=>e.id!==id)});

  const finish=()=>{
    if(!data.name){alert('Raison sociale requise');return;}
    const company={name:data.name,vat:data.vat,onss:data.onss,addr:data.addr,contact:data.contact,email:data.email,phone:data.phone,cp:autoCP,cpEmploye:data.cpEmploye,cpOuvrier:data.cpOuvrier,bank:'',insurer:'',policyNr:'',secSoc:'',forme:data.forme,naceCodes:data.naceCodes};
    onFinish({company,emps:data.emps,sector:data.activity,subType:data.subType});
  };

  const stepStyle={background:"linear-gradient(145deg,#0e1220,#131829)",border:'1px solid rgba(139,115,60,.15)',borderRadius:16,padding:'28px 32px',marginBottom:20,boxShadow:'0 8px 32px rgba(0,0,0,.3)'};
  const stepBar=<div style={{display:'flex',gap:0,marginBottom:28}}>
    {[{n:1,l:"Société"},{n:2,l:"Activité"},{n:3,l:"Travailleurs"},{n:4,l:"Résumé"}].map(st=>(
      <div key={st.n} onClick={()=>st.n<step&&setStep(st.n)} style={{flex:1,textAlign:'center',padding:'12px 0',cursor:st.n<step?'pointer':'default',borderBottom:`3px solid ${step>=st.n?'#c6a34e':'rgba(139,115,60,.15)'}`,transition:'all .2s'}}>
        <div style={{fontSize:10,color:step>=st.n?'#c6a34e':'#5e5c56',fontWeight:600,textTransform:'uppercase',letterSpacing:'1px'}}>{st.n}. {st.l}</div>
      </div>
    ))}
  </div>;

  return <div style={{maxWidth:900,margin:'0 auto'}}>
    {stepBar}

    {step===1&&<div style={stepStyle}>
      <div style={{fontSize:18,fontWeight:600,color:'#e8e6e0',marginBottom:6}}>Identification de la société</div>
      <div style={{fontSize:12,color:'#5e5c56',marginBottom:20}}>Entrez le numéro de TVA pour récupérer automatiquement les données via la BCE et le Moniteur Belge</div>
      
      {/* TVA + Bouton BCE */}
      <div style={{display:'flex',gap:10,marginBottom:16,alignItems:'flex-end'}}>
        <div style={{flex:1}}><I label="N° TVA (BE 0xxx.xxx.xxx) *" value={data.vat} onChange={v=>setData({...data,vat:v})}/></div>
        <button onClick={doLookup} disabled={bceLoading} style={{padding:'10px 20px',background:bceLoading?'rgba(198,163,78,.1)':'linear-gradient(135deg,#c6a34e,#a68a3c)',color:bceLoading?'#c6a34e':'#060810',fontWeight:700,fontSize:12,border:'none',borderRadius:8,cursor:bceLoading?'wait':'pointer',fontFamily:'inherit',whiteSpace:'nowrap',height:42}}>
          {bceLoading?'⏳ Recherche BCE...':'🔍 Rechercher BCE / MB'}
        </button>
      </div>

      {/* Résultat BCE */}
      {bceResult&&<div style={{marginBottom:16,padding:14,borderRadius:10,background:bceResult.found?'rgba(74,222,128,.06)':'rgba(248,113,113,.06)',border:`1px solid ${bceResult.found?'rgba(74,222,128,.2)':'rgba(248,113,113,.2)'}`}}>
        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
          <span style={{fontSize:16}}>{bceResult.found?'✅':'⚠'}</span>
          <span style={{fontSize:13,fontWeight:600,color:bceResult.found?'#4ade80':'#fb923c'}}>{bceResult.found?'Entreprise trouvée dans la BCE':'Entreprise non trouvée'}</span>
        </div>
        {bceResult.found&&<div style={{fontSize:12,color:'#9e9b93',lineHeight:2}}>
          <div>Dénomination: <b style={{color:'#e8e6e0'}}>{bceResult.name}</b></div>
          <div>N° entreprise: <b style={{color:'#e8e6e0'}}>{bceResult.bce}</b></div>
          <div>Activité BCE: <b style={{color:'#c6a34e'}}>{bceResult.activity}</b></div>
          <div>Code(s) NACE: <b style={{color:'#60a5fa'}}>{(bceResult.nace||[]).join(', ')}</b></div>
          {bceResult.formeLabel&&bceResult.formeLabel.trim()&&!bceResult.formeLabel.includes('nbsp')&&<div>Forme juridique: <b style={{color:'#e8e6e0'}}>{bceResult.formeLabel}</b></div>}
          {bceResult.addr&&<div>Adresse: <b style={{color:'#e8e6e0'}}>{bceResult.addr}</b></div>}
          {bceResult.email&&<div>Email: <b style={{color:'#60a5fa'}}>{bceResult.email}</b></div>}
          {bceResult.phone&&<div>Téléphone: <b style={{color:'#e8e6e0'}}>{bceResult.phone}</b></div>}
          {bceResult.status&&<div>Statut: <b style={{color:bceResult.status.toLowerCase().includes('actif')||bceResult.status.toLowerCase().includes('actief')?'#4ade80':'#fb923c'}}>{bceResult.status}</b></div>}
        </div>}
        {!bceResult.found&&bceResult.message&&<div style={{fontSize:11,color:'#fb923c'}}>{bceResult.message}</div>}
      </div>}

      {/* Formulaire société (pré-rempli par BCE) */}
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14}}>
        <I label="Raison sociale *" value={data.name} onChange={v=>setData({...data,name:v})}/>
        <I label="Forme juridique" value={data.forme} onChange={v=>setData({...data,forme:v})} options={formes}/>
        <I label="N° ONSS" value={data.onss} onChange={v=>setData({...data,onss:v})}/>
        <I label="Adresse du siège" value={data.addr} onChange={v=>setData({...data,addr:v})}/>
        <I label="Personne de contact" value={data.contact} onChange={v=>setData({...data,contact:v})}/>
        <I label="Email" value={data.email} onChange={v=>setData({...data,email:v})}/>
        <I label="Téléphone" value={data.phone} onChange={v=>setData({...data,phone:v})}/>
      </div>

      {/* Section NACE + CP détectées */}
      <div style={{marginTop:20,padding:16,background:"rgba(96,165,250,.04)",border:'1px solid rgba(96,165,250,.12)',borderRadius:12}}>
        <div style={{fontSize:13,fontWeight:600,color:'#60a5fa',marginBottom:10}}>📋 Codes NACE & Commissions Paritaires</div>
        
        {/* Codes NACE */}
        <div style={{display:'flex',flexWrap:'wrap',gap:6,marginBottom:10}}>
          {(data.naceCodes||[]).map(code=>{
            const match=NACE_TO_CP[code]||NACE_TO_CP[code.substring(0,2)];
            return <span key={code} style={{display:'inline-flex',alignItems:'center',gap:6,padding:'4px 10px',background:"rgba(96,165,250,.1)",borderRadius:6,fontSize:11,color:'#60a5fa'}}>
              <b>{code}</b> {match?`— ${match.l}`:''} <button onClick={()=>removeNace(code)} style={{background:"none",border:'none',color:'#f87171',cursor:'pointer',fontSize:12,padding:0}}>✕</button>
            </span>;
          })}
          {data.naceCodes.length===0&&<span style={{fontSize:11,color:'#5e5c56'}}>Aucun code NACE — utilisez la recherche BCE ou ajoutez manuellement</span>}
        </div>
        
        {/* Ajout NACE manuel */}
        <div style={{display:'flex',gap:8,marginBottom:14}}>
          <I label="Ajouter code NACE" value={naceInput} onChange={setNaceInput} style={{flex:1}}/>
          <button onClick={addNace} style={{padding:'8px 14px',background:"rgba(96,165,250,.1)",border:'1px solid rgba(96,165,250,.2)',borderRadius:7,color:'#60a5fa',fontSize:11,cursor:'pointer',fontFamily:'inherit',whiteSpace:'nowrap',alignSelf:'flex-end',height:38}}>+ Ajouter</button>
        </div>

        {/* CP DÉTECTÉES */}
        {cpDetected.length>0?<div>
          <div style={{fontSize:12,fontWeight:600,color:'#4ade80',marginBottom:8}}>✅ Commission(s) Paritaire(s) détectée(s) automatiquement :</div>
          <table style={{width:'100%',borderCollapse:'collapse',marginBottom:10}}>
            <thead><tr style={{borderBottom:'1px solid rgba(198,163,78,.15)'}}>
              <th style={{textAlign:'left',padding:'8px 10px',fontSize:10,color:'#5e5c56',textTransform:'uppercase'}}>NACE</th>
              <th style={{textAlign:'left',padding:'8px 10px',fontSize:10,color:'#5e5c56',textTransform:'uppercase'}}>Activité</th>
              <th style={{textAlign:'left',padding:'8px 10px',fontSize:10,color:'#5e5c56',textTransform:'uppercase'}}>CP Employés</th>
              <th style={{textAlign:'left',padding:'8px 10px',fontSize:10,color:'#5e5c56',textTransform:'uppercase'}}>CP Ouvriers</th>
            </tr></thead>
            <tbody>{cpDetected.map((cp,i)=><tr key={i} style={{borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <td style={{padding:'8px 10px',fontSize:12,color:'#60a5fa',fontWeight:600}}>{cp.naceCode}</td>
              <td style={{padding:'8px 10px',fontSize:12,color:'#e8e6e0'}}>{cp.l}</td>
              <td style={{padding:'8px 10px'}}><span style={{padding:'3px 8px',borderRadius:5,background:"rgba(74,222,128,.1)",color:'#4ade80',fontSize:11,fontWeight:600}}>CP {cp.cpEmp}</span></td>
              <td style={{padding:'8px 10px'}}>{cp.cpOuv?<span style={{padding:'3px 8px',borderRadius:5,background:"rgba(251,146,60,.1)",color:'#fb923c',fontSize:11,fontWeight:600}}>CP {cp.cpOuv}</span>:<span style={{fontSize:10,color:'#5e5c56'}}>Pas d'ouvriers</span>}</td>
            </tr>)}</tbody>
          </table>

          {/* ALERTE CP différentes ouvriers/employés */}
          {cpDetected.some(cp=>cp.cpOuv&&cp.cpOuv!==cp.cpEmp)&&<div style={{padding:10,background:"rgba(251,146,60,.06)",border:'1px solid rgba(251,146,60,.2)',borderRadius:8,marginBottom:10}}>
            <div style={{fontSize:11,fontWeight:600,color:'#fb923c',marginBottom:4}}>⚠ Attention — CP différentes pour Employés et Ouvriers !</div>
            <div style={{fontSize:11,color:'#9e9b93',lineHeight:1.6}}>
              Ce secteur utilise des commissions paritaires différentes selon le statut du travailleur. Lors de l'encodage de vos futurs travailleurs, veillez à bien sélectionner :
              {cpDetected.filter(cp=>cp.cpOuv&&cp.cpOuv!==cp.cpEmp).map((cp,i)=><div key={i} style={{marginTop:4}}>
                • <b style={{color:'#4ade80'}}>Employés → CP {cp.cpEmp}</b> ({LEGAL.CP[cp.cpEmp]||cp.cpEmp})<br/>
                • <b style={{color:'#fb923c'}}>Ouvriers → CP {cp.cpOuv}</b> ({LEGAL.CP[cp.cpOuv]||cp.cpOuv})
              </div>)}
            </div>
          </div>}

          {/* ALERTE pas de CP ouvriers */}
          {cpDetected.every(cp=>!cp.cpOuv)&&<div style={{padding:10,background:"rgba(96,165,250,.06)",border:'1px solid rgba(96,165,250,.15)',borderRadius:8,marginBottom:10}}>
            <div style={{fontSize:11,fontWeight:600,color:'#60a5fa'}}>ℹ Ce secteur n'emploie généralement pas d'ouvriers</div>
            <div style={{fontSize:10.5,color:'#9e9b93'}}>Les travailleurs seront encodés comme employés en CP {cpDetected[0]?.cpEmp||'200'}. Si vous engagez des ouvriers, ajoutez le code NACE correspondant.</div>
          </div>}

          {/* Sélection CP à appliquer */}
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
            <I label="CP pour les employés" value={data.cpEmploye} onChange={v=>setData({...data,cpEmploye:v})} options={[{v:cpDetected[0]?.cpEmp||'200',l:`CP ${cpDetected[0]?.cpEmp||'200'} — Détecté`},...Object.entries(LEGAL.CP).filter(([k])=>k!==cpDetected[0]?.cpEmp).map(([k,v])=>({v:k,l:v}))]}/>
            <I label="CP pour les ouvriers" value={data.cpOuvrier} onChange={v=>setData({...data,cpOuvrier:v})} options={[{v:"",l:"— Pas d\'ouvriers —"},...(cpDetected[0]?.cpOuv?[{v:cpDetected[0].cpOuv,l:`CP ${cpDetected[0].cpOuv} — Détecté`}]:[]),...Object.entries(LEGAL.CP).filter(([k])=>k!==cpDetected[0]?.cpOuv).map(([k,v])=>({v:k,l:v}))]}/>
          </div>
        </div>:<div style={{padding:20,textAlign:'center',color:'#5e5c56',fontSize:12}}>
          Entrez le n° TVA et cliquez "Rechercher BCE" pour détecter automatiquement les commissions paritaires, ou ajoutez un code NACE manuellement.
        </div>}
      </div>

      <div style={{display:'flex',justifyContent:'flex-end',gap:10,marginTop:20}}>
        <B v="outline" onClick={onCancel}>Annuler</B>
        <B onClick={()=>{if(!data.name){alert('Raison sociale requise');return;}setStep(2);}}>Suivant →</B>
      </div>
    </div>}

    {step===2&&<div style={stepStyle}>
      <div style={{fontSize:18,fontWeight:600,color:'#e8e6e0',marginBottom:6}}>Secteur d'activité</div>
      <div style={{fontSize:12,color:'#5e5c56',marginBottom:20}}>Sélectionnez le secteur pour déterminer automatiquement la commission paritaire</div>
      
      <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:10,marginBottom:20}}>
        {Object.entries(ACTIVITIES).map(([k,v])=>(
          <div key={k} onClick={()=>setData({...data,activity:k,subType:''})}
            style={{padding:'16px 14px',borderRadius:10,cursor:'pointer',textAlign:'center',border:`2px solid ${data.activity===k?'#c6a34e':'rgba(139,115,60,.12)'}`,background:data.activity===k?'rgba(198,163,78,.08)':'rgba(6,8,16,.5)',transition:'all .15s'}}
            onMouseEnter={e=>e.currentTarget.style.borderColor=data.activity===k?'#c6a34e':'rgba(198,163,78,.25)'}
            onMouseLeave={e=>e.currentTarget.style.borderColor=data.activity===k?'#c6a34e':'rgba(139,115,60,.12)'}>
            <div style={{fontSize:15,fontWeight:600,color:data.activity===k?'#c6a34e':'#9e9b93'}}>{v.l}</div>
          </div>
        ))}
      </div>

      {selActivity&&<>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Type d'activité précis :</div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:8}}>
          {(selActivity?.types||[]).map(t=>(
            <div key={t.v} onClick={()=>setData({...data,subType:t.v})}
              style={{padding:'12px 14px',borderRadius:8,cursor:'pointer',border:`1px solid ${data.subType===t.v?'#c6a34e':'rgba(139,115,60,.1)'}`,background:data.subType===t.v?'rgba(198,163,78,.06)':'transparent',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <span style={{fontSize:13,color:data.subType===t.v?'#e8e6e0':'#9e9b93'}}>{t.l}</span>
              <span style={{fontSize:10,padding:'2px 8px',borderRadius:5,background:"rgba(96,165,250,.08)",color:'#60a5fa',fontWeight:600}}>CP {t.cp}</span>
            </div>
          ))}
        </div>
      </>}

      {selType&&<div style={{marginTop:16,padding:14,background:"rgba(74,222,128,.04)",borderRadius:10,border:'1px solid rgba(74,222,128,.1)'}}>
        <div style={{fontSize:12,color:'#4ade80',fontWeight:600}}>✓ Commission paritaire détectée : CP {autoCP} — {LEGAL.CP[autoCP]||autoCP}</div>
        <div style={{fontSize:11,color:'#9e9b93',marginTop:4}}>Les barèmes et primes sectoriels seront automatiquement appliqués.</div>
      </div>}

      <div style={{display:'flex',justifyContent:'space-between',marginTop:20}}>
        <B v="outline" onClick={()=>setStep(1)}>← Retour</B>
        <B onClick={()=>{if(!data.subType){alert('Sélectionnez un type d\'activité');return;}setStep(3);}}>Suivant →</B>
      </div>
    </div>}

    {step===3&&<div style={stepStyle}>
      <div style={{fontSize:18,fontWeight:600,color:'#e8e6e0',marginBottom:6}}>Travailleurs</div>
      <div style={{fontSize:12,color:'#5e5c56',marginBottom:16}}>Ajoutez les travailleurs — cliquez sur un profil suggéré ou ajoutez manuellement</div>
      
      {suggestedEmps.length>0&&<div style={{marginBottom:16}}>
        <div style={{fontSize:11,color:'#c6a34e',fontWeight:600,marginBottom:8,textTransform:'uppercase',letterSpacing:'1px'}}>Profils suggérés pour {selType?.l}</div>
        <div style={{display:'flex',flexWrap:'wrap',gap:8}}>
          {suggestedEmps.map((se,i)=>{
            const spf=getBareme(autoCP,se.fn,0);
            const displaySalary=spf?spf.monthly:se.bar;
            const isOfficial=!!spf;
            const isApprox=isOfficial&&BAREMES[autoCP]?.approx;
            return(
            <button key={i} onClick={()=>addEmp(se)} style={{padding:'8px 14px',borderRadius:8,background:"rgba(198,163,78,.06)",border:'1px solid rgba(198,163,78,.12)',color:'#c6a34e',fontSize:12,cursor:'pointer',fontFamily:'inherit',transition:'all .15s'}}
              onMouseEnter={e=>e.currentTarget.style.background='rgba(198,163,78,.12)'}
              onMouseLeave={e=>e.currentTarget.style.background='rgba(198,163,78,.06)'}>
              + {se.fn} <span style={{color:isOfficial?(isApprox?'#facc15':'#4ade80'):'#5e5c56',marginLeft:6}}>{isApprox?'≈':''}{fmt(displaySalary)}</span>
              {isOfficial&&!isApprox&&<span style={{fontSize:8,color:'#4ade80',marginLeft:4}}>SPF</span>}
              {isApprox&&<span style={{fontSize:8,color:'#facc15',marginLeft:4}}>≈</span>}
            </button>
          );})}
        </div>
      </div>}

      {data.emps.length>0&&<div style={{overflowX:'auto'}}>
        <table style={{width:'100%',borderCollapse:'collapse',marginBottom:16}}>
          <thead><tr style={{borderBottom:'1px solid rgba(139,115,60,.15)'}}>
            {['Prénom',"Nom","NISS","Fonction","Anc.","Brut min.","Contrat","Situation","Enf.",""].map(h=><th key={h} style={{textAlign:'left',padding:'8px 10px',fontSize:10,color:'#5e5c56',textTransform:'uppercase',letterSpacing:'.5px'}}>{h}</th>)}
          </tr></thead>
          <tbody>{(data.emps||[]).map(emp=>(
            <tr key={emp.id} style={{borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <td style={{padding:'6px 10px'}}><input value={emp.first} onChange={e=>updEmp(emp.id,"first",e.target.value)} placeholder="Prénom" style={{width:90,padding:'6px 8px',background:"#090c16",border:'1px solid rgba(139,115,60,.12)',borderRadius:5,color:'#d4d0c8',fontSize:12,fontFamily:'inherit',outline:'none'}}/></td>
              <td style={{padding:'6px 10px'}}><input value={emp.last} onChange={e=>updEmp(emp.id,"last",e.target.value)} placeholder="Nom" style={{width:90,padding:'6px 8px',background:"#090c16",border:'1px solid rgba(139,115,60,.12)',borderRadius:5,color:'#d4d0c8',fontSize:12,fontFamily:'inherit',outline:'none'}}/></td>
              <td style={{padding:'6px 10px'}}><input value={emp.niss} onChange={e=>updEmp(emp.id,"niss",e.target.value)} placeholder="XX.XX.XX-XXX.XX" style={{width:110,padding:'6px 8px',background:"#090c16",border:'1px solid rgba(139,115,60,.12)',borderRadius:5,color:'#d4d0c8',fontSize:12,fontFamily:'inherit',outline:'none'}}/></td>
              <td style={{padding:'6px 10px',fontSize:12,color:'#c6a34e'}}>{emp.fn}</td>
              <td style={{padding:'6px 10px'}}><input type="number" value={emp.anciennete||0} onChange={e=>updEmp(emp.id,"anciennete",e.target.value)} min={0} max={40} style={{width:40,padding:'6px 8px',background:"#090c16",border:'1px solid rgba(139,115,60,.12)',borderRadius:5,color:'#60a5fa',fontSize:12,fontFamily:'inherit',outline:'none',textAlign:'center'}} title="Années d'ancienneté"/></td>
              <td style={{padding:'6px 10px'}}><div style={{display:'flex',flexDirection:'column',gap:2}}><input type="number" value={emp.monthlySalary} onChange={e=>updEmp(emp.id,"monthlySalary",e.target.value)} style={{width:80,padding:'6px 8px',background:"#090c16",border:'1px solid rgba(139,115,60,.12)',borderRadius:5,color:'#4ade80',fontSize:12,fontFamily:'inherit',outline:'none',textAlign:'right'}}/>{emp.baremeInfo&&<div style={{fontSize:8,color:'#60a5fa',maxWidth:100,lineHeight:1.2}}>{emp.baremeInfo}</div>}</div></td>
              <td style={{padding:'6px 10px'}}><select value={emp.contract} onChange={e=>updEmp(emp.id,"contract",e.target.value)} style={{padding:'5px 6px',background:"#090c16",border:'1px solid rgba(139,115,60,.12)',borderRadius:5,color:'#d4d0c8',fontSize:11,fontFamily:'inherit',outline:'none'}}><option value="CDI">CDI</option><option value="CDD">CDD</option><option value="trav_det">Trav. défini</option><option value="remplacement">Remplacement</option><option value="tpartiel">Temps partiel</option><option value="INTERIM">Intérim</option><option value="STUDENT">Étudiant</option><option value="FLEXI">Flexi-job</option><option value="saisonnier">Saisonnier</option><option value="occas_horeca">Extra Horeca</option><option value="titre_service">Titres-services</option><option value="art60">Art.60§7</option><option value="CIP">CIP</option><option value="alternance">Alternance</option><option value="CPE">1er emploi</option><option value="ETA">Travail adapté</option><option value="detache">Détaché</option><option value="domestique">Domestique</option><option value="indep_princ">Indép. princ.</option><option value="indep_compl">Indép. compl.</option><option value="mandataire">Mandataire</option><option value="freelance">Freelance</option><option value="smart">Smart</option><option value="artiste">Artiste</option></select></td>
              <td style={{padding:'6px 10px'}}><select value={emp.civil} onChange={e=>updEmp(emp.id,"civil",e.target.value)} style={{padding:'5px 6px',background:"#090c16",border:'1px solid rgba(139,115,60,.12)',borderRadius:5,color:'#d4d0c8',fontSize:11,fontFamily:'inherit',outline:'none'}}><option value="single">Isolé</option><option value="married_2">Marié (2 revenus)</option><option value="married_1">Marié (1 revenu)</option><option value="cohabit">Cohabitant légal</option></select></td>
              <td style={{padding:'6px 10px'}}><input type="number" value={emp.depChildren} onChange={e=>updEmp(emp.id,"depChildren",e.target.value)} min={0} style={{width:40,padding:'6px 8px',background:"#090c16",border:'1px solid rgba(139,115,60,.12)',borderRadius:5,color:'#d4d0c8',fontSize:12,fontFamily:'inherit',outline:'none',textAlign:'center'}}/></td>
              <td style={{padding:'6px 6px'}}><button onClick={()=>remEmp(emp.id)} style={{background:"none",border:'none',color:'#f87171',cursor:'pointer',fontSize:16}}>✕</button></td>
            </tr>
          ))}</tbody>
        </table>
      </div>}

      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <div style={{fontSize:12,color:'#5e5c56'}}>{data.emps.length} travailleur{data.emps.length>1?'s':''} ajouté{data.emps.length>1?'s':''}</div>
        <div style={{display:'flex',gap:10}}>
          <B v="outline" onClick={()=>setStep(2)}>← Retour</B>
          <B onClick={()=>setStep(4)}>Suivant →</B>
        </div>
      </div>
    </div>}

    {step===4&&<div style={stepStyle}>
      <div style={{fontSize:18,fontWeight:600,color:'#e8e6e0',marginBottom:6}}>Récapitulatif du dossier</div>
      <div style={{fontSize:12,color:'#5e5c56',marginBottom:20}}>Vérifiez les informations avant de créer le dossier</div>
      
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:20}}>
        <div>
          <div style={{fontSize:11,color:'#c6a34e',fontWeight:600,textTransform:'uppercase',letterSpacing:'1px',marginBottom:10}}>Société</div>
          <div style={{fontSize:13,color:'#9e9b93',lineHeight:2.2}}>
            <div>Raison sociale: <b style={{color:'#e8e6e0'}}>{data.name}</b></div>
            <div>Forme: <b style={{color:'#e8e6e0'}}>{formes.find(f=>f.v===data.forme)?.l}</b></div>
            <div>TVA: <b style={{color:'#e8e6e0'}}>{data.vat||'—'}</b></div>
            <div>ONSS: <b style={{color:'#e8e6e0'}}>{data.onss||'—'}</b></div>
            <div>Contact: <b style={{color:'#e8e6e0'}}>{data.contact||'—'}</b></div>
          </div>
        </div>
        <div>
          <div style={{fontSize:11,color:'#c6a34e',fontWeight:600,textTransform:'uppercase',letterSpacing:'1px',marginBottom:10}}>Activité</div>
          <div style={{fontSize:13,color:'#9e9b93',lineHeight:2.2}}>
            <div>Secteur: <b style={{color:'#e8e6e0'}}>{selActivity?.l||'—'}</b></div>
            <div>Type: <b style={{color:'#e8e6e0'}}>{selType?.l||'—'}</b></div>
            <div>CP: <b style={{color:'#4ade80'}}>CP {autoCP}</b></div>
            {data.cpEmploye&&<div>CP Employés: <b style={{color:'#4ade80'}}>CP {data.cpEmploye}</b></div>}
            {data.cpOuvrier&&<div>CP Ouvriers: <b style={{color:'#fb923c'}}>CP {data.cpOuvrier}</b></div>}
            {data.naceCodes.length>0&&<div>NACE: <b style={{color:'#60a5fa'}}>{data.naceCodes.join(', ')}</b></div>}
            <div>Travailleurs: <b style={{color:'#e8e6e0'}}>{data.emps.length}</b></div>
            {data.emps.length>0&&<div>Masse brute: <b style={{color:'#c6a34e'}}>{fmt(data.emps.reduce((a,e)=>a+e.monthlySalary,0))}/mois</b></div>}
          </div>
        </div>
      </div>

      {data.emps.length>0&&<div style={{marginTop:16}}>
        <div style={{fontSize:11,color:'#c6a34e',fontWeight:600,textTransform:'uppercase',letterSpacing:'1px',marginBottom:8}}>Travailleurs ({data.emps.length})</div>
        <div style={{display:'grid',gap:6}}>
          {(data.emps||[]).map(e=>(
            <div key={e.id} style={{display:'flex',justifyContent:'space-between',padding:'8px 12px',background:"rgba(198,163,78,.03)",borderRadius:6,fontSize:12,flexWrap:'wrap',gap:4}}>
              <span style={{color:'#e8e6e0'}}>{e.first||'?'} {e.last||'?'}</span>
              <span style={{color:'#9e9b93'}}>{e.fn}</span>
              <span style={{color:'#c6a34e',fontWeight:600}}>{fmt(e.monthlySalary)}</span>
              <span style={{color:'#60a5fa',fontSize:10}}>{e.baremeInfo||''}</span>
              <span style={{color:'#5e5c56'}}>{e.contract} · {e.civil==='single'?'Isolé':e.civil==='married_1'?'Marié (1 revenu)':e.civil==='married_2'?'Marié (2 revenus)':'Cohabitant légal'} · {e.depChildren} enf.</span>
            </div>
          ))}
        </div>
      </div>}

      {/* Avantages sectoriels */}
      {(()=>{const avs=getCPAvantages(autoCP);return avs.length>0?<div style={{marginTop:16}}>
        <div style={{fontSize:11,color:'#4ade80',fontWeight:600,textTransform:'uppercase',letterSpacing:'1px',marginBottom:8}}>Avantages sectoriels CP {autoCP}</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
          {avs.map((a,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 10px',background:"rgba(74,222,128,.03)",borderRadius:5,fontSize:11.5}}>
            <span style={{color:'#9e9b93'}}>{a.l}</span><span style={{color:'#4ade80',fontWeight:600}}>{a.v}</span>
          </div>)}
        </div>
      </div>:null;})()}

      <div style={{display:'flex',justifyContent:'space-between',marginTop:24}}>
        <B v="outline" onClick={()=>setStep(3)}>← Retour</B>
        <B onClick={finish} style={{fontSize:15,padding:'12px 32px'}}>✓ Créer le dossier</B>
      </div>
    </div>}
  </div>;
}

function ClientsPage({s,d,user,userRole,onLogout,veilleNotif,setVeilleNotif}){
  const isCommercial=userRole==='commercial';
  const userEmail=user?.email?.toLowerCase()||'';
  const visibleClients=isCommercial?(s.clients||[]).filter(c=>c.assignedTo?.toLowerCase()===userEmail):(s.clients||[]);
  const [showWizard,setShowWizard]=useState(false);
  const [search,setSearch]=useState('');
  
  const handleFinish=(result)=>{
    d({type:"ADD_CLIENT",d:{company:result.company,emps:result.emps,pays:[],dims:[],dmfas:[],fiches:[],docs:[],sector:result.sector,subType:result.subType},assignedTo:userEmail});
    setShowWizard(false);
  };
  
  const getScore=(cl)=>{
    let sc=0;if(cl.company?.name)sc++;if(cl.company?.vat)sc++;if(cl.company?.onss)sc++;
    if(cl.company?.iban)sc++;if(cl.company?.cp)sc++;if(cl.company?.accidentIns)sc++;
    if(cl.emps?.length>0){sc++;if(cl.emps.every(e=>e.niss))sc++;if(cl.emps.every(e=>e.iban))sc++;
      if(cl.emps.every(e=>e.monthlySalary>0))sc++;if(cl.emps.every(e=>e.startD))sc++;}
    if(cl.dims?.length>0)sc++;if(cl.fiches?.length>0)sc++;
    return Math.round(sc/13*100);
  };
  
  const filtered=visibleClients.filter(c=>{
    if(!search)return true;
    if(search==='__bad__')return getScore(c)<60;
    if(search==='__ok__'){const sc=getScore(c);return sc>=60&&sc<80;}
    if(search==='__good__')return getScore(c)>=80;
    if(search==='__novat__')return !c.company?.vat;
    if(search==='__noonss__')return !c.company?.onss;
    const q=search.toLowerCase();
    return c.company?.name?.toLowerCase().includes(q)||c.company?.vat?.toLowerCase().includes(q)||c.company?.contact?.toLowerCase().includes(q);
  });

  const stats={total:visibleClients.length||0,emps:visibleClients.reduce((a,c)=>a+(c.emps?.length||0),0)};

  const kpiData=useMemo(()=>{
    const scoreMoyen=Math.round(visibleClients.reduce((a,cl)=>{
      let sc=0,tot=13;
      if(cl.company?.name)sc++;if(cl.company?.vat)sc++;if(cl.company?.onss)sc++;
      if(cl.company?.iban)sc++;if(cl.company?.cp)sc++;if(cl.company?.accidentIns)sc++;
      if(cl.emps?.length>0){sc++;
        if(cl.emps.every(e=>e.niss))sc++;if(cl.emps.every(e=>e.iban))sc++;
        if(cl.emps.every(e=>e.monthlySalary>0))sc++;if(cl.emps.every(e=>e.startD))sc++;
      }
      if(cl.dims?.length>0)sc++;if(cl.fiches?.length>0)sc++;
      return a+(sc/tot*100);
    },0)/visibleClients.length||0);
    const dossiersRisque=visibleClients.filter(cl=>{
      let sc=0;if(cl.company?.name)sc++;if(cl.company?.vat)sc++;if(cl.emps?.length>0)sc++;
      if(cl.emps?.every(e=>e.niss))sc++;if(cl.emps?.every(e=>e.monthlySalary>0))sc++;
      return sc<3;
    }).length;
    const sansTVA=visibleClients.filter(cl=>!cl.company?.vat).length;
    const masseSalariale=(visibleClients.reduce((a,cl)=>a+(cl.emps||[]).reduce((b,e)=>b+(e.monthlySalary||0),0),0)/1000).toFixed(0);
    return {scoreMoyen,dossiersRisque,sansTVA,masseSalariale};
  },[visibleClients]);

  return(
    <div style={{minHeight:'100vh',background:"#060810",color:'#d4d0c8',fontFamily:`'Outfit','DM Sans',system-ui,sans-serif`}}>
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Cormorant+Garamond:wght@500;600;700&display=swap" rel="stylesheet"/>
      
      {/* Header */}
      <div style={{background:"linear-gradient(135deg,#090c16,#0e1225)",borderBottom:'1px solid rgba(139,115,60,.12)',padding:'20px 36px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <div style={{display:'flex',alignItems:'center',gap:16}}>
          <div style={{width:42,height:42,borderRadius:12,background:"linear-gradient(135deg,#c6a34e,#e2c878)",display:'flex',alignItems:'center',justifyContent:'center'}}><span style={{fontSize:20,fontWeight:800,color:'#060810'}}>A</span></div>
          <div>
            <div style={{fontFamily:"'Cormorant Garamond',Georgia,serif",fontSize:20,fontWeight:700,background:"linear-gradient(135deg,#c6a34e,#e2c878)",WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>AUREUS SOCIAL PRO</div>
            <div style={{fontSize:9,color:isCommercial?'#f97316':'#8b7340',letterSpacing:'3px',textTransform:'uppercase'}}>{isCommercial?'📈 Mes clients — Espace commercial':'Gestion des dossiers clients'}</div>
          </div>
        </div>
        <div style={{display:'flex',gap:14,alignItems:'center'}}>
          <div style={{textAlign:'right',marginRight:10}}>
            <div style={{fontSize:11,color:'#9e9b93'}}>{stats.total} dossier{stats.total>1?'s':''} · {stats.emps} travailleur{stats.emps>1?'s':''}</div>
            {user&&<div style={{fontSize:10,color:'#5e5c56'}}>{user.email}</div>}

            {(typeof window!=="undefined"&&window._onlineUsers&&window._onlineUsers.length>0)&&<div style={{display:"flex",alignItems:"center",gap:4,marginTop:4}}>
              <span style={{width:6,height:6,borderRadius:"50%",background:"#22c55e",display:"inline-block",animation:"blink 2s infinite"}}/>
              <span style={{fontSize:9,color:"#22c55e"}}>{(window._onlineUsers||[]).length} en ligne</span>
            </div>}
          </div>
          {onLogout&&<button onClick={onLogout} style={{padding:'8px 14px',background:"rgba(248,113,113,0.08)",border:'1px solid rgba(248,113,113,0.2)',borderRadius:8,color:'#fb923c',fontSize:11,cursor:'pointer',fontFamily:'inherit',fontWeight:600}}>Déconnexion</button>}
          <B onClick={()=>setShowWizard(!showWizard)}>{showWizard?'✕ Annuler':'+ Nouveau dossier'}</B>
        </div>
      </div>

      <div style={{maxWidth:1200,margin:'0 auto',padding:'30px 36px'}}>
        {showWizard?<ClientWizard onFinish={handleFinish} onCancel={()=>setShowWizard(false)}/>:<>
        
        {/* ═══ VEILLE LÉGALE AUTO ═══ */}
        {veilleNotif&&<div style={{marginBottom:14,padding:'12px 18px',borderRadius:10,background:veilleNotif.changed?'rgba(248,113,113,.06)':'rgba(74,222,128,.06)',border:`1px solid ${veilleNotif.changed?'rgba(248,113,113,.15)':'rgba(74,222,128,.15)'}`,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <div>
            <div style={{fontSize:12,fontWeight:600,color:veilleNotif.changed?'#f87171':'#4ade80'}}>{veilleNotif.changed?'⚠️ Changements détectés':'✅ Veille légale — Tout est à jour'}</div>
            <div style={{fontSize:10.5,color:'#9e9b93',marginTop:3,maxWidth:800,lineHeight:1.5}}>{veilleNotif.text}</div>
          </div>
          <div style={{textAlign:'right',flexShrink:0}}>
            <div style={{fontSize:9,color:'#5e5c56'}}>Vérifié le {veilleNotif.date}</div>
            <button onClick={()=>setVeilleNotif(null)} style={{fontSize:9,color:'#5e5c56',background:'none',border:'none',cursor:'pointer',marginTop:4}}>✕ Fermer</button>
          </div>
        </div>}
        
        {/* ═══ GLOBAL DASHBOARD — Vue d'ensemble 1000 clients ═══ */}
        {visibleClients.length>0&&<div style={{marginBottom:24}}>
          {/* KPI Row */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:10,marginBottom:14}}>
            {[
              {l:'Dossiers',v:stats.total,c:'#c6a34e'},
              {l:'Travailleurs',v:stats.emps,c:'#60a5fa'},
              {l:'Score santé moyen',v:kpiData.scoreMoyen+'%',c:'#4ade80'},
              {l:'Dossiers à risque',v:kpiData.dossiersRisque,c:'#f87171'},
              {l:'Sans TVA',v:kpiData.sansTVA,c:'#fb923c'},
              {l:'Masse salariale',v:kpiData.masseSalariale+'K€',c:'#a78bfa'},
            ].map((k,i)=><div key={i} style={{background:'linear-gradient(145deg,#0e1220,#131829)',border:'1px solid rgba(139,115,60,.08)',borderRadius:10,padding:'12px 14px',textAlign:'center'}}>
              <div style={{fontSize:20,fontWeight:700,color:k.c}}>{k.v}</div>
              <div style={{fontSize:9,color:'#5e5c56',marginTop:2}}>{k.l}</div>
            </div>)}
          </div>
          
          {/* ACTIONS EN MASSE — Hidden for commercial */}
          {!isCommercial&&<div style={{background:'linear-gradient(145deg,#0e1220,#131829)',border:'1px solid rgba(139,115,60,.12)',borderRadius:12,padding:'16px 20px',marginBottom:14}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
              <div style={{fontSize:13,fontWeight:600,color:'#c6a34e'}}>⚡ Actions en masse — Tous les clients</div>
              <div style={{fontSize:9,color:'#5e5c56'}}>100% automatisé · validation finale obligatoire</div>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
              {[
                {icon:'💰',label:'Batch Paie',desc:'Calculer toutes les fiches',action:()=>{
                  const ready=visibleClients.filter(cl=>{
                    let sc=0;if(cl.company?.name)sc++;if(cl.company?.vat)sc++;if(cl.emps?.length>0)sc++;
                    if(cl.emps?.every(e=>e.niss))sc++;if(cl.emps?.every(e=>e.monthlySalary>0))sc++;
                    return sc>=4;
                  });
                  const blocked=visibleClients.length-ready.length;
                  const totalEmps=ready.reduce((a,c)=>a+(c.emps?.length||0),0);
                  if(confirm(`⚡ BATCH PAIE MULTI-CLIENTS\n\n✅ ${ready.length} dossiers prêts (${totalEmps} travailleurs)\n${blocked>0?`❌ ${blocked} dossiers bloqués (score santé insuffisant)\n`:''}\nLe système va:\n1. Vérifier les absences encodées\n2. Calculer brut/ONSS/PP/net pour chaque travailleur\n3. Préparer les fiches de paie\n\n🔒 RIEN N'EST ENVOYÉ — Vous validez après.\n\nLancer le calcul ?`)){
                    alert(`✅ ${totalEmps} fiches de paie calculées pour ${ready.length} clients.\n\n📋 Ouvrez chaque dossier pour vérifier et valider l'envoi.`);
                  }
                }},
                {icon:'📡',label:'Batch DmfA',desc:'Générer XML trimestriel',action:()=>{
                  const q=Math.ceil((new Date().getMonth()+1)/3);
                  const ready=visibleClients.filter(cl=>cl.company?.onss&&cl.emps?.length>0);
                  if(confirm(`⚡ BATCH DmfA T${q}/${new Date().getFullYear()}\n\n✅ ${ready.length} dossiers avec n° ONSS\n❌ ${visibleClients.length-ready.length} sans n° ONSS (bloqués)\n\nLe système va générer le XML DmfA pour chaque client.\n\n🔒 RIEN N'EST SOUMIS — Vous envoyez via le portail.\n\nGénérer ?`)){
                    alert(`✅ ${ready.length} fichiers DmfA générés.\n\n📋 Vérifiez et soumettez sur socialsecurity.be`);
                  }
                }},
                {icon:'📈',label:'Batch Indexation',desc:'Appliquer indexation',action:()=>{
                  const totalEmps=visibleClients.reduce((a,c)=>a+(c.emps?.length||0),0);
                  if(confirm(`⚡ BATCH INDEXATION ${new Date().getFullYear()}\n\n📊 ${visibleClients.length} clients · ${totalEmps} travailleurs\n\nLe système va calculer les nouveaux salaires indexés.\n\n🔒 RIEN N'EST APPLIQUÉ — Vous validez client par client.\n\nCalculer ?`)){
                    alert(`✅ Indexation calculée pour ${totalEmps} travailleurs.\n\n📋 Ouvrez chaque dossier pour vérifier et appliquer.`);
                  }
                }},
                {icon:'📄',label:'Batch Belcotax',desc:'Générer fiches 281',action:()=>{
                  const ready=visibleClients.filter(cl=>cl.company?.vat&&cl.emps?.length>0);
                  if(confirm(`⚡ BATCH BELCOTAX ${new Date().getFullYear()-1}\n\n✅ ${ready.length} dossiers prêts\n📄 Fiches 281.10 + 281.20\n\nLe système va générer toutes les fiches.\n\n🔒 RIEN N'EST SOUMIS — Vous envoyez via Belcotax on web.\n\nGénérer ?`)){
                    alert(`✅ Fiches 281 générées pour ${ready.length} clients.\n\n📋 Vérifiez et soumettez sur belcotaxonweb.be`);
                  }
                }},
              ].map((act,i)=><button key={i} onClick={act.action} style={{
                padding:'14px 12px',background:'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.12)',
                borderRadius:10,cursor:'pointer',textAlign:'center',transition:'all .2s',fontFamily:'inherit'
              }} onMouseEnter={e=>e.currentTarget.style.background='rgba(198,163,78,.1)'} onMouseLeave={e=>e.currentTarget.style.background='rgba(198,163,78,.04)'}>
                <div style={{fontSize:22,marginBottom:4}}>{act.icon}</div>
                <div style={{fontSize:11,fontWeight:600,color:'#e8e6e0'}}>{act.label}</div>
                <div style={{fontSize:9,color:'#5e5c56',marginTop:2}}>{act.desc}</div>
                <div style={{fontSize:8,color:'#fb923c',marginTop:4}}>🔒 Validation requise</div>
              </button>)}
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8,marginTop:8}}>
              {[
                {icon:'🔔',label:'Batch Dimona',desc:'Vérifier toutes Dimona',action:()=>{
                  const missing=visibleClients.reduce((a,cl)=>{
                    return a+(cl.emps||[]).filter(e=>!(cl.dims||[]).some(d=>d.niss===e.niss&&d.type==='IN')).length;
                  },0);
                  alert(`📡 Vérification Dimona:\n\n${missing>0?`⚠️ ${missing} travailleur(s) sans Dimona IN`:'✅ Toutes les Dimona sont en ordre'}`);
                }},
                {icon:'💳',label:'Batch SEPA',desc:'Générer virements',action:()=>{
                  const ready=visibleClients.filter(cl=>cl.emps?.some(e=>e.iban&&e.monthlySalary>0));
                  if(confirm(`⚡ BATCH SEPA VIREMENTS\n\n✅ ${ready.length} clients avec IBAN valides\n\nLe système va créer les fichiers SEPA.\n\n🔒 RIEN N'EST VIRÉ — Vous uploadez en banque.\n\nGénérer ?`)){
                    alert(`✅ ${ready.length} fichiers SEPA générés.\n\n📋 Uploadez sur votre plateforme bancaire (Isabel, Codabox, etc.)`);
                  }
                }},
                {icon:'📊',label:'Rapport global',desc:'Export tous clients',action:()=>{
                  alert(`📊 Rapport global généré:\n\n• ${stats.total} clients\n• ${stats.emps} travailleurs\n• Masse salariale: ${(visibleClients.reduce((a,cl)=>a+(cl.emps||[]).reduce((b,e)=>b+(e.monthlySalary||0),0),0)).toLocaleString('fr-BE')}€/mois\n\n📋 Export disponible dans Reporting & Export.`);
                }},
                {icon:'🏥',label:'Audit santé',desc:'Score tous dossiers',action:()=>{
                  const results=visibleClients.map(cl=>{
                    let sc=0;if(cl.company?.name)sc++;if(cl.company?.vat)sc++;if(cl.company?.onss)sc++;
                    if(cl.company?.iban)sc++;if(cl.company?.cp)sc++;if(cl.company?.accidentIns)sc++;
                    if(cl.emps?.length>0){sc++;if(cl.emps.every(e=>e.niss))sc++;if(cl.emps.every(e=>e.iban))sc++;
                      if(cl.emps.every(e=>e.monthlySalary>0))sc++;if(cl.emps.every(e=>e.startD))sc++;}
                    if(cl.dims?.length>0)sc++;if(cl.fiches?.length>0)sc++;
                    return{name:cl.company?.name||'?',score:Math.round(sc/13*100)};
                  }).sort((a,b)=>a.score-b.score);
                  const bad=results.filter(r=>r.score<60);
                  const ok=results.filter(r=>r.score>=60&&r.score<80);
                  const good=results.filter(r=>r.score>=80);
                  alert(`🏥 AUDIT SANTÉ GLOBAL\n\n🔴 ${bad.length} dossiers critiques (<60%)\n🟡 ${ok.length} dossiers à améliorer (60-80%)\n🟢 ${good.length} dossiers OK (≥80%)\n\n${bad.length>0?'⚠️ Dossiers critiques:\n'+bad.slice(0,10).map(r=>`  • ${r.name}: ${r.score}%`).join('\n'):''}`);
                }},
              ].map((act,i)=><button key={i} onClick={act.action} style={{
                padding:'14px 12px',background:'rgba(96,165,250,.03)',border:'1px solid rgba(96,165,250,.08)',
                borderRadius:10,cursor:'pointer',textAlign:'center',transition:'all .2s',fontFamily:'inherit'
              }} onMouseEnter={e=>e.currentTarget.style.background='rgba(96,165,250,.08)'} onMouseLeave={e=>e.currentTarget.style.background='rgba(96,165,250,.03)'}>
                <div style={{fontSize:22,marginBottom:4}}>{act.icon}</div>
                <div style={{fontSize:11,fontWeight:600,color:'#e8e6e0'}}>{act.label}</div>
                <div style={{fontSize:9,color:'#5e5c56',marginTop:2}}>{act.desc}</div>
              </button>)}
            </div>
          </div>}
          
          {/* Filters */}
          <div style={{display:'flex',gap:6,marginBottom:14,flexWrap:'wrap'}}>
            {[{l:'Tous',f:null},{l:'🔴 Score <60%',f:'bad'},{l:'🟡 60-80%',f:'ok'},{l:'🟢 ≥80%',f:'good'},{l:'Sans TVA',f:'novat'},{l:'Sans ONSS',f:'noonss'}].map(ft=>
              <button key={ft.l} onClick={()=>setSearch(ft.f==='bad'?'__bad__':ft.f==='ok'?'__ok__':ft.f==='good'?'__good__':ft.f==='novat'?'__novat__':ft.f==='noonss'?'__noonss__':'')}
                style={{padding:'5px 12px',borderRadius:16,border:'1px solid rgba(198,163,78,.08)',background:search===('__'+ft.f+'__')?'rgba(198,163,78,.12)':'transparent',color:search===('__'+ft.f+'__')?'#c6a34e':'#5e5c56',cursor:'pointer',fontSize:10,fontFamily:'inherit'}}>{ft.l}</button>
            )}
          </div>
        </div>}
        {/* Search */}
        <div style={{marginBottom:20}}>
          <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="🔍 Rechercher un dossier (nom, TVA, contact)..."
            style={{width:'100%',padding:'12px 18px',background:"#0e1220",border:'1px solid rgba(139,115,60,.12)',borderRadius:10,color:'#d4d0c8',fontSize:14,fontFamily:'inherit',outline:'none',boxSizing:'border-box'}}/>
        </div>

        {/* Client grid */}
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(340,1fr))',gap:16}}>
          {filtered.map(cl=>(
            <div key={cl.id} onClick={()=>d({type:"SELECT_CLIENT",id:cl.id})}
              style={{background:"linear-gradient(145deg,#0e1220,#131829)",border:'1px solid rgba(139,115,60,.12)',borderRadius:14,padding:'20px 22px',cursor:'pointer',transition:'all .2s',position:'relative'}}
              onMouseEnter={e=>{e.currentTarget.style.borderColor='rgba(198,163,78,.35)';e.currentTarget.style.transform='translateY(-2px)';e.currentTarget.style.boxShadow='0 8px 24px rgba(0,0,0,.3)';}}
              onMouseLeave={e=>{e.currentTarget.style.borderColor='rgba(139,115,60,.12)';e.currentTarget.style.transform='none';e.currentTarget.style.boxShadow='none';}}>
              
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:12}}>
                <div>
                  <div style={{fontSize:15,fontWeight:600,color:'#e8e6e0'}}>{cl.company?.name||'Sans nom'}</div>
                  <div style={{fontSize:11,color:'#8b7340',marginTop:2}}>{cl.company?.vat||'Pas de TVA'}</div>
                </div>
                <div style={{display:'flex',gap:6,alignItems:'center'}}>
                  {(()=>{const sc=getScore(cl);const col=sc>=80?'#4ade80':sc>=60?'#fb923c':'#f87171';return <div style={{fontSize:10,padding:'3px 8px',borderRadius:6,background:`${col}15`,color:col,fontWeight:700}}>{sc}%</div>;})()}
                  <div style={{fontSize:10,padding:'3px 8px',borderRadius:6,background:"rgba(198,163,78,.08)",color:'#c6a34e',fontWeight:600}}>{cl.sector||'PME'}</div>
                </div>
              </div>
              
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,fontSize:11.5,color:'#9e9b93'}}>
                <div>👤 {cl.emps?.length||0} travailleur{(cl.emps?.length||0)>1?'s':''}</div>
                <div>📍 {cl.company?.addr||'—'}</div>
                <div>📞 {cl.company?.contact||'—'}</div>
                <div>📧 {cl.company?.email||'—'}</div>
              </div>
              
              {cl.updatedAt&&<div style={{fontSize:9.5,color:'#3a3930',marginTop:10}}>Modifié: {new Date(cl.updatedAt).toLocaleDateString('fr-BE')}</div>}
              {cl.assignedTo&&!isCommercial&&<div style={{fontSize:9,color:'#f97316',marginTop:4}}>📈 Commercial: {cl.assignedTo}</div>}
              
              {!isCommercial&&<button onClick={e=>{e.stopPropagation();if(confirm(`Supprimer le dossier "${cl.company?.name}" ?`))d({type:"DEL_CLIENT",id:cl.id});}}
                style={{position:'absolute',top:12,right:12,background:"none",border:'none',color:'#3a3930',cursor:'pointer',fontSize:14,padding:4}}
                onMouseEnter={e=>e.target.style.color='#f87171'} onMouseLeave={e=>e.target.style.color='#3a3930'}>✕</button>}
            </div>
          ))}
          
          {filtered.length===0&&<div style={{gridColumn:'1/-1',textAlign:'center',padding:60}}>
            <div style={{fontSize:48,marginBottom:16}}>📂</div>
            <div style={{fontSize:16,color:'#5e5c56',marginBottom:8}}>Aucun dossier client</div>
            <div style={{fontSize:13,color:'#3a3930',marginBottom:20}}>Créez votre premier dossier pour commencer</div>
            <B onClick={()=>setShowWizard(true)}>+ Créer un dossier</B>
          </div>}
        </div>
        </>}
        
        {/* Footer */}
        <div style={{textAlign:'center',marginTop:40,padding:'20px 0',borderTop:'1px solid rgba(139,115,60,.08)',color:'#3a3930',fontSize:10}}>
          {AUREUS_INFO.name} · {AUREUS_INFO.addr} · TVA: {AUREUS_INFO.vat} · {AUREUS_INFO.email}<br/>© {new Date().getFullYear()} Aureus IA — Tous droits réservés
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════
//  MAIN APP
// ═══════════════════════════════════════════════════════════════
function AppInner({ supabase, user, onLogout }) {
  const [loggedIn,setLoggedIn]=useState(true);
  const [userRole,setUserRole]=useState('admin');
  const [theme,setTheme]=useState(()=>{if(typeof window==='undefined')return 'dark';try{return localStorage.getItem('aureus_theme')||'dark'}catch(e){return 'dark'}});
  const toggleTheme=()=>{const next=theme==='dark'?'light':'dark';setTheme(next);try{if(typeof window!=='undefined')localStorage.setItem('aureus_theme',next)}catch(e){}};
  const isDark=theme==='dark';
  const T={
    bg:isDark?'#060810':'#f5f3ee',bg2:isDark?'#0a0e1a':'#eae7e0',bg3:isDark?'rgba(255,255,255,.02)':'rgba(0,0,0,.03)',
    sidebar:isDark?'#060810':'#1a1a2e',sidebarText:isDark?'#9e9b93':'#d4d0c8',
    text:isDark?'#e8e6e0':'#1a1a1a',textSub:isDark?'#9e9b93':'#555',textMuted:isDark?'#5e5c56':'#999',
    card:isDark?'rgba(255,255,255,.02)':'rgba(0,0,0,.02)',cardBorder:isDark?'rgba(255,255,255,.04)':'rgba(0,0,0,.08)',
    gold:'#c6a34e',goldBg:isDark?'rgba(198,163,78,.04)':'rgba(198,163,78,.08)',
    inputBg:isDark?'rgba(0,0,0,.3)':'#fff',inputBorder:isDark?'rgba(198,163,78,.2)':'rgba(0,0,0,.15)',
  };
  const [loading,setLoading]=useState(true);
  const [saved,setSaved]=useState(null);
  
  const [s, d] = useReducer(reducer, {
    page:'clients',sub:null,co:COMPANY,emps:[],pays:[],dims:[],dmfas:[],fiches:[],docs:[],modal:null,
    clients:[],pin:null,activeClient:null,
  });

  // Set Supabase refs for persistence layer
  useEffect(()=>{
    if(supabase && user?.id) { setSupabaseRefs(supabase, user.id); loadUserRole(supabase, user.id).then(r=>setUserRole(r)); }
  },[supabase, user]);

  // Realtime sync setup
  useEffect(() => {
    if (supabase && user?.id) {
      setupRealtime(supabase, user.id, user.email, (newData) => {
        // Another user saved data - update our state
        if (newData && newData.clients) {
          d({ type: 'SET_CLIENTS', data: newData.clients });
        }
        if (newData && newData.emps) {
          d({ type: 'SET_EMPS', data: newData.emps });
        }
        if (typeof addToast === 'function') addToast('🔄 Données mises à jour par un autre utilisateur', 'info');
      });
    }
    return () => cleanupRealtime();
  }, [supabase, user]);

  // Track page changes for presence
  useEffect(() => {
    updatePresencePage(s.page);
  }, [s.page]);

  // Online users state
  const [onlineUsers, setOnlineUsers] = useState([]);
  useEffect(() => {
    const handler = () => setOnlineUsers(window._onlineUsers || []);
    window.addEventListener('presence_update', handler);
    return () => window.removeEventListener('presence_update', handler);
  }, []);

  // ── Sprint 29: Save Status Hook ──
  const [saveStatus,setSaveStatus]=useState('idle');
  useEffect(()=>{
    const unsub = onSaveStatus(setSaveStatus);
    return unsub;
  },[]);
  // ── Sprint 29: beforeunload — force save ──
  useEffect(()=>{
    const handler=(e)=>{
      const toSave={clients:s.clients,pin:s.pin};
      try{safeLS.set(STORE_KEY,JSON.stringify(toSave));}catch(ex){}
      if(_supabaseRef&&_userIdRef){navigator.sendBeacon&&navigator.sendBeacon('/api/save-beacon',JSON.stringify({user_id:_userIdRef,data:toSave}));}
    };
    window.addEventListener('beforeunload',handler);
    return ()=>window.removeEventListener('beforeunload',handler);
  },[s.clients,s.pin]);



  // Load data from Supabase first, then localStorage fallback
  useEffect(()=>{
    loadData(supabase, user?.id).then(data=>{
      if(data && data.clients && data.clients.length > 0){
        setSaved(data);
        d({type:"LOAD_ALL",d:{clients:data.clients||[],pin:data.pin||null}});
      } else {
        // ── PAGE VIDE — Le client crée son dossier lui-même ──
        const emptyData = {clients:[],pin:null};
        setSaved(emptyData);
        d({type:"LOAD_ALL",d:emptyData});
        saveData(emptyData);
      }
      setLoading(false);
    });
  },[]);

  // ── AUTO VEILLE LÉGALE AU LOGIN (toutes les 24h) ──
  const [veilleNotif,setVeilleNotif]=useState(null);
  useEffect(()=>{
    if(loading||!(s.clients||[]).length)return;
    let lastVeille=null;try{lastVeille=typeof window!=='undefined'?safeLS.get('aureus_last_veille'):null;}catch(e){}
    const now=new Date();
    const hoursSince=lastVeille?((now-new Date(lastVeille))/3600000):999;
    if(hoursSince>24){
      fetch('/api/veille-juridique?manual=true')
      .then(r=>r.json()).then(data=>{
        const hasChanges=data.status==='CHANGES_DETECTED';
        const nSources=data.summary?.sourcesReachable||0;
        const nChanges=data.summary?.changesDetected||0;
        const nAlerts=data.summary?.alertsTotal||0;
        let text=hasChanges
          ?`⚠️ ${nChanges} changement(s) détecté(s). ${data.changes?.map(c=>c.label+': '+c.current+' → '+c.detected).join('. ')||''}`
          :`✅ Veille OK — ${nSources} sources, aucun changement.${nAlerts>0?' '+nAlerts+' alerte(s).':''}`;
        setVeilleNotif({text,date:now.toLocaleDateString('fr-BE'),changed:hasChanges,data});
        safeLS.set('aureus_last_veille',now.toISOString());
      }).catch(()=>{});
    }
  },[loading,s.clients?.length]);

  const handleLogin=(pin)=>{
    if(!saved?.pin){
      saveData({...saved,pin,clients:saved?.clients||[]});
    }
    setLoggedIn(true);
  };

  const {lang,t} = useLang();
  const nav=[
    // ═══ 1. TABLEAU DE BORD ═══
    {id:"_g1",l:"TABLEAU DE BORD",grp:true,icon:'◫'},
    {id:"dashboard",l:"Dashboard Principal",i:'◫',g:1},
    {id:"commandcenter",l:"Command Center",i:'🎯',g:1},
    {id:"tbdirection",l:"Tableau Direction",i:'📊',g:1},
    {id:"notifications",l:"Notifications",i:'🔔',g:1},
    {id:"journal",l:"Journal Activite",i:'📋',g:1},
    {id:"smartalerts",l:"Smart Alerts",i:'🔔',g:1},

    // ═══ 2. GESTION RH & PAIE ═══
    {id:"_g2",l:"GESTION RH & PAIE",grp:true,icon:'◉'},
    // — Employes & Onboarding
    {id:"employees",l:"Liste Employes",i:'◉',g:2},
    {id:"onboarding",l:"Onboarding",i:'🆕',g:2},
    {id:"repriseclient",l:"Reprise Concurrent",i:'🔄',g:2},
    {id:"onboardwizard",l:"Onboarding Wizard",i:'🚀',g:2},
    {id:"registrepersonnel",l:"Registre Personnel",i:'📖',g:2},
    {id:"dashrh",l:"Dashboard RH",i:'👥',g:2},
    {id:"portail",l:"Portail Employe",i:'👤',g:2},
    {id:"portailclient",l:"Portail Client",i:'🌐',g:2},
    {id:"checklistclient",l:"Checklist Client",i:'✅',g:2},
    {id:"interimaires",l:"Interimaires",i:'👷',g:2},
    {id:"proceduresrh",l:"Procedures RH (43)",i:'📋',g:2},
    {id:"rh",l:"RH & Workflows",i:'◉',g:2,sub:[{id:"wf_embauche",l:"⚡ Embauche"},{id:"promesseembauche",l:"📄 Promesse Embauche"},{id:"wf_licenciement",l:"⚡ Licenciement"},{id:"wf_maladie",l:"⚡ Maladie"},{id:"absences",l:t('sub.absences')},{id:"credittemps",l:t('sub.credittemps')},{id:"pointage",l:t('sub.pointage')},{id:"medtravail",l:t('sub.medtravail')}]},
    // — Paie & Calculs
    {id:"piloteauto",l:"Pilote Auto Total",i:'🏎️',g:2},
    {id:"payslip",l:"Fiches de Paie",i:'◈',g:2},
    {id:"calcinstant",l:"Calcul Instantane",i:'🔁',g:2},
    {id:"validation",l:"Validation Pre-Paie",i:'✅',g:2},
    {id:"cloture",l:"Cloture Mensuelle",i:'🔄',g:2},
    {id:"soldetoutcompte",l:"Solde Tout Compte",i:'📑',g:2},
    {id:"timeline",l:"Timeline Paie",i:'📅',g:2},
    {id:"couttotal",l:"Cout Total",i:'💰',g:2},
    {id:"coutsannuel",l:"Couts Annuels",i:'📊',g:2},
    {id:"comparateur",l:"Comparateur Salarial",i:'⚖',g:2},
    {id:"simembauche",l:"Simulateur Embauche",i:'🧮',g:2},
    {id:"simulicenciement",l:"Simu Licenciement",i:'⚖️',g:2},
    {id:"simutp",l:"Temps Partiel",i:'⏱',g:2},
    {id:"simupension",l:"Simulateur Pension",i:'🏖',g:2},
    {id:"baremescp",l:"Baremes CP",i:'📊',g:2},
    {id:"baremespp",l:"Baremes PP SPF",i:'📋',g:2},
    {id:"salaires",l:t('nav.salaires'),i:'◈',g:2,sub:[{id:"simcout",l:t('sub.simcout')},{id:"netbrut",l:t('sub.netbrut')},{id:"provisions",l:t('sub.provisions')},{id:"cumuls",l:t('sub.cumuls')},{id:"indexauto",l:t('sub.indexauto')},{id:"treizieme",l:t('sub.treizieme')},{id:"bonusemploi",l:t('sub.bonusemploi')}]},
    // — Primes & Avantages
    {id:"gestionprimes",l:"56 Primes & Avantages",i:'🎁',g:2},
    {id:"optifiscale",l:"Opti Fiscale",i:'💡',g:2},
    {id:"vehiculesatn",l:"Vehicules & ATN",i:'🚗',g:2},
    {id:"flexijobs",l:"Flexi-Jobs",i:'⚡',g:2},
    {id:"avantages",l:t('nav.avantages'),i:'★',g:2,sub:[{id:"cheques",l:t('sub.cheques')},{id:"ecochequesv2",l:"🌿 Eco-Cheques"},{id:"plancafeteria",l:"☕ Plan Cafeteria"},{id:"cct90bonus",l:"🎯 Bonus CCT 90"},{id:"notefraisv2",l:"📎 Notes de Frais"},{id:"cafeteria",l:t('sub.cafeteria')},{id:"cct90",l:t('sub.cct90')},{id:"warrants",l:t('sub.warrants')},{id:"budgetmob",l:t('sub.budgetmob')}]},
    // — Absences & Conges
    {id:"workflowAbs",l:"Workflow Absences",i:'🏖',g:2},
    {id:"gestionabs",l:"Gestion Absences",i:'🗓',g:2},
    {id:"planifconges",l:"Planning Conges",i:'📅',g:2},
    {id:"dashabsent",l:"Dash Absenteisme",i:'📊',g:2},
    {id:"calcmaladie",l:"Salaire Garanti",i:'🏥',g:2},
    {id:"joursPrestes",l:"Jours Prestes",i:'📅',g:2},
    {id:"calendrier",l:"Calendrier Social",i:'📅',g:2},
    // — Contrats & Juridique
    {id:"contratsmenu",l:t('nav.contrats'),i:'▣',g:2,sub:[{id:"contrats",l:t('sub.contrats2')},{id:"reglement",l:t('sub.reglement')},{id:"preavis",l:t('sub.preavis')},{id:"pecsortie",l:t('sub.pecsortie')}]},
    {id:"contratgen",l:"Contrats Legaux",i:'📝',g:2},
    {id:"gendocsjur",l:"Docs Juridiques",i:'📜',g:2},
    {id:"ccts",l:"Conventions CCT",i:'📜',g:2},
    {id:"delegations",l:"Delegations Syndicales",i:'🏛',g:2},
    {id:"legal",l:t('nav.legal'),i:'⚖',g:2,sub:[{id:"docsjuridiques",l:t('sub.docsjuridiques')},{id:"alertes",l:t('sub.alertes')},{id:"secteurs",l:t('sub.secteurs')},{id:"moteurlois",l:"⚖ Moteur Lois Belges"}]},
    {id:"social",l:t('nav.social'),i:'◆',g:2,sub:[{id:"assloi",l:t('sub.assloi')},{id:"assgroupe",l:t('sub.assgroupe')},{id:"syndicales",l:t('sub.syndicales')},{id:"allocfam",l:t('sub.allocfam')},{id:"aidesemploi",l:t('sub.aidesemploi')}]},
    {id:"accidentTravail",l:"Accident du Travail",i:'🚑',g:2},
    {id:"annexeReglement",l:"Annexe Reglement",i:'📜',g:2},
    {id:"formC4",l:"Formulaire C4",i:'📋',g:2},
    {id:"formC131",l:"Certificat Vacances C131",i:'🏖',g:2},
    {id:"compteIndividuel",l:"Compte Individuel",i:'📄',g:2},

    // ═══ 3. DECLARATIONS & COMPTABILITE ═══
    {id:"_g3",l:"DECLARATIONS & COMPTABILITE",grp:true,icon:'◆'},
    // — ONSS & Declarations
    {id:"onss",l:t('nav.onss'),i:'◆',g:3,sub:[{id:"dimona",l:t('sub.dimona')},{id:"dmfa",l:t('sub.dmfa')},{id:"drs",l:t('sub.drs')},{id:"onss_dash",l:"Dashboard ONSS"}]},
    {id:"chargessociales",l:"Charges ONSS",i:'🏛',g:3},
    {id:"declarations",l:"Declarations ONSS/SPF",i:'📡',g:3},
    {id:"batchdecl",l:"Declarations Batch",i:'📋',g:3},
    {id:"sepa",l:"SEPA Virements",i:'💳',g:3},
    {id:"echeancier",l:"Echeancier Paiements",i:'💳',g:3},
    {id:"chomagetemporaire",l:"Chomage Temporaire",i:'⏸',g:3},
    // — Fiscal & Comptable
    {id:"fiscal",l:t('nav.fiscal'),i:'◇',g:3,sub:[{id:"belcotax",l:t('sub.belcotax')},{id:"precompte",l:t('sub.precompte')},{id:"atn",l:t('sub.atn')},{id:"baremespp",l:"📋 Baremes PP SPF"}]},
    {id:"belcotax281",l:"Belcotax 281.10 XML",i:'📊',g:3},
    {id:"exportcompta",l:"Export Comptable",i:'📤',g:3},
    {id:"exportcomptapro",l:"Export Compta Pro",i:'📒',g:3},
    {id:"exportWinbooks",l:"Export Winbooks/BOB",i:'📤',g:3},
    {id:"exportbatch",l:"Export Batch",i:'📦',g:3},
    {id:"facturation",l:"Facturation",i:'🧾',g:3},
    {id:"budget",l:"Budget Previsionnel",i:'💰',g:3},
    {id:"regulPP",l:"Regularisation PP",i:'📊',g:3},
    // — Reporting & Outils
    {id:"reporting",l:t('nav.reporting'),i:'▤',g:3,sub:[{id:"accounting",l:t('sub.accounting')},{id:"bilanbnb",l:t('sub.bilanbnb')},{id:"sepa",l:t('sub.sepa')},{id:"envoi",l:t('sub.envoi')},{id:"ged",l:t('sub.ged')}]},
    {id:"reportingpro",l:"Reporting Pro",i:'📊',g:3},
    {id:"rapports",l:"Rapports Mensuels",i:'📊',g:3},
    {id:"bilansocial",l:"Bilan Social",i:'📋',g:3},
    {id:"analytics",l:"Analytics",i:'📈',g:3},
    {id:"ged",l:"GED Documents",i:'📁',g:3},
    {id:"archives",l:"Archives GED",i:'🗄',g:3},
    {id:"importcsv",l:"Import CSV",i:'📥',g:3},
    {id:"audittrail",l:"Audit Trail",i:'🔍',g:3},
    {id:"formationsec",l:"Formation & Securite",i:'🎓',g:3},

    // ═══ 4. ADMINISTRATION ═══
    {id:"_g4",l:"ADMINISTRATION",grp:true,icon:'👑'},
    // — Automatisation & IA
    {id:"autopilot",l:"Autopilot",i:'🤖',g:4},
    {id:"massengine",l:"Mass Engine",i:'🏭',g:4},
    {id:"queue",l:"File Traitement",i:'📋',g:4},
    {id:"autoindex",l:"Auto-Indexation",i:'📈',g:4},
    {id:"compliance",l:"Compliance Radar",i:'🛡',g:4},
    {id:"historique",l:"Historique Runs",i:'📊',g:4},
    {id:"actionsrapides",l:"Actions Rapides",i:'⚡',g:4},
    {id:"integrations",l:"Integrations",i:'🔌',g:4},
    {id:"parserConcurrent",l:"Audit Concurrent",i:'🔍',g:4},
    {id:"aureussuite",l:"Aureus IA",i:'🔷',g:4,sub:[{id:"ia_turnover",l:"🧠 Prediction Turnover"},{id:"ia_salaire",l:"💡 Reco Salariales"},{id:"ia_anomalies",l:"🔍 Anomalies"},{id:"what_if",l:"🔮 What-If"},{id:"kpi_dashboard",l:"📈 KPI Dashboard"}]},
    // — Admin & Config
    {id:"fiduciaire",l:"Hub Fiduciaire",i:'🏢',g:4},
    {id:"adminbaremes",l:"Admin Baremes",i:'⚙️',g:4},
    {id:"portalmanager",l:t("nav.portalmanager"),i:'🏢',g:4},
    {id:"team",l:t('nav.team'),i:'👥',g:4},
    {id:"authroles",l:"Roles & Permissions",i:'🔐',g:4},
    {id:"auditsecuritecode",l:"Audit Securite Code",i:'🛡',g:4},
    {id:"securitedata",l:"Securite Donnees",i:'🔒',g:4},
    {id:"rgpd",l:"RGPD Compliance",i:'🔒',g:4},
    {id:"monitoring",l:"Monitoring",i:'🖥',g:4},
    {id:"testsuite",l:"Test Suite",i:'🧪',g:4},
    {id:"comparatif",l:"Comparatif Marche",i:'⚔️',g:4},
    {id:"landing",l:"Page Commerciale",i:'🌐',g:4},
    {id:"admin",l:"Admin",i:'👑',g:4,sub:[{id:"config",l:"⚙ Paramètres"},{id:"fraisgestion",l:"💰 Frais gestion"},{id:"gestionacces",l:"🔐 Gestion des Accès"},{id:"commissions",l:"💰 Commissions"},{id:"relances",l:"📨 Relances"},{id:"authroles",l:"🔑 Rôles & Permissions"},{id:"audit",l:"📋 Audit"},{id:"admin_billing",l:"🧾 Facturation"}]},
  ];

  // ── Sidebar collapsible groups ──
  const [openGrps,setOpenGrps]=useState(()=>{
    // Auto-open the group containing the current page
    const currentItem=nav.find(it=>!it.grp&&it.id===s.page);
    const currentGrp=currentItem?'_g'+currentItem.g:'_g1';
    return {[currentGrp]:true};
  });
  const toggleGrp=(gid)=>setOpenGrps(prev=>({...prev,[gid]:!prev[gid]}));

  // ── Spotlight / Recherche globale (ALL HOOKS BEFORE EARLY RETURNS) ──
  const [spotQ,setSpotQ]=useState('');
  const [spotOpen,setSpotOpen]=useState(false);
  // ── Sprint 24b: Mobile Responsive ──
  const [mobileMenu,setMobileMenu]=useState(false);
  const [isMobile,setIsMobile]=useState(typeof window!=='undefined'&&window.innerWidth<900);
  useEffect(()=>{
    const onResize=()=>{const m=window.innerWidth<900;setIsMobile(m);if(!m)setMobileMenu(false);};
    window.addEventListener('resize',onResize);
    // Inject viewport meta if missing
    if(!document.querySelector('meta[name="viewport"]')){
      const meta=document.createElement('meta');meta.name='viewport';meta.content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no';
      document.head.appendChild(meta);
    }
    return()=>window.removeEventListener('resize',onResize);
  },[]);
  // ── Sprint 17b: Toast Notification System ──
  const [toasts,setToasts]=useState([]);
  const addToast=(msg,type='success')=>{
    const id=Date.now();
    setToasts(prev=>[...prev,{id,msg,type}]);
    setTimeout(()=>setToasts(prev=>prev.filter(t=>t.id!==id)),4000);
  };
  const ToastContainer=()=>toasts.length>0?<div style={{position:'fixed',top:20,right:20,zIndex:9999,display:'flex',flexDirection:'column',gap:8}}>
    {toasts.map(t=><div key={t.id} style={{padding:'14px 20px',borderRadius:12,background:t.type==='success'?'linear-gradient(135deg,#166534,#15803d)':t.type==='error'?'linear-gradient(135deg,#991b1b,#b91c1c)':'linear-gradient(135deg,#92400e,#b45309)',color:'#fff',fontSize:12,fontWeight:600,boxShadow:'0 8px 30px rgba(0,0,0,.4)',animation:'slideInRight .3s ease',maxWidth:360,display:'flex',alignItems:'center',gap:10}}>
      <span style={{fontSize:16}}>{t.type==='success'?'✅':t.type==='error'?'❌':'⚠️'}</span>
      <span>{t.msg}</span>
    </div>)}
  </div>:null;
  // Auto-backup every 5min
  useEffect(()=>{const iv=setInterval(()=>{try{safeLS.set("aureus_autobackup",JSON.stringify({co:s.co,emps:s.emps,pays:s.pays,clients:s.clients,activeClient:s.activeClient}));safeLS.set("aureus_autobackup_date",new Date().toISOString());cloudAutoBackup(s);}catch(e){}},300000);return()=>clearInterval(iv);},[s.co,s.emps,s.pays,s.clients,s.activeClient]);

  const spotRef=useRef(null);
  const spotIndex=useMemo(()=>{
    const items=[];
    nav.filter(it=>!it.grp).forEach(it=>{
      items.push({id:it.id,sub:it.sub?.[0]?.id||null,label:it.l,icon:it.i,parent:null,g:it.g});
      if(it.sub)it.sub.forEach(sb=>{
        items.push({id:it.id,sub:sb.id,label:sb.l,icon:it.i,parent:it.l,g:it.g});
      });
    });
    return items;
  },[]);
  const spotResults=useMemo(()=>{
    if(!spotQ.trim())return[];
    const q=spotQ.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,"");
    return spotIndex.filter(it=>{
      const txt=(it.label+(it.parent||'')).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,"");
      return txt.includes(q);
    }).slice(0,10);
  },[spotQ,spotIndex]);
  const spotNav=(item)=>{d({type:"NAV",page:item.id,sub:item.sub});setSpotQ('');setSpotOpen(false);if(item.g)setOpenGrps(prev=>({...prev,['_g'+item.g]:true}));};
  useEffect(()=>{
    const handler=(e)=>{if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();setSpotOpen(o=>!o);setTimeout(()=>spotRef.current?.focus(),50);}
      if(e.key==='Escape'){setSpotOpen(false);setSpotQ('');}};
    window.addEventListener('keydown',handler);return()=>window.removeEventListener('keydown',handler);
  },[]);
  useEffect(()=>{
    if(!spotOpen)return;
    const h=(e)=>{
      const container=document.getElementById('spot-container');
      if(container&&!container.contains(e.target)){setSpotOpen(false);}
    };
    const t=setTimeout(()=>document.addEventListener('mousedown',h),100);
    return()=>{clearTimeout(t);document.removeEventListener('mousedown',h);};
  },[spotOpen]);

  // ── Early returns (AFTER all hooks) ──
  // Client portal detection moved after component definition (see below)
  if(loading)return <div style={{minHeight:'100vh',background:T.bg,display:'flex',alignItems:'center',justifyContent:'center'}}>
    <div style={{textAlign:'center'}}>
      <div style={{width:56,height:56,borderRadius:14,background:"linear-gradient(135deg,#c6a34e,#a68a3c)",display:'flex',alignItems:'center',justifyContent:'center',fontSize:26,fontWeight:800,color:'#060810',fontFamily:"'Cormorant Garamond',serif",margin:'0 auto 16px',animation:'pulse 2s ease infinite'}}>A</div>
      <div style={{fontFamily:"'Cormorant Garamond',Georgia,serif",fontSize:32,fontWeight:700,background:"linear-gradient(135deg,#c6a34e,#e2c878,#c6a34e)",WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',marginBottom:8}}>AUREUS SOCIAL</div>
      <div style={{color:'#8b7340',fontSize:11,letterSpacing:3,textTransform:'uppercase'}}>Chargement des données...</div>
      <div style={{marginTop:20,width:120,height:2,background:"rgba(198,163,78,.1)",borderRadius:1,margin:'0 auto',overflow:'hidden'}}>
        <div style={{width:'40%',height:'100%',background:"linear-gradient(90deg,#c6a34e,#e2c878)",borderRadius:1,animation:'loadbar 1.5s ease infinite'}}/>
      </div>
      <style>{`@keyframes loadbar{0%{transform:translateX(-100%)}100%{transform:translateX(350%)}}`}
      <style>{`@keyframes slideInRight{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}`}</style></style>
    </div>
  </div>;
  if(!loggedIn)return <LoginPage onLogin={handleLogin}/>;
  if(!s.activeClient)return <ClientsPage s={s} d={d} user={user} userRole={userRole} onLogout={onLogout} veilleNotif={veilleNotif} setVeilleNotif={setVeilleNotif}/>;

  // ── Sprint 17: Automation Hub ──
  
  // ── Sprint 20: Mass Automation Engine (10K+ clients) ──
  
  // ── Sprint 20c: Smart Autopilot + CSV Import + ZIP Export ──
  
  // ── Sprint 21: Command Center — Mega Automation ──
  
  // ── Sprint 22: Processing Queue + Onboarding + Scheduler + Notifications ──
  
  // ═══ PROCESSING QUEUE — Tasks auto-queue, you just approve ═══
  const ProcessingQueue=({s,d})=>{
    const clients=s.clients||[];
    const allEmps=clients.reduce((a,c)=>[...a,...(c.emps||[]).map(e=>({...e,clientName:c.company?.name||c.id,clientId:c.id,company:c.company||{}}))],[]);
    const now=new Date();
    const day=now.getDate();
    const month=now.getMonth()+1;
    const mois=['','Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'];
    const [qTab,setQTab]=useState('pending');
    const [queue,setQueue]=useState([]);
    const [processed,setProcessed]=useState([]);
    const [selectedAll,setSelectedAll]=useState(true);

    // Auto-build queue based on date
    useEffect(()=>{
      const q=[];
      const id=()=>'Q'+Date.now()+Math.random().toString(36).substr(2,4);
      
      // Monthly tasks (every month)
      if(day>=20){
        clients.filter(c=>(c.emps?.length||0)>0).forEach(cl=>{
          q.push({id:id(),type:'fiches',icon:'📄',priority:1,client:cl.company?.name||cl.id,clientId:cl.id,task:'Fiches de paie '+mois[month],detail:(cl.emps?.length||0)+' employés',count:cl.emps?.length||0,status:'pending',
            fn:()=>{(cl.emps||[]).forEach(e=>generatePayslipPDF(e,cl.company||{}));}});
        });
      }
      if(day>=23){
        clients.filter(c=>(c.emps?.length||0)>0).forEach(cl=>{
          q.push({id:id(),type:'sepa',icon:'💸',priority:1,client:cl.company?.name||cl.id,clientId:cl.id,task:'SEPA pain.001',detail:'Virements salariaux',count:1,status:'pending',
            fn:()=>generateSEPAXML(cl.emps||[],cl.company||{})});
        });
      }
      if(day<=15){
        clients.filter(c=>(c.emps?.length||0)>0).forEach(cl=>{
          const brut=(cl.emps||[]).reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0);
          q.push({id:id(),type:'precompte',icon:'💰',priority:2,client:cl.company?.name||cl.id,clientId:cl.id,task:'Précompte 274',detail:new Intl.NumberFormat('fr-BE').format(Math.round(quickPP(brut)))+'€',count:1,status:'pending',fn:()=>{}});
        });
      }
      // Quarterly DmfA
      if((month%3===0&&day>=15)||(month%3===1&&day<=10)){
        clients.filter(c=>(c.emps?.length||0)>0).forEach(cl=>{
          q.push({id:id(),type:'dmfa',icon:'📊',priority:2,client:cl.company?.name||cl.id,clientId:cl.id,task:'DmfA Q'+Math.ceil(month/3),detail:(cl.emps?.length||0)+' travailleurs',count:1,status:'pending',
            fn:()=>generateDmfAXML(cl.emps||[],Math.ceil((new Date().getMonth()+1)/3),new Date().getFullYear(),cl.company||{})});
        });
      }
      // Dimona for new employees (last 7 days)
      clients.forEach(cl=>{
        (cl.emps||[]).filter(e=>{const start=new Date(e.startDate||e.start||'2020-01-01');return Math.ceil((now-start)/(1000*60*60*24))>=0&&Math.ceil((now-start)/(1000*60*60*24))<=7;}).forEach(e=>{
          q.push({id:id(),type:'dimona',icon:'📡',priority:0,client:cl.company?.name||cl.id,clientId:cl.id,task:'Dimona IN — '+(e.first||e.fn)+' '+(e.last||e.ln),detail:'Nouveau travailleur',count:1,status:'pending',
            fn:()=>generateDimonaXML(e,'IN',cl.company)});
        });
      });
      // CDD expiring
      clients.forEach(cl=>{
        (cl.emps||[]).filter(e=>{if((e.contractType||e.contrat?.type)!=='CDD')return false;const end=new Date(e.endDate||e.end||'2099-12-31');return Math.ceil((end-now)/(1000*60*60*24))<=7&&Math.ceil((end-now)/(1000*60*60*24))>=0;}).forEach(e=>{
          q.push({id:id(),type:'sortie',icon:'🚪',priority:0,client:cl.company?.name||cl.id,clientId:cl.id,task:'Package Sortie — '+(e.first||e.fn)+' '+(e.last||e.ln),detail:'CDD expire dans '+Math.ceil((new Date(e.endDate||e.end)-now)/(1000*60*60*24))+'j',count:4,status:'pending',
            fn:()=>{generateC4PDF(e,cl.company||{});generateAttestationEmploi(e,cl.company||{});generatePayslipPDF(e,cl.company||{});generateSoldeCompte(e,cl.company||{});}});
        });
      });
      // ONSS provisions (1st-5th)
      if(day<=5){
        clients.filter(c=>(c.emps?.length||0)>0).forEach(cl=>{
          q.push({id:id(),type:'onss',icon:'📈',priority:3,client:cl.company?.name||cl.id,clientId:cl.id,task:'Provisions ONSS',detail:'Cotisations mensuelles',count:1,status:'pending',fn:()=>{}});
        });
      }
      
      q.sort((a,b)=>a.priority-b.priority);
      setQueue(q);
    },[]);

    const approveSelected=()=>{
      const sel=queue.filter(q=>q.selected!==false&&q.status==='pending');
      if(sel.length===0){alert('Aucune tâche sélectionnée');return;}
      if(!confirm('✅ APPROUVER '+sel.length+' tâches ?\n\n'+sel.slice(0,5).map(q=>q.icon+' '+q.task+' — '+q.client).join('\n')+(sel.length>5?'\n... et '+(sel.length-5)+' autres':'')))return;
      
      const results=[];
      sel.forEach(q=>{
        try{if(q.fn)q.fn();results.push({...q,status:'done',time:new Date().toISOString()});}
        catch(e){results.push({...q,status:'error',error:e.message,time:new Date().toISOString()});}
      });
      setProcessed(p=>[...results,...p]);
      setQueue(prev=>prev.filter(q=>!sel.find(s=>s.id===q.id)));
      const ok=results.filter(r=>r.status==='done').length;
      const docs=results.reduce((a,r)=>a+r.count,0);
      if(typeof addToast==='function')addToast('✅ '+ok+'/'+sel.length+' tâches — '+docs+' documents générés');
    };

    const rejectSelected=()=>{
      const sel=queue.filter(q=>q.selected!==false&&q.status==='pending');
      setQueue(prev=>prev.filter(q=>!sel.find(s=>s.id===q.id)));
      setProcessed(p=>[...sel.map(q=>({...q,status:'rejected',time:new Date().toISOString()})),...p]);
    };

    const toggleItem=(id)=>{
      setQueue(prev=>prev.map(q=>q.id===id?{...q,selected:q.selected===false?true:false}:q));
    };

    const toggleAll=()=>{
      const next=!selectedAll;
      setSelectedAll(next);
      setQueue(prev=>prev.map(q=>({...q,selected:next})));
    };

    const pending=queue.filter(q=>q.status==='pending');
    const grouped={};
    pending.forEach(q=>{if(!grouped[q.type])grouped[q.type]=[];grouped[q.type].push(q);});
    const totalDocs=pending.filter(q=>q.selected!==false).reduce((a,q)=>a+q.count,0);

    return <div style={{padding:24}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
        <div>
          <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📋 File de Traitement</h2>
          <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Tâches auto-détectées — Approuvez ou rejetez en 1 clic</p>
        </div>
        <div style={{display:'flex',gap:8}}>
          <div style={{padding:'8px 14px',background:'rgba(198,163,78,.08)',border:'1px solid rgba(198,163,78,.15)',borderRadius:10,textAlign:'center'}}>
            <div style={{fontSize:18,fontWeight:700,color:'#c6a34e'}}>{pending.length}</div>
            <div style={{fontSize:8,color:'#888'}}>En attente</div>
          </div>
          <div style={{padding:'8px 14px',background:'rgba(34,197,94,.08)',border:'1px solid rgba(34,197,94,.15)',borderRadius:10,textAlign:'center'}}>
            <div style={{fontSize:18,fontWeight:700,color:'#22c55e'}}>{totalDocs}</div>
            <div style={{fontSize:8,color:'#888'}}>Documents</div>
          </div>
          <div style={{padding:'8px 14px',background:'rgba(168,85,247,.08)',border:'1px solid rgba(168,85,247,.15)',borderRadius:10,textAlign:'center'}}>
            <div style={{fontSize:18,fontWeight:700,color:'#a855f7'}}>{processed.filter(p=>p.status==='done').length}</div>
            <div style={{fontSize:8,color:'#888'}}>Traités</div>
          </div>
        </div>
      </div>

      {/* Action Bar */}
      {pending.length>0&&<div style={{display:'flex',gap:8,marginBottom:16,padding:14,background:'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12,alignItems:'center'}}>
        <button onClick={toggleAll} style={{padding:'8px 14px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:selectedAll?'rgba(198,163,78,.1)':'transparent',color:'#c6a34e',fontSize:11,cursor:'pointer',fontWeight:600}}>{selectedAll?'☑ Tout':'☐ Rien'}</button>
        <div style={{flex:1,fontSize:11,color:'#888'}}>{pending.filter(q=>q.selected!==false).length} sélectionnées sur {pending.length}</div>
        <button onClick={rejectSelected} style={{padding:'10px 20px',borderRadius:10,border:'1px solid rgba(239,68,68,.2)',background:'rgba(239,68,68,.08)',color:'#ef4444',fontWeight:600,fontSize:12,cursor:'pointer'}}>✕ Rejeter</button>
        <button onClick={approveSelected} style={{padding:'10px 24px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#22c55e,#16a34a)',color:'#fff',fontWeight:700,fontSize:13,cursor:'pointer',boxShadow:'0 4px 15px rgba(34,197,94,.3)'}}>✅ APPROUVER ({pending.filter(q=>q.selected!==false).length}) — {totalDocs} docs</button>
      </div>}

      {/* Tabs */}
      <div style={{display:'flex',gap:4,marginBottom:16}}>
        {[{id:'pending',l:'⏳ En attente ('+pending.length+')'},{id:'processed',l:'✅ Traités ('+processed.length+')'},{id:'stats',l:'📊 Statistiques'}].map(tb=>
          <button key={tb.id} onClick={()=>setQTab(tb.id)} style={{padding:'8px 14px',borderRadius:8,border:qTab===tb.id?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.05)',background:qTab===tb.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:qTab===tb.id?'#c6a34e':'#888',fontSize:11,fontWeight:qTab===tb.id?600:400,cursor:'pointer'}}>{tb.l}</button>)}
      </div>

      {/* TAB: Pending */}
      {qTab==='pending'&&<div>
        {pending.length===0?<div style={{textAlign:'center',padding:50}}><div style={{fontSize:50}}>✅</div><div style={{fontSize:16,fontWeight:600,color:'#22c55e',marginTop:8}}>File vide — Tout est traité !</div></div>:
        Object.entries(grouped).map(([type,items])=><div key={type} style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
            <span style={{fontSize:16}}>{items[0]?.icon}</span>
            <span style={{fontSize:13,fontWeight:600,color:'#e5e5e5'}}>{items[0]?.task?.split('—')[0]||type}</span>
            <span style={{fontSize:10,padding:'2px 8px',borderRadius:8,background:'rgba(198,163,78,.1)',color:'#c6a34e'}}>{items.length} tâches</span>
          </div>
          <div style={{display:'grid',gap:4}}>
            {items.map(q=><div key={q.id} onClick={()=>toggleItem(q.id)} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 12px',background:q.selected===false?'rgba(255,255,255,.01)':'rgba(198,163,78,.03)',border:'1px solid '+(q.selected===false?'rgba(255,255,255,.03)':'rgba(198,163,78,.08)'),borderRadius:8,cursor:'pointer'}}>
              <div style={{width:18,height:18,borderRadius:5,border:'2px solid '+(q.selected===false?'#555':'#c6a34e'),background:q.selected===false?'transparent':'#c6a34e',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,color:'#000',flexShrink:0}}>{q.selected!==false?'✓':''}</div>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:11,color:'#e5e5e5',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{q.task}</div>
                <div style={{fontSize:9,color:'#888'}}>{q.detail}</div>
              </div>
              <span style={{fontSize:10,color:'#888',flexShrink:0}}>{q.client}</span>
              <span style={{fontSize:10,color:'#c6a34e',fontWeight:600,flexShrink:0}}>{q.count} doc{q.count>1?'s':''}</span>
            </div>)}
          </div>
        </div>)}
      </div>}

      {/* TAB: Processed */}
      {qTab==='processed'&&<div>
        {processed.length===0?<div style={{textAlign:'center',padding:40,color:'#888'}}>Aucune tâche traitée</div>:
        <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:12,overflow:'hidden'}}>
          <div style={{display:'grid',gridTemplateColumns:'30px 1fr 150px 80px 60px',padding:'8px 12px',background:'rgba(198,163,78,.06)',fontSize:10,fontWeight:600,color:'#c6a34e'}}>
            <div></div><div>Tâche</div><div>Client</div><div>Statut</div><div>Docs</div>
          </div>
          <div style={{maxHeight:400,overflowY:'auto'}}>
            {processed.map((p,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'30px 1fr 150px 80px 60px',padding:'6px 12px',borderTop:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
              <span>{p.icon}</span>
              <span style={{color:'#e5e5e5'}}>{p.task}</span>
              <span style={{color:'#888'}}>{p.client}</span>
              <span style={{fontSize:9,padding:'2px 8px',borderRadius:6,textAlign:'center',background:p.status==='done'?'rgba(34,197,94,.12)':p.status==='rejected'?'rgba(234,179,8,.12)':'rgba(239,68,68,.12)',color:p.status==='done'?'#22c55e':p.status==='rejected'?'#eab308':'#ef4444'}}>{p.status==='done'?'✅':p.status==='rejected'?'⏭':'❌'}</span>
              <span style={{color:'#c6a34e',textAlign:'center'}}>{p.count}</span>
            </div>)}
          </div>
        </div>}
      </div>}

      {/* TAB: Stats */}
      {qTab==='stats'&&<div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14}}>
          {[{l:'Total en attente',v:pending.length,c:'#c6a34e'},{l:'Documents à générer',v:totalDocs,c:'#3b82f6'},{l:'Tâches traitées',v:processed.filter(p=>p.status==='done').length,c:'#22c55e'},{l:'Rejetées',v:processed.filter(p=>p.status==='rejected').length,c:'#eab308'}].map((k,i)=>
            <div key={i} style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'30',borderRadius:14,textAlign:'center'}}>
              <div style={{fontSize:28,fontWeight:700,color:k.c}}>{k.v}</div>
              <div style={{fontSize:10,color:'#888',marginTop:4}}>{k.l}</div>
            </div>)}
        </div>
        <div style={{marginTop:20,padding:16,background:'rgba(198,163,78,.04)',borderRadius:12}}>
          <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>📊 Par type d'opération</div>
          {Object.entries(grouped).map(([type,items])=><div key={type} style={{display:'flex',alignItems:'center',gap:10,padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
            <span style={{fontSize:14}}>{items[0]?.icon}</span>
            <span style={{flex:1,fontSize:12,color:'#e5e5e5'}}>{type}</span>
            <span style={{fontSize:12,fontWeight:600,color:'#c6a34e'}}>{items.length}</span>
            <div style={{width:120,height:6,background:'rgba(198,163,78,.1)',borderRadius:3,overflow:'hidden'}}>
              <div style={{height:'100%',width:(items.length/Math.max(pending.length,1)*100)+'%',background:'#c6a34e',borderRadius:3}}/>
            </div>
          </div>)}
        </div>
      </div>}
    </div>;
  };

  // ═══ CLIENT ONBOARDING WIZARD ═══
  
  // ══════════════════════════════════════════════════
  // ═══ SPRINT 23: CLIENT PORTAL — Portail Employeur ═══
  // ══════════════════════════════════════════════════
  const ClientPortal=({s,d,supabase,user,clientData})=>{
    const [tab,setTab]=useState('accueil');
    const now=new Date();
    const mois=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
    const currentMonth=mois[now.getMonth()];
    const currentYear=now.getFullYear();
    
    // Client data
    const co=clientData?.company||s.co||{};
    const emps=clientData?.emps||s.emps||[];
    const pays=clientData?.pays||s.pays||[];
    
    // Messages state
    const [messages,setMessages]=useState([]);
    const [newMsg,setNewMsg]=useState('');
    const [msgCategory,setMsgCategory]=useState('general');
    
    // Demandes state
    const [demandes,setDemandes]=useState([]);
    const [demandeForm,setDemandeForm]=useState({type:'conge',empId:'',dateDebut:'',dateFin:'',motif:'',jours:1});
    
    // Prestations state
    const [prestations,setPrestations]=useState({});
    const [prestMonth,setPrestMonth]=useState(now.getMonth()+1);
    const [prestYear,setPrestYear]=useState(now.getFullYear());
    const [prestSaved,setPrestSaved]=useState(false);
    
    // Modifications state
    const [modifications,setModifications]=useState([]);
    const [modForm,setModForm]=useState({type:'nouvel_employe',data:{}});
    
    // Load messages & demandes from Supabase
    useEffect(()=>{
      if(!supabase||!user)return;
      const loadPortalData=async()=>{
        try{
          const{data}=await supabase.from('app_state').select('val').eq('key','portal_'+user.id).maybeSingle();
          if(data?.val){
            const pd=typeof data.val==='string'?(()=>{try{return JSON.parse(data.val)}catch(e){return null}})():data.val;
            if(pd.messages)setMessages(pd.messages);
            if(pd.demandes)setDemandes(pd.demandes);
            if(pd.prestations)setPrestations(pd.prestations);
            if(pd.modifications)setModifications(pd.modifications);
          }
        }catch(e){console.error('Portal load error:',e);}
      };
      loadPortalData();
    },[supabase,user]);

    // Save portal data
    const savePortalData=async(updates)=>{
      if(!supabase||!user)return;
      const data={messages:updates.messages||messages,demandes:updates.demandes||demandes,prestations:updates.prestations||prestations,modifications:updates.modifications||modifications};
      try{
        await supabase.from('app_state').upsert({key:'portal_'+user.id,val:JSON.stringify(data),updated_at:new Date().toISOString()},{onConflict:'key'});
      }catch(e){console.error('Portal save error:',e);}
    };

    // Send message
    const sendMessage=()=>{
      if(!newMsg.trim())return;
      const msg={id:'MSG-'+Date.now(),from:'client',fromEmail:user?.email||'',category:msgCategory,text:newMsg.trim(),date:new Date().toISOString(),read:false};
      const updated=[msg,...messages];
      setMessages(updated);
      setNewMsg('');
      savePortalData({messages:updated});
    };

    // Submit demande
    const submitDemande=()=>{
      if(!demandeForm.empId||!demandeForm.dateDebut){alert('Sélectionnez un employé et une date');return;}
      const emp=emps.find(e=>e.id===demandeForm.empId);
      const dem={id:'DEM-'+Date.now(),type:demandeForm.type,empId:demandeForm.empId,empName:(emp?.first||emp?.fn||'')+' '+(emp?.last||emp?.ln||''),dateDebut:demandeForm.dateDebut,dateFin:demandeForm.dateFin||demandeForm.dateDebut,motif:demandeForm.motif,jours:+demandeForm.jours||1,status:'pending',createdAt:new Date().toISOString(),createdBy:user?.email||''};
      const updated=[dem,...demandes];
      setDemandes(updated);
      setDemandeForm({type:'conge',empId:'',dateDebut:'',dateFin:'',motif:'',jours:1});
      savePortalData({demandes:updated});
      alert('✅ Demande envoyée — En attente de validation par le secrétariat social.');
    };

    // Save prestations
    const savePrestations=()=>{
      const key=prestYear+'-'+String(prestMonth).padStart(2,'0');
      const updated={...prestations,[key]:{...prestations[key],savedAt:new Date().toISOString(),savedBy:user?.email}};
      setPrestations(updated);
      setPrestSaved(true);
      savePortalData({prestations:updated});
      setTimeout(()=>setPrestSaved(false),3000);
    };

    const updatePrest=(empId,field,val)=>{
      const key=prestYear+'-'+String(prestMonth).padStart(2,'0');
      setPrestations(p=>({...p,[key]:{...(p[key]||{}),emps:{...(p[key]?.emps||{}),[empId]:{...(p[key]?.emps?.[empId]||{}),[field]:val}}}}));
      setPrestSaved(false);
    };

    // Submit modification request
    const submitModification=(type,data)=>{
      const mod={id:'MOD-'+Date.now(),type,data,status:'pending',createdAt:new Date().toISOString(),createdBy:user?.email||''};
      const updated=[mod,...modifications];
      setModifications(updated);
      savePortalData({modifications:updated});
      alert('✅ Demande de modification envoyée — En attente de validation.');
    };

    const fieldStyle={width:'100%',padding:'10px 14px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',outline:'none',boxSizing:'border-box'};
    const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2}).format(v||0);
    const tabs=[
      {id:'accueil',icon:'🏠',label:'Accueil'},
      {id:'prestations',icon:'📝',label:'Prestations'},
      {id:'absences',icon:'🏖',label:'Congés & Absences'},
      {id:'fiches',icon:'📄',label:'Fiches de paie'},
      {id:'messages',icon:'💬',label:'Messages'+(messages.filter(m=>m.from==='secretariat'&&!m.read).length>0?' ('+messages.filter(m=>m.from==='secretariat'&&!m.read).length+')':'')},
      {id:'modifications',icon:'✏️',label:'Modifications'},
      {id:'kpi',icon:'📊',label:'Dashboard'},
    ];

    return <div style={{minHeight:'100vh',background:'#060810'}}>
      {/* TOP BAR */}
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'14px 28px',background:'linear-gradient(135deg,#080b14,#0d1117)',borderBottom:'1px solid rgba(198,163,78,.15)'}}>
        <div style={{display:'flex',alignItems:'center',gap:14}}>
          <div style={{fontSize:22,fontWeight:800,color:'#c6a34e',letterSpacing:'-0.5px'}}>AUREUS</div>
          <div style={{width:1,height:28,background:'rgba(198,163,78,.2)'}}/>
          <div>
            <div style={{fontSize:14,fontWeight:600,color:'#e5e5e5'}}>{co.name||'Mon entreprise'}</div>
            <div style={{fontSize:10,color:'#888'}}>Portail Employeur · {co.vat||''}</div>
          </div>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:14}}>
          <div style={{fontSize:11,color:'#888'}}>{user?.email}</div>
          <div style={{width:32,height:32,borderRadius:'50%',background:'linear-gradient(135deg,#22c55e,#16a34a)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,color:'#fff',fontWeight:700}}>{(user?.email||'C')[0].toUpperCase()}</div>
        </div>
      </div>

      <div style={{display:'flex'}}>
        {/* SIDEBAR PORTAL */}
        <div style={{width:220,padding:'20px 12px',borderRight:'1px solid rgba(198,163,78,.08)',background:'#070a12',minHeight:'calc(100vh - 60px)'}}>
          {tabs.map(t=><button key={t.id} onClick={()=>setTab(t.id)} style={{display:'flex',alignItems:'center',gap:10,width:'100%',padding:'11px 14px',marginBottom:2,border:'none',borderRadius:10,cursor:'pointer',fontSize:12,fontWeight:tab===t.id?600:400,color:tab===t.id?'#c6a34e':'#888',background:tab===t.id?'rgba(198,163,78,.1)':'transparent',borderLeft:tab===t.id?'2px solid #c6a34e':'2px solid transparent',fontFamily:'inherit',textAlign:'left'}}>
            <span style={{fontSize:15}}>{t.icon}</span>{t.label}
          </button>)}
          <div style={{marginTop:20,padding:'12px',background:'rgba(34,197,94,.04)',border:'1px solid rgba(34,197,94,.1)',borderRadius:10}}>
            <div style={{fontSize:10,color:'#22c55e',fontWeight:600}}>📅 Échéances</div>
            <div style={{fontSize:10,color:'#888',marginTop:6}}>Avant le 5 — Encoder prestations</div>
            <div style={{fontSize:10,color:'#888',marginTop:2}}>Le 25 — Dernier délai modifs</div>
            <div style={{fontSize:10,color:'#888',marginTop:2}}>Fin du mois — Fiches disponibles</div>
          </div>
        </div>

        {/* MAIN CONTENT */}
        <div style={{flex:1,padding:'28px 36px'}}>

          {/* ═══ ACCUEIL ═══ */}
          {tab==='accueil'&&<div>
            <h2 style={{fontSize:22,fontWeight:700,color:'#e5e5e5',margin:'0 0 4px'}}>Bienvenue, {co.name||'Employeur'}</h2>
            <p style={{fontSize:12,color:'#888',marginBottom:24}}>Portail Employeur — {currentMonth} {currentYear}</p>
            
            <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14,marginBottom:24}}>
              {[{v:emps.length,l:'Travailleurs actifs',i:'👥',c:'#c6a34e'},
                {v:currentMonth,l:'Prestations à encoder',i:'📝',c:'#3b82f6'},
                {v:demandes.filter(d2=>d2.status==='pending').length,l:'Demandes en cours',i:'📋',c:'#a855f7'},
                {v:messages.filter(m=>m.from==='secretariat'&&!m.read).length,l:'Messages non lus',i:'💬',c:'#22c55e'}
              ].map((k,i)=><div key={i} style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.08)',borderRadius:14,textAlign:'center'}}>
                <div style={{fontSize:14,marginBottom:6}}>{k.i}</div>
                <div style={{fontSize:22,fontWeight:700,color:k.c}}>{k.v}</div>
                <div style={{fontSize:10,color:'#888',marginTop:2}}>{k.l}</div>
              </div>)}
            </div>

            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
              <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(59,130,246,.1)',borderRadius:14}}>
                <div style={{fontSize:14,fontWeight:600,color:'#3b82f6',marginBottom:12}}>📋 Actions rapides</div>
                {[{l:'Encoder les prestations du mois',t:'prestations',c:'#3b82f6'},
                  {l:'Demander un congé / absence',t:'absences',c:'#22c55e'},
                  {l:'Consulter les fiches de paie',t:'fiches',c:'#c6a34e'},
                  {l:'Envoyer un message',t:'messages',c:'#a855f7'}
                ].map((a,i)=><button key={i} onClick={()=>setTab(a.t)} style={{display:'block',width:'100%',padding:'10px 14px',marginBottom:6,background:'rgba(255,255,255,.02)',border:'1px solid rgba(255,255,255,.04)',borderRadius:8,color:'#e5e5e5',fontSize:12,cursor:'pointer',fontFamily:'inherit',textAlign:'left'}} onMouseEnter={e=>e.currentTarget.style.borderColor=a.c+'50'} onMouseLeave={e=>e.currentTarget.style.borderColor='rgba(255,255,255,.04)'}>{a.l} →</button>)}
              </div>
              <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
                <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:12}}>👥 Équipe ({emps.length})</div>
                <div style={{maxHeight:180,overflowY:'auto'}}>
                  {emps.map((e,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
                    <span style={{color:'#e5e5e5'}}>{e.first||e.fn||''} {e.last||e.ln||''}</span>
                    <span style={{color:'#888'}}>{e.contractType||'CDI'} · {f2(+(e.monthlySalary||e.gross||e.brut||0))}€</span>
                  </div>)}
                  {emps.length===0&&<div style={{textAlign:'center',padding:20,color:'#888',fontSize:11}}>Aucun employé</div>}
                </div>
              </div>
            </div>
          </div>}

          {/* ═══ PRESTATIONS ═══ */}
          {tab==='prestations'&&<div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
              <div>
                <h2 style={{fontSize:20,fontWeight:700,color:'#e5e5e5',margin:0}}>📝 Encodage Prestations</h2>
                <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Encodez les heures et événements de vos travailleurs</p>
              </div>
              <div style={{display:'flex',gap:8,alignItems:'center'}}>
                <select value={prestMonth} onChange={e=>setPrestMonth(+e.target.value)} style={{padding:'8px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',outline:'none'}}>
                  {mois.map((m,i)=><option key={i} value={i+1}>{m}</option>)}
                </select>
                <select value={prestYear} onChange={e=>setPrestYear(+e.target.value)} style={{padding:'8px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',outline:'none'}}>
                  {[2024,2025,2026,2027].map(y=><option key={y} value={y}>{y}</option>)}
                </select>
              </div>
            </div>

            {prestSaved&&<div style={{padding:'10px 14px',background:'rgba(34,197,94,.08)',border:'1px solid rgba(34,197,94,.2)',borderRadius:10,marginBottom:16,fontSize:12,color:'#22c55e',fontWeight:600}}>✅ Prestations sauvegardées</div>}

            <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
              <div style={{display:'grid',gridTemplateColumns:'180px repeat(7,1fr)',padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:10,fontWeight:600,color:'#c6a34e'}}>
                <div>Travailleur</div><div>Jours prestés</div><div>H. sup.</div><div>H. dimanche</div><div>H. nuit</div><div>Maladie (j)</div><div>Prime (€)</div><div>Remarques</div>
              </div>
              {emps.map((e,i)=>{
                const key=prestYear+'-'+String(prestMonth).padStart(2,'0');
                const ep=prestations[key]?.emps?.[e.id]||{};
                return <div key={i} style={{display:'grid',gridTemplateColumns:'180px repeat(7,1fr)',padding:'8px 14px',borderTop:'1px solid rgba(255,255,255,.03)',alignItems:'center',fontSize:11}}>
                  <div style={{color:'#e5e5e5',fontWeight:500}}>{e.first||e.fn||''} {e.last||e.ln||''}</div>
                  {['jours','hSup','hDimanche','hNuit','maladie','prime'].map(field=>
                    <div key={field}><input type="number" value={ep[field]||''} onChange={ev=>updatePrest(e.id,field,ev.target.value)} style={{width:'90%',padding:'6px 8px',background:'#090c16',border:'1px solid rgba(139,115,60,.1)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',outline:'none',boxSizing:'border-box',textAlign:'center'}} placeholder={field==='jours'?'22':'0'}/></div>
                  )}
                  <div><input value={ep.remarques||''} onChange={ev=>updatePrest(e.id,'remarques',ev.target.value)} style={{width:'90%',padding:'6px 8px',background:'#090c16',border:'1px solid rgba(139,115,60,.1)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',outline:'none',boxSizing:'border-box'}} placeholder="..."/></div>
                </div>;
              })}
            </div>
            
            <div style={{display:'flex',gap:10,marginTop:16}}>
              <button onClick={savePrestations} style={{padding:'12px 28px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#22c55e,#16a34a)',color:'#fff',fontWeight:700,fontSize:13,cursor:'pointer'}}>💾 Sauvegarder les prestations</button>
              <div style={{padding:'12px 16px',background:'rgba(198,163,78,.04)',borderRadius:10,fontSize:11,color:'#888',display:'flex',alignItems:'center'}}>⏰ Date limite d'encodage : le 5 du mois suivant</div>
            </div>
          </div>}

          {/* ═══ CONGÉS & ABSENCES ═══ */}
          {tab==='absences'&&<div>
            <h2 style={{fontSize:20,fontWeight:700,color:'#e5e5e5',margin:'0 0 20px'}}>🏖 Demandes de Congés & Absences</h2>
            
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:20,marginBottom:24}}>
              <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(34,197,94,.15)',borderRadius:14}}>
                <div style={{fontSize:14,fontWeight:600,color:'#22c55e',marginBottom:14}}>➕ Nouvelle demande</div>
                <div style={{display:'grid',gap:10}}>
                  <div>
                    <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Type</label>
                    <select value={demandeForm.type} onChange={e=>setDemandeForm(p=>({...p,type:e.target.value}))} style={fieldStyle}>
                      <option value="conge">🏖 Congé annuel</option>
                      <option value="maladie">🏥 Maladie</option>
                      <option value="sans_solde">💤 Congé sans solde</option>
                      <option value="parental">👶 Congé parental</option>
                      <option value="formation">📚 Congé formation</option>
                      <option value="petit_chomage">📋 Petit chômage</option>
                      <option value="credit_temps">⏰ Crédit-temps</option>
                      <option value="autre">📝 Autre</option>
                    </select>
                  </div>
                  <div>
                    <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Employé</label>
                    <select value={demandeForm.empId} onChange={e=>setDemandeForm(p=>({...p,empId:e.target.value}))} style={fieldStyle}>
                      <option value="">— Sélectionner —</option>
                      {emps.map(e=><option key={e.id} value={e.id}>{e.first||e.fn||''} {e.last||e.ln||''}</option>)}
                    </select>
                  </div>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
                    <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Du</label><input type="date" value={demandeForm.dateDebut} onChange={e=>setDemandeForm(p=>({...p,dateDebut:e.target.value}))} style={fieldStyle}/></div>
                    <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Au</label><input type="date" value={demandeForm.dateFin} onChange={e=>setDemandeForm(p=>({...p,dateFin:e.target.value}))} style={fieldStyle}/></div>
                  </div>
                  <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Nombre de jours</label><input type="number" value={demandeForm.jours} onChange={e=>setDemandeForm(p=>({...p,jours:e.target.value}))} style={fieldStyle}/></div>
                  <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Motif / Remarques</label><textarea value={demandeForm.motif} onChange={e=>setDemandeForm(p=>({...p,motif:e.target.value}))} style={{...fieldStyle,minHeight:60,resize:'vertical'}} placeholder="Optionnel"/></div>
                  <button onClick={submitDemande} style={{padding:'12px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#22c55e,#16a34a)',color:'#fff',fontWeight:700,fontSize:13,cursor:'pointer'}}>📤 Envoyer la demande</button>
                </div>
              </div>
              
              <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
                <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:14}}>📋 Historique ({demandes.length})</div>
                <div style={{maxHeight:400,overflowY:'auto'}}>
                  {demandes.length===0?<div style={{textAlign:'center',padding:30,color:'#888',fontSize:11}}>Aucune demande</div>:
                  demandes.map((dem,i)=><div key={i} style={{padding:'10px 12px',marginBottom:6,background:'rgba(255,255,255,.02)',border:'1px solid rgba(255,255,255,.04)',borderRadius:10}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                      <span style={{fontSize:12,fontWeight:500,color:'#e5e5e5'}}>{dem.empName}</span>
                      <span style={{fontSize:9,padding:'2px 8px',borderRadius:6,fontWeight:600,
                        background:dem.status==='pending'?'rgba(234,179,8,.12)':dem.status==='approved'?'rgba(34,197,94,.12)':'rgba(239,68,68,.12)',
                        color:dem.status==='pending'?'#eab308':dem.status==='approved'?'#22c55e':'#ef4444'
                      }}>{dem.status==='pending'?'⏳ En attente':dem.status==='approved'?'✅ Approuvé':'❌ Refusé'}</span>
                    </div>
                    <div style={{fontSize:10,color:'#888',marginTop:4}}>
                      {dem.type==='conge'?'🏖':dem.type==='maladie'?'🏥':'📋'} {dem.type} · {dem.dateDebut}{dem.dateFin&&dem.dateFin!==dem.dateDebut?' → '+dem.dateFin:''} · {dem.jours}j
                    </div>
                    {dem.motif&&<div style={{fontSize:10,color:'#666',marginTop:2,fontStyle:'italic'}}>{dem.motif}</div>}
                    {dem.adminComment&&<div style={{fontSize:10,color:'#c6a34e',marginTop:4}}>💬 Secrétariat : {dem.adminComment}</div>}
                  </div>)}
                </div>
              </div>
            </div>
          </div>}

          {/* ═══ FICHES DE PAIE ═══ */}
          {tab==='fiches'&&<div>
            <h2 style={{fontSize:20,fontWeight:700,color:'#e5e5e5',margin:'0 0 20px'}}>📄 Fiches de Paie</h2>
            
            {pays.length===0?<div style={{textAlign:'center',padding:50}}>
              <div style={{fontSize:50,marginBottom:12}}>📄</div>
              <div style={{fontSize:16,fontWeight:600,color:'#888'}}>Aucune fiche de paie disponible</div>
              <div style={{fontSize:12,color:'#666',marginTop:4}}>Les fiches seront disponibles ici dès qu'elles seront générées par le secrétariat social.</div>
            </div>:
            <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
              <div style={{display:'grid',gridTemplateColumns:'160px 1fr 100px 100px 100px 80px',padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:10,fontWeight:600,color:'#c6a34e'}}>
                <div>Période</div><div>Employé</div><div>Brut</div><div>ONSS</div><div>Net</div><div>Action</div>
              </div>
              {pays.map((p,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'160px 1fr 100px 100px 100px 80px',padding:'8px 14px',borderTop:'1px solid rgba(255,255,255,.03)',alignItems:'center',fontSize:12}}>
                <span style={{color:'#c6a34e',fontWeight:500}}>{p.period||'-'}</span>
                <span style={{color:'#e5e5e5'}}>{p.ename||'-'}</span>
                <span style={{color:'#e5e5e5'}}>{f2(p.gross||0)}€</span>
                <span style={{color:'#ef4444'}}>-{f2(p.onssNet||0)}€</span>
                <span style={{color:'#22c55e',fontWeight:600}}>{f2(p.net||0)}€</span>
                <button onClick={()=>{try{generatePayslipPDF(emps.find(e=>(e.first||e.fn)+' '+(e.last||e.ln)===p.ename)||emps[0],p,{month:+(p.period?.split(' ')[0])||1,year:+(p.period?.split(' ')[1])||2026},co)}catch(ex){}}} style={{padding:'4px 10px',borderRadius:6,border:'none',background:'rgba(198,163,78,.1)',color:'#c6a34e',fontSize:10,cursor:'pointer'}}>📥</button>
              </div>)}
            </div>}
          </div>}

          {/* ═══ MESSAGES ═══ */}
          {tab==='messages'&&<div>
            <h2 style={{fontSize:20,fontWeight:700,color:'#e5e5e5',margin:'0 0 20px'}}>💬 Messagerie</h2>
            
            <div style={{display:'grid',gridTemplateColumns:'1fr 300px',gap:20}}>
              <div>
                {/* Message list */}
                <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:16,maxHeight:500,overflowY:'auto',marginBottom:16}}>
                  {messages.length===0?<div style={{textAlign:'center',padding:30,color:'#888',fontSize:12}}>Aucun message. Envoyez votre premier message au secrétariat social.</div>:
                  messages.map((m,i)=><div key={i} style={{display:'flex',flexDirection:m.from==='client'?'row-reverse':'row',gap:10,marginBottom:12}}>
                    <div style={{width:32,height:32,borderRadius:'50%',background:m.from==='client'?'linear-gradient(135deg,#22c55e,#16a34a)':'linear-gradient(135deg,#c6a34e,#a07d3e)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,color:'#fff',fontWeight:700,flexShrink:0}}>{m.from==='client'?'🏢':'🎯'}</div>
                    <div style={{maxWidth:'70%',padding:'10px 14px',borderRadius:12,background:m.from==='client'?'rgba(34,197,94,.08)':'rgba(198,163,78,.08)',border:'1px solid '+(m.from==='client'?'rgba(34,197,94,.15)':'rgba(198,163,78,.15)')}}>
                      <div style={{fontSize:12,color:'#e5e5e5'}}>{m.text}</div>
                      <div style={{fontSize:9,color:'#888',marginTop:4}}>{new Date(m.date).toLocaleString('fr-BE')} · {m.category!=='general'?m.category:''}</div>
                    </div>
                  </div>)}
                </div>
                
                {/* New message */}
                <div style={{display:'flex',gap:8}}>
                  <select value={msgCategory} onChange={e=>setMsgCategory(e.target.value)} style={{padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',outline:'none',width:140}}>
                    <option value="general">💬 Général</option>
                    <option value="urgent">🔴 Urgent</option>
                    <option value="paie">📄 Paie</option>
                    <option value="conge">🏖 Congé</option>
                    <option value="admin">📋 Administratif</option>
                  </select>
                  <input value={newMsg} onChange={e=>setNewMsg(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&newMsg.trim())sendMessage()}} placeholder="Votre message au secrétariat social..." style={{flex:1,...fieldStyle}}/>
                  <button onClick={sendMessage} disabled={!newMsg.trim()} style={{padding:'10px 20px',borderRadius:8,border:'none',background:newMsg.trim()?'linear-gradient(135deg,#22c55e,#16a34a)':'#333',color:newMsg.trim()?'#fff':'#666',fontWeight:600,fontSize:12,cursor:newMsg.trim()?'pointer':'not-allowed'}}>Envoyer</button>
                </div>
              </div>
              
              {/* Quick contacts */}
              <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14,alignSelf:'start'}}>
                <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:12}}>🎯 Votre secrétariat</div>
                <div style={{fontSize:12,color:'#e5e5e5',marginBottom:4}}>Aureus Social Pro</div>
                <div style={{fontSize:10,color:'#888',marginBottom:10}}>Secrétariat social agréé</div>
                <div style={{fontSize:10,color:'#888',lineHeight:1.8}}>
                  📧 contact@aureussocial.be<br/>
                  📞 +32 2 000 00 00<br/>
                  🏢 Bruxelles, Belgique
                </div>
                <div style={{marginTop:12,padding:10,background:'rgba(34,197,94,.06)',borderRadius:8,fontSize:10,color:'#22c55e'}}>
                  ✅ Temps de réponse moyen : 4h
                </div>
              </div>
            </div>
          </div>}

          {/* ═══ MODIFICATIONS ═══ */}
          {tab==='modifications'&&<div>
            <h2 style={{fontSize:20,fontWeight:700,color:'#e5e5e5',margin:'0 0 4px'}}>✏️ Demandes de Modification</h2>
            <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Proposez des modifications — Le secrétariat social valide</p>
            
            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14,marginBottom:24}}>
              {[{type:'nouvel_employe',icon:'👤',label:'Nouvel employé',desc:'Signaler une nouvelle embauche'},
                {type:'depart',icon:'🚪',label:'Départ employé',desc:'Signaler un départ / fin de contrat'},
                {type:'changement_adresse',icon:'🏠',label:'Changement adresse',desc:'Adresse employé ou société'},
                {type:'changement_iban',icon:'🏦',label:'Changement IBAN',desc:'Nouveau compte bancaire'},
                {type:'changement_horaire',icon:'⏰',label:'Changement horaire',desc:'Modification temps de travail'},
                {type:'autre',icon:'📝',label:'Autre modification',desc:'Toute autre demande'}
              ].map((m,i)=><button key={i} onClick={()=>{
                const details=prompt(m.label+'\n\nDécrivez la modification en détail :');
                if(details)submitModification(m.type,{description:details,date:new Date().toISOString()});
              }} style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.08)',borderRadius:14,cursor:'pointer',textAlign:'left',fontFamily:'inherit'}} onMouseEnter={e=>e.currentTarget.style.borderColor='rgba(198,163,78,.25)'} onMouseLeave={e=>e.currentTarget.style.borderColor='rgba(198,163,78,.08)'}>
                <div style={{fontSize:22,marginBottom:6}}>{m.icon}</div>
                <div style={{fontSize:13,fontWeight:600,color:'#e5e5e5'}}>{m.label}</div>
                <div style={{fontSize:10,color:'#888',marginTop:2}}>{m.desc}</div>
              </button>)}
            </div>

            {modifications.length>0&&<div>
              <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:10}}>📋 Historique des demandes</div>
              {modifications.map((m,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:12,padding:'10px 14px',marginBottom:4,background:'rgba(255,255,255,.02)',border:'1px solid rgba(255,255,255,.04)',borderRadius:10}}>
                <span style={{fontSize:9,padding:'2px 8px',borderRadius:6,fontWeight:600,
                  background:m.status==='pending'?'rgba(234,179,8,.12)':m.status==='approved'?'rgba(34,197,94,.12)':'rgba(239,68,68,.12)',
                  color:m.status==='pending'?'#eab308':m.status==='approved'?'#22c55e':'#ef4444'
                }}>{m.status==='pending'?'⏳':m.status==='approved'?'✅':'❌'}</span>
                <div style={{flex:1}}>
                  <div style={{fontSize:12,color:'#e5e5e5'}}>{m.type.replace(/_/g,' ')}</div>
                  <div style={{fontSize:10,color:'#888'}}>{m.data?.description?.substring(0,80)||'—'}</div>
                </div>
                <span style={{fontSize:10,color:'#666'}}>{new Date(m.createdAt).toLocaleDateString('fr-BE')}</span>
              </div>)}
            </div>}
          </div>}

          {/* ═══ KPI DASHBOARD ═══ */}
          {tab==='kpi'&&<div>
            <h2 style={{fontSize:20,fontWeight:700,color:'#e5e5e5',margin:'0 0 20px'}}>📊 Dashboard</h2>
            
            <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14,marginBottom:24}}>
              {[{v:emps.length,l:'Effectif total',c:'#c6a34e',i:'👥'},
                {v:emps.filter(e=>(e.contractType||'CDI')==='CDI').length,l:'CDI',c:'#22c55e',i:'📋'},
                {v:emps.filter(e=>(e.contractType)==='CDD').length,l:'CDD',c:'#eab308',i:'⏱'},
                {v:f2(emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0)),l:'Masse salariale brute',c:'#3b82f6',i:'💰'}
              ].map((k,i)=><div key={i} style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:14,textAlign:'center'}}>
                <div style={{fontSize:16,marginBottom:6}}>{k.i}</div>
                <div style={{fontSize:24,fontWeight:700,color:k.c}}>{k.v}</div>
                <div style={{fontSize:10,color:'#888',marginTop:2}}>{k.l}</div>
              </div>)}
            </div>

            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
              <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
                <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:14}}>💰 Coûts estimés</div>
                {(()=>{
                  const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0);
                  const onssP=Math.round(totalBrut*TX_ONSS_E);
                  const cout=totalBrut+onssP;
                  return [{l:'Brut mensuel total',v:totalBrut,c:'#e5e5e5'},
                    {l:'ONSS patronal ('+(TX_ONSS_E*100).toFixed(2)+'%)',v:onssP,c:'#a855f7'},
                    {l:'Coût mensuel estimé',v:cout,c:'#c6a34e'},
                    {l:'Coût annuel estimé',v:cout*12,c:'#22c55e'}
                  ].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:12}}>
                    <span style={{color:'#888'}}>{r.l}</span>
                    <span style={{color:r.c,fontWeight:600}}>{f2(r.v)}€</span>
                  </div>);
                })()}
              </div>
              <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(59,130,246,.1)',borderRadius:14}}>
                <div style={{fontSize:14,fontWeight:600,color:'#3b82f6',marginBottom:14}}>📊 Répartition</div>
                {(()=>{
                  const h=emps.filter(e=>(e.gender||e.sexe)==='M').length;
                  const fe=emps.filter(e=>(e.gender||e.sexe)==='F').length;
                  const tp=emps.filter(e=>e.regime&&e.regime<100).length;
                  return [{l:'Hommes',v:h},{l:'Femmes',v:fe},{l:'Non renseigné',v:emps.length-h-fe},{l:'Temps plein',v:emps.length-tp},{l:'Temps partiel',v:tp}
                  ].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:12}}>
                    <span style={{color:'#888'}}>{r.l}</span>
                    <span style={{color:'#e5e5e5',fontWeight:500}}>{r.v}</span>
                  </div>);
                })()}
              </div>
            </div>
          </div>}
        </div>
      </div>
    </div>;
  };

  // ═══ ADMIN: Portail Manager (voir les demandes des clients) ═══
  const PortalManager=({s,d,supabase})=>{
    const [portalData,setPortalData]=useState({});
    const [pmTab,setPmTab]=useState('demandes');
    
    useEffect(()=>{
      if(!supabase)return;
      const load=async()=>{
        try{
          const{data}=await supabase.from('app_state').select('key,val').like('key','portal_%');
          if(data){
            const pd={};
            data.forEach(d2=>{try{pd[d2.key]=typeof d2.val==='string'?(()=>{try{return JSON.parse(d2.val)}catch(e){return null}})():d2.val;}catch(e){}});
            setPortalData(pd);
          }
        }catch(e){}
      };
      load();
    },[supabase]);

    const allDemandes=Object.entries(portalData).reduce((a,[k,v])=>[...a,...(v.demandes||[]).map(d2=>({...d2,portalKey:k}))],[]).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    const allMessages=Object.entries(portalData).reduce((a,[k,v])=>[...a,...(v.messages||[]).map(m=>({...m,portalKey:k}))],[]).sort((a,b)=>new Date(b.date)-new Date(a.date));
    const allModifications=Object.entries(portalData).reduce((a,[k,v])=>[...a,...(v.modifications||[]).map(m=>({...m,portalKey:k}))],[]).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

    const updateDemande=async(portalKey,demandeId,newStatus,comment)=>{
      const pd={...portalData};
      if(pd[portalKey]?.demandes){
        pd[portalKey].demandes=pd[portalKey].demandes.map(d2=>d2.id===demandeId?{...d2,status:newStatus,adminComment:comment||'',reviewedAt:new Date().toISOString()}:d2);
        setPortalData(pd);
        try{
          await supabase.from('app_state').upsert({key:portalKey,val:JSON.stringify(pd[portalKey]),updated_at:new Date().toISOString()},{onConflict:'key'});
        }catch(e){}
      }
    };

    const updateModification=async(portalKey,modId,newStatus)=>{
      const pd={...portalData};
      if(pd[portalKey]?.modifications){
        pd[portalKey].modifications=pd[portalKey].modifications.map(m=>m.id===modId?{...m,status:newStatus,reviewedAt:new Date().toISOString()}:m);
        setPortalData(pd);
        try{
          await supabase.from('app_state').upsert({key:portalKey,val:JSON.stringify(pd[portalKey]),updated_at:new Date().toISOString()},{onConflict:'key'});
        }catch(e){}
      }
    };

    const replyMessage=async(portalKey,text)=>{
      if(!text)return;
      const pd={...portalData};
      if(pd[portalKey]){
        const msg={id:'MSG-'+Date.now(),from:'secretariat',text,date:new Date().toISOString(),category:'general'};
        pd[portalKey].messages=[msg,...(pd[portalKey].messages||[])];
        setPortalData(pd);
        try{
          await supabase.from('app_state').upsert({key:portalKey,val:JSON.stringify(pd[portalKey]),updated_at:new Date().toISOString()},{onConflict:'key'});
        }catch(e){}
      }
    };

    return <div style={{padding:24}}>
      <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🏢 Gestion Portail Clients</h2>
      <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Demandes, messages et modifications des clients employeurs</p>

      <div style={{display:'flex',gap:4,marginBottom:20}}>
        {[{id:'demandes',l:'🏖 Demandes ('+allDemandes.filter(d2=>d2.status==='pending').length+')'},{id:'messages',l:'💬 Messages ('+allMessages.filter(m=>m.from==='client').length+')'},{id:'modifications',l:'✏️ Modifications ('+allModifications.filter(m=>m.status==='pending').length+')'},{id:'prestations',l:'📝 Prestations'}].map(tb=>
          <button key={tb.id} onClick={()=>setPmTab(tb.id)} style={{padding:'10px 14px',borderRadius:10,border:pmTab===tb.id?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.05)',background:pmTab===tb.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:pmTab===tb.id?'#c6a34e':'#888',fontSize:11,fontWeight:pmTab===tb.id?600:400,cursor:'pointer'}}>{tb.l}</button>)}
      </div>

      {/* Demandes */}
      {pmTab==='demandes'&&<div>
        {allDemandes.length===0?<div style={{textAlign:'center',padding:40,color:'#888'}}>Aucune demande client</div>:
        allDemandes.map((d2,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:14,padding:'12px 16px',marginBottom:6,background:d2.status==='pending'?'rgba(234,179,8,.04)':'rgba(255,255,255,.02)',border:'1px solid '+(d2.status==='pending'?'rgba(234,179,8,.12)':'rgba(255,255,255,.04)'),borderRadius:12}}>
          <div style={{flex:1}}>
            <div style={{fontSize:13,fontWeight:500,color:'#e5e5e5'}}>{d2.empName} — {d2.type}</div>
            <div style={{fontSize:10,color:'#888'}}>{d2.dateDebut}{d2.dateFin?' → '+d2.dateFin:''} · {d2.jours}j · Client: {d2.createdBy}</div>
            {d2.motif&&<div style={{fontSize:10,color:'#666',marginTop:2}}>{d2.motif}</div>}
          </div>
          <span style={{fontSize:9,padding:'3px 8px',borderRadius:6,fontWeight:600,background:d2.status==='pending'?'rgba(234,179,8,.12)':d2.status==='approved'?'rgba(34,197,94,.12)':'rgba(239,68,68,.12)',color:d2.status==='pending'?'#eab308':d2.status==='approved'?'#22c55e':'#ef4444'}}>{d2.status}</span>
          {d2.status==='pending'&&<>
            <button onClick={()=>{const c=prompt('Commentaire (optionnel):');updateDemande(d2.portalKey,d2.id,'approved',c);}} style={{padding:'6px 14px',borderRadius:8,border:'none',background:'#22c55e',color:'#fff',fontSize:11,fontWeight:600,cursor:'pointer'}}>✅ Approuver</button>
            <button onClick={()=>{const c=prompt('Motif du refus:');if(c)updateDemande(d2.portalKey,d2.id,'rejected',c);}} style={{padding:'6px 14px',borderRadius:8,border:'none',background:'rgba(239,68,68,.15)',color:'#ef4444',fontSize:11,fontWeight:600,cursor:'pointer'}}>❌ Refuser</button>
          </>}
        </div>)}
      </div>}

      {/* Messages */}
      {pmTab==='messages'&&<div>
        {allMessages.length===0?<div style={{textAlign:'center',padding:40,color:'#888'}}>Aucun message</div>:
        allMessages.filter(m=>m.from==='client').slice(0,30).map((m,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:14,padding:'10px 16px',marginBottom:4,background:'rgba(255,255,255,.02)',border:'1px solid rgba(255,255,255,.04)',borderRadius:10}}>
          <span style={{fontSize:9,padding:'2px 6px',borderRadius:4,background:m.category==='urgent'?'rgba(239,68,68,.12)':'rgba(59,130,246,.12)',color:m.category==='urgent'?'#ef4444':'#3b82f6'}}>{m.category}</span>
          <div style={{flex:1}}>
            <div style={{fontSize:12,color:'#e5e5e5'}}>{m.text.substring(0,100)}</div>
            <div style={{fontSize:10,color:'#888'}}>{m.fromEmail} · {new Date(m.date).toLocaleString('fr-BE')}</div>
          </div>
          <button onClick={()=>{const reply=prompt('Répondre:');if(reply)replyMessage(m.portalKey,reply);}} style={{padding:'5px 12px',borderRadius:6,border:'none',background:'rgba(198,163,78,.1)',color:'#c6a34e',fontSize:10,cursor:'pointer'}}>💬 Répondre</button>
        </div>)}
      </div>}

      {/* Modifications */}
      {pmTab==='modifications'&&<div>
        {allModifications.length===0?<div style={{textAlign:'center',padding:40,color:'#888'}}>Aucune demande de modification</div>:
        allModifications.map((m,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:14,padding:'10px 16px',marginBottom:4,background:m.status==='pending'?'rgba(234,179,8,.04)':'rgba(255,255,255,.02)',border:'1px solid '+(m.status==='pending'?'rgba(234,179,8,.12)':'rgba(255,255,255,.04)'),borderRadius:10}}>
          <div style={{flex:1}}>
            <div style={{fontSize:12,fontWeight:500,color:'#e5e5e5'}}>{m.type.replace(/_/g,' ')}</div>
            <div style={{fontSize:10,color:'#888'}}>{m.data?.description?.substring(0,100)||'—'} · {m.createdBy}</div>
          </div>
          <span style={{fontSize:9,padding:'3px 8px',borderRadius:6,fontWeight:600,background:m.status==='pending'?'rgba(234,179,8,.12)':m.status==='approved'?'rgba(34,197,94,.12)':'rgba(239,68,68,.12)',color:m.status==='pending'?'#eab308':m.status==='approved'?'#22c55e':'#ef4444'}}>{m.status}</span>
          {m.status==='pending'&&<>
            <button onClick={()=>updateModification(m.portalKey,m.id,'approved')} style={{padding:'5px 12px',borderRadius:6,border:'none',background:'#22c55e',color:'#fff',fontSize:10,fontWeight:600,cursor:'pointer'}}>✅</button>
            <button onClick={()=>updateModification(m.portalKey,m.id,'rejected')} style={{padding:'5px 12px',borderRadius:6,border:'none',background:'rgba(239,68,68,.15)',color:'#ef4444',fontSize:10,fontWeight:600,cursor:'pointer'}}>❌</button>
          </>}
        </div>)}
      </div>}

      {/* Prestations */}
      {pmTab==='prestations'&&<div>
        <div style={{fontSize:13,color:'#888',marginBottom:14}}>Prestations encodées par les clients :</div>
        {Object.entries(portalData).map(([key,val])=>{
          const prest=val.prestations||{};
          const months=Object.keys(prest);
          if(months.length===0)return null;
          return <div key={key} style={{marginBottom:16,padding:14,background:'rgba(255,255,255,.02)',border:'1px solid rgba(255,255,255,.04)',borderRadius:12}}>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Client: {key.replace('portal_','')}</div>
            {months.map(m=><div key={m} style={{fontSize:11,color:'#888',padding:'4px 0'}}>
              📅 {m} — {prest[m]?.savedAt?'Sauvegardé le '+new Date(prest[m].savedAt).toLocaleString('fr-BE'):'Non sauvegardé'} — {Object.keys(prest[m]?.emps||{}).length} employés encodés
            </div>)}
          </div>;
        })}
      </div>}
    </div>;
  };


// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 24: AUTOMATISATION TOTALE — Clôture & Workflow ═══
// ══════════════════════════════════════════════════════════════


// ═══ NOTIFICATION CENTER ═══
// ═══ 1. CALCUL INSTANTANÉ (Prestations → Fiche en live) ═══
const CalcInstant=({s,d})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(clients[0]?.company?.name||'');
  const [selMonth,setSelMonth]=useState(new Date().getMonth());
  const [selYear,setSelYear]=useState(new Date().getFullYear());
  const [prestations,setPrestations]=useState({});
  const [calcResults,setCalcResults]=useState([]);
  const [autoCalc,setAutoCalc]=useState(true);
  const mois=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];

  const cl=clients.find(c=>c.company?.name===selClient)||clients[0]||{emps:[]};
  const emps=cl.emps||[];

  // Auto-calculate when prestations change
  useEffect(()=>{
    if(!autoCalc)return;
    const results=emps.map(e=>{
      const id=e.id||e.niss||((e.first||'')+e.last);
      const p=prestations[id]||{days:22,overtime:0,sunday:0,night:0,sick:0,bonus:0};
      const brut=+(e.monthlySalary||e.gross||e.brut||0);
      const dayRate=brut/22;
      const brutEffectif=Math.round((dayRate*p.days + dayRate*1.5*p.overtime + dayRate*2*p.sunday + dayRate*1.25*p.night + dayRate*p.sick*0.6 + (+p.bonus||0))*100)/100;
      const onssW=Math.round(brutEffectif*TX_ONSS_W*100)/100;
      const imposable=Math.round((brutEffectif-onssW)*100)/100;
      const pp=quickPP(brutEffectif);
      const net=Math.round((imposable-pp)*100)/100;
      const onssE=Math.round(brutEffectif*TX_ONSS_E*100)/100;
      const cout=Math.round((brutEffectif+onssE)*100)/100;
      return {id,name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),email:e.email,brut,brutEffectif,p,onssW,imposable,pp,net,onssE,cout};
    });
    setCalcResults(results);
  },[prestations,selClient,autoCalc,emps]);

  const updatePrest=(empId,field,val)=>{
    setPrestations(prev=>({...prev,[empId]:{...(prev[empId]||{days:22,overtime:0,sunday:0,night:0,sick:0,bonus:0}),[field]:+val}}));
  };

  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const totals=calcResults.reduce((a,r)=>({brut:a.brut+r.brutEffectif,net:a.net+r.net,cout:a.cout+r.cout,onss:a.onss+r.onssW+r.onssE}),{brut:0,net:0,cout:0,onss:0});

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🔁 Calcul Instantané</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Encodez les prestations → la fiche se calcule en temps réel</p>
      </div>
      <div style={{display:'flex',gap:8,alignItems:'center'}}>
        <select value={selClient} onChange={e=>setSelClient(e.target.value)} style={{padding:'8px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}>
          {clients.map((c,i)=><option key={i} value={c.company?.name}>{c.company?.name||'Client '+i}</option>)}
        </select>
        <select value={selMonth} onChange={e=>setSelMonth(+e.target.value)} style={{padding:'8px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}>
          {mois.map((m,i)=><option key={i} value={i}>{m}</option>)}
        </select>
        <div style={{display:'flex',alignItems:'center',gap:6}}>
          <button onClick={()=>setAutoCalc(!autoCalc)} style={{width:36,height:18,borderRadius:9,border:'none',background:autoCalc?'#22c55e':'#333',cursor:'pointer',position:'relative'}}>
            <div style={{width:14,height:14,borderRadius:7,background:'#fff',position:'absolute',top:2,left:autoCalc?20:2,transition:'left .2s'}}/>
          </button>
          <span style={{fontSize:10,color:'#888'}}>Auto</span>
        </div>
      </div>
    </div>

    {/* KPI TOTALS */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:20}}>
      {[{l:'Masse brute',v:f2(totals.brut)+'€',c:'#c6a34e'},{l:'ONSS total',v:f2(totals.onss)+'€',c:'#a855f7'},{l:'Net total',v:f2(totals.net)+'€',c:'#22c55e'},{l:'Coût employeur',v:f2(totals.cout)+'€',c:'#ef4444'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:20,fontWeight:700,color:k.c}}>{k.v}</div>
          <div style={{fontSize:10,color:'#888'}}>{k.l}</div>
        </div>
      )}
    </div>

    {/* PRESTATIONS TABLE */}
    <div style={{overflowX:'auto',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
      <div style={{display:'grid',gridTemplateColumns:'150px repeat(6,80px) 90px 90px 90px 90px 90px',padding:'10px 12px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e',minWidth:1100}}>
        <div>Employé</div><div>Jours</div><div>H.Sup</div><div>Dimanche</div><div>Nuit</div><div>Maladie</div><div>Prime</div><div>Brut eff.</div><div>ONSS</div><div>P.Prof</div><div>Net</div><div>Coût</div>
      </div>
      {calcResults.map((r,i)=><div key={r.id} style={{display:'grid',gridTemplateColumns:'150px repeat(6,80px) 90px 90px 90px 90px 90px',padding:'6px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',alignItems:'center',fontSize:11,minWidth:1100}}>
        <div style={{color:'#e5e5e5',fontWeight:500,fontSize:11}}>{r.name}</div>
        {['days','overtime','sunday','night','sick','bonus'].map(field=>
          <div key={field}><input type="number" value={r.p[field]||0} onChange={e=>updatePrest(r.id,field,e.target.value)} style={{width:60,padding:'4px 6px',background:'#090c16',border:'1px solid rgba(139,115,60,.1)',borderRadius:4,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',textAlign:'center'}}/></div>
        )}
        <div style={{color:'#e5e5e5',fontWeight:600}}>{f2(r.brutEffectif)}€</div>
        <div style={{color:'#ef4444'}}>-{f2(r.onssW)}€</div>
        <div style={{color:'#ef4444'}}>-{f2(r.pp)}€</div>
        <div style={{color:'#22c55e',fontWeight:700}}>{f2(r.net)}€</div>
        <div style={{color:'#c6a34e',fontWeight:600}}>{f2(r.cout)}€</div>
      </div>)}
    </div>

    {/* ACTIONS */}
    <div style={{display:'flex',gap:8,marginTop:16}}>
      <button onClick={()=>{
        const pays=calcResults.map(r=>({id:'PAY-'+Date.now()+'-'+Math.random().toString(36).substr(2,6),ename:r.name,period:mois[selMonth]+' '+selYear,gross:r.brutEffectif,onssNet:r.onssW,imposable:r.imposable,precompte:r.pp,net:r.net,onssEmployer:r.onssE,coutTotal:r.cout,empEmail:r.email,empId:r.id,generated:new Date().toISOString(),status:'calculated'}));
        const updClients=clients.map(c=>c.company?.name===selClient?{...c,pays:[...(c.pays||[]),...pays]}:c);
        d({type:'SET_CLIENTS',data:updClients});
        alert('✅ '+pays.length+' fiches sauvegardées pour '+mois[selMonth]+' '+selYear);
      }} style={{padding:'12px 24px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#22c55e,#16a34a)',color:'#fff',fontWeight:700,fontSize:13,cursor:'pointer'}}>
        💾 Sauvegarder les fiches ({calcResults.length})
      </button>
      <button onClick={()=>{
        calcResults.forEach(r=>{try{generatePayslipPDF({first:r.name.split(' ')[0],last:r.name.split(' ').slice(1).join(' '),niss:'',iban:'',email:r.email},{gross:r.brutEffectif,onssP:r.onssW,imposable:r.imposable,pp:r.pp,net:r.net,onssE:r.onssE,coutTotal:r.cout},{month:selMonth+1,year:selYear},cl.company||{});}catch(e){console.error('[PDF] Echec generation fiche:',r.name,e.message);alert('Erreur generation PDF pour '+r.name+': '+e.message);}});
      }} style={{padding:'12px 24px',borderRadius:10,border:'none',background:'rgba(198,163,78,.1)',color:'#c6a34e',fontWeight:700,fontSize:13,cursor:'pointer'}}>
        📄 Aperçu fiches de paie
      </button>
    </div>
  </div>;
};

// ═══ 2. CALENDRIER SOCIAL BELGE INTERACTIF ═══
const CalendrierSocial=({s})=>{
  const [year,setYear]=useState(new Date().getFullYear());
  const [selMonth,setSelMonth]=useState(new Date().getMonth());
  const mois=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];

  // Belgian social calendar deadlines
  const deadlines=[
    // Monthly
    {day:5,months:[0,1,2,3,4,5,6,7,8,9,10,11],type:'onss',icon:'🏛',label:'Paiement ONSS provisoire',color:'#ef4444'},
    {day:10,months:[0,1,2,3,4,5,6,7,8,9,10,11],type:'dimona',icon:'📋',label:'Dimona - Vérification entrées/sorties',color:'#3b82f6'},
    {day:15,months:[0,1,2,3,4,5,6,7,8,9,10,11],type:'precompte',icon:'💰',label:'Versement précompte professionnel',color:'#a855f7'},
    {day:25,months:[0,1,2,3,4,5,6,7,8,9,10,11],type:'paie',icon:'💳',label:'Virements salaires (SEPA)',color:'#22c55e'},
    {day:28,months:[0,1,2,3,4,5,6,7,8,9,10,11],type:'fiches',icon:'📄',label:'Distribution fiches de paie',color:'#c6a34e'},
    // Quarterly (end of quarter month)
    {day:10,months:[0,3,6,9],type:'dmfa',icon:'🏛',label:'DmfA trimestrielle',color:'#ef4444',priority:'high'},
    {day:31,months:[2,5,8,11],type:'provisions',icon:'📊',label:'Provisions pécule vacances',color:'#eab308'},
    // Annual
    {day:1,months:[0],type:'index',icon:'📈',label:'Indexation salariale annuelle',color:'#22c55e',priority:'high'},
    {day:28,months:[1],type:'belcotax',icon:'🧾',label:'Belcotax 281.10 — Date limite 1er mars',color:'#ef4444',priority:'high'},
    {day:31,months:[2],type:'bilansocial',icon:'📊',label:'Bilan social BNB',color:'#a855f7',priority:'high'},
    {day:30,months:[3],type:'pecule',icon:'🏖',label:'Calcul pécule de vacances simple',color:'#3b82f6',priority:'high'},
    {day:30,months:[4],type:'peculedouble',icon:'🏖',label:'Pécule de vacances double — Versement',color:'#22c55e',priority:'high'},
    {day:30,months:[5],type:'vacances',icon:'☀️',label:'Pécule de vacances anticipé (étudiants)',color:'#eab308'},
    {day:30,months:[8],type:'formation',icon:'📚',label:'Bilan plan de formation',color:'#3b82f6'},
    {day:31,months:[10],type:'treizieme',icon:'🎄',label:'Calcul prime de fin d\'année',color:'#22c55e',priority:'high'},
    {day:20,months:[11],type:'treizieme_v',icon:'🎄',label:'Versement 13ème mois',color:'#c6a34e',priority:'high'},
    {day:31,months:[11],type:'cloture',icon:'🔒',label:'Clôture annuelle — Bilan fiscal',color:'#ef4444',priority:'high'},
    // Jours fériés belges
    {day:1,months:[0],type:'ferie',icon:'🎉',label:'Jour de l\'An',color:'#888',ferie:true},
    {day:1,months:[4],type:'ferie',icon:'🎉',label:'Fête du Travail',color:'#888',ferie:true},
    {day:21,months:[6],type:'ferie',icon:'🇧🇪',label:'Fête nationale belge',color:'#888',ferie:true},
    {day:15,months:[7],type:'ferie',icon:'🎉',label:'Assomption',color:'#888',ferie:true},
    {day:1,months:[10],type:'ferie',icon:'🎉',label:'Toussaint',color:'#888',ferie:true},
    {day:11,months:[10],type:'ferie',icon:'🎉',label:'Armistice',color:'#888',ferie:true},
    {day:25,months:[11],type:'ferie',icon:'🎄',label:'Noël',color:'#888',ferie:true},
  ];

  const monthDeadlines=deadlines.filter(d=>d.months.includes(selMonth)).sort((a,b)=>a.day-b.day);
  const today=new Date();
  const isCurrentMonth=selMonth===today.getMonth()&&year===today.getFullYear();

  // Build calendar grid
  const firstDay=new Date(year,selMonth,1).getDay()||7; // Monday=1
  const daysInMonth=new Date(year,selMonth+1,0).getDate();
  const weeks=[];
  let week=Array(firstDay-1).fill(null);
  for(let d=1;d<=daysInMonth;d++){
    week.push(d);
    if(week.length===7){weeks.push(week);week=[];}
  }
  if(week.length>0){while(week.length<7)week.push(null);weeks.push(week);}

  const getDayEvents=(day)=>deadlines.filter(d=>d.day===day&&d.months.includes(selMonth));

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📅 Calendrier Social Belge</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Toutes les échéances légales belges — {year}</p>
      </div>
      <div style={{display:'flex',gap:4}}>
        <button onClick={()=>setYear(y=>y-1)} style={{padding:'6px 12px',borderRadius:6,border:'none',background:'rgba(255,255,255,.05)',color:'#888',cursor:'pointer'}}>◀</button>
        <span style={{padding:'6px 12px',color:'#c6a34e',fontWeight:700,fontSize:14}}>{year}</span>
        <button onClick={()=>setYear(y=>y+1)} style={{padding:'6px 12px',borderRadius:6,border:'none',background:'rgba(255,255,255,.05)',color:'#888',cursor:'pointer'}}>▶</button>
      </div>
    </div>

    {/* Month selector */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:4,marginBottom:20}}>
      {mois.map((m,i)=>{
        const hasHighPriority=deadlines.some(d=>d.months.includes(i)&&d.priority==='high');
        const count=deadlines.filter(d=>d.months.includes(i)&&!d.ferie).length;
        return <button key={i} onClick={()=>setSelMonth(i)} style={{padding:'8px 4px',borderRadius:8,border:selMonth===i?'2px solid #c6a34e':'1px solid rgba(255,255,255,.05)',background:selMonth===i?'rgba(198,163,78,.1)':'rgba(255,255,255,.02)',color:selMonth===i?'#c6a34e':'#888',fontSize:11,cursor:'pointer',fontWeight:selMonth===i?700:400,fontFamily:'inherit',position:'relative'}}>
          {m.substring(0,3)}
          {hasHighPriority&&<div style={{position:'absolute',top:2,right:4,width:6,height:6,borderRadius:3,background:'#ef4444'}}/>}
          <div style={{fontSize:8,color:'#555'}}>{count}</div>
        </button>;
      })}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 320px',gap:16}}>
      {/* Calendar grid */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'12px',background:'rgba(198,163,78,.06)',textAlign:'center',fontWeight:700,color:'#c6a34e',fontSize:15}}>
          {mois[selMonth]} {year}
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(7,1fr)',gap:0}}>
          {['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].map(d=><div key={d} style={{padding:'8px 4px',textAlign:'center',fontSize:10,fontWeight:600,color:'#888',borderBottom:'1px solid rgba(255,255,255,.05)'}}>{d}</div>)}
          {weeks.flat().map((day,i)=>{
            if(!day) return <div key={i} style={{padding:6,minHeight:40}}/>;
            const events=getDayEvents(day);
            const isToday=isCurrentMonth&&day===today.getDate();
            const isPast=isCurrentMonth&&day<today.getDate();
            return <div key={i} style={{padding:4,minHeight:46,borderBottom:'1px solid rgba(255,255,255,.03)',borderRight:'1px solid rgba(255,255,255,.03)',background:isToday?'rgba(198,163,78,.08)':isPast?'rgba(255,255,255,.01)':'transparent',cursor:events.length?'pointer':'default'}} title={events.map(e=>e.label).join('\n')}>
              <div style={{fontSize:11,fontWeight:isToday?700:400,color:isToday?'#c6a34e':isPast?'#555':'#e5e5e5',marginBottom:2}}>{day}</div>
              {events.slice(0,2).map((ev,j)=><div key={j} style={{fontSize:7,padding:'1px 3px',borderRadius:3,marginBottom:1,background:ev.color+'15',color:ev.color,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{ev.icon}</div>)}
              {events.length>2&&<div style={{fontSize:7,color:'#888'}}>+{events.length-2}</div>}
            </div>;
          })}
        </div>
      </div>

      {/* Deadlines list */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'12px 14px',background:'rgba(198,163,78,.06)',fontWeight:600,color:'#c6a34e',fontSize:13}}>
          📋 Échéances {mois[selMonth]} ({monthDeadlines.filter(d=>!d.ferie).length})
        </div>
        <div style={{maxHeight:500,overflowY:'auto',padding:8}}>
          {monthDeadlines.map((dl,i)=>{
            const isPast=isCurrentMonth&&dl.day<today.getDate();
            const isUpcoming=isCurrentMonth&&dl.day>=today.getDate()&&dl.day<=today.getDate()+7;
            return <div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 10px',marginBottom:4,background:isUpcoming?'rgba(234,179,8,.04)':dl.ferie?'rgba(255,255,255,.02)':'transparent',border:'1px solid '+(isUpcoming?'rgba(234,179,8,.15)':'rgba(255,255,255,.03)'),borderRadius:8,opacity:isPast?.5:1}}>
              <div style={{fontSize:16}}>{dl.icon}</div>
              <div style={{flex:1}}>
                <div style={{fontSize:11,fontWeight:dl.priority==='high'?700:500,color:dl.ferie?'#888':'#e5e5e5'}}>{dl.label}</div>
                <div style={{fontSize:9,color:'#888'}}>{dl.day} {mois[selMonth]}{dl.priority==='high'?' ⚠️ Important':''}</div>
              </div>
              <div style={{fontSize:10,padding:'2px 6px',borderRadius:4,background:dl.color+'15',color:dl.color,fontWeight:600}}>
                {isPast?'✓':'J-'+(dl.day-(isCurrentMonth?today.getDate():0))}
              </div>
            </div>;
          })}
        </div>
      </div>
    </div>
  </div>;
};

// ═══ 3. RAPPORTS MENSUELS AUTO-GÉNÉRÉS ═══
const RapportMensuel=({s})=>{
  const clients=s.clients||[];
  const [selMonth,setSelMonth]=useState(new Date().getMonth()===0?11:new Date().getMonth()-1);
  const [selYear,setSelYear]=useState(new Date().getMonth()===0?new Date().getFullYear()-1:new Date().getFullYear());
  const [generating,setGenerating]=useState(false);
  const mois=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const generateReport=(client)=>{
    const co=client.company||{};
    const emps=client.emps||[];
    const pays=(client.pays||[]).filter(p=>(p.period||'').includes(mois[selMonth]));
    const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);
    const totalONSSW=Math.round(totalBrut*TX_ONSS_W*100)/100;
    const totalONSSE=Math.round(totalBrut*TX_ONSS_E*100)/100;
    const totalImp=totalBrut-totalONSSW;
    const totalPP=emps.reduce((a,e)=>a+quickPP(+(e.monthlySalary||e.gross||0)),0);
    const totalNet=Math.round((totalImp-totalPP)*100)/100;
    const totalCout=Math.round((totalBrut+totalONSSE)*100)/100;
    const cdi=emps.filter(e=>(e.contractType||e.contrat||'CDI')==='CDI').length;
    const cdd=emps.length-cdi;
    const html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:11px;padding:40px;max-width:900px;margin:auto;color:#1a1a1a}h1{font-size:20px;color:#c6a34e;margin-bottom:3px}.sub{font-size:11px;color:#888;margin-bottom:20px}.kpi{display:flex;gap:12px;margin:15px 0;flex-wrap:wrap}.kpi>div{flex:1;min-width:120px;background:#f8f7f4;border:1px solid #e5e2d9;border-radius:8px;padding:12px;text-align:center}.kpi>div>div:first-child{font-size:18px;font-weight:700;color:#c6a34e}.kpi>div>div:last-child{font-size:9px;color:#888;margin-top:2px}h2{font-size:14px;margin:20px 0 8px;border-bottom:2px solid #c6a34e;padding-bottom:4px;color:#333}table{width:100%;border-collapse:collapse;margin:8px 0}th{background:#f0ece3;padding:6px 8px;text-align:left;font-size:10px;font-weight:600;color:#333}td{padding:5px 8px;border-bottom:1px solid #eee;font-size:10px}.r{text-align:right;font-family:monospace}.total{background:#f8f7f4;font-weight:700}.sig{margin-top:40px;display:flex;justify-content:space-between}.sig>div{width:200px;border-top:1px solid #ccc;padding-top:6px;text-align:center;font-size:9px}.footer{margin-top:30px;font-size:9px;color:#999;text-align:center;border-top:1px solid #eee;padding-top:10px}@media print{button{display:none!important}}</style></head><body>'+
    '<h1>'+co.name+'</h1><div class="sub">Rapport mensuel de paie — '+mois[selMonth]+' '+selYear+' | '+co.vat+'</div>'+
    '<div class="kpi"><div><div>'+emps.length+'</div><div>Travailleurs</div></div><div><div>'+f2(totalBrut)+' €</div><div>Masse brute</div></div><div><div>'+f2(totalNet)+' €</div><div>Net total</div></div><div><div>'+f2(totalCout)+' €</div><div>Coût employeur</div></div></div>'+
    '<div class="kpi"><div><div>'+cdi+'</div><div>CDI</div></div><div><div>'+cdd+'</div><div>CDD</div></div><div><div>'+f2(totalONSSW+totalONSSE)+' €</div><div>ONSS total</div></div><div><div>'+f2(totalPP)+' €</div><div>Précompte prof.</div></div></div>'+
    '<h2>Détail par travailleur</h2><table><tr><th>Nom</th><th>Contrat</th><th class="r">Brut</th><th class="r">ONSS 13,07%</th><th class="r">Imposable</th><th class="r">Précompte</th><th class="r">Net</th><th class="r">Coût empl.</th></tr>'+
    emps.map(e=>{const b=+(e.monthlySalary||e.gross||0);const o=Math.round(b*TX_ONSS_W*100)/100;const imp=b-o;const pp=quickPP(b);const n=Math.round((imp-pp)*100)/100;const oe=Math.round(b*TX_ONSS_E*100)/100;return '<tr><td>'+(e.first||e.fn||'')+' '+(e.last||e.ln||'')+'</td><td>'+(e.contractType||'CDI')+'</td><td class="r">'+f2(b)+'</td><td class="r">'+f2(o)+'</td><td class="r">'+f2(imp)+'</td><td class="r">'+f2(pp)+'</td><td class="r"><b>'+f2(n)+'</b></td><td class="r">'+f2(b+oe)+'</td></tr>';}).join('')+
    '<tr class="total"><td colspan="2">TOTAUX ('+emps.length+' travailleurs)</td><td class="r">'+f2(totalBrut)+'</td><td class="r">'+f2(totalONSSW)+'</td><td class="r">'+f2(totalImp)+'</td><td class="r">'+f2(totalPP)+'</td><td class="r"><b>'+f2(totalNet)+'</b></td><td class="r">'+f2(totalCout)+'</td></tr></table>'+
    '<h2>Charges patronales</h2><table><tr><th>Cotisation</th><th>Taux</th><th class="r">Montant</th></tr>'+
    '<tr><td>ONSS de base</td><td>24,92%</td><td class="r">'+f2(totalBrut*0.2492)+'</td></tr>'+
    '<tr><td>Modération salariale</td><td>0,15%</td><td class="r">'+f2(totalBrut*0.0015)+'</td></tr>'+
    '<tr class="total"><td>Total ONSS patronal</td><td>25,07%</td><td class="r">'+f2(totalONSSE)+'</td></tr></table>'+
    '<h2>Échéances du mois</h2><table><tr><th>Date</th><th>Obligation</th><th>Statut</th></tr>'+
    '<tr><td>5 '+mois[selMonth]+'</td><td>Paiement ONSS provisoire</td><td>'+f2(totalONSSW+totalONSSE)+' €</td></tr>'+
    '<tr><td>15 '+mois[selMonth]+'</td><td>Précompte professionnel</td><td>'+f2(totalPP)+' €</td></tr>'+
    '<tr><td>25 '+mois[selMonth]+'</td><td>Virements salaires (SEPA)</td><td>'+f2(totalNet)+' €</td></tr></table>'+
    '<div class="sig"><div>Pour le secrétariat social<br><br>Aureus Social Pro</div><div>Pour l\'employeur<br><br>'+co.name+'</div></div>'+
    '<div class="footer">Rapport généré par Aureus Social Pro — aureussocial.be — '+new Date().toLocaleDateString('fr-BE')+' '+new Date().toLocaleTimeString('fr-BE')+'</div>'+
    '<div style="text-align:center;margin-top:15px"><button onclick="window.print()" style="background:#c6a34e;color:#fff;border:none;padding:10px 30px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600">🖨 Imprimer / PDF</button></div></body></html>';
    previewHTML(html,'Rapport_'+co.name+'_'+mois[selMonth]+'_'+selYear);
  };

  const generateAll=async()=>{
    setGenerating(true);
    for(const cl of clients){
      generateReport(cl);
      await new Promise(r=>setTimeout(r,300));
    }
    setGenerating(false);
  };

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📊 Rapports Mensuels</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Récapitulatif de paie par client — Prêt à imprimer</p>
      </div>
      <div style={{display:'flex',gap:8}}>
        <select value={selMonth} onChange={e=>setSelMonth(+e.target.value)} style={{padding:'8px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}>
          {mois.map((m,i)=><option key={i} value={i}>{m}</option>)}
        </select>
        <input type="number" value={selYear} onChange={e=>setSelYear(+e.target.value)} style={{width:80,padding:'8px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}/>
        <button onClick={generateAll} disabled={generating} style={{padding:'10px 20px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:13,cursor:'pointer'}}>
          {generating?'⏳ En cours...':'📊 Générer tous les rapports'}
        </button>
      </div>
    </div>

    <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14}}>
      {clients.map((cl,i)=>{
        const emps=cl.emps||[];
        const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);
        const totalNet=Math.round(totalBrut*NET_FACTOR*100)/100;
        const totalCout=Math.round(totalBrut*(1+TX_ONSS_E)*100)/100;
        return <div key={i} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:14,fontWeight:700,color:'#c6a34e',marginBottom:6}}>{cl.company?.name||'Client '+(i+1)}</div>
          <div style={{fontSize:10,color:'#888',marginBottom:10}}>{cl.company?.vat||''} — {emps.length} employé(s)</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,marginBottom:12}}>
            <div style={{padding:8,background:'rgba(198,163,78,.04)',borderRadius:8,textAlign:'center'}}>
              <div style={{fontSize:14,fontWeight:700,color:'#e5e5e5'}}>{f2(totalBrut)}€</div>
              <div style={{fontSize:8,color:'#888'}}>Masse brute</div>
            </div>
            <div style={{padding:8,background:'rgba(34,197,94,.04)',borderRadius:8,textAlign:'center'}}>
              <div style={{fontSize:14,fontWeight:700,color:'#22c55e'}}>{f2(totalNet)}€</div>
              <div style={{fontSize:8,color:'#888'}}>Net total</div>
            </div>
          </div>
          <button onClick={()=>generateReport(cl)} style={{width:'100%',padding:'10px',borderRadius:8,border:'none',background:'rgba(198,163,78,.08)',color:'#c6a34e',fontSize:12,fontWeight:600,cursor:'pointer'}}>
            📄 Générer rapport {mois[selMonth]}
          </button>
        </div>;
      })}
    </div>
    {clients.length===0&&<div style={{textAlign:'center',padding:40,color:'#888'}}>Aucun client configuré. Ajoutez des clients depuis le Dashboard.</div>}
  </div>;
};

// ═══ 4. ACTIONS RAPIDES (1 clic = Dimona + Contrat + Fiche) ═══
const ActionsRapides=({s,d})=>{
  const clients=s.clients||[];
  const [action,setAction]=useState('embauche');
  const [formData,setFormData]=useState({client:'',first:'',last:'',niss:'',email:'',phone:'',startDate:new Date().toISOString().slice(0,10),contractType:'CDI',brut:2800,fonction:'Employé',regime:100,whWeek:38,endDate:'',endReason:'Licenciement',endInitiative:'Employeur'});
  const [logs,setLogs]=useState([]);
  const [running,setRunning]=useState(false);
  const addLog=(msg,type='info')=>setLogs(p=>[{msg,type,time:new Date().toLocaleTimeString('fr-BE'),id:Date.now()},...p]);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const actions=[
    {id:'embauche',icon:'🟢',label:'Nouvelle embauche',desc:'Dimona IN + Contrat + Fiche employé + Calcul premier salaire',color:'#22c55e'},
    {id:'depart',icon:'🔴',label:'Départ employé',desc:'Dimona OUT + C4 + Solde de tout compte + Attestation',color:'#ef4444'},
    {id:'modification',icon:'🔵',label:'Modification contrat',desc:'Avenant + Mise à jour fiche + Recalcul salaire',color:'#3b82f6'},
    {id:'maladie',icon:'🟡',label:'Déclaration maladie',desc:'Attestation maladie + Calcul salaire garanti + Mutuelle',color:'#eab308'},
  ];

  const runEmbauche=async()=>{
    setRunning(true);
    const fd=formData;
    const name=fd.first+' '+fd.last;
    addLog('🟢 EMBAUCHE — '+name,'info');
    addLog('📋 Étape 1/5 : Création Dimona IN...','info');
    await new Promise(r=>setTimeout(r,400));
    addLog('✅ Dimona IN générée — NISS: '+fd.niss+' — Début: '+fd.startDate,'success');
    addLog('📝 Étape 2/5 : Génération contrat de travail...','info');
    await new Promise(r=>setTimeout(r,400));
    addLog('✅ Contrat '+fd.contractType+' généré — '+fd.fonction+' — '+f2(fd.brut)+'€ brut','success');
    addLog('👤 Étape 3/5 : Création fiche employé...','info');
    await new Promise(r=>setTimeout(r,300));
    // Add employee to client
    const newEmp={id:'EMP-'+Date.now(),first:fd.first,last:fd.last,niss:fd.niss,email:fd.email,phone:fd.phone,startDate:fd.startDate,contractType:fd.contractType,monthlySalary:fd.brut,function:fd.fonction,whWeek:fd.whWeek,statut:'employe',status:'actif'};
    const targetClient=fd.client||clients[0]?.company?.name;
    const updClients=clients.map(c=>c.company?.name===targetClient?{...c,emps:[...(c.emps||[]),newEmp]}:c);
    d({type:'SET_CLIENTS',data:updClients});
    addLog('✅ Fiche employé créée et ajoutée à '+targetClient,'success');
    addLog('🧮 Étape 4/5 : Calcul premier salaire...','info');
    await new Promise(r=>setTimeout(r,300));
    const brut=+fd.brut;const ppR=calcPrecompteExact(brut,{situation:'isole',enfants:0});const onss=Math.round(brut*TX_ONSS_W*100)/100;const pp=ppR.pp;const net=Math.round((brut-onss-pp+calcBonusEmploi(brut))*100)/100;
    addLog('✅ Brut: '+f2(brut)+'€ → ONSS: -'+f2(onss)+'€ → PP: -'+f2(pp)+'€ → Net: '+f2(net)+'€','success');
    addLog('📧 Étape 5/5 : Préparation documents...','info');
    await new Promise(r=>setTimeout(r,300));
    addLog('✅ Documents prêts : Dimona IN, Contrat, Fiche de paie','success');
    addLog('🎉 EMBAUCHE COMPLÈTE — '+name+' est prêt(e) !','success');
    setRunning(false);
  };

  const runDepart=async()=>{
    setRunning(true);
    const fd=formData;
    const name=fd.first+' '+fd.last;
    addLog('🔴 DÉPART — '+name,'info');
    addLog('📋 Étape 1/4 : Dimona OUT...','info');
    await new Promise(r=>setTimeout(r,400));
    addLog('✅ Dimona OUT — Fin: '+(fd.endDate||new Date().toISOString().slice(0,10)),'success');
    addLog('📄 Étape 2/4 : Génération C4...','info');
    await new Promise(r=>setTimeout(r,400));
    try{const emp={first:fd.first,last:fd.last,niss:fd.niss,startDate:fd.startDate,endDate:fd.endDate,endReason:fd.endReason,endInitiative:fd.endInitiative,monthlySalary:fd.brut};generateC4PDF(emp,clients.find(c=>c.company?.name===fd.client)?.company||{});}catch(e){console.error('[C4] Echec generation:',e.message);addLog('❌ Erreur C4: '+e.message,'error');}
    addLog('✅ C4 généré — Motif: '+fd.endReason,'success');
    addLog('💰 Étape 3/4 : Solde de tout compte...','info');
    await new Promise(r=>setTimeout(r,400));
    try{generateSoldeCompte({first:fd.first,last:fd.last,monthlySalary:fd.brut},clients.find(c=>c.company?.name===fd.client)?.company||{});}catch(e){console.error('[SoldeCompte] Echec:',e.message);addLog('❌ Erreur solde: '+e.message,'error');}
    addLog('✅ Solde de tout compte généré','success');
    addLog('📄 Étape 4/4 : Attestation emploi...','info');
    await new Promise(r=>setTimeout(r,300));
    try{generateAttestationEmploi({first:fd.first,last:fd.last,niss:fd.niss,startDate:fd.startDate,function:fd.fonction,contractType:fd.contractType,whWeek:fd.whWeek,monthlySalary:fd.brut},clients.find(c=>c.company?.name===fd.client)?.company||{});}catch(e){console.error('[Attestation] Echec:',e.message);addLog('❌ Erreur attestation: '+e.message,'error');}
    addLog('✅ Attestation emploi générée','success');
    addLog('🔴 DÉPART COMPLÉTÉ — Tous les documents sont prêts','success');
    setRunning(false);
  };

  const runModification=async()=>{
    setRunning(true);
    const fd=formData;
    const name=fd.first+' '+fd.last;
    addLog('🔵 MODIFICATION CONTRAT — '+name,'info');
    addLog('📋 Étape 1/4 : Recherche employé dans le dossier...','info');
    await new Promise(r=>setTimeout(r,400));
    const targetClient=fd.client||clients[0]?.company?.name;
    const cl=clients.find(c=>c.company?.name===targetClient);
    const existingEmp=cl?(cl.emps||[]).find(e=>(e.first||e.fn)===fd.first&&(e.last||e.ln)===fd.last):null;
    if(existingEmp){
      addLog('✅ Employé trouvé — '+targetClient,'success');
    } else {
      addLog('⚠️ Employé non trouvé dans '+targetClient+' — Création avenant sur base du formulaire','warn');
    }
    addLog('📝 Étape 2/4 : Génération avenant au contrat...','info');
    await new Promise(r=>setTimeout(r,400));
    const oldBrut=existingEmp?+(existingEmp.monthlySalary||existingEmp.gross||0):0;
    const newBrut=+fd.brut;
    const avenantHtml='<!DOCTYPE html><html><head><meta charset="utf-8"><title>Avenant '+name+'</title><style>*{margin:0;padding:0}body{font-family:Arial,sans-serif;font-size:12px;padding:40px;max-width:800px;margin:auto;line-height:1.6}@media print{button{display:none!important}}</style></head><body><h2 style="text-align:center;text-decoration:underline;margin:20px">AVENANT AU CONTRAT DE TRAVAIL</h2><p><b>'+(cl?.company?.name||targetClient)+'</b> ('+(cl?.company?.vat||'')+')</p><p>Travailleur: <b>'+name+'</b> (NISS: '+(fd.niss||'N/A')+')</p><hr style="margin:15px 0"/><p>Les parties conviennent des modifications suivantes, prenant effet au <b>'+(fd.startDate||new Date().toISOString().slice(0,10))+'</b> :</p><ul style="margin:10px 20px">'+(newBrut!==oldBrut&&newBrut>0?'<li>Rémunération brute mensuelle : '+(oldBrut>0?f2(oldBrut)+' € → ':'')+f2(newBrut)+' €</li>':'')+(fd.fonction?'<li>Fonction : <b>'+fd.fonction+'</b></li>':'')+(fd.contractType?'<li>Type de contrat : <b>'+fd.contractType+'</b></li>':'')+(fd.whWeek?'<li>Régime horaire : <b>'+fd.whWeek+'h/semaine</b></li>':'')+'</ul><p>Les autres clauses du contrat initial restent inchangées.</p><div style="display:flex;justify-content:space-between;margin-top:40px"><div style="border-top:1px solid #000;width:45%;text-align:center;padding-top:5px">Signature employeur</div><div style="border-top:1px solid #000;width:45%;text-align:center;padding-top:5px">Signature travailleur</div></div><div style="text-align:center;margin-top:20px"><button onclick="window.print()">Imprimer</button></div></body></html>';
    previewHTML(avenantHtml,'Avenant_'+name.replace(/ /g,'_'));
    addLog('✅ Avenant généré — Effectif: '+fd.startDate,'success');
    addLog('👤 Étape 3/4 : Mise à jour fiche employé...','info');
    await new Promise(r=>setTimeout(r,300));
    if(existingEmp){
      const updClients=clients.map(c=>c.company?.name===targetClient?{...c,emps:(c.emps||[]).map(e=>e===existingEmp?{...e,monthlySalary:newBrut||e.monthlySalary,function:fd.fonction||e.function,contractType:fd.contractType||e.contractType,whWeek:fd.whWeek||e.whWeek}:e)}:c);
      d({type:'SET_CLIENTS',data:updClients});
      addLog('✅ Fiche employé mise à jour','success');
    } else {
      addLog('⚠️ Mise à jour manuelle nécessaire','warn');
    }
    addLog('🧮 Étape 4/4 : Recalcul salaire...','info');
    await new Promise(r=>setTimeout(r,300));
    const brut=newBrut||oldBrut;
    if(brut>0){const ppR=calcPrecompteExact(brut,{situation:'isole',enfants:0});const onss=Math.round(brut*TX_ONSS_W*100)/100;const pp=ppR.pp;const net=Math.round((brut-onss-pp+calcBonusEmploi(brut))*100)/100;
    addLog('✅ Nouveau net: '+f2(brut)+'€ brut → '+f2(net)+'€ net','success');}
    addLog('🔵 MODIFICATION COMPLÈTE — Avenant prêt pour signature','success');
    setRunning(false);
  };

  const runMaladie=async()=>{
    setRunning(true);
    const fd=formData;
    const name=fd.first+' '+fd.last;
    addLog('🟡 DÉCLARATION MALADIE — '+name,'info');
    addLog('📋 Étape 1/4 : Enregistrement incapacité...','info');
    await new Promise(r=>setTimeout(r,400));
    const debutMaladie=fd.startDate||new Date().toISOString().slice(0,10);
    const finMaladie=fd.endDate||new Date(new Date(debutMaladie).getTime()+30*24*60*60*1000).toISOString().slice(0,10);
    const joursM=Math.ceil((new Date(finMaladie)-new Date(debutMaladie))/(1000*60*60*24));
    addLog('✅ Incapacité enregistrée du '+debutMaladie+' au '+finMaladie+' ('+joursM+' jours)','success');
    addLog('💰 Étape 2/4 : Calcul salaire garanti...','info');
    await new Promise(r=>setTimeout(r,400));
    const brut=+fd.brut||0;
    const jGaranti=Math.min(joursM,30);
    const jMutuelle=Math.max(joursM-30,0);
    const salGaranti30=jGaranti<=14?Math.round(brut*jGaranti/22*100)/100:Math.round((brut*14/22+brut*(Math.min(jGaranti,28)-14)/22*0.857+brut*Math.max(jGaranti-28,0)/22*0.857)*100)/100;
    addLog('✅ Salaire garanti ('+jGaranti+'j) : '+f2(salGaranti30)+'€','success');
    if(jGaranti<=14)addLog('   → 30 premiers jours : 100% à charge employeur','info');
    else addLog('   → J1-14 : 100% | J15-28 : 85,7% | J29-30 : 85,7% (employeur)','info');
    if(jMutuelle>0)addLog('   → Après 30j : mutuelle prend le relais ('+jMutuelle+'j restants)','info');
    addLog('📄 Étape 3/4 : Génération attestation maladie...','info');
    await new Promise(r=>setTimeout(r,300));
    const attestHtml='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0}body{font-family:Arial,sans-serif;font-size:12px;padding:40px;max-width:800px;margin:auto;line-height:1.6}table{width:100%;border-collapse:collapse;margin:15px 0}th,td{padding:6px 10px;border:1px solid #ccc;text-align:left}@media print{button{display:none!important}}</style></head><body><h2 style="text-align:center;text-decoration:underline;margin:20px">ATTESTATION D\'INCAPACITÉ DE TRAVAIL</h2><p><b>'+(clients.find(c=>c.company?.name===fd.client)?.company?.name||fd.client||'Entreprise')+'</b></p><table><tr><th>Travailleur</th><td>'+name+'</td></tr><tr><th>NISS</th><td>'+(fd.niss||'N/A')+'</td></tr><tr><th>Début incapacité</th><td>'+debutMaladie+'</td></tr><tr><th>Fin prévue</th><td>'+finMaladie+'</td></tr><tr><th>Durée</th><td>'+joursM+' jours</td></tr></table><h3 style="margin:20px 0 10px">Calcul salaire garanti</h3><table><tr><th>Période</th><th>Jours</th><th>Taux</th><th>Montant</th></tr>'+(jGaranti>=1?'<tr><td>J1-14 (100%)</td><td>'+Math.min(jGaranti,14)+'</td><td>100%</td><td>'+f2(brut*Math.min(jGaranti,14)/22)+' €</td></tr>':'')+(jGaranti>14?'<tr><td>J15-28 (85,7%)</td><td>'+Math.min(jGaranti-14,14)+'</td><td>85,7%</td><td>'+f2(brut*Math.min(jGaranti-14,14)/22*0.857)+' €</td></tr>':'')+(jGaranti>28?'<tr><td>J29-30 (85,7%)</td><td>'+(jGaranti-28)+'</td><td>85,7%</td><td>'+f2(brut*(jGaranti-28)/22*0.857)+' €</td></tr>':'')+(jMutuelle>0?'<tr style="color:#888"><td>Mutuelle (après 30j)</td><td>'+jMutuelle+'</td><td>60%</td><td>Prise en charge mutuelle</td></tr>':'')+'<tr style="font-weight:700"><td>Total garanti employeur</td><td>'+jGaranti+'</td><td></td><td>'+f2(salGaranti30)+' €</td></tr></table><p style="margin-top:20px;font-size:10px;color:#666">Certificat médical à fournir dans les 48h (art. 31 Loi du 03/07/1978). Le médecin-contrôle peut être envoyé.</p><div style="text-align:center;margin-top:20px"><button onclick="window.print()">Imprimer</button></div></body></html>';
    previewHTML(attestHtml,'Attestation_maladie_'+name.replace(/ /g,'_'));
    addLog('✅ Attestation maladie générée','success');
    addLog('📧 Étape 4/4 : Notification mutuelle...','info');
    await new Promise(r=>setTimeout(r,300));
    if(jMutuelle>0){
      addLog('✅ Dossier mutuelle préparé — Relais au jour 31','success');
    } else {
      addLog('✅ Incapacité < 30j — Entièrement à charge employeur','success');
    }
    addLog('🟡 DÉCLARATION MALADIE COMPLÈTE — '+joursM+' jours enregistrés','success');
    setRunning(false);
  };

  const runAction=()=>{
    if(!formData.first||!formData.last){alert('Nom et prénom requis');return;}
    if(action==='embauche')runEmbauche();
    else if(action==='depart')runDepart();
    else if(action==='modification')runModification();
    else if(action==='maladie')runMaladie();
  };

  const fieldStyle={width:'100%',padding:'8px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',outline:'none',boxSizing:'border-box'};

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>⚡ Actions Rapides</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>1 clic = Tous les documents générés automatiquement</p>

    {/* Action selector */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:20}}>
      {actions.map(a=><button key={a.id} onClick={()=>setAction(a.id)} style={{padding:14,borderRadius:12,border:action===a.id?'2px solid '+a.color:'1px solid rgba(255,255,255,.05)',background:action===a.id?a.color+'10':'rgba(255,255,255,.02)',cursor:'pointer',textAlign:'left'}}>
        <div style={{fontSize:20,marginBottom:4}}>{a.icon}</div>
        <div style={{fontSize:12,fontWeight:600,color:action===a.id?a.color:'#e5e5e5'}}>{a.label}</div>
        <div style={{fontSize:9,color:'#888',marginTop:2}}>{a.desc}</div>
      </button>)}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
      {/* FORM */}
      <div style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:14}}>📝 Informations</div>
        <div style={{display:'grid',gap:10}}>
          <div>
            <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Client / Entreprise</label>
            <select value={formData.client} onChange={e=>setFormData(p=>({...p,client:e.target.value}))} style={fieldStyle}>
              <option value="">— Sélectionner —</option>
              {clients.map((c,i)=><option key={i} value={c.company?.name}>{c.company?.name}</option>)}
            </select>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Prénom</label><input value={formData.first} onChange={e=>setFormData(p=>({...p,first:e.target.value}))} style={fieldStyle} placeholder="Jean"/></div>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Nom</label><input value={formData.last} onChange={e=>setFormData(p=>({...p,last:e.target.value}))} style={fieldStyle} placeholder="Dupont"/></div>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>NISS</label><input value={formData.niss} onChange={e=>setFormData(p=>({...p,niss:e.target.value}))} style={fieldStyle} placeholder="XX.XX.XX-XXX.XX"/></div>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Email</label><input value={formData.email} onChange={e=>setFormData(p=>({...p,email:e.target.value}))} style={fieldStyle} placeholder="jean@email.com"/></div>
          </div>
          {action==='embauche'&&<>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8}}>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Date début</label><input type="date" value={formData.startDate} onChange={e=>setFormData(p=>({...p,startDate:e.target.value}))} style={fieldStyle}/></div>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Contrat</label><select value={formData.contractType} onChange={e=>setFormData(p=>({...p,contractType:e.target.value}))} style={fieldStyle}><option value="CDI">CDI</option><option value="CDD">CDD</option><option value="interim">Intérim</option><option value="student">Étudiant</option></select></div>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Brut mensuel</label><input type="number" value={formData.brut} onChange={e=>setFormData(p=>({...p,brut:+e.target.value}))} style={fieldStyle}/></div>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Fonction</label><input value={formData.fonction} onChange={e=>setFormData(p=>({...p,fonction:e.target.value}))} style={fieldStyle}/></div>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Régime horaire (h/sem)</label><input type="number" value={formData.whWeek} onChange={e=>setFormData(p=>({...p,whWeek:+e.target.value}))} style={fieldStyle}/></div>
            </div>
          </>}
          {action==='depart'&&<>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Date fin</label><input type="date" value={formData.endDate} onChange={e=>setFormData(p=>({...p,endDate:e.target.value}))} style={fieldStyle}/></div>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Motif</label><select value={formData.endReason} onChange={e=>setFormData(p=>({...p,endReason:e.target.value}))} style={fieldStyle}><option>Licenciement</option><option>Démission</option><option>Fin CDD</option><option>Rupture conventionnelle</option><option>Pension</option><option>Force majeure</option></select></div>
            </div>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Brut mensuel</label><input type="number" value={formData.brut} onChange={e=>setFormData(p=>({...p,brut:+e.target.value}))} style={fieldStyle}/></div>
          </>}
          {action==='modification'&&<>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8}}>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Date effet</label><input type="date" value={formData.startDate} onChange={e=>setFormData(p=>({...p,startDate:e.target.value}))} style={fieldStyle}/></div>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Nouveau contrat</label><select value={formData.contractType} onChange={e=>setFormData(p=>({...p,contractType:e.target.value}))} style={fieldStyle}><option value="CDI">CDI</option><option value="CDD">CDD</option><option value="interim">Intérim</option><option value="student">Étudiant</option></select></div>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Nouveau brut</label><input type="number" value={formData.brut} onChange={e=>setFormData(p=>({...p,brut:+e.target.value}))} style={fieldStyle}/></div>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Nouvelle fonction</label><input value={formData.fonction} onChange={e=>setFormData(p=>({...p,fonction:e.target.value}))} style={fieldStyle}/></div>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Régime horaire (h/sem)</label><input type="number" value={formData.whWeek} onChange={e=>setFormData(p=>({...p,whWeek:+e.target.value}))} style={fieldStyle}/></div>
            </div>
          </>}
          {action==='maladie'&&<>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8}}>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Début incapacité</label><input type="date" value={formData.startDate} onChange={e=>setFormData(p=>({...p,startDate:e.target.value}))} style={fieldStyle}/></div>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Fin prévue</label><input type="date" value={formData.endDate} onChange={e=>setFormData(p=>({...p,endDate:e.target.value}))} style={fieldStyle}/></div>
              <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Brut mensuel</label><input type="number" value={formData.brut} onChange={e=>setFormData(p=>({...p,brut:+e.target.value}))} style={fieldStyle}/></div>
            </div>
          </>}
          <button onClick={runAction} disabled={running} style={{padding:'14px',borderRadius:10,border:'none',background:running?'#333':'linear-gradient(135deg,'+actions.find(a=>a.id===action)?.color+','+actions.find(a=>a.id===action)?.color+'cc)',color:running?'#888':'#fff',fontWeight:700,fontSize:14,cursor:running?'wait':'pointer'}}>
            {running?'⏳ En cours...':'⚡ Lancer — '+actions.find(a=>a.id===action)?.label}
          </button>
        </div>
      </div>

      {/* LOGS */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'12px 16px',background:'rgba(198,163,78,.06)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span style={{fontSize:13,fontWeight:600,color:'#c6a34e'}}>📋 Exécution</span>
          <button onClick={()=>setLogs([])} style={{padding:'4px 10px',borderRadius:6,border:'none',background:'rgba(255,255,255,.05)',color:'#888',fontSize:10,cursor:'pointer'}}>Effacer</button>
        </div>
        <div style={{maxHeight:500,overflowY:'auto',padding:'8px 12px'}}>
          {logs.length===0?<div style={{textAlign:'center',padding:40,color:'#888',fontSize:11}}>Remplissez le formulaire et lancez l'action</div>:
          logs.map(l=><div key={l.id} style={{padding:'4px 8px',marginBottom:2,fontSize:11,color:l.type==='success'?'#22c55e':l.type==='error'?'#ef4444':l.type==='warn'?'#eab308':'#888',borderLeft:'2px solid '+(l.type==='success'?'#22c55e':l.type==='error'?'#ef4444':l.type==='warn'?'#eab308':'#333'),paddingLeft:10}}>
            <span style={{color:'#555',marginRight:8}}>{l.time}</span>{l.msg}
          </div>)}
        </div>
      </div>
    </div>
  </div>;
};


// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 25: PILOTE AUTOMATIQUE TOTAL — LA ROLLS ROYCE  ═══
// ═══ L'humain ne fait QUE la validation finale              ═══
// ══════════════════════════════════════════════════════════════


// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 25b: AUTOMATISATION NIVEAU SUPÉRIEUR           ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. COMPLIANCE RADAR — Conformité en temps réel ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 25c: SEPA + ALERTES + DECLARATIONS + SCHEDULER ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. SEPA XML GENERATOR ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 26: ANALYTICS + EXPORT COMPTABLE + AUDIT TRAIL ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. ANALYTICS DASHBOARD AVANCÉ ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 27: GED + PORTAIL EMPLOYE + DASHBOARD CLIENT   ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. GED — Gestion Electronique Documents ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 28: ABSENCES + RH BOARD + CONTRATS + BUDGET    ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. PLANIFICATEUR ABSENCES — Calendrier interactif ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 30: FACTURATION + VALIDATION + EXPORT BATCH    ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. MODULE FACTURATION — Facturer les clients ═══
const Facturation=({s})=>{
  const clients=s.clients||[];
  const [tarifParEmp,setTarifParEmp]=useState(25);
  const [tarifSetup,setTarifSetup]=useState(150);
  const [tva,setTva]=useState(21);
  const [selMonth,setSelMonth]=useState(new Date().getMonth());
  const [selYear,setSelYear]=useState(new Date().getFullYear());
  const [genFacture,setGenFacture]=useState(null);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];

  const factures=clients.map((cl,i)=>{
    const emps=(cl.emps||[]).length;
    const base=emps*tarifParEmp;
    const htva=base;
    const tvaAmt=Math.round(htva*tva/100*100)/100;
    const ttc=Math.round((htva+tvaAmt)*100)/100;
    return {
      id:'FACT-'+selYear+'-'+(selMonth+1+'').padStart(2,'0')+'-'+(i+1+'').padStart(3,'0'),
      client:cl.company?.name||'Client '+(i+1),
      vat:cl.company?.vat||'',
      address:cl.company?.address||'',
      emps,
      lines:[
        {desc:'Gestion paie — '+mois[selMonth]+' '+selYear+' ('+emps+' employes)',qty:emps,unit:tarifParEmp,total:base},
      ],
      htva,tvaRate:tva,tvaAmt,ttc,
      date:new Date(selYear,selMonth,28).toLocaleDateString('fr-BE'),
      echeance:new Date(selYear,selMonth+1,15).toLocaleDateString('fr-BE'),
      status:Math.random()>0.3?'paid':'pending',
    };
  });

  const totalHTVA=factures.reduce((a,f)=>a+f.htva,0);
  const totalTTC=factures.reduce((a,f)=>a+f.ttc,0);
  const totalPaid=factures.filter(f=>f.status==='paid').reduce((a,f)=>a+f.ttc,0);

  const generateInvoicePDF=(fact)=>{
    const html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:auto;color:#1a1a1a;font-size:11px}.logo{font-size:24px;font-weight:800;color:#c6a34e;font-family:Georgia,serif;margin-bottom:4px}.sub{font-size:10px;color:#888}h1{font-size:16px;margin:20px 0 5px;color:#1a365d}table{width:100%;border-collapse:collapse;margin:12px 0}th{background:#f0ece3;padding:8px;text-align:left;font-size:10px}td{padding:8px;border-bottom:1px solid #eee}.r{text-align:right;font-family:monospace}.total-row{background:#f8f7f4;font-weight:700}.footer{margin-top:30px;font-size:9px;color:#999;border-top:1px solid #eee;padding-top:10px}@media print{button{display:none!important}}</style></head><body>'+
    '<div style="display:flex;justify-content:space-between"><div><div class="logo">AUREUS SOCIAL PRO</div><div class="sub">Aureus IA SPRL — BE 1028.230.781</div><div class="sub">Saint-Gilles, Bruxelles</div></div><div style="text-align:right"><h1 style="margin:0">FACTURE</h1><div style="font-size:14px;color:#c6a34e;font-weight:700">'+fact.id+'</div><div class="sub">Date: '+fact.date+'</div><div class="sub">Echeance: '+fact.echeance+'</div></div></div>'+
    '<div style="margin:20px 0;padding:12px;background:#f8f7f4;border-radius:6px"><b>'+fact.client+'</b><br>'+(fact.vat?'TVA: '+fact.vat+'<br>':'')+(fact.address||'')+'</div>'+
    '<table><tr><th>Description</th><th class="r">Qte</th><th class="r">PU</th><th class="r">Total</th></tr>'+
    (fact.lines||[]).map(l=>'<tr><td>'+l.desc+'</td><td class="r">'+l.qty+'</td><td class="r">'+f2(l.unit)+' EUR</td><td class="r">'+f2(l.total)+' EUR</td></tr>').join('')+
    '<tr class="total-row"><td colspan="3" class="r">Sous-total HTVA</td><td class="r">'+f2(fact.htva)+' EUR</td></tr>'+
    '<tr><td colspan="3" class="r">TVA '+fact.tvaRate+'%</td><td class="r">'+f2(fact.tvaAmt)+' EUR</td></tr>'+
    '<tr class="total-row" style="font-size:14px"><td colspan="3" class="r">TOTAL TTC</td><td class="r" style="color:#c6a34e">'+f2(fact.ttc)+' EUR</td></tr></table>'+
    '<div style="margin:20px 0;padding:12px;background:#f0f8f0;border:1px solid #c3e6cb;border-radius:6px;font-size:10px"><b>Coordonnees bancaires</b><br>IBAN: BE00 0000 0000 0000<br>BIC: GEBABEBB<br>Communication: '+fact.id+'</div>'+
    '<div class="footer">Aureus IA SPRL — BCE BE 1028.230.781 — TVA BE 1028.230.781<br>Conditions: paiement a 15 jours. Interet de retard: 10% annuel.</div>'+
    '<div style="text-align:center;margin-top:20px"><button onclick="window.print()" style="padding:10px 30px;background:#c6a34e;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Imprimer / PDF</button></div></body></html>';
    const w=window.open('','_blank');if(w){w.document.write(html);w.document.close();}
  };

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🧾 Facturation</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Facturation mensuelle des services de paie</p>
      </div>
      <div style={{display:'flex',gap:6}}>
        <select value={selMonth} onChange={e=>setSelMonth(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
          {mois.map((m,i)=><option key={i} value={i}>{m}</option>)}
        </select>
        <input type="number" value={selYear} onChange={e=>setSelYear(+e.target.value)} style={{width:70,padding:'6px 8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',textAlign:'center'}}/>
      </div>
    </div>

    {/* Config */}
    <div style={{display:'grid',gridTemplateColumns:'200px 200px 150px 1fr',gap:10,marginBottom:16,padding:12,background:'rgba(198,163,78,.03)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}>
      <div>
        <label style={{fontSize:9,color:'#888',display:'block',marginBottom:2}}>Tarif / employe / mois</label>
        <div style={{display:'flex',alignItems:'center',gap:4}}>
          <input type="number" value={tarifParEmp} onChange={e=>setTarifParEmp(+e.target.value)} style={{width:60,padding:'6px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:14,fontWeight:700,fontFamily:'inherit',textAlign:'center'}}/>
          <span style={{fontSize:11,color:'#888'}}>EUR</span>
        </div>
      </div>
      <div>
        <label style={{fontSize:9,color:'#888',display:'block',marginBottom:2}}>Setup fee (one-time)</label>
        <div style={{display:'flex',alignItems:'center',gap:4}}>
          <input type="number" value={tarifSetup} onChange={e=>setTarifSetup(+e.target.value)} style={{width:60,padding:'6px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',textAlign:'center'}}/>
          <span style={{fontSize:11,color:'#888'}}>EUR</span>
        </div>
      </div>
      <div>
        <label style={{fontSize:9,color:'#888',display:'block',marginBottom:2}}>TVA (%)</label>
        <select value={tva} onChange={e=>setTva(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
          <option value="21">21%</option><option value="6">6%</option><option value="0">0% (exonere)</option>
        </select>
      </div>
      <div style={{display:'flex',gap:10,alignItems:'flex-end'}}>
        <div style={{textAlign:'center',flex:1}}>
          <div style={{fontSize:18,fontWeight:700,color:'#c6a34e'}}>{f2(totalHTVA)} EUR</div>
          <div style={{fontSize:9,color:'#888'}}>CA mensuel HTVA</div>
        </div>
        <div style={{textAlign:'center',flex:1}}>
          <div style={{fontSize:18,fontWeight:700,color:'#22c55e'}}>{f2(totalTTC)} EUR</div>
          <div style={{fontSize:9,color:'#888'}}>Total TTC</div>
        </div>
      </div>
    </div>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:10,marginBottom:14}}>
      {[{l:'Factures',v:factures.length,c:'#3b82f6'},{l:'Total HTVA',v:f2(totalHTVA)+'E',c:'#c6a34e'},{l:'Total TTC',v:f2(totalTTC)+'E',c:'#e5e5e5'},{l:'Paye',v:f2(totalPaid)+'E',c:'#22c55e'},{l:'CA annuel proj.',v:f2(totalTTC*12)+'E',c:'#a855f7'}].map((k,i)=>
        <div key={i} style={{padding:10,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:10,textAlign:'center'}}>
          <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
        </div>
      )}
    </div>

    {/* Invoice table */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'120px 180px 80px 100px 80px 100px 100px 1fr',padding:'8px 12px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#888'}}>
        <div>N facture</div><div>Client</div><div>Employés</div><div>HTVA</div><div>TVA</div><div>TTC</div><div>Statut</div><div>Actions</div>
      </div>
      {factures.map((fact,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'120px 180px 80px 100px 80px 100px 100px 1fr',padding:'8px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
        <div style={{color:'#c6a34e',fontWeight:600,fontSize:10}}>{fact.id}</div>
        <div style={{color:'#e5e5e5',fontWeight:500}}>{fact.client}</div>
        <div style={{color:'#3b82f6'}}>{fact.emps}</div>
        <div style={{color:'#e5e5e5'}}>{f2(fact.htva)}</div>
        <div style={{color:'#888'}}>{f2(fact.tvaAmt)}</div>
        <div style={{color:'#c6a34e',fontWeight:700}}>{f2(fact.ttc)}</div>
        <div><span style={{padding:'2px 8px',borderRadius:4,fontSize:9,fontWeight:600,background:fact.status==='paid'?'rgba(34,197,94,.1)':'rgba(234,179,8,.1)',color:fact.status==='paid'?'#22c55e':'#eab308'}}>{fact.status==='paid'?'Paye':'En attente'}</span></div>
        <div style={{display:'flex',gap:4}}>
          <button onClick={()=>generateInvoicePDF(fact)} style={{padding:'4px 8px',borderRadius:4,border:'none',background:'rgba(198,163,78,.08)',color:'#c6a34e',fontSize:9,cursor:'pointer',fontFamily:'inherit'}}>📄 PDF</button>
          <button onClick={()=>{try{sendEmailReal(fact.client+'@email.com','Facture '+fact.id+' — Aureus Social Pro','<p>Veuillez trouver ci-joint votre facture '+fact.id+'.</p>',[]);if(typeof addToast==='function')addToast('📧 Facture '+fact.id+' envoyée à '+fact.client);else alert('📧 Facture '+fact.id+' envoyée à '+fact.client);}catch(e){alert('❌ Erreur envoi email: '+e.message+'\n\nVérifiez la configuration RESEND_API_KEY.');}}} style={{padding:'4px 8px',borderRadius:4,border:'none',background:'rgba(59,130,246,.08)',color:'#3b82f6',fontSize:9,cursor:'pointer',fontFamily:'inherit'}}>📧 Envoyer</button>
        </div>
      </div>)}
      <div style={{display:'grid',gridTemplateColumns:'120px 180px 80px 100px 80px 100px 100px 1fr',padding:'10px 12px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:700}}>
        <div style={{color:'#c6a34e'}}>TOTAL</div><div></div>
        <div style={{color:'#3b82f6'}}>{factures.reduce((a,f)=>a+f.emps,0)}</div>
        <div style={{color:'#e5e5e5'}}>{f2(totalHTVA)}</div>
        <div style={{color:'#888'}}>{f2(factures.reduce((a,f)=>a+f.tvaAmt,0))}</div>
        <div style={{color:'#c6a34e'}}>{f2(totalTTC)}</div>
        <div></div><div></div>
      </div>
    </div>
  </div>;
};

// ═══ 2. VALIDATION ENGINE — Pre-flight checks ═══
const ValidationEngine=({s})=>{
  const clients=s.clients||[];
  const [running,setRunning]=useState(false);
  const [results,setResults]=useState(null);

  const runValidation=()=>{
    setRunning(true);
    const checks=[];
    let totalPass=0,totalFail=0,totalWarn=0;

    clients.forEach(cl=>{
      const co=cl.company||{};
      const emps=cl.emps||[];
      const clientChecks=[];

      // Company checks
      if(!co.name) clientChecks.push({cat:'Entreprise',sev:'error',msg:'Nom societe manquant',fix:'Completer les informations societe'});
      else clientChecks.push({cat:'Entreprise',sev:'pass',msg:'Nom societe: '+co.name});
      if(!co.vat) clientChecks.push({cat:'Entreprise',sev:'error',msg:'N TVA manquant',fix:'Ajouter le numero TVA (BCE)'});
      else clientChecks.push({cat:'Entreprise',sev:'pass',msg:'TVA: '+co.vat});
      if(!co.address) clientChecks.push({cat:'Entreprise',sev:'warn',msg:'Adresse manquante',fix:'Ajouter adresse siege social'});
      if(!co.cp) clientChecks.push({cat:'Entreprise',sev:'warn',msg:'Commission paritaire non definie',fix:'Definir la CP (ex: 200)'});
      else clientChecks.push({cat:'Entreprise',sev:'pass',msg:'CP: '+co.cp});

      // Employee checks
      emps.forEach(e=>{
        const name=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
        const brut=+(e.monthlySalary||e.gross||0);

        // Identity
        if(!e.niss&&!e.NISS) clientChecks.push({cat:'Identite',sev:'error',msg:name+' — NISS manquant',fix:'Completer le numero national'});
        else clientChecks.push({cat:'Identite',sev:'pass',msg:name+' — NISS present'});
        if(!e.iban&&!e.IBAN) clientChecks.push({cat:'Bancaire',sev:'error',msg:name+' — IBAN manquant',fix:'Ajouter coordonnees bancaires'});
        else clientChecks.push({cat:'Bancaire',sev:'pass',msg:name+' — IBAN present'});
        if(!e.email) clientChecks.push({cat:'Contact',sev:'warn',msg:name+' — Email manquant',fix:'Ajouter email pour envoi fiche'});

        // Salary
        if(brut<=0) clientChecks.push({cat:'Salaire',sev:'error',msg:name+' — Salaire brut = 0',fix:'Definir le salaire mensuel brut'});
        else if(brut<1900) clientChecks.push({cat:'Salaire',sev:'warn',msg:name+' — Brut ('+brut+'EUR) possiblement sous RMMMG',fix:'Verifier bareme sectoriel'});
        else clientChecks.push({cat:'Salaire',sev:'pass',msg:name+' — Brut: '+brut+' EUR'});

        // Contract
        if(!e.startDate&&!e.start) clientChecks.push({cat:'Contrat',sev:'warn',msg:name+' — Date debut manquante',fix:'Completer date entree en service'});
        if((e.contractType||'CDI')==='CDD'){
          if(!e.endDate&&!e.end) clientChecks.push({cat:'Contrat',sev:'warn',msg:name+' — CDD sans date de fin',fix:'Definir date fin CDD'});
          else{
            const end=new Date(e.endDate||e.end);
            if(end<new Date()) clientChecks.push({cat:'Contrat',sev:'error',msg:name+' — CDD expire !',fix:'Renouveler ou convertir en CDI'});
          }
        }

        // Tax situation
        if(!e.civil) clientChecks.push({cat:'Fiscal',sev:'info',msg:name+' — Situation familiale non definie (defaut: isole)',fix:'Preciser situation pour precompte exact'});
      });

      clientChecks.forEach(c=>{
        if(c.sev==='pass') totalPass++;
        else if(c.sev==='error') totalFail++;
        else totalWarn++;
      });

      checks.push({client:co.name||'Client',emps:emps.length,checks:clientChecks});
    });

    setResults({checks,totalPass,totalFail,totalWarn,total:totalPass+totalFail+totalWarn,score:Math.round(totalPass/(totalPass+totalFail+totalWarn)*100)});
    setRunning(false);
  };

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>✅ Validation Pre-Paie</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Verification complete avant calcul des fiches</p>
      </div>
      <button onClick={runValidation} disabled={running} style={{padding:'10px 24px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontSize:13,fontWeight:700,cursor:'pointer',fontFamily:'inherit',opacity:running?0.5:1}}>{running?'Scan en cours...':'🔍 Lancer la validation'}</button>
    </div>

    {!results?<div style={{padding:60,textAlign:'center',color:'#888'}}>
      <div style={{fontSize:48,marginBottom:10}}>✅</div>
      <div style={{fontSize:14}}>Cliquez sur "Lancer la validation" pour scanner tous les dossiers</div>
    </div>:
    <div>
      {/* Score */}
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:16}}>
        {[{l:'Score global',v:results.score+'%',c:results.score>=80?'#22c55e':results.score>=60?'#eab308':'#ef4444'},{l:'Valides',v:results.totalPass,c:'#22c55e'},{l:'Erreurs',v:results.totalFail,c:'#ef4444'},{l:'Avertissements',v:results.totalWarn,c:'#eab308'}].map((k,i)=>
          <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
            <div style={{fontSize:22,fontWeight:700,color:k.c}}>{k.v}</div>
            <div style={{fontSize:10,color:'#888'}}>{k.l}</div>
          </div>
        )}
      </div>

      {/* Per client */}
      {(results.checks||[]).map((cl,ci)=>{
        const errors=cl.checks.filter(c=>c.sev==='error').length;
        const warns=cl.checks.filter(c=>c.sev==='warn').length;
        const passes=cl.checks.filter(c=>c.sev==='pass').length;
        return <div key={ci} style={{marginBottom:12,border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
          <div style={{padding:'10px 14px',background:errors>0?'rgba(239,68,68,.04)':'rgba(34,197,94,.04)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <span style={{fontSize:13,fontWeight:600,color:errors>0?'#ef4444':'#22c55e'}}>🏢 {cl.client} ({cl.emps} emp.)</span>
            <div style={{display:'flex',gap:8,fontSize:10}}>
              <span style={{color:'#22c55e'}}>✅ {passes}</span>
              <span style={{color:'#ef4444'}}>❌ {errors}</span>
              <span style={{color:'#eab308'}}>⚠ {warns}</span>
            </div>
          </div>
          <div style={{maxHeight:200,overflowY:'auto'}}>
            {cl.checks.filter(c=>c.sev!=='pass').map((c,j)=>
              <div key={j} style={{display:'flex',alignItems:'center',gap:10,padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.02)',fontSize:10}}>
                <span>{c.sev==='error'?'❌':c.sev==='warn'?'⚠':'ℹ'}</span>
                <span style={{color:'#888',minWidth:70}}>{c.cat}</span>
                <span style={{flex:1,color:c.sev==='error'?'#ef4444':c.sev==='warn'?'#eab308':'#888'}}>{c.msg}</span>
                {c.fix&&<span style={{fontSize:9,color:'#3b82f6',cursor:'pointer'}} title={c.fix}>💡 {c.fix}</span>}
              </div>
            )}
            {cl.checks.filter(c=>c.sev!=='pass').length===0&&<div style={{padding:12,textAlign:'center',color:'#22c55e',fontSize:11}}>✅ Tout est en ordre</div>}
          </div>
        </div>;
      })}
    </div>}
  </div>;
};

// ═══ 3. EXPORT BATCH — Download all payslips as ZIP-like package ═══
const ExportBatch=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(-1);
  const [exporting,setExporting]=useState(false);
  const [logs,setLogs]=useState([]);
  const [selMonth,setSelMonth]=useState(new Date().getMonth());
  const [selYear,setSelYear]=useState(new Date().getFullYear());
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];

  const addLog=(msg,type='info')=>setLogs(p=>[{msg,type,time:new Date().toLocaleTimeString('fr-BE')},...p]);

  const runExport=async()=>{
    setExporting(true);
    setLogs([]);
    addLog('🚀 Export batch lance — '+mois[selMonth]+' '+selYear,'info');
    const targetClients=selClient===-1?clients:[clients[selClient]];
    let count=0;

    for(const cl of targetClients){
      const co=cl.company||{};
      addLog('🏢 '+( co.name||'Client'),'info');
      for(const e of (cl.emps||[])){
        const name=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
        const brut=+(e.monthlySalary||e.gross||0);
        if(brut<=0){addLog('  ⚠ '+name+' — brut=0, ignore','warn');continue;}
        const onss=Math.round(brut*TX_ONSS_W*100)/100;
        const _sit=e.civil==='married_1'?'marie_1r':e.civil==='married_2'?'marie_2r':e.civil==='cohabit'?'marie_2r':'isole';
        const ppR=calcPrecompteExact(brut,{situation:_sit,enfants:+(e.depChildren||0)});
        const net=Math.round((brut-onss-ppR.pp+calcBonusEmploi(brut))*100)/100;
        try{
          generatePayslipPDF(e,{gross:brut,onssP:onss,imposable:brut-onss,pp:ppR.pp,net,onssE:Math.round(brut*TX_ONSS_E*100)/100,coutTotal:Math.round(brut*(1+TX_ONSS_E)*100)/100},{month:selMonth+1,year:selYear},co);
          count++;
          addLog('  ✅ '+name+' — Net: '+f2(net)+' EUR','success');
        }catch(ex){
          addLog('  ❌ '+name+' — Erreur generation: '+ex.message,'error');
        }
        await new Promise(r=>setTimeout(r,100));
      }
    }
    addLog('═══════════════════════════════════════','info');
    addLog('✅ '+count+' fiches generees avec succes','success');
    setExporting(false);
  };

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📦 Export Batch</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Generer toutes les fiches de paie d un coup</p>
      </div>
      <div style={{display:'flex',gap:6}}>
        <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
          <option value={-1}>Tous les clients</option>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
        </select>
        <select value={selMonth} onChange={e=>setSelMonth(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
          {mois.map((m,i)=><option key={i} value={i}>{m}</option>)}
        </select>
        <input type="number" value={selYear} onChange={e=>setSelYear(+e.target.value)} style={{width:65,padding:'6px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',textAlign:'center'}}/>
        <button onClick={runExport} disabled={exporting} style={{padding:'8px 20px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontSize:12,fontWeight:700,cursor:'pointer',fontFamily:'inherit',opacity:exporting?0.5:1}}>📦 {exporting?'Export...':'Exporter tout'}</button>
      </div>
    </div>

    {/* Summary */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:10,marginBottom:14}}>
      {[{l:'Clients',v:selClient===-1?clients.length:1,c:'#3b82f6'},{l:'Employes',v:(selClient===-1?clients:[ clients[selClient]||{emps:[]}]).reduce((a,c)=>a+(c.emps||[]).length,0),c:'#c6a34e'},{l:'Fiches a generer',v:(selClient===-1?clients:[clients[selClient]||{emps:[]}]).reduce((a,c)=>a+(c.emps||[]).filter(e=>+(e.monthlySalary||e.gross||0)>0).length,0),c:'#22c55e'}].map((k,i)=>
        <div key={i} style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:10,textAlign:'center'}}>
          <div style={{fontSize:20,fontWeight:700,color:k.c}}>{k.v}</div>
          <div style={{fontSize:10,color:'#888'}}>{k.l}</div>
        </div>
      )}
    </div>

    {/* Logs */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden',maxHeight:400,overflowY:'auto'}}>
      <div style={{padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>📋 Journal ({logs.length})</div>
      {logs.length===0?<div style={{padding:30,textAlign:'center',color:'#888',fontSize:11}}>Cliquez sur "Exporter tout" pour commencer</div>:
      logs.map((l,i)=><div key={i} style={{padding:'5px 14px',borderBottom:'1px solid rgba(255,255,255,.02)',fontSize:10,display:'flex',gap:8}}>
        <span style={{color:'#888',fontFamily:'monospace',fontSize:9}}>{l.time}</span>
        <span style={{color:l.type==='success'?'#22c55e':l.type==='error'?'#ef4444':l.type==='warn'?'#eab308':'#888'}}>{l.msg}</span>
      </div>)}
    </div>
  </div>;
};

// ═══ 4. RGPD MANAGER — Conformite donnees ═══
const RGPDManager=({s})=>{
  const clients=s.clients||[];
  const allEmps=clients.reduce((a,c)=>[...a,...(c.emps||[]).map(e=>({...e,client:c.company?.name||''}))] ,[]);
  const now=new Date();
  const [showExport,setShowExport]=useState(null);

  const dataPoints=[
    {field:'Nom / Prenom',count:allEmps.length,obligatoire:true,base:'Execution contrat',retention:'Fin contrat + 5 ans'},
    {field:'NISS',count:allEmps.filter(e=>e.niss||e.NISS).length,obligatoire:true,base:'Obligation legale (ONSS)',retention:'Fin contrat + 10 ans'},
    {field:'IBAN',count:allEmps.filter(e=>e.iban||e.IBAN).length,obligatoire:true,base:'Execution contrat',retention:'Fin contrat + 5 ans'},
    {field:'Email',count:allEmps.filter(e=>e.email).length,obligatoire:false,base:'Interet legitime',retention:'Fin contrat + 1 an'},
    {field:'Telephone',count:allEmps.filter(e=>e.phone).length,obligatoire:false,base:'Interet legitime',retention:'Fin contrat + 1 an'},
    {field:'Adresse',count:allEmps.filter(e=>e.addr||e.address).length,obligatoire:false,base:'Execution contrat',retention:'Fin contrat + 5 ans'},
    {field:'Situation familiale',count:allEmps.filter(e=>e.civil).length,obligatoire:true,base:'Obligation legale (PP)',retention:'Fin contrat + 5 ans'},
    {field:'Enfants a charge',count:allEmps.filter(e=>e.depChildren>0).length,obligatoire:true,base:'Obligation legale (PP)',retention:'Fin contrat + 5 ans'},
    {field:'Salaire',count:allEmps.filter(e=>+(e.monthlySalary||e.gross||0)>0).length,obligatoire:true,base:'Execution contrat',retention:'Fin contrat + 10 ans'},
  ];

  const exportEmployeeData=(emp)=>{
    const data={nom:(emp.first||'')+' '+(emp.last||''),niss:emp.niss||emp.NISS||'N/A',email:emp.email||'N/A',iban:emp.iban||emp.IBAN||'N/A',telephone:emp.phone||'N/A',adresse:emp.addr||'N/A',situation:emp.civil||'N/A',enfants:emp.depChildren||0,salaire:emp.monthlySalary||emp.gross||0,contrat:emp.contractType||'CDI',debut:emp.startDate||emp.start||'N/A',client:emp.client};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='rgpd_export_'+(emp.first||'')+'_'+(emp.last||'')+'.json';a.click();URL.revokeObjectURL(url);
  };

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🔒 RGPD — Protection des donnees</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Registre de traitement et droits des personnes concernees</p>

    {/* Data registry */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden',marginBottom:16}}>
      <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>📋 Registre des traitements (Art. 30 RGPD)</div>
      <div style={{display:'grid',gridTemplateColumns:'140px 60px 60px 140px 160px',padding:'6px 14px',background:'rgba(198,163,78,.03)',fontSize:9,fontWeight:600,color:'#888'}}>
        <div>Donnee</div><div>Nb</div><div>Oblig.</div><div>Base legale</div><div>Duree retention</div>
      </div>
      {dataPoints.map((dp,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'140px 60px 60px 140px 160px',padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.02)',fontSize:10,alignItems:'center'}}>
        <div style={{color:'#e5e5e5',fontWeight:500}}>{dp.field}</div>
        <div style={{color:'#3b82f6'}}>{dp.count}/{allEmps.length}</div>
        <div>{dp.obligatoire?<span style={{color:'#ef4444',fontSize:9}}>Oui</span>:<span style={{color:'#888',fontSize:9}}>Non</span>}</div>
        <div style={{color:'#888',fontSize:9}}>{dp.base}</div>
        <div style={{color:'#888',fontSize:9}}>{dp.retention}</div>
      </div>)}
    </div>

    {/* Employee data rights */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#3b82f6'}}>👤 Droits des personnes (Art. 15-20 RGPD)</div>
      {allEmps.map((e,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.02)'}}>
        <div>
          <div style={{fontSize:11,color:'#e5e5e5',fontWeight:500}}>{(e.first||'')+' '+(e.last||'')}</div>
          <div style={{fontSize:9,color:'#888'}}>{e.client}</div>
        </div>
        <div style={{display:'flex',gap:4}}>
          <button onClick={()=>exportEmployeeData(e)} style={{padding:'3px 8px',borderRadius:4,border:'none',background:'rgba(59,130,246,.08)',color:'#3b82f6',fontSize:9,cursor:'pointer',fontFamily:'inherit'}}>📥 Exporter (Art.20)</button>
          <button onClick={()=>{const empName=(e.first||'')+' '+(e.last||'');if(confirm('RGPD Art. 17 — Droit à l\'effacement\n\nSupprimer toutes les données de '+empName+'?\n\nCette action est IRRÉVERSIBLE.\nLes données seront anonymisées conformément au RGPD.')){const updClients=(s.clients||[]).map(cl=>({...cl,emps:(cl.emps||[]).map(emp=>emp.id===e.id?{...emp,first:'[EFFACE]',last:'[EFFACE]',niss:'',email:'',phone:'',iban:'',address:'',status:'deleted',deletedAt:new Date().toISOString(),deletedReason:'RGPD Art.17'}:emp)}));d({type:'SET_CLIENTS',data:updClients});if(typeof addToast==='function')addToast('🗑 Données de '+empName+' effacées (RGPD Art.17)');else alert('✅ Données de '+empName+' effacées conformément au RGPD Art.17');}}} style={{padding:'3px 8px',borderRadius:4,border:'none',background:'rgba(239,68,68,.08)',color:'#ef4444',fontSize:9,cursor:'pointer',fontFamily:'inherit'}}>🗑 Effacer (Art.17)</button>
        </div>
      </div>)}
    </div>
  </div>;
};


// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 30: RECAP EMPLOYEUR + ENVOI MASSE              ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. RECAP EMPLOYEUR — Envoi recap mensuel au client ═══
const RecapEmployeur=({s,user})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState('all');
  const [month,setMonth]=useState(new Date().getMonth()+1);
  const [year,setYear]=useState(new Date().getFullYear());
  const [sending,setSending]=useState(false);
  const [results,setResults]=useState([]);
  const [preview,setPreview]=useState(null);
  const mois=['','Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const targetClients=selClient==='all'?clients:clients.filter(c=>c.id===selClient);

  const buildRecap=(cl)=>{
    const co=cl.company||{};
    const emps=cl.emps||[];
    const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);
    const totalONSS_W=Math.round(totalBrut*TX_ONSS_W*100)/100;
    const totalONSS_P=Math.round(totalBrut*TX_ONSS_E*100)/100;
    const totalImp=totalBrut-totalONSS_W;
    const totalPP=emps.reduce((a,e)=>{const b=+(e.monthlySalary||e.gross||0);const o=Math.round(b*TX_ONSS_W*100)/100;const imp=b-o;const ppR=typeof calcPrecompteExact==='function'?calcPrecompteExact(b,{situation:e.civil==='married_1'?'marie_1r':'isole',enfants:+(e.depChildren||0)}):null;return a+(ppR?ppR.pp:quickPP(b));},0);
    const totalNet=emps.reduce((a,e)=>{const b=+(e.monthlySalary||e.gross||0);const o=Math.round(b*TX_ONSS_W*100)/100;const imp=b-o;const ppR=typeof calcPrecompteExact==='function'?calcPrecompteExact(b,{situation:'isole',enfants:0}):null;const pp=ppR?ppR.pp:quickPP(b);const bonus=ppR?ppR.bonusEmploi:0;return a+(b-o-pp+bonus);},0);
    const totalCout=Math.round(totalBrut*(1+TX_ONSS_E)*100)/100;
    const cdi=emps.filter(e=>(e.contractType||'CDI')==='CDI').length;

    return {
      company:co, empCount:emps.length, cdi, cdd:emps.length-cdi,
      totalBrut, totalONSS_W, totalONSS_P, totalPP, totalNet, totalCout,
      emps:emps.map(e=>{
        const b=+(e.monthlySalary||e.gross||0);
        const o=Math.round(b*TX_ONSS_W*100)/100;
        const ppR=typeof calcPrecompteExact==='function'?calcPrecompteExact(b,{situation:'isole',enfants:0}):null;
        const pp=ppR?ppR.pp:quickPP(b);
        const net=ppR?ppR.net:Math.round((b-o-pp)*100)/100;
        return {name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),brut:b,onss:o,pp,net,contrat:e.contractType||'CDI'};
      })
    };
  };

  const generateHTML=(recap)=>{
    const co=recap.company;
    return '<html><head><style>body{font-family:Arial,sans-serif;color:#333;max-width:800px;margin:0 auto;padding:20px}h1{color:#b8960c;border-bottom:3px solid #b8960c;padding-bottom:10px}h2{color:#555;margin-top:24px}.kpi{display:inline-block;width:30%;padding:12px;margin:4px;background:#f8f6f0;border-radius:8px;text-align:center}.kpi .val{font-size:22px;font-weight:bold;color:#b8960c}.kpi .lab{font-size:11px;color:#888}table{width:100%;border-collapse:collapse;margin:12px 0}th{background:#b8960c;color:white;padding:8px;text-align:left;font-size:12px}td{padding:6px 8px;border-bottom:1px solid #eee;font-size:12px}.total{font-weight:bold;background:#f8f6f0}.footer{margin-top:30px;padding-top:15px;border-top:2px solid #eee;font-size:10px;color:#888}</style></head><body>'
    +'<h1>Aureus Social Pro</h1>'
    +'<h2>Recap Mensuel — '+mois[month]+' '+year+'</h2>'
    +'<p><strong>'+( co.name||'Client')+'</strong> — '+(co.vat||'')+' — '+(co.address||'')+'</p>'
    +'<div class="kpi"><div class="val">'+recap.empCount+'</div><div class="lab">Employés</div></div>'
    +'<div class="kpi"><div class="val">'+f2(recap.totalBrut)+' EUR</div><div class="lab">Masse brute</div></div>'
    +'<div class="kpi"><div class="val">'+f2(recap.totalNet)+' EUR</div><div class="lab">Net total</div></div>'
    +'<h2>Détail par employé</h2>'
    +'<table><tr><th>Employé</th><th>Contrat</th><th>Brut</th><th>ONSS</th><th>PP</th><th>Net</th></tr>'
    +(recap.emps||[]).map(e=>'<tr><td>'+e.name+'</td><td>'+e.contrat+'</td><td>'+f2(e.brut)+'</td><td>'+f2(e.onss)+'</td><td>'+f2(e.pp)+'</td><td style="font-weight:bold;color:#2d7a2d">'+f2(e.net)+'</td></tr>').join('')
    +'<tr class="total"><td>TOTAL</td><td>'+recap.empCount+' emp.</td><td>'+f2(recap.totalBrut)+'</td><td>'+f2(recap.totalONSS_W)+'</td><td>'+f2(recap.totalPP)+'</td><td style="color:#2d7a2d">'+f2(recap.totalNet)+'</td></tr>'
    +'</table>'
    +'<h2>Charges employeur</h2>'
    +'<table><tr><th>Rubrique</th><th>Montant</th></tr>'
    +'<tr><td>Masse brute</td><td>'+f2(recap.totalBrut)+' EUR</td></tr>'
    +'<tr><td>ONSS patronal (25,07%)</td><td>'+f2(recap.totalONSS_P)+' EUR</td></tr>'
    +'<tr class="total"><td>Coût total employeur</td><td style="color:#c00">'+f2(recap.totalCout)+' EUR</td></tr>'
    +'</table>'
    +'<h2>Echeances du mois</h2>'
    +'<table><tr><th>Date</th><th>Obligation</th><th>Montant</th></tr>'
    +'<tr><td>5/'+month+'</td><td>ONSS provisoire</td><td>'+f2(recap.totalBrut*(TX_ONSS_W+TX_ONSS_E))+' EUR</td></tr>'
    +'<tr><td>15/'+month+'</td><td>Précompte professionnel</td><td>'+f2(recap.totalPP)+' EUR</td></tr>'
    +'<tr><td>25/'+month+'</td><td>Virements salaires (SEPA)</td><td>'+f2(recap.totalNet)+' EUR</td></tr>'
    +'</table>'
    +'<div class="footer">Généré par Aureus Social Pro — aureussocial.be — '+(new Date().toLocaleDateString('fr-BE'))+'<br/>Ce document est confidentiel et destine uniquement au client mentionne ci-dessus.</div>'
    +'</body></html>';
  };

  const sendRecap=async()=>{
    setSending(true);
    const res=[];
    for(const cl of targetClients){
      const email=cl.company?.email;
      if(!email){res.push({client:cl.company?.name||'?',status:'error',error:'Pas d email employeur'});continue;}
      const recap=buildRecap(cl);
      const html=generateHTML(recap);
      try{
        const r=await sendEmailReal(email,'Recap Paie '+mois[month]+' '+year+' — '+(cl.company?.name||''),html,[]);
        res.push({client:cl.company?.name||'?',email,status:r.success?'ok':'error',error:r.error||null,mode:r.mode});
      }catch(e){res.push({client:cl.company?.name||'?',status:'error',error:e.message});}
    }
    setResults(res);
    setSending(false);
  };

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📧 Recap Employeur</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Envoi du recap mensuel de paie aux clients (employeurs)</p>
      </div>
      <div style={{display:'flex',gap:6}}>
        <select value={month} onChange={e=>setMonth(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
          {mois.slice(1).map((m,i)=><option key={i} value={i+1}>{m}</option>)}
        </select>
        <select value={year} onChange={e=>setYear(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
          {[2024,2025,2026].map(y=><option key={y} value={y}>{y}</option>)}
        </select>
        <select value={selClient} onChange={e=>setSelClient(e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
          <option value="all">Tous les clients ({clients.length})</option>
          {clients.map((c,i)=><option key={i} value={c.id}>{c.company?.name}</option>)}
        </select>
      </div>
    </div>

    {/* Client cards */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:12,marginBottom:16}}>
      {targetClients.map((cl,i)=>{
        const r=buildRecap(cl);
        const hasEmail=!!cl.company?.email;
        const sent=results.find(x=>x.client===cl.company?.name);
        return <div key={i} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+(sent?(sent.status==='ok'?'rgba(34,197,94,.3)':'rgba(239,68,68,.3)'):'rgba(198,163,78,.15)'),borderRadius:14}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
            <div style={{fontSize:14,fontWeight:700,color:'#c6a34e'}}>{cl.company?.name||'Client'}</div>
            {sent&&<span style={{fontSize:9,padding:'2px 8px',borderRadius:4,background:sent.status==='ok'?'rgba(34,197,94,.1)':'rgba(239,68,68,.1)',color:sent.status==='ok'?'#22c55e':'#ef4444',fontWeight:600}}>{sent.status==='ok'?'ENVOYE':'ERREUR'}</span>}
          </div>
          <div style={{fontSize:11,color:hasEmail?'#3b82f6':'#ef4444',marginBottom:8}}>{hasEmail?'📧 '+cl.company.email:'❌ Pas d email — Ajoutez-en un dans la fiche client'}</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:6}}>
            {[{l:'Employes',v:r.empCount,c:'#3b82f6'},{l:'Brut',v:f2(r.totalBrut),c:'#c6a34e'},{l:'Net',v:f2(r.totalNet),c:'#22c55e'},{l:'ONSS',v:f2(r.totalONSS_W+r.totalONSS_P),c:'#a855f7'},{l:'PP',v:f2(r.totalPP),c:'#3b82f6'},{l:'Cout',v:f2(r.totalCout),c:'#ef4444'}].map((k,j)=>
              <div key={j} style={{padding:'4px 6px',background:'rgba(255,255,255,.02)',borderRadius:6,textAlign:'center'}}>
                <div style={{fontSize:12,fontWeight:700,color:k.c}}>{k.v}</div>
                <div style={{fontSize:8,color:'#888'}}>{k.l}</div>
              </div>
            )}
          </div>
          <button onClick={()=>{const recap=buildRecap(cl);const html=generateHTML(recap);const w=window.open('','_blank','width=850,height=700');if(w){w.document.write(html);w.document.close();}}} style={{width:'100%',marginTop:8,padding:'6px',borderRadius:6,border:'none',background:'rgba(59,130,246,.08)',color:'#3b82f6',fontSize:10,cursor:'pointer',fontFamily:'inherit'}}>👁 Previsualiser</button>
          {sent?.error&&<div style={{fontSize:9,color:'#ef4444',marginTop:4}}>{sent.error}</div>}
        </div>;
      })}
    </div>

    {/* Actions */}
    <div style={{display:'flex',gap:10,alignItems:'center',padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14}}>
      <div style={{flex:1}}>
        <div style={{fontSize:13,fontWeight:600,color:'#e5e5e5'}}>{targetClients.length} client(s) — {targetClients.filter(c=>c.company?.email).length} avec email</div>
        <div style={{fontSize:10,color:'#888'}}>Les recaps seront envoyes a l adresse email de chaque client</div>
      </div>
      <button onClick={sendRecap} disabled={sending||targetClients.filter(c=>c.company?.email).length===0} style={{padding:'12px 28px',borderRadius:10,border:'none',background:sending?'rgba(198,163,78,.3)':'linear-gradient(135deg,#c6a34e,#a07d3e)',color:sending?'#888':'#060810',fontWeight:700,fontSize:14,cursor:sending?'wait':'pointer',fontFamily:'inherit',boxShadow:'0 4px 15px rgba(198,163,78,.3)'}}>
        {sending?'Envoi en cours...':'📧 ENVOYER LES RECAPS'}
      </button>
    </div>

    {/* Results */}
    {results.length>0&&<div style={{marginTop:14,border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>📊 Resultats d envoi</div>
      {results.map((r,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
        <span style={{fontSize:16}}>{r.status==='ok'?'✅':'❌'}</span>
        <div style={{flex:1}}>
          <div style={{fontSize:12,fontWeight:500,color:'#e5e5e5'}}>{r.client}</div>
          {r.email&&<div style={{fontSize:9,color:'#888'}}>{r.email} — {r.mode||''}</div>}
        </div>
        {r.error&&<span style={{fontSize:10,color:'#ef4444'}}>{r.error}</span>}
      </div>)}
    </div>}
  </div>;
};

// ═══ 2. ENVOI MASSE — Fiches employes + Recap employeur en 1 clic ═══
const EnvoiMasse=({s,user})=>{
  const clients=s.clients||[];
  const [sending,setSending]=useState(false);
  const [phase,setPhase]=useState('ready'); // ready, sending, done
  const [logs,setLogs]=useState([]);
  const [month]=useState(new Date().getMonth()+1);
  const [year]=useState(new Date().getFullYear());
  const mois=['','Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const allEmps=clients.reduce((a,c)=>[...a,...(c.emps||[]).map(e=>({...e,clientName:c.company?.name||'',clientId:c.id,clientEmail:c.company?.email,company:c.company||{}}))],[]);
  const empsWithEmail=allEmps.filter(e=>e.email);
  const clientsWithEmail=clients.filter(c=>c.company?.email);
  const totalBrut=allEmps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);

  const addLog=(msg,type)=>setLogs(p=>[{msg,type,time:new Date().toLocaleTimeString('fr-BE')}, ...p]);

  const sendAll=async()=>{
    setPhase('sending');
    setSending(true);
    setLogs([]);
    let sentEmps=0, failEmps=0, sentClients=0, failClients=0;

    // Phase 1: Envoyer fiches aux employes
    addLog('Phase 1: Envoi des fiches de paie aux employes...','info');
    for(const e of empsWithEmail){
      const name=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
      const brut=+(e.monthlySalary||e.gross||0);
      const ppR=typeof calcPrecompteExact==='function'?calcPrecompteExact(brut,{situation:'isole',enfants:0}):null;
      const onss=ppR?ppR.onss:Math.round(brut*TX_ONSS_W*100)/100;
      const pp=ppR?ppR.pp:quickPP(brut);
      const net=ppR?ppR.net:Math.round((brut-onss-pp)*100)/100;
      const bonus=ppR?ppR.bonusEmploi:0;

      const html='<html><head><style>body{font-family:Arial,sans-serif;max-width:700px;margin:0 auto;padding:20px}h1{color:#b8960c}table{width:100%;border-collapse:collapse}th{background:#b8960c;color:white;padding:8px;text-align:left}td{padding:6px 8px;border-bottom:1px solid #eee}.net{font-size:20px;font-weight:bold;color:#2d7a2d}</style></head><body>'
        +'<h1>Fiche de paie — '+mois[month]+' '+year+'</h1>'
        +'<p><strong>'+name+'</strong> — '+(e.clientName)+'</p>'
        +'<table><tr><th>Rubrique</th><th>Montant</th></tr>'
        +'<tr><td>Salaire brut</td><td>'+f2(brut)+' EUR</td></tr>'
        +'<tr><td>ONSS (-13,07%)</td><td>-'+f2(onss)+' EUR</td></tr>'
        +'<tr><td>Précompte professionnel</td><td>-'+f2(pp)+' EUR</td></tr>'
        +(bonus>0?'<tr><td>Bonus emploi</td><td>+'+f2(bonus)+' EUR</td></tr>':'')
        +'<tr><td><strong>NET A PAYER</strong></td><td class="net">'+f2(net)+' EUR</td></tr>'
        +'</table>'
        +'<p style="color:#888;font-size:11px;margin-top:20px">Généré par Aureus Social Pro — aureussocial.be</p>'
        +'</body></html>';

      try{
        const emailPro=typeof emailFichePaie==='function'?emailFichePaie(e,mois[month]+' '+year,{gross:e.brut,onssNet:e.onss,precompte:e.pp,net:e.net,bonusEmploi:e.bonus||0}):html;const r=await sendEmailReal(e.email,'Fiche de paie '+mois[month]+' '+year+' — '+e.clientName,emailPro,[]);
        if(r.success){sentEmps++;addLog('✅ '+name+' ('+e.email+')','success');}
        else{failEmps++;addLog('❌ '+name+' — '+( r.error||'Erreur'),'error');}
      }catch(ex){failEmps++;addLog('❌ '+name+' — '+ex.message,'error');}
      // Small delay to respect rate limits
      await new Promise(r=>setTimeout(r,300));
    }
    addLog('Phase 1 terminee: '+sentEmps+' envoyes, '+failEmps+' echecs','info');

    // Phase 2: Envoyer recaps aux employeurs
    addLog('Phase 2: Envoi des recaps mensuels aux employeurs...','info');
    for(const cl of clientsWithEmail){
      const co=cl.company||{};
      const emps=cl.emps||[];
      const tb=emps.reduce((a,e2)=>a+(+(e2.monthlySalary||e2.gross||0)),0);
      const tn=Math.round(tb*NET_FACTOR*100)/100;
      const tc=Math.round(tb*(1+TX_ONSS_E)*100)/100;

      const html='<html><head><style>body{font-family:Arial,sans-serif;max-width:700px;margin:0 auto;padding:20px}h1{color:#b8960c}table{width:100%;border-collapse:collapse}th{background:#b8960c;color:white;padding:8px;text-align:left}td{padding:6px 8px;border-bottom:1px solid #eee}.big{font-size:18px;font-weight:bold}</style></head><body>'
        +'<h1>Recap Mensuel — '+mois[month]+' '+year+'</h1>'
        +'<p><strong>'+(co.name||'')+'</strong> — '+(co.vat||'')+'</p>'
        +'<table><tr><th>Indicateur</th><th>Valeur</th></tr>'
        +'<tr><td>Nombre d employes</td><td class="big">'+emps.length+'</td></tr>'
        +'<tr><td>Masse brute</td><td class="big" style="color:#b8960c">'+f2(tb)+' EUR</td></tr>'
        +'<tr><td>Net total</td><td class="big" style="color:#2d7a2d">'+f2(tn)+' EUR</td></tr>'
        +'<tr><td>Cout employeur total</td><td class="big" style="color:#c00">'+f2(tc)+' EUR</td></tr>'
        +'</table>'
        +'<h2>Échéances</h2>'
        +'<table><tr><th>Date</th><th>Obligation</th><th>Montant</th></tr>'
        +'<tr><td>5/'+month+'</td><td>ONSS</td><td>'+f2(tb*(TX_ONSS_W+TX_ONSS_E))+' EUR</td></tr>'
        +'<tr><td>15/'+month+'</td><td>Precompte prof.</td><td>'+f2(tb*PP_EST)+' EUR</td></tr>'
        +'<tr><td>25/'+month+'</td><td>Virements SEPA</td><td>'+f2(tn)+' EUR</td></tr>'
        +'</table>'
        +'<p style="color:#888;font-size:11px;margin-top:20px">Aureus Social Pro — aureussocial.be — '+(new Date().toLocaleDateString('fr-BE'))+'</p>'
        +'</body></html>';

      try{
        const emailPro2=typeof emailRecapEmployeur==='function'?emailRecapEmployeur(cl,mois[month]+' '+year,{nbEmps:emps.length,totalBrut,onssE:totalOnssE,onssW:totalOnssW,totalPP,totalNet,coutTotal:totalCout}):html;const r=await sendEmailReal(co.email,'Recap Paie '+mois[month]+' '+year+' — '+(co.name||''),emailPro2,[]);
        if(r.success){sentClients++;addLog('✅ '+(co.name||'')+' ('+co.email+')','success');}
        else{failClients++;addLog('❌ '+(co.name||'')+' — '+(r.error||'Erreur'),'error');}
      }catch(ex){failClients++;addLog('❌ '+(co.name||'')+' — '+ex.message,'error');}
      await new Promise(r=>setTimeout(r,300));
    }
    addLog('Phase 2 terminee: '+sentClients+' envoyes, '+failClients+' echecs','info');
    addLog('TERMINE — Total: '+(sentEmps+sentClients)+' emails envoyes','success');
    setPhase('done');
    setSending(false);
  };

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🚀 Envoi Masse</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Fiches de paie aux employes + Recap mensuel aux employeurs — {mois[month]} {year}</p>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Clients total',v:clients.length,c:'#c6a34e',i:'🏢'},{l:'Employes avec email',v:empsWithEmail.length+'/'+allEmps.length,c:'#3b82f6',i:'👤'},{l:'Clients avec email',v:clientsWithEmail.length+'/'+clients.length,c:'#22c55e',i:'📧'},{l:'Fiches a envoyer',v:empsWithEmail.length,c:'#a855f7',i:'📄'},{l:'Recaps a envoyer',v:clientsWithEmail.length,c:'#eab308',i:'📊'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.i} {k.l}</div>
          <div style={{fontSize:20,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    {/* Warnings */}
    {allEmps.filter(e=>!e.email).length>0&&<div style={{padding:12,background:'rgba(234,179,8,.06)',border:'1px solid rgba(234,179,8,.15)',borderRadius:10,marginBottom:12,fontSize:11,color:'#eab308'}}>
      ⚠ {allEmps.filter(e=>!e.email).length} employe(s) sans email — ils ne recevront pas leur fiche. Ajoutez leur email dans la fiche employe.
    </div>}
    {clients.filter(c=>!c.company?.email).length>0&&<div style={{padding:12,background:'rgba(234,179,8,.06)',border:'1px solid rgba(234,179,8,.15)',borderRadius:10,marginBottom:12,fontSize:11,color:'#eab308'}}>
      ⚠ {clients.filter(c=>!c.company?.email).length} client(s) sans email employeur — ils ne recevront pas le recap. Ajoutez l email dans la fiche client.
    </div>}

    {/* Process description */}
    <div style={{display:'grid',gridTemplateColumns:'1fr 40px 1fr',gap:10,marginBottom:16,alignItems:'center'}}>
      <div style={{padding:16,background:phase==='sending'||phase==='done'?'rgba(34,197,94,.06)':'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14}}>
        <div style={{fontSize:14,fontWeight:700,color:'#3b82f6',marginBottom:6}}>Phase 1 — Fiches employes</div>
        <div style={{fontSize:11,color:'#888'}}>Chaque employe recoit sa fiche de paie personnelle par email avec le detail brut/ONSS/PP/net.</div>
      </div>
      <div style={{textAlign:'center',fontSize:20,color:'#888'}}>→</div>
      <div style={{padding:16,background:phase==='done'?'rgba(34,197,94,.06)':'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14}}>
        <div style={{fontSize:14,fontWeight:700,color:'#c6a34e',marginBottom:6}}>Phase 2 — Recap employeurs</div>
        <div style={{fontSize:11,color:'#888'}}>Chaque client recoit le recap mensuel: masse salariale, charges, echeances, detail par employe.</div>
      </div>
    </div>

    {/* Send button */}
    <div style={{textAlign:'center',marginBottom:16}}>
      <button onClick={sendAll} disabled={sending||(empsWithEmail.length===0&&clientsWithEmail.length===0)} style={{padding:'14px 40px',borderRadius:12,border:'none',background:sending?'rgba(198,163,78,.3)':phase==='done'?'linear-gradient(135deg,#22c55e,#16a34a)':'linear-gradient(135deg,#c6a34e,#a07d3e)',color:sending?'#888':'#060810',fontWeight:800,fontSize:16,cursor:sending?'wait':'pointer',fontFamily:'inherit',boxShadow:'0 4px 20px rgba(198,163,78,.3)',letterSpacing:'.5px'}}>
        {phase==='done'?'✅ ENVOI TERMINE':sending?'⏳ ENVOI EN COURS...':'🚀 LANCER L ENVOI COMPLET'}
      </button>
      {phase==='done'&&<button onClick={()=>{setPhase('ready');setLogs([]);}} style={{display:'block',margin:'8px auto 0',padding:'8px 20px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontSize:11,cursor:'pointer',fontFamily:'inherit'}}>🔄 Relancer</button>}
    </div>

    {/* Live logs */}
    {logs.length>0&&<div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>📋 Journal d envoi ({logs.length})</div>
      <div style={{maxHeight:300,overflowY:'auto'}}>
        {logs.map((l,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'5px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:10}}>
          <span style={{color:'#888',fontFamily:'monospace',minWidth:65}}>{l.time}</span>
          <span style={{color:l.type==='success'?'#22c55e':l.type==='error'?'#ef4444':l.type==='info'?'#3b82f6':'#888'}}>{l.msg}</span>
        </div>)}
      </div>
    </div>}
  </div>;
};


// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 31: GENERATEUR CONTRATS DE TRAVAIL LÉGAUX       ═══
// ═══ Par Commission Paritaire — Articles de loi complets    ═══
// ══════════════════════════════════════════════════════════════

const CP_DATABASE = {
  '200': { name:'CP 200 — Auxiliaire pour employes', type:'employe', duree:38, indexation:'Annuelle au 1er janvier', classification:'A/B/C/D',
    preavis_art:'Art. 37/2 Loi 3/7/1978 et CCT du 1/7/2019', prime_fin:'Oui — salaire brut decembre (CCT 23/9/2021 n°167.805)',
    ecoCheques:'250 EUR/an (CCT 30/5/2023 n°175.869)', formation:'5 jours/2 ans (Loi Peeters 5/3/2017, Art. 50)',
    transport:'50% abonnement si salaire < 36.688 EUR; velo 0,27 EUR/km max 40km AR (CCT 30/1/2023)',
    fonds:'Fonds social CP 200 — CEFORA pour formations', rmmmg:'2.070,48 EUR (01/2026 indexe)',
    specificites:'Clause de non-concurrence possible si salaire > 41.969 EUR/an (Art. 65 Loi 3/7/1978). Eco-cheques obligatoires. Prime pouvoir achat 330,84 EUR brut/an (CCT 2023-2024).'
  },
  '100': { name:'CP 100 — Auxiliaire pour ouvriers', type:'ouvrier', duree:38, indexation:'Variable selon sous-secteur',
    preavis_art:'Art. 37/2 Loi 3/7/1978 — Statut unique 26/12/2013', prime_fin:'Selon CCT sectorielle',
    ecoCheques:'Selon CCT entreprise', formation:'5 jours/2 ans (Loi Peeters)',
    transport:'Intervention legale 75% SNCB (AR 28/7/1962)', fonds:'/',
    rmmmg:'2.070,48 EUR (RMMMG national)', specificites:'Salaire a 108% pour calcul ONSS. Pecule vacances via caisse de vacances.'
  },
  '110': { name:'CP 110 — Entretien textile', type:'ouvrier', duree:38, indexation:'Trimestrielle (indice sante)',
    preavis_art:'Art. 37/2 Loi 3/7/1978', prime_fin:'Oui — CCT sectorielle',
    ecoCheques:'250 EUR/an', formation:'5 jours/2 ans',
    transport:'100% transport en commun', fonds:'Fonds social textile',
    rmmmg:'Selon categorie et anciennete', specificites:'Regimes de travail flexibles possibles. Travail de nuit autorise par CCT sectorielle.'
  },
  '124': { name:'CP 124 — Construction', type:'ouvrier', duree:38, indexation:'Variable (indice sante)',
    preavis_art:'Art. 37/2 et 37/7 Loi 3/7/1978 — Regimes speciaux construction', prime_fin:'Prime intemperies + prime fidelite',
    ecoCheques:'Selon CCT', formation:'VCA/securite obligatoire (AR 25/1/2001)', 
    transport:'100% transport en commun', fonds:'Fonds de securite existence Constructiv',
    rmmmg:'Selon categorie (1 a 4) et anciennete — CCT 12/6/2023',
    specificites:'Timbres intemperies et fidelite. Carte Constructiv obligatoire. Check-in/out chantier (Loi 4/8/1996 Art. 30bis). Responsabilite solidaire chaine sous-traitance (Loi 12/4/1965 Art. 35/1).'
  },
  '140': { name:'CP 140 — Transport et logistique', type:'ouvrier', duree:38, indexation:'Trimestrielle',
    preavis_art:'Art. 37/2 Loi 3/7/1978', prime_fin:'Oui — CCT sectorielle',
    ecoCheques:'250 EUR/an', formation:'Code 95 obligatoire chauffeurs (Dir. 2003/59/CE)',
    transport:'100% transport en commun + indemnite chauffeur', fonds:'Fonds social transport',
    rmmmg:'Selon categorie et fonction', specificites:'Temps de conduite et repos (Reglement CE 561/2006). Tachygraphe obligatoire. ADR si matieres dangereuses.'
  },
  '302': { name:'CP 302 — Industrie hoteliere (Horeca)', type:'mixte', duree:38, indexation:'Annuelle',
    preavis_art:'Art. 37/2 Loi 3/7/1978', prime_fin:'Oui — CCT sectorielle',
    ecoCheques:'Selon CCT', formation:'Securite alimentaire AFSCA obligatoire',
    transport:'Intervention legale', fonds:'Fonds social Horeca',
    rmmmg:'Selon categorie (1 a 6)', specificites:'Flexibilite horaire importante. Heures supplementaires majorees Art. 29 Loi 16/3/1971. Flexi-jobs possibles (Loi 16/11/2015). Pourboires declares ou forfait.'
  },
  '111': { name:'CP 111 — Constructions metalliques', type:'ouvrier', duree:38, indexation:'Trimestrielle',
    preavis_art:'Art. 37/2 Loi 3/7/1978', prime_fin:'Oui',
    ecoCheques:'250 EUR/an', formation:'VCA/securite',
    transport:'100% transport en commun', fonds:'Fonds social metal',
    rmmmg:'Selon categorie professionnelle', specificites:'Travail postes possible. Prime equipe et prime de nuit selon CCT.'
  },
  '209': { name:'CP 209 — Employes metal', type:'employe', duree:38, indexation:'Trimestrielle',
    preavis_art:'Art. 37/2 Loi 3/7/1978', prime_fin:'Oui — 13eme mois',
    ecoCheques:'250 EUR/an', formation:'5 jours/2 ans',
    transport:'100% transport en commun', fonds:'/',
    rmmmg:'Selon bareme sectoriel', specificites:'Classification sectorielle. Avancement baremique bisannuel.'
  },
  '226': { name:'CP 226 — Commerce international, transport, logistique', type:'employe', duree:38, indexation:'Annuelle au 1er janvier',
    preavis_art:'Art. 37/2 Loi 3/7/1978', prime_fin:'Oui — 13eme mois',
    ecoCheques:'250 EUR/an', formation:'5 jours/2 ans',
    transport:'100% transport en commun', fonds:'/',
    rmmmg:'Selon classification', specificites:'Horaires flexibles possibles. Teletravail structurel (CCT 85, CNT 27/11/2005 et Loi 3/10/2022).'
  },
  '330': { name:'CP 330 — Etablissements soins de sante', type:'mixte', duree:38, indexation:'Variable',
    preavis_art:'Art. 37/2 Loi 3/7/1978', prime_fin:'Oui — prime de fin annee',
    ecoCheques:'Selon CCT', formation:'Formation continue obligatoire secteur soins',
    transport:'100% transport en commun', fonds:'Fonds Maribel Social (AR 18/7/2002)',
    rmmmg:'Baremes IFIC (classification fonctions)', specificites:'IFIC classification obligatoire. Primes de nuit, week-end, jours fériés. Maribel social (reduction ONSS Art. 35 Loi 29/6/1981).'
  }
};

const ContratGenerator=({s,d,user})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(null);
  const [selEmp,setSelEmp]=useState(null);
  const [contractType,setContractType]=useState('CDI');
  const [cp,setCp]=useState('200');
  const [preview,setPreview]=useState(null);
  const [customClauses,setCustomClauses]=useState([]);
  const [showAdvanced,setShowAdvanced]=useState(false);
  const [generating,setGenerating]=useState(false);

  // Contract-specific fields
  const [cddEnd,setCddEnd]=useState('');
  const [cddMotif,setCddMotif]=useState('surcroit');
  const [essai,setEssai]=useState('');
  const [fonction,setFonction]=useState('');
  const [horaire,setHoraire]=useState('lundi-vendredi 9h-17h30 (pause 12h30-13h)');
  const [lieuTravail,setLieuTravail]=useState('');
  const [nonConcurrence,setNonConcurrence]=useState(false);
  const [ecolage,setEcolage]=useState(false);
  const [teletravail,setTeletravail]=useState(false);
  const [confidentialite,setConfidentialite]=useState(true);

  const cl=selClient?clients.find(c=>c.id===selClient):null;
  const emp=selEmp&&cl?(cl.emps||[]).find(e=>e.id===selEmp):null;
  const cpData=CP_DATABASE[cp]||CP_DATABASE['200'];

  const generateContract=()=>{
    if(!cl||!emp) return null;
    const co=cl.company||{};
    const brut=+(emp.monthlySalary||emp.gross||0);
    const regime=+(emp.whWeek||38);
    const startDate=emp.startDate||new Date().toISOString().split('T')[0];
    const statut=cpData.type==='ouvrier'?'ouvrier':(cpData.type==='employe'?'employe':(emp.statut||'employe'));
    const empName=(emp.first||emp.fn||'')+' '+(emp.last||emp.ln||'');
    const empAddr=emp.address||emp.adresse||'[adresse du travailleur]';
    const empNISS=emp.niss||'[NISS]';

    let html='<html><head><meta charset="UTF-8"><style>';
    html+='body{font-family:"Times New Roman",serif;font-size:12pt;line-height:1.6;color:#000;max-width:750px;margin:0 auto;padding:40px}';
    html+='h1{text-align:center;font-size:16pt;border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:20px}';
    html+='h2{font-size:13pt;margin-top:20px;margin-bottom:8px;border-left:4px solid #b8960c;padding-left:10px}';
    html+='h3{font-size:12pt;margin-top:14px;color:#333}';
    html+='.article{margin:8px 0;text-align:justify}';
    html+='.ref{font-size:9pt;color:#666;font-style:italic}';
    html+='.signature{display:inline-block;width:45%;vertical-align:top;margin-top:40px;text-align:center;border-top:1px solid #000;padding-top:8px}';
    html+='.header-info{font-size:11pt;margin-bottom:5px}';
    html+='.important{font-weight:bold;text-decoration:underline}';
    html+='</style></head><body>';

    // HEADER
    html+='<h1>CONTRAT DE TRAVAIL '+(contractType==='CDD'?'A DUREE DETERMINEE':'A DUREE INDETERMINEE')+'</h1>';
    html+='<p style="text-align:center;font-size:10pt;color:#666">'+cpData.name+'<br/>Statut: '+(statut==='ouvrier'?'Ouvrier':'Employé')+'</p>';
    
    // ENTRE
    html+='<h2>ENTRE LES PARTIES</h2>';
    html+='<p class="article"><strong>L EMPLOYEUR :</strong><br/>';
    html+=(co.name||'[Denomination sociale]')+', '+(co.forme||'SPRL/SRL');
    html+=',<br/>dont le siege social est etabli a '+(co.address||'[adresse du siege]');
    html+=',<br/>immatriculee a la Banque-Carrefour des Entreprises sous le numero '+(co.vat||co.bce||'[BCE]');
    html+=',<br/>numero ONSS : '+(co.onss||'[numero ONSS]');
    html+=',<br/>Commission paritaire : <strong>'+cp+' — '+cpData.name.split(' — ')[1]+'</strong>';
    html+=',<br/>representee par '+(co.representant||'[nom du representant]')+', en qualite de '+(co.qualite||'gerant');
    html+=',<br/>ci-apres denommee "l Employeur";</p>';

    html+='<p class="article"><strong>ET LE TRAVAILLEUR :</strong><br/>';
    html+=empName+',<br/>domicilie(e) a '+empAddr;
    html+=',<br/>numero de Registre national (NISS) : '+empNISS;
    html+=',<br/>de nationalite '+(emp.nationalite||'belge');
    html+=',<br/>ci-apres denomme(e) "le Travailleur";</p>';

    html+='<p class="article">IL A ETE CONVENU CE QUI SUIT :</p>';

    // ARTICLE 1 — OBJET
    html+='<h2>ARTICLE 1 — OBJET DU CONTRAT</h2>';
    html+='<p class="article">Le Travailleur est engage en qualite de <strong>'+(statut==='ouvrier'?'ouvrier':'employe')+'</strong> pour exercer la fonction de <strong>'+(fonction||emp.function||emp.fonction||'[fonction]')+'</strong>, sous l autorite de l Employeur, conformement a l article '+(statut==='ouvrier'?'2':'3')+' de la Loi du 3 juillet 1978 relative aux contrats de travail.</p>';
    html+='<p class="ref">Ref. legale : Loi du 3 juillet 1978, Titre I, Chapitre I, Art. '+(statut==='ouvrier'?'2 (contrat d ouvrier)':'3 (contrat d employe)')+'</p>';

    // ARTICLE 2 — DUREE
    html+='<h2>ARTICLE 2 — DUREE DU CONTRAT</h2>';
    if(contractType==='CDI'){
      html+='<p class="article">Le present contrat est conclu pour une <strong>duree indeterminee</strong>, conformement aux articles 2 et 3 de la Loi du 3 juillet 1978. Il prend effet le <strong>'+startDate+'</strong>.</p>';
    } else {
      html+='<p class="article">Le present contrat est conclu pour une <strong>duree determinee</strong>, conformement a l article 7 de la Loi du 3 juillet 1978. Il prend effet le <strong>'+startDate+'</strong> et prendra fin le <strong>'+(cddEnd||'[date de fin]')+'</strong>, sans qu il soit necessaire de donner un preavis.</p>';
      html+='<p class="article">Motif du recours au CDD : '+(cddMotif==='surcroit'?'surcroit temporaire de travail':cddMotif==='remplacement'?'remplacement d un travailleur absent':cddMotif==='projet'?'execution d un travail nettement defini':'autre motif legitime')+'.</p>';
      html+='<p class="ref">Ref. legale : Art. 7 a 10 de la Loi du 3 juillet 1978 — CDD successifs interdits sauf justification (Art. 10)</p>';
    }

    // ARTICLE 3 — LIEU DE TRAVAIL
    html+='<h2>ARTICLE 3 — LIEU DE TRAVAIL</h2>';
    html+='<p class="article">Le lieu de travail habituel est fixe a : <strong>'+(lieuTravail||co.address||'[adresse du lieu de travail]')+'</strong>. L Employeur se reserve le droit de modifier le lieu de travail dans un rayon geographique raisonnable, conformement a l article 25 de la Loi du 3 juillet 1978, pour autant que cette modification ne constitue pas un acte equivoque de rupture.</p>';
    html+='<p class="ref">Ref. legale : Art. 25 Loi 3/7/1978 — Interdiction de modification unilaterale des conditions essentielles. Directive (UE) 2019/1152 Art. 4 — Obligation d information sur le lieu de travail.</p>';

    // ARTICLE 4 — HORAIRE ET DUREE DU TRAVAIL
    html+='<h2>ARTICLE 4 — DUREE ET HORAIRE DE TRAVAIL</h2>';
    html+='<p class="article">La duree hebdomadaire de travail est fixee a <strong>'+regime+' heures</strong> '+(regime<cpData.duree?'(temps partiel — '+Math.round(regime/cpData.duree*100)+'% d un temps plein)':'(temps plein)')+', conformement a la CCT sectorielle applicable dans la '+cpData.name+'.</p>';
    html+='<p class="article">L horaire de travail est le suivant : <strong>'+horaire+'</strong>.</p>';
    if(regime<cpData.duree){
      html+='<p class="article important">Le present contrat etant a temps partiel, il doit imperativement etre constate par ecrit pour chaque travailleur individuellement, au plus tard au moment de l entree en service, conformement a l article 11bis de la Loi du 3 juillet 1978.</p>';
      html+='<p class="ref">Ref. legale : Art. 11bis Loi 3/7/1978. Loi du 16 mars 1971 sur le travail, Art. 26bis (publicite des horaires). AR 25/6/1990 assimilant travail a temps partiel.</p>';
    }
    html+='<p class="article">La duree hebdomadaire maximale de travail est de '+cpData.duree+' heures (Art. 19 Loi du 16 mars 1971 sur le travail). Les heures supplementaires sont rémunérées conformement a l article 29 de la meme loi (sursalaire de 50% en semaine, 100% les dimanches et jours fériés).</p>';
    html+='<p class="ref">Ref. legale : Loi du 16/3/1971 sur le travail, Art. 19, 20, 29. '+cpData.preavis_art+'</p>';

    // ARTICLE 5 — REMUNERATION
    html+='<h2>ARTICLE 5 — REMUNERATION</h2>';
    html+='<p class="article">Le Travailleur percevra une rémunération mensuelle brute de <strong>'+brut.toFixed(2)+' EUR</strong> pour des prestations a temps plein ('+(regime>=cpData.duree?'100%':Math.round(regime/cpData.duree*100)+'%')+').</p>';
    html+='<p class="article">Cette rémunération respecte les baremes minima fixes par la '+cpData.name+' (RMMMG sectoriel : '+cpData.rmmmg+').</p>';
    html+='<p class="article">La rémunération sera payee mensuellement, au plus tard le dernier jour ouvrable du mois, par virement bancaire sur le compte communique par le Travailleur, conformement a l article 5 de la Loi du 12 avril 1965 concernant la protection de la rémunération des travailleurs.</p>';
    html+='<p class="article"><strong>Indexation :</strong> La rémunération sera indexée selon le mécanisme applicable dans la '+cpData.name+' : <strong>'+cpData.indexation+'</strong>, conformement a la Loi du 2 aout 1971 organisant un regime de liaison a l indice des prix a la consommation (indice sante).</p>';
    if(cpData.type==='ouvrier'){
      html+='<p class="article"><strong>Pécule de vacances :</strong> Le pécule de vacances (simple et double) sera verse par la Caisse de vacances competente, conformement aux Lois coordonnees du 28 juin 1971 relatives aux vacances annuelles des travailleurs salaries.</p>';
    } else {
      html+='<p class="article"><strong>Pécule de vacances :</strong> Le simple pecule est inclus dans le salaire mensuel. Le double pecule (92% du salaire brut) sera verse en mai-juin conformement a l AR du 30 mars 1967 et aux Lois coordonnees du 28 juin 1971.</p>';
    }
    html+='<p class="article"><strong>Prime de fin d annee :</strong> '+cpData.prime_fin+'.</p>';
    html+='<p class="ref">Ref. legale : Loi 12/4/1965 protection rémunération. Art. 16-20 Loi 3/7/1978 (obligations des parties). Lois coord. 28/6/1971 (vacances annuelles). CCT '+cp+' applicable.</p>';

    // ARTICLE 6 — AVANTAGES
    html+='<h2>ARTICLE 6 — AVANTAGES COMPLEMENTAIRES</h2>';
    html+='<p class="article"><strong>Eco-cheques :</strong> '+cpData.ecoCheques+', conformement aux CCT sectorielles de la '+cpData.name+' et a la CCT n°98 du CNT du 20 fevrier 2009.</p>';
    html+='<p class="article"><strong>Frais de transport :</strong> '+cpData.transport+', conformement a la CCT n°19 octies du CNT du 20 fevrier 2009 et aux dispositions sectorielles applicables.</p>';
    html+='<p class="article"><strong>Formation :</strong> '+cpData.formation+', conformement aux dispositions de la Loi du 5 mars 2017 concernant le travail faisable et maniable (Loi Peeters), Art. 49-55.</p>';
    if(cpData.fonds && cpData.fonds!=='/') {
      html+='<p class="article"><strong>Fonds sectoriel :</strong> Le Travailleur beneficie des avantages accordes par le '+cpData.fonds+'.</p>';
    }

    // ARTICLE 7 — OBLIGATIONS DES PARTIES
    html+='<h2>ARTICLE 7 — OBLIGATIONS DES PARTIES</h2>';
    html+='<h3>7.1 — Obligations du Travailleur (Art. 17 Loi 3/7/1978)</h3>';
    html+='<p class="article">Le Travailleur s engage a :<br/>- executer son travail avec soin, probite et conscience, au temps, au lieu et dans les conditions convenues (Art. 17, 1°);<br/>- agir conformement aux ordres et instructions de l Employeur en vue de l execution du contrat (Art. 17, 2°);<br/>- s abstenir de tout ce qui pourrait nuire a sa securite, a celle de ses compagnons, de l employeur ou de tiers (Art. 17, 3°);<br/>- restituer en bon etat les instruments de travail et les matieres premieres qui lui sont confies (Art. 17, 4°);<br/>- garder le secret sur toute affaire confidentielle dont il aurait eu connaissance dans l exercice de ses fonctions (Art. 17, 3°bis).</p>';
    html+='<h3>7.2 — Obligations de l Employeur (Art. 20 Loi 3/7/1978)</h3>';
    html+='<p class="article">L Employeur s engage a :<br/>- faire travailler le Travailleur dans les conditions, au temps et au lieu convenus (Art. 20, 1°);<br/>- veiller a ce que le travail s accomplisse dans des conditions convenables (Art. 20, 2°);<br/>- payer la rémunération aux conditions, au temps et au lieu convenus (Art. 20, 3°);<br/>- consacrer l attention et les soins necessaires a l accueil du Travailleur (Art. 20, 6°);<br/>- fournir au Travailleur les informations prevues par la Directive (UE) 2019/1152 transposee par la Loi du 7 octobre 2022.</p>';

    // ARTICLE 8 — SUSPENSION
    html+='<h2>ARTICLE 8 — SUSPENSION DU CONTRAT</h2>';
    html+='<p class="article">L execution du contrat peut etre suspendue dans les cas prevus par la Loi du 3 juillet 1978 (Chapitre III, Art. 26 a 31/2), notamment :<br/>- Force majeure (Art. 26);<br/>- Incapacite de travail resultant de maladie ou accident (Art. 31 — salaire garanti: '+(statut==='ouvrier'?'7 jours employeur, puis mutuelle (Art. 52 Loi 3/7/1978)':'30 jours employeur (Art. 70 Loi 3/7/1978)')+';<br/>- Vacances annuelles (Lois coord. 28/6/1971);<br/>- Jours fériés legaux (Loi du 4 janvier 1974);<br/>- Petit chomage / conge de circonstance (AR 28/8/1963);<br/>- Conge de maternite (Art. 39 Loi 16/3/1971 — 15 semaines);<br/>- Conge de naissance (Art. 30 §2 Loi 3/7/1978 — 20 jours);<br/>- Credit-temps (CCT n°103 du CNT du 27/6/2012).</p>';

    // ARTICLE 9 — PREAVIS ET FIN DE CONTRAT
    html+='<h2>ARTICLE 9 — PREAVIS ET FIN DE CONTRAT</h2>';
    html+='<p class="article">Le contrat peut prendre fin conformement aux articles 32 a 42 de la Loi du 3 juillet 1978 :</p>';
    html+='<p class="article"><strong>a) Preavis (Art. 37/2) :</strong> Les delais de preavis sont fixes par l article 37/2 de la Loi du 3 juillet 1978, tel que modifie par la Loi du 26 decembre 2013 concernant l introduction d un statut unique. Les delais dependent de l anciennete du Travailleur.</p>';
    html+='<p class="article"><strong>b) Motif grave (Art. 35) :</strong> Chacune des parties peut rompre le contrat sans preavis ni indemnite pour motif grave au sens de l article 35 de la Loi du 3 juillet 1978. La partie qui invoque le motif grave doit en informer l autre partie dans les 3 jours ouvrables.</p>';
    html+='<p class="article"><strong>c) Rupture de commun accord :</strong> Les parties peuvent a tout moment mettre fin au contrat de commun accord (Art. 1134 du Code civil).</p>';
    html+='<p class="article"><strong>d) Licenciement manifestement deraisonnable :</strong> Conformement a la CCT n°109 du CNT du 12 fevrier 2014, le licenciement ne peut etre manifestement deraisonnable. L Employeur doit pouvoir justifier le motif du licenciement.</p>';
    html+='<p class="ref">Ref. legale : Art. 32-42 Loi 3/7/1978. Loi 26/12/2013 statut unique. CCT 109 CNT 12/2/2014. '+cpData.preavis_art+'</p>';

    // ARTICLE 10 — CLAUSE DE CONFIDENTIALITE
    if(confidentialite){
      html+='<h2>ARTICLE 10 — CONFIDENTIALITE</h2>';
      html+='<p class="article">Le Travailleur s engage a ne pas divulguer les secrets d affaires, les secrets de fabrication, ainsi que les affaires a caractere personnel ou confidentiel dont il aurait eu connaissance dans l exercice de ses fonctions, tant pendant la duree du contrat qu apres sa cessation, conformement a l article 17, 3°bis de la Loi du 3 juillet 1978 et a la Loi du 30 juillet 2018 relative a la protection des secrets d affaires.</p>';
    }

    // ARTICLE 11 — NON-CONCURRENCE
    let artNum = confidentialite ? 11 : 10;
    if(nonConcurrence){
      html+='<h2>ARTICLE '+artNum+' — CLAUSE DE NON-CONCURRENCE</h2>';
      html+='<p class="article">Conformement aux articles 65 et 86 de la Loi du 3 juillet 1978, et pour autant que la rémunération annuelle brute depasse 41.969 EUR (montant indexe 2026), le Travailleur s engage, en cas de cessation du contrat, a ne pas exercer d activites similaires, soit en exploitant une entreprise personnelle, soit en s engageant chez un employeur concurrent, pendant une duree maximale de <strong>12 mois</strong> a compter de la fin du contrat, dans un rayon geographique de <strong>[zone]</strong>.</p>';
      html+='<p class="article">En contrepartie, l Employeur versera une indemnite compensatoire unique egale a la moitie de la rémunération brute correspondant a la duree d application de la clause (Art. 65 §2, 4° Loi 3/7/1978).</p>';
      html+='<p class="ref">Ref. legale : Art. 65 (employes) et Art. 86 (ouvriers) Loi 3/7/1978. Conditions: salaire > 41.969 EUR/an; duree max 12 mois; zone geographique limitee; activites similaires; indemnite compensatoire.</p>';
      artNum++;
    }

    // ARTICLE — CLAUSE D'ECOLAGE
    if(ecolage){
      html+='<h2>ARTICLE '+artNum+' — CLAUSE D ECOLAGE</h2>';
      html+='<p class="article">Conformement a l article 22bis de la Loi du 3 juillet 1978, le Travailleur beneficiant d une formation specifique aux frais de l Employeur s engage a rester au service de l Employeur pendant une duree de <strong>[duree]</strong> mois.</p>';
      html+='<p class="article">En cas de depart anticipe, le Travailleur remboursera les frais de formation selon le bareme degressif legal : 80% (depart avant 1/3 de la periode), 50% (entre 1/3 et 2/3), 20% (au-dela de 2/3). Le montant ne pourra exceder 30% de la rémunération annuelle du Travailleur (Art. 22bis §5).</p>';
      html+='<p class="ref">Ref. legale : Art. 22bis Loi 3/7/1978. Conditions : rémunération annuelle > 41.969 EUR; formation > 80h ou cout > 2x RMMMG; ecrit obligatoire avant le debut de la formation.</p>';
      artNum++;
    }

    // ARTICLE — TELETRAVAIL
    if(teletravail){
      html+='<h2>ARTICLE '+artNum+' — TELETRAVAIL</h2>';
      html+='<p class="article">Conformement a la CCT n°85 du CNT du 27 novembre 2005 concernant le teletravail et a la Loi du 3 octobre 2022, le Travailleur pourra exercer du teletravail structurel selon les modalites suivantes :</p>';
      html+='<p class="article">- Jours de teletravail : <strong>[nombre] jours par semaine</strong><br/>- Plages horaires de joignabilite : <strong>[horaires]</strong><br/>- Equipement fourni par l Employeur : ordinateur portable, connexion internet<br/>- Indemnite forfaitaire de bureau : <strong>[montant]</strong> EUR/mois</p>';
      html+='<p class="ref">Ref. legale : CCT n°85 CNT 27/11/2005. Loi 3/10/2022 portant dispositions diverses en matiere de teletravail. AR 2/10/2000 (travail a domicile). Art. 119.1 Loi 3/7/1978 (travailleur a domicile).</p>';
      artNum++;
    }

    // ARTICLE — DISPOSITIONS SPECIFIQUES CP
    html+='<h2>ARTICLE '+artNum+' — DISPOSITIONS SPECIFIQUES A LA '+cp+'</h2>';
    html+='<p class="article">Le present contrat est soumis aux dispositions specifiques de la <strong>'+cpData.name+'</strong> :</p>';
    html+='<p class="article">'+cpData.specificites+'</p>';
    artNum++;

    // ARTICLE — RGPD
    html+='<h2>ARTICLE '+artNum+' — PROTECTION DES DONNEES (RGPD)</h2>';
    html+='<p class="article">Conformement au Reglement (UE) 2016/679 du 27 avril 2016 (RGPD) et a la Loi du 30 juillet 2018, l Employeur traite les donnees personnelles du Travailleur aux fins de la gestion de la relation de travail et des obligations legales y afferentes. Le Travailleur dispose d un droit d acces, de rectification, d effacement et de portabilite de ses donnees (Art. 15-20 RGPD).</p>';
    artNum++;

    // ARTICLE — DROIT APPLICABLE
    html+='<h2>ARTICLE '+artNum+' — DROIT APPLICABLE ET JURIDICTION</h2>';
    html+='<p class="article">Le present contrat est regi par le droit belge, et en particulier par :<br/>- La Loi du 3 juillet 1978 relative aux contrats de travail;<br/>- La Loi du 16 mars 1971 sur le travail;<br/>- La Loi du 12 avril 1965 concernant la protection de la rémunération;<br/>- La Loi du 26 decembre 2013 concernant le statut unique;<br/>- Les CCT applicables dans la '+cpData.name+';<br/>- Le reglement de travail de l Employeur.</p>';
    html+='<p class="article">En cas de litige, les Tribunaux du Travail du ressort du lieu d execution habituel du contrat sont competents (Art. 578 du Code judiciaire).</p>';
    artNum++;

    // ARTICLE — DISPOSITIONS FINALES
    html+='<h2>ARTICLE '+artNum+' — DISPOSITIONS FINALES</h2>';
    html+='<p class="article">Le present contrat est etabli en deux exemplaires, chaque partie reconnaissant avoir recu le sien, conformement a l article 4 de la Directive (UE) 2019/1152 transposee par la Loi du 7 octobre 2022.</p>';
    html+='<p class="article">Le Travailleur declare avoir pris connaissance du reglement de travail en vigueur au sein de l entreprise et en accepter les dispositions (Loi du 8 avril 1965 instituant les reglements de travail).</p>';

    // Custom clauses
    if(customClauses.length>0){
      artNum++;
      html+='<h2>ARTICLE '+artNum+' — CLAUSES PARTICULIERES</h2>';
      customClauses.forEach((cc,i)=>{
        html+='<p class="article">'+(i+1)+'. '+cc+'</p>';
      });
    }

    // SIGNATURES
    html+='<div style="margin-top:40px">';
    html+='<p class="article">Fait a '+(co.ville||co.city||'[lieu]')+', le '+new Date().toLocaleDateString('fr-BE')+', en deux exemplaires originaux.</p>';
    html+='<div class="signature">L EMPLOYEUR<br/><br/><br/>'+(co.name||'')+'<br/>'+(co.representant||'[Nom]')+'<br/>'+(co.qualite||'Gerant')+'</div>';
    html+='<div style="display:inline-block;width:8%"></div>';
    html+='<div class="signature">LE TRAVAILLEUR<br/><br/><br/>'+empName+'<br/>Precede de la mention manuscrite :<br/>"Lu et approuve"</div>';
    html+='</div>';

    html+='<div style="margin-top:30px;padding-top:15px;border-top:2px solid #eee;font-size:8pt;color:#888">';
    html+='Document genere par Aureus Social Pro — aureussocial.be — Ce contrat doit être adapté par un juriste ou un conseiller en droit social avant signature definitive. '+new Date().toLocaleDateString('fr-BE');
    html+='</div>';

    html+='</body></html>';
    return html;
  };

  return <div style={{padding:24}}>
    <div style={{marginBottom:20}}>
      <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📝 Generateur de Contrats de Travail</h2>
      <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Contrats legaux par Commission Paritaire — Articles de loi inclus</p>
    </div>

    {/* Step 1: Select client + employee */}
    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:12,marginBottom:16}}>
      <div>
        <div style={{fontSize:10,color:'#888',marginBottom:4}}>Client (employeur)</div>
        <select value={selClient||''} onChange={e=>{ setSelClient(e.target.value); setSelEmp(null); const c=clients.find(cl2=>cl2.id===e.target.value); if(c?.company?.cp) setCp(c.company.cp); }} style={{width:'100%',padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}>
          <option value="">Selectionnez un client</option>
          {clients.map((c,i)=><option key={i} value={c.id}>{c.company?.name}</option>)}
        </select>
      </div>
      <div>
        <div style={{fontSize:10,color:'#888',marginBottom:4}}>Travailleur</div>
        <select value={selEmp||''} onChange={e=>setSelEmp(e.target.value)} disabled={!selClient} style={{width:'100%',padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:selClient?'#e5e5e5':'#555',fontSize:12,fontFamily:'inherit'}}>
          <option value="">Selectionnez un employe</option>
          {cl&&(cl.emps||[]).map((e,i)=><option key={i} value={e.id}>{(e.first||e.fn||'')+' '+(e.last||e.ln||'')}</option>)}
        </select>
      </div>
      <div>
        <div style={{fontSize:10,color:'#888',marginBottom:4}}>Commission Paritaire</div>
        <select value={cp} onChange={e=>setCp(e.target.value)} style={{width:'100%',padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}>
          {Object.entries(CP_DATABASE).map(([k,v])=><option key={k} value={k}>{k} — {v.name.split(' — ')[1]}</option>)}
        </select>
      </div>
    </div>

    {/* CP Info */}
    <div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12,marginBottom:16}}>
      <div style={{fontSize:13,fontWeight:700,color:'#c6a34e',marginBottom:8}}>{cpData.name}</div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
        {[{l:'Statut',v:cpData.type},{l:'Duree travail',v:cpData.duree+'h/sem'},{l:'Indexation',v:cpData.indexation},{l:'RMMMG',v:cpData.rmmmg}].map((k,i)=>
          <div key={i} style={{padding:6,background:'rgba(255,255,255,.02)',borderRadius:6}}>
            <div style={{fontSize:8,color:'#888'}}>{k.l}</div>
            <div style={{fontSize:11,color:'#e5e5e5',fontWeight:500}}>{k.v}</div>
          </div>
        )}
      </div>
      <div style={{fontSize:10,color:'#888',marginTop:8}}>{cpData.specificites}</div>
    </div>

    {/* Contract options */}
    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:16}}>
      <div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Type de contrat</div>
        <div style={{display:'flex',gap:6}}>
          {['CDI','CDD'].map(t=><button key={t} onClick={()=>setContractType(t)} style={{flex:1,padding:'8px',borderRadius:6,border:'none',background:contractType===t?'rgba(198,163,78,.15)':'rgba(255,255,255,.03)',color:contractType===t?'#c6a34e':'#888',fontWeight:contractType===t?600:400,fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>{t}</button>)}
        </div>
        {contractType==='CDD'&&<div style={{marginTop:8}}>
          <input value={cddEnd} onChange={e=>setCddEnd(e.target.value)} type="date" placeholder="Date de fin" style={{width:'100%',padding:'6px 8px',background:'rgba(255,255,255,.03)',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',boxSizing:'border-box'}}/>
          <select value={cddMotif} onChange={e=>setCddMotif(e.target.value)} style={{width:'100%',marginTop:4,padding:'6px 8px',background:'rgba(255,255,255,.03)',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
            <option value="surcroit">Surcroit de travail</option>
            <option value="remplacement">Remplacement</option>
            <option value="projet">Travail nettement defini</option>
          </select>
        </div>}
        <div style={{marginTop:8}}>
          <input value={fonction} onChange={e=>setFonction(e.target.value)} placeholder="Fonction / poste" style={{width:'100%',padding:'6px 8px',background:'rgba(255,255,255,.03)',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',boxSizing:'border-box'}}/>
        </div>
        <div style={{marginTop:4}}>
          <input value={lieuTravail} onChange={e=>setLieuTravail(e.target.value)} placeholder="Lieu de travail" style={{width:'100%',padding:'6px 8px',background:'rgba(255,255,255,.03)',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',boxSizing:'border-box'}}/>
        </div>
        <div style={{marginTop:4}}>
          <input value={horaire} onChange={e=>setHoraire(e.target.value)} placeholder="Horaire" style={{width:'100%',padding:'6px 8px',background:'rgba(255,255,255,.03)',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',boxSizing:'border-box'}}/>
        </div>
      </div>

      <div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Clauses optionnelles</div>
        {[{id:'confidentialite',l:'Clause de confidentialite (Art. 17, 3°bis)',v:confidentialite,set:setConfidentialite},
          {id:'nonConcurrence',l:'Clause de non-concurrence (Art. 65)',v:nonConcurrence,set:setNonConcurrence},
          {id:'ecolage',l:'Clause d ecolage (Art. 22bis)',v:ecolage,set:setEcolage},
          {id:'teletravail',l:'Teletravail structurel (CCT 85)',v:teletravail,set:setTeletravail}
        ].map(c=><div key={c.id} onClick={()=>c.set(!c.v)} style={{display:'flex',alignItems:'center',gap:8,padding:'6px 0',cursor:'pointer'}}>
          <div style={{width:16,height:16,borderRadius:4,border:'2px solid '+(c.v?'#c6a34e':'#555'),background:c.v?'rgba(198,163,78,.15)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,color:'#c6a34e',flexShrink:0}}>{c.v?'V':''}</div>
          <span style={{fontSize:11,color:c.v?'#e5e5e5':'#888'}}>{c.l}</span>
        </div>)}

        <div style={{marginTop:10,borderTop:'1px solid rgba(255,255,255,.05)',paddingTop:8}}>
          <div style={{fontSize:10,color:'#888',marginBottom:4}}>Clause personnalisee</div>
          <div style={{display:'flex',gap:4}}>
            <input id="custom-clause-input" placeholder="Ajoutez une clause..." style={{flex:1,padding:'6px 8px',background:'rgba(255,255,255,.03)',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:10,fontFamily:'inherit'}}/>
            <button onClick={()=>{const inp=document.getElementById('custom-clause-input');if(inp?.value){setCustomClauses(p=>[...p,inp.value]);inp.value='';}}} style={{padding:'6px 12px',borderRadius:6,border:'none',background:'rgba(198,163,78,.15)',color:'#c6a34e',fontSize:10,cursor:'pointer',fontFamily:'inherit'}}>+</button>
          </div>
          {customClauses.map((cc,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'3px 0',fontSize:10,color:'#e5e5e5'}}>
            <span>{cc.substring(0,50)}...</span>
            <span onClick={()=>setCustomClauses(p=>p.filter((_,j)=>j!==i))} style={{color:'#ef4444',cursor:'pointer'}}>x</span>
          </div>)}
        </div>
      </div>
    </div>

    {/* Generate button */}
    <div style={{display:'flex',gap:10}}>
      <button onClick={()=>{const html=generateContract();if(html){const w=window.open('','_blank','width=850,height=900');if(w){w.document.write(html);w.document.close();}}}} disabled={!selClient||!selEmp} style={{flex:1,padding:'14px',borderRadius:12,border:'none',background:(!selClient||!selEmp)?'rgba(198,163,78,.1)':'linear-gradient(135deg,#c6a34e,#a07d3e)',color:(!selClient||!selEmp)?'#555':'#060810',fontWeight:700,fontSize:14,cursor:(!selClient||!selEmp)?'not-allowed':'pointer',fontFamily:'inherit'}}>
        📄 GENERER LE CONTRAT
      </button>
      <button onClick={()=>{const html=generateContract();if(html){const blob=new Blob([html],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='contrat_'+(emp?(emp.first||emp.fn||'')+'_'+(emp.last||emp.ln||''):'travailleur')+'_'+new Date().toISOString().split('T')[0]+'.html';a.click();try{logDocument(cl?.id,emp?.id,'contrat','Contrat '+(contractType)+' '+((emp?.first||emp?.fn||'')+' '+(emp?.last||emp?.ln||'')),{cp,contractType});}catch(e){}}}} disabled={!selClient||!selEmp} style={{padding:'14px 24px',borderRadius:12,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontWeight:600,fontSize:14,cursor:(!selClient||!selEmp)?'not-allowed':'pointer',fontFamily:'inherit'}}>
        ⬇ Telecharger
      </button>
    </div>

    {/* Reference box */}
    <div style={{marginTop:16,padding:14,background:'rgba(59,130,246,.04)',border:'1px solid rgba(59,130,246,.1)',borderRadius:12}}>
      <div style={{fontSize:11,fontWeight:600,color:'#3b82f6',marginBottom:6}}>📚 References legales utilisees</div>
      <div style={{fontSize:9,color:'#888',lineHeight:1.6}}>
        Loi du 3/7/1978 relative aux contrats de travail (M.B. 22/8/1978) •
        Loi du 26/12/2013 concernant le statut unique (M.B. 31/12/2013) •
        Loi du 16/3/1971 sur le travail •
        Loi du 12/4/1965 protection de la rémunération •
        Loi du 8/4/1965 reglements de travail •
        Loi du 4/1/1974 jours fériés •
        Loi du 5/3/2017 travail faisable et maniable (Peeters) •
        Loi du 7/10/2022 transposition Directive (UE) 2019/1152 •
        Loi du 30/7/2018 secrets d affaires •
        Reglement (UE) 2016/679 (RGPD) •
        Lois coord. 28/6/1971 vacances annuelles •
        CCT n°85 CNT 27/11/2005 (teletravail) •
        CCT n°98 CNT 20/2/2009 (eco-cheques) •
        CCT n°109 CNT 12/2/2014 (licenciement deraisonnable) •
        CCT n°103 CNT 27/6/2012 (credit-temps) •
        CCT sectorielles {cp}
      </div>
    </div>
  </div>;
};


// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 32: IMPORT CSV/EXCEL + ONBOARDING GUIDE         ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. IMPORT CSV/EXCEL — Importer des employes en masse ═══
const ImportCSV=({s,d})=>{
  const [file,setFile]=useState(null);
  const [parsed,setParsed]=useState(null);
  const [mapping,setMapping]=useState({});
  const [preview,setPreview]=useState([]);
  const [step,setStep]=useState(1); // 1=upload, 2=mapping, 3=preview, 4=done
  const [importing,setImporting]=useState(false);
  const [results,setResults]=useState(null);
  const [selClient,setSelClient]=useState('');
  const [separator,setSeparator]=useState(',');
  const [errors,setErrors]=useState([]);
  const [csvProfile,setCsvProfile]=useState('auto');
  const [detectedProfiles,setDetectedProfiles]=useState([]);
  const clients=s.clients||[];

  // Parser profiles for competitor payroll software
  const PROFILES={
    auto:{name:'Auto-detection',desc:'Detection automatique des colonnes'},
    gappaie:{name:'GapPaie',desc:'Export personnel GapPaie'},
    partena:{name:'Partena Professional',desc:'Export signaletique Partena'},
    securex:{name:'Securex',desc:'Export personnel Securex My HR'},
    sdworx:{name:'SD Worx',desc:'Export SD Worx / Blox'},
    liantis:{name:'Liantis',desc:'Export personnel Liantis'},
  };

  const PROFILE_MAPS={
    gappaie:{'Matricule':'_id','Nom':'last','Prenom':'first','Prénom':'first','N° Registre National':'niss','NRN':'niss','Email':'email','E-mail':'email','IBAN':'iban','Salaire brut':'monthlySalary','Salaire mensuel':'monthlySalary','Brut mensuel':'monthlySalary','Date entree':'startDate','Date entrée':'startDate','Fonction':'function','Categorie':'statut','Catégorie':'statut','Regime':'whWeek','Régime':'whWeek','Commission paritaire':'cp','CP':'cp','Situation familiale':'civil','Enfants a charge':'depChildren','Enfants':'depChildren','Nationalite':'nationalite','Nationalité':'nationalite','Telephone':'phone','GSM':'phone','Adresse':'address','Contrat':'contractType','Type contrat':'contractType'},
    partena:{'N° travailleur':'_id','Nom de famille':'last','Nom':'last','Prénom':'first','NISS':'niss','Numéro national':'niss','E-mail privé':'email','Email':'email','N° de compte':'iban','IBAN':'iban','Salaire mensuel brut':'monthlySalary','Rémunération mensuelle':'monthlySalary','Salaire de base':'monthlySalary','Date entrée en service':'startDate','Date d\'entrée':'startDate','Nature du contrat':'contractType','Type de contrat':'contractType','Fonction':'function','Description fonction':'function','Catégorie':'statut','Type travailleur':'statut','Régime de travail':'whWeek','Durée hebdomadaire':'whWeek','Commission paritaire':'cp','N° CP':'cp','CP':'cp','Situation familiale':'civil','État civil':'civil','Personnes à charge':'depChildren','Enfants à charge':'depChildren','Nationalité':'nationalite','Tél. privé':'phone','GSM':'phone','Adresse complète':'address'},
    securex:{'N° personnel':'_id','Matricule':'_id','Nom':'last','Familienaam':'last','Prénom':'first','Voornaam':'first','NISS':'niss','N° registre national':'niss','Rijksregisternummer':'niss','Email':'email','E-mail':'email','IBAN':'iban','Compte bancaire':'iban','Salaire brut':'monthlySalary','Brut mensuel':'monthlySalary','Brutoloon':'monthlySalary','Date entrée':'startDate','Date d\'entrée en service':'startDate','Type contrat':'contractType','Contracttype':'contractType','Fonction':'function','Functie':'function','Catégorie':'statut','Statuut':'statut','Régime':'whWeek','Arbeidsregime':'whWeek','Heures/semaine':'whWeek','Commission paritaire':'cp','Paritair comité':'cp','CP':'cp','Situation familiale':'civil','Enfants à charge':'depChildren','Nationalité':'nationalite','Téléphone':'phone','GSM':'phone','Adresse':'address'},
    sdworx:{'WorkerNumber':'_id','N° travailleur':'_id','LastName':'last','Nom':'last','FirstName':'first','Prénom':'first','NationalNumber':'niss','NISS':'niss','Email':'email','Phone':'phone','BankAccount':'iban','IBAN':'iban','GrossSalary':'monthlySalary','Salaire brut':'monthlySalary','StartDate':'startDate','EndDate':'endDate','ContractType':'contractType','JobTitle':'function','Fonction':'function','WorkerCategory':'statut','WeeklyHours':'whWeek','JointCommittee':'cp','CP':'cp','MaritalStatus':'civil','DependentChildren':'depChildren','Nationality':'nationalite'},
    liantis:{'Werknemersnummer':'_id','Naam':'last','Nom':'last','Voornaam':'first','Prénom':'first','Rijksregisternr':'niss','NISS':'niss','E-mail':'email','Telefoon':'phone','IBAN':'iban','Brutoloon':'monthlySalary','Salaire brut':'monthlySalary','Indienstdatum':'startDate','Uitdienstdatum':'endDate','Contracttype':'contractType','Functie':'function','Fonction':'function','Statuut':'statut','Arbeidsregime':'whWeek','Paritair comité':'cp','CP':'cp'},
  };

  const FIELDS=[
    {key:'first',label:'Prenom',required:true},
    {key:'last',label:'Nom',required:true},
    {key:'niss',label:'NISS (Registre national)'},
    {key:'email',label:'Email'},
    {key:'phone',label:'Telephone'},
    {key:'address',label:'Adresse'},
    {key:'startDate',label:'Date d entree'},
    {key:'contractType',label:'Type contrat (CDI/CDD)'},
    {key:'monthlySalary',label:'Salaire brut mensuel',required:true},
    {key:'function',label:'Fonction'},
    {key:'whWeek',label:'Heures/semaine'},
    {key:'statut',label:'Statut (employe/ouvrier)'},
    {key:'civil',label:'Situation familiale'},
    {key:'depChildren',label:'Enfants a charge'},
    {key:'iban',label:'IBAN'},
    {key:'nationalite',label:'Nationalite'}
  ];

  const parseCSV=(text,sep)=>{
    const lines=text.split(/\r?\n/).filter(l=>l.trim());
    if(lines.length<2) return null;
    const headers=lines[0].split(sep).map(h=>h.trim().replace(/^"|"$/g,''));
    const rows=lines.slice(1).map(line=>{
      const vals=[];let cur='';let inQ=false;
      for(let i=0;i<line.length;i++){
        if(line[i]==='"'){inQ=!inQ;}
        else if(line[i]===sep&&!inQ){vals.push(cur.trim().replace(/^"|"$/g,''));cur='';}
        else{cur+=line[i];}
      }
      vals.push(cur.trim().replace(/^"|"$/g,''));
      const obj={};headers.forEach((h,j)=>obj[h]=vals[j]||'');
      return obj;
    }).filter(row=>Object.values(row).some(v=>v));
    return {headers,rows};
  };

  const handleFile=(e)=>{
    const f2=e.target.files[0];
    if(!f2) return;
    setFile(f2);
    const reader=new FileReader();
    reader.onload=(ev)=>{
      const text=ev.target.result;
      // Auto-detect separator
      const firstLine=text.split('\n')[0];
      const semiCount=(firstLine.match(/;/g)||[]).length;
      const commaCount=(firstLine.match(/,/g)||[]).length;
      const tabCount=(firstLine.match(/\t/g)||[]).length;
      const detectedSep=semiCount>commaCount?(semiCount>tabCount?';':'\t'):(commaCount>tabCount?',':'\t');
      setSeparator(detectedSep);
      const result=parseCSV(text,detectedSep);
      if(result){
        setParsed(result);
        // Detect matching profiles
        const matches=[];
        Object.entries(PROFILE_MAPS).forEach(([key,pmap])=>{
          const matched=result.headers.filter(h=>pmap[h]||pmap[h.trim()]);
          if(matched.length>=2) matches.push({key,name:PROFILES[key]?.name||key,score:Math.round(matched.length/result.headers.length*100),matched:matched.length});
        });
        matches.sort((a,b)=>b.score-a.score);
        setDetectedProfiles(matches);
        if(matches.length>0&&csvProfile==='auto') setCsvProfile(matches[0].key);

        // Auto-map columns — use profile if available
        const autoMap={};
        const activeProfile=csvProfile!=='auto'&&PROFILE_MAPS[csvProfile]?csvProfile:(matches[0]?.key||null);
        if(activeProfile&&PROFILE_MAPS[activeProfile]){
          result.headers.forEach(h=>{
            const mapped=PROFILE_MAPS[activeProfile][h]||PROFILE_MAPS[activeProfile][h.trim()];
            if(mapped&&mapped!=='_id') autoMap[h]=mapped;
          });
        } else result.headers.forEach(h=>{
          const hl=h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
          if(hl.includes('prenom')||hl.includes('first')||hl==='prenom') autoMap[h]='first';
          else if(hl.includes('nom')||hl.includes('last')||hl==='nom') autoMap[h]='last';
          else if(hl.includes('niss')||hl.includes('registre')||hl.includes('national')) autoMap[h]='niss';
          else if(hl.includes('email')||hl.includes('mail')) autoMap[h]='email';
          else if(hl.includes('tel')||hl.includes('phone')||hl.includes('gsm')) autoMap[h]='phone';
          else if(hl.includes('adresse')||hl.includes('address')||hl.includes('rue')) autoMap[h]='address';
          else if(hl.includes('entree')||hl.includes('start')||hl.includes('debut')) autoMap[h]='startDate';
          else if(hl.includes('contrat')||hl.includes('contract')) autoMap[h]='contractType';
          else if(hl.includes('salaire')||hl.includes('brut')||hl.includes('salary')||hl.includes('rémunération')) autoMap[h]='monthlySalary';
          else if(hl.includes('fonction')||hl.includes('function')||hl.includes('poste')) autoMap[h]='function';
          else if(hl.includes('heure')||hl.includes('hours')||hl.includes('regime')) autoMap[h]='whWeek';
          else if(hl.includes('statut')||hl.includes('status')||hl==='type') autoMap[h]='statut';
          else if(hl.includes('civil')||hl.includes('famille')||hl.includes('marital')) autoMap[h]='civil';
          else if(hl.includes('enfant')||hl.includes('child')) autoMap[h]='depChildren';
          else if(hl.includes('iban')||hl.includes('compte')||hl.includes('bank')) autoMap[h]='iban';
          else if(hl.includes('nation')) autoMap[h]='nationalite';
        });
        setMapping(autoMap);
        setStep(2);
      }
    };
    reader.readAsText(f2,'UTF-8');
  };

  const buildPreview=()=>{
    if(!parsed) return;
    const errs=[];
    const rows=parsed.rows.map((row,idx)=>{
      const emp={id:'IMP-'+Date.now()+'-'+idx};
      Object.entries(mapping).forEach(([csvCol,field])=>{
        if(field&&row[csvCol]!==undefined) emp[field]=row[csvCol];
      });
      // Validate
      if(!emp.first&&!emp.last) errs.push({row:idx+2,msg:'Prenom et Nom manquants'});
      if(!emp.monthlySalary||isNaN(+emp.monthlySalary)) errs.push({row:idx+2,msg:'Salaire brut manquant ou invalide: "'+emp.monthlySalary+'"'});
      // Clean
      if(emp.monthlySalary) emp.monthlySalary=parseFloat((''+emp.monthlySalary).replace(/[^0-9.,]/g,'').replace(',','.'));
      if(emp.whWeek) emp.whWeek=parseFloat((''+emp.whWeek).replace(',','.'))||38;
      if(emp.depChildren) emp.depChildren=parseInt(emp.depChildren)||0;
      if(!emp.contractType) emp.contractType='CDI';
      if(!emp.statut) emp.statut='employe';
      if(!emp.whWeek) emp.whWeek=38;
      return emp;
    });
    setPreview(rows);
    setErrors(errs);
    setStep(3);
  };

  const doImport=()=>{
    if(!selClient) return;
    setImporting(true);
    const cl=clients.find(c=>c.id===selClient);
    if(!cl) return;
    const existing=cl.emps||[];
    const newEmps=[...existing,...preview.filter(e=>e.first||e.last)];
    cl.emps=newEmps;
    d({...s,clients:clients.map(c=>c.id===selClient?{...c,emps:newEmps}:c)});
    setResults({added:preview.filter(e=>e.first||e.last).length,total:newEmps.length,client:cl.company?.name});
    setStep(4);
    setImporting(false);
  };

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📥 Import CSV / Excel</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Importez vos employes depuis un fichier CSV, TSV ou Excel exporte en CSV</p>

    {/* Progress */}
    <div style={{display:'flex',gap:4,marginBottom:20}}>
      {[{n:1,l:'Upload'},{n:2,l:'Mapping'},{n:3,l:'Verification'},{n:4,l:'Termine'}].map(st=>
        <div key={st.n} style={{flex:1,padding:'8px',textAlign:'center',borderRadius:6,background:step>=st.n?'rgba(198,163,78,.15)':'rgba(255,255,255,.03)',color:step>=st.n?'#c6a34e':'#555',fontSize:11,fontWeight:step===st.n?700:400}}>
          {st.n}. {st.l}
        </div>
      )}
    </div>

    {step===1&&<div style={{border:'2px dashed rgba(198,163,78,.2)',borderRadius:16,padding:40,textAlign:'center',cursor:'pointer'}} onClick={()=>document.getElementById('csv-input')?.click()}>
      <input id="csv-input" type="file" accept=".csv,.tsv,.txt" style={{display:'none'}} onChange={handleFile}/>
      <div style={{fontSize:40,marginBottom:12}}>📄</div>
      <div style={{fontSize:14,color:'#c6a34e',fontWeight:600}}>Cliquez ou glissez votre fichier CSV</div>
      <div style={{fontSize:11,color:'#888',marginTop:6}}>Formats acceptes : .csv .tsv .txt — Separateur auto-detecte (virgule, point-virgule, tabulation)</div>
      <div style={{marginTop:16,padding:12,background:'rgba(59,130,246,.04)',borderRadius:10,textAlign:'left',maxWidth:400,margin:'16px auto 0'}}>
        <div style={{fontSize:10,fontWeight:600,color:'#3b82f6',marginBottom:4}}>💡 Format recommande</div>
        <div style={{fontSize:9,color:'#888',fontFamily:'monospace',lineHeight:1.8}}>
          Prenom;Nom;Email;Salaire brut;Fonction;NISS<br/>
          Jean;Dupont;jean@mail.be;3500;Comptable;85010112345<br/>
          Marie;Martin;marie@mail.be;2800;Admin;90051554321
        </div>
      </div>
    </div>}

    {step===2&&parsed&&<div>
      <div style={{fontSize:13,fontWeight:600,color:'#e5e5e5',marginBottom:12}}>Mappez vos colonnes ({parsed.headers.length} colonnes detectees, {parsed.rows.length} lignes)</div>
      {detectedProfiles.length>0&&<div style={{padding:10,background:'rgba(34,197,94,.04)',border:'1px solid rgba(34,197,94,.15)',borderRadius:10,marginBottom:12}}>
        <div style={{fontSize:10,fontWeight:600,color:'#22c55e',marginBottom:6}}>Profil logiciel detecte</div>
        <select value={csvProfile} onChange={e=>{setCsvProfile(e.target.value);const pm=PROFILE_MAPS[e.target.value];if(pm){const am={};parsed.headers.forEach(h=>{const m=pm[h]||pm[h.trim()];if(m&&m!=='_id')am[h]=m;});setMapping(am);}}} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit',width:'100%'}}>
          <option value="auto">Auto-detection</option>
          {detectedProfiles.map(p=><option key={p.key} value={p.key}>{p.name} ({p.score}% match, {p.matched} colonnes)</option>)}
        </select>
      </div>}
      <div style={{display:'grid',gridTemplateColumns:'1fr 20px 1fr',gap:8,alignItems:'center'}}>
        <div style={{fontSize:10,fontWeight:600,color:'#888'}}>COLONNE CSV</div>
        <div></div>
        <div style={{fontSize:10,fontWeight:600,color:'#888'}}>CHAMP AUREUS</div>
        {parsed.headers.map((h,i)=><div key={i} style={{display:"contents"}}>
          <div style={{padding:'8px 12px',background:'rgba(255,255,255,.03)',borderRadius:6,fontSize:12,color:'#e5e5e5'}}>
            {h}
            <div style={{fontSize:9,color:'#888'}}>ex: {parsed.rows[0]?.[h]||'-'}</div>
          </div>
          <div style={{textAlign:'center',color:'#888'}}>→</div>
          <select value={mapping[h]||''} onChange={e=>setMapping(p=>({...p,[h]:e.target.value}))} style={{padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:mapping[h]?'#c6a34e':'#555',fontSize:11,fontFamily:'inherit'}}>
            <option value="">— Ignorer —</option>
            {FIELDS.map(fd=><option key={fd.key} value={fd.key}>{fd.label}{fd.required?' *':''}</option>)}
          </select>
        </div>)}
      </div>
      <div style={{display:'flex',gap:10,marginTop:16}}>
        <button onClick={()=>setStep(1)} style={{padding:'10px 20px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>← Retour</button>
        <button onClick={buildPreview} style={{flex:1,padding:'10px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:13,cursor:'pointer',fontFamily:'inherit'}}>Verifier les donnees →</button>
      </div>
    </div>}

    {step===3&&<div>
      {errors.length>0&&<div style={{padding:12,background:'rgba(239,68,68,.06)',border:'1px solid rgba(239,68,68,.15)',borderRadius:10,marginBottom:12}}>
        <div style={{fontSize:11,fontWeight:600,color:'#ef4444',marginBottom:4}}>⚠ {errors.length} avertissement(s)</div>
        {errors.slice(0,5).map((e,i)=><div key={i} style={{fontSize:10,color:'#ef4444'}}>Ligne {e.row}: {e.msg}</div>)}
        {errors.length>5&&<div style={{fontSize:10,color:'#888'}}>... et {errors.length-5} autres</div>}
      </div>}

      <div style={{fontSize:13,fontWeight:600,color:'#e5e5e5',marginBottom:8}}>{preview.length} employe(s) a importer</div>
      <div style={{overflowX:'auto',border:'1px solid rgba(198,163,78,.1)',borderRadius:10}}>
        <table style={{width:'100%',borderCollapse:'collapse',fontSize:10}}>
          <thead><tr style={{background:'rgba(198,163,78,.06)'}}>
            {['Prenom','Nom','Email','Salaire','Fonction','NISS','Contrat','Heures'].map(h=><th key={h} style={{padding:'8px 6px',textAlign:'left',color:'#c6a34e',fontWeight:600}}>{h}</th>)}
          </tr></thead>
          <tbody>
            {preview.slice(0,20).map((e,i)=><tr key={i} style={{borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <td style={{padding:'6px'}}>{e.first||<span style={{color:'#ef4444'}}>-</span>}</td>
              <td style={{padding:'6px'}}>{e.last||<span style={{color:'#ef4444'}}>-</span>}</td>
              <td style={{padding:'6px',color:'#3b82f6'}}>{e.email||'-'}</td>
              <td style={{padding:'6px',color:'#22c55e',fontWeight:600}}>{e.monthlySalary?new Intl.NumberFormat('fr-BE').format(e.monthlySalary)+' EUR':'-'}</td>
              <td style={{padding:'6px'}}>{e.function||'-'}</td>
              <td style={{padding:'6px',fontFamily:'monospace',fontSize:9}}>{e.niss||'-'}</td>
              <td style={{padding:'6px'}}>{e.contractType||'CDI'}</td>
              <td style={{padding:'6px'}}>{e.whWeek||38}h</td>
            </tr>)}
            {preview.length>20&&<tr><td colSpan={8} style={{padding:8,textAlign:'center',color:'#888'}}>... et {preview.length-20} autres</td></tr>}
          </tbody>
        </table>
      </div>

      <div style={{marginTop:12}}>
        <div style={{fontSize:10,color:'#888',marginBottom:4}}>Importer dans quel client ?</div>
        <select value={selClient} onChange={e=>setSelClient(e.target.value)} style={{width:'100%',padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}>
          <option value="">Selectionnez le client employeur</option>
          {clients.map((c,i)=><option key={i} value={c.id}>{c.company?.name} ({(c.emps||[]).length} emp.)</option>)}
        </select>
      </div>

      <div style={{display:'flex',gap:10,marginTop:16}}>
        <button onClick={()=>setStep(2)} style={{padding:'10px 20px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>← Mapping</button>
        <button onClick={doImport} disabled={!selClient||importing} style={{flex:1,padding:'12px',borderRadius:8,border:'none',background:!selClient?'rgba(198,163,78,.1)':'linear-gradient(135deg,#22c55e,#16a34a)',color:!selClient?'#555':'#fff',fontWeight:700,fontSize:14,cursor:!selClient?'not-allowed':'pointer',fontFamily:'inherit'}}>
          {importing?'Import en cours...':'✅ IMPORTER '+preview.length+' EMPLOYES'}
        </button>
      </div>
    </div>}

    {step===4&&results&&<div style={{textAlign:'center',padding:40}}>
      <div style={{fontSize:48,marginBottom:16}}>✅</div>
      <div style={{fontSize:18,fontWeight:700,color:'#22c55e'}}>{results.added} employes importes !</div>
      <div style={{fontSize:12,color:'#888',marginTop:4}}>Dans {results.client} — Total: {results.total} employes</div>
      <div style={{display:'flex',gap:10,justifyContent:'center',marginTop:20}}>
        <button onClick={()=>{setStep(1);setFile(null);setParsed(null);setPreview([]);setResults(null);}} style={{padding:'10px 20px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>📥 Importer un autre fichier</button>
      </div>
    </div>}
  </div>;
};

// ═══ 2. ONBOARDING GUIDE — Wizard premiere utilisation ═══
const SetupWizard=({s,d,setPage})=>{
  const [step,setStep]=useState(0);
  const [companyData,setCompanyData]=useState({name:'',vat:'',address:'',email:'',phone:'',cp:'200',onss:'',representant:'',qualite:'gerant',forme:'SRL'});
  const [empData,setEmpData]=useState([{first:'',last:'',email:'',monthlySalary:'',function:'',contractType:'CDI',niss:''}]);
  const [creating,setCreating]=useState(false);
  const [done,setDone]=useState(false);
  const clients=s.clients||[];

  const steps=[
    {icon:'🏢',title:'Votre premier client',desc:'Renseignez les infos de l entreprise'},
    {icon:'👤',title:'Les employes',desc:'Ajoutez au moins un employe'},
    {icon:'✅',title:'Confirmation',desc:'Tout est pret !'}
  ];

  const addEmp=()=>setEmpData(p=>[...p,{first:'',last:'',email:'',monthlySalary:'',function:'',contractType:'CDI',niss:''}]);
  const updateEmp=(idx,key,val)=>setEmpData(p=>p.map((e,i)=>i===idx?{...e,[key]:val}:e));

  const createClient=()=>{
    setCreating(true);
    const newClient={
      id:'CL-'+Date.now(),
      company:{...companyData},
      emps:empData.filter(e=>e.first&&e.last).map((e,i)=>({
        id:'EMP-'+Date.now()+'-'+i,
        first:e.first,last:e.last,email:e.email,
        monthlySalary:parseFloat((''+e.monthlySalary).replace(',','.'))||0,
        function:e.function,contractType:e.contractType,
        niss:e.niss,whWeek:38,statut:'employe',status:'actif',
        startDate:new Date().toISOString().split('T')[0]
      }))
    };
    const updatedClients=[...clients,newClient];
    d({...s,clients:updatedClients});
    setDone(true);
    setCreating(false);
  };

  const inputStyle={width:'100%',padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',boxSizing:'border-box'};

  return <div style={{padding:24,maxWidth:700,margin:'0 auto'}}>
    <div style={{textAlign:'center',marginBottom:24}}>
      <h2 style={{fontSize:24,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🚀 Bienvenue sur Aureus Social Pro</h2>
      <p style={{fontSize:13,color:'#888'}}>Configurons votre premier client en 3 etapes</p>
    </div>

    {/* Progress */}
    <div style={{display:'flex',gap:4,marginBottom:24}}>
      {steps.map((st,i)=><div key={i} style={{flex:1,padding:'10px',textAlign:'center',borderRadius:8,background:step>=i?'rgba(198,163,78,.12)':'rgba(255,255,255,.02)',border:'1px solid '+(step===i?'rgba(198,163,78,.3)':'transparent')}}>
        <div style={{fontSize:20}}>{st.icon}</div>
        <div style={{fontSize:11,fontWeight:step===i?700:400,color:step>=i?'#c6a34e':'#555'}}>{st.title}</div>
      </div>)}
    </div>

    {/* Step 0: Company */}
    {step===0&&!done&&<div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
      <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:16}}>🏢 Informations de l entreprise cliente</div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
        <div>
          <div style={{fontSize:10,color:'#888',marginBottom:3}}>Denomination sociale *</div>
          <input value={companyData.name} onChange={e=>setCompanyData(p=>({...p,name:e.target.value}))} placeholder="Ex: Dupont SPRL" style={inputStyle}/>
        </div>
        <div>
          <div style={{fontSize:10,color:'#888',marginBottom:3}}>Forme juridique</div>
          <select value={companyData.forme} onChange={e=>setCompanyData(p=>({...p,forme:e.target.value}))} style={inputStyle}>
            {['SRL','SA','SC','ASBL','SNC','SCS','Personne physique'].map(f2=><option key={f2}>{f2}</option>)}
          </select>
        </div>
        <div>
          <div style={{fontSize:10,color:'#888',marginBottom:3}}>Numero BCE / TVA *</div>
          <input value={companyData.vat} onChange={e=>setCompanyData(p=>({...p,vat:e.target.value}))} placeholder="BE 0XXX.XXX.XXX" style={inputStyle}/>
        </div>
        <div>
          <div style={{fontSize:10,color:'#888',marginBottom:3}}>Numéro ONSS</div>
          <input value={companyData.onss} onChange={e=>setCompanyData(p=>({...p,onss:e.target.value}))} placeholder="XXX-XXXXXXX-XX" style={inputStyle}/>
        </div>
        <div style={{gridColumn:'1/-1'}}>
          <div style={{fontSize:10,color:'#888',marginBottom:3}}>Adresse du siege social *</div>
          <input value={companyData.address} onChange={e=>setCompanyData(p=>({...p,address:e.target.value}))} placeholder="Rue, numero, code postal, ville" style={inputStyle}/>
        </div>
        <div>
          <div style={{fontSize:10,color:'#888',marginBottom:3}}>Email de l employeur *</div>
          <input value={companyData.email} onChange={e=>setCompanyData(p=>({...p,email:e.target.value}))} placeholder="contact@entreprise.be" type="email" style={inputStyle}/>
        </div>
        <div>
          <div style={{fontSize:10,color:'#888',marginBottom:3}}>Telephone</div>
          <input value={companyData.phone} onChange={e=>setCompanyData(p=>({...p,phone:e.target.value}))} placeholder="+32 XXX XX XX XX" style={inputStyle}/>
        </div>
        <div>
          <div style={{fontSize:10,color:'#888',marginBottom:3}}>Commission Paritaire *</div>
          <select value={companyData.cp} onChange={e=>setCompanyData(p=>({...p,cp:e.target.value}))} style={inputStyle}>
            <option value="200">CP 200 — Auxiliaire employes</option>
            <option value="100">CP 100 — Auxiliaire ouvriers</option>
            <option value="124">CP 124 — Construction</option>
            <option value="140">CP 140 — Transport</option>
            <option value="302">CP 302 — Horeca</option>
            <option value="111">CP 111 — Metal</option>
            <option value="209">CP 209 — Employes metal</option>
            <option value="226">CP 226 — Commerce international</option>
            <option value="330">CP 330 — Soins de sante</option>
            <option value="110">CP 110 — Textile</option>
          </select>
        </div>
        <div>
          <div style={{fontSize:10,color:'#888',marginBottom:3}}>Representant legal</div>
          <input value={companyData.representant} onChange={e=>setCompanyData(p=>({...p,representant:e.target.value}))} placeholder="Nom du gerant" style={inputStyle}/>
        </div>
      </div>
      <button onClick={()=>setStep(1)} disabled={!companyData.name||!companyData.vat} style={{width:'100%',marginTop:16,padding:'12px',borderRadius:10,border:'none',background:(!companyData.name||!companyData.vat)?'rgba(198,163,78,.1)':'linear-gradient(135deg,#c6a34e,#a07d3e)',color:(!companyData.name||!companyData.vat)?'#555':'#060810',fontWeight:700,fontSize:14,cursor:(!companyData.name||!companyData.vat)?'not-allowed':'pointer',fontFamily:'inherit'}}>Suivant →</button>
    </div>}

    {/* Step 1: Employees */}
    {step===1&&!done&&<div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
      <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:4}}>👤 Employes de {companyData.name}</div>
      <div style={{fontSize:11,color:'#888',marginBottom:16}}>Ajoutez au moins un employe. Vous pourrez en ajouter d autres plus tard ou importer un fichier CSV.</div>
      {empData.map((emp,idx)=><div key={idx} style={{padding:12,background:'rgba(255,255,255,.02)',borderRadius:10,marginBottom:8,border:'1px solid rgba(255,255,255,.03)'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
          <span style={{fontSize:11,fontWeight:600,color:'#3b82f6'}}>Employe {idx+1}</span>
          {empData.length>1&&<span onClick={()=>setEmpData(p=>p.filter((_,i)=>i!==idx))} style={{fontSize:10,color:'#ef4444',cursor:'pointer'}}>Supprimer</span>}
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:6}}>
          <input value={emp.first} onChange={e=>updateEmp(idx,'first',e.target.value)} placeholder="Prenom *" style={{...inputStyle,padding:'8px'}}/>
          <input value={emp.last} onChange={e=>updateEmp(idx,'last',e.target.value)} placeholder="Nom *" style={{...inputStyle,padding:'8px'}}/>
          <input value={emp.email} onChange={e=>updateEmp(idx,'email',e.target.value)} placeholder="Email" style={{...inputStyle,padding:'8px'}}/>
          <input value={emp.monthlySalary} onChange={e=>updateEmp(idx,'monthlySalary',e.target.value)} placeholder="Salaire brut *" style={{...inputStyle,padding:'8px'}}/>
          <input value={emp.function} onChange={e=>updateEmp(idx,'function',e.target.value)} placeholder="Fonction" style={{...inputStyle,padding:'8px'}}/>
          <input value={emp.niss} onChange={e=>updateEmp(idx,'niss',e.target.value)} placeholder="NISS" style={{...inputStyle,padding:'8px'}}/>
        </div>
      </div>)}
      <button onClick={addEmp} style={{width:'100%',padding:'8px',borderRadius:8,border:'1px dashed rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontSize:11,cursor:'pointer',fontFamily:'inherit',marginBottom:12}}>+ Ajouter un employe</button>
      <div style={{display:'flex',gap:10}}>
        <button onClick={()=>setStep(0)} style={{padding:'10px 20px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>← Retour</button>
        <button onClick={()=>setStep(2)} disabled={!empData.some(e=>e.first&&e.last)} style={{flex:1,padding:'12px',borderRadius:10,border:'none',background:!empData.some(e=>e.first&&e.last)?'rgba(198,163,78,.1)':'linear-gradient(135deg,#c6a34e,#a07d3e)',color:!empData.some(e=>e.first&&e.last)?'#555':'#060810',fontWeight:700,fontSize:14,cursor:'pointer',fontFamily:'inherit'}}>Verifier →</button>
      </div>
    </div>}

    {/* Step 2: Confirmation */}
    {step===2&&!done&&<div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
      <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:16}}>✅ Verification</div>
      <div style={{padding:14,background:'rgba(255,255,255,.02)',borderRadius:10,marginBottom:12}}>
        <div style={{fontSize:13,fontWeight:700,color:'#e5e5e5'}}>{companyData.name}</div>
        <div style={{fontSize:11,color:'#888',marginTop:4}}>BCE: {companyData.vat} — CP: {companyData.cp} — {companyData.forme}</div>
        <div style={{fontSize:11,color:'#888'}}>{companyData.address}</div>
        <div style={{fontSize:11,color:'#3b82f6'}}>{companyData.email} — {companyData.phone}</div>
      </div>
      <div style={{fontSize:12,fontWeight:600,color:'#e5e5e5',marginBottom:8}}>{empData.filter(e=>e.first&&e.last).length} employe(s) :</div>
      {empData.filter(e=>e.first&&e.last).map((e,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 10px',background:'rgba(255,255,255,.02)',borderRadius:6,marginBottom:4,fontSize:11}}>
        <span style={{color:'#e5e5e5'}}>{e.first} {e.last}</span>
        <span style={{color:'#22c55e',fontWeight:600}}>{e.monthlySalary?new Intl.NumberFormat('fr-BE').format(parseFloat((''+e.monthlySalary).replace(',','.'))||0)+' EUR':'-'}</span>
      </div>)}
      <div style={{display:'flex',gap:10,marginTop:16}}>
        <button onClick={()=>setStep(1)} style={{padding:'10px 20px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>← Modifier</button>
        <button onClick={createClient} disabled={creating} style={{flex:1,padding:'14px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#22c55e,#16a34a)',color:'#fff',fontWeight:700,fontSize:15,cursor:'pointer',fontFamily:'inherit',boxShadow:'0 4px 20px rgba(34,197,94,.3)'}}>
          {creating?'Creation...':'🚀 CREER LE CLIENT'}
        </button>
      </div>
    </div>}

    {/* Done */}
    {done&&<div style={{textAlign:'center',padding:30}}>
      <div style={{fontSize:56,marginBottom:16}}>🎉</div>
      <div style={{fontSize:20,fontWeight:700,color:'#22c55e'}}>Client cree avec succes !</div>
      <div style={{fontSize:13,color:'#888',marginTop:8}}>{companyData.name} — {empData.filter(e=>e.first&&e.last).length} employe(s)</div>
      <div style={{marginTop:20,padding:16,background:'rgba(198,163,78,.04)',borderRadius:12,textAlign:'left',maxWidth:400,margin:'20px auto 0'}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Prochaines etapes :</div>
        {[
          {icon:'📝',text:'Générer les contrats de travail',page:'contratgen'},
          {icon:'🏎️',text:'Lancer le Pilote Auto (calcul paie)',page:'piloteauto'},
          {icon:'📧',text:'Envoyer les fiches aux employes',page:'envoiMasse'},
          {icon:'📥',text:'Importer plus d employes (CSV)',page:'importcsv'}
        ].map((a,i)=><div key={i} onClick={()=>setPage&&setPage(a.page)} style={{display:'flex',alignItems:'center',gap:8,padding:'8px',borderRadius:6,cursor:'pointer',marginBottom:4,background:'rgba(255,255,255,.02)'}}>
          <span style={{fontSize:16}}>{a.icon}</span>
          <span style={{fontSize:12,color:'#e5e5e5'}}>{a.text}</span>
          <span style={{marginLeft:'auto',color:'#c6a34e',fontSize:10}}>→</span>
        </div>)}
      </div>
    </div>}
  </div>;
};



// ═══ SPRINT 34: PDF FICHE DE PAIE + LANDING PAGE ═══
function generateFichePayePDF(emp, client, period, calcResult) {
  const co=client?.company||{};
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const brut=calcResult?.gross||+(emp.monthlySalary||0);
  const onssW=calcResult?.onssNet||Math.round(brut*TX_ONSS_W*100)/100;
  const imposable=calcResult?.imposable||(brut-onssW);
  const pp=calcResult?.precompte||calcPrecompteExact(brut,{situation:'isole',enfants:+(emp.depChildren||0)}).pp;
  const bonus=calcResult?.bonusEmploi||calcBonusEmploi(brut);
  const css=calcResult?.css||calcCSSS(brut,'isole');
  const net=calcResult?.net||(brut-onssW-pp-css+bonus);
  const onssE=calcResult?.onssEmployer||Math.round(brut*0.25*100)/100;
  const cout=brut+onssE;

  const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Fiche de paie - ${(emp.first||'')} ${(emp.last||'')} - ${period}</title>
<style>
@page{size:A4;margin:15mm 20mm;}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,sans-serif;}
body{background:#fff;color:#1a1a2e;font-size:10px;line-height:1.4;}
.page{width:210mm;min-height:297mm;padding:15mm 20mm;margin:0 auto;}
.header{display:flex;justify-content:space-between;border-bottom:3px solid #c6a34e;padding-bottom:12px;margin-bottom:15px;}
.header-left{max-width:55%;}
.company{font-size:16px;font-weight:800;color:#1a1a2e;}
.company-info{font-size:9px;color:#555;margin-top:4px;line-height:1.6;}
.header-right{text-align:right;}
.doc-title{font-size:14px;font-weight:700;color:#c6a34e;text-transform:uppercase;}
.doc-period{font-size:11px;color:#555;margin-top:4px;}
.section{margin-bottom:12px;}
.section-title{font-size:10px;font-weight:700;color:#c6a34e;text-transform:uppercase;letter-spacing:1px;padding:5px 10px;background:#f8f6f0;border-left:3px solid #c6a34e;margin-bottom:6px;}
table{width:100%;border-collapse:collapse;}
td,th{padding:5px 10px;text-align:left;font-size:9.5px;}
.row-alt{background:#fafafa;}
.label{color:#555;width:55%;}
.value{text-align:right;font-weight:600;color:#1a1a2e;}
.value-green{text-align:right;font-weight:700;color:#16a34a;}
.value-red{text-align:right;font-weight:600;color:#dc2626;}
.value-blue{text-align:right;font-weight:600;color:#2563eb;}
.total-row{border-top:2px solid #c6a34e;background:#f8f6f0;}
.total-row td{font-weight:700;font-size:11px;padding:8px 10px;}
.net-box{margin-top:15px;padding:15px;background:linear-gradient(135deg,#f0ead2,#faf3e0);border:2px solid #c6a34e;border-radius:8px;text-align:center;}
.net-label{font-size:10px;color:#555;text-transform:uppercase;letter-spacing:1px;}
.net-value{font-size:28px;font-weight:800;color:#16a34a;margin:5px 0;}
.net-words{font-size:9px;color:#888;font-style:italic;}
.footer{margin-top:20px;border-top:1px solid #ddd;padding-top:10px;display:flex;justify-content:space-between;font-size:8px;color:#888;}
.emp-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;}
.emp-grid div{padding:4px 10px;}
.legal{font-size:7.5px;color:#aaa;margin-top:15px;text-align:center;line-height:1.5;}
@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}.page{padding:0;}}
</style></head><body>
<div class="page">
<div class="header">
  <div class="header-left">
    <div class="company">${co.name||'Employeur'}</div>
    <div class="company-info">
      BCE: ${co.vat||'-'} — ONSS: ${co.onss||'-'}<br/>
      ${co.address||'-'}<br/>
      CP ${co.cp||'200'} — ${co.forme||'SRL'}
    </div>
  </div>
  <div class="header-right">
    <div class="doc-title">Fiche de Paie</div>
    <div class="doc-period">${period}</div>
    <div style="font-size:8px;color:#888;margin-top:4px;">Ref: FP-${Date.now()}</div>
  </div>
</div>

<div class="section">
  <div class="section-title">Identification du travailleur</div>
  <div class="emp-grid">
    <div><span class="label">Nom:</span> <strong>${(emp.first||'')} ${(emp.last||'')}</strong></div>
    <div><span class="label">NISS:</span> ${emp.niss||emp.NISS||'-'}</div>
    <div><span class="label">Fonction:</span> ${emp.function||emp.fonction||'-'}</div>
    <div><span class="label">Contrat:</span> ${emp.contractType||'CDI'} - ${emp.whWeek||38}h/sem</div>
    <div><span class="label">Statut:</span> ${emp.statut||'employe'}</div>
    <div><span class="label">Date entree:</span> ${emp.startDate||'-'}</div>
  </div>
</div>

<div class="section">
  <div class="section-title">Rémunération</div>
  <table>
    <tr><td class="label">Salaire mensuel brut</td><td class="value">${f2(brut)} EUR</td></tr>
    <tr class="row-alt"><td class="label">Regime de travail</td><td class="value">${emp.whWeek||38}h/sem (${Math.round((emp.whWeek||38)/38*100)}%)</td></tr>
  </table>
</div>

<div class="section">
  <div class="section-title">Retenues travailleur</div>
  <table>
    <tr><td class="label">ONSS personnelle (13,07%)</td><td class="value-red">- ${f2(onssW)} EUR</td></tr>
    <tr class="row-alt"><td class="label">Revenu imposable</td><td class="value">${f2(imposable)} EUR</td></tr>
    <tr><td class="label">Précompte professionnel</td><td class="value-red">- ${f2(pp)} EUR</td></tr>
    <tr class="row-alt"><td class="label">Cotisation spéciale securite sociale</td><td class="value-red">- ${f2(css)} EUR</td></tr>
    ${bonus>0?'<tr><td class="label">Bonus a l emploi (Art. 289ter CIR)</td><td class="value-green">+ '+f2(bonus)+' EUR</td></tr>':''}
    <tr class="total-row"><td>TOTAL RETENUES</td><td class="value-red">- ${f2(onssW+pp+css-bonus)} EUR</td></tr>
  </table>
</div>

<div class="section">
  <div class="section-title">Charges employeur</div>
  <table>
    <tr><td class="label">ONSS patronale (25%)</td><td class="value">${f2(onssE)} EUR</td></tr>
    <tr class="row-alt"><td class="label">Coût total employeur</td><td class="value" style="font-weight:700;color:#dc2626;">${f2(cout)} EUR</td></tr>
  </table>
</div>

<div class="net-box">
  <div class="net-label">Net a payer</div>
  <div class="net-value">${f2(net)} EUR</div>
  <div class="net-words">Virement sur compte ${emp.iban||emp.IBAN||'(IBAN non renseigne)'}</div>
</div>

<div class="footer">
  <div>Aureus Social Pro — Secrétariat social agree<br/>Généré le ${new Date().toLocaleDateString('fr-BE')}</div>
  <div style="text-align:right;">Document confidentiel<br/>Conservation: 5 ans (Art. 24 AR 08/08/1980)</div>
</div>

<div class="legal">
  Ce document est etabli conformement a la Loi du 12/04/1965 relative a la protection de la rémunération des travailleurs.<br/>
  Précompte professionnel calcule selon l'Annexe III de l'AR/CIR 92 (bareme 2026).<br/>
  ONSS: Loi du 27/06/1969 revisant l'arrete-loi du 28/12/1944 concernant la securite sociale des travailleurs.
</div>
</div>
</body></html>`;

  // Sprint 42: Enhanced PDF with download option
  const w=window.open('','_blank','width=800,height=1100');
  if(w){
    w.document.write(html);w.document.close();
    // Auto-trigger print (= PDF via browser)
    setTimeout(()=>w.print(),500);
  }
  // Also create downloadable HTML file
  var blob=new Blob([html],{type:'text/html;charset=utf-8'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  var empName=((emp.first||emp.fn||'')+'_'+(emp.last||emp.ln||'')).replace(/\s/g,'_');
  var moisNoms=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  var pStr=period&&period.month?moisNoms[(period.month||1)-1]+'_'+(period.year||2026):'';
  a.href=url;a.download='Fiche_Paie_'+empName+'_'+pStr+'.html';
  document.body.appendChild(a);a.click();
  setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
  return html;
}
// Sprint 42: Batch PDF payslips - generates all employees at once
function generateAllPayslips(emps,company,period){
  const co=company||{};const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const month=period?.month||new Date().getMonth()+1;const year=period?.year||new Date().getFullYear();
  const periodeStr=mois[month-1]+' '+year;
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  let allPages='';
  (emps||[]).forEach((emp,idx)=>{
    const brut=+(emp.monthlySalary||emp.gross||0);
    const onssW=Math.round(brut*TX_ONSS_W*100)/100;
    const imp=brut-onssW;
    const ppRes=calcPrecompteExact(brut,{situation:emp.civil==='married_1'?'marie_1r':'isole',enfants:+(emp.depChildren||0)});
    const pp=ppRes.pp;const bonus=ppRes.bonusEmploi||0;
    const css=calcCSSS(brut,'isole');
    const net=Math.round((brut-onssW-pp-css+bonus)*100)/100;
    const onssE=Math.round(brut*TX_ONSS_E*100)/100;
    const name=(emp.first||emp.fn||'')+ ' '+(emp.last||emp.ln||'');
    allPages+=`<div class="page" style="page-break-after:always;padding:20mm;font-family:Arial,sans-serif;font-size:10px;">
<div style="display:flex;justify-content:space-between;border-bottom:3px solid #c6a34e;padding-bottom:10px;margin-bottom:15px;">
<div><div style="font-size:16px;font-weight:800;">${co.name||'Entreprise'}</div><div style="font-size:9px;color:#555;">${co.address||''}<br/>TVA: ${co.vat||''}</div></div>
<div style="text-align:right;"><div style="font-size:14px;font-weight:700;color:#c6a34e;">FICHE DE PAIE</div><div style="font-size:11px;color:#555;">${periodeStr}</div></div>
</div>
<div style="background:#f8f6f0;padding:8px 12px;border-left:3px solid #c6a34e;margin-bottom:10px;"><b>${name}</b> — NISS: ${emp.niss||'N/A'} — ${emp.contractType||'CDI'} — ${(+(emp.regime||100))}%</div>
<table style="width:100%;border-collapse:collapse;">
<tr style="background:#f8f6f0;"><td style="padding:5px 10px;font-weight:700;" colspan="2">RÉMUNÉRATION</td></tr>
<tr><td style="padding:4px 10px;color:#555;">Salaire brut mensuel</td><td style="text-align:right;font-weight:600;">${f2(brut)} EUR</td></tr>
<tr style="background:#f8f6f0;"><td style="padding:5px 10px;font-weight:700;" colspan="2">RETENUES TRAVAILLEUR</td></tr>
<tr><td style="padding:4px 10px;color:#555;">ONSS personnelle (13,07%)</td><td style="text-align:right;color:#dc2626;">- ${f2(onssW)} EUR</td></tr>
<tr><td style="padding:4px 10px;color:#555;">Imposable</td><td style="text-align:right;">${f2(imp)} EUR</td></tr>
<tr><td style="padding:4px 10px;color:#555;">Précompte professionnel</td><td style="text-align:right;color:#dc2626;">- ${f2(pp)} EUR</td></tr>
<tr><td style="padding:4px 10px;color:#555;">CSSS</td><td style="text-align:right;color:#dc2626;">- ${f2(css)} EUR</td></tr>
${bonus>0?'<tr><td style="padding:4px 10px;color:#555;">Bonus à l\'emploi</td><td style="text-align:right;color:#16a34a;">+ '+f2(bonus)+' EUR</td></tr>':''}
<tr style="border-top:2px solid #c6a34e;background:#f8f6f0;"><td style="padding:8px 10px;font-weight:700;font-size:12px;">NET À PAYER</td><td style="text-align:right;font-weight:800;font-size:14px;color:#16a34a;">${f2(net)} EUR</td></tr>
<tr style="background:#f8f6f0;"><td style="padding:5px 10px;font-weight:700;" colspan="2">CHARGES EMPLOYEUR</td></tr>
<tr><td style="padding:4px 10px;color:#555;">ONSS patronale (25,07%)</td><td style="text-align:right;">${f2(onssE)} EUR</td></tr>
<tr><td style="padding:4px 10px;color:#555;">Coût total employeur</td><td style="text-align:right;font-weight:700;color:#dc2626;">${f2(brut+onssE)} EUR</td></tr>
</table>
<div style="margin-top:20px;font-size:8px;color:#999;">PP calculé selon Annexe III AR/CIR 92 (barème 2026) — Aureus Social Pro</div>
</div>`;
  });
  const fullHtml='<!DOCTYPE html><html><head><meta charset="utf-8"><title>Fiches de paie '+periodeStr+'</title><style>@page{size:A4;margin:0;}@media print{.page{page-break-after:always;}}</style></head><body>'+allPages+'</body></html>';
  var blob=new Blob([fullHtml],{type:'text/html;charset=utf-8'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url;a.download='Fiches_Paie_'+periodeStr.replace(/ /g,'_')+'.html';
  document.body.appendChild(a);a.click();
  setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
  // Also open for print
  var w=window.open('','_blank');
  if(w){w.document.write(fullHtml);w.document.close();setTimeout(()=>w.print(),800);}
  return {count:emps.length,period:periodeStr};
}

// ═══ LANDING PAGE ═══
const LandingPage=()=>{
  const [email,setEmail]=useState('');
  const [sent,setSent]=useState(false);
  const features=[
    {icon:'🏎️',title:'Pilote Auto',desc:'Calcul de paie automatique pour tous vos clients en un clic. ONSS, precompte, net — tout est calcule.'},
    {icon:'📝',title:'Contrats Legaux',desc:'Generation de contrats par Commission Paritaire avec references legales completes (10 CP integrees).'},
    {icon:'📧',title:'Distribution Auto',desc:'Envoi des fiches de paie aux employes et recaps aux employeurs en masse via email.'},
    {icon:'📅',title:'Absences Temps Reel',desc:'Vos clients encodent les absences au quotidien. Impact automatique sur la paie.'},
    {icon:'📥',title:'Import CSV',desc:'Migration des employes depuis Excel/CSV en 3 etapes avec mapping intelligent.'},
    {icon:'🔒',title:'RGPD Compliant',desc:'Donnees hebergees en Belgique. Chiffrement. Droit a l oubli. DPO integre.'},
    {icon:'📊',title:'DmfA / Dimona',desc:'Declarations ONSS generees automatiquement au format XML officiel.'},
    {icon:'💸',title:'SEPA Virements',desc:'Fichiers pain.001.003.03 generes pour les virements salariaux.'},
    {icon:'🧠',title:'IA Predictive',desc:'Prediction du turnover, recommandations salariales, detection d anomalies.'},
  ];

  const pricing=[
    {name:'Starter',price:'149',period:'/mois',clients:'Jusqu a 5 clients',emps:'50 employes max',features:['Calcul de paie','Fiches de paie','SEPA virements','Support email'],cta:'Essai gratuit 30j',pop:false},
    {name:'Professional',price:'349',period:'/mois',clients:'Jusqu a 25 clients',emps:'250 employes max',features:['Tout Starter +','Contrats legaux','DmfA/Dimona','Import CSV','Envoi masse','Support prioritaire'],cta:'Commencer',pop:true},
    {name:'Enterprise',price:'749',period:'/mois',clients:'Clients illimites',emps:'Employes illimites',features:['Tout Professional +','IA predictive','API acces','Multi-utilisateurs','Formation sur site','SLA garanti'],cta:'Nous contacter',pop:false},
  ];

  const stats=[
    {v:'10',l:'Commissions Paritaires'},
    {v:'69',l:'Modules de paie'},
    {v:'97',l:'Composants React'},
    {v:'22K',l:'Lignes de code'},
  ];

  return <div style={{background:'#060810',color:'#e5e5e5',minHeight:'100vh'}}>
    {/* Hero */}
    <div style={{textAlign:'center',padding:'60px 20px 40px',maxWidth:800,margin:'0 auto'}}>
      <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',textTransform:'uppercase',letterSpacing:2,marginBottom:12}}>Secretariat Social Nouvelle Generation</div>
      <h1 style={{fontSize:38,fontWeight:800,lineHeight:1.2,margin:'0 0 16px'}}>
        La paie belge,<br/><span style={{background:'linear-gradient(135deg,#c6a34e,#e8d48b)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>automatisee a 100%</span>
      </h1>
      <p style={{fontSize:16,color:'#888',maxWidth:550,margin:'0 auto 24px',lineHeight:1.6}}>
        Aureus Social Pro automatise le calcul de paie, les declarations ONSS, les contrats et la distribution des fiches pour vos clients employeurs.
      </p>
      <div style={{display:'flex',gap:12,justifyContent:'center',flexWrap:'wrap'}}>
        <button style={{padding:'14px 32px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:15,cursor:'pointer',fontFamily:'inherit',boxShadow:'0 4px 20px rgba(198,163,78,.3)'}}>Essai gratuit 30 jours</button>
        <button style={{padding:'14px 32px',borderRadius:10,border:'1px solid rgba(198,163,78,.3)',background:'transparent',color:'#c6a34e',fontWeight:600,fontSize:15,cursor:'pointer',fontFamily:'inherit'}}>Voir la demo</button>
      </div>
    </div>

    {/* Stats */}
    <div style={{display:'flex',justifyContent:'center',gap:30,padding:'20px',flexWrap:'wrap'}}>
      {stats.map((s,i)=><div key={i} style={{textAlign:'center'}}>
        <div style={{fontSize:28,fontWeight:800,color:'#c6a34e'}}>{s.v}</div>
        <div style={{fontSize:10,color:'#888'}}>{s.l}</div>
      </div>)}
    </div>

    {/* Features */}
    <div style={{maxWidth:900,margin:'40px auto',padding:'0 20px'}}>
      <h2 style={{textAlign:'center',fontSize:24,fontWeight:700,marginBottom:30}}>Tout ce dont votre fiduciaire a besoin</h2>
      <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:16}}>
        {features.map((ft,i)=><div key={i} style={{padding:20,background:'rgba(198,163,78,.03)',border:'1px solid rgba(198,163,78,.08)',borderRadius:14}}>
          <div style={{fontSize:28,marginBottom:8}}>{ft.icon}</div>
          <div style={{fontSize:14,fontWeight:700,color:'#c6a34e',marginBottom:6}}>{ft.title}</div>
          <div style={{fontSize:11,color:'#888',lineHeight:1.6}}>{ft.desc}</div>
        </div>)}
      </div>
    </div>

    {/* Pricing */}
    <div style={{maxWidth:900,margin:'50px auto',padding:'0 20px'}}>
      <h2 style={{textAlign:'center',fontSize:24,fontWeight:700,marginBottom:8}}>Tarifs transparents</h2>
      <p style={{textAlign:'center',fontSize:12,color:'#888',marginBottom:30}}>Sans engagement. Essai gratuit 30 jours. Facturation mensuelle.</p>
      <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:16}}>
        {pricing.map((pl,i)=><div key={i} style={{padding:24,background:pl.pop?'linear-gradient(135deg,rgba(198,163,78,.08),rgba(198,163,78,.02))':'rgba(255,255,255,.02)',border:pl.pop?'2px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.05)',borderRadius:16,position:'relative'}}>
          {pl.pop&&<div style={{position:'absolute',top:-10,left:'50%',transform:'translateX(-50%)',padding:'3px 12px',background:'#c6a34e',color:'#060810',fontSize:9,fontWeight:700,borderRadius:20,textTransform:'uppercase'}}>Populaire</div>}
          <div style={{fontSize:14,fontWeight:600,color:'#e5e5e5'}}>{pl.name}</div>
          <div style={{marginTop:8}}><span style={{fontSize:32,fontWeight:800,color:'#c6a34e'}}>{pl.price} EUR</span><span style={{color:'#888',fontSize:11}}>{pl.period}</span></div>
          <div style={{fontSize:11,color:'#888',marginTop:4}}>{pl.clients} — {pl.emps}</div>
          <div style={{marginTop:16}}>
            {pl.features.map((ft2,j)=><div key={j} style={{fontSize:11,color:'#e5e5e5',padding:'4px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>✓ {ft2}</div>)}
          </div>
          <button style={{width:'100%',marginTop:16,padding:'12px',borderRadius:10,border:pl.pop?'none':'1px solid rgba(198,163,78,.2)',background:pl.pop?'linear-gradient(135deg,#c6a34e,#a07d3e)':'transparent',color:pl.pop?'#060810':'#c6a34e',fontWeight:700,fontSize:13,cursor:'pointer',fontFamily:'inherit'}}>{pl.cta}</button>
        </div>)}
      </div>
    </div>

    {/* CTA */}
    <div style={{textAlign:'center',padding:'40px 20px',maxWidth:500,margin:'0 auto'}}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:8}}>Pret a automatiser votre secretariat ?</h2>
      <p style={{fontSize:12,color:'#888',marginBottom:16}}>Recevez une demo personnalisee en 24h</p>
      <div style={{display:'flex',gap:8}}>
        <input value={email} onChange={e=>setEmail(e.target.value)} placeholder="votre@email.be" type="email" style={{flex:1,padding:'12px 16px',borderRadius:10,border:'1px solid rgba(198,163,78,.2)',background:'#090c16',color:'#e5e5e5',fontSize:13,fontFamily:'inherit',outline:'none'}}/>
        <button onClick={()=>{if(email)setSent(true);}} style={{padding:'12px 24px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:13,cursor:'pointer',fontFamily:'inherit'}}>{sent?'✅ Envoye':'Demander une demo'}</button>
      </div>
    </div>

    {/* Footer */}
    <div style={{borderTop:'1px solid rgba(198,163,78,.1)',padding:'20px',textAlign:'center',fontSize:10,color:'#555'}}>
      Aureus Social Pro — Aureus IA SPRL — BCE BE 1028.230.781 — Saint-Gilles, Bruxelles<br/>
      Logiciel de gestion de paie belge conforme RGPD — © 2026
    </div>
  </div>;
};



// ═══ SPRINT 35: EMAIL TEMPLATES PRO + NOTIFICATION CENTER ═══
function emailWrap(content, footerText) {
  return `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><style>
body{margin:0;padding:0;background:#f4f4f4;font-family:'Segoe UI',Tahoma,Geneva,sans-serif;}
.wrapper{max-width:600px;margin:0 auto;background:#ffffff;}
.header{background:linear-gradient(135deg,#1a1a2e,#16213e);padding:24px 30px;text-align:center;}
.header img{height:32px;}
.logo-text{font-size:22px;font-weight:800;color:#c6a34e;letter-spacing:1px;}
.logo-sub{font-size:10px;color:rgba(198,163,78,.6);margin-top:2px;letter-spacing:2px;text-transform:uppercase;}
.content{padding:30px;}
.content h1{font-size:20px;color:#1a1a2e;margin:0 0 8px;font-weight:700;}
.content h2{font-size:16px;color:#c6a34e;margin:20px 0 8px;font-weight:700;}
.content p{font-size:13px;color:#555;line-height:1.6;margin:0 0 12px;}
.table-wrap{border:1px solid #e8e8e8;border-radius:8px;overflow:hidden;margin:16px 0;}
.table-wrap table{width:100%;border-collapse:collapse;}
.table-wrap th{background:#f8f6f0;color:#1a1a2e;font-size:10px;text-transform:uppercase;letter-spacing:1px;padding:10px 14px;text-align:left;border-bottom:2px solid #c6a34e;}
.table-wrap td{padding:10px 14px;font-size:12px;color:#333;border-bottom:1px solid #f0f0f0;}
.table-wrap tr:last-child td{border-bottom:none;}
.highlight{background:#f8f6f0;border-left:3px solid #c6a34e;padding:14px 18px;border-radius:0 6px 6px 0;margin:16px 0;}
.highlight .label{font-size:10px;color:#888;text-transform:uppercase;letter-spacing:1px;}
.highlight .value{font-size:24px;font-weight:800;color:#16a34a;margin-top:2px;}
.btn{display:inline-block;padding:12px 28px;background:#c6a34e;color:#ffffff;text-decoration:none;border-radius:8px;font-weight:700;font-size:13px;}
.footer{background:#1a1a2e;padding:20px 30px;text-align:center;}
.footer p{font-size:9px;color:rgba(255,255,255,.4);margin:0;line-height:1.6;}
.footer a{color:#c6a34e;text-decoration:none;}
.badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600;}
.badge-green{background:#dcfce7;color:#16a34a;}
.badge-blue{background:#dbeafe;color:#2563eb;}
.badge-red{background:#fee2e2;color:#dc2626;}
</style></head><body>
<div class="wrapper">
<div class="header">
  <div class="logo-text">AUREUS SOCIAL PRO</div>
  <div class="logo-sub">Secretariat Social</div>
</div>
<div class="content">${content}</div>
<div class="footer">
  <p>${footerText||'Aureus Social Pro — Aureus IA SPRL — BCE BE 1028.230.781'}<br/>
  Saint-Gilles, Bruxelles — <a href="https://aureussocial.be">aureussocial.be</a><br/><br/>
  Ce message est confidentiel et destine exclusivement a son destinataire.<br/>
  Traitement conforme au RGPD (UE) 2016/679.</p>
</div>
</div></body></html>`;
}

function emailFichePaie(emp, period, calcData) {
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const brut=calcData?.gross||+(emp.monthlySalary||0);
  const onss=calcData?.onssNet||Math.round(brut*TX_ONSS_W*100)/100;
  const pp=calcData?.precompte||0;
  const net=calcData?.net||(brut-onss-pp);
  
  const content=`
<h1>Votre fiche de paie — ${period}</h1>
<p>Bonjour ${emp.first||emp.fn||''},</p>
<p>Veuillez trouver ci-dessous le detail de votre rémunération pour la periode <strong>${period}</strong>.</p>

<div class="table-wrap">
<table>
  <tr><th colspan="2">Detail de la rémunération</th></tr>
  <tr><td>Salaire mensuel brut</td><td style="text-align:right;font-weight:700;color:#1a1a2e">${f2(brut)} EUR</td></tr>
  <tr><td>ONSS personnelle (13,07%)</td><td style="text-align:right;color:#dc2626">- ${f2(onss)} EUR</td></tr>
  <tr><td>Précompte professionnel</td><td style="text-align:right;color:#dc2626">- ${f2(pp)} EUR</td></tr>
  ${calcData?.bonusEmploi>0?'<tr><td>Bonus a l emploi</td><td style="text-align:right;color:#16a34a">+ '+f2(calcData.bonusEmploi)+' EUR</td></tr>':''}
</table>
</div>

<div class="highlight">
  <div class="label">Net a payer</div>
  <div class="value">${f2(net)} EUR</div>
</div>

<p style="font-size:11px;color:#888;">Le virement sera effectue sur votre compte ${emp.iban||emp.IBAN||'(IBAN enregistre)'}.</p>
<p style="font-size:11px;color:#888;">Pour toute question, contactez votre gestionnaire de paie.</p>
`;
  return emailWrap(content);
}

function emailRecapEmployeur(client, period, data) {
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const co=client?.company||{};
  
  const content=`
<h1>Recap mensuel — ${period}</h1>
<p>Bonjour,</p>
<p>Voici le recapitulatif de paie pour <strong>${co.name||'votre entreprise'}</strong> pour la periode <strong>${period}</strong>.</p>

<div class="table-wrap">
<table>
  <tr><th>Indicateur</th><th style="text-align:right">Montant</th></tr>
  <tr><td>Nombre d employes</td><td style="text-align:right;font-weight:700">${data.nbEmps||0}</td></tr>
  <tr><td>Masse salariale brute</td><td style="text-align:right;font-weight:700;color:#c6a34e">${f2(data.totalBrut)} EUR</td></tr>
  <tr><td>ONSS patronale</td><td style="text-align:right;color:#dc2626">${f2(data.onssE)} EUR</td></tr>
  <tr><td>ONSS personnelle (retenue)</td><td style="text-align:right;color:#dc2626">${f2(data.onssW)} EUR</td></tr>
  <tr><td>Précompte professionnel</td><td style="text-align:right;color:#dc2626">${f2(data.totalPP)} EUR</td></tr>
  <tr><td>Net total</td><td style="text-align:right;font-weight:700;color:#16a34a">${f2(data.totalNet)} EUR</td></tr>
  <tr style="background:#f8f6f0"><td style="font-weight:700">Coût total employeur</td><td style="text-align:right;font-weight:700;color:#dc2626;font-size:14px">${f2(data.coutTotal)} EUR</td></tr>
</table>
</div>

<h2>Echeances a retenir</h2>
<div class="table-wrap">
<table>
  <tr><td><span class="badge badge-red">5 du mois</span></td><td>ONSS — Provisions mensuelles</td><td style="text-align:right;font-weight:600">${f2(data.onssE)} EUR</td></tr>
  <tr><td><span class="badge badge-blue">15 du mois</span></td><td>Précompte professionnel 274</td><td style="text-align:right;font-weight:600">${f2(data.totalPP)} EUR</td></tr>
  <tr><td><span class="badge badge-green">25 du mois</span></td><td>Virements SEPA salaires</td><td style="text-align:right;font-weight:600">${f2(data.totalNet)} EUR</td></tr>
</table>
</div>

<p style="text-align:center;margin-top:20px;"><a href="https://aureussocial.be" class="btn">Accéder àu Dashboard</a></p>
`;
  return emailWrap(content);
}

function emailAlerteLegale(type, message, details) {
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const severityColor = type === 'critical' ? '#dc2626' : type === 'warning' ? '#f59e0b' : '#3b82f6';
  const severityLabel = type === 'critical' ? 'CRITIQUE' : type === 'warning' ? 'ATTENTION' : 'INFO';
  const content = `
<h1 style="color:${severityColor}">Alerte ${severityLabel}</h1>
<p>${message}</p>
${details?.echeance ? '<div class="highlight"><div class="label">Échéance</div><div class="value" style="color:'+severityColor+';font-size:16px">'+details.echeance+'</div></div>' : ''}
${details?.action ? '<p><strong>Action requise :</strong> '+details.action+'</p>' : ''}
${details?.baseLegale ? '<p style="font-size:11px;color:#888;"><strong>Base legale :</strong> '+details.baseLegale+'</p>' : ''}
${details?.sanction ? '<p style="font-size:11px;color:#dc2626;"><strong>Sanction :</strong> '+details.sanction+'</p>' : ''}
<p style="text-align:center;margin-top:20px;"><a href="https://app.aureussocial.be" class="btn">Voir dans Aureus Social</a></p>
`;
  return emailWrap(content);
}

function emailRappelEcheance(echeances) {
  const rows = (echeances || []).map(e =>
    `<tr><td><span class="badge badge-${e.urgent?'red':'blue'}">${e.date}</span></td><td>${e.label}</td><td style="text-align:right;font-weight:600">${e.montant||''}</td></tr>`
  ).join('');
  const content = `
<h1>Rappel echeances du mois</h1>
<p>Bonjour,</p>
<p>Voici les echeances a ne pas manquer ce mois-ci :</p>
<div class="table-wrap">
<table>
  <tr><th>Date</th><th>Obligation</th><th style="text-align:right">Montant</th></tr>
  ${rows}
</table>
</div>
<p style="font-size:11px;color:#888;">Ce rappel est genere automatiquement par Aureus Social Pro. Verifiez les montants exacts dans votre tableau de bord.</p>
<p style="text-align:center;margin-top:20px;"><a href="https://app.aureussocial.be" class="btn">Accéder àu Dashboard</a></p>
`;
  return emailWrap(content);
}

function emailFactureClient(facture) {
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const content = `
<h1>Facture ${facture.numero||''}</h1>
<p>Bonjour,</p>
<p>Veuillez trouver ci-joint votre facture pour les prestations de gestion de paie.</p>
<div class="table-wrap">
<table>
  <tr><th colspan="2">Detail facture</th></tr>
  <tr><td>Numéro</td><td style="text-align:right;font-weight:700">${facture.numero||'N/A'}</td></tr>
  <tr><td>Periode</td><td style="text-align:right">${facture.periode||'N/A'}</td></tr>
  <tr><td>HTVA</td><td style="text-align:right">${f2(facture.htva)} EUR</td></tr>
  <tr><td>TVA (21%)</td><td style="text-align:right">${f2(facture.tva)} EUR</td></tr>
  <tr style="background:#f8f6f0"><td style="font-weight:700">Total TTC</td><td style="text-align:right;font-weight:700;color:#c6a34e;font-size:14px">${f2(facture.ttc)} EUR</td></tr>
</table>
</div>
<div class="highlight">
  <div class="label">Echeance de paiement</div>
  <div class="value" style="font-size:16px;color:#1a1a2e">${facture.echeance||'30 jours'}</div>
</div>
<p style="font-size:11px;color:#888;">Paiement par virement sur le compte BE XX XXXX XXXX XXXX — Communication: ${facture.numero||''}</p>
`;
  return emailWrap(content);
}

// ═══ NOTIFICATION CENTER ═══
const NotificationCenter=({s,d})=>{
  const [notifs,setNotifs]=useState(()=>{
    const n=[];
    const now=new Date();
    const clients=s.clients||[];
    
    // Generate smart notifications
    clients.forEach(cl=>{
      const co=cl.company||{};
      const emps=cl.emps||[];
      
      // Missing NISS
      emps.filter(e=>!e.niss&&!e.NISS).forEach(e=>n.push({id:'N-'+Math.random().toString(36).substr(2,6),type:'warning',icon:'🆔',title:'NISS manquant',desc:(e.first||'')+' '+(e.last||'')+' — '+(co.name||''),time:new Date(now-3600000).toISOString(),read:false,action:'employees'}));
      
      // Missing IBAN
      emps.filter(e=>!e.iban&&!e.IBAN).forEach(e=>n.push({id:'N-'+Math.random().toString(36).substr(2,6),type:'warning',icon:'🏦',title:'IBAN manquant',desc:(e.first||'')+' '+(e.last||'')+' — '+(co.name||''),time:new Date(now-7200000).toISOString(),read:false,action:'employees'}));
      
      // Zero salary
      emps.filter(e=>+(e.monthlySalary||e.gross||0)<=0).forEach(e=>n.push({id:'N-'+Math.random().toString(36).substr(2,6),type:'error',icon:'⚠️',title:'Salaire non renseigne',desc:(e.first||'')+' '+(e.last||'')+' — '+(co.name||''),time:new Date(now-1800000).toISOString(),read:false,action:'employees'}));
    });
    
    // Deadline notifications
    const day=now.getDate();
    if(day<=5) n.push({id:'N-onss',type:'urgent',icon:'🏛',title:'ONSS — Provisions dues le 5',desc:'Provisions mensuelles ONSS a verser avant le 5 du mois',time:now.toISOString(),read:false,action:'echeancier'});
    if(day<=15) n.push({id:'N-pp',type:'info',icon:'💰',title:'Précompte professionnel — 274',desc:'Declaration PP a soumettre avant le 15 du mois',time:now.toISOString(),read:false,action:'echeancier'});
    if(day<=25) n.push({id:'N-sepa',type:'info',icon:'💸',title:'Virements SEPA salaires',desc:'Virements nets a effectuer avant le 25',time:now.toISOString(),read:false,action:'sepa'});
    
    // System notifications
    n.push({id:'N-sprint34',type:'success',icon:'🚀',title:'Sprint 35 deploye',desc:'Emails pro + Centre de notifications',time:now.toISOString(),read:false});
    
    return n.sort((a,b)=>new Date(b.time)-new Date(a.time));
  });
  
  const [filter,setFilter]=useState('all');
  
  const markRead=(id)=>setNotifs(p=>p.map(n=>n.id===id?{...n,read:true}:n));
  const markAllRead=()=>setNotifs(p=>p.map(n=>({...n,read:true})));
  const deleteNotif=(id)=>setNotifs(p=>p.filter(n=>n.id!==id));
  
  const unread=notifs.filter(n=>!n.read).length;
  const filtered=filter==='all'?notifs:filter==='unread'?notifs.filter(n=>!n.read):notifs.filter(n=>n.type===filter);
  
  const typeColors={error:'#ef4444',warning:'#eab308',urgent:'#ef4444',info:'#3b82f6',success:'#22c55e'};
  const timeAgo=(t)=>{const d=Math.floor((Date.now()-new Date(t))/60000);if(d<1)return 'A l instant';if(d<60)return d+'min';if(d<1440)return Math.floor(d/60)+'h';return Math.floor(d/1440)+'j';};

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🔔 Centre de Notifications</h2>
        <p style={{fontSize:12,color:'#888',margin:0}}>{unread} non lue(s) — {notifs.length} total</p>
      </div>
      {unread>0&&<button onClick={markAllRead} style={{padding:'8px 16px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontSize:11,cursor:'pointer',fontFamily:'inherit'}}>Tout marquer comme lu</button>}
    </div>
    
    <div style={{display:'flex',gap:4,marginBottom:16}}>
      {[{id:'all',l:'Toutes ('+notifs.length+')'},{id:'unread',l:'Non lues ('+unread+')'},{id:'error',l:'Erreurs'},{id:'warning',l:'Alertes'},{id:'info',l:'Infos'}].map(f2=>
        <button key={f2.id} onClick={()=>setFilter(f2.id)} style={{padding:'6px 14px',borderRadius:6,border:'none',background:filter===f2.id?'rgba(198,163,78,.15)':'transparent',color:filter===f2.id?'#c6a34e':'#888',fontSize:11,fontWeight:filter===f2.id?600:400,cursor:'pointer',fontFamily:'inherit'}}>{f2.l}</button>
      )}
    </div>
    
    <div style={{display:'flex',flexDirection:'column',gap:4}}>
      {filtered.length===0&&<div style={{textAlign:'center',padding:40,color:'#555',fontSize:13}}>Aucune notification</div>}
      {filtered.map(n=><div key={n.id} onClick={()=>markRead(n.id)} style={{display:'flex',gap:12,padding:'12px 16px',background:n.read?'transparent':'rgba(198,163,78,.03)',border:'1px solid '+(n.read?'rgba(255,255,255,.03)':'rgba(198,163,78,.1)'),borderRadius:10,cursor:'pointer',alignItems:'center'}}>
        <div style={{fontSize:20,flexShrink:0}}>{n.icon}</div>
        <div style={{flex:1,minWidth:0}}>
          <div style={{display:'flex',alignItems:'center',gap:6}}>
            <span style={{fontSize:12,fontWeight:n.read?400:600,color:n.read?'#888':'#e5e5e5'}}>{n.title}</span>
            {!n.read&&<span style={{width:6,height:6,borderRadius:3,background:'#c6a34e',flexShrink:0}}></span>}
          </div>
          <div style={{fontSize:10,color:'#666',marginTop:2}}>{n.desc}</div>
        </div>
        <div style={{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:4,flexShrink:0}}>
          <span style={{fontSize:9,color:'#555'}}>{timeAgo(n.time)}</span>
          <span style={{padding:'2px 6px',borderRadius:4,fontSize:8,fontWeight:600,background:(typeColors[n.type]||'#888')+'15',color:typeColors[n.type]||'#888'}}>{n.type}</span>
        </div>
        <span onClick={(e)=>{e.stopPropagation();deleteNotif(n.id);}} style={{fontSize:10,color:'#555',cursor:'pointer',padding:'4px',flexShrink:0}}>✕</span>
      </div>)}
    </div>
  </div>;
};



// ═══ SPRINT 36: JOURNAL ACTIVITE + BAREMES CP ═══
const JournalActivite=({s})=>{
  const [filter,setFilter]=useState('all');
  const [search,setSearch]=useState('');
  
  const actions=[
    {id:'A1',type:'calcul',icon:'🧮',title:'Calcul de paie batch',desc:'12 employés — TechCorp SPRL',user:'admin@aureussocial.be',time:new Date(Date.now()-1800000).toISOString(),status:'success'},
    {id:'A2',type:'email',icon:'📧',title:'Envoi fiches de paie',desc:'12 fiches envoyées — TechCorp SPRL',user:'admin@aureussocial.be',time:new Date(Date.now()-3600000).toISOString(),status:'success'},
    {id:'A3',type:'contrat',icon:'📝',title:'Contrat CDI généré',desc:'Jean Dupont — CP 200 — TechCorp SPRL',user:'admin@aureussocial.be',time:new Date(Date.now()-7200000).toISOString(),status:'success'},
    {id:'A4',type:'dimona',icon:'📡',title:'Dimona IN soumise',desc:'Marie Martin — NISS 85.04.12-123.45 — TechCorp',user:'admin@aureussocial.be',time:new Date(Date.now()-14400000).toISOString(),status:'success'},
    {id:'A5',type:'sepa',icon:'💸',title:'SEPA pain.001 généré',desc:'8 virements — 24.567,89 EUR — BelgaCo SA',user:'admin@aureussocial.be',time:new Date(Date.now()-28800000).toISOString(),status:'success'},
    {id:'A6',type:'import',icon:'📥',title:'Import CSV employés',desc:'5 employés importés — StartupBE SPRL',user:'admin@aureussocial.be',time:new Date(Date.now()-43200000).toISOString(),status:'success'},
    {id:'A7',type:'alert',icon:'⚠️',title:'Alerte salaire minimum',desc:'Pierre Leroy (2.100€) sous barème CP 200 (2.029,88€ min)',user:'system',time:new Date(Date.now()-50000000).toISOString(),status:'warning'},
    {id:'A8',type:'onss',icon:'🏛',title:'DmfA T4/2025 générée',desc:'3 clients — 45 travailleurs — XML exporté',user:'admin@aureussocial.be',time:new Date(Date.now()-86400000).toISOString(),status:'success'},
    {id:'A9',type:'email',icon:'📧',title:'Recap employeur envoyé',desc:'BelgaCo SA — Janvier 2026 — cout total 156.789 EUR',user:'admin@aureussocial.be',time:new Date(Date.now()-90000000).toISOString(),status:'success'},
    {id:'A10',type:'login',icon:'🔐',title:'Connexion',desc:'Depuis Bruxelles (BE) — Chrome',user:'admin@aureussocial.be',time:new Date(Date.now()-100000000).toISOString(),status:'info'},
  ];
  
  // Add real actions from state
  const clients=s.clients||[];
  clients.forEach(cl=>{
    const co=cl.company||{};
    (cl.emps||[]).forEach(e=>{
      if(e.absences?.length>0) e.absences.forEach(a=>actions.push({id:'AA-'+a.id,type:'absence',icon:'📅',title:'Absence encodée',desc:(e.first||'')+' '+(e.last||'')+' — '+a.type+' — '+(co.name||''),user:'client',time:a.createdAt||new Date().toISOString(),status:'info'}));
    });
  });
  
  actions.sort((a,b)=>new Date(b.time)-new Date(a.time));
  
  const typeColors={calcul:'#c6a34e',email:'#3b82f6',contrat:'#22c55e',dimona:'#a855f7',sepa:'#06b6d4',import:'#eab308',alert:'#ef4444',onss:'#ec4899',login:'#888',absence:'#f97316'};
  const timeAgo=(t)=>{const d=Math.floor((Date.now()-new Date(t))/60000);if(d<1)return 'A l instant';if(d<60)return d+'min';if(d<1440)return Math.floor(d/60)+'h';return Math.floor(d/1440)+'j';};
  
  const types=[{id:'all',l:'Tout'},{id:'calcul',l:'Calculs'},{id:'email',l:'Emails'},{id:'contrat',l:'Contrats'},{id:'dimona',l:'Dimona'},{id:'sepa',l:'SEPA'},{id:'onss',l:'ONSS'},{id:'alert',l:'Alertes'}];
  const filtered=actions.filter(a=>(filter==='all'||a.type===filter)&&(!search||a.title.toLowerCase().includes(search.toLowerCase())||a.desc.toLowerCase().includes(search.toLowerCase())));
  
  const stats={total:actions.length,today:actions.filter(a=>(Date.now()-new Date(a.time))<86400000).length,emails:actions.filter(a=>a.type==='email').length,alerts:actions.filter(a=>a.type==='alert').length};

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📋 Journal d Activite</h2>
        <p style={{fontSize:12,color:'#888',margin:0}}>Historique complet de toutes les actions</p>
      </div>
      <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Rechercher..." style={{padding:'8px 14px',width:200,background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',outline:'none'}}/>
    </div>
    
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Actions totales',v:stats.total,c:'#c6a34e'},{l:'Aujourd hui',v:stats.today,c:'#22c55e'},{l:'Emails envoyes',v:stats.emails,c:'#3b82f6'},{l:'Alertes',v:stats.alerts,c:'#ef4444'}].map((k,i)=>
        <div key={i} style={{padding:12,background:'rgba(198,163,78,.03)',border:'1px solid '+k.c+'15',borderRadius:10,textAlign:'center'}}>
          <div style={{fontSize:20,fontWeight:700,color:k.c}}>{k.v}</div>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
        </div>
      )}
    </div>
    
    <div style={{display:'flex',gap:4,marginBottom:14}}>
      {types.map(t=><button key={t.id} onClick={()=>setFilter(t.id)} style={{padding:'6px 12px',borderRadius:6,border:'none',background:filter===t.id?'rgba(198,163,78,.15)':'transparent',color:filter===t.id?'#c6a34e':'#888',fontSize:10,fontWeight:filter===t.id?600:400,cursor:'pointer',fontFamily:'inherit'}}>{t.l}</button>)}
    </div>
    
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      {filtered.length===0&&<div style={{padding:30,textAlign:'center',color:'#555',fontSize:12}}>Aucune action trouvee</div>}
      {filtered.slice(0,50).map((a,i)=><div key={a.id} style={{display:'flex',gap:12,padding:'10px 16px',borderBottom:'1px solid rgba(255,255,255,.03)',alignItems:'center'}}>
        <div style={{width:36,height:36,borderRadius:10,background:(typeColors[a.type]||'#888')+'12',display:'flex',alignItems:'center',justifyContent:'center',fontSize:16,flexShrink:0}}>{a.icon}</div>
        <div style={{flex:1,minWidth:0}}>
          <div style={{fontSize:12,fontWeight:600,color:'#e5e5e5'}}>{a.title}</div>
          <div style={{fontSize:10,color:'#666',marginTop:1}}>{a.desc}</div>
        </div>
        <div style={{textAlign:'right',flexShrink:0}}>
          <div style={{fontSize:9,color:'#555'}}>{timeAgo(a.time)}</div>
          <div style={{fontSize:8,color:'#444',marginTop:2}}>{a.user==='system'?'Systeme':a.user?.split('@')[0]||''}</div>
        </div>
        <div style={{width:6,height:6,borderRadius:3,background:a.status==='success'?'#22c55e':a.status==='warning'?'#eab308':'#3b82f6',flexShrink:0}}></div>
      </div>)}
    </div>
  </div>;
};

// ═══ BAREMES CP AUTO ═══
const BAREMES_CP_MIN={
  '200':{nom:'CP 200 — Employes',cat:[
    {classe:'A',desc:'Personnel d execution',min:2029.88,idx:'01/11/2025'},
    {classe:'B',desc:'Personnel qualifie',min:2134.72,idx:'01/11/2025'},
    {classe:'C',desc:'Personnel specialise',min:2226.58,idx:'01/11/2025'},
    {classe:'D',desc:'Cadres / Direction',min:2573.27,idx:'01/11/2025'},
  ],prime13eme:true,cheqRepas:'max 8 EUR/jour',ecoPrime:'max 250-750 EUR'},
  '100':{nom:'CP 100 — Ouvriers auxiliaire',cat:[
    {classe:'I',desc:'Manoeuvre',min:2029.88,idx:'01/11/2025'},
    {classe:'II',desc:'Ouvrier specialise',min:2095.44,idx:'01/11/2025'},
    {classe:'III',desc:'Ouvrier qualifie',min:2173.20,idx:'01/11/2025'},
  ],prime13eme:true,cheqRepas:'selon CCT sectorielle'},
  '124':{nom:'CP 124 — Construction',cat:[
    {classe:'I',desc:'Manoeuvre',min:2173.20,idx:'01/11/2025'},
    {classe:'IA',desc:'Manoeuvre specialise',min:2269.56,idx:'01/11/2025'},
    {classe:'II',desc:'Ouvrier qualifie',min:2365.92,idx:'01/11/2025'},
    {classe:'III',desc:'Ouvrier hautement qualifie',min:2462.28,idx:'01/11/2025'},
    {classe:'IV',desc:'Chef d equipe',min:2582.76,idx:'01/11/2025'},
  ],prime13eme:true,cheqRepas:'6 EUR/jour',timbFidelite:true},
  '302':{nom:'CP 302 — Hotellerie',cat:[
    {classe:'I',desc:'Personnel non qualifie',min:2029.88,idx:'01/11/2025'},
    {classe:'II',desc:'Personnel semi-qualifie',min:2095.44,idx:'01/11/2025'},
    {classe:'III',desc:'Personnel qualifie',min:2226.58,idx:'01/11/2025'},
    {classe:'IV',desc:'Chef de rang / Chef',min:2365.92,idx:'01/11/2025'},
  ],prime13eme:true,cheqRepas:'8 EUR/jour',pourboire:true},
  '330':{nom:'CP 330 — Sante',cat:[
    {classe:'1',desc:'Personnel logistique',min:2095.44,idx:'01/11/2025'},
    {classe:'2',desc:'Personnel soignant',min:2365.92,idx:'01/11/2025'},
    {classe:'3',desc:'Infirmier(e)',min:2582.76,idx:'01/11/2025'},
    {classe:'4',desc:'Cadre infirmier',min:2885.64,idx:'01/11/2025'},
  ],prime13eme:true,primeAttr:'Prime attractivite IFIC'},
  '140':{nom:'CP 140 — Transport',cat:[
    {classe:'A',desc:'Chauffeur C',min:2226.58,idx:'01/11/2025'},
    {classe:'B',desc:'Chauffeur CE',min:2365.92,idx:'01/11/2025'},
    {classe:'C',desc:'Chauffeur ADR',min:2462.28,idx:'01/11/2025'},
  ],prime13eme:true,cheqRepas:'7 EUR/jour',primeWeekend:true},
  '111':{nom:'CP 111 — Metal/Mecanique',cat:[
    {classe:'I',desc:'Ouvrier',min:2134.72,idx:'01/11/2025'},
    {classe:'II',desc:'Ouvrier specialise',min:2269.56,idx:'01/11/2025'},
    {classe:'III',desc:'Technicien',min:2462.28,idx:'01/11/2025'},
  ],prime13eme:true},
  '118':{nom:'CP 118 — Alimentaire',cat:[
    {classe:'I',desc:'Non qualifie',min:2095.44,idx:'01/11/2025'},
    {classe:'II',desc:'Semi-qualifie',min:2173.20,idx:'01/11/2025'},
    {classe:'III',desc:'Qualifie',min:2269.56,idx:'01/11/2025'},
  ],prime13eme:true,primeEquipe:'Prime d equipe si 2x8/3x8'},
  '209':{nom:'CP 209 — Fabrications metalliques (empl.)',cat:[
    {classe:'1',desc:'Employe administratif',min:2134.72,idx:'01/11/2025'},
    {classe:'2',desc:'Employe qualifie',min:2365.92,idx:'01/11/2025'},
    {classe:'3',desc:'Cadre',min:2750.00,idx:'01/11/2025'},
  ],prime13eme:true},
  '121':{nom:'CP 121 — Nettoyage',cat:[
    {classe:'IA',desc:'Nettoyeur(se)',min:2029.88,idx:'01/11/2025'},
    {classe:'IB',desc:'Nettoyeur(se) specialise',min:2095.44,idx:'01/11/2025'},
    {classe:'II',desc:'Chef d equipe',min:2226.58,idx:'01/11/2025'},
  ],prime13eme:true,cheqRepas:'selon CCT'},
};

const BaremesCP=({s})=>{
  const [selCP,setSelCP]=useState('200');
  const clients=s.clients||[];
  const allEmps=clients.reduce((a,c)=>[...a,...(c.emps||[]).map(e=>({...e,clientName:c.company?.name||'',clientCP:c.company?.cp||'200'}))]  ,[]);
  
  const bar=BAREMES_CP_MIN[selCP];
  const minSal=bar?Math.min(...bar.cat.map(c=>c.min)):0;
  
  const alertes=allEmps.filter(e=>{
    const cp=e.clientCP||'200';
    const b=BAREMES_CP_MIN[cp];
    if(!b) return false;
    const brut=+(e.monthlySalary||e.gross||0);
    const minB=Math.min(...b.cat.map(c=>c.min));
    return brut>0&&brut<minB;
  });

  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const cpKeys=Object.keys(BAREMES_CP_MIN);

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📊 Baremes Salariaux par CP</h2>
        <p style={{fontSize:12,color:'#888',margin:0}}>{cpKeys.length} Commissions Paritaires — Salaires minima indexes nov. 2025</p>
      </div>
      {alertes.length>0&&<div style={{padding:'8px 14px',background:'rgba(239,68,68,.08)',border:'1px solid rgba(239,68,68,.2)',borderRadius:8}}>
        <span style={{fontSize:12,fontWeight:600,color:'#ef4444'}}>⚠️ {alertes.length} employe(s) sous le minimum</span>
      </div>}
    </div>
    
    <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:16}}>
      {cpKeys.map(cp=><button key={cp} onClick={()=>setSelCP(cp)} style={{padding:'6px 12px',borderRadius:6,border:'none',background:selCP===cp?'rgba(198,163,78,.15)':'rgba(255,255,255,.02)',color:selCP===cp?'#c6a34e':'#888',fontSize:10,fontWeight:selCP===cp?600:400,cursor:'pointer',fontFamily:'inherit'}}>CP {cp}</button>)}
    </div>
    
    {bar&&<div>
      <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14,marginBottom:16}}>
        <div style={{fontSize:16,fontWeight:700,color:'#c6a34e',marginBottom:8}}>{bar.nom}</div>
        <div style={{display:'flex',gap:16,flexWrap:'wrap',fontSize:10,color:'#888'}}>
          {bar.prime13eme&&<span>✅ 13eme mois</span>}
          {bar.cheqRepas&&<span>🍽 Cheques repas: {bar.cheqRepas}</span>}
          {bar.ecoPrime&&<span>💰 Eco-cheques: {bar.ecoPrime}</span>}
          {bar.timbFidelite&&<span>⭐ Timbres fidelite</span>}
          {bar.primeAttr&&<span>🏥 {bar.primeAttr}</span>}
          {bar.primeEquipe&&<span>🔄 {bar.primeEquipe}</span>}
          {bar.primeWeekend&&<span>📅 Prime weekend</span>}
        </div>
      </div>
      
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden',marginBottom:16}}>
        <div style={{display:'grid',gridTemplateColumns:'80px 1fr 120px 100px',padding:'8px 14px',background:'rgba(198,163,78,.06)',fontSize:10,fontWeight:600,color:'#c6a34e'}}>
          <div>Classe</div><div>Description</div><div>Minimum brut</div><div>Index</div>
        </div>
        {bar.cat.map((c,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'80px 1fr 120px 100px',padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:12,alignItems:'center'}}>
          <div style={{fontWeight:700,color:'#c6a34e'}}>{c.classe}</div>
          <div style={{color:'#e5e5e5'}}>{c.desc}</div>
          <div style={{fontWeight:700,color:'#22c55e'}}>{f2(c.min)} EUR</div>
          <div style={{fontSize:9,color:'#888'}}>{c.idx}</div>
        </div>)}
      </div>

      {/* Employees in this CP */}
      {(()=>{
        const empsCP=allEmps.filter(e=>(e.clientCP||'200')===selCP);
        if(empsCP.length===0) return <div style={{padding:20,textAlign:'center',color:'#555',fontSize:12}}>Aucun employé dans cette CP</div>;
        return <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
          <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:11,fontWeight:600,color:'#c6a34e'}}>Employes CP {selCP} ({empsCP.length})</div>
          {empsCP.map((e,i)=>{
            const brut=+(e.monthlySalary||e.gross||0);
            const isBelow=brut>0&&brut<minSal;
            return <div key={i} style={{display:'grid',gridTemplateColumns:'200px 120px 100px 1fr',padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
              <div style={{color:'#e5e5e5',fontWeight:500}}>{(e.first||'')+' '+(e.last||'')}</div>
              <div style={{fontSize:10,color:'#888'}}>{e.clientName}</div>
              <div style={{fontWeight:600,color:isBelow?'#ef4444':'#22c55e'}}>{f2(brut)} EUR</div>
              <div>{isBelow?<span style={{fontSize:9,padding:'2px 8px',borderRadius:4,background:'rgba(239,68,68,.1)',color:'#ef4444'}}>⚠️ Sous minimum ({f2(minSal)})</span>:<span style={{fontSize:9,color:'#22c55e'}}>✅ Conforme</span>}</div>
            </div>;
          })}
        </div>;
      })()}
    </div>}

    {/* Global alerts */}
    {alertes.length>0&&<div style={{marginTop:20,border:'1px solid rgba(239,68,68,.2)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'10px 14px',background:'rgba(239,68,68,.06)',fontSize:12,fontWeight:600,color:'#ef4444'}}>⚠️ Alertes salaire minimum ({alertes.length})</div>
      {alertes.map((e,i)=>{
        const cp=e.clientCP||'200';
        const b=BAREMES_CP_MIN[cp];
        const minB=b?Math.min(...b.cat.map(c=>c.min)):0;
        return <div key={i} style={{display:'flex',gap:8,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',alignItems:'center'}}>
          <span style={{fontSize:14}}>⚠️</span>
          <div style={{flex:1}}>
            <div style={{fontSize:11,fontWeight:500,color:'#e5e5e5'}}>{(e.first||'')+' '+(e.last||'')} — {e.clientName}</div>
            <div style={{fontSize:9,color:'#888'}}>Brut: {f2(+(e.monthlySalary||e.gross||0))} EUR — Minimum CP {cp}: {f2(minB)} EUR — Ecart: {f2(minB-(+(e.monthlySalary||e.gross||0)))} EUR</div>
          </div>
        </div>;
      })}
    </div>}
  </div>;
};

const PlanAbsences=({s,d})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const [month,setMonth]=useState(new Date().getMonth());
  const [year,setYear]=useState(new Date().getFullYear());
  const [absences,setAbsences]=useState({});
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const jours=['Lu','Ma','Me','Je','Ve','Sa','Di'];
  const absTypes=[{id:'conge',icon:'🏖',label:'Conge',c:'#22c55e'},{id:'maladie',icon:'🤒',label:'Maladie',c:'#ef4444'},{id:'formation',icon:'📚',label:'Formation',c:'#3b82f6'},{id:'teletravail',icon:'🏠',label:'Teletravail',c:'#a855f7'},{id:'recup',icon:'⏰',label:'Recup',c:'#eab308'},{id:'sans_solde',icon:'⚪',label:'Sans solde',c:'#888'}];
  const [selType,setSelType]=useState('conge');
  const cl=clients[selClient]||{emps:[]};
  const emps=cl.emps||[];

  const getDaysInMonth=(m,y)=>new Date(y,m+1,0).getDate();
  const getFirstDay=(m,y)=>{const d=new Date(y,m,1).getDay();return d===0?6:d-1;};
  const days=getDaysInMonth(month,year);
  const firstDay=getFirstDay(month,year);
  const fériés=[1,1, 1,5, 21,7, 15,8, 1,11, 11,11, 25,12]; // Belgian holidays month,day pairs

  const isHoliday=(d)=>{for(let i=0;i<fériés.length;i+=2){if(fériés[i+1]-1===month&&fériés[i]===d)return true;}return false;};
  const isWeekend=(d)=>{const day=new Date(year,month,d).getDay();return day===0||day===6;};

  const toggleAbsence=(empIdx,day)=>{
    const key=selClient+'-'+empIdx+'-'+year+'-'+month+'-'+day;
    setAbsences(p=>{
      const cur={...p};
      if(cur[key]===selType) delete cur[key];
      else cur[key]=selType;
      return cur;
    });
  };

  const getAbsence=(empIdx,day)=>absences[selClient+'-'+empIdx+'-'+year+'-'+month+'-'+day];

  // Stats
  const totalAbs=Object.keys(absences).filter(k=>k.startsWith(selClient+'-')).length;
  const byType={};absTypes.forEach(t=>{byType[t.id]=Object.values(absences).filter(v=>v===t.id).length;});

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📅 Planificateur Absences</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Calendrier interactif — Conges, maladies, teletravail</p>
      </div>
      <div style={{display:'flex',gap:6,alignItems:'center'}}>
        <button onClick={()=>{if(month===0){setMonth(11);setYear(y=>y-1);}else setMonth(m=>m-1);}} style={{padding:'6px 12px',borderRadius:6,border:'1px solid rgba(198,163,78,.15)',background:'transparent',color:'#c6a34e',cursor:'pointer',fontFamily:'inherit'}}>◀</button>
        <span style={{fontSize:14,fontWeight:700,color:'#c6a34e',minWidth:140,textAlign:'center'}}>{mois[month]} {year}</span>
        <button onClick={()=>{if(month===11){setMonth(0);setYear(y=>y+1);}else setMonth(m=>m+1);}} style={{padding:'6px 12px',borderRadius:6,border:'1px solid rgba(198,163,78,.15)',background:'transparent',color:'#c6a34e',cursor:'pointer',fontFamily:'inherit'}}>▶</button>
        <select value={selClient} onChange={e=>{setSelClient(+e.target.value);}} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',marginLeft:8}}>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
        </select>
      </div>
    </div>

    {/* Type selector */}
    <div style={{display:'flex',gap:6,marginBottom:12}}>
      {absTypes.map(t=><button key={t.id} onClick={()=>setSelType(t.id)} style={{padding:'6px 12px',borderRadius:8,border:selType===t.id?'2px solid '+t.c:'1px solid rgba(255,255,255,.05)',background:selType===t.id?t.c+'15':'transparent',color:selType===t.id?t.c:'#888',fontSize:11,cursor:'pointer',fontFamily:'inherit',fontWeight:600}}>{t.icon} {t.label} ({byType[t.id]||0})</button>)}
    </div>

    {/* Calendar grid */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      {/* Header row: days */}
      <div style={{display:'grid',gridTemplateColumns:'140px repeat('+days+',1fr)',background:'rgba(198,163,78,.06)'}}>
        <div style={{padding:'8px 12px',fontSize:11,fontWeight:600,color:'#c6a34e'}}>Employé</div>
        {Array.from({length:days},(_,i)=>{
          const d=i+1;
          const we=isWeekend(d);
          const hol=isHoliday(d);
          return <div key={i} style={{padding:'4px 0',textAlign:'center',fontSize:9,color:hol?'#ef4444':we?'#555':'#888',fontWeight:hol?700:400,background:we?'rgba(0,0,0,.15)':'transparent'}}>
            <div>{jours[new Date(year,month,d).getDay()===0?6:new Date(year,month,d).getDay()-1]}</div>
            <div style={{fontSize:11,fontWeight:600}}>{d}</div>
          </div>;
        })}
      </div>
      {/* Employee rows */}
      <div style={{maxHeight:400,overflowY:'auto'}}>
        {emps.map((e,ei)=><div key={ei} style={{display:'grid',gridTemplateColumns:'140px repeat('+days+',1fr)',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <div style={{padding:'6px 12px',fontSize:10,color:'#e5e5e5',fontWeight:500,display:'flex',alignItems:'center'}}>{(e.first||'')[0]}.{e.last||''}</div>
          {Array.from({length:days},(_,i)=>{
            const d=i+1;
            const abs=getAbsence(ei,d);
            const we=isWeekend(d);
            const hol=isHoliday(d);
            const at=abs?absTypes.find(t=>t.id===abs):null;
            return <div key={i} onClick={()=>!we&&!hol&&toggleAbsence(ei,d)} style={{height:28,display:'flex',alignItems:'center',justifyContent:'center',cursor:we||hol?'default':'pointer',background:hol?'rgba(239,68,68,.06)':we?'rgba(0,0,0,.15)':abs?at.c+'15':'transparent',borderRight:'1px solid rgba(255,255,255,.02)',fontSize:11,transition:'all .1s'}}>
              {abs&&<span title={at?.label}>{at?.icon}</span>}
              {hol&&!abs&&<span style={{fontSize:8,color:'#ef4444'}}>F</span>}
            </div>;
          })}
        </div>)}
      </div>
    </div>

    {/* Summary */}
    <div style={{display:'grid',gridTemplateColumns:'repeat('+absTypes.length+',1fr)',gap:8,marginTop:12}}>
      {absTypes.map(t=><div key={t.id} style={{padding:8,borderRadius:8,background:t.c+'08',border:'1px solid '+t.c+'15',textAlign:'center'}}>
        <div style={{fontSize:16,fontWeight:700,color:t.c}}>{byType[t.id]||0}</div>
        <div style={{fontSize:9,color:'#888'}}>{t.icon} {t.label}</div>
      </div>)}
    </div>
  </div>;
};

// ═══ 2. TABLEAU DE BORD RH — Vue consolidee ═══
const DashboardRH=({s})=>{
  const clients=s.clients||[];
  const now=new Date();
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const allEmps=clients.reduce((a,c)=>[...a,...(c.emps||[]).map(e=>({...e,client:c.company?.name||''}))],[]);
  const totalBrut=allEmps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);

  // Demographics
  const contracts={CDI:0,CDD:0,other:0};
  allEmps.forEach(e=>{const t=e.contractType||'CDI';if(contracts[t]!==undefined)contracts[t]++;else contracts.other++;});
  
  // Seniority buckets
  const seniority=[{l:'<1 an',c:0},{l:'1-3 ans',c:0},{l:'3-5 ans',c:0},{l:'5-10 ans',c:0},{l:'10+ ans',c:0}];
  allEmps.forEach(e=>{
    const start=new Date(e.startDate||e.start||'2023-01-01');
    const yrs=(now-start)/31536000000;
    if(yrs<1) seniority[0].c++;
    else if(yrs<3) seniority[1].c++;
    else if(yrs<5) seniority[2].c++;
    else if(yrs<10) seniority[3].c++;
    else seniority[4].c++;
  });

  // Upcoming events
  const events=[];
  allEmps.forEach(e=>{
    const name=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
    if((e.contractType||'')==='CDD'){
      const end=new Date(e.endDate||e.end||'2099-12-31');
      const d=Math.ceil((end-now)/86400000);
      if(d<=90&&d>-30) events.push({name,event:'Fin CDD',days:d,c:d<0?'#ef4444':d<30?'#eab308':'#3b82f6',client:e.client});
    }
    const start=new Date(e.startDate||e.start||'2020-01-01');
    const monthsIn=Math.round((now-start)/2592000000);
    if(monthsIn>=5&&monthsIn<=7) events.push({name,event:'Fin essai',days:180-Math.ceil((now-start)/86400000),c:'#a855f7',client:e.client});
    // Anniversary
    if(start.getMonth()===now.getMonth()&&(now.getFullYear()-start.getFullYear())>0){
      events.push({name,event:'Anniversaire '+(now.getFullYear()-start.getFullYear())+' an(s)',days:start.getDate()-now.getDate(),c:'#c6a34e',client:e.client});
    }
  });
  events.sort((a,b)=>a.days-b.days);

  // Alerts
  const noNISS=allEmps.filter(e=>!e.niss&&!e.NISS).length;
  const noIBAN=allEmps.filter(e=>!e.iban&&!e.IBAN).length;
  const noEmail=allEmps.filter(e=>!e.email).length;
  const noSalary=allEmps.filter(e=>+(e.monthlySalary||e.gross||0)<=0).length;

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>👥 Dashboard RH</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Vue consolidee des ressources humaines</p>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Total employes',v:allEmps.length,c:'#c6a34e'},{l:'CDI',v:contracts.CDI,c:'#22c55e'},{l:'CDD',v:contracts.CDD,c:'#eab308'},{l:'Masse brute',v:f2(totalBrut)+'E',c:'#e5e5e5'},{l:'Cout annuel',v:f2(totalBrut*(1+TX_ONSS_E)*12)+'E',c:'#ef4444'},{l:'Salaire moy.',v:f2(allEmps.length>0?totalBrut/allEmps.length:0)+'E',c:'#3b82f6'}].map((k,i)=>
        <div key={i} style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
          <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:14,marginBottom:14}}>
      {/* Seniority */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>📊 Anciennete</div>
        {seniority.map((s,i)=>{const max=Math.max(...seniority.map(x=>x.c),1);return <div key={i} style={{marginBottom:6}}>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:10,marginBottom:2}}>
            <span style={{color:'#888'}}>{s.l}</span><span style={{color:'#e5e5e5',fontWeight:600}}>{s.c}</span>
          </div>
          <div style={{height:6,background:'rgba(255,255,255,.05)',borderRadius:3,overflow:'hidden'}}>
            <div style={{height:'100%',width:(s.c/max*100)+'%',background:'linear-gradient(90deg,#c6a34e,#a07d3e)',borderRadius:3}}/>
          </div>
        </div>;})}
      </div>

      {/* Upcoming events */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#3b82f6',marginBottom:10}}>📅 Evenements a venir</div>
        {events.length===0?<div style={{color:'#888',fontSize:11,padding:10}}>Aucun evenement</div>:
        events.slice(0,8).map((e,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'5px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:10}}>
          <div><span style={{color:'#e5e5e5',fontWeight:500}}>{e.name}</span><br/><span style={{color:'#888',fontSize:9}}>{e.event} — {e.client}</span></div>
          <span style={{color:e.c,fontWeight:600,fontSize:11}}>{e.days>=0?'J-'+e.days:'J+'+Math.abs(e.days)}</span>
        </div>)}
      </div>

      {/* Data quality */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#ef4444',marginBottom:10}}>⚠ Qualite donnees</div>
        {[{l:'Sans NISS',v:noNISS,t:allEmps.length},{l:'Sans IBAN',v:noIBAN,t:allEmps.length},{l:'Sans email',v:noEmail,t:allEmps.length},{l:'Sans salaire',v:noSalary,t:allEmps.length}].map((q,i)=>
          <div key={i} style={{marginBottom:8}}>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:10,marginBottom:2}}>
              <span style={{color:q.v>0?'#ef4444':'#22c55e'}}>{q.v>0?'❌':'✅'} {q.l}</span>
              <span style={{color:'#888'}}>{q.v}/{q.t}</span>
            </div>
            <div style={{height:4,background:'rgba(255,255,255,.05)',borderRadius:2,overflow:'hidden'}}>
              <div style={{height:'100%',width:(q.t>0?((q.t-q.v)/q.t*100):100)+'%',background:q.v>0?'#eab308':'#22c55e',borderRadius:2}}/>
            </div>
          </div>
        )}
        <div style={{marginTop:8,fontSize:10,color:'#888'}}>Completude: <span style={{color:'#c6a34e',fontWeight:700}}>{allEmps.length>0?Math.round(((allEmps.length*4-noNISS-noIBAN-noEmail-noSalary)/(allEmps.length*4))*100):100}%</span></div>
      </div>
    </div>

    {/* Per-client breakdown */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>🏢 Par client</div>
      <div style={{display:'grid',gridTemplateColumns:'180px 80px 80px 100px 100px 100px 1fr',padding:'6px 12px',background:'rgba(198,163,78,.03)',fontSize:9,color:'#888',fontWeight:600}}>
        <div>Client</div><div>Employés</div><div>CDI/CDD</div><div>Masse brute</div><div>Cout/mois</div><div>Cout/an</div><div>Score</div>
      </div>
      {clients.map((cl,i)=>{
        const e=cl.emps||[];
        const b=e.reduce((a,x)=>a+(+(x.monthlySalary||x.gross||0)),0);
        const cd=e.filter(x=>(x.contractType||'CDI')==='CDI').length;
        let sc=100;e.forEach(x=>{if(!x.niss&&!x.NISS)sc-=5;if(!x.iban&&!x.IBAN)sc-=5;if(+(x.monthlySalary||x.gross||0)<=0)sc-=10;});sc=Math.max(0,sc);
        return <div key={i} style={{display:'grid',gridTemplateColumns:'180px 80px 80px 100px 100px 100px 1fr',padding:'8px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
          <div style={{color:'#e5e5e5',fontWeight:500}}>{cl.company?.name||'Client'}</div>
          <div style={{color:'#3b82f6'}}>{e.length}</div>
          <div style={{color:'#888'}}>{cd}/{e.length-cd}</div>
          <div style={{color:'#c6a34e'}}>{f2(b)}</div>
          <div style={{color:'#ef4444'}}>{f2(b*(1+TX_ONSS_E))}</div>
          <div style={{color:'#ef4444'}}>{f2(b*(1+TX_ONSS_E)*12)}</div>
          <div style={{color:sc>=80?'#22c55e':sc>=60?'#eab308':'#ef4444',fontWeight:700}}>{sc}%</div>
        </div>;
      })}
    </div>
  </div>;
};

// ═══ 3. BUDGET PREVISIONNEL — Projection 12 mois ═══
const BudgetPrev=({s})=>{
  const clients=s.clients||[];
  const [growthRate,setGrowthRate]=useState(2);
  const [newHires,setNewHires]=useState(0);
  const [avgNewSalary,setAvgNewSalary]=useState(3500);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const mois=['Jan','Fev','Mar','Avr','Mai','Jun','Jul','Aou','Sep','Oct','Nov','Dec'];

  const totalEmps=clients.reduce((a,c)=>a+(c.emps||[]).length,0);
  const totalBrut=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+(+(e.monthlySalary||e.gross||0)),0),0);
  const now=new Date();

  // Project 12 months
  const projection=Array.from({length:12},(_,i)=>{
    const d=new Date();d.setMonth(d.getMonth()+i);
    const monthGrowth=1+(growthRate/100/12*i);
    const extraEmps=Math.floor(newHires*i/12);
    const brutBase=totalBrut*monthGrowth;
    const brutNew=extraEmps*avgNewSalary;
    const brut=brutBase+brutNew;
    const onss=brut*(TX_ONSS_W+TX_ONSS_E);
    const net=brut*NET_FACTOR;
    const cout=brut*(1+TX_ONSS_E);
    const emps=totalEmps+extraEmps;
    return {label:mois[d.getMonth()]+' '+d.getFullYear(),brut:Math.round(brut),net:Math.round(net),cout:Math.round(cout),onss:Math.round(onss),emps};
  });

  const totalCoutAn=projection.reduce((a,p)=>a+p.cout,0);
  const totalBrutAn=projection.reduce((a,p)=>a+p.brut,0);
  const maxCout=Math.max(...projection.map(p=>p.cout));

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>💰 Budget Previsionnel</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Projection sur 12 mois — Masse salariale et cout employeur</p>

    <div style={{display:'grid',gridTemplateColumns:'300px 1fr',gap:16}}>
      {/* Config */}
      <div>
        <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14,marginBottom:14}}>
          <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Hypotheses</div>
          <div style={{marginBottom:8}}>
            <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Croissance salariale annuelle (%)</label>
            <input type="range" min="0" max="10" step="0.5" value={growthRate} onChange={e=>setGrowthRate(+e.target.value)} style={{width:'100%'}}/>
            <div style={{textAlign:'center',fontSize:14,fontWeight:700,color:'#c6a34e'}}>+{growthRate}%</div>
          </div>
          <div style={{marginBottom:8}}>
            <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Nouvelles embauches sur 12 mois</label>
            <input type="number" value={newHires} onChange={e=>setNewHires(+e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:14,fontWeight:700,fontFamily:'inherit',textAlign:'center'}}/>
          </div>
          {newHires>0&&<div style={{marginBottom:8}}>
            <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Salaire moyen nouveaux (EUR)</label>
            <input type="number" value={avgNewSalary} onChange={e=>setAvgNewSalary(+e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',textAlign:'center'}}/>
          </div>}
        </div>
        <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:13,fontWeight:600,color:'#ef4444',marginBottom:10}}>Projections annuelles</div>
          {[{l:'Cout annuel total',v:f2(totalCoutAn)+' EUR',c:'#ef4444'},{l:'Masse brute annuelle',v:f2(totalBrutAn)+' EUR',c:'#c6a34e'},{l:'Effectif fin periode',v:projection[11].emps+' employes',c:'#3b82f6'},{l:'Variation cout',v:(totalCoutAn>totalBrut*(1+TX_ONSS_E)*12?'+':'')+f2(totalCoutAn-totalBrut*(1+TX_ONSS_E)*12)+' EUR',c:totalCoutAn>totalBrut*(1+TX_ONSS_E)*12?'#ef4444':'#22c55e'}].map((k,i)=>
            <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
              <span style={{color:'#888'}}>{k.l}</span><span style={{color:k.c,fontWeight:700}}>{k.v}</span>
            </div>
          )}
        </div>
      </div>

      {/* Chart + table */}
      <div>
        <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14,marginBottom:14}}>
          <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Projection mensuelle</div>
          <div style={{display:'flex',alignItems:'flex-end',gap:3,height:140}}>
            {projection.map((p,i)=><div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:2}}>
              <div style={{fontSize:7,color:'#888'}}>{f2(p.cout)}</div>
              <div style={{width:'100%',height:maxCout>0?(p.cout/maxCout*120)+'px':'4px',background:'linear-gradient(180deg,#ef4444,rgba(198,163,78,.4))',borderRadius:'3px 3px 0 0',position:'relative'}}>
                <div style={{position:'absolute',bottom:0,width:'100%',height:maxCout>0?(p.brut/maxCout*120)+'px':'2px',background:'rgba(198,163,78,.6)',borderRadius:'2px 2px 0 0'}}>
                  <div style={{position:'absolute',bottom:0,width:'100%',height:maxCout>0?(p.net/maxCout*120)+'px':'1px',background:'rgba(34,197,94,.6)',borderRadius:'1px 1px 0 0'}}/>
                </div>
              </div>
              <div style={{fontSize:8,color:'#888'}}>{p.label}</div>
            </div>)}
          </div>
        </div>
        <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
          <div style={{display:'grid',gridTemplateColumns:'100px 60px 90px 90px 90px 90px',padding:'6px 12px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#888'}}>
            <div>Mois</div><div>Effectif</div><div>Brut</div><div>ONSS</div><div>Net</div><div>Coût total</div>
          </div>
          {projection.map((p,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'100px 60px 90px 90px 90px 90px',padding:'5px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:10}}>
            <div style={{color:'#c6a34e',fontWeight:500}}>{p.label}</div>
            <div style={{color:'#3b82f6'}}>{p.emps}</div>
            <div style={{color:'#e5e5e5'}}>{f2(p.brut)}</div>
            <div style={{color:'#a855f7'}}>{f2(p.onss)}</div>
            <div style={{color:'#22c55e'}}>{f2(p.net)}</div>
            <div style={{color:'#ef4444',fontWeight:600}}>{f2(p.cout)}</div>
          </div>)}
        </div>
      </div>
    </div>
  </div>;
};

// ═══ 4. ECHEANCIER PAIEMENTS — Tout ce qui est du ═══
const Echeancier=({s})=>{
  const clients=s.clients||[];
  const now=new Date();
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const month=now.getMonth();const year=now.getFullYear();
  const totalBrut=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+(+(e.monthlySalary||e.gross||0)),0),0);

  const echeances=[
    {day:5,label:'ONSS provisoire',amount:Math.round(totalBrut*(TX_ONSS_W+TX_ONSS_E)),cat:'ONSS',icon:'🏛',dest:'ONSS via portail securite sociale'},
    {day:15,label:'Précompte professionnel',amount:emps.reduce((a,e)=>a+quickPP(+(e.monthlySalary||e.gross||0)),0),cat:'Fiscal',icon:'💰',dest:'SPF Finances via Finprof'},
    {day:20,label:'Cheques-repas',amount:Math.round(clients.reduce((a,c)=>a+(c.emps||[]).length,0)*8*22*0.83),cat:'Avantages',icon:'🍽',dest:'Sodexo/Edenred'},
    {day:25,label:'Virements salaires SEPA',amount:Math.round(totalBrut*NET_FACTOR),cat:'Paie',icon:'💳',dest:'Banque via fichier SEPA'},
    {day:28,label:'Distribution fiches de paie',amount:0,cat:'Admin',icon:'📄',dest:'Email / portail employe'},
  ];

  // Quarterly
  if([0,3,6,9].includes(month)){
    echeances.push({day:10,label:'DmfA trimestrielle T'+Math.ceil((month+1)/3),amount:Math.round(totalBrut*3*(TX_ONSS_W+TX_ONSS_E)),cat:'ONSS',icon:'🏛',dest:'Portail ONSS',quarterly:true});
  }

  echeances.sort((a,b)=>a.day-b.day);

  const totalDue=echeances.reduce((a,e)=>a+e.amount,0);
  const pastDue=echeances.filter(e=>e.day<now.getDate());
  const upcoming=echeances.filter(e=>e.day>=now.getDate());

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📆 Echeancier Paiements</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>{mois[month]} {year} — Toutes les echeances du mois</p>

    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:16}}>
      {[{l:'Total du ce mois',v:f2(totalDue)+' EUR',c:'#c6a34e'},{l:'Paye',v:f2(pastDue.reduce((a,e)=>a+e.amount,0))+' EUR',c:'#22c55e'},{l:'A venir',v:f2(upcoming.reduce((a,e)=>a+e.amount,0))+' EUR',c:'#eab308'},{l:'Echeances restantes',v:upcoming.length,c:'#3b82f6'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
        </div>
      )}
    </div>

    {/* Timeline */}
    <div style={{display:'flex',flexDirection:'column',gap:6}}>
      {echeances.map((e,i)=>{
        const past=e.day<now.getDate();
        const today=e.day===now.getDate();
        return <div key={i} style={{display:'flex',alignItems:'center',gap:14,padding:'14px 18px',background:today?'rgba(198,163,78,.06)':past?'rgba(34,197,94,.03)':'rgba(255,255,255,.01)',border:'1px solid '+(today?'rgba(198,163,78,.2)':past?'rgba(34,197,94,.1)':'rgba(255,255,255,.05)'),borderRadius:12}}>
          <div style={{width:40,textAlign:'center'}}>
            <div style={{fontSize:20,fontWeight:800,color:past?'#22c55e':today?'#c6a34e':'#e5e5e5'}}>{e.day}</div>
            <div style={{fontSize:8,color:'#888'}}>{mois[month].substring(0,3)}</div>
          </div>
          <div style={{fontSize:20}}>{e.icon}</div>
          <div style={{flex:1}}>
            <div style={{fontSize:13,fontWeight:600,color:past?'#888':'#e5e5e5'}}>{e.label}{e.quarterly?' (trimestriel)':''}</div>
            <div style={{fontSize:10,color:'#888'}}>{e.dest}</div>
          </div>
          {e.amount>0&&<div style={{fontSize:16,fontWeight:700,color:past?'#22c55e':'#c6a34e'}}>{f2(e.amount)} EUR</div>}
          <div style={{padding:'4px 10px',borderRadius:6,background:past?'rgba(34,197,94,.1)':today?'rgba(198,163,78,.1)':'rgba(255,255,255,.05)',color:past?'#22c55e':today?'#c6a34e':'#888',fontSize:10,fontWeight:600}}>
            {past?'✅ Paye':today?'📌 Aujourd hui':'⏳ J-'+(e.day-now.getDate())}
          </div>
        </div>;
      })}
    </div>
  </div>;
};

const GedDocuments=({s,d})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const [selEmp,setSelEmp]=useState(null);
  const [search,setSearch]=useState('');
  const [genType,setGenType]=useState(null);
  const now=new Date();

  const docTypes=[
    {id:'contrat',icon:'📝',label:'Contrat de travail',auto:true,obligatoire:true},
    {id:'avenant',icon:'📝',label:'Avenant au contrat',auto:true},
    {id:'fiche_paie',icon:'📄',label:'Fiche de paie',auto:true,obligatoire:true},
    {id:'c4',icon:'📄',label:'Certificat C4',auto:true},
    {id:'attestation',icon:'📄',label:'Attestation emploi',auto:true},
    {id:'solde',icon:'💰',label:'Solde de tout compte',auto:true},
    {id:'dimona',icon:'📋',label:'Declaration Dimona',auto:true},
    {id:'identite',icon:'🪪',label:'Carte identite',auto:false},
    {id:'iban',icon:'🏦',label:'Coordonnees bancaires',auto:true},
    {id:'medical',icon:'🏥',label:'Certificat medical',auto:false},
    {id:'diplome',icon:'🎓',label:'Diplome / Certificat',auto:false},
    {id:'permis',icon:'🚗',label:'Permis de conduire',auto:false},
    {id:'sejour',icon:'🛂',label:'Titre de sejour',auto:false},
    {id:'reglement',icon:'📖',label:'Reglement de travail',auto:false,obligatoire:true},
  ];

  const cl=clients[selClient]||{emps:[]};
  const emps=cl.emps||[];
  const emp=selEmp!==null?emps[selEmp]:null;

  // Generate document inventory per employee
  const getEmpDocs=(e)=>{
    const docs=[];
    const name=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
    // Auto-detect existing docs
    if(e.startDate||e.start) docs.push({type:'contrat',date:e.startDate||e.start,status:'ok',name:'Contrat '+( e.contractType||'CDI')});
    if(e.niss||e.NISS) docs.push({type:'identite',date:'-',status:'ok',name:'NISS renseigne'});
    if(e.iban||e.IBAN) docs.push({type:'iban',date:'-',status:'ok',name:'IBAN renseigne'});
    if(e.dimonaDone) docs.push({type:'dimona',date:e.startDate,status:'ok',name:'Dimona IN'});
    // Check missing obligatory
    docTypes.filter(d=>d.obligatoire).forEach(dt=>{
      if(!docs.find(d=>d.type===dt.id)){
        docs.push({type:dt.id,date:null,status:'missing',name:dt.label+' — MANQUANT'});
      }
    });
    // Add payslip history
    const pays=(cl.pays||[]).filter(p=>(p.ename||'').includes(name.split(' ')[0]));
    pays.forEach(p=>docs.push({type:'fiche_paie',date:p.generated||'',status:'ok',name:'Fiche '+( p.period||'')}));
    return docs;
  };

  const filteredEmps=emps.filter(e=>{
    if(!search) return true;
    const name=((e.first||e.fn||'')+' '+(e.last||e.ln||'')).toLowerCase();
    return name.includes(search.toLowerCase());
  });

  const empDocs=emp?getEmpDocs(emp):[];
  const totalDocs=emps.reduce((a,e)=>a+getEmpDocs(e).length,0);
  const missingDocs=emps.reduce((a,e)=>a+getEmpDocs(e).filter(d=>d.status==='missing').length,0);

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📁 GED — Documents</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Gestion electronique des documents employes</p>
      </div>
      <div style={{display:'flex',gap:8}}>
        <select value={selClient} onChange={e=>{setSelClient(+e.target.value);setSelEmp(null);}} style={{padding:'8px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name||'Client '+(i+1)}</option>)}
        </select>
      </div>
    </div>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Employes',v:emps.length,c:'#c6a34e',i:'👥'},{l:'Documents',v:totalDocs,c:'#3b82f6',i:'📄'},{l:'Manquants',v:missingDocs,c:'#ef4444',i:'❌'},{l:'Completude',v:totalDocs>0?Math.round((totalDocs-missingDocs)/totalDocs*100)+'%':'N/A',c:'#22c55e',i:'✅'}].map((k,i)=>
        <div key={i} style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.i} {k.l}</div>
          <div style={{fontSize:20,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'280px 1fr',gap:16}}>
      {/* Employee list */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'8px 12px',background:'rgba(198,163,78,.06)'}}>
          <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Rechercher..." style={{width:'100%',padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.1)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/>
        </div>
        <div style={{maxHeight:500,overflowY:'auto'}}>
          {filteredEmps.map((e,i)=>{
            const docs=getEmpDocs(e);
            const missing=docs.filter(d=>d.status==='missing').length;
            const idx=emps.indexOf(e);
            return <div key={i} onClick={()=>setSelEmp(idx)} style={{padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',cursor:'pointer',background:selEmp===idx?'rgba(198,163,78,.06)':'transparent'}}>
              <div style={{fontSize:12,fontWeight:selEmp===idx?600:400,color:selEmp===idx?'#c6a34e':'#e5e5e5'}}>{(e.first||e.fn||'')+' '+(e.last||e.ln||'')}</div>
              <div style={{display:'flex',justifyContent:'space-between',fontSize:9,marginTop:2}}>
                <span style={{color:'#888'}}>{docs.length} docs</span>
                {missing>0&&<span style={{color:'#ef4444',fontWeight:600}}>{missing} manquant(s)</span>}
                {missing===0&&<span style={{color:'#22c55e'}}>Complet</span>}
              </div>
            </div>;
          })}
        </div>
      </div>

      {/* Document view */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        {!emp?<div style={{padding:60,textAlign:'center',color:'#888'}}>
          <div style={{fontSize:40,marginBottom:10}}>📁</div>
          <div style={{fontSize:14}}>Selectionnez un employe</div>
        </div>:
        <div>
          <div style={{padding:'12px 16px',background:'rgba(198,163,78,.06)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <span style={{fontSize:13,fontWeight:600,color:'#c6a34e'}}>📁 {(emp.first||'')+' '+(emp.last||'')} — {empDocs.length} documents</span>
            <div style={{display:'flex',gap:4}}>
              {docTypes.filter(d=>d.auto).slice(0,4).map(dt=><button key={dt.id} onClick={()=>{
                try{
                  if(dt.id==='contrat') generateDocHTML&&previewHTML(generateDocHTML({name:(emp.first||'')+' '+(emp.last||''),niss:emp.niss,contractType:emp.contractType||'CDI',fonction:emp.function||'Employé',startDate:emp.startDate,brut:+(emp.monthlySalary||0),whWeek:emp.whWeek||38,company:cl.company},'contrat_travail'),'Contrat');
                  else if(dt.id==='attestation') generateAttestationEmploi(emp,cl.company||{});
                  else if(dt.id==='fiche_paie'){const brut=+(emp.monthlySalary||emp.gross||0);const o=Math.round(brut*TX_ONSS_W*100)/100;const imp=brut-o;const pp=quickPP(brut);const net=Math.round((imp-pp)*100)/100;generatePayslipPDF(emp,{gross:brut,onssP:o,imposable:imp,pp,net,onssE:Math.round(brut*TX_ONSS_E*100)/100,coutTotal:Math.round(brut*(1+TX_ONSS_E)*100)/100},{month:new Date().getMonth()+1,year:new Date().getFullYear()},cl.company||{});}
                }catch(ex){}
              }} style={{padding:'4px 8px',borderRadius:4,border:'none',background:'rgba(198,163,78,.08)',color:'#c6a34e',fontSize:9,cursor:'pointer',fontFamily:'inherit'}}>{dt.icon} {dt.label.split(' ')[0]}</button>)}
            </div>
          </div>
          <div style={{maxHeight:460,overflowY:'auto'}}>
            {empDocs.map((doc,i)=>{
              const dt=docTypes.find(d=>d.id===doc.type);
              return <div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',background:doc.status==='missing'?'rgba(239,68,68,.03)':'transparent'}}>
                <div style={{fontSize:16}}>{dt?.icon||'📄'}</div>
                <div style={{flex:1}}>
                  <div style={{fontSize:11,fontWeight:500,color:doc.status==='missing'?'#ef4444':'#e5e5e5'}}>{doc.name}</div>
                  {doc.date&&<div style={{fontSize:9,color:'#888'}}>{doc.date}</div>}
                </div>
                <span style={{fontSize:9,padding:'2px 6px',borderRadius:4,background:doc.status==='ok'?'rgba(34,197,94,.1)':'rgba(239,68,68,.1)',color:doc.status==='ok'?'#22c55e':'#ef4444',fontWeight:600}}>{doc.status==='ok'?'OK':'MANQUANT'}</span>
              </div>;
            })}
          </div>
        </div>}
      </div>
    </div>
  </div>;
};

// ═══ 2. PORTAIL EMPLOYE (preview mode) ═══
const PortailEmploye=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const [selEmp,setSelEmp]=useState(0);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];

  const cl=clients[selClient]||{emps:[]};
  const emp=(cl.emps||[])[selEmp];
  if(!emp) return <div style={{padding:24,textAlign:'center',color:'#888'}}>Aucun employé. Ajoutez des clients d abord.</div>;

  const name=(emp.first||emp.fn||'')+' '+(emp.last||emp.ln||'');
  const brut=+(emp.monthlySalary||emp.gross||0);
  const onss=Math.round(brut*TX_ONSS_W*100)/100;
  const imp=brut-onss;
  const pp=quickPP(brut);
  const net=Math.round((imp-pp)*100)/100;
  const anciennete=emp.startDate?Math.round((new Date()-new Date(emp.startDate))/2592000000):0;
  const congesRestants=20-Math.min(20,Math.floor(Math.random()*8));

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
      <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>👤 Portail Employe</h2>
      <div style={{display:'flex',gap:6}}>
        <select value={selClient} onChange={e=>{setSelClient(+e.target.value);setSelEmp(0);}} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:10,fontFamily:'inherit'}}>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
        </select>
        <select value={selEmp} onChange={e=>setSelEmp(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:10,fontFamily:'inherit'}}>
          {(cl.emps||[]).map((e,i)=><option key={i} value={i}>{(e.first||'')+' '+(e.last||'')}</option>)}
        </select>
        <div style={{padding:'6px 12px',borderRadius:6,background:'rgba(234,179,8,.1)',border:'1px solid rgba(234,179,8,.2)',color:'#eab308',fontSize:10,fontWeight:600}}>MODE PREVIEW</div>
      </div>
    </div>
    <p style={{fontSize:11,color:'#888',margin:'0 0 20px'}}>Ce que voit l employe quand il se connecte a son espace</p>

    {/* Welcome */}
    <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:16,marginBottom:16}}>
      <div style={{display:'flex',alignItems:'center',gap:14}}>
        <div style={{width:52,height:52,borderRadius:26,background:'linear-gradient(135deg,#c6a34e,#a07d3e)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:22,color:'#060810',fontWeight:800}}>{(emp.first||'?')[0]}{(emp.last||'?')[0]}</div>
        <div>
          <div style={{fontSize:18,fontWeight:700,color:'#e5e5e5'}}>Bonjour, {emp.first||name} 👋</div>
          <div style={{fontSize:11,color:'#888'}}>{emp.function||emp.job||'Employé'} — {cl.company?.name} — {emp.contractType||'CDI'}</div>
        </div>
      </div>
    </div>

    {/* Quick KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Net mensuel',v:f2(net)+' EUR',c:'#22c55e',i:'💵'},{l:'Anciennete',v:anciennete+' mois',c:'#3b82f6',i:'📅'},{l:'Conges restants',v:congesRestants+' jours',c:'#c6a34e',i:'🏖'},{l:'Prochain salaire',v:'25/'+((new Date().getMonth()+1)+'').padStart(2,'0'),c:'#a855f7',i:'💳'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.i} {k.l}</div>
          <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14}}>
      {/* Last payslip */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>📄 Derniere fiche de paie</div>
        {[{l:'Brut mensuel',v:f2(brut)+' EUR'},{l:'ONSS (-13,07%)',v:'-'+f2(onss)+' EUR'},{l:'Imposable',v:f2(imp)+' EUR'},{l:'Precompte prof.',v:'-'+f2(pp)+' EUR'}].map((r,i)=>
          <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'4px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
            <span style={{color:'#888'}}>{r.l}</span><span style={{color:'#e5e5e5'}}>{r.v}</span>
          </div>
        )}
        <div style={{display:'flex',justifyContent:'space-between',padding:'8px 0',fontSize:14,fontWeight:700}}>
          <span style={{color:'#e5e5e5'}}>NET A PAYER</span><span style={{color:'#22c55e'}}>{f2(net)} EUR</span>
        </div>
        <button onClick={()=>{try{generatePayslipPDF(emp,{gross:brut,onssP:onss,imposable:imp,pp,net,onssE:Math.round(brut*TX_ONSS_E*100)/100,coutTotal:Math.round(brut*(1+TX_ONSS_E)*100)/100},{month:new Date().getMonth()+1,year:new Date().getFullYear()},cl.company||{});}catch(e){}}} style={{width:'100%',marginTop:8,padding:'10px',borderRadius:8,border:'none',background:'rgba(198,163,78,.08)',color:'#c6a34e',fontSize:12,fontWeight:600,cursor:'pointer'}}>📥 Telecharger ma fiche</button>
      </div>

      {/* Personal info */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:13,fontWeight:600,color:'#3b82f6',marginBottom:10}}>👤 Mes informations</div>
        {[{l:'Nom complet',v:name},{l:'NISS',v:emp.niss||emp.NISS||'Non renseigne'},{l:'Email',v:emp.email||'Non renseigne'},{l:'IBAN',v:emp.iban||emp.IBAN||'Non renseigne'},{l:'Contrat',v:(emp.contractType||'CDI')+' — '+(emp.whWeek||38)+'h/sem'},{l:'Debut',v:emp.startDate||emp.start||'N/A'},{l:'Fonction',v:emp.function||emp.job||'Employé'},{l:'Commission paritaire',v:cl.company?.cp||'CP 200'}].map((r,i)=>
          <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'4px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
            <span style={{color:'#888'}}>{r.l}</span><span style={{color:'#e5e5e5',fontWeight:500}}>{r.v}</span>
          </div>
        )}
      </div>
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:14,marginTop:14}}>
      {/* Payslip history */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>📋 Historique fiches</div>
        {Array.from({length:6},(_, i)=>{const d=new Date();d.setMonth(d.getMonth()-i);return <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'5px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:10}}>
          <span style={{color:'#888'}}>{mois[d.getMonth()]} {d.getFullYear()}</span>
          <span style={{color:'#22c55e',fontWeight:600}}>{f2(net*(0.97+Math.random()*0.06))} EUR</span>
        </div>;})}
      </div>

      {/* Documents */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#3b82f6',marginBottom:8}}>📁 Mes documents</div>
        {[{n:'Contrat de travail',d:emp.startDate||'',i:'📝'},{n:'Reglement de travail',d:'-',i:'📖'},{n:'Attestation emploi',d:'A generer',i:'📄'}].map((doc,i)=>
          <div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:10}}>
            <span>{doc.i}</span><span style={{flex:1,color:'#e5e5e5'}}>{doc.n}</span><span style={{color:'#888'}}>{doc.d}</span>
          </div>
        )}
      </div>

      {/* Conges */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#22c55e',marginBottom:8}}>🏖 Mes conges</div>
        <div style={{textAlign:'center',marginBottom:10}}>
          <div style={{fontSize:32,fontWeight:800,color:'#22c55e'}}>{congesRestants}</div>
          <div style={{fontSize:10,color:'#888'}}>jours restants sur 20</div>
        </div>
        <div style={{height:8,background:'rgba(255,255,255,.05)',borderRadius:4,overflow:'hidden'}}>
          <div style={{height:'100%',width:(congesRestants/20*100)+'%',background:'#22c55e',borderRadius:4}}/>
        </div>
      </div>
    </div>
  </div>;
};

// ═══ 3. DASHBOARD CLIENT — Vue par client ═══
const DashboardClient=({s,d,userRole,user})=>{
  const isCommercial=userRole==='commercial';
  const _userEmail=user?.email?.toLowerCase()||'';
  const clients=isCommercial?(s.clients||[]).filter(c=>c.assignedTo?.toLowerCase()===_userEmail):(s.clients||[]);
  const [sel,setSel]=useState(0);
  const [dcTab,setDcTab]=useState('overview');
  const [absMonth,setAbsMonth]=useState(new Date().getMonth()+1);
  const [absYear,setAbsYear]=useState(new Date().getFullYear());
  const [showAbsForm,setShowAbsForm]=useState(false);
  const [absForm,setAbsForm]=useState({empId:'',type:'conge',dateDebut:'',dateFin:'',motif:''});
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const cl=clients[sel]||{emps:[],company:{}};
  const co=cl.company||{};
  const emps=cl.emps||[];
  const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);
  const totalNet=Math.round(totalBrut*NET_FACTOR*100)/100;
  const totalCout=Math.round(totalBrut*(1+TX_ONSS_E)*100)/100;
  const cdi=emps.filter(e=>(e.contractType||'CDI')==='CDI').length;
  const avgBrut=emps.length>0?Math.round(totalBrut/emps.length):0;

  let health=100;
  emps.forEach(e=>{
    if(!e.niss&&!e.NISS) health-=5;
    if(!e.iban&&!e.IBAN) health-=5;
    if(!e.email) health-=3;
    if(+(e.monthlySalary||e.gross||0)<=0) health-=10;
    if(!e.startDate&&!e.start) health-=5;
  });
  health=Math.max(0,Math.min(100,health));

  const absTypesList=[{id:'conge',icon:'🏖',label:'Congé payé',c:'#22c55e'},{id:'maladie',icon:'🤒',label:'Maladie',c:'#ef4444'},{id:'formation',icon:'📚',label:'Formation',c:'#3b82f6'},{id:'teletravail',icon:'🏠',label:'Teletravail',c:'#a855f7'},{id:'recup',icon:'⏰',label:'Recuperation',c:'#eab308'},{id:'sans_solde',icon:'⚪',label:'Sans solde',c:'#888'},{id:'maternite',icon:'🤱',label:'Maternite',c:'#ec4899'},{id:'naissance',icon:'👶',label:'Conge naissance',c:'#06b6d4'}];
  const moisLabels=['','Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const numDays=new Date(absYear,absMonth,0).getDate();

  const doAddAbsence=()=>{
    if(!absForm.empId||!absForm.dateDebut) return;
    const ab={id:'ABS-'+Date.now(),type:absForm.type,dateDebut:absForm.dateDebut,dateFin:absForm.dateFin||absForm.dateDebut,motif:absForm.motif,createdAt:new Date().toISOString(),status:'validee'};
    const uEmps=emps.map(e=>e.id===absForm.empId?{...e,absences:[...(e.absences||[]),ab]}:e);
    const uClients=(s.clients||[]).map(c=>c===cl?{...c,emps:uEmps}:c);
    if(d) d({...s,clients:uClients});
    setAbsForm({empId:'',type:'conge',dateDebut:'',dateFin:'',motif:''});
    setShowAbsForm(false);
  };

  const doDelAbsence=(eId,aId)=>{
    const uEmps=emps.map(e=>e.id===eId?{...e,absences:(e.absences||[]).filter(a=>a.id!==aId)}:e);
    const uClients=(s.clients||[]).map(c=>c===cl?{...c,emps:uEmps}:c);
    if(d) d({...s,clients:uClients});
  };

  const getAbsForDay=(emp2,day)=>{
    const ds=absYear+'-'+String(absMonth).padStart(2,'0')+'-'+String(day).padStart(2,'0');
    return (emp2.absences||[]).find(a=>ds>=a.dateDebut&&ds<=(a.dateFin||a.dateDebut));
  };

  const monthAbs=emps.reduce((a,e)=>[...a,...(e.absences||[]).filter(ab=>{const m=parseInt(ab.dateDebut?.split('-')[1]);const y=parseInt(ab.dateDebut?.split('-')[0]);return m===absMonth&&y===absYear;}).map(ab=>({...ab,empName:(e.first||e.fn||'')+' '+(e.last||e.ln||''),empId:e.id}))],[]);

  const iS={width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',boxSizing:'border-box'};

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🏢 Dashboard Client</h2>
      <select value={sel} onChange={e=>setSel(+e.target.value)} style={{padding:'8px 14px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:13,fontFamily:'inherit',fontWeight:600}}>
        {clients.map((c,i)=><option key={i} value={i}>{c.company?.name||'Client '+(i+1)}</option>)}
      </select>
    </div>

    <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:16,marginBottom:16,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
      <div>
        <div style={{fontSize:20,fontWeight:700,color:'#c6a34e'}}>{co.name||'Client'}</div>
        <div style={{fontSize:11,color:'#888'}}>{co.vat||''} {co.address?'— '+co.address:''} {co.cp?'— CP '+co.cp:''}</div>
      </div>
      <div style={{textAlign:'center'}}>
        <div style={{fontSize:32,fontWeight:800,color:health>=80?'#22c55e':health>=60?'#eab308':'#ef4444'}}>{health}%</div>
        <div style={{fontSize:9,color:'#888'}}>Score sante</div>
      </div>
    </div>

    <div style={{display:'flex',gap:4,marginBottom:16,borderBottom:'1px solid rgba(198,163,78,.1)',paddingBottom:8}}>
      {[{id:'overview',l:'📊 Vue d ensemble'},{id:'absences',l:'📅 Absences ('+monthAbs.length+')'}].map(t=>
        <button key={t.id} onClick={()=>setDcTab(t.id)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:dcTab===t.id?'rgba(198,163,78,.15)':'transparent',color:dcTab===t.id?'#c6a34e':'#888',fontWeight:dcTab===t.id?600:400,fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>{t.l}</button>
      )}
    </div>

    {dcTab==='absences'?<div>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
        <div style={{display:'flex',gap:6,alignItems:'center'}}>
          <button onClick={()=>{setAbsMonth(absMonth===1?12:absMonth-1);if(absMonth===1)setAbsYear(absYear-1);}} style={{padding:'4px 8px',borderRadius:6,border:'1px solid rgba(198,163,78,.15)',background:'transparent',color:'#c6a34e',cursor:'pointer',fontSize:11,fontFamily:'inherit'}}>←</button>
          <span style={{fontSize:14,fontWeight:700,color:'#c6a34e',minWidth:140,textAlign:'center'}}>{moisLabels[absMonth]} {absYear}</span>
          <button onClick={()=>{setAbsMonth(absMonth===12?1:absMonth+1);if(absMonth===12)setAbsYear(absYear+1);}} style={{padding:'4px 8px',borderRadius:6,border:'1px solid rgba(198,163,78,.15)',background:'transparent',color:'#c6a34e',cursor:'pointer',fontSize:11,fontFamily:'inherit'}}>→</button>
        </div>
        <button onClick={()=>setShowAbsForm(!showAbsForm)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>+ Encoder une absence</button>
      </div>

      {showAbsForm&&<div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.2)',borderRadius:12,marginBottom:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Nouvelle absence</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8}}>
          <div>
            <div style={{fontSize:9,color:'#888',marginBottom:3}}>Employe *</div>
            <select value={absForm.empId} onChange={e=>setAbsForm(p=>({...p,empId:e.target.value}))} style={iS}>
              <option value="">Choisir...</option>
              {emps.map(e2=><option key={e2.id} value={e2.id}>{(e2.first||e2.fn||'')+' '+(e2.last||e2.ln||'')}</option>)}
            </select>
          </div>
          <div>
            <div style={{fontSize:9,color:'#888',marginBottom:3}}>Type *</div>
            <select value={absForm.type} onChange={e=>setAbsForm(p=>({...p,type:e.target.value}))} style={iS}>
              {absTypesList.map(t=><option key={t.id} value={t.id}>{t.icon} {t.label}</option>)}
            </select>
          </div>
          <div>
            <div style={{fontSize:9,color:'#888',marginBottom:3}}>Motif</div>
            <input value={absForm.motif} onChange={e=>setAbsForm(p=>({...p,motif:e.target.value}))} placeholder="Optionnel" style={iS}/>
          </div>
          <div>
            <div style={{fontSize:9,color:'#888',marginBottom:3}}>Date debut *</div>
            <input type="date" value={absForm.dateDebut} onChange={e=>setAbsForm(p=>({...p,dateDebut:e.target.value}))} style={iS}/>
          </div>
          <div>
            <div style={{fontSize:9,color:'#888',marginBottom:3}}>Date fin</div>
            <input type="date" value={absForm.dateFin} onChange={e=>setAbsForm(p=>({...p,dateFin:e.target.value}))} style={iS}/>
          </div>
          <div style={{display:'flex',alignItems:'flex-end'}}>
            <button onClick={doAddAbsence} disabled={!absForm.empId||!absForm.dateDebut} style={{width:'100%',padding:'8px',borderRadius:6,border:'none',background:(!absForm.empId||!absForm.dateDebut)?'rgba(198,163,78,.1)':'#22c55e',color:(!absForm.empId||!absForm.dateDebut)?'#555':'#fff',fontWeight:700,fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>✅ Valider</button>
          </div>
        </div>
      </div>}

      <div style={{overflowX:'auto',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}>
        <table style={{width:'100%',borderCollapse:'collapse',fontSize:9}}>
          <thead><tr style={{background:'rgba(198,163,78,.06)'}}>
            <th style={{padding:'8px 6px',textAlign:'left',color:'#c6a34e',fontWeight:600,fontSize:10,minWidth:120,position:'sticky',left:0,background:'#0d1117',zIndex:1}}>Employé</th>
            {Array.from({length:numDays},(_,i)=>{const dow=new Date(absYear,absMonth-1,i+1).getDay();const isWE=dow===0||dow===6;return <th key={i} style={{padding:'4px 2px',textAlign:'center',color:isWE?'#555':'#888',fontWeight:isWE?400:500,fontSize:9,background:isWE?'rgba(255,255,255,.02)':'transparent',minWidth:22}}>{i+1}</th>;})}
            <th style={{padding:'4px 6px',textAlign:'center',color:'#c6a34e',fontWeight:600,fontSize:9}}>Total</th>
          </tr></thead>
          <tbody>
            {emps.map((emp2,idx)=>{let absDays=0;return <tr key={idx} style={{borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <td style={{padding:'6px',fontWeight:500,color:'#e5e5e5',fontSize:10,position:'sticky',left:0,background:'#0d1117',zIndex:1}}>{(emp2.first||emp2.fn||'')} {(emp2.last||emp2.ln||'')}</td>
              {Array.from({length:numDays},(_,i)=>{const day=i+1;const dow=new Date(absYear,absMonth-1,day).getDay();const isWE=dow===0||dow===6;const ab=getAbsForDay(emp2,day);if(ab&&!isWE)absDays++;const at=ab?absTypesList.find(t=>t.id===ab.type):null;return <td key={i} style={{padding:'2px',textAlign:'center',background:isWE?'rgba(255,255,255,.02)':ab?(at?.c||'#888')+'15':'transparent',borderRadius:2}} title={ab?(at?.label||''):''}>{ab?<span style={{fontSize:8}}>{at?.icon||'•'}</span>:isWE?<span style={{color:'#333',fontSize:7}}>·</span>:''}</td>;})}
              <td style={{padding:'4px 6px',textAlign:'center',fontWeight:600,color:absDays>0?'#ef4444':'#22c55e',fontSize:10}}>{absDays}j</td>
            </tr>;})}
          </tbody>
        </table>
      </div>

      <div style={{display:'flex',gap:8,flexWrap:'wrap',marginTop:10}}>
        {absTypesList.map(t=><div key={t.id} style={{display:'flex',alignItems:'center',gap:3,fontSize:9,color:'#888'}}><span>{t.icon}</span><span>{t.label}</span></div>)}
      </div>

      {monthAbs.length>0&&<div style={{marginTop:14,border:'1px solid rgba(198,163,78,.1)',borderRadius:12,overflow:'hidden'}}>
        <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:11,fontWeight:600,color:'#c6a34e'}}>Absences du mois ({monthAbs.length})</div>
        {monthAbs.map((a,i)=>{const at=absTypesList.find(t=>t.id===a.type);return <div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <span style={{fontSize:14}}>{at?.icon||'📅'}</span>
          <div style={{flex:1}}>
            <div style={{fontSize:11,fontWeight:500,color:'#e5e5e5'}}>{a.empName}</div>
            <div style={{fontSize:9,color:'#888'}}>{at?.label} — {a.dateDebut}{a.dateFin&&a.dateFin!==a.dateDebut?' → '+a.dateFin:''}</div>
          </div>
          <span onClick={()=>doDelAbsence(a.empId,a.id)} style={{fontSize:10,color:'#ef4444',cursor:'pointer',padding:'4px 8px',borderRadius:4,background:'rgba(239,68,68,.06)'}}>✕</span>
        </div>;})}
      </div>}

      <div style={{marginTop:14,padding:14,background:'rgba(59,130,246,.04)',border:'1px solid rgba(59,130,246,.1)',borderRadius:12}}>
        <div style={{fontSize:11,fontWeight:600,color:'#3b82f6',marginBottom:6}}>Impact sur la paie</div>
        <div style={{fontSize:10,color:'#888',lineHeight:1.6}}>
          Congé payé : salaire maintenu — Maladie : salaire garanti 30j employe / 7j ouvrier — Sans solde : deduction au prorata — Teletravail : salaire maintenu + indemnite bureau
        </div>
      </div>
    </div>

    :<div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:10,marginBottom:16}}>
        {[{l:'Employes',v:emps.length,c:'#3b82f6'},{l:'CDI',v:cdi,c:'#22c55e'},{l:'CDD',v:emps.length-cdi,c:'#eab308'},{l:'Brut/mois',v:f2(totalBrut),c:'#c6a34e'},{l:'Net/mois',v:f2(totalNet),c:'#22c55e'},{l:'Cout/mois',v:f2(totalCout),c:'#ef4444'}].map((k,i)=>
          <div key={i} style={{padding:10,background:'rgba(198,163,78,.03)',border:'1px solid '+k.c+'15',borderRadius:10,textAlign:'center'}}>
            <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div>
            <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
          </div>
        )}
      </div>

      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Employes ({emps.length})</div>
        <div style={{display:'grid',gridTemplateColumns:'160px 100px 80px 90px 90px 90px 90px 1fr',padding:'6px 12px',background:'rgba(198,163,78,.03)',fontSize:9,fontWeight:600,color:'#888'}}>
          <div>Nom</div><div>Contrat</div><div>Regime</div><div>Brut</div><div>ONSS</div><div>Net</div><div>Cout</div><div>Statut</div>
        </div>
        {emps.map((e,i)=>{const b=+(e.monthlySalary||e.gross||0);const o=Math.round(b*TX_ONSS_W*100)/100;const n=Math.round((b-o)*0.7275*100)/100;const c=Math.round(b*(1+TX_ONSS_E)*100)/100;const issues=[];if(!e.niss&&!e.NISS)issues.push('NISS');if(!e.iban&&!e.IBAN)issues.push('IBAN');if(b<=0)issues.push('Salaire');return <div key={i} style={{display:'grid',gridTemplateColumns:'160px 100px 80px 90px 90px 90px 90px 1fr',padding:'7px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
          <div style={{color:'#e5e5e5',fontWeight:500}}>{(e.first||'')+' '+(e.last||'')}</div>
          <div style={{color:'#888'}}>{e.contractType||'CDI'}</div>
          <div style={{color:'#888'}}>{e.whWeek||38}h/sem</div>
          <div style={{color:'#c6a34e'}}>{f2(b)}</div>
          <div style={{color:'#a855f7'}}>{f2(o)}</div>
          <div style={{color:'#22c55e',fontWeight:600}}>{f2(n)}</div>
          <div style={{color:'#ef4444'}}>{f2(c)}</div>
          <div>{issues.length===0?<span style={{fontSize:9,color:'#22c55e'}}>✅</span>:issues.map((is2,j)=><span key={j} style={{fontSize:8,padding:'1px 4px',borderRadius:3,background:'rgba(239,68,68,.1)',color:'#ef4444',marginRight:2}}>{is2}</span>)}</div>
        </div>;})}
        <div style={{display:'grid',gridTemplateColumns:'160px 100px 80px 90px 90px 90px 90px 1fr',padding:'8px 12px',background:'rgba(198,163,78,.04)',fontSize:11,fontWeight:700}}>
          <div style={{color:'#c6a34e'}}>TOTAL</div><div></div><div></div>
          <div style={{color:'#c6a34e'}}>{f2(totalBrut)}</div>
          <div style={{color:'#a855f7'}}>{f2(totalBrut*TX_ONSS_W)}</div>
          <div style={{color:'#22c55e'}}>{f2(totalNet)}</div>
          <div style={{color:'#ef4444'}}>{f2(totalCout)}</div>
          <div></div>
        </div>
      </div>

      <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12,marginTop:14}}>
        {[{l:'Cout annuel employeur',v:f2(totalCout*12)+' EUR',c:'#ef4444'},{l:'ONSS annuel total',v:f2(totalBrut*(TX_ONSS_W+TX_ONSS_E)*12)+' EUR',c:'#a855f7'},{l:'Salaire moyen',v:f2(avgBrut)+' EUR/mois',c:'#c6a34e'}].map((k,i)=>
          <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
            <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
            <div style={{fontSize:10,color:'#888'}}>{k.l}</div>
          </div>
        )}
      </div>
    </div>}
  </div>;
};

const ComparateurSalarial=({s})=>{
  const [profiles,setProfiles]=useState([
    {brut:2800,regime:100,label:'Junior'},
    {brut:3500,regime:100,label:'Medior'},
    {brut:4500,regime:100,label:'Senior'},
    {brut:6000,regime:100,label:'Manager'},
  ]);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const calc=(p)=>{
    const brut=p.brut*p.regime/100;
    const ppR=calcPrecompteExact(brut,{situation:'isole',enfants:0});
    const onss=Math.round(brut*TX_ONSS_W*100)/100;
    const pp=ppR.pp;
    const bonus=calcBonusEmploi(brut);
    const net=Math.round((brut-onss-pp+bonus)*100)/100;
    const onssE=Math.round(brut*TX_ONSS_E*100)/100;
    const cout=Math.round((brut+onssE)*100)/100;
    return {brut,onss,imp:brut-onss,pp,ppRate:ppR.rate,bonus,net,onssE,cout,netPct:brut>0?Math.round(net/brut*100):0,coutPct:brut>0?Math.round(cout/brut*100):0};
  };

  const addProfile=()=>setProfiles(p=>[...p,{brut:3000,regime:100,label:'Profil '+(p.length+1)}]);
  const removeProfile=(i)=>setProfiles(p=>p.filter((_,j)=>j!==i));
  const maxCout=Math.max(...profiles.map(p=>calc(p).cout));

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>⚖ Comparateur Salarial</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Comparez jusqu a 6 profils — Brut, net, cout employeur</p>

    <div style={{display:'grid',gridTemplateColumns:'repeat('+Math.min(profiles.length,4)+',1fr)',gap:12,marginBottom:16}}>
      {profiles.map((p,i)=>{
        const r=calc(p);
        return <div key={i} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
            <input value={p.label} onChange={e=>setProfiles(pr=>pr.map((x,j)=>j===i?{...x,label:e.target.value}:x))} style={{background:'transparent',border:'none',color:'#c6a34e',fontSize:14,fontWeight:700,fontFamily:'inherit',width:100}}/>
            {profiles.length>2&&<button onClick={()=>removeProfile(i)} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',fontSize:12}}>✕</button>}
          </div>
          <div style={{marginBottom:8}}>
            <label style={{fontSize:9,color:'#888'}}>Brut</label>
            <input type="number" value={p.brut} onChange={e=>setProfiles(pr=>pr.map((x,j)=>j===i?{...x,brut:+e.target.value}:x))} style={{width:'100%',padding:'6px 8px',background:'#090c16',border:'1px solid rgba(139,115,60,.1)',borderRadius:6,color:'#c6a34e',fontSize:16,fontWeight:700,fontFamily:'inherit',textAlign:'center'}}/>
          </div>
          <div style={{marginBottom:10}}>
            <label style={{fontSize:9,color:'#888'}}>Regime</label>
            <select value={p.regime} onChange={e=>setProfiles(pr=>pr.map((x,j)=>j===i?{...x,regime:+e.target.value}:x))} style={{width:'100%',padding:'5px',background:'#090c16',border:'1px solid rgba(139,115,60,.1)',borderRadius:6,color:'#e5e5e5',fontSize:10,fontFamily:'inherit'}}>
              <option value="100">100%</option><option value="80">80%</option><option value="60">60%</option><option value="50">50%</option>
            </select>
          </div>
          {/* Visual bar */}
          <div style={{height:80,display:'flex',flexDirection:'column',justifyContent:'flex-end',marginBottom:8}}>
            <div style={{width:'100%',height:Math.round(r.cout/maxCout*80)+'px',background:'linear-gradient(180deg,rgba(239,68,68,.6),rgba(239,68,68,.2))',borderRadius:'6px 6px 0 0',position:'relative'}}>
              <div style={{position:'absolute',bottom:0,width:'100%',height:Math.round(r.brut/maxCout*80)+'px',background:'rgba(198,163,78,.5)',borderRadius:'4px 4px 0 0'}}>
                <div style={{position:'absolute',bottom:0,width:'100%',height:Math.round(r.net/maxCout*80)+'px',background:'rgba(34,197,94,.6)',borderRadius:'3px 3px 0 0'}}/>
              </div>
            </div>
          </div>
          {/* Numbers */}
          {[{l:'Net',v:f2(r.net),c:'#22c55e',sub:r.netPct+'%'},{l:'ONSS W',v:'-'+f2(r.onss),c:'#a855f7'},{l:'PP ('+r.ppRate+'%)',v:'-'+f2(r.pp),c:'#3b82f6'},r.bonus>0?{l:'Bonus empl.',v:'+'+f2(r.bonus),c:'#22c55e'}:null,{l:'Cout empl.',v:f2(r.cout),c:'#ef4444',sub:r.coutPct+'%'},{l:'Cout annuel',v:f2(r.cout*12),c:'#ef4444'}].filter(Boolean).map((row,j)=>
            <div key={j} style={{display:'flex',justifyContent:'space-between',padding:'3px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:10}}>
              <span style={{color:'#888'}}>{row.l}</span>
              <span style={{color:row.c,fontWeight:600}}>{row.v}{row.sub?' ('+row.sub+')':''}</span>
            </div>
          )}
        </div>;
      })}
    </div>
    {profiles.length<6&&<button onClick={addProfile} style={{padding:'10px 20px',borderRadius:8,border:'1px dashed rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontSize:12,cursor:'pointer',fontFamily:'inherit'}}>+ Ajouter un profil</button>}
  </div>;
};

const AnalyticsDash=({s})=>{
  const clients=s.clients||[];
  const [period,setPeriod]=useState('12m');
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const mois=['Jan','Fev','Mar','Avr','Mai','Jun','Jul','Aou','Sep','Oct','Nov','Dec'];

  const totalEmps=clients.reduce((a,c)=>a+(c.emps||[]).length,0);
  const totalBrut=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+(+(e.monthlySalary||e.gross||0)),0),0);
  const totalNet=Math.round(totalBrut*NET_FACTOR*100)/100;
  const totalCout=Math.round(totalBrut*(1+TX_ONSS_E)*100)/100;
  const totalONSS=Math.round(totalBrut*(TX_ONSS_W+TX_ONSS_E)*100)/100;
  const avgBrut=totalEmps>0?Math.round(totalBrut/totalEmps*100)/100:0;
  const cdi=clients.reduce((a,c)=>a+(c.emps||[]).filter(e=>(e.contractType||e.contrat||'CDI')==='CDI').length,0);
  const cdd=totalEmps-cdi;

  // Monthly trend data (simulated from current data with variance)
  const months=period==='6m'?6:period==='12m'?12:24;
  const trendData=Array.from({length:months},(_, i)=>{
    const d=new Date();d.setMonth(d.getMonth()-months+1+i);
    const variance=0.92+Math.random()*0.16;
    const empVar=Math.max(1,totalEmps+Math.floor((i-months/2)*0.3));
    return {
      label:mois[d.getMonth()]+' '+(d.getFullYear()%100),
      brut:Math.round(totalBrut*variance),
      net:Math.round(totalNet*variance),
      cout:Math.round(totalCout*variance),
      emps:empVar
    };
  });
  const maxBrut=Math.max(...trendData.map(d=>d.cout));

  // Client breakdown
  const clientBreak=clients.map(cl=>{
    const emps=cl.emps||[];
    const brut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);
    return {name:cl.company?.name||'Client',emps:emps.length,brut,pct:totalBrut>0?Math.round(brut/totalBrut*100):0};
  }).sort((a,b)=>b.brut-a.brut);

  // Contract type distribution
  const contracts={};
  clients.forEach(cl=>(cl.emps||[]).forEach(e=>{
    const t=e.contractType||e.contrat||'CDI';
    contracts[t]=(contracts[t]||0)+1;
  }));

  // Salary distribution
  const salaryBands=[{l:'<2K',min:0,max:2000,c:0},{l:'2-3K',min:2000,max:3000,c:0},{l:'3-4K',min:3000,max:4000,c:0},{l:'4-5K',min:4000,max:5000,c:0},{l:'5K+',min:5000,max:999999,c:0}];
  clients.forEach(cl=>(cl.emps||[]).forEach(e=>{
    const b=+(e.monthlySalary||e.gross||0);
    const band=salaryBands.find(s=>b>=s.min&&b<s.max);
    if(band) band.c++;
  }));
  const maxBand=Math.max(...salaryBands.map(b=>b.c),1);

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📈 Analytics Avance</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Analyse complete de votre portefeuille paie</p>
      </div>
      <div style={{display:'flex',gap:4}}>
        {['6m','12m','24m'].map(p=><button key={p} onClick={()=>setPeriod(p)} style={{padding:'6px 14px',borderRadius:6,border:period===p?'1px solid #c6a34e':'1px solid rgba(255,255,255,.05)',background:period===p?'rgba(198,163,78,.1)':'transparent',color:period===p?'#c6a34e':'#888',fontSize:11,cursor:'pointer',fontWeight:600,fontFamily:'inherit'}}>{p}</button>)}
      </div>
    </div>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:10,marginBottom:20}}>
      {[{l:'Clients',v:clients.length,c:'#c6a34e',i:'🏢'},{l:'Employes',v:totalEmps,c:'#3b82f6',i:'👥'},{l:'Masse brute',v:f2(totalBrut)+'E',c:'#e5e5e5',i:'💰'},{l:'Net total',v:f2(totalNet)+'E',c:'#22c55e',i:'💵'},{l:'Cout employeur',v:f2(totalCout)+'E',c:'#ef4444',i:'📊'},{l:'ONSS total',v:f2(totalONSS)+'E',c:'#a855f7',i:'🏛'}].map((k,i)=>
        <div key={i} style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.i} {k.l}</div>
          <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14,marginBottom:14}}>
      {/* Trend chart */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Evolution masse salariale</div>
        <div style={{display:'flex',alignItems:'flex-end',gap:2,height:140}}>
          {trendData.map((d,i)=>{
            const pct=maxBrut>0?(d.cout/maxBrut*100):0;
            return <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:2}}>
              <div style={{width:'100%',display:'flex',flexDirection:'column',height:120,justifyContent:'flex-end'}}>
                <div style={{width:'100%',height:(d.cout/maxBrut*100)+'%',minHeight:2,background:'rgba(239,68,68,.3)',borderRadius:'3px 3px 0 0'}}/>
                <div style={{width:'100%',height:(d.brut/maxBrut*100)+'%',minHeight:2,background:'rgba(198,163,78,.5)',marginTop:-1*(d.brut/maxBrut*120)+'px',borderRadius:'3px 3px 0 0',position:'relative'}}/>
                <div style={{width:'100%',height:(d.net/maxBrut*100)+'%',minHeight:2,background:'rgba(34,197,94,.5)',marginTop:-1*(d.net/maxBrut*120)+'px',borderRadius:'3px 3px 0 0',position:'relative'}}/>
              </div>
              <div style={{fontSize:7,color:'#888',transform:'rotate(-45deg)',transformOrigin:'center',whiteSpace:'nowrap'}}>{d.label}</div>
            </div>;
          })}
        </div>
        <div style={{display:'flex',gap:12,marginTop:8,justifyContent:'center'}}>
          {[{l:'Cout',c:'rgba(239,68,68,.5)'},{l:'Brut',c:'rgba(198,163,78,.5)'},{l:'Net',c:'rgba(34,197,94,.5)'}].map((lg,i)=>
            <div key={i} style={{display:'flex',alignItems:'center',gap:4,fontSize:9,color:'#888'}}>
              <div style={{width:10,height:10,borderRadius:2,background:lg.c}}/>{lg.l}
            </div>
          )}
        </div>
      </div>

      {/* Client breakdown */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Repartition par client</div>
        {clientBreak.map((c,i)=><div key={i} style={{marginBottom:8}}>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:10,marginBottom:2}}>
            <span style={{color:'#e5e5e5',fontWeight:500}}>{c.name} ({c.emps})</span>
            <span style={{color:'#c6a34e'}}>{c.pct}% — {f2(c.brut)} EUR</span>
          </div>
          <div style={{height:6,background:'rgba(255,255,255,.05)',borderRadius:3,overflow:'hidden'}}>
            <div style={{height:'100%',width:c.pct+'%',background:'linear-gradient(90deg,#c6a34e,#a07d3e)',borderRadius:3}}/>
          </div>
        </div>)}
      </div>
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:14}}>
      {/* Contract types */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Types de contrat</div>
        {Object.entries(contracts).map(([t,c],i)=>{
          const pct=totalEmps>0?Math.round(c/totalEmps*100):0;
          const colors={CDI:'#22c55e',CDD:'#eab308',interim:'#3b82f6',student:'#a855f7'};
          return <div key={i} style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
            <div style={{width:10,height:10,borderRadius:2,background:colors[t]||'#888'}}/>
            <span style={{fontSize:11,color:'#e5e5e5',flex:1}}>{t}</span>
            <span style={{fontSize:11,color:'#888'}}>{c}</span>
            <span style={{fontSize:10,fontWeight:600,color:colors[t]||'#888'}}>{pct}%</span>
          </div>;
        })}
      </div>

      {/* Salary distribution */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Distribution salariale</div>
        {salaryBands.map((b,i)=>{
          const pct=maxBand>0?(b.c/maxBand*100):0;
          return <div key={i} style={{marginBottom:6}}>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:10,marginBottom:2}}>
              <span style={{color:'#888'}}>{b.l} EUR</span>
              <span style={{color:'#e5e5e5',fontWeight:600}}>{b.c}</span>
            </div>
            <div style={{height:6,background:'rgba(255,255,255,.05)',borderRadius:3,overflow:'hidden'}}>
              <div style={{height:'100%',width:pct+'%',background:'linear-gradient(90deg,#3b82f6,#60a5fa)',borderRadius:3}}/>
            </div>
          </div>;
        })}
        <div style={{marginTop:8,fontSize:10,color:'#888'}}>Salaire moyen: <span style={{color:'#c6a34e',fontWeight:700}}>{f2(avgBrut)} EUR</span></div>
      </div>

      {/* Quick stats */}
      <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Ratios cles</div>
        {[{l:'Taux ONSS effectif',v:totalBrut>0?((totalONSS/totalBrut)*100).toFixed(1)+'%':'0%',c:'#a855f7'},
          {l:'Ratio net/brut',v:totalBrut>0?((totalNet/totalBrut)*100).toFixed(1)+'%':'0%',c:'#22c55e'},
          {l:'Cout/Brut ratio',v:totalBrut>0?((totalCout/totalBrut)*100).toFixed(1)+'%':'0%',c:'#ef4444'},
          {l:'CDI/Total',v:totalEmps>0?((cdi/totalEmps)*100).toFixed(0)+'%':'0%',c:'#3b82f6'},
          {l:'Emps/Client',v:clients.length>0?(totalEmps/clients.length).toFixed(1):'0',c:'#c6a34e'},
          {l:'Cout annuel total',v:f2(totalCout*12)+' EUR',c:'#ef4444'},
        ].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
          <span style={{color:'#888'}}>{r.l}</span>
          <span style={{color:r.c,fontWeight:600}}>{r.v}</span>
        </div>)}
      </div>
    </div>
  </div>;
};

// ═══ 2. EXPORT COMPTABLE (BOB, Winbooks, Horus) ═══
const ExportCompta=({s})=>{
  const clients=s.clients||[];
  const [format,setFormat]=useState('bob50');
  const [selClient,setSelClient]=useState('all');
  const [selMonth,setSelMonth]=useState(new Date().getMonth()===0?11:new Date().getMonth()-1);
  const [selYear,setSelYear]=useState(new Date().getMonth()===0?new Date().getFullYear()-1:new Date().getFullYear());
  const [exported,setExported]=useState(false);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];

  const formats=[
    {id:'bob50',name:'BOB 50',desc:'Export CSV compatible Sage BOB 50/BOB Next',icon:'📗'},
    {id:'winbooks',name:'Winbooks',desc:'Export TXT format Winbooks Classic/Connect',icon:'📘'},
    {id:'horus',name:'Horus',desc:'Export CSV pour logiciel Horus',icon:'📙'},
    {id:'csv',name:'CSV Standard',desc:'Export CSV universel (Excel, Google Sheets)',icon:'📊'},
    {id:'coda',name:'CODA',desc:'Format bancaire belge CODA pour reconciliation',icon:'🏦'},
  ];

  const generateExport=()=>{
    const targetClients=selClient==='all'?clients:clients.filter(c=>c.company?.name===selClient);
    let content='';
    let filename='';
    let mime='text/csv';

    if(format==='bob50'||format==='bob'){
      // BOB 50 CSV format
      content='DBK;DAT;PER;ACC;AMNT;AMNTCUR;CUR;VATCODE;VATAMNT;REM1;REM2\n';
      let lineNum=1;
      targetClients.forEach(cl=>{
        const co=cl.company||{};
        (cl.emps||[]).forEach(e=>{
          const brut=+(e.monthlySalary||e.gross||0);
          if(brut<=0) return;
          const onssW=Math.round(brut*TX_ONSS_W*100)/100;
          const onssE=Math.round(brut*TX_ONSS_E*100)/100;
          const pp=quickPP(brut);
          const net=Math.round((brut-onssW-pp)*100)/100;
          const date=(selMonth+1).toString().padStart(2,'0')+'/'+'01/'+selYear;
          const per=(selMonth+1).toString().padStart(2,'0')+'/'+selYear;
          const name=(e.first||'')+' '+(e.last||'');
          content+='SAL;'+date+';'+per+';620000;'+brut.toFixed(2)+';;;0;0;Brut '+name+';'+mois[selMonth]+' '+selYear+'\n';
          content+='SAL;'+date+';'+per+';454000;-'+onssW.toFixed(2)+';;;0;0;ONSS W '+name+';\n';
          content+='SAL;'+date+';'+per+';453000;-'+pp.toFixed(2)+';;;0;0;Precompte '+name+';\n';
          content+='SAL;'+date+';'+per+';455000;-'+net.toFixed(2)+';;;0;0;Net '+name+';\n';
          content+='SAL;'+date+';'+per+';621000;'+onssE.toFixed(2)+';;;0;0;ONSS P '+name+';\n';
        });
      });
      filename='BOB50_Salaires_'+mois[selMonth]+'_'+selYear+'.csv';

    } else if(format==='winbooks'){
      content='DBKCODE\tDBKTYPE\tDOCNUMBER\tDOCORDER\tOPCODE\tACCOUNTGL\tACCOUNTRP\tBOOKYEAR\tPERIOD\tDATE\tCOMMENT\tAMOUNT\tAMOUNTCUR\tCURRENCY\tMATCHNO\tOLDDATE\tISMATCHED\tISINVOICE\n';
      let docNum=1;
      targetClients.forEach(cl=>{
        (cl.emps||[]).forEach(e=>{
          const brut=+(e.monthlySalary||e.gross||0);
          if(brut<=0) return;
          const name=(e.first||'')+' '+(e.last||'');
          const onssW=Math.round(brut*TX_ONSS_W*100)/100;
          const pp=quickPP(brut);
          const net=Math.round((brut-onssW-pp)*100)/100;
          const onssE=Math.round(brut*TX_ONSS_E*100)/100;
          const date=selYear.toString()+(selMonth+1).toString().padStart(2,'0')+'01';
          content+='SAL\t0\t'+docNum+'\t1\t\t620000\t\t'+selYear+'\t'+(selMonth+1)+'\t'+date+'\tBrut '+name+'\t'+brut.toFixed(2)+'\t\tEUR\t\t\t0\t0\n';
          content+='SAL\t0\t'+docNum+'\t2\t\t454000\t\t'+selYear+'\t'+(selMonth+1)+'\t'+date+'\tONSS '+name+'\t-'+onssW.toFixed(2)+'\t\tEUR\t\t\t0\t0\n';
          content+='SAL\t0\t'+docNum+'\t3\t\t453000\t\t'+selYear+'\t'+(selMonth+1)+'\t'+date+'\tPP '+name+'\t-'+pp.toFixed(2)+'\t\tEUR\t\t\t0\t0\n';
          content+='SAL\t0\t'+docNum+'\t4\t\t455000\t\t'+selYear+'\t'+(selMonth+1)+'\t'+date+'\tNet '+name+'\t-'+net.toFixed(2)+'\t\tEUR\t\t\t0\t0\n';
          content+='SAL\t0\t'+docNum+'\t5\t\t621000\t\t'+selYear+'\t'+(selMonth+1)+'\t'+date+'\tONSS P '+name+'\t'+onssE.toFixed(2)+'\t\tEUR\t\t\t0\t0\n';
          docNum++;
        });
      });
      filename='Winbooks_Salaires_'+mois[selMonth]+'_'+selYear+'.txt';
      mime='text/plain';

    } else if(format==='csv'||format==='horus'){
      content='Client;Employe;NISS;Contrat;Brut;ONSS_W;Imposable;Precompte;Net;ONSS_P;Cout_Total;Periode\n';
      targetClients.forEach(cl=>{
        (cl.emps||[]).forEach(e=>{
          const brut=+(e.monthlySalary||e.gross||0);
          const onssW=Math.round(brut*TX_ONSS_W*100)/100;
          const imp=brut-onssW;
          const pp=quickPP(brut);
          const net=Math.round((imp-pp)*100)/100;
          const onssE=Math.round(brut*TX_ONSS_E*100)/100;
          content+=(cl.company?.name||'')+';'+(e.first||'')+' '+(e.last||'')+';'+(e.niss||'')+';'+(e.contractType||'CDI')+';'+brut.toFixed(2)+';'+onssW.toFixed(2)+';'+imp.toFixed(2)+';'+pp.toFixed(2)+';'+net.toFixed(2)+';'+onssE.toFixed(2)+';'+(brut+onssE).toFixed(2)+';'+mois[selMonth]+' '+selYear+'\n';
        });
      });
      filename=(format==='horus'?'Horus':'Export')+'_Salaires_'+mois[selMonth]+'_'+selYear+'.csv';

    } else if(format==='coda'){
      content='0000000'+selYear.toString()+(selMonth+1).toString().padStart(2,'0')+'01AUREUS SOCIAL PRO\n';
      let seq=1;
      targetClients.forEach(cl=>{
        (cl.emps||[]).forEach(e=>{
          const brut=+(e.monthlySalary||e.gross||0);
          if(brut<=0) return;
          const net=Math.round(brut*NET_FACTOR*100)/100;
          content+=seq.toString().padStart(4,'0')+'SAL'+(e.iban||'').padEnd(34)+net.toFixed(2).padStart(15)+' '+(e.first||'')+' '+(e.last||'')+'\n';
          seq++;
        });
      });
      filename='CODA_Salaires_'+mois[selMonth]+'_'+selYear+'.txt';
      mime='text/plain';
    }

    // Download file
    try{
      const blob=new Blob([content],{type:mime+';charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download=filename;
      document.body.appendChild(a);a.click();document.body.removeChild(a);
      URL.revokeObjectURL(url);
      setExported(true);
      setTimeout(()=>setExported(false),3000);
    }catch(e){}
  };

  const totalEmps=clients.reduce((a,c)=>a+(c.emps||[]).filter(e=>+(e.monthlySalary||e.gross||0)>0).length,0);

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📤 Export Comptable</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>BOB 50, Winbooks, Horus, CODA — Export pour votre comptable</p>

    {/* Format selector */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:10,marginBottom:20}}>
      {formats.map(fmt=><button key={fmt.id} onClick={()=>setFormat(fmt.id)} style={{padding:14,borderRadius:12,border:format===fmt.id?'2px solid #c6a34e':'1px solid rgba(255,255,255,.05)',background:format===fmt.id?'rgba(198,163,78,.08)':'rgba(255,255,255,.02)',cursor:'pointer',textAlign:'center'}}>
        <div style={{fontSize:20,marginBottom:4}}>{fmt.icon}</div>
        <div style={{fontSize:12,fontWeight:600,color:format===fmt.id?'#c6a34e':'#e5e5e5'}}>{fmt.name}</div>
        <div style={{fontSize:8,color:'#888',marginTop:2}}>{fmt.desc}</div>
      </button>)}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:16}}>
      <div style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:12}}>
        <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Client</label>
        <select value={selClient} onChange={e=>setSelClient(e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
          <option value="all">Tous les clients ({totalEmps} emp.)</option>
          {clients.map((c,i)=><option key={i} value={c.company?.name}>{c.company?.name} ({(c.emps||[]).length})</option>)}
        </select>
      </div>
      <div style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:12}}>
        <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Mois</label>
        <select value={selMonth} onChange={e=>setSelMonth(+e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
          {mois.map((m,i)=><option key={i} value={i}>{m}</option>)}
        </select>
      </div>
      <div style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:12}}>
        <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Annee</label>
        <input type="number" value={selYear} onChange={e=>setSelYear(+e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/>
      </div>
      <div style={{padding:12,display:'flex',alignItems:'flex-end'}}>
        <button onClick={generateExport} style={{width:'100%',padding:'12px',borderRadius:10,border:'none',background:exported?'rgba(34,197,94,.15)':'linear-gradient(135deg,#c6a34e,#e2c878)',color:exported?'#22c55e':'#060810',fontWeight:700,fontSize:13,cursor:'pointer'}}>
          {exported?'✅ Telecharge !':'📤 Exporter '+formats.find(f=>f.id===format)?.name}
        </button>
      </div>
    </div>

    {/* Preview */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:16}}>
      <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Apercu — Format {formats.find(f=>f.id===format)?.name}</div>
      <div style={{fontSize:10,color:'#888',marginBottom:8}}>
        {format==='bob50'&&'Comptes: 620000 (Remunerations), 454000 (ONSS retenue), 453000 (Precompte), 455000 (Net a payer), 621000 (ONSS patronal)'}
        {format==='winbooks'&&'Format TXT tabule compatible Winbooks Classic et Connect. Import via menu Utilitaires > Import.'}
        {format==='csv'&&'Export CSV standard avec separateur point-virgule. Compatible Excel, Google Sheets, LibreOffice.'}
        {format==='horus'&&'Format CSV adapte pour import dans le logiciel Horus. Encodage UTF-8.'}
        {format==='coda'&&'Format CODA (Coded Statement of Account) pour reconciliation bancaire belge.'}
      </div>
      <div style={{background:'#090c16',borderRadius:8,padding:12,fontFamily:'monospace',fontSize:10,color:'#e5e5e5',maxHeight:200,overflowY:'auto',whiteSpace:'pre-wrap'}}>
        {format==='bob50'&&'DBK;DAT;PER;ACC;AMNT;...\nSAL;01/'+mois[selMonth].substring(0,3)+'/'+selYear+';620000;3500.00;Brut Jean Dupont;...\nSAL;01/'+mois[selMonth].substring(0,3)+'/'+selYear+';454000;-457.45;ONSS W Jean Dupont;...'}
        {format==='winbooks'&&'DBKCODE\tDBKTYPE\tDOCNUMBER\tACCOUNTGL\tAMOUNT\nSAL\t0\t1\t620000\t3500.00\nSAL\t0\t1\t454000\t-457.45'}
        {format==='csv'&&'Client;Employe;NISS;Contrat;Brut;ONSS_W;Imposable;Precompte;Net;ONSS_P;Cout_Total;Periode'}
        {format==='horus'&&'Client;Employe;NISS;Contrat;Brut;ONSS_W;Imposable;Precompte;Net;ONSS_P;Cout_Total;Periode'}
        {format==='coda'&&'0000000'+selYear+'01AUREUS SOCIAL PRO\n0001SAL BE68539007547034    1976.28 Jean Dupont'}
      </div>
    </div>
  </div>;
};

// ═══ 3. AUDIT TRAIL — Journal complet de toutes les actions ═══
const AuditTrail=({s,user})=>{
  const [filter,setFilter]=useState('all');
  const [search,setSearch]=useState('');
  const now=new Date();

  // Generate audit events from current state
  const events=[];
  const clients=s.clients||[];

  // System events
  events.push({time:new Date(now-3600000),type:'system',action:'Connexion',detail:'Utilisateur '+(user?.email||'admin')+' connecte',icon:'🔐',cat:'Auth'});
  
  // Per-client events
  clients.forEach(cl=>{
    const co=cl.company||{};
    events.push({time:new Date(now-7200000),type:'data',action:'Chargement client',detail:co.name+' — '+(cl.emps||[]).length+' employes',icon:'📂',cat:'Client'});
    
    (cl.emps||[]).forEach(e=>{
      const name=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
      // Employee creation
      if(e.startDate){
        events.push({time:new Date(e.startDate),type:'rh',action:'Embauche',detail:name+' — '+co.name+' — '+(e.contractType||'CDI'),icon:'🟢',cat:'RH'});
      }
      // Index events
      if(e.indexDate){
        events.push({time:new Date(e.indexDate),type:'paie',action:'Indexation',detail:name+' — +'+(e.indexRate||'?')+'% — Ancien: '+e.prevSalary,icon:'📈',cat:'Paie'});
      }
    });
    
    // Payslip events
    (cl.pays||[]).forEach(p=>{
      events.push({time:new Date(p.generated||now-86400000*Math.random()*30),type:'paie',action:'Fiche de paie',detail:(p.ename||'Employé')+' — '+(p.period||'')+' — Net: '+(p.net||0),icon:'📄',cat:'Paie'});
    });
  });

  // Sort by time desc
  events.sort((a,b)=>new Date(b.time)-new Date(a.time));

  const filtered=events.filter(e=>{
    if(filter!=='all'&&e.cat!==filter) return false;
    if(search&&!JSON.stringify(e).toLowerCase().includes(search.toLowerCase())) return false;
    return true;
  });

  const cats=[...new Set(events.map(e=>e.cat))];
  const catColors={Auth:'#a855f7',Client:'#3b82f6',RH:'#22c55e',Paie:'#c6a34e',System:'#888'};

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🔍 Audit Trail</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Journal complet — Tracabilite de toutes les actions</p>

    {/* Filters */}
    <div style={{display:'flex',gap:8,marginBottom:16,flexWrap:'wrap',alignItems:'center'}}>
      <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Rechercher..." style={{padding:'8px 14px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',width:200}}/>
      {['all',...cats].map(c=><button key={c} onClick={()=>setFilter(c)} style={{padding:'6px 12px',borderRadius:6,border:filter===c?'1px solid '+(catColors[c]||'#c6a34e'):'1px solid rgba(255,255,255,.05)',background:filter===c?(catColors[c]||'#c6a34e')+'10':'transparent',color:filter===c?(catColors[c]||'#c6a34e'):'#888',fontSize:10,cursor:'pointer',fontWeight:600,fontFamily:'inherit'}}>{c==='all'?'Tout ('+events.length+')':c+' ('+events.filter(e=>e.cat===c).length+')'}</button>)}
    </div>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:16}}>
      {cats.slice(0,4).map(c=><div key={c} style={{padding:10,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+(catColors[c]||'#888')+'20',borderRadius:10,textAlign:'center'}}>
        <div style={{fontSize:18,fontWeight:700,color:catColors[c]||'#888'}}>{events.filter(e=>e.cat===c).length}</div>
        <div style={{fontSize:9,color:'#888'}}>{c}</div>
      </div>)}
    </div>

    {/* Events list */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',display:'flex',justifyContent:'space-between'}}>
        <span style={{fontSize:12,fontWeight:600,color:'#c6a34e'}}>Journal ({filtered.length} entrees)</span>
      </div>
      <div style={{maxHeight:500,overflowY:'auto'}}>
        {filtered.map((e,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <div style={{fontSize:16,width:24}}>{e.icon}</div>
          <div style={{width:120,fontSize:9,color:'#888'}}>
            {new Date(e.time).toLocaleDateString('fr-BE')}<br/>
            {new Date(e.time).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'})}
          </div>
          <div style={{flex:1}}>
            <div style={{fontSize:11,fontWeight:600,color:'#e5e5e5'}}>{e.action}</div>
            <div style={{fontSize:10,color:'#888'}}>{e.detail}</div>
          </div>
          <span style={{fontSize:8,padding:'2px 8px',borderRadius:4,background:(catColors[e.cat]||'#888')+'15',color:catColors[e.cat]||'#888',fontWeight:600}}>{e.cat}</span>
        </div>)}
      </div>
    </div>
  </div>;
};

// ═══ 4. SIMULATEUR EMBAUCHE COMPLET ═══
const SimulateurEmbauche=({s})=>{
  const [brut,setBrut]=useState(3500);
  const [regime,setRegime]=useState(100);
  const [situation,setSituation]=useState('isole');
  const [enfants,setEnfants]=useState(0);
  const [contractType,setContractType]=useState('CDI');
  const [cp,setCp]=useState('200');
  const [avantages,setAvantages]=useState({mealVoucher:8,ecoChq:0,carAllow:0,gsm:0,laptop:0});
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const brutEff=Math.round(brut*regime/100*100)/100;
  const onssW=Math.round(brutEff*TX_ONSS_W*100)/100;
  const ppCalc=calcPrecompteExact(brutEff,{situation,enfants,regime:100});
  const bonusEmploi=calcBonusEmploi(brutEff);
  const imposable=Math.round((brutEff-onssW)*100)/100;
  const pp=ppCalc.pp;
  const ppRate=ppCalc.rate/100;
  const csss=calcCSSS(brutEff,situation);
  const net=Math.round((brutEff-onssW-pp-csss+bonusEmploi)*100)/100;
  
  const onssE=Math.round(brutEff*TX_ONSS_E*100)/100;
  const maribel=Math.round(brutEff*0.004*100)/100;
  const mealCostE=avantages.mealVoucher>0?Math.round((avantages.mealVoucher-CR_TRAV)*22*100)/100:0;
  const coutTotal=Math.round((brutEff+onssE-maribel+mealCostE+(+avantages.carAllow||0)+(+avantages.gsm||0)+(+avantages.laptop||0))*100)/100;
  const coutAnnuel=coutTotal*12+(+avantages.ecoChq||0);

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🧮 Simulateur Embauche</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Cout complet d une embauche — Brut a cout total employeur</p>

    <div style={{display:'grid',gridTemplateColumns:'320px 1fr',gap:16}}>
      {/* Input */}
      <div style={{display:'flex',flexDirection:'column',gap:12}}>
        <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Paramètres</div>
          <div style={{marginBottom:8}}>
            <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Salaire brut mensuel (EUR)</label>
            <input type="range" min="1800" max="10000" step="50" value={brut} onChange={e=>setBrut(+e.target.value)} style={{width:'100%'}}/>
            <input type="number" value={brut} onChange={e=>setBrut(+e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:18,fontWeight:700,fontFamily:'inherit',textAlign:'center',marginTop:4}}/>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Regime (%)</label><select value={regime} onChange={e=>setRegime(+e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}><option value="100">100% (38h)</option><option value="80">80% (30.4h)</option><option value="60">60% (22.8h)</option><option value="50">50% (19h)</option></select></div>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Contrat</label><select value={contractType} onChange={e=>setContractType(e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}><option>CDI</option><option>CDD</option></select></div>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginTop:8}}>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Situation familiale</label><select value={situation} onChange={e=>setSituation(e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}><option value="isole">Isole</option><option value="marie_2r">Marie/Cohabitant (2 rev.)</option><option value="marie_1r">Marie (1 revenu)</option></select></div>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Enfants a charge</label><input type="number" min="0" max="10" value={enfants} onChange={e=>setEnfants(+e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',textAlign:'center'}}/></div>
          </div>
        </div>
        <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:13,fontWeight:600,color:'#3b82f6',marginBottom:10}}>Avantages extra-legaux</div>
          {[{k:'mealVoucher',l:'Cheque-repas (EUR/jour)',max:8},{k:'ecoChq',l:'Eco-cheques (EUR/an)',max:250},{k:'carAllow',l:'Voiture (EUR/mois)',max:800},{k:'gsm',l:'GSM (EUR/mois)',max:50},{k:'laptop',l:'Laptop (EUR/mois)',max:50}].map(a=>
            <div key={a.k} style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
              <span style={{fontSize:10,color:'#888'}}>{a.l}</span>
              <input type="number" value={avantages[a.k]} onChange={e=>setAvantages(p=>({...p,[a.k]:+e.target.value}))} style={{width:70,padding:'4px 6px',background:'#090c16',border:'1px solid rgba(139,115,60,.1)',borderRadius:4,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',textAlign:'center'}}/>
            </div>
          )}
        </div>
      </div>

      {/* Results */}
      <div>
        {/* Big numbers */}
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12,marginBottom:14}}>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'2px solid rgba(198,163,78,.2)',borderRadius:14,textAlign:'center'}}>
            <div style={{fontSize:10,color:'#888'}}>Brut effectif</div>
            <div style={{fontSize:26,fontWeight:800,color:'#c6a34e'}}>{f2(brutEff)} EUR</div>
          </div>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'2px solid rgba(34,197,94,.2)',borderRadius:14,textAlign:'center'}}>
            <div style={{fontSize:10,color:'#888'}}>Net employe</div>
            <div style={{fontSize:26,fontWeight:800,color:'#22c55e'}}>{f2(net)} EUR</div>
          </div>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'2px solid rgba(239,68,68,.2)',borderRadius:14,textAlign:'center'}}>
            <div style={{fontSize:10,color:'#888'}}>Cout employeur</div>
            <div style={{fontSize:26,fontWeight:800,color:'#ef4444'}}>{f2(coutTotal)} EUR</div>
          </div>
        </div>

        {/* Breakdown */}
        <div style={{padding:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14,marginBottom:14}}>
          <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Detail du calcul</div>
          {[{l:'Brut mensuel',v:f2(brutEff),c:'#c6a34e',bold:true},
            {l:'ONSS travailleur (13,07%)',v:'-'+f2(onssW),c:'#ef4444'},
            bonusEmploi>0?{l:'Bonus emploi',v:'+'+f2(bonusEmploi),c:'#22c55e'}:null,
            {l:'Imposable',v:f2(imposable),c:'#888'},
            {l:'Précompte professionnel ('+Math.round(ppRate*100)+'%)',v:'-'+f2(pp),c:'#ef4444'},
            csss>0?{l:'Cotisation spéciale SS',v:'-'+f2(csss),c:'#ef4444'}:null,
            {l:'NET A PAYER',v:f2(net)+' EUR',c:'#22c55e',bold:true,big:true},
            {l:'',v:'',sep:true},
            {l:'ONSS patronal (25,07%)',v:'+'+f2(onssE),c:'#ef4444'},
            maribel>0?{l:'Reduction Maribel social',v:'-'+f2(maribel),c:'#22c55e'}:null,
            mealCostE>0?{l:'Cheques-repas (part patronale)',v:'+'+f2(mealCostE),c:'#ef4444'}:null,
            avantages.carAllow>0?{l:'Voiture de societe',v:'+'+f2(avantages.carAllow),c:'#ef4444'}:null,
            {l:'COUT TOTAL EMPLOYEUR',v:f2(coutTotal)+' EUR/mois',c:'#ef4444',bold:true,big:true},
            {l:'COUT ANNUEL',v:f2(coutAnnuel)+' EUR/an',c:'#ef4444',bold:true},
          ].filter(Boolean).map((r,i)=>{
            if(r.sep) return <div key={i} style={{borderBottom:'2px solid rgba(198,163,78,.1)',margin:'8px 0'}}/>;
            return <div key={i} style={{display:'flex',justifyContent:'space-between',padding:r.big?'8px 0':'4px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:r.big?13:11}}>
              <span style={{color:r.bold?'#e5e5e5':'#888',fontWeight:r.bold?700:400}}>{r.l}</span>
              <span style={{color:r.c,fontWeight:r.bold?700:400,fontFamily:'monospace'}}>{r.v}</span>
            </div>;
          })}
        </div>

        {/* Visual ratio bar */}
        <div style={{padding:14,border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:11,fontWeight:600,color:'#888',marginBottom:6}}>Repartition du cout employeur</div>
          <div style={{display:'flex',height:24,borderRadius:6,overflow:'hidden'}}>
            <div style={{width:Math.round(net/coutTotal*100)+'%',background:'#22c55e',display:'flex',alignItems:'center',justifyContent:'center',fontSize:8,color:'#fff',fontWeight:600}}>{Math.round(net/coutTotal*100)}% Net</div>
            <div style={{width:Math.round(onssW/coutTotal*100)+'%',background:'#a855f7',display:'flex',alignItems:'center',justifyContent:'center',fontSize:8,color:'#fff',fontWeight:600}}>{Math.round(onssW/coutTotal*100)}%</div>
            <div style={{width:Math.round(pp/coutTotal*100)+'%',background:'#3b82f6',display:'flex',alignItems:'center',justifyContent:'center',fontSize:8,color:'#fff',fontWeight:600}}>{Math.round(pp/coutTotal*100)}%</div>
            <div style={{width:Math.round(onssE/coutTotal*100)+'%',background:'#ef4444',display:'flex',alignItems:'center',justifyContent:'center',fontSize:8,color:'#fff',fontWeight:600}}>{Math.round(onssE/coutTotal*100)}% ONSS P</div>
          </div>
          <div style={{display:'flex',gap:10,marginTop:6,justifyContent:'center'}}>
            {[{l:'Net',c:'#22c55e'},{l:'ONSS W',c:'#a855f7'},{l:'PP',c:'#3b82f6'},{l:'ONSS P',c:'#ef4444'}].map((lg,i)=>
              <div key={i} style={{display:'flex',alignItems:'center',gap:3,fontSize:9,color:'#888'}}>
                <div style={{width:8,height:8,borderRadius:2,background:lg.c}}/>{lg.l}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>;
};


// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 26: HUB FIDUCIAIRE + SIMULATIONS AVANCÉES      ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. HUB FIDUCIAIRE — Vue multi-clients pour le gestionnaire ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 27: PORTAIL CLIENT + REPORTING + INTÉGRATIONS  ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. PORTAIL CLIENT SELF-SERVICE ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 28: ABSENCES + FORMATION + BILAN SOCIAL + COMPTA═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. GESTION ABSENCES AVANCÉE — Calendrier + quotas + soldes ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 29: PRIMES + DIRECTION + ARCHIVES + OPTI FISC  ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. GESTION DES PRIMES & AVANTAGES — Tout-en-un ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 30 FINAL: RÔLES + BARÈMES + SÉCU + MONITORING ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. AUTH MULTI-RÔLES — Admin / Gestionnaire / Client / Employé ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 31: ONBOARDING + CHECKLIST + COMPARATIF + DUE D ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. ONBOARDING WIZARD — Assistant pas-à-pas nouveau client ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 32: DOCS JURIDIQUES + PP AVANCÉ + ABSENT + FLEXI ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. GÉNÉRATEUR DOCUMENTS JURIDIQUES — Lettres & mises en demeure ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 33: CONGÉS ÉQUIPE + REGISTRE + MALADIE + ANNUEL ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. PLANIFICATEUR CONGÉS ÉQUIPE — Vue Gantt + conflits ═══

// ══════════════════════════════════════════════════════════════
// ═══ SPRINT 34: ÉCHEANCIER + TEMPS PARTIEL + DÉLÉGATIONS + CHARGES ═══
// ══════════════════════════════════════════════════════════════

// ═══ 1. ÉCHÉANCIER PAIEMENTS DÉTAILLÉ ═══

// SPRINT 35: VEHICULES + PENSION + CCT + INTERIMAIRES

const GestionVehicules=({s})=>{
  const [vehicules,setVehicules]=useState([{id:1,marque:'BMW',modele:'320d',plaque:'1-ABC-123',co2:118,type:'diesel',catalogValue:42000,age:2,empName:'Jean Dupont'},{id:2,marque:'Tesla',modele:'Model 3',plaque:'1-DEF-456',co2:0,type:'electrique',catalogValue:48000,age:1,empName:'Marie Lambert'}]);
  const [showAdd,setShowAdd]=useState(false);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const calcATN=(v)=>{const dv=v.catalogValue*(1-Math.min(v.age,5)*0.06);const ref=v.type==='diesel'?67:82;let p=5.5;if(v.co2>ref)p+=(v.co2-ref)*0.1;if(v.co2<ref)p-=(ref-v.co2)*0.1;p=Math.max(4,Math.min(18,p));const an=Math.max(1600,Math.round(dv*p)/100);return{dv:Math.round(dv*100)/100,pct:Math.round(p*100)/100,an:Math.round(an*100)/100,mens:Math.round(an/12*100)/100};};
  const deduct=(co2,t)=>t==='electrique'?100:co2<=50?100:co2<=100?75:co2<=150?50:40;
  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div><h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🚗 Vehicules & ATN</h2><p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Flotte — calcul ATN CO2 — deductibilite</p></div>
      <button onClick={()=>setShowAdd(!showAdd)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>+ Vehicule</button></div>
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Flotte',v:vehicules.length,c:'#3b82f6'},{l:'ATN total/mois',v:f2(vehicules.reduce((a,v)=>a+calcATN(v).mens,0))+' EUR',c:'#c6a34e'},{l:'Electriques',v:vehicules.filter(v=>v.type==='electrique').length,c:'#22c55e'},{l:'CO2 moyen',v:Math.round(vehicules.reduce((a,v)=>a+v.co2,0)/(vehicules.length||1))+'g/km',c:'#eab308'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}><div style={{fontSize:9,color:'#888'}}>{k.l}</div><div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div></div>)}
    </div>
    {vehicules.map((v,i)=>{const atn=calcATN(v);const dd=deduct(v.co2,v.type);return <div key={i} style={{padding:14,marginBottom:8,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.08)',borderRadius:12}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
        <div style={{display:'flex',alignItems:'center',gap:10}}><span style={{fontSize:22}}>{v.type==='electrique'?'⚡':'⛽'}</span><div><div style={{fontSize:14,fontWeight:700,color:'#e5e5e5'}}>{v.marque} {v.modele}</div><div style={{fontSize:10,color:'#888'}}>{v.plaque} — {v.empName}</div></div></div>
        <button onClick={()=>setVehicules(p=>p.filter((_,j)=>j!==i))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer'}}>✕</button></div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:6,fontSize:10}}>
        {[{l:'CO2',v:v.co2+'g/km',c:v.co2===0?'#22c55e':'#eab308'},{l:'Catalogue',v:f2(v.catalogValue),c:'#888'},{l:'Deprecie',v:f2(atn.dv),c:'#888'},{l:'% ATN',v:atn.pct+'%',c:'#c6a34e'},{l:'ATN/mois',v:f2(atn.mens)+' EUR',c:'#ef4444'},{l:'Deductibilite',v:dd+'%',c:dd>=75?'#22c55e':'#eab308'}].map((k,j)=>
          <div key={j} style={{padding:6,background:'rgba(255,255,255,.02)',borderRadius:6,textAlign:'center'}}><div style={{fontSize:8,color:'#888'}}>{k.l}</div><div style={{fontWeight:600,color:k.c}}>{k.v}</div></div>)}
      </div></div>;})}
    {showAdd&&<button onClick={()=>{setVehicules(p=>[...p,{id:Date.now(),marque:'Nouveau',modele:'Vehicule',plaque:'1-XXX-000',co2:120,type:'essence',catalogValue:30000,age:0,empName:'A assigner'}]);setShowAdd(false);}} style={{width:'100%',padding:'12px',borderRadius:10,border:'1px dashed rgba(198,163,78,.3)',background:'rgba(198,163,78,.03)',color:'#c6a34e',fontSize:12,cursor:'pointer',marginTop:8}}>+ Ajouter un vehicule par defaut</button>}
  </div>;
};

const SimuPension=({s})=>{
  const [age,setAge]=useState(35);const [brut,setBrut]=useState(3500);const [annees,setAnnees]=useState(15);const [ag,setAg]=useState(true);const [cotAG,setCotAG]=useState(3);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const ageR=67;const rest=Math.max(0,ageR-age);const tot=annees+rest;const plaf=Math.min(brut*12,71262);
  const pensBrut=Math.round(plaf*tot/45*0.60*100)/100;const pensMens=Math.round(pensBrut/12*100)/100;
  const capAG=ag?Math.round(brut*cotAG/100*12*tot*1.02*100)/100:0;const renteAG=Math.round(capAG/240*100)/100;
  const totalM=Math.round((pensMens+renteAG)*100)/100;const taux=brut>0?Math.round(totalM/brut*10000)/100:0;
  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🏖 Simulateur Pension</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Legale + complementaire — projection a {ageR} ans</p>
    <div style={{display:'grid',gridTemplateColumns:'260px 1fr',gap:16}}>
      <div style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        {[{l:'Age: '+age,v:age,set:setAge,min:20,max:65},{l:'Brut: '+f2(brut),v:brut,set:setBrut,min:1800,max:10000,step:50},{l:'Annees: '+annees,v:annees,set:setAnnees,min:0,max:40}].map((s,i)=>
          <div key={i} style={{marginBottom:12}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>{s.l}</label><input type="range" min={s.min} max={s.max} step={s.step||1} value={s.v} onChange={e=>s.set(+e.target.value)} style={{width:'100%',accentColor:'#c6a34e'}}/></div>)}
        <label style={{display:'flex',alignItems:'center',gap:8,cursor:'pointer'}}><input type="checkbox" checked={ag} onChange={e=>setAg(e.target.checked)} style={{accentColor:'#c6a34e'}}/><span style={{fontSize:11,color:'#e5e5e5'}}>Assurance groupe ({cotAG}%)</span></label>
        {ag&&<input type="range" min={1} max={8} step={0.5} value={cotAG} onChange={e=>setCotAG(+e.target.value)} style={{width:'100%',accentColor:'#c6a34e',marginTop:6}}/>}
      </div>
      <div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:14}}>
          {[{l:'Pension legale/mois',v:f2(pensMens),c:'#3b82f6'},{l:'Rente AG/mois',v:f2(renteAG),c:'#22c55e'},{l:'Total/mois',v:f2(totalM),c:'#c6a34e'},{l:'Taux remplacement',v:taux+'%',c:taux>=70?'#22c55e':taux>=50?'#eab308':'#ef4444'}].map((k,i)=>
            <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}><div style={{fontSize:9,color:'#888'}}>{k.l}</div><div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v} EUR</div></div>)}
        </div>
        <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
          <div style={{padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Projection a {ageR} ans</div>
          {[{l:'Annees restantes',v:rest},{l:'Carriere totale',v:tot+'/45'},{l:'Pension legale/mois',v:f2(pensMens)+' EUR',c:'#3b82f6'},{l:'Capital AG',v:f2(capAG)+' EUR',c:'#22c55e'},{l:'TOTAL/MOIS',v:f2(totalM)+' EUR',c:'#c6a34e',b:true}].map((r,i)=>
            <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}><span style={{color:r.b?'#e5e5e5':'#888',fontWeight:r.b?600:400}}>{r.l}</span><span style={{color:r.c||'#e5e5e5',fontFamily:'monospace',fontWeight:r.b?700:400}}>{r.v}</span></div>)}
        </div>
      </div>
    </div>
  </div>;
};

const ConventionsCollectives=({})=>{
  const [selCP,setSelCP]=useState('200');
  const cps=[{id:'200',name:'CP 200 — Employes',n:'800K',ccts:[{num:'CCT 90',t:'Bonus non recurrent',d:'Max 4.020 EUR/an',tp:'avantage'},{num:'CCT eco',t:'Eco-cheques',d:'250 EUR/an max',tp:'avantage'},{num:'CCT teletravail',t:'Indemnite teletravail',d:'154,74 EUR/mois',tp:'avantage'},{num:'CCT formation',t:'Droit formation',d:'5j/an — Cefora',tp:'formation'},{num:'CCT credit-temps',t:'Credit-temps',d:'1/5, mi-temps, fin carriere',tp:'conge'}]},
    {id:'124',name:'CP 124 — Construction',n:'180K',ccts:[{num:'CCT mobilite',t:'Indemnite deplacement',d:'Forfait chantier',tp:'avantage'},{num:'CCT intemperies',t:'Chomage intemperies',d:'Regime special',tp:'conge'},{num:'CCT timbres',t:'Timbres fidelite',d:'Prime anciennete',tp:'avantage'}]},
    {id:'302',name:'CP 302 — Horeca',n:'140K',ccts:[{num:'CCT flexi',t:'Flexi-jobs',d:'28% cotisation',tp:'avantage'},{num:'CCT nuit',t:'Supplements nuit/dimanche',d:'Majorations',tp:'salaire'}]},
    {id:'330',name:'CP 330 — Sante',n:'250K',ccts:[{num:'CCT Maribel',t:'Maribel social',d:'Reduction cotisations',tp:'avantage'},{num:'CCT IFIC',t:'Classification IFIC',d:'Bareme sectoriel',tp:'salaire'}]}];
  const sel=cps.find(c=>c.id===selCP);const tc={avantage:'#22c55e',salaire:'#c6a34e',formation:'#3b82f6',conge:'#a855f7'};
  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📜 Conventions Collectives</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>CCT par commission paritaire</p>
    <div style={{display:'grid',gridTemplateColumns:'240px 1fr',gap:16}}>
      <div style={{display:'flex',flexDirection:'column',gap:6}}>
        {cps.map(c=><button key={c.id} onClick={()=>setSelCP(c.id)} style={{padding:12,borderRadius:10,border:selCP===c.id?'2px solid #c6a34e':'1px solid rgba(255,255,255,.05)',background:selCP===c.id?'rgba(198,163,78,.06)':'rgba(255,255,255,.02)',cursor:'pointer',textAlign:'left'}}><div style={{fontSize:11,fontWeight:600,color:selCP===c.id?'#c6a34e':'#e5e5e5'}}>CP {c.id}</div><div style={{fontSize:9,color:'#888'}}>{c.n} travailleurs</div></button>)}
      </div>
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'12px 16px',background:'rgba(198,163,78,.04)'}}><div style={{fontSize:14,fontWeight:700,color:'#c6a34e'}}>{sel?.name}</div></div>
        {sel?.ccts.map((c,i)=><div key={i} style={{padding:'12px 16px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:2}}><span style={{fontSize:8,padding:'2px 6px',borderRadius:4,background:(tc[c.tp]||'#888')+'15',color:tc[c.tp],fontWeight:600}}>{c.tp}</span><span style={{fontSize:12,fontWeight:600,color:'#e5e5e5'}}>{c.num}</span></div>
          <div style={{fontSize:12,color:'#c6a34e',fontWeight:500}}>{c.t}</div><div style={{fontSize:10,color:'#888'}}>{c.d}</div></div>)}
      </div>
    </div>
  </div>;
};

const GestionInterimaires=({s})=>{
  const [ints,setInts]=useState([]);const [showAdd,setShowAdd]=useState(false);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const agences=[{id:'randstad',n:'Randstad',c:'#0066cc'},{id:'adecco',n:'Adecco',c:'#ef4444'},{id:'manpower',n:'Manpower',c:'#3b82f6'},{id:'tempo',n:'Tempo-Team',c:'#22c55e'},{id:'start',n:'Start People',c:'#eab308'}];
  const [ni,setNi]=useState({first:'',last:'',agence:'randstad',brutH:15.50,heures:152,coeff:2.0,motif:'remplacement'});
  const addI=()=>{if(!ni.first)return;const b=Math.round(ni.brutH*ni.heures*100)/100;setInts(p=>[...p,{...ni,id:Date.now(),brut:b,cout:Math.round(b*ni.coeff*100)/100}]);setShowAdd(false);setNi({first:'',last:'',agence:'randstad',brutH:15.50,heures:152,coeff:2.0,motif:'remplacement'});};
  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div><h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>👷 Interimaires</h2><p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Agences, coefficients, couts — {ints.length} actifs</p></div>
      <button onClick={()=>setShowAdd(true)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>+ Interimaire</button></div>
    {ints.length>0&&<div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:10,marginBottom:14}}>
      {[{l:'Brut total',v:f2(ints.reduce((a,i)=>a+i.brut,0))+' EUR',c:'#e5e5e5'},{l:'Cout agences',v:f2(ints.reduce((a,i)=>a+i.cout,0))+' EUR',c:'#ef4444'},{l:'Coeff. moyen',v:'x'+Math.round(ints.reduce((a,i)=>a+i.coeff,0)/ints.length*100)/100,c:'#c6a34e'}].map((k,i)=>
        <div key={i} style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:10,textAlign:'center'}}><div style={{fontSize:9,color:'#888'}}>{k.l}</div><div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div></div>)}</div>}
    {ints.map((it,i)=>{const ag=agences.find(a=>a.id===it.agence);return <div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
      <div style={{width:8,height:8,borderRadius:'50%',background:ag?.c}}/><div style={{flex:1}}><div style={{color:'#e5e5e5',fontWeight:600}}>{it.first} {it.last}</div><div style={{fontSize:9,color:'#888'}}>{ag?.n} — {it.motif} — {it.heures}h</div></div>
      <span style={{color:'#888'}}>{f2(it.brutH)}/h</span><span style={{color:'#c6a34e'}}>x{it.coeff}</span><span style={{fontWeight:700,color:'#ef4444',fontFamily:'monospace'}}>{f2(it.cout)} EUR</span>
      <button onClick={()=>setInts(p=>p.filter((_,j)=>j!==i))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer'}}>✕</button></div>;})}
    {ints.length===0&&<div style={{textAlign:'center',padding:30,color:'#888',fontSize:12}}>Aucun interimaire</div>}
    {showAdd&&<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.6)',zIndex:999,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={()=>setShowAdd(false)}>
      <div onClick={e=>e.stopPropagation()} style={{background:'#0d1117',border:'1px solid rgba(198,163,78,.2)',borderRadius:16,padding:24,width:440}}>
        <h3 style={{fontSize:16,fontWeight:700,color:'#c6a34e',marginBottom:14}}>Nouvel interimaire</h3>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:10}}>
          {[{l:'Prenom',k:'first',t:'text'},{l:'Nom',k:'last',t:'text'},{l:'Brut/h',k:'brutH',t:'number'},{l:'Heures/mois',k:'heures',t:'number'},{l:'Coefficient',k:'coeff',t:'number'}].map((field,i)=>
            <div key={i}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>{field.l}</label><input type={field.t} value={ni[field.k]} onChange={e=>setNi(p=>({...p,[field.k]:field.t==='number'?+e.target.value:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>)}
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Agence</label><select value={ni.agence} onChange={e=>setNi(p=>({...p,agence:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>{agences.map(a=><option key={a.id} value={a.id}>{a.n}</option>)}</select></div>
        </div>
        <div style={{display:'flex',gap:8,marginTop:10}}><button onClick={addI} style={{flex:1,padding:'10px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>Ajouter</button><button onClick={()=>setShowAdd(false)} style={{padding:'10px 16px',borderRadius:8,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'#888',fontSize:12,cursor:'pointer'}}>Annuler</button></div>
      </div></div>}
  </div>;
};

const EcheancierPaiements=({s})=>{
  const clients=s.clients||[];
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const [selTrimestre,setSelTrimestre]=useState(0);
  const year=new Date().getFullYear();
  const totalBrut=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+(+(e.monthlySalary||e.gross||0)),0),0);
  const totalNet=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>{const br=+(e.monthlySalary||e.gross||0);return b+quickNet(br);},0),0);
  const onssE=Math.round(totalBrut*TX_ONSS_E*100)/100;
  const onssW=Math.round(totalBrut*TX_ONSS_W*100)/100;
  const allEmps=clients.flatMap(c=>c.emps||[]);
  const pp=allEmps.length>0?allEmps.reduce((a,e)=>a+quickPP(+(e.monthlySalary||e.gross||0)),0):Math.round((totalBrut-onssW)*PP_EST*100)/100;
  const trimestres=[{label:'T1 Jan-Mar',months:[0,1,2]},{label:'T2 Avr-Jun',months:[3,4,5]},{label:'T3 Jul-Sep',months:[6,7,8]},{label:'T4 Oct-Dec',months:[9,10,11]}];
  const moisNoms=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const genPay=(mi)=>{
    const m=mi+1;const sp=[];
    if(mi===5)sp.push({label:'Pecule vacances',amount:Math.round(totalBrut*0.85*100)/100,date:m+'/06',color:'#ec4899'});
    if(mi===11)sp.push({label:'13eme mois',amount:totalBrut,date:'20/12',color:'#ec4899'});
    return [{label:'Salaires nets',amount:totalNet,date:'25/'+String(m).padStart(2,'0'),color:'#22c55e'},
      {label:'ONSS travailleur',amount:onssW,date:'05/'+String(m+1>12?1:m+1).padStart(2,'0'),color:'#ef4444'},
      {label:'ONSS employeur',amount:onssE,date:'05/'+String(m+1>12?1:m+1).padStart(2,'0'),color:'#ef4444'},
      {label:'Precompte prof.',amount:pp,date:'15/'+String(m+1>12?1:m+1).padStart(2,'0'),color:'#eab308'},...sp];
  };
  const selT=trimestres[selTrimestre];
  const allPay=selT.months.flatMap(m=>genPay(m).map(p=>({...p,month:moisNoms[m]})));
  const totalT=allPay.reduce((a,p)=>a+p.amount,0);
  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>💳 Echeancier Paiements</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 16px'}}>Calendrier flux sortants — salaires, ONSS, PP</p>
    <div style={{display:'flex',gap:6,marginBottom:16}}>
      {trimestres.map((t,i)=><button key={i} onClick={()=>setSelTrimestre(i)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:selTrimestre===i?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:selTrimestre===i?'#c6a34e':'#888',fontSize:11,fontWeight:selTrimestre===i?600:400,cursor:'pointer'}}>{t.label}</button>)}
    </div>
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Total trimestre',v:f2(totalT),c:'#c6a34e'},{l:'Salaires nets',v:f2(totalNet*3),c:'#22c55e'},{l:'ONSS total',v:f2((onssW+onssE)*3),c:'#ef4444'},{l:'PP total',v:f2(pp*3),c:'#eab308'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div><div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v} EUR</div>
        </div>)}
    </div>
    {selT.months.map(m=><div key={m} style={{marginBottom:10}}>
      <div style={{fontSize:11,fontWeight:600,color:'#c6a34e',padding:'6px 0',borderBottom:'1px solid rgba(198,163,78,.08)'}}>{moisNoms[m]} {year}</div>
      {genPay(m).map((p,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 12px',borderBottom:'1px solid rgba(255,255,255,.02)'}}>
        <div style={{width:8,height:8,borderRadius:'50%',background:p.color}}/><div style={{flex:1,fontSize:11,color:'#e5e5e5'}}>{p.label}</div>
        <span style={{fontSize:9,color:'#888',padding:'2px 6px',borderRadius:4,background:'rgba(255,255,255,.03)'}}>{p.date}/{year}</span>
        <span style={{fontSize:12,fontWeight:700,color:p.color,fontFamily:'monospace',minWidth:100,textAlign:'right'}}>{f2(p.amount)}</span>
      </div>)}
    </div>)}
  </div>;
};

// ═══ 2. SIMULATEUR TEMPS PARTIEL ═══
const SimuTempsPartiel=({s})=>{
  const [regime]=useState(38);const [heures,setHeures]=useState(19);const [brutTP,setBrutTP]=useState(3500);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const fraction=heures/regime;const brutP=Math.round(brutTP*fraction*100)/100;
  const onssW=Math.round(brutP*TX_ONSS_W*100)/100;const pp=quickPP(brutP);
  const net=Math.round((brutP-onssW-pp)*100)/100;const coutT=Math.round(brutP*(1+TX_ONSS_E)*100)/100;
  const netFT=Math.round((quickNet(brutTP))*100)/100;
  const regimes=[{h:38,l:'Temps plein'},{h:30.4,l:'4/5eme'},{h:28.5,l:'3/4'},{h:19,l:'Mi-temps'},{h:12.67,l:'1/3'},{h:7.6,l:'1/5eme'}];
  const droits=[{l:'Congés payés',v:Math.round(20*fraction)+'j/20j',p:fraction*100},{l:'Pecule vacances',v:f2(brutP*PV_SIMPLE)+' EUR',p:fraction*100},{l:'Pension legale',v:'Prorata '+Math.round(fraction*100)+'%',p:fraction*100},{l:'Chomage',v:fraction>=0.33?'Maintenu':'Risque',p:fraction>=0.33?100:30}];
  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>⏱ Simulateur Temps Partiel</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Impact rémunération et droits sociaux</p>
    <div style={{display:'grid',gridTemplateColumns:'260px 1fr',gap:16}}>
      <div style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{marginBottom:12}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Brut temps plein: {f2(brutTP)} EUR</label>
          <input type="range" min={1800} max={8000} step={50} value={brutTP} onChange={e=>setBrutTP(+e.target.value)} style={{width:'100%',accentColor:'#c6a34e'}}/></div>
        <div style={{fontSize:10,color:'#888',marginBottom:6}}>Regime horaire</div>
        {regimes.map(r=><button key={r.h} onClick={()=>setHeures(r.h)} style={{display:'block',width:'100%',padding:'6px 10px',marginBottom:3,borderRadius:6,border:heures===r.h?'1px solid #c6a34e':'1px solid rgba(255,255,255,.05)',background:heures===r.h?'rgba(198,163,78,.08)':'transparent',color:heures===r.h?'#c6a34e':'#888',fontSize:10,cursor:'pointer',textAlign:'left'}}>{r.l} ({r.h}h)</button>)}
        <div style={{marginTop:10,padding:8,background:'rgba(198,163,78,.04)',borderRadius:6,fontSize:10,color:'#888'}}>Fraction: <span style={{color:'#c6a34e',fontWeight:700}}>{Math.round(fraction*10000)/100}%</span></div>
      </div>
      <div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:14}}>
          <div style={{padding:14,border:'1px solid rgba(255,255,255,.05)',borderRadius:12}}>
            <div style={{fontSize:10,color:'#888',marginBottom:6}}>TEMPS PLEIN</div>
            {[{l:'Brut',v:f2(brutTP)},{l:'Net',v:f2(netFT)},{l:'Cout',v:f2(Math.round(brutTP*(1+TX_ONSS_E)*100)/100)}].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'3px 0',fontSize:11}}><span style={{color:'#888'}}>{r.l}</span><span style={{fontFamily:'monospace'}}>{r.v}</span></div>)}
          </div>
          <div style={{padding:14,border:'2px solid rgba(198,163,78,.2)',borderRadius:12,background:'rgba(198,163,78,.02)'}}>
            <div style={{fontSize:10,color:'#c6a34e',fontWeight:600,marginBottom:6}}>TEMPS PARTIEL ({heures}h)</div>
            {[{l:'Brut',v:f2(brutP),c:'#e5e5e5'},{l:'ONSS',v:'-'+f2(onssW),c:'#ef4444'},{l:'PP',v:'-'+f2(pp),c:'#eab308'},{l:'Net',v:f2(net),c:'#22c55e'},{l:'Cout',v:f2(coutT),c:'#c6a34e'}].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'3px 0',fontSize:11}}><span style={{color:'#888'}}>{r.l}</span><span style={{color:r.c,fontFamily:'monospace',fontWeight:600}}>{r.v}</span></div>)}
          </div>
        </div>
        <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
          <div style={{padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Impact droits sociaux</div>
          {droits.map((d,i)=><div key={i} style={{padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:11,marginBottom:3}}><span style={{color:'#e5e5e5'}}>{d.l}</span><span style={{color:d.p>=80?'#22c55e':d.p>=50?'#eab308':'#ef4444',fontWeight:600}}>{d.v}</span></div>
            <div style={{height:4,background:'rgba(255,255,255,.05)',borderRadius:2}}><div style={{height:'100%',width:Math.min(d.p,100)+'%',background:d.p>=80?'#22c55e':d.p>=50?'#eab308':'#ef4444',borderRadius:2}}/></div>
          </div>)}
        </div>
      </div>
    </div>
  </div>;
};

// ═══ 3. GESTION DÉLÉGATIONS SYNDICALES ═══
const GestionDelegations=({s})=>{
  const clients=s.clients||[];const [selClient,setSelClient]=useState(0);const cl=clients[selClient];const emps=cl?.emps||[];
  const [delegues,setDelegues]=useState([]);const [showAdd,setShowAdd]=useState(false);
  const [newDel,setNewDel]=useState({empIndex:0,syndicat:'FGTB',mandat:'delegue',creditHeures:4});
  const syndicats=[{id:'FGTB',name:'FGTB/ABVV',color:'#ef4444',icon:'🔴'},{id:'CSC',name:'CSC/ACV',color:'#22c55e',icon:'🟢'},{id:'CGSLB',name:'CGSLB/ACLVB',color:'#3b82f6',icon:'🔵'}];
  const mandats=[{id:'delegue',label:'Delegue syndical'},{id:'cppt',label:'Membre CPPT'},{id:'ce',label:'Membre CE'},{id:'suppleant',label:'Suppleant'}];
  const addDel=()=>{const emp=emps[newDel.empIndex];if(!emp)return;setDelegues(p=>[...p,{...newDel,id:Date.now(),name:(emp.first||'')+' '+(emp.last||'')}]);setShowAdd(false);};
  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div><h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🏛 Delegations Syndicales</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Credit heures, mandats, protection licenciement</p></div>
      <div style={{display:'flex',gap:8}}>
        <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>{clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}</select>
        <button onClick={()=>setShowAdd(true)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>+ Delegue</button>
      </div>
    </div>
    <div style={{padding:14,background:'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12,marginBottom:16}}>
      <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:6}}>Seuils legaux (effectif: {emps.length})</div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8,fontSize:10}}>
        {[{l:'CPPT',s:50},{l:'Conseil entreprise',s:100},{l:'Delegation syndicale',s:null}].map((s,i)=><div key={i} style={{padding:8,borderRadius:6,border:'1px solid '+(s.s&&emps.length>=s.s?'rgba(34,197,94,.2)':'rgba(255,255,255,.05)')}}><div style={{fontWeight:600,color:s.s&&emps.length>=s.s?'#22c55e':'#888'}}>{s.l}</div><div style={{color:'#888'}}>{s.s?'Seuil: '+s.s+' '+(emps.length>=s.s?'✅':'❌'):'Selon CCT'}</div></div>)}
      </div>
    </div>
    {delegues.length>0?<div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      {delegues.map((d,i)=>{const syn=syndicats.find(s=>s.id===d.syndicat);return <div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
        <span>{syn?.icon}</span><div style={{flex:1}}><div style={{color:'#e5e5e5',fontWeight:600}}>{d.name}</div><div style={{fontSize:9,color:'#888'}}>{syn?.name} — {mandats.find(m=>m.id===d.mandat)?.label}</div></div>
        <span style={{fontSize:10,color:'#c6a34e'}}>{d.creditHeures}h/sem</span>
        <span style={{fontSize:8,padding:'2px 6px',borderRadius:4,background:'rgba(239,68,68,.1)',color:'#ef4444'}}>🛡 Protege</span>
        <button onClick={()=>setDelegues(p=>p.filter((_,j)=>j!==i))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer'}}>✕</button>
      </div>;})}
    </div>:<div style={{textAlign:'center',padding:30,color:'#888',fontSize:12}}>Aucun delegue enregistre</div>}
    <div style={{marginTop:14,padding:14,background:'rgba(239,68,68,.03)',border:'1px solid rgba(239,68,68,.1)',borderRadius:12}}>
      <div style={{fontSize:12,fontWeight:600,color:'#ef4444',marginBottom:4}}>🛡 Protection (Loi 19/03/1991)</div>
      <div style={{fontSize:10,color:'#888'}}>Licenciement interdit sauf motif grave reconnu ou raisons eco/techniques acceptees par la CP. Indemnite = rémunération restante du mandat + 2 a 4 ans.</div>
    </div>
    {showAdd&&<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.6)',zIndex:999,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={()=>setShowAdd(false)}>
      <div onClick={e=>e.stopPropagation()} style={{background:'#0d1117',border:'1px solid rgba(198,163,78,.2)',borderRadius:16,padding:24,width:400}}>
        <h3 style={{fontSize:16,fontWeight:700,color:'#c6a34e',marginBottom:14}}>Nouveau delegue</h3>
        <div style={{marginBottom:10}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Employé</label><select value={newDel.empIndex} onChange={e=>setNewDel(p=>({...p,empIndex:+e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>{emps.map((e,i)=><option key={i} value={i}>{(e.first||'')} {(e.last||'')}</option>)}</select></div>
        <div style={{marginBottom:10}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Syndicat</label><div style={{display:'flex',gap:4}}>{syndicats.map(s=><button key={s.id} onClick={()=>setNewDel(p=>({...p,syndicat:s.id}))} style={{flex:1,padding:'8px',borderRadius:6,border:newDel.syndicat===s.id?'1px solid '+s.color:'1px solid rgba(255,255,255,.05)',background:newDel.syndicat===s.id?s.color+'10':'transparent',color:newDel.syndicat===s.id?s.color:'#888',fontSize:10,cursor:'pointer'}}>{s.icon} {s.id}</button>)}</div></div>
        <div style={{marginBottom:10}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Mandat</label><select value={newDel.mandat} onChange={e=>setNewDel(p=>({...p,mandat:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>{mandats.map(m=><option key={m.id} value={m.id}>{m.label}</option>)}</select></div>
        <div style={{marginBottom:14}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Credit heures/sem</label><input type="number" value={newDel.creditHeures} onChange={e=>setNewDel(p=>({...p,creditHeures:+e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
        <div style={{display:'flex',gap:8}}><button onClick={addDel} style={{flex:1,padding:'10px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>Ajouter</button><button onClick={()=>setShowAdd(false)} style={{padding:'10px 16px',borderRadius:8,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'#888',fontSize:12,cursor:'pointer'}}>Annuler</button></div>
      </div>
    </div>}
  </div>;
};

// ═══ 4. TABLEAU CHARGES SOCIALES ONSS ═══
const TableauChargesSociales=({s})=>{
  const clients=s.clients||[];const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const [selYear,setSelYear]=useState(new Date().getFullYear());
  const trims=['T1','T2','T3','T4'];
  const totalBrut=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+(+(e.monthlySalary||e.gross||0)),0),0);
  const totalEmps=clients.reduce((a,c)=>a+(c.emps||[]).length,0);
  const trimData=trims.map(()=>{
    const b=Math.round(totalBrut*3*100)/100;const ow=Math.round(b*TX_ONSS_W*100)/100;const oe=Math.round(b*TX_ONSS_E*100)/100;
    const mar=totalEmps>=5?Math.round(totalEmps*480*100)/100:0;
    return {brut:b,onssW:ow,onssE:oe,total:Math.round((ow+oe)*100)/100,maribel:mar,net:Math.round((ow+oe-mar)*100)/100};
  });
  const ann={brut:trimData.reduce((a,t)=>a+t.brut,0),total:trimData.reduce((a,t)=>a+t.total,0),mar:trimData.reduce((a,t)=>a+t.maribel,0)};
  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div><h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🏛 Charges Sociales ONSS</h2><p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Vue trimestrielle + reductions Maribel + DmfA</p></div>
      <div style={{display:'flex',gap:4}}>{[2024,2025,2026].map(y=><button key={y} onClick={()=>setSelYear(y)} style={{padding:'6px 12px',borderRadius:6,border:'none',background:selYear===y?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:selYear===y?'#c6a34e':'#888',fontSize:11,cursor:'pointer'}}>{y}</button>)}</div>
    </div>
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Masse salariale',v:f2(ann.brut),c:'#e5e5e5'},{l:'ONSS total',v:f2(ann.total),c:'#ef4444'},{l:'Maribel',v:'-'+f2(ann.mar),c:'#22c55e'},{l:'ONSS net',v:f2(ann.total-ann.mar),c:'#c6a34e'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div><div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v} EUR</div></div>)}
    </div>
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'80px repeat(5,1fr)',padding:'8px 14px',background:'rgba(198,163,78,.06)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
        <div>Trim.</div><div>Masse sal.</div><div>ONSS W</div><div>ONSS E</div><div>Maribel</div><div>ONSS Net</div></div>
      {trimData.map((t,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'80px repeat(5,1fr)',padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
        <div style={{fontWeight:600,color:'#c6a34e'}}>{trims[i]} {selYear}</div>
        <div style={{fontFamily:'monospace'}}>{f2(t.brut)}</div><div style={{fontFamily:'monospace',color:'#ef4444'}}>{f2(t.onssW)}</div>
        <div style={{fontFamily:'monospace',color:'#ef4444'}}>{f2(t.onssE)}</div><div style={{fontFamily:'monospace',color:'#22c55e'}}>-{f2(t.maribel)}</div>
        <div style={{fontFamily:'monospace',fontWeight:700,color:'#c6a34e'}}>{f2(t.net)}</div>
      </div>)}
    </div>
  </div>;
};

const PlanifCongesEquipe=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const [month,setMonth]=useState(new Date().getMonth());
  const [year,setYear]=useState(new Date().getFullYear());
  const [conges,setConges]=useState({});
  const cl=clients[selClient];
  const emps=cl?.emps||[];
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const daysInMonth=new Date(year,month+1,0).getDate();
  const today=new Date();

  const congeTypes=[
    {id:'conge',label:'Conge',color:'#22c55e',short:'C'},
    {id:'maladie',label:'Maladie',color:'#ef4444',short:'M'},
    {id:'formation',label:'Formation',color:'#3b82f6',short:'F'},
    {id:'teletravail',label:'Teletravail',color:'#a855f7',short:'T'},
    {id:'recuperation',label:'Recuperation',color:'#eab308',short:'R'},
  ];

  const toggle=(empIdx,day,type)=>{
    const key=empIdx+'_'+year+'_'+month+'_'+day;
    setConges(p=>{
      if(p[key]?.type===type)return {...p,[key]:undefined};
      return {...p,[key]:{type}};
    });
  };

  // Count per day
  const dayAbsences=(day)=>{
    let count=0;
    emps.forEach((_,i)=>{const k=i+'_'+year+'_'+month+'_'+day;if(conges[k])count++;});
    return count;
  };

  const [selType,setSelType]=useState('conge');

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📅 Planning Conges Equipe</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Vue Gantt — detection conflits automatique</p>
      </div>
      <div style={{display:'flex',gap:6,alignItems:'center'}}>
        <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
        </select>
        <button onClick={()=>{if(month===0){setMonth(11);setYear(y=>y-1);}else setMonth(m=>m-1);}} style={{padding:'5px 8px',borderRadius:6,border:'none',background:'rgba(255,255,255,.05)',color:'#c6a34e',cursor:'pointer'}}>◀</button>
        <span style={{fontSize:12,fontWeight:600,color:'#e5e5e5',minWidth:100,textAlign:'center'}}>{mois[month]} {year}</span>
        <button onClick={()=>{if(month===11){setMonth(0);setYear(y=>y+1);}else setMonth(m=>m+1);}} style={{padding:'5px 8px',borderRadius:6,border:'none',background:'rgba(255,255,255,.05)',color:'#c6a34e',cursor:'pointer'}}>▶</button>
      </div>
    </div>

    {/* Type selector */}
    <div style={{display:'flex',gap:6,marginBottom:12}}>
      {congeTypes.map(t=><button key={t.id} onClick={()=>setSelType(t.id)} style={{display:'flex',alignItems:'center',gap:4,padding:'5px 10px',borderRadius:6,border:selType===t.id?'1px solid '+t.color:'1px solid rgba(255,255,255,.05)',background:selType===t.id?t.color+'12':'transparent',cursor:'pointer',fontSize:10,color:selType===t.id?t.color:'#888'}}>
        <div style={{width:8,height:8,borderRadius:2,background:t.color}}/>{t.label}
      </button>)}
    </div>

    {/* Gantt grid */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden',overflowX:'auto'}}>
      <div style={{display:'grid',gridTemplateColumns:'140px repeat('+daysInMonth+',1fr)',minWidth:140+daysInMonth*28}}>
        {/* Header */}
        <div style={{padding:'6px 10px',background:'rgba(198,163,78,.06)',fontSize:10,fontWeight:600,color:'#c6a34e',position:'sticky',left:0,zIndex:2,background:'#0d1117'}}>Employé</div>
        {Array.from({length:daysInMonth},(_,i)=>{
          const d=new Date(year,month,i+1);
          const isWE=d.getDay()===0||d.getDay()===6;
          const isToday=d.toDateString()===today.toDateString();
          const absCount=dayAbsences(i+1);
          const conflict=absCount>=Math.max(2,Math.ceil(emps.length*0.4));
          return <div key={i} style={{padding:'4px 0',textAlign:'center',fontSize:8,background:isToday?'rgba(198,163,78,.1)':isWE?'rgba(0,0,0,.3)':'rgba(198,163,78,.02)',color:conflict?'#ef4444':isToday?'#c6a34e':'#888',borderBottom:conflict?'2px solid #ef4444':'none'}}>
            <div style={{fontWeight:isToday?700:400}}>{i+1}</div>
            {absCount>0&&<div style={{fontSize:7,color:conflict?'#ef4444':'#888'}}>{absCount}</div>}
          </div>;
        })}
        {/* Employee rows */}
        {emps.map((e,ei)=><>
          <div key={'n'+ei} style={{padding:'4px 10px',fontSize:10,color:'#e5e5e5',fontWeight:500,position:'sticky',left:0,zIndex:1,background:'#0d1117',borderBottom:'1px solid rgba(255,255,255,.03)',display:'flex',alignItems:'center'}}>{(e.first||'')[0]}. {e.last||e.ln||''}</div>
          {Array.from({length:daysInMonth},(_,i)=>{
            const d=new Date(year,month,i+1);
            const isWE=d.getDay()===0||d.getDay()===6;
            const k=ei+'_'+year+'_'+month+'_'+(i+1);
            const c=conges[k];
            const ct=c?congeTypes.find(t=>t.id===c.type):null;
            return <div key={i} onClick={()=>{if(!isWE)toggle(ei,i+1,selType);}} style={{height:24,display:'flex',alignItems:'center',justifyContent:'center',background:isWE?'rgba(0,0,0,.3)':c?ct?.color+'25':'transparent',borderBottom:'1px solid rgba(255,255,255,.02)',borderRight:'1px solid rgba(255,255,255,.02)',cursor:isWE?'default':'pointer',fontSize:8,fontWeight:700,color:ct?.color||'transparent'}}>
              {c&&ct?.short}
            </div>;
          })}
        </>)}
      </div>
    </div>
  </div>;
};

// ═══ 2. REGISTRE DU PERSONNEL — Obligation légale belge ═══
const RegistrePersonnel=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const cl=clients[selClient];
  const co=cl?.company||{};
  const emps=cl?.emps||[];
  const now=new Date();

  const generateRegistreHTML=()=>{
    let html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:10px;padding:20px;max-width:1100px;margin:auto}h1{font-size:16px;text-align:center;margin:12px 0}table{width:100%;border-collapse:collapse;margin:8px 0;page-break-inside:auto}th{background:#f5f1e8;padding:5px 6px;font-size:8px;border:1px solid #ddd;text-align:center}td{padding:4px 6px;border:1px solid #eee;font-size:9px}.header{text-align:center;margin-bottom:15px}@media print{button{display:none!important}}</style></head><body>';
    html+='<div class="header"><div style="font-size:20px;font-weight:800;color:#c6a34e">AUREUS SOCIAL PRO</div>';
    html+='<h1>REGISTRE GENERAL DU PERSONNEL</h1>';
    html+='<div style="font-size:10px;color:#888">'+co.name+' — BCE: '+(co.vat||'N/A')+' — CP: '+(co.cp||'200')+'</div>';
    html+='<div style="font-size:9px;color:#aaa">Conformement a l\'AR du 8 aout 1980 — Généré le '+now.toLocaleDateString('fr-BE')+'</div></div>';

    html+='<table><tr><th>N°</th><th>Nom</th><th>Prenom</th><th>NISS</th><th>Sexe</th><th>Nationalite</th><th>Date naissance</th><th>Adresse</th><th>Debut contrat</th><th>Type</th><th>Temps</th><th>Fonction</th><th>Brut</th><th>Fin</th></tr>';
    emps.forEach((e,i)=>{
      html+='<tr><td style="text-align:center">'+(i+1)+'</td>';
      html+='<td><strong>'+(e.last||e.ln||'')+'</strong></td>';
      html+='<td>'+(e.first||e.fn||'')+'</td>';
      html+='<td style="font-family:monospace">'+(e.niss||e.NISS||'—')+'</td>';
      html+='<td style="text-align:center">'+(e.gender||e.sexe||'—')+'</td>';
      html+='<td>'+(e.nationality||'Belge')+'</td>';
      html+='<td>'+(e.birthDate||'—')+'</td>';
      html+='<td>'+(e.address||'—')+'</td>';
      html+='<td>'+(e.startDate||e.start||'—')+'</td>';
      html+='<td style="text-align:center">'+(e.contractType||'CDI')+'</td>';
      html+='<td style="text-align:center">'+(e.whWeek||38)+'h</td>';
      html+='<td>'+(e.function||e.titre||'Employé')+'</td>';
      html+='<td style="text-align:right;font-family:monospace">'+f2(+(e.monthlySalary||e.gross||0))+'</td>';
      html+='<td>'+(e.endDate||'—')+'</td></tr>';
    });
    html+='</table>';
    html+='<div style="margin-top:20px;font-size:9px;color:#888">Total: '+emps.length+' travailleurs inscrits | Document confidentiel</div>';
    html+='<div style="text-align:center;margin:15px"><button onclick="window.print()" style="background:#c6a34e;color:#fff;border:none;padding:10px 30px;border-radius:6px;cursor:pointer;font-weight:700">Imprimer / PDF</button></div>';
    html+='</body></html>';
    previewHTML(html,'Registre_Personnel_'+co.name);
  };

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📖 Registre du Personnel</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Obligation legale — AR du 8 aout 1980 — {emps.length} travailleurs</p>
      </div>
      <div style={{display:'flex',gap:8}}>
        <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
        </select>
        <button onClick={generateRegistreHTML} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>📄 Generer PDF</button>
      </div>
    </div>

    {/* Table */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'35px 120px 120px 110px 60px 80px 80px 70px 80px 50px',padding:'8px 10px',background:'rgba(198,163,78,.06)',fontSize:8,fontWeight:600,color:'#c6a34e'}}>
        <div>N°</div><div>Nom</div><div>Prenom</div><div>NISS</div><div>Contrat</div><div>Debut</div><div>Fonction</div><div>Regime</div><div>Brut</div><div>Statut</div>
      </div>
      {emps.map((e,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'35px 120px 120px 110px 60px 80px 80px 70px 80px 50px',padding:'6px 10px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:10,alignItems:'center'}}>
        <div style={{color:'#888',fontWeight:600}}>{i+1}</div>
        <div style={{color:'#e5e5e5',fontWeight:600}}>{e.last||e.ln||''}</div>
        <div style={{color:'#e5e5e5'}}>{e.first||e.fn||''}</div>
        <div style={{color:'#a855f7',fontFamily:'monospace',fontSize:9}}>{e.niss||e.NISS||'—'}</div>
        <span style={{fontSize:8,padding:'2px 5px',borderRadius:4,background:(e.contractType||'CDI')==='CDI'?'rgba(34,197,94,.1)':'rgba(234,179,8,.1)',color:(e.contractType||'CDI')==='CDI'?'#22c55e':'#eab308',textAlign:'center'}}>{e.contractType||'CDI'}</span>
        <div style={{color:'#888',fontSize:9}}>{e.startDate||e.start||'—'}</div>
        <div style={{color:'#888',fontSize:9}}>{e.function||e.titre||'Employé'}</div>
        <div style={{color:'#888',fontSize:9}}>{e.whWeek||38}h/sem</div>
        <div style={{color:'#c6a34e',fontFamily:'monospace',fontWeight:600}}>{f2(+(e.monthlySalary||e.gross||0))}</div>
        <div style={{width:8,height:8,borderRadius:'50%',background:e.endDate?'#ef4444':'#22c55e'}}/>
      </div>)}
    </div>
  </div>;
};

// ═══ 3. CALCUL INDEMNITÉS MALADIE — Salaire garanti belge ═══
const CalcMaladie=({s})=>{
  const [anciennete,setAnciennete]=useState(5);
  const [brutMensuel,setBrutMensuel]=useState(3500);
  const [joursAbsence,setJoursAbsence]=useState(30);
  const [statut,setStatut]=useState('employe');
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  // Salaire garanti belge
  const brutJour=Math.round(brutMensuel/22*100)/100;

  // Employes >= 1 mois ancienneté
  const periodes=statut==='employe'?[
    {label:'Jours 1-30',from:1,to:30,rate:100,payer:'employeur',color:'#22c55e'},
    {label:'Jours 31-60',from:31,to:60,rate:60,payer:'mutuelle',color:'#3b82f6'},
    {label:'Jours 61+',from:61,to:365,rate:60,payer:'mutuelle',color:'#a855f7'},
  ]:[
    {label:'Jours 1-7',from:1,to:7,rate:100,payer:'employeur',color:'#22c55e'},
    {label:'Jours 8-14',from:8,to:14,rate:85.88,payer:'employeur',color:'#eab308'},
    {label:'Jours 15-30',from:15,to:30,rate:85.88,payer:'employeur (25.88%) + mutuelle (60%)',color:'#f97316'},
    {label:'Jours 31+',from:31,to:365,rate:60,payer:'mutuelle',color:'#3b82f6'},
  ];

  const details=periodes.map(p=>{
    const daysInPeriod=Math.max(0,Math.min(joursAbsence,p.to)-Math.max(0,p.from-1));
    const montant=Math.round(daysInPeriod*brutJour*p.rate)/100;
    return {...p,days:daysInPeriod,montant};
  }).filter(p=>p.days>0);

  const coutEmployeur=details.filter(d=>d.payer.includes('employeur')).reduce((a,d)=>a+d.montant,0);
  const indMutuelle=details.filter(d=>d.payer.includes('mutuelle')).reduce((a,d)=>a+d.montant,0);

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🏥 Salaire Garanti & Maladie</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Calcul indemnites maladie belge — employeur + mutuelle</p>

    <div style={{display:'grid',gridTemplateColumns:'300px 1fr',gap:16}}>
      {/* Inputs */}
      <div style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{marginBottom:12}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Statut</label>
          <div style={{display:'flex',gap:4}}>
            {[{id:'employe',l:'Employé'},{id:'ouvrier',l:'Ouvrier'}].map(s=><button key={s.id} onClick={()=>setStatut(s.id)} style={{flex:1,padding:'8px',borderRadius:6,border:'none',background:statut===s.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:statut===s.id?'#c6a34e':'#888',fontSize:11,cursor:'pointer',fontWeight:statut===s.id?600:400}}>{s.l}</button>)}
          </div>
        </div>
        <div style={{marginBottom:12}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Brut mensuel: {f2(brutMensuel)} EUR</label>
          <input type="range" min={1800} max={8000} step={50} value={brutMensuel} onChange={e=>setBrutMensuel(+e.target.value)} style={{width:'100%',accentColor:'#c6a34e'}}/>
        </div>
        <div style={{marginBottom:12}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Jours absence: {joursAbsence}</label>
          <input type="range" min={1} max={120} value={joursAbsence} onChange={e=>setJoursAbsence(+e.target.value)} style={{width:'100%',accentColor:'#c6a34e'}}/>
        </div>
        <div style={{padding:10,background:'rgba(198,163,78,.04)',borderRadius:8,fontSize:10,color:'#888'}}>
          Brut/jour: <span style={{color:'#c6a34e',fontWeight:700}}>{f2(brutJour)} EUR</span>
        </div>
      </div>

      {/* Results */}
      <div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:10,marginBottom:14}}>
          {[{l:'Cout employeur',v:f2(coutEmployeur)+' EUR',c:'#ef4444'},{l:'Indemnite mutuelle',v:f2(indMutuelle)+' EUR',c:'#3b82f6'},{l:'Total travailleur',v:f2(coutEmployeur+indMutuelle)+' EUR',c:'#22c55e'}].map((k,i)=>
            <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
              <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
              <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
            </div>
          )}
        </div>

        {/* Timeline */}
        <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
          <div style={{padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Decomposition periodes</div>
          {details.map((d,i)=><div key={i} style={{padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
              <div style={{display:'flex',alignItems:'center',gap:6}}>
                <div style={{width:10,height:10,borderRadius:3,background:d.color}}/>
                <span style={{fontSize:12,fontWeight:600,color:'#e5e5e5'}}>{d.label}</span>
              </div>
              <span style={{fontSize:14,fontWeight:700,color:d.color}}>{f2(d.montant)} EUR</span>
            </div>
            <div style={{fontSize:10,color:'#888'}}>{d.days} jours x {f2(brutJour)} x {d.rate}% = {f2(d.montant)} EUR — <span style={{fontWeight:500}}>{d.payer}</span></div>
            <div style={{height:4,background:'rgba(255,255,255,.05)',borderRadius:2,marginTop:4,overflow:'hidden'}}>
              <div style={{height:'100%',width:d.rate+'%',background:d.color,borderRadius:2}}/>
            </div>
          </div>)}
        </div>
      </div>
    </div>
  </div>;
};

// ═══ 4. DASHBOARD COÛTS SALARIAUX ANNUEL ═══
const DashCoutsAnnuel=({s})=>{
  const clients=s.clients||[];
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const mois=['Jan','Fev','Mar','Avr','Mai','Jun','Jul','Aou','Sep','Oct','Nov','Dec'];
  const now=new Date();
  const year=now.getFullYear();

  const totalMensuel=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+(+(e.monthlySalary||e.gross||0)),0),0);
  const totalEmpCount=clients.reduce((a,c)=>a+(c.emps||[]).length,0);

  // Monthly breakdown
  const monthly=mois.map((_,i)=>{
    const base=totalMensuel;
    const brut=Math.round(base*(0.95+Math.random()*0.1)*100)/100;
    const onssW=Math.round(brut*TX_ONSS_W*100)/100;
    const onssE=Math.round(brut*TX_ONSS_E*100)/100;
    const pp=quickPP(brut);
    const net=Math.round((brut-onssW-pp)*100)/100;
    const extras=Math.round(brut*0.02*100)/100; // cheq repas etc
    const coutTotal=Math.round((brut+onssE+extras)*100)/100;
    const special=i===5?{label:'Pecule vacances',amount:Math.round(brut*0.85*100)/100}:i===11?{label:'13eme mois',amount:brut}:null;
    return {month:mois[i],brut,onssW,onssE,pp,net,extras,coutTotal,special};
  });

  const totalAnnuel=monthly.reduce((a,m)=>a+m.coutTotal+(m.special?.amount||0),0);
  const maxCout=Math.max(...monthly.map(m=>m.coutTotal+(m.special?.amount||0)));

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📊 Couts Salariaux Annuels</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>{year} — {totalEmpCount} employes — {clients.length} clients</p>

    <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Cout annuel total',v:f2(totalAnnuel)+' EUR',c:'#c6a34e'},{l:'Brut annuel',v:f2(monthly.reduce((a,m)=>a+m.brut,0))+' EUR',c:'#e5e5e5'},{l:'ONSS E annuel',v:f2(monthly.reduce((a,m)=>a+m.onssE,0))+' EUR',c:'#ef4444'},{l:'Net annuel',v:f2(monthly.reduce((a,m)=>a+m.net,0))+' EUR',c:'#22c55e'},{l:'Cout moyen/mois',v:f2(totalAnnuel/12)+' EUR',c:'#3b82f6'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:8,color:'#888'}}>{k.l}</div>
          <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    {/* Monthly chart */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:16,marginBottom:14}}>
      <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Decomposition mensuelle {year}</div>
      <div style={{display:'flex',alignItems:'flex-end',gap:4,height:160}}>
        {monthly.map((m,i)=>{
          const total=m.coutTotal+(m.special?.amount||0);
          const pct=maxCout>0?(total/maxCout*100):0;
          return <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:2}}>
            {m.special&&<div style={{fontSize:7,color:'#ec4899',fontWeight:600}}>{m.special.label}</div>}
            <div style={{fontSize:7,color:'#888'}}>{f2(total)}</div>
            <div style={{width:'100%',display:'flex',flexDirection:'column',height:pct+'%',minHeight:4}}>
              {m.special&&<div style={{height:Math.round(m.special.amount/total*100)+'%',background:'#ec4899',borderRadius:'3px 3px 0 0'}}/>}
              <div style={{flex:1,background:'linear-gradient(180deg,#c6a34e,rgba(198,163,78,.3))',borderRadius:m.special?0:'3px 3px 0 0'}}/>
            </div>
            <div style={{fontSize:8,color:i===now.getMonth()?'#c6a34e':'#888',fontWeight:i===now.getMonth()?700:400}}>{m.month}</div>
          </div>;
        })}
      </div>
    </div>

    {/* Monthly table */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'60px repeat(7,1fr)',padding:'6px 10px',background:'rgba(198,163,78,.04)',fontSize:8,fontWeight:600,color:'#c6a34e'}}>
        <div>Mois</div><div>Brut</div><div>ONSS W</div><div>ONSS E</div><div>PP</div><div>Net</div><div>Special</div><div>Coût total</div>
      </div>
      {monthly.map((m,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'60px repeat(7,1fr)',padding:'5px 10px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:10,background:i===now.getMonth()?'rgba(198,163,78,.03)':'transparent'}}>
        <div style={{fontWeight:600,color:i===now.getMonth()?'#c6a34e':'#e5e5e5'}}>{m.month}</div>
        <div style={{fontFamily:'monospace'}}>{f2(m.brut)}</div>
        <div style={{fontFamily:'monospace',color:'#ef4444'}}>{f2(m.onssW)}</div>
        <div style={{fontFamily:'monospace',color:'#ef4444'}}>{f2(m.onssE)}</div>
        <div style={{fontFamily:'monospace',color:'#eab308'}}>{f2(m.pp)}</div>
        <div style={{fontFamily:'monospace',color:'#22c55e'}}>{f2(m.net)}</div>
        <div style={{fontFamily:'monospace',color:'#ec4899'}}>{m.special?f2(m.special.amount):'—'}</div>
        <div style={{fontFamily:'monospace',fontWeight:700,color:'#c6a34e'}}>{f2(m.coutTotal+(m.special?.amount||0))}</div>
      </div>)}
      <div style={{display:'grid',gridTemplateColumns:'60px repeat(7,1fr)',padding:'6px 10px',background:'rgba(198,163,78,.06)',fontSize:10,fontWeight:700}}>
        <div style={{color:'#c6a34e'}}>TOTAL</div>
        <div style={{fontFamily:'monospace'}}>{f2(monthly.reduce((a,m)=>a+m.brut,0))}</div>
        <div style={{fontFamily:'monospace',color:'#ef4444'}}>{f2(monthly.reduce((a,m)=>a+m.onssW,0))}</div>
        <div style={{fontFamily:'monospace',color:'#ef4444'}}>{f2(monthly.reduce((a,m)=>a+m.onssE,0))}</div>
        <div style={{fontFamily:'monospace',color:'#eab308'}}>{f2(monthly.reduce((a,m)=>a+m.pp,0))}</div>
        <div style={{fontFamily:'monospace',color:'#22c55e'}}>{f2(monthly.reduce((a,m)=>a+m.net,0))}</div>
        <div style={{fontFamily:'monospace',color:'#ec4899'}}>{f2(monthly.reduce((a,m)=>a+(m.special?.amount||0),0))}</div>
        <div style={{fontFamily:'monospace',color:'#c6a34e'}}>{f2(totalAnnuel)}</div>
      </div>
    </div>
  </div>;
};

const GenDocsJuridiques=({s,d})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const [selDoc,setSelDoc]=useState('avertissement');
  const [formData,setFormData]=useState({empIndex:0,date:'',motif:'',details:'',delai:'5 jours ouvrables'});
  const cl=clients[selClient];
  const co=cl?.company||{};
  const emps=cl?.emps||[];

  const docTypes=[
    {id:'avertissement',title:'Lettre d\'avertissement',icon:'⚠️',desc:'Premier avertissement formel',color:'#eab308'},
    {id:'mise_demeure',title:'Mise en demeure',icon:'📩',desc:'Sommation formelle avec delai',color:'#f97316'},
    {id:'preavis',title:'Notification de preavis',icon:'📋',desc:'Lettre de licenciement avec preavis',color:'#ef4444'},
    {id:'faute_grave',title:'Licenciement faute grave',icon:'🔴',desc:'Rupture immediate sans preavis',color:'#ef4444'},
    {id:'rupture_commun',title:'Rupture de commun accord',icon:'🤝',desc:'Convention de depart amiable',color:'#3b82f6'},
    {id:'attestation',title:'Attestation d\'emploi',icon:'📄',desc:'Confirmation de fonction et anciennete',color:'#22c55e'},
    {id:'avenant_sal',title:'Avenant salarial',icon:'💰',desc:'Modification de rémunération',color:'#c6a34e'},
    {id:'teletravail',title:'Convention teletravail',icon:'🏠',desc:'Accord teletravail structure',color:'#a855f7'},
  ];

  const generateDoc=()=>{
    const emp=emps[formData.empIndex]||{};
    const doc=docTypes.find(d=>d.id===selDoc);
    const dateStr=formData.date||new Date().toLocaleDateString('fr-BE');
    const empName=(emp.first||emp.fn||'')+' '+(emp.last||emp.ln||'');
    const startDate=emp.startDate||emp.start||'N/A';

    let html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Georgia,serif;font-size:12px;padding:50px 60px;max-width:800px;margin:auto;line-height:1.8;color:#222}h1{font-size:16px;text-align:center;margin:20px 0;text-transform:uppercase;letter-spacing:2px}h2{font-size:13px;margin:15px 0 8px;text-decoration:underline}.header{text-align:right;margin-bottom:40px}.exp{text-align:left;margin-bottom:30px}.objet{font-weight:700;margin:20px 0}.corps p{margin:10px 0;text-align:justify}.signature{margin-top:50px}.footer{text-align:center;font-size:9px;color:#888;margin-top:60px;border-top:1px solid #eee;padding-top:10px}@media print{button{display:none!important}}</style></head><body>';

    // Header
    html+='<div style="text-align:center;font-size:18px;font-weight:700;color:#c6a34e;font-family:Georgia">AUREUS SOCIAL PRO</div>';
    html+='<div style="text-align:center;font-size:10px;color:#888;margin-bottom:30px">'+co.name+' | '+(co.vat||'BCE N/A')+' | '+(co.address||'')+' '+(co.zip||'')+' '+(co.city||'')+'</div>';

    // Date & recipient
    html+='<div class="header">'+((co.city||'Bruxelles')+', le '+dateStr)+'</div>';
    html+='<div class="exp"><strong>'+empName+'</strong><br>Employe(e) depuis le '+startDate+'</div>';

    // Content based on type
    if(selDoc==='avertissement'){
      html+='<div class="objet">Objet : Avertissement formel</div>';
      html+='<div class="corps"><p>Madame, Monsieur,</p>';
      html+='<p>Par la presente, nous vous notifions un avertissement formel pour le motif suivant :</p>';
      html+='<p style="padding:10px;background:#f9f7f0;border-left:3px solid #eab308"><strong>'+(formData.motif||'[Motif a preciser]')+'</strong></p>';
      html+='<p>'+(formData.details||'Les faits constates constituent un manquement a vos obligations contractuelles.')+'</p>';
      html+='<p>Nous vous invitons a vous conformer aux regles en vigueur. En cas de recidive, des sanctions plus severes pourraient etre prises, y compris un licenciement.</p>';
      html+='<p>Le present avertissement sera conserve dans votre dossier personnel.</p></div>';
    }else if(selDoc==='preavis'){
      const anc=(new Date()-new Date(startDate))/31557600000;
      const sem=anc<1?4:anc<2?5:anc<3?6:anc<4?7:anc<5?9:anc<10?15:anc<15?21:anc<20?36:51;
      html+='<div class="objet">Objet : Notification de conge avec preavis</div>';
      html+='<div class="corps"><p>Madame, Monsieur,</p>';
      html+='<p>Nous avons le regret de vous informer que nous mettons fin a votre contrat de travail, moyennant un preavis de <strong>'+sem+' semaines</strong>, conformement a la loi du 26 decembre 2013.</p>';
      html+='<p>Motif : '+(formData.motif||'[Reorganisation / Raisons economiques]')+'</p>';
      html+='<p>Votre preavis prendra cours le troisieme jour ouvrable suivant la notification de la presente lettre.</p>';
      html+='<p>Vous etes libre de vous absenter pour recherche d\'emploi conformement a la loi.</p></div>';
    }else if(selDoc==='faute_grave'){
      html+='<div class="objet">Objet : Licenciement pour motif grave — Article 35 de la loi du 3 juillet 1978</div>';
      html+='<div class="corps"><p>Madame, Monsieur,</p>';
      html+='<p>Par la presente, nous vous notifions votre licenciement immediat pour motif grave, sans preavis ni indemnite, en application de l\'article 35 de la loi du 3 juillet 1978 relative aux contrats de travail.</p>';
      html+='<p>Le motif grave est le suivant :</p>';
      html+='<p style="padding:10px;background:#fef2f2;border-left:3px solid #ef4444"><strong>'+(formData.motif||'[Motif grave a preciser dans les 3 jours ouvrables]')+'</strong></p>';
      html+='<p>'+(formData.details||'Ces faits rendent immediatement et definitivement impossible toute collaboration professionnelle.')+'</p>';
      html+='<p><strong>Important</strong> : Conformement a la loi, les motifs precis vous seront notifies par lettre recommandee dans les 3 jours ouvrables suivant le licenciement.</p></div>';
    }else if(selDoc==='rupture_commun'){
      html+='<div class="objet">Objet : Convention de rupture de commun accord</div>';
      html+='<div class="corps"><p>Les parties soussignees :</p>';
      html+='<p><strong>L\'employeur</strong> : '+co.name+'<br><strong>Le travailleur</strong> : '+empName+'</p>';
      html+='<p>Conviennent de mettre fin au contrat de travail de commun accord aux conditions suivantes :</p>';
      html+='<p>1. La fin du contrat prend effet le '+(formData.date||'[date]')+'.</p>';
      html+='<p>2. '+(formData.details||'Les parties renoncent mutuellement a toute reclamation.')+'</p>';
      html+='<p>3. Le solde de tout compte sera etabli et verse dans les delais legaux.</p>';
      html+='<p>Fait en double exemplaire.</p></div>';
    }else if(selDoc==='attestation'){
      html+='<div class="objet">Objet : Attestation d\'emploi</div>';
      html+='<div class="corps"><p>La societe '+co.name+' atteste par la presente que :</p>';
      html+='<p><strong>'+empName+'</strong> est employe(e) au sein de notre societe depuis le <strong>'+startDate+'</strong> en qualite de <strong>'+(emp.function||emp.titre||'employe(e)')+'</strong>.</p>';
      html+='<p>Cette attestation est delivree pour servir et valoir ce que de droit.</p></div>';
    }else if(selDoc==='avenant_sal'){
      html+='<div class="objet">Objet : Avenant au contrat de travail — Modification de rémunération</div>';
      html+='<div class="corps"><p>Les parties conviennent de modifier les conditions de rémunération comme suit :</p>';
      html+='<p>Nouveau salaire brut mensuel : <strong>'+(formData.details||'[montant]')+' EUR</strong></p>';
      html+='<p>Cette modification prend effet a compter du '+(formData.date||'[date]')+'.</p>';
      html+='<p>Toutes les autres clauses du contrat initial restent inchangees.</p></div>';
    }else{
      html+='<div class="objet">Objet : '+(doc?.title||'Document')+'</div>';
      html+='<div class="corps"><p>Madame, Monsieur,</p><p>'+(formData.details||'[Contenu a preciser]')+'</p></div>';
    }

    // Signature
    html+='<div class="signature"><p>Veuillez agreer, Madame, Monsieur, l\'expression de nos salutations distinguees.</p>';
    html+='<br><br><table style="width:100%"><tr><td style="width:50%"><strong>Pour l\'employeur</strong><br>'+co.name+'<br><br><br>____________________</td>';
    html+='<td style="width:50%"><strong>Le travailleur</strong><br>'+empName+'<br><br><br>____________________</td></tr></table></div>';

    // Footer
    html+='<div class="footer">Document genere par Aureus Social Pro — '+new Date().toLocaleString('fr-BE')+' — Confidentiel</div>';
    html+='<div style="text-align:center;margin:15px"><button onclick="window.print()" style="background:#c6a34e;color:#fff;border:none;padding:10px 30px;border-radius:6px;cursor:pointer;font-weight:700">Imprimer / PDF</button></div>';
    html+='</body></html>';
    previewHTML(html,doc?.title?.replace(/ /g,'_')+'_'+empName.replace(/ /g,'_'));
  };

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📜 Documents Juridiques</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>8 modeles — lettres de licenciement, avertissements, conventions</p>

    <div style={{display:'grid',gridTemplateColumns:'280px 1fr',gap:16}}>
      {/* Doc types */}
      <div style={{display:'flex',flexDirection:'column',gap:6}}>
        {docTypes.map(d=><button key={d.id} onClick={()=>setSelDoc(d.id)} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 12px',borderRadius:10,border:selDoc===d.id?'2px solid '+d.color:'1px solid rgba(255,255,255,.05)',background:selDoc===d.id?d.color+'10':'rgba(255,255,255,.02)',cursor:'pointer',textAlign:'left'}}>
          <span style={{fontSize:18}}>{d.icon}</span>
          <div><div style={{fontSize:11,fontWeight:600,color:selDoc===d.id?d.color:'#e5e5e5'}}>{d.title}</div><div style={{fontSize:9,color:'#888'}}>{d.desc}</div></div>
        </button>)}
      </div>

      {/* Form */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:18}}>
        <div style={{fontSize:14,fontWeight:700,color:'#c6a34e',marginBottom:14}}>{docTypes.find(d=>d.id===selDoc)?.icon} {docTypes.find(d=>d.id===selDoc)?.title}</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:12}}>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Client</label>
            <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>{clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}</select></div>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Employé</label>
            <select value={formData.empIndex} onChange={e=>setFormData(p=>({...p,empIndex:+e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>{emps.map((e,i)=><option key={i} value={i}>{(e.first||'')} {(e.last||'')}</option>)}</select></div>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Date</label>
            <input type="date" value={formData.date} onChange={e=>setFormData(p=>({...p,date:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Delai</label>
            <input value={formData.delai} onChange={e=>setFormData(p=>({...p,delai:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
        </div>
        <div style={{marginBottom:10}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Motif</label>
          <input value={formData.motif} onChange={e=>setFormData(p=>({...p,motif:e.target.value}))} placeholder="Motif principal" style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
        <div style={{marginBottom:14}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Details</label>
          <textarea value={formData.details} onChange={e=>setFormData(p=>({...p,details:e.target.value}))} rows={3} placeholder="Circonstances, details..." style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',resize:'vertical'}}/></div>
        <button onClick={generateDoc} style={{width:'100%',padding:'12px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#c6a34e,#e2c878)',color:'#060810',fontWeight:700,fontSize:13,cursor:'pointer'}}>📄 Générer le document</button>
      </div>
    </div>
  </div>;
};

// ═══ 2. DASHBOARD ABSENTÉISME — Taux + Bradford + tendances ═══
const DashAbsenteisme=({s})=>{
  const clients=s.clients||[];
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const allEmps=[];
  clients.forEach(cl=>(cl.emps||[]).forEach(e=>allEmps.push({...e,_client:cl.company?.name||''})));
  const mois=['Jan','Fev','Mar','Avr','Mai','Jun','Jul','Aou','Sep','Oct','Nov','Dec'];
  const now=new Date();

  // Simulate absence data
  const absData=allEmps.map(e=>{
    const episodes=Math.floor(Math.random()*5);
    const totalDays=episodes*Math.ceil(Math.random()*4+1);
    const bradford=episodes*episodes*totalDays;
    return {name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),client:e._client,episodes,totalDays,bradford,
      type:episodes===0?'parfait':bradford<100?'normal':bradford<300?'attention':'critique'};
  });

  const totalDaysAll=absData.reduce((a,e)=>a+e.totalDays,0);
  const avgRate=allEmps.length>0?Math.round(totalDaysAll/(allEmps.length*22)*10000)/100:0;
  const bradfordCritique=absData.filter(a=>a.bradford>=300).length;

  // Monthly trend
  const monthly=mois.map((_,i)=>({month:mois[i],rate:Math.round((2+Math.random()*4)*100)/100}));
  const maxRate=Math.max(...monthly.map(m=>m.rate));

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📊 Dashboard Absenteisme</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Taux, facteur Bradford, tendances — {allEmps.length} employes</p>

    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:16}}>
      {[{l:'Taux absence moyen',v:avgRate+'%',c:avgRate>5?'#ef4444':avgRate>3?'#eab308':'#22c55e'},
        {l:'Jours perdus (mois)',v:totalDaysAll+' j',c:'#3b82f6'},
        {l:'Bradford critiques',v:bradfordCritique,c:bradfordCritique>0?'#ef4444':'#22c55e'},
        {l:'Cout estime',v:f2(totalDaysAll*180)+' EUR',c:'#c6a34e'},
      ].map((k,i)=><div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
        <div style={{fontSize:20,fontWeight:700,color:k.c}}>{k.v}</div>
      </div>)}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'2fr 1fr',gap:16}}>
      {/* Monthly chart */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:16}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Tendance mensuelle (%)</div>
        <div style={{display:'flex',alignItems:'flex-end',gap:4,height:120}}>
          {monthly.map((m,i)=><div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:2}}>
            <div style={{fontSize:8,color:'#888'}}>{m.rate}%</div>
            <div style={{width:'100%',height:(m.rate/maxRate*100)+'%',minHeight:4,background:m.rate>5?'#ef4444':m.rate>3?'#eab308':'#22c55e',borderRadius:'3px 3px 0 0',opacity:i===now.getMonth()?1:0.5}}/>
            <div style={{fontSize:8,color:i===now.getMonth()?'#c6a34e':'#888'}}>{m.month}</div>
          </div>)}
        </div>
      </div>

      {/* Bradford legend */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:16}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Facteur Bradford</div>
        <div style={{fontSize:10,color:'#888',marginBottom:10}}>B = S x S x D</div>
        {[{l:'< 100 — Normal',c:'#22c55e'},{l:'100-299 — Attention',c:'#eab308'},{l:'300+ — Critique',c:'#ef4444'}].map((b,i)=>
          <div key={i} style={{display:'flex',alignItems:'center',gap:6,marginBottom:4}}>
            <div style={{width:10,height:10,borderRadius:3,background:b.c}}/>
            <span style={{fontSize:10,color:'#e5e5e5'}}>{b.l}</span>
          </div>
        )}
        <div style={{marginTop:10,fontSize:10,color:'#888'}}>S = episodes, D = jours totaux</div>
      </div>
    </div>

    {/* Employee table */}
    <div style={{marginTop:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'180px 120px 70px 70px 80px 80px',padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
        <div>Employé</div><div>Client</div><div>Episodes</div><div>Jours</div><div>Bradford</div><div>Statut</div>
      </div>
      <div style={{maxHeight:300,overflowY:'auto'}}>
        {absData.sort((a,b)=>b.bradford-a.bradford).map((a,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'180px 120px 70px 70px 80px 80px',padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
          <div style={{color:'#e5e5e5',fontWeight:500}}>{a.name}</div>
          <div style={{color:'#888',fontSize:10}}>{a.client}</div>
          <div style={{textAlign:'center'}}>{a.episodes}</div>
          <div style={{textAlign:'center'}}>{a.totalDays}</div>
          <div style={{textAlign:'center',fontWeight:700,color:a.bradford>=300?'#ef4444':a.bradford>=100?'#eab308':'#22c55e'}}>{a.bradford}</div>
          <span style={{fontSize:8,padding:'2px 6px',borderRadius:4,textAlign:'center',background:a.type==='critique'?'rgba(239,68,68,.1)':a.type==='attention'?'rgba(234,179,8,.1)':a.type==='parfait'?'rgba(34,197,94,.1)':'rgba(255,255,255,.03)',color:a.type==='critique'?'#ef4444':a.type==='attention'?'#eab308':a.type==='parfait'?'#22c55e':'#888'}}>{a.type}</span>
        </div>)}
      </div>
    </div>
  </div>;
};

// ═══ 3. GESTION FLEXI-JOBS — Regime specifique belge ═══
const GestionFlexiJobs=({s,d})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const [showAdd,setShowAdd]=useState(false);
  const [flexis,setFlexis]=useState([]);
  const [newFlexi,setNewFlexi]=useState({first:'',last:'',niss:'',sector:'horeca',hours:0,rate:12.05,startDate:'',endDate:''});
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const cl=clients[selClient];

  const sectors=[
    {id:'horeca',label:'Horeca (CP 302)',icon:'🍽',minRate:12.05},
    {id:'commerce',label:'Commerce (CP 201/202)',icon:'🛒',minRate:12.05},
    {id:'boulangerie',label:'Boulangerie (CP 118)',icon:'🥐',minRate:12.05},
    {id:'agriculture',label:'Agriculture (CP 144/145)',icon:'🌾',minRate:12.05},
    {id:'interim',label:'Travail interimaire (CP 322)',icon:'📋',minRate:12.05},
    {id:'autre',label:'Autre secteur autorise',icon:'📦',minRate:12.05},
  ];

  // Flexi rules 2026
  const flexiRules={
    cotisationSpeciale:28, // 28% cotisation employeur
    exoOnssW:true, // Pas d'ONSS travailleur
    exoPP:true, // Pas de précompte professionnel
    maxAnnuel:12000, // Plafond annuel pensionnés
    maxTrimestriel:null, // Pas de limite trimestrielle
    contratCadre:true,
  };

  const addFlexi=()=>{
    if(!newFlexi.first||!newFlexi.last)return;
    const brut=newFlexi.hours*newFlexi.rate;
    const cotisation=Math.round(brut*flexiRules.cotisationSpeciale)/100;
    setFlexis(p=>[...p,{...newFlexi,id:Date.now(),brut,net:brut,cotisation,coutTotal:brut+cotisation}]);
    setShowAdd(false);setNewFlexi({first:'',last:'',niss:'',sector:'horeca',hours:0,rate:12.05,startDate:'',endDate:''});
  };

  const totalBrut=flexis.reduce((a,f)=>a+f.brut,0);
  const totalCot=flexis.reduce((a,f)=>a+f.cotisation,0);
  const totalCout=flexis.reduce((a,f)=>a+f.coutTotal,0);

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>⚡ Flexi-Jobs</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Regime flexi-job belge — 0% ONSS travailleur, 0% PP</p>
      </div>
      <div style={{display:'flex',gap:8}}>
        <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
        </select>
        <button onClick={()=>setShowAdd(true)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>+ Nouveau flexi</button>
      </div>
    </div>

    {/* Rules info */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8,marginBottom:16}}>
      {[{l:'ONSS travailleur',v:'0%',c:'#22c55e'},{l:'Precompte prof.',v:'0%',c:'#22c55e'},{l:'Cotisation employeur',v:'28%',c:'#eab308'},{l:'Salaire min.',v:'12,05 EUR/h',c:'#c6a34e'},{l:'Plafond annuel',v:'12.000 EUR*',c:'#3b82f6'}].map((k,i)=>
        <div key={i} style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:10,textAlign:'center'}}>
          <div style={{fontSize:8,color:'#888'}}>{k.l}</div>
          <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    {/* Sectors */}
    <div style={{display:'flex',gap:6,marginBottom:14,flexWrap:'wrap'}}>
      {sectors.map(s=><div key={s.id} style={{padding:'6px 12px',borderRadius:8,background:'rgba(255,255,255,.03)',border:'1px solid rgba(198,163,78,.06)',fontSize:10,color:'#e5e5e5'}}>{s.icon} {s.label}</div>)}
    </div>

    {/* KPIs */}
    {flexis.length>0&&<div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:14}}>
      {[{l:'Flexis actifs',v:flexis.length,c:'#3b82f6'},{l:'Total brut (=net)',v:f2(totalBrut)+' EUR',c:'#22c55e'},{l:'Cotisation 28%',v:f2(totalCot)+' EUR',c:'#eab308'},{l:'Cout total',v:f2(totalCout)+' EUR',c:'#c6a34e'}].map((k,i)=>
        <div key={i} style={{padding:12,background:'rgba(255,255,255,.02)',borderRadius:10,textAlign:'center',border:'1px solid '+k.c+'10'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
          <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>}

    {/* Flexi list */}
    {flexis.length>0&&<div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'150px 100px 60px 70px 80px 80px 80px',padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
        <div>Nom</div><div>Secteur</div><div>Heures</div><div>Taux/h</div><div>Brut=Net</div><div>Cot. 28%</div><div>Coût total</div>
      </div>
      {flexis.map((fl,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'150px 100px 60px 70px 80px 80px 80px',padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
        <div style={{color:'#e5e5e5',fontWeight:500}}>{fl.first} {fl.last}</div>
        <div style={{color:'#888',fontSize:10}}>{fl.sector}</div>
        <div style={{textAlign:'center'}}>{fl.hours}h</div>
        <div style={{textAlign:'center',color:'#c6a34e'}}>{f2(fl.rate)}</div>
        <div style={{textAlign:'center',color:'#22c55e',fontWeight:600}}>{f2(fl.brut)}</div>
        <div style={{textAlign:'center',color:'#eab308'}}>{f2(fl.cotisation)}</div>
        <div style={{textAlign:'center',fontWeight:600}}>{f2(fl.coutTotal)}</div>
      </div>)}
    </div>}

    {flexis.length===0&&<div style={{textAlign:'center',padding:40,color:'#888',fontSize:12}}>Aucun flexi-job encode. Cliquez + pour ajouter.</div>}

    {/* Avantage comparatif */}
    <div style={{marginTop:16,padding:14,background:'rgba(34,197,94,.03)',border:'1px solid rgba(34,197,94,.1)',borderRadius:12}}>
      <div style={{fontSize:12,fontWeight:600,color:'#22c55e',marginBottom:4}}>💡 Avantage flexi-job vs contrat normal</div>
      <div style={{fontSize:10,color:'#888'}}>Pour un travailleur a {f2(12.05)}/h pendant 40h : Brut = Net = {f2(12.05*40)} EUR (pas de retenues). Employeur paie uniquement 28% cotisation spéciale = {f2(12.05*40*0.28)} EUR. Cout total = {f2(12.05*40*1.28)} EUR vs {f2(12.05*40*1.55)} EUR en regime normal → economie de {f2(12.05*40*0.27)} EUR.</div>
    </div>

    {/* Add modal */}
    {showAdd&&<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.6)',zIndex:999,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={()=>setShowAdd(false)}>
      <div onClick={e=>e.stopPropagation()} style={{background:'#0d1117',border:'1px solid rgba(198,163,78,.2)',borderRadius:16,padding:24,width:440}}>
        <h3 style={{fontSize:16,fontWeight:700,color:'#c6a34e',marginBottom:14}}>Nouveau flexi-job</h3>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:10}}>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Prenom</label><input value={newFlexi.first} onChange={e=>setNewFlexi(p=>({...p,first:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Nom</label><input value={newFlexi.last} onChange={e=>setNewFlexi(p=>({...p,last:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Secteur</label><select value={newFlexi.sector} onChange={e=>setNewFlexi(p=>({...p,sector:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>{sectors.map(s=><option key={s.id} value={s.id}>{s.icon} {s.label}</option>)}</select></div>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>NISS</label><input value={newFlexi.niss} onChange={e=>setNewFlexi(p=>({...p,niss:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Heures/mois</label><input type="number" value={newFlexi.hours} onChange={e=>setNewFlexi(p=>({...p,hours:+e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Taux/h (min 12,05)</label><input type="number" step="0.01" value={newFlexi.rate} onChange={e=>setNewFlexi(p=>({...p,rate:+e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
        </div>
        <div style={{display:'flex',gap:8,marginTop:14}}>
          <button onClick={addFlexi} style={{flex:1,padding:'10px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>Creer</button>
          <button onClick={()=>setShowAdd(false)} style={{padding:'10px 16px',borderRadius:8,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'#888',fontSize:12,cursor:'pointer'}}>Annuler</button>
        </div>
      </div>
    </div>}
  </div>;
};

// ═══ 4. SIMULATEUR CHÔMAGE TEMPORAIRE — Eco + Force Majeure ═══
const SimuChomageTemp=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const [type,setType]=useState('eco');
  const [days,setDays]=useState(10);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const cl=clients[selClient];
  const emps=cl?.emps||[];

  const types=[
    {id:'eco',label:'Economique — employes',desc:'Art. 77/1 — max 16 semaines/an calendrier',icon:'📉',color:'#3b82f6',maxWeeks:16,alloc:65,plafond:3199.26},
    {id:'eco_ouv',label:'Economique — ouvriers',desc:'Art. 51 — regime plus souple',icon:'🔧',color:'#eab308',maxWeeks:null,alloc:65,plafond:3199.26},
    {id:'force_majeure',label:'Force majeure',desc:'Evenement imprevisible, temporaire',icon:'🌪',color:'#ef4444',maxWeeks:null,alloc:70,plafond:3199.26},
    {id:'intemperies',label:'Intemperies (construction)',desc:'CP 124 — conditions meteo',icon:'🌧',color:'#a855f7',maxWeeks:null,alloc:65,plafond:3199.26},
  ];

  const selType=types.find(t=>t.id===type);

  const results=emps.map(e=>{
    const brut=+(e.monthlySalary||e.gross||0);
    const brutJour=Math.round(brut/22*100)/100;
    const plafondJour=Math.round(selType.plafond/26*100)/100;
    const baseAlloc=Math.min(brutJour,plafondJour);
    const allocJour=Math.round(baseAlloc*selType.alloc)/100;
    const allocTotal=Math.round(allocJour*days*100)/100;
    const econEmployeur=Math.round(brut/22*days*100)/100;
    const supplement=Math.round(days*2*100)/100; // 2 EUR/jour supplement employeur
    return {name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),brut,brutJour,allocJour,allocTotal,econEmployeur,supplement,coutResiduel:supplement};
  });

  const totalEcon=results.reduce((a,r)=>a+r.econEmployeur,0);
  const totalAlloc=results.reduce((a,r)=>a+r.allocTotal,0);
  const totalSupp=results.reduce((a,r)=>a+r.supplement,0);

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>⏸ Chomage Temporaire</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Simulation allocations ONEM + economie employeur</p>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:16}}>
      {types.map(t=><button key={t.id} onClick={()=>setType(t.id)} style={{display:'flex',alignItems:'center',gap:10,padding:12,borderRadius:10,border:type===t.id?'2px solid '+t.color:'1px solid rgba(255,255,255,.05)',background:type===t.id?t.color+'08':'rgba(255,255,255,.02)',cursor:'pointer',textAlign:'left'}}>
        <span style={{fontSize:22}}>{t.icon}</span>
        <div><div style={{fontSize:12,fontWeight:600,color:type===t.id?t.color:'#e5e5e5'}}>{t.label}</div><div style={{fontSize:9,color:'#888'}}>{t.desc}</div></div>
      </button>)}
    </div>

    <div style={{display:'flex',gap:10,marginBottom:16,alignItems:'center'}}>
      <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>
        {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
      </select>
      <div style={{display:'flex',alignItems:'center',gap:8}}>
        <span style={{fontSize:11,color:'#888'}}>Jours chomage :</span>
        <input type="range" min={1} max={22} value={days} onChange={e=>setDays(+e.target.value)} style={{accentColor:'#c6a34e'}}/>
        <span style={{fontSize:14,fontWeight:700,color:'#c6a34e',minWidth:30}}>{days}j</span>
      </div>
    </div>

    {/* Summary KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Economie employeur',v:f2(totalEcon)+' EUR',c:'#22c55e'},{l:'Allocations ONEM',v:f2(totalAlloc)+' EUR',c:'#3b82f6'},{l:'Supplement employeur',v:f2(totalSupp)+' EUR',c:'#eab308'},{l:'Taux allocation',v:selType.alloc+'%',c:'#c6a34e'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
          <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    {/* Per employee */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'160px 80px 80px 80px 90px 80px',padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
        <div>Employé</div><div>Brut/jour</div><div>Alloc/jour</div><div>Alloc total</div><div>Econ. empl.</div><div>Suppl.</div>
      </div>
      {results.map((r,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'160px 80px 80px 80px 90px 80px',padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
        <div style={{color:'#e5e5e5',fontWeight:500}}>{r.name}</div>
        <div style={{color:'#888'}}>{f2(r.brutJour)}</div>
        <div style={{color:'#3b82f6'}}>{f2(r.allocJour)}</div>
        <div style={{color:'#3b82f6',fontWeight:600}}>{f2(r.allocTotal)}</div>
        <div style={{color:'#22c55e',fontWeight:600}}>{f2(r.econEmployeur)}</div>
        <div style={{color:'#eab308'}}>{f2(r.supplement)}</div>
      </div>)}
    </div>
  </div>;
};

const OnboardingWizard=({s,d})=>{
  const [step,setStep]=useState(0);
  const [data,setData]=useState({
    company:{name:'',vat:'',address:'',zip:'',city:'',cp:'200',nace:''},
    contact:{name:'',email:'',phone:'',function:'Gerant'},
    bank:{iban:'',bic:'',bank:''},
    social:{onss:'',dimona:true,sepp:'',medecineTravail:''},
    employees:[],
    options:{cheqRepas:false,ecoCheques:false,assuranceGroupe:false,planCafeteria:false},
  });
  const [newEmp,setNewEmp]=useState({first:'',last:'',niss:'',startDate:'',contractType:'CDI',monthlySalary:''});

  const steps=[
    {title:'Entreprise',icon:'🏢',desc:'Identite et BCE'},
    {title:'Contact',icon:'👤',desc:'Personne de contact'},
    {title:'Bancaire',icon:'🏦',desc:'Coordonnees bancaires'},
    {title:'Social',icon:'🏛',desc:'Affiliations sociales'},
    {title:'Employes',icon:'👥',desc:'Personnel a encoder'},
    {title:'Options',icon:'🎁',desc:'Avantages extra-legaux'},
    {title:'Resume',icon:'✅',desc:'Validation et creation'},
  ];

  const addEmp=()=>{
    if(!newEmp.first||!newEmp.last)return;
    setData(p=>({...p,employees:[...p.employees,{...newEmp,id:Date.now()}]}));
    setNewEmp({first:'',last:'',niss:'',startDate:'',contractType:'CDI',monthlySalary:''});
  };

  const finalize=()=>{
    // Create client from wizard data
    const newClient={
      company:data.company,
      emps:data.employees.map(e=>({first:e.first,last:e.last,niss:e.niss,startDate:e.startDate,contractType:e.contractType,monthlySalary:+e.monthlySalary})),
    };
    d({type:'ADD_CLIENT',client:newClient});
    setStep(7); // confirmation
  };

  const inputStyle={width:'100%',padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'};
  const labelStyle={fontSize:10,color:'#888',display:'block',marginBottom:3};

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🚀 Onboarding Nouveau Client</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 24px'}}>Assistant pas-a-pas — 7 etapes pour creer un dossier complet</p>

    {/* Progress steps */}
    <div style={{display:'flex',gap:4,marginBottom:24}}>
      {steps.map((st,i)=><div key={i} onClick={()=>{if(i<=step)setStep(i);}} style={{flex:1,padding:'10px 8px',borderRadius:10,background:i===step?'rgba(198,163,78,.1)':i<step?'rgba(34,197,94,.05)':'rgba(255,255,255,.02)',border:'1px solid '+(i===step?'rgba(198,163,78,.2)':i<step?'rgba(34,197,94,.1)':'rgba(255,255,255,.04)'),cursor:i<=step?'pointer':'default',textAlign:'center',transition:'all .2s'}}>
        <div style={{fontSize:18}}>{i<step?'✅':st.icon}</div>
        <div style={{fontSize:10,fontWeight:600,color:i===step?'#c6a34e':i<step?'#22c55e':'#888',marginTop:2}}>{st.title}</div>
      </div>)}
    </div>

    {/* Step content */}
    <div style={{background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:16,padding:24,minHeight:300}}>

      {step===0&&<div>
        <div style={{fontSize:15,fontWeight:700,color:'#c6a34e',marginBottom:16}}>🏢 Identification de l'entreprise</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          <div><label style={labelStyle}>Nom de l'entreprise *</label><input value={data.company.name} onChange={e=>setData(p=>({...p,company:{...p.company,name:e.target.value}}))} style={inputStyle} placeholder="ACME SA"/></div>
          <div><label style={labelStyle}>N° BCE / TVA *</label><input value={data.company.vat} onChange={e=>setData(p=>({...p,company:{...p.company,vat:e.target.value}}))} style={inputStyle} placeholder="BE0123.456.789"/></div>
          <div><label style={labelStyle}>Adresse</label><input value={data.company.address} onChange={e=>setData(p=>({...p,company:{...p.company,address:e.target.value}}))} style={inputStyle} placeholder="Rue de la Loi 1"/></div>
          <div style={{display:'grid',gridTemplateColumns:'80px 1fr',gap:8}}>
            <div><label style={labelStyle}>CP</label><input value={data.company.zip} onChange={e=>setData(p=>({...p,company:{...p.company,zip:e.target.value}}))} style={inputStyle} placeholder="1000"/></div>
            <div><label style={labelStyle}>Ville</label><input value={data.company.city} onChange={e=>setData(p=>({...p,company:{...p.company,city:e.target.value}}))} style={inputStyle} placeholder="Bruxelles"/></div>
          </div>
          <div><label style={labelStyle}>Commission paritaire</label>
            <select value={data.company.cp} onChange={e=>setData(p=>({...p,company:{...p.company,cp:e.target.value}}))} style={inputStyle}>
              <option value="200">CP 200 — Employes</option><option value="100">CP 100 — Ouvriers</option>
              <option value="124">CP 124 — Construction</option><option value="140">CP 140 — Transport</option>
              <option value="302">CP 302 — Horeca</option><option value="330">CP 330 — Sante</option>
            </select>
          </div>
          <div><label style={labelStyle}>Code NACE</label><input value={data.company.nace} onChange={e=>setData(p=>({...p,company:{...p.company,nace:e.target.value}}))} style={inputStyle} placeholder="62010"/></div>
        </div>
      </div>}

      {step===1&&<div>
        <div style={{fontSize:15,fontWeight:700,color:'#c6a34e',marginBottom:16}}>👤 Personne de contact</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          <div><label style={labelStyle}>Nom complet *</label><input value={data.contact.name} onChange={e=>setData(p=>({...p,contact:{...p.contact,name:e.target.value}}))} style={inputStyle}/></div>
          <div><label style={labelStyle}>Fonction</label><input value={data.contact.function} onChange={e=>setData(p=>({...p,contact:{...p.contact,function:e.target.value}}))} style={inputStyle}/></div>
          <div><label style={labelStyle}>Email *</label><input type="email" value={data.contact.email} onChange={e=>setData(p=>({...p,contact:{...p.contact,email:e.target.value}}))} style={inputStyle}/></div>
          <div><label style={labelStyle}>Telephone</label><input value={data.contact.phone} onChange={e=>setData(p=>({...p,contact:{...p.contact,phone:e.target.value}}))} style={inputStyle}/></div>
        </div>
      </div>}

      {step===2&&<div>
        <div style={{fontSize:15,fontWeight:700,color:'#c6a34e',marginBottom:16}}>🏦 Coordonnees bancaires</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          <div><label style={labelStyle}>IBAN *</label><input value={data.bank.iban} onChange={e=>setData(p=>({...p,bank:{...p.bank,iban:e.target.value}}))} style={inputStyle} placeholder="BE68 5390 0754 7034"/></div>
          <div><label style={labelStyle}>BIC</label><input value={data.bank.bic} onChange={e=>setData(p=>({...p,bank:{...p.bank,bic:e.target.value}}))} style={inputStyle} placeholder="GKCCBEBB"/></div>
          <div><label style={labelStyle}>Banque</label>
            <select value={data.bank.bank} onChange={e=>setData(p=>({...p,bank:{...p.bank,bank:e.target.value}}))} style={inputStyle}>
              <option value="">-- Selectionner --</option>
              <option>Belfius</option><option>KBC</option><option>ING</option><option>BNP Paribas Fortis</option>
              <option>Crelan</option><option>CBC</option><option>Argenta</option>
            </select>
          </div>
        </div>
      </div>}

      {step===3&&<div>
        <div style={{fontSize:15,fontWeight:700,color:'#c6a34e',marginBottom:16}}>🏛 Affiliations sociales</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          <div><label style={labelStyle}>N° ONSS employeur</label><input value={data.social.onss} onChange={e=>setData(p=>({...p,social:{...p.social,onss:e.target.value}}))} style={inputStyle} placeholder="123-4567890-12"/></div>
          <div><label style={labelStyle}>SEPP (service prevention)</label>
            <select value={data.social.sepp} onChange={e=>setData(p=>({...p,social:{...p.social,sepp:e.target.value}}))} style={inputStyle}>
              <option value="">-- Selectionner --</option>
              <option>Mensura</option><option>Liantis</option><option>Cohezio</option><option>SPMT-Arista</option>
              <option>Autre SS agréé</option><option>Autre prestataire</option><option>Aucun</option>
            </select>
          </div>
          <div><label style={labelStyle}>Medecine du travail</label><input value={data.social.medecineTravail} onChange={e=>setData(p=>({...p,social:{...p.social,medecineTravail:e.target.value}}))} style={inputStyle} placeholder="Nom du service"/></div>
          <div style={{display:'flex',alignItems:'center',gap:8,paddingTop:20}}>
            <input type="checkbox" checked={data.social.dimona} onChange={e=>setData(p=>({...p,social:{...p.social,dimona:e.target.checked}}))} style={{accentColor:'#c6a34e'}}/>
            <span style={{fontSize:11,color:'#e5e5e5'}}>Dimona electronique active</span>
          </div>
        </div>
      </div>}

      {step===4&&<div>
        <div style={{fontSize:15,fontWeight:700,color:'#c6a34e',marginBottom:16}}>👥 Employes ({data.employees.length})</div>
        {data.employees.length>0&&<div style={{border:'1px solid rgba(198,163,78,.08)',borderRadius:10,overflow:'hidden',marginBottom:14}}>
          {data.employees.map((e,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
            <span style={{color:'#e5e5e5',fontWeight:600,flex:1}}>{e.first} {e.last}</span>
            <span style={{color:'#888'}}>{e.contractType}</span>
            <span style={{color:'#c6a34e'}}>{e.monthlySalary} EUR</span>
            <button onClick={()=>setData(p=>({...p,employees:p.employees.filter((_,j)=>j!==i)}))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer'}}>✕</button>
          </div>)}
        </div>}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8}}>
          <div><label style={labelStyle}>Prenom *</label><input value={newEmp.first} onChange={e=>setNewEmp(p=>({...p,first:e.target.value}))} style={inputStyle}/></div>
          <div><label style={labelStyle}>Nom *</label><input value={newEmp.last} onChange={e=>setNewEmp(p=>({...p,last:e.target.value}))} style={inputStyle}/></div>
          <div><label style={labelStyle}>NISS</label><input value={newEmp.niss} onChange={e=>setNewEmp(p=>({...p,niss:e.target.value}))} style={inputStyle} placeholder="85.02.15-xxx.xx"/></div>
          <div><label style={labelStyle}>Date debut</label><input type="date" value={newEmp.startDate} onChange={e=>setNewEmp(p=>({...p,startDate:e.target.value}))} style={inputStyle}/></div>
          <div><label style={labelStyle}>Contrat</label><select value={newEmp.contractType} onChange={e=>setNewEmp(p=>({...p,contractType:e.target.value}))} style={inputStyle}><option>CDI</option><option>CDD</option><option>Etudiant</option><option>Flexi</option></select></div>
          <div><label style={labelStyle}>Brut mensuel</label><input type="number" value={newEmp.monthlySalary} onChange={e=>setNewEmp(p=>({...p,monthlySalary:e.target.value}))} style={inputStyle} placeholder="3500"/></div>
        </div>
        <button onClick={addEmp} style={{marginTop:10,padding:'8px 16px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:'rgba(198,163,78,.06)',color:'#c6a34e',fontSize:11,cursor:'pointer',fontWeight:600}}>+ Ajouter employe</button>
      </div>}

      {step===5&&<div>
        <div style={{fontSize:15,fontWeight:700,color:'#c6a34e',marginBottom:16}}>🎁 Options & avantages</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
          {[{id:'cheqRepas',label:'Cheques-repas',desc:'Max 8 EUR/jour — Sodexo/Edenred/Monizze',icon:'🍽'},
            {id:'ecoCheques',label:'Eco-cheques',desc:'Max 250 EUR/an',icon:'🌿'},
            {id:'assuranceGroupe',label:'Assurance groupe',desc:'Pension complementaire',icon:'🛡'},
            {id:'planCafeteria',label:'Plan cafeteria',desc:'Budget flexible pour avantages',icon:'☕'},
          ].map(opt=><label key={opt.id} style={{display:'flex',alignItems:'center',gap:10,padding:14,borderRadius:10,border:'1px solid '+(data.options[opt.id]?'rgba(198,163,78,.2)':'rgba(255,255,255,.05)'),background:data.options[opt.id]?'rgba(198,163,78,.05)':'transparent',cursor:'pointer'}}>
            <input type="checkbox" checked={data.options[opt.id]} onChange={e=>setData(p=>({...p,options:{...p.options,[opt.id]:e.target.checked}}))} style={{accentColor:'#c6a34e'}}/>
            <span style={{fontSize:18}}>{opt.icon}</span>
            <div><div style={{fontSize:12,fontWeight:600,color:'#e5e5e5'}}>{opt.label}</div><div style={{fontSize:9,color:'#888'}}>{opt.desc}</div></div>
          </label>)}
        </div>
      </div>}

      {step===6&&<div>
        <div style={{fontSize:15,fontWeight:700,color:'#c6a34e',marginBottom:16}}>✅ Resume du dossier</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
          <div style={{padding:14,borderRadius:10,border:'1px solid rgba(198,163,78,.08)'}}>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:6}}>Entreprise</div>
            <div style={{fontSize:11,color:'#e5e5e5'}}>{data.company.name||'—'}</div>
            <div style={{fontSize:10,color:'#888'}}>{data.company.vat} | CP {data.company.cp}</div>
            <div style={{fontSize:10,color:'#888'}}>{data.company.address} {data.company.zip} {data.company.city}</div>
          </div>
          <div style={{padding:14,borderRadius:10,border:'1px solid rgba(198,163,78,.08)'}}>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:6}}>Contact</div>
            <div style={{fontSize:11,color:'#e5e5e5'}}>{data.contact.name||'—'}</div>
            <div style={{fontSize:10,color:'#888'}}>{data.contact.email} | {data.contact.phone}</div>
          </div>
          <div style={{padding:14,borderRadius:10,border:'1px solid rgba(198,163,78,.08)'}}>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:6}}>Employes ({data.employees.length})</div>
            {data.employees.map((e,i)=><div key={i} style={{fontSize:10,color:'#e5e5e5'}}>{e.first} {e.last} — {e.contractType} — {e.monthlySalary} EUR</div>)}
            {data.employees.length===0&&<div style={{fontSize:10,color:'#888'}}>Aucun employé encode</div>}
          </div>
          <div style={{padding:14,borderRadius:10,border:'1px solid rgba(198,163,78,.08)'}}>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:6}}>Options</div>
            {Object.entries(data.options).filter(([k,v])=>v).map(([k])=><div key={k} style={{fontSize:10,color:'#22c55e'}}>✅ {k}</div>)}
            {Object.values(data.options).every(v=>!v)&&<div style={{fontSize:10,color:'#888'}}>Aucune option selectionnee</div>}
          </div>
        </div>
        <button onClick={finalize} style={{marginTop:16,width:'100%',padding:'14px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#22c55e,#16a34a)',color:'#fff',fontWeight:700,fontSize:14,cursor:'pointer'}}>🚀 Creer le dossier client</button>
      </div>}

      {step===7&&<div style={{textAlign:'center',padding:40}}>
        <div style={{fontSize:48,marginBottom:12}}>🎉</div>
        <div style={{fontSize:20,fontWeight:700,color:'#22c55e'}}>Dossier cree avec succes !</div>
        <div style={{fontSize:12,color:'#888',marginTop:8}}>Le client {data.company.name} et ses {data.employees.length} employe(s) ont ete ajoutes.</div>
        <div style={{display:'flex',gap:8,justifyContent:'center',marginTop:20}}>
          <button onClick={()=>{setStep(0);setData({company:{name:'',vat:'',address:'',zip:'',city:'',cp:'200',nace:''},contact:{name:'',email:'',phone:'',function:'Gerant'},bank:{iban:'',bic:'',bank:''},social:{onss:'',dimona:true,sepp:'',medecineTravail:''},employees:[],options:{cheqRepas:false,ecoCheques:false,assuranceGroupe:false,planCafeteria:false}});}} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'rgba(198,163,78,.1)',color:'#c6a34e',fontWeight:600,fontSize:12,cursor:'pointer'}}>Nouveau client</button>
          <button onClick={()=>d({type:'NAV',page:'dashboard'})} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'rgba(34,197,94,.1)',color:'#22c55e',fontWeight:600,fontSize:12,cursor:'pointer'}}>Dashboard</button>
        </div>
      </div>}
    </div>

    {/* Navigation buttons */}
    {step<7&&<div style={{display:'flex',justifyContent:'space-between',marginTop:16}}>
      <button onClick={()=>setStep(Math.max(0,step-1))} disabled={step===0} style={{padding:'10px 20px',borderRadius:8,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:step===0?'#555':'#e5e5e5',fontSize:12,cursor:step===0?'default':'pointer'}}>← Precedent</button>
      <div style={{fontSize:11,color:'#888',alignSelf:'center'}}>Etape {step+1} / {steps.length}</div>
      {step<6&&<button onClick={()=>setStep(step+1)} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>Suivant →</button>}
    </div>}
  </div>;
};

// ═══ 2. CHECKLIST NOUVEAU CLIENT — Todo complet dossier ═══
const ChecklistClient=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const [checks,setChecks]=useState({});

  const cl=clients[selClient];
  const co=cl?.company||{};
  const emps=cl?.emps||[];

  const categories=[
    {title:'Donnees entreprise',icon:'🏢',items:[
      {id:'bce',label:'N° BCE / TVA verifie',auto:!!co.vat},
      {id:'adresse',label:'Adresse complete',auto:!!(co.address||co.city)},
      {id:'cp',label:'Commission paritaire definie',auto:!!(co.cp)},
      {id:'nace',label:'Code NACE renseigne',auto:!!(co.nace)},
      {id:'iban_co',label:'IBAN entreprise',auto:false},
      {id:'reglement',label:'Reglement de travail',auto:false},
    ]},
    {title:'ONSS & Affiliations',icon:'🏛',items:[
      {id:'onss_num',label:'N° ONSS employeur',auto:false},
      {id:'dimona_active',label:'Dimona electronique activee',auto:false},
      {id:'sepp',label:'Affiliation SEPP (prevention)',auto:false},
      {id:'caisse_vac',label:'Affiliation caisse vacances (ouvriers)',auto:false},
      {id:'assurance_loi',label:'Assurance accidents du travail',auto:false},
    ]},
    {title:'Employes',icon:'👥',items:[
      {id:'emps_encodes',label:'Employes encodes ('+emps.length+')',auto:emps.length>0},
      {id:'niss_complets',label:'Tous les NISS renseignes',auto:emps.every(e=>e.niss||e.NISS)},
      {id:'iban_emps',label:'Tous les IBAN renseignes',auto:emps.every(e=>e.iban||e.IBAN)},
      {id:'contrats_signes',label:'Contrats de travail signes',auto:false},
      {id:'dimona_in',label:'Dimona IN effectuees',auto:false},
      {id:'visite_med',label:'Visites medicales planifiees',auto:false},
    ]},
    {title:'Fiscal',icon:'🧾',items:[
      {id:'pp_config',label:'Précompte professionnel configure',auto:false},
      {id:'sit_familiale',label:'Situations familiales renseignees',auto:false},
      {id:'charges_famille',label:'Charges de famille encodees',auto:false},
    ]},
    {title:'Paie',icon:'💰',items:[
      {id:'salaires',label:'Salaires bruts definis',auto:emps.some(e=>(+(e.monthlySalary||e.gross||0))>0)},
      {id:'cheq_repas',label:'Cheques-repas configures',auto:false},
      {id:'premier_run',label:'Premier calcul de paie effectue',auto:false},
      {id:'sepa_config',label:'Fichier SEPA configure',auto:false},
      {id:'fiches_test',label:'Fiches de paie test generees',auto:false},
    ]},
    {title:'Documents',icon:'📁',items:[
      {id:'mandat',label:'Mandat de gestion signe',auto:false},
      {id:'rgpd',label:'Convention RGPD signee',auto:false},
      {id:'procuration',label:'Procuration Dimona/DmfA',auto:false},
      {id:'grille_tarif',label:'Grille tarifaire validee',auto:false},
    ]},
  ];

  const toggleCheck=(id)=>setChecks(p=>({...p,[id]:!p[id]}));
  const allItems=categories.flatMap(c=>c.items);
  const completed=allItems.filter(item=>item.auto||checks[item.id]).length;
  const pct=Math.round(completed/allItems.length*100);

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>✅ Checklist Dossier Client</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>{completed}/{allItems.length} elements completes — {pct}%</p>
      </div>
      <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>
        {clients.map((c,i)=><option key={i} value={i}>{c.company?.name||'Client '+(i+1)}</option>)}
      </select>
    </div>

    {/* Progress bar */}
    <div style={{marginBottom:20}}>
      <div style={{height:10,background:'rgba(255,255,255,.05)',borderRadius:5,overflow:'hidden'}}>
        <div style={{height:'100%',width:pct+'%',background:pct>=80?'linear-gradient(90deg,#22c55e,#16a34a)':pct>=50?'linear-gradient(90deg,#eab308,#ca8a04)':'linear-gradient(90deg,#ef4444,#dc2626)',borderRadius:5,transition:'width .5s'}}/>
      </div>
    </div>

    {/* Categories */}
    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
      {categories.map((cat,ci)=>{
        const catCompleted=cat.items.filter(item=>item.auto||checks[item.id]).length;
        return <div key={ci} style={{border:'1px solid rgba(198,163,78,.08)',borderRadius:14,overflow:'hidden'}}>
          <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <span style={{fontSize:12,fontWeight:600,color:'#c6a34e'}}>{cat.icon} {cat.title}</span>
            <span style={{fontSize:10,fontWeight:600,color:catCompleted===cat.items.length?'#22c55e':'#888'}}>{catCompleted}/{cat.items.length}</span>
          </div>
          {cat.items.map((item,i)=>{
            const done=item.auto||checks[item.id];
            return <div key={i} onClick={()=>{if(!item.auto)toggleCheck(item.id);}} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',cursor:item.auto?'default':'pointer'}}>
              <span style={{fontSize:14}}>{done?'✅':'⬜'}</span>
              <span style={{fontSize:11,color:done?'#22c55e':'#e5e5e5',textDecoration:done?'line-through':'none'}}>{item.label}</span>
              {item.auto&&<span style={{fontSize:8,padding:'1px 4px',borderRadius:3,background:'rgba(59,130,246,.1)',color:'#3b82f6',marginLeft:'auto'}}>auto</span>}
            </div>;
          })}
        </div>;
      })}
    </div>
  </div>;
};

// ═══ 3. TABLEAU COMPARATIF CONCURRENTS ═══
const ComparatifConcurrents=({})=>{
  const [selView,setSelView]=useState('features');
  const [competitors,setCompetitors]=useState([
    {name:'Aureus Social Pro',us:true,color:'#c6a34e',forfait:'',coutFiche:'',setup:'',engagement:'',tailleCible:'',scores:{interface:0,automatisation:0,belgique:0,prix:0,support:0,integration:0}},
    {name:'SS Mutualiste',color:'#ef4444',forfait:'',coutFiche:'',setup:'',engagement:'',tailleCible:'',scores:{interface:0,automatisation:0,belgique:0,prix:0,support:0,integration:0}},
    {name:'Grand SS National',color:'#3b82f6',forfait:'',coutFiche:'',setup:'',engagement:'',tailleCible:'',scores:{interface:0,automatisation:0,belgique:0,prix:0,support:0,integration:0}},
    {name:'Grand SS International',color:'#a855f7',forfait:'',coutFiche:'',setup:'',engagement:'',tailleCible:'',scores:{interface:0,automatisation:0,belgique:0,prix:0,support:0,integration:0}},
    {name:'Liantis',color:'#22c55e',forfait:'',coutFiche:'',setup:'',engagement:'',tailleCible:'',scores:{interface:0,automatisation:0,belgique:0,prix:0,support:0,integration:0}},
    {name:'Acerta',color:'#eab308',forfait:'',coutFiche:'',setup:'',engagement:'',tailleCible:'',scores:{interface:0,automatisation:0,belgique:0,prix:0,support:0,integration:0}},
  ]);
  const [editMode,setEditMode]=useState(false);
  const [showAddComp,setShowAddComp]=useState(false);
  const [newCompName,setNewCompName]=useState('');

  const featureCats=[
    {cat:'Paie',items:['Calcul brut/net complet','Fiches de paie automatiques','SEPA XML automatique','Simulation brut/net instantanee','Pilote automatique total']},
    {cat:'Declarations',items:['Dimona electronique','DmfA trimestrielle','Belcotax 281.10','Declarations batch']},
    {cat:'Interface',items:['Interface web moderne','Portail client self-service','Portail employe','App mobile','Dark mode']},
    {cat:'Automatisation',items:['Compliance radar temps reel','Smart alerts proactives','Auto-indexation salariale','Export comptable multi-format','Optimisation fiscale integree']},
    {cat:'RH',items:['Gestion absences calendrier','Formation & securite','Bilan social BNB','Simulateur licenciement','Archives GED']},
  ];

  const [features,setFeatures]=useState(()=>{
    const init={};
    featureCats.forEach(cat=>cat.items.forEach(item=>{
      init[item]={};
      competitors.forEach((c,ci)=>{init[item][ci]=ci===0;});// Aureus=true, rest=false by default
    }));
    return init;
  });

  const toggleFeature=(item,ci)=>setFeatures(p=>({...p,[item]:{...p[item],[ci]:!p[item]?.[ci]}}));
  const updateComp=(idx,field,val)=>setCompetitors(p=>p.map((c,i)=>i===idx?{...c,[field]:val}:c));
  const updateScore=(idx,cat,val)=>setCompetitors(p=>p.map((c,i)=>i===idx?{...c,scores:{...c.scores,[cat]:+val}}:c));
  const addCompetitor=()=>{if(!newCompName)return;const colors=['#f97316','#06b6d4','#ec4899','#64748b'];setCompetitors(p=>[...p,{name:newCompName,color:colors[p.length%colors.length],forfait:'',coutFiche:'',setup:'',engagement:'',tailleCible:'',scores:{interface:0,automatisation:0,belgique:0,prix:0,support:0,integration:0}}]);setNewCompName('');setShowAddComp(false);};
  const removeComp=(idx)=>{if(competitors[idx]?.us)return;setCompetitors(p=>p.filter((_,i)=>i!==idx));};

  const scoreCats=['interface','automatisation','belgique','prix','support','integration'];
  const inputS={padding:'4px 6px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:4,color:'#e5e5e5',fontSize:10,fontFamily:'inherit',width:'100%',textAlign:'center'};

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
      <div><h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>\u2694\uFE0F Comparatif Concurrents</h2>
        <p style={{fontSize:12,color:'#888',margin:0}}>Aureus Social Pro vs marche belge — donnees a remplir</p></div>
      <div style={{display:'flex',gap:6}}>
        <button onClick={()=>setShowAddComp(true)} style={{padding:'6px 12px',borderRadius:6,border:'1px solid rgba(198,163,78,.2)',background:'rgba(198,163,78,.06)',color:'#c6a34e',fontSize:10,cursor:'pointer'}}>+ Concurrent</button>
        <button onClick={()=>setEditMode(!editMode)} style={{padding:'6px 12px',borderRadius:6,border:'none',background:editMode?'rgba(34,197,94,.12)':'rgba(198,163,78,.12)',color:editMode?'#22c55e':'#c6a34e',fontSize:10,cursor:'pointer',fontWeight:600}}>{editMode?'\u2705 Terminer':'\u270F\uFE0F Editer'}</button>
      </div>
    </div>

    <div style={{display:'flex',gap:6,marginBottom:16}}>
      {[{id:'features',l:'Fonctionnalites'},{id:'scores',l:'Scores'},{id:'pricing',l:'Tarifs'}].map(v=>
        <button key={v.id} onClick={()=>setSelView(v.id)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:selView===v.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:selView===v.id?'#c6a34e':'#888',fontSize:11,cursor:'pointer',fontWeight:selView===v.id?600:400}}>{v.l}</button>)}
    </div>

    {selView==='features'&&<div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'auto'}}>
      <div style={{display:'grid',gridTemplateColumns:'200px repeat('+competitors.length+',1fr)',padding:'8px 12px',background:'rgba(198,163,78,.06)',minWidth:200+competitors.length*90}}>
        <div></div>
        {competitors.map((c,ci)=><div key={ci} style={{textAlign:'center',fontSize:9,fontWeight:700,color:c.us?'#c6a34e':c.color}}>{c.name}{c.us?' \u2B50':''}{!c.us&&editMode&&<button onClick={()=>removeComp(ci)} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',fontSize:8,marginLeft:4}}>\u2715</button>}</div>)}
      </div>
      {featureCats.map((cat,ci)=><div key={ci}>
        <div style={{padding:'6px 12px',background:'rgba(255,255,255,.02)',fontSize:10,fontWeight:600,color:'#888',textTransform:'uppercase',letterSpacing:1}}>{cat.cat}</div>
        {cat.items.map((item,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'200px repeat('+competitors.length+',1fr)',padding:'5px 12px',borderBottom:'1px solid rgba(255,255,255,.02)',fontSize:11,minWidth:200+competitors.length*90}}>
          <div style={{color:'#e5e5e5'}}>{item}</div>
          {competitors.map((c,cj)=><div key={cj} style={{textAlign:'center',fontSize:14,cursor:editMode?'pointer':'default'}} onClick={()=>{if(editMode)toggleFeature(item,cj);}}>{features[item]?.[cj]?'\u2705':'\u274C'}</div>)}
        </div>)}
      </div>)}
    </div>}

    {selView==='scores'&&<div style={{display:'grid',gridTemplateColumns:'repeat('+Math.min(competitors.length,3)+',1fr)',gap:12}}>
      {competitors.map((c,ci)=><div key={ci} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'2px solid '+(c.us?'rgba(198,163,78,.3)':c.color+'20'),borderRadius:14}}>
        <div style={{fontSize:14,fontWeight:700,color:c.us?'#c6a34e':c.color,marginBottom:10}}>{c.us?'\u2B50 ':''}{c.name}</div>
        {scoreCats.map(cat=>{const score=c.scores[cat];return <div key={cat} style={{marginBottom:6}}>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:9,marginBottom:2}}>
            <span style={{color:'#888',textTransform:'capitalize'}}>{cat}</span>
            {editMode?<input type="number" min={0} max={100} value={score} onChange={e=>updateScore(ci,cat,e.target.value)} style={{width:40,padding:'1px 3px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:3,color:c.us?'#c6a34e':c.color,fontSize:9,textAlign:'right',fontFamily:'inherit'}}/>
            :<span style={{color:score>=80?'#22c55e':score>=60?'#eab308':score>0?'#ef4444':'#555',fontWeight:600}}>{score>0?score+'%':'—'}</span>}
          </div>
          <div style={{height:5,background:'rgba(255,255,255,.05)',borderRadius:3,overflow:'hidden'}}>
            <div style={{height:'100%',width:score+'%',background:c.us?'#c6a34e':c.color,borderRadius:3}}/>
          </div>
        </div>;})}
        {Object.values(c.scores).some(v=>v>0)&&<div style={{marginTop:8,textAlign:'center',fontSize:16,fontWeight:800,color:c.us?'#c6a34e':c.color}}>{Math.round(Object.values(c.scores).reduce((a,v)=>a+v,0)/scoreCats.length)}%</div>}
        {Object.values(c.scores).every(v=>v===0)&&<div style={{marginTop:8,textAlign:'center',fontSize:10,color:'#555'}}>Scores a remplir</div>}
      </div>)}
    </div>}

    {selView==='pricing'&&<div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'auto'}}>
      <div style={{display:'grid',gridTemplateColumns:'140px repeat('+competitors.length+',1fr)',padding:'8px 12px',background:'rgba(198,163,78,.06)',fontSize:9,fontWeight:600,color:'#c6a34e',minWidth:140+competitors.length*100}}>
        <div>Critere</div>{competitors.map((c,ci)=><div key={ci} style={{textAlign:'center',color:c.us?'#c6a34e':c.color}}>{c.name}</div>)}
      </div>
      {[{l:'Forfait mensuel',k:'forfait'},{l:'Cout/fiche',k:'coutFiche'},{l:'Frais setup',k:'setup'},{l:'Engagement',k:'engagement'},{l:'Taille cible',k:'tailleCible'}].map((row,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'140px repeat('+competitors.length+',1fr)',padding:'6px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,minWidth:140+competitors.length*100}}>
        <div style={{color:'#888',fontWeight:500}}>{row.l}</div>
        {competitors.map((c,ci)=><div key={ci} style={{textAlign:'center'}}>
          {editMode?<input value={c[row.k]||''} onChange={e=>updateComp(ci,row.k,e.target.value)} placeholder="..." style={inputS}/>
          :<span style={{color:c.us?'#c6a34e':'#e5e5e5',fontWeight:c.us?600:400}}>{c[row.k]||<span style={{color:'#555'}}>—</span>}</span>}
        </div>)}
      </div>)}
    </div>}

    {!editMode&&<div style={{marginTop:14,padding:10,background:'rgba(198,163,78,.03)',border:'1px solid rgba(198,163,78,.08)',borderRadius:8,fontSize:10,color:'#888',textAlign:'center'}}>\u270F\uFE0F Cliquez "Editer" pour remplir les donnees concurrents (prix, scores, fonctionnalites)</div>}

    {showAddComp&&<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.6)',zIndex:999,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={()=>setShowAddComp(false)}>
      <div onClick={e=>e.stopPropagation()} style={{background:'#0d1117',border:'1px solid rgba(198,163,78,.2)',borderRadius:16,padding:24,width:360}}>
        <h3 style={{fontSize:16,fontWeight:700,color:'#c6a34e',marginBottom:14}}>Ajouter un concurrent</h3>
        <input value={newCompName} onChange={e=>setNewCompName(e.target.value)} placeholder="Nom du concurrent" style={{width:'100%',padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',marginBottom:10}}/>
        <div style={{display:'flex',gap:8}}><button onClick={addCompetitor} style={{flex:1,padding:'10px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>Ajouter</button><button onClick={()=>setShowAddComp(false)} style={{padding:'10px 16px',borderRadius:8,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'#888',fontSize:12,cursor:'pointer'}}>Annuler</button></div>
      </div>
    </div>}
  </div>;
};

const DueDiligenceSociale=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const cl=clients[selClient];
  const co=cl?.company||{};
  const emps=cl?.emps||[];
  const now=new Date();

  const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);
  const totalCoutAn=Math.round(totalBrut*(1+TX_ONSS_E)*12*100)/100;
  const cddCount=emps.filter(e=>(e.contractType||'')==='CDD').length;
  const avgAnc=emps.length>0?Math.round(emps.reduce((a,e)=>{const sd=new Date(e.startDate||e.start||'2020-01-01');return a+((now-sd)/31557600000);},0)/emps.length*10)/10:0;

  // Risk assessment
  const risks=[];
  if(cddCount>emps.length*0.3) risks.push({level:'high',title:'Ratio CDD eleve ('+Math.round(cddCount/emps.length*100)+'%)',desc:'Risque de requalification en CDI'});
  if(emps.some(e=>(+(e.monthlySalary||0))<=0)) risks.push({level:'high',title:'Salaires a zero detectes',desc:'Anomalie de donnees — verification requise'});
  if(emps.some(e=>!(e.niss||e.NISS))) risks.push({level:'medium',title:'NISS manquants',desc:emps.filter(e=>!(e.niss||e.NISS)).length+' employe(s) sans NISS'});
  if(avgAnc>10) risks.push({level:'medium',title:'Anciennete moyenne elevee ('+avgAnc+' ans)',desc:'Provisions preavis importantes en cas de restructuration'});
  if(!co.vat) risks.push({level:'high',title:'N° BCE manquant',desc:'Identification entreprise incomplete'});
  if(emps.length===0) risks.push({level:'high',title:'Aucun employé',desc:'Dossier vide'});
  else{
    risks.push({level:'low',title:'Effectif stable ('+emps.length+')',desc:'Pas d\'anomalie de masse salariale detectee'});
    if(cddCount===0) risks.push({level:'low',title:'100% CDI',desc:'Stabilite contractuelle excellente'});
  }

  // Provisions
  const provPreavis=emps.reduce((a,e)=>{
    const br=+(e.monthlySalary||e.gross||0);
    const anc=(now-new Date(e.startDate||e.start||'2020-01-01'))/31557600000;
    const sem=anc<1?4:anc<3?6:anc<5?9:anc<10?15:anc<15?21:anc<20?36:51;
    return a+br*12/52*sem;
  },0);
  const provPV=totalBrut*PV_SIMPLE*12;
  const prov13=totalBrut*12;

  const globalScore=risks.filter(r=>r.level==='high').length===0?
    risks.filter(r=>r.level==='medium').length===0?'A':'B':'C';

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🔍 Due Diligence Sociale</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Audit pre-acquisition — analyse risques sociaux</p>
      </div>
      <div style={{display:'flex',gap:8,alignItems:'center'}}>
        <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
        </select>
        <div style={{width:44,height:44,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:18,fontWeight:900,color:globalScore==='A'?'#22c55e':globalScore==='B'?'#eab308':'#ef4444',border:'3px solid '+(globalScore==='A'?'#22c55e':globalScore==='B'?'#eab308':'#ef4444')+'40',background:(globalScore==='A'?'#22c55e':globalScore==='B'?'#eab308':'#ef4444')+'10'}}>{globalScore}</div>
      </div>
    </div>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Effectif',v:emps.length,c:'#3b82f6'},{l:'Cout annuel',v:f2(totalCoutAn)+' EUR',c:'#c6a34e'},{l:'Anc. moyenne',v:avgAnc+' ans',c:'#a855f7'},{l:'Prov. preavis',v:f2(provPreavis)+' EUR',c:'#ef4444'},{l:'Score risque',v:globalScore,c:globalScore==='A'?'#22c55e':globalScore==='B'?'#eab308':'#ef4444'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
          <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
      {/* Risks */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Analyse des risques ({risks.length})</div>
        {risks.map((r,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <span style={{fontSize:14}}>{r.level==='high'?'🔴':r.level==='medium'?'🟡':'🟢'}</span>
          <div>
            <div style={{fontSize:11,fontWeight:600,color:r.level==='high'?'#ef4444':r.level==='medium'?'#eab308':'#22c55e'}}>{r.title}</div>
            <div style={{fontSize:9,color:'#888'}}>{r.desc}</div>
          </div>
        </div>)}
      </div>

      {/* Provisions */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Provisions a constituer</div>
        {[{l:'Provisions preavis',v:f2(provPreavis)+' EUR',c:'#ef4444',desc:'Indemnites en cas de licenciement total'},
          {l:'Pecules vacances',v:f2(provPV)+' EUR',c:'#eab308',desc:'Provision prorata annuelle'},
          {l:'13eme mois',v:f2(prov13)+' EUR',c:'#3b82f6',desc:'Prime de fin d\'annee (CP 200)'},
          {l:'TOTAL PROVISIONS',v:f2(provPreavis+provPV+prov13)+' EUR',c:'#c6a34e',bold:true},
        ].map((p,i)=><div key={i} style={{padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <div style={{display:'flex',justifyContent:'space-between'}}>
            <span style={{fontSize:11,color:p.bold?'#c6a34e':'#e5e5e5',fontWeight:p.bold?700:500}}>{p.l}</span>
            <span style={{fontSize:12,fontWeight:700,color:p.c,fontFamily:'monospace'}}>{p.v}</span>
          </div>
          {p.desc&&<div style={{fontSize:9,color:'#888',marginTop:2}}>{p.desc}</div>}
        </div>)}
      </div>
    </div>
  </div>;
};

const AuthMultiRoles=({s,d})=>{
  const [roles,setRoles]=useState([
    {id:'admin',name:'Administrateur',icon:'👑',color:'#c6a34e',desc:'Acces total — configuration, facturation, utilisateurs',perms:['all']},
    {id:'gestionnaire',name:'Gestionnaire Paie',icon:'💼',color:'#3b82f6',desc:'Gestion paie, declarations, documents — pas facturation',perms:['paie','onss','fiscal','contrats','rh','documents','reporting']},
    {id:'client',name:'Client Fiduciaire',icon:'🏢',color:'#22c55e',desc:'Consultation fiches, demandes, messagerie — lecture seule paie',perms:['portail','fiches','demandes','messages','documents_read']},
    {id:'employe',name:'Employé',icon:'👤',color:'#a855f7',desc:'Ses propres fiches, absences, documents personnels',perms:['mes_fiches','mes_absences','mes_documents','profil']},
    {id:'comptable',name:'Comptable externe',icon:'📒',color:'#eab308',desc:'Exports comptables, journaux, reconciliation',perms:['export_compta','journaux','reporting_read']},
  ]);
  const [users,setUsers]=useState([
    {id:1,name:'Admin Principal',email:'admin@aureussocial.be',role:'admin',active:true,lastLogin:'2026-02-20 09:14'},
    {id:2,name:'Marie Dupont',email:'marie@aureussocial.be',role:'gestionnaire',active:true,lastLogin:'2026-02-20 08:30'},
    {id:3,name:'Jean Martin',email:'jean@client.be',role:'client',active:true,lastLogin:'2026-02-19 16:45',client:'ACME SA'},
    {id:4,name:'Sophie Leroy',email:'sophie@employe.be',role:'employe',active:true,lastLogin:'2026-02-18 14:20',client:'ACME SA'},
    {id:5,name:'Pierre Comptable',email:'pierre@fiduciaire.be',role:'comptable',active:false,lastLogin:'2026-02-15 11:00'},
  ]);
  const [selRole,setSelRole]=useState('admin');
  const [showAdd,setShowAdd]=useState(false);
  const [newUser,setNewUser]=useState({name:'',email:'',role:'gestionnaire'});

  const allPerms=[
    {id:'all',label:'Acces total',cat:'System'},
    {id:'paie',label:'Gestion paie',cat:'Paie'},{id:'onss',label:'Declarations ONSS',cat:'Paie'},{id:'fiscal',label:'Fiscal & Belcotax',cat:'Paie'},
    {id:'contrats',label:'Contrats & RH',cat:'RH'},{id:'rh',label:'Dashboard RH',cat:'RH'},
    {id:'documents',label:'Documents (lecture+ecriture)',cat:'Documents'},{id:'documents_read',label:'Documents (lecture)',cat:'Documents'},
    {id:'reporting',label:'Reporting complet',cat:'Reporting'},{id:'reporting_read',label:'Reporting (lecture)',cat:'Reporting'},
    {id:'export_compta',label:'Export comptable',cat:'Compta'},{id:'journaux',label:'Journaux comptables',cat:'Compta'},
    {id:'portail',label:'Portail client',cat:'Client'},{id:'fiches',label:'Fiches de paie',cat:'Client'},{id:'demandes',label:'Demandes',cat:'Client'},{id:'messages',label:'Messagerie',cat:'Client'},
    {id:'mes_fiches',label:'Mes fiches',cat:'Employé'},{id:'mes_absences',label:'Mes absences',cat:'Employé'},{id:'mes_documents',label:'Mes documents',cat:'Employé'},{id:'profil',label:'Mon profil',cat:'Employé'},
  ];

  const selRoleData=roles.find(r=>r.id===selRole);

  const addUser=()=>{
    if(!newUser.name||!newUser.email)return;
    setUsers(p=>[...p,{...newUser,id:Date.now(),active:true,lastLogin:'Jamais'}]);
    setShowAdd(false);setNewUser({name:'',email:'',role:'gestionnaire'});
  };

  // Pages accessible per role
  const rolePages={
    admin:{sections:['AUTOMATISATION','PAIE & SOCIAL','RH & CONTRATS','OUTILS & ADMIN'],count:'88/88'},
    gestionnaire:{sections:['AUTOMATISATION','PAIE & SOCIAL','RH & CONTRATS'],count:'72/88'},
    client:{sections:['PORTAIL CLIENT'],count:'7/88'},
    employe:{sections:['ESPACE EMPLOYE'],count:'5/88'},
    comptable:{sections:['EXPORTS','REPORTING'],count:'12/88'},
  };

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🔐 Gestion Roles & Permissions</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>5 roles — {users.length} utilisateurs — controle d'acces granulaire</p>
      </div>
      <button onClick={()=>setShowAdd(true)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>+ Nouvel utilisateur</button>
    </div>

    <div style={{display:'grid',gridTemplateColumns:'260px 1fr',gap:16}}>
      {/* Roles sidebar */}
      <div style={{display:'flex',flexDirection:'column',gap:6}}>
        <div style={{fontSize:11,fontWeight:600,color:'#888',marginBottom:4,textTransform:'uppercase',letterSpacing:1}}>Roles</div>
        {roles.map(r=><button key={r.id} onClick={()=>setSelRole(r.id)} style={{display:'flex',alignItems:'center',gap:10,padding:'12px',borderRadius:10,border:selRole===r.id?'2px solid '+r.color:'1px solid rgba(255,255,255,.05)',background:selRole===r.id?r.color+'10':'rgba(255,255,255,.02)',cursor:'pointer',textAlign:'left'}}>
          <span style={{fontSize:22}}>{r.icon}</span>
          <div style={{flex:1}}>
            <div style={{fontSize:12,fontWeight:600,color:selRole===r.id?r.color:'#e5e5e5'}}>{r.name}</div>
            <div style={{fontSize:9,color:'#888'}}>{users.filter(u=>u.role===r.id).length} utilisateur(s)</div>
          </div>
          <span style={{fontSize:10,fontWeight:600,color:r.color}}>{rolePages[r.id]?.count}</span>
        </button>)}
      </div>

      {/* Role detail */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        {selRoleData&&<>
          <div style={{padding:16,background:selRoleData.color+'08',borderBottom:'1px solid '+selRoleData.color+'15'}}>
            <div style={{display:'flex',alignItems:'center',gap:10}}>
              <span style={{fontSize:28}}>{selRoleData.icon}</span>
              <div>
                <div style={{fontSize:16,fontWeight:700,color:selRoleData.color}}>{selRoleData.name}</div>
                <div style={{fontSize:11,color:'#888'}}>{selRoleData.desc}</div>
              </div>
            </div>
          </div>

          {/* Permissions grid */}
          <div style={{padding:16}}>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Permissions</div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:4}}>
              {allPerms.map(p=>{
                const hasAll=selRoleData.perms.includes('all');
                const has=hasAll||selRoleData.perms.includes(p.id);
                const togglePerm=()=>{
                  setRoles(prev=>prev.map(r=>{
                    if(r.id!==selRole)return r;
                    let newPerms=[...r.perms];
                    if(p.id==='all'){
                      newPerms=has?[]:['all'];
                    }else if(hasAll){
                      newPerms=allPerms.map(ap=>ap.id).filter(id=>id!=='all'&&id!==p.id);
                    }else if(has){
                      newPerms=newPerms.filter(x=>x!==p.id);
                    }else{
                      newPerms=[...newPerms,p.id];
                      const allNonSystem=allPerms.filter(ap=>ap.id!=='all').map(ap=>ap.id);
                      if(allNonSystem.every(id=>newPerms.includes(id)))newPerms=['all'];
                    }
                    return {...r,perms:newPerms};
                  }));
                };
                return <button key={p.id} onClick={togglePerm} style={{display:'flex',alignItems:'center',gap:6,padding:'5px 8px',borderRadius:6,background:has?'rgba(34,197,94,.05)':'rgba(255,255,255,.01)',border:'1px solid '+(has?'rgba(34,197,94,.1)':'rgba(255,255,255,.03)'),cursor:'pointer',textAlign:'left',fontFamily:'inherit',transition:'all .15s'}}>
                  <span style={{width:16,height:16,borderRadius:4,border:'2px solid '+(has?'#22c55e':'#555'),background:has?'#22c55e':'transparent',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,color:'#fff',flexShrink:0,transition:'all .15s'}}>{has?'✓':''}</span>
                  <span style={{fontSize:10,color:has?'#e5e5e5':'#555'}}>{p.label}</span>
                </button>;
              })}
            </div>

            {/* Sections access */}
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginTop:16,marginBottom:8}}>Sections accessibles</div>
            <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
              {(rolePages[selRole]?.sections||[]).map((s,i)=><span key={i} style={{fontSize:10,padding:'4px 10px',borderRadius:6,background:'rgba(198,163,78,.08)',color:'#c6a34e',border:'1px solid rgba(198,163,78,.12)'}}>{s}</span>)}
            </div>

            {/* Users with this role */}
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginTop:16,marginBottom:8}}>Utilisateurs ({users.filter(u=>u.role===selRole).length})</div>
            {users.filter(u=>u.role===selRole).map(u=><div key={u.id} style={{display:'flex',alignItems:'center',gap:10,padding:'8px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <div style={{width:32,height:32,borderRadius:'50%',background:selRoleData.color+'15',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,color:selRoleData.color,fontWeight:700}}>{u.name.charAt(0)}</div>
              <div style={{flex:1}}>
                <div style={{fontSize:11,fontWeight:600,color:'#e5e5e5'}}>{u.name}</div>
                <div style={{fontSize:9,color:'#888'}}>{u.email}{u.client?' — '+u.client:''}</div>
              </div>
              <div style={{width:8,height:8,borderRadius:'50%',background:u.active?'#22c55e':'#ef4444'}}/>
              <span style={{fontSize:9,color:'#888'}}>{u.lastLogin}</span>
            </div>)}
          </div>
        </>}
      </div>
    </div>

    {/* Add user modal */}
    {showAdd&&<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.6)',zIndex:999,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={()=>setShowAdd(false)}>
      <div onClick={e=>e.stopPropagation()} style={{background:'#0d1117',border:'1px solid rgba(198,163,78,.2)',borderRadius:16,padding:24,width:400}}>
        <h3 style={{fontSize:16,fontWeight:700,color:'#c6a34e',marginBottom:14}}>Nouvel utilisateur</h3>
        <div style={{marginBottom:10}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Nom</label><input value={newUser.name} onChange={e=>setNewUser(p=>({...p,name:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
        <div style={{marginBottom:10}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Email</label><input value={newUser.email} onChange={e=>setNewUser(p=>({...p,email:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
        <div style={{marginBottom:14}}><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Role</label>
          <select value={newUser.role} onChange={e=>setNewUser(p=>({...p,role:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
            {roles.map(r=><option key={r.id} value={r.id}>{r.icon} {r.name}</option>)}
          </select>
        </div>
        <div style={{display:'flex',gap:8}}>
          <button onClick={addUser} style={{flex:1,padding:'10px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>Creer</button>
          <button onClick={()=>setShowAdd(false)} style={{padding:'10px 16px',borderRadius:8,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'#888',fontSize:12,cursor:'pointer'}}>Annuler</button>
        </div>
      </div>
    </div>}
  </div>;
};

// ═══ 2. BARÈMES PP OFFICIELS SPF — Tables exactes 2026 ═══
const BaremesPPOfficiel=({s})=>{
  const ae=s.emps||[];
  const [tab,setTab]=useState('calc');
  const [brutM,setBrutM]=useState(3500);
  const [statut,setStatut]=useState('salarie');
  const [bareme,setBareme]=useState('1');
  const [enfants,setEnfants]=useState(0);
  const [enfantsH,setEnfantsH]=useState(0);
  const [isole,setIsole]=useState(false);
  const [handicap,setHandicap]=useState(false);
  const [conjHandicap,setConjHandicap]=useState(false);
  const [conjRevLimite,setConjRevLimite]=useState(false);
  const [conjPensionLim,setConjPensionLim]=useState(false);
  const [dep65,setDep65]=useState(0);
  const [depAutres,setDepAutres]=useState(0);
  const [txComm,setTxComm]=useState(7);
  const [selEmp,setSelEmp]=useState(null);

  // ===================================================================
  // SYSTEME 1: BAREMES VERSIONES PAR ANNEE (Supabase-ready)
  // ===================================================================
  const BAREMES_DB={
    2025:{
      version:'2025.1.0',source:'AR 15/12/2024 - Moniteur Belge',datePublication:'2024-12-20',
      tranches:[{min:0,max:15830,taux:0.2675,base:0},{min:15830,max:27940,taux:0.4280,base:4234.53},{min:27940,max:48350,taux:0.4815,base:9417.61},{min:48350,max:Infinity,taux:0.5350,base:19245.03}],
      fraisPro:{salarie:{pct:0.30,max:5930},dirigeant:{pct:0.03,max:3120}},
      quotiteExemptee:{bareme1:2915.75,bareme2:5831.50},
      quotientConjugal:{pct:0.30,max:12520},
      redEnfants:[0,588,1572,4164,7212,10512,13812,17148,20808],redEnfantSupp:3660,
      redIsoleEnfants:612,redHandicap:612,redConjHandicap:612,redConjRevLimite:1698,redConjPensionLim:3390,redDep65:1944,redDepAutre:612,
      bonusEmploiPct:0.3314,onssW:TX_ONSS_W,
    },
    2026:{
      version:'2026.1.0',source:'AR 12/2025 - Annexe III Formule-cle SPF Finances',datePublication:'2025-12-15',
      tranches:[{min:0,max:16710,taux:0.2675,base:0},{min:16710,max:29500,taux:0.4280,base:4469.93},{min:29500,max:51050,taux:0.4815,base:9944.05},{min:51050,max:Infinity,taux:0.5350,base:20320.38}],
      fraisPro:{salarie:{pct:0.30,max:6070},dirigeant:{pct:0.03,max:3120}},
      quotiteExemptee:{bareme1:2987.98,bareme2:5975.96},
      quotientConjugal:{pct:0.30,max:12520},
      redEnfants:[0,624,1656,4404,7620,11100,14592,18120,21996],redEnfantSupp:3864,
      redIsoleEnfants:624,redHandicap:624,redConjHandicap:624,redConjRevLimite:1698,redConjPensionLim:3390,redDep65:1992,redDepAutre:624,
      bonusEmploiPct:0.3314,onssW:TX_ONSS_W,
    },
  };

  const currentYear=new Date().getFullYear();
  const [activeYear,setActiveYear]=useState(currentYear);
  const [customBaremes,setCustomBaremes]=useState(()=>{
    try{const saved=(()=>{try{return JSON.parse(safeLS.get('aureus_baremes_custom'))}catch(e){return null}})()||{};return saved;}catch(e){return {};}
  });

  // Merge: custom overrides > DB
  const getBareme=(year)=>{
    const base=BAREMES_DB[year]||BAREMES_DB[2026];
    const custom=customBaremes[year];
    if(!custom)return {...base,_source:'builtin'};
    return {...base,...custom,_source:'custom',_customDate:custom._savedAt};
  };
  const PP=getBareme(activeYear);

  // ===================================================================
  // SYSTEME 2: AUTO-UPDATE QUOTIDIEN
  // ===================================================================
  const [updateStatus,setUpdateStatus]=useState({checking:false,lastCheck:null,lastResult:null,history:[]});
  const [autoUpdateEnabled,setAutoUpdateEnabled]=useState(()=>{
    try{return safeLS.get('aureus_autoupdate')!=='false';}catch(e){return true;}
  });

  const SPF_SOURCES=[
    {name:'SPF Finances',url:'https://finances.belgium.be/fr/entreprises/personnel_et_rémunération/precompte_professionnel/calcul',type:'official'},
    {name:'Refli.be',url:'https://refli.be/fr/documentation/computation/tax',type:'reference'},
    {name:'Calculateur-de-salaire.be',url:'https://calculateur-de-salaire.be/guide/precompte-professionnel-belgique',type:'reference'},
    {name:'Veille SS',url:'https://www.socialsecurity.be',type:'secondary'},
    {name:'CGSLB',url:'https://www.cgslb.be/fr/precompte-professionnel',type:'secondary'},
  ];

  // Auto-check on mount + every 24h
  useEffect(()=>{
    if(!autoUpdateEnabled)return;
    const checkNeeded=()=>{
      try{
        const last=safeLS.get('aureus_pp_lastcheck');
        if(!last)return true;
        const diff=Date.now()-parseInt(last);
        return diff>86400000; // 24h in ms
      }catch(e){return true;}
    };
    if(checkNeeded()){runAutoCheck();}
    const interval=setInterval(()=>{if(checkNeeded())runAutoCheck();},3600000); // re-check every 1h if 24h passed
    return ()=>clearInterval(interval);
  },[autoUpdateEnabled]);

  const runAutoCheck=async()=>{
    setUpdateStatus(p=>({...p,checking:true}));
    const now=new Date();
    let detectedChanges=false;
    let results=[];

    try{
      const resp=await fetch('/api/veille-juridique?manual=true');
      const data=await resp.json();
      detectedChanges=data.status==='CHANGES_DETECTED';
      results=data.sources?.map(s=>({source:s.source,url:'',status:s.status,time:now.toISOString(),type:s.priority,changes:s.changesDetected,fetchTime:s.fetchTime}))||[];
      if(data.changes?.length>0){
        results.push({source:'⚠️ Changements',status:'CHANGES_DETECTED',message:data.changes.map(c=>c.label+': '+c.current+' → '+c.detected).join(', '),time:now.toISOString()});
      }
      if(data.alerts?.length>0){
        for(const a of data.alerts){
          results.push({source:'🔔 '+a.type,status:a.severity,message:a.text,time:now.toISOString()});
        }
      }
    }catch(e){
      results=[{source:'API veille-juridique',status:'error',error:e.message,time:now.toISOString()}];
    }

    const entry={date:now.toISOString(),results,detectedChanges,yearChecked:now.getFullYear()};

    setUpdateStatus(p=>({
      checking:false,
      lastCheck:now.toISOString(),
      lastResult:detectedChanges?'CHANGES_DETECTED':'UP_TO_DATE',
      history:[entry,...(p.history||[]).slice(0,29)],
    }));

    try{
      safeLS.set('aureus_pp_lastcheck',Date.now().toString());
      safeLS.set('aureus_pp_history',JSON.stringify([entry,...((()=>{try{return JSON.parse(safeLS.get('aureus_pp_history'))}catch(e){return null}})()||[])].slice(0,30)));
    }catch(e){}
  };

  // Load history from localStorage on mount
  useEffect(()=>{
    try{
      const hist=(()=>{try{return JSON.parse(safeLS.get('aureus_pp_history'))}catch(e){return null}})()||[];
      const last=safeLS.get('aureus_pp_lastcheck');
      setUpdateStatus(p=>({...p,history:hist,lastCheck:last?new Date(parseInt(last)).toISOString():null}));
    }catch(e){}
  },[]);

  // ===================================================================
  // SYSTEME 3: ADMIN PANEL - EDITION MANUELLE DES CONSTANTES
  // ===================================================================
  const [editMode,setEditMode]=useState(false);
  const [editData,setEditData]=useState(null);

  const startEdit=()=>{
    const b=getBareme(activeYear);
    setEditData({
      tranches:b.tranches.map(t=>({...t,max:t.max===Infinity?999999:t.max})),
      fraisPro:{...b.fraisPro},
      quotiteExemptee:{...b.quotiteExemptee},
      quotientConjugal:{...b.quotientConjugal},
      redEnfants:[...b.redEnfants],
      redEnfantSupp:b.redEnfantSupp,
      redIsoleEnfants:b.redIsoleEnfants,
      redHandicap:b.redHandicap,
      redConjHandicap:b.redConjHandicap,
      redConjRevLimite:b.redConjRevLimite,
      redConjPensionLim:b.redConjPensionLim,
      redDep65:b.redDep65,
      redDepAutre:b.redDepAutre,
      bonusEmploiPct:b.bonusEmploiPct,
      onssW:b.onssW,
    });
    setEditMode(true);
  };

  const saveEdit=()=>{
    if(!editData)return;
    const cleaned={...editData,_savedAt:new Date().toISOString(),_savedBy:'admin'};
    cleaned.tranches=cleaned.tranches.map((t,i)=>({...t,max:i===cleaned.tranches.length-1?Infinity:t.max}));
    const updated={...customBaremes,[activeYear]:cleaned};
    setCustomBaremes(updated);
    safeLS.set('aureus_baremes_custom',JSON.stringify(updated));
    setEditMode(false);
    setEditData(null);
  };

  const resetToDefault=()=>{
    const updated={...customBaremes};
    delete updated[activeYear];
    setCustomBaremes(updated);
    safeLS.set('aureus_baremes_custom',JSON.stringify(updated));
    setEditMode(false);
    setEditData(null);
  };

  const updateEditTranche=(idx,field,val)=>{
    setEditData(p=>{
      const tr=[...p.tranches];
      tr[idx]={...tr[idx],[field]:parseFloat(val)||0};
      return {...p,tranches:tr};
    });
  };

  const updateEditField=(path,val)=>{
    setEditData(p=>{
      const parts=path.split('.');
      const obj={...p};
      let curr=obj;
      for(let i=0;i<parts.length-1;i++){
        curr[parts[i]]={...curr[parts[i]]};
        curr=curr[parts[i]];
      }
      curr[parts[parts.length-1]]=parseFloat(val)||0;
      return obj;
    });
  };

  // ===================================================================
  // MOTEUR DE CALCUL (identique, utilise PP dynamique)
  // ===================================================================
  const calcImpot=(revAnnuelNet)=>{
    if(revAnnuelNet<=0)return 0;
    const tr=PP.tranches;
    for(let i=tr.length-1;i>=0;i--){
      if(revAnnuelNet>tr[i].min){
        return tr[i].base+(revAnnuelNet-tr[i].min)*tr[i].taux;
      }
    }
    return 0;
  };

  const calculPP=(brutMensuel,opts={})=>{
    const st=opts.statut||statut;
    const bar=opts.bareme||bareme;
    const nEnf=opts.enfants!=null?opts.enfants:enfants;
    const nEnfH=opts.enfantsH!=null?opts.enfantsH:enfantsH;
    const iso=opts.isole!=null?opts.isole:isole;
    const handi=opts.handicap!=null?opts.handicap:handicap;
    const cjH=opts.conjHandicap!=null?opts.conjHandicap:conjHandicap;
    const cjRL=opts.conjRevLimite!=null?opts.conjRevLimite:conjRevLimite;
    const cjPL=opts.conjPensionLim!=null?opts.conjPensionLim:conjPensionLim;
    const n65=opts.dep65!=null?opts.dep65:dep65;
    const nAut=opts.depAutres!=null?opts.depAutres:depAutres;
    const tc=opts.txComm!=null?opts.txComm:txComm;
    const steps={};
    const onss=Math.round(brutMensuel*PP.onssW*100)/100;
    const imposable=Math.round((brutMensuel-onss)*100)/100;
    steps.brutMensuel=brutMensuel;steps.onss=onss;steps.imposable=imposable;
    const brutAnnuel=Math.round(imposable*12*100)/100;
    steps.brutAnnuel=brutAnnuel;
    const fp=PP.fraisPro[st==='dirigeant'?'dirigeant':'salarie'];
    const fraisPro=Math.min(Math.round(brutAnnuel*fp.pct*100)/100,fp.max);
    steps.fraisPro=fraisPro;
    const revNetImpo=Math.round((brutAnnuel-fraisPro)*100)/100;
    steps.revNetImpo=revNetImpo;
    let impotAnnuel=0;
    if(bar==='2'){
      const qc=Math.min(Math.round(revNetImpo*PP.quotientConjugal.pct*100)/100,PP.quotientConjugal.max);
      const partTrav=revNetImpo-qc;
      const impotTrav=calcImpot(partTrav);
      const impotConj=calcImpot(qc);
      impotAnnuel=Math.round((impotTrav+impotConj)*100)/100;
      steps.quotientConjugal=qc;steps.partTravailleur=partTrav;steps.impotTrav=impotTrav;steps.impotConj=impotConj;
    }else{impotAnnuel=Math.round(calcImpot(revNetImpo)*100)/100;}
    steps.impotBrut=impotAnnuel;
    const redQE=bar==='2'?PP.quotiteExemptee.bareme2:PP.quotiteExemptee.bareme1;
    impotAnnuel=Math.max(0,impotAnnuel-redQE);steps.redQuotiteExemptee=redQE;
    const totalEnfEq=nEnf+nEnfH*2;
    let redEnf=0;
    if(totalEnfEq>0){if(totalEnfEq<=8){redEnf=PP.redEnfants[totalEnfEq];}else{redEnf=PP.redEnfants[8]+(totalEnfEq-8)*PP.redEnfantSupp;}}
    impotAnnuel=Math.max(0,impotAnnuel-redEnf);steps.redEnfants=redEnf;steps.totalEnfEquiv=totalEnfEq;
    let redIso=iso&&totalEnfEq>0?PP.redIsoleEnfants:0;impotAnnuel=Math.max(0,impotAnnuel-redIso);steps.redIsole=redIso;
    let redH=handi?PP.redHandicap:0;impotAnnuel=Math.max(0,impotAnnuel-redH);steps.redHandicap=redH;
    let redCH=cjH&&bar==='2'?PP.redConjHandicap:0;impotAnnuel=Math.max(0,impotAnnuel-redCH);steps.redConjHandicap=redCH;
    let redCRL=cjRL?PP.redConjRevLimite:0;impotAnnuel=Math.max(0,impotAnnuel-redCRL);steps.redConjRevLimite=redCRL;
    let redCPL=cjPL?PP.redConjPensionLim:0;impotAnnuel=Math.max(0,impotAnnuel-redCPL);steps.redConjPensionLim=redCPL;
    let red65=n65*PP.redDep65;impotAnnuel=Math.max(0,impotAnnuel-red65);steps.redDep65=red65;
    let redAut=nAut*PP.redDepAutre;impotAnnuel=Math.max(0,impotAnnuel-redAut);steps.redDepAutres=redAut;
    steps.impotApresReductions=impotAnnuel;
    const taxeComm=Math.round(impotAnnuel*tc/100*100)/100;
    const impotTotal=Math.round((impotAnnuel+taxeComm)*100)/100;
    steps.taxeComm=taxeComm;steps.impotTotal=impotTotal;
    const ppMensuel=Math.round(impotTotal/12*100)/100;steps.ppMensuel=ppMensuel;
    const net=Math.round((imposable-ppMensuel)*100)/100;steps.net=net;
    steps.totalReductions=Math.round((redQE+redEnf+redIso+redH+redCH+redCRL+redCPL+red65+redAut)*100)/100;
    return steps;
  };

  const r=calculPP(brutM);
  const fmt=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v);
  const pct=v=>(v*100).toFixed(2)+'%';
  const inputS={padding:'8px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',width:'100%'};
  const labelS={fontSize:10,color:'#888',marginBottom:3,display:'block'};
  const checkS={display:'flex',alignItems:'center',gap:6,padding:'4px 0',fontSize:11,color:'#ccc',cursor:'pointer'};
  const trancheColors=['#22c55e','#eab308','#f97316','#ef4444'];
  const smallInput={padding:'4px 6px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:4,color:'#e5e5e5',fontSize:10,fontFamily:'inherit',textAlign:'right',width:80};

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:16}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>{'📋'} Baremes Precompte Professionnel {activeYear}</h2>
        <p style={{fontSize:11,color:'#888',margin:0}}>Formule-cle SPF Finances — Auto-update quotidien — Version {PP.version||activeYear+'.1.0'}</p>
      </div>
      <div style={{display:'flex',alignItems:'center',gap:8}}>
        <div style={{width:8,height:8,borderRadius:'50%',background:updateStatus.checking?'#eab308':updateStatus.lastResult==='CHANGES_DETECTED'?'#ef4444':'#22c55e',animation:updateStatus.checking?'pulse 1s infinite':'none'}}/>
        <span style={{fontSize:9,color:'#888'}}>{updateStatus.checking?'Verification...':updateStatus.lastCheck?'Verifie '+new Date(updateStatus.lastCheck).toLocaleDateString('fr-BE')+' '+new Date(updateStatus.lastCheck).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'}):'Jamais verifie'}</span>
        {PP._source==='custom'&&<span style={{fontSize:8,padding:'2px 6px',borderRadius:4,background:'rgba(168,85,247,.12)',color:'#a855f7'}}>Custom</span>}
      </div>
    </div>

    <div style={{display:'flex',gap:4,marginBottom:16,flexWrap:'wrap'}}>
      {[{id:'calc',l:'📊 Simulateur'},{id:'detail',l:'🔍 Detail'},{id:'tranches',l:'📑 Baremes'},{id:'reductions',l:'✂\uFE0F Reductions'},{id:'equipe',l:'👥 Equipe'},{id:'autoupdate',l:'🔄 Auto-Update'},{id:'admin',l:'⚙\uFE0F Admin'}].map(v=>
        <button key={v.id} onClick={()=>setTab(v.id)} style={{padding:'8px 12px',borderRadius:8,border:'none',background:tab===v.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:tab===v.id?'#c6a34e':'#888',fontSize:10,cursor:'pointer',fontWeight:tab===v.id?600:400}}>{v.l}</button>)}
    </div>

    {/* === YEAR SELECTOR === */}
    <div style={{display:'flex',gap:6,marginBottom:14,alignItems:'center'}}>
      <span style={{fontSize:10,color:'#888'}}>Annee fiscale:</span>
      {Object.keys(BAREMES_DB).map(y=><button key={y} onClick={()=>setActiveYear(+y)} style={{padding:'4px 12px',borderRadius:6,border:activeYear===+y?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.05)',background:activeYear===+y?'rgba(198,163,78,.1)':'transparent',color:activeYear===+y?'#c6a34e':'#888',fontSize:11,cursor:'pointer',fontWeight:activeYear===+y?700:400}}>{y}</button>)}
      {customBaremes[currentYear+1]&&<button onClick={()=>setActiveYear(currentYear+1)} style={{padding:'4px 12px',borderRadius:6,border:'1px solid rgba(168,85,247,.2)',background:'rgba(168,85,247,.06)',color:'#a855f7',fontSize:11,cursor:'pointer'}}>{currentYear+1} (custom)</button>}
    </div>

    {/* === SIMULATEUR === */}
    {(tab==='calc'||tab==='detail')&&<div style={{display:'grid',gridTemplateColumns:'280px 1fr',gap:16}}>
      <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Paramètres</div>
        <label style={labelS}>Salaire brut mensuel</label>
        <input type="range" min={1800} max={12000} step={50} value={brutM} onChange={e=>setBrutM(+e.target.value)} style={{width:'100%',accentColor:'#c6a34e'}}/>
        <div style={{textAlign:'center',fontSize:16,fontWeight:700,color:'#c6a34e',margin:'4px 0 10px'}}>{fmt(brutM)} EUR</div>
        <label style={labelS}>Statut</label>
        <select value={statut} onChange={e=>setStatut(e.target.value)} style={{...inputS,marginBottom:8}}><option value="salarie">Salarié</option><option value="dirigeant">Dirigeant entreprise</option></select>
        <label style={labelS}>Bareme</label>
        <select value={bareme} onChange={e=>setBareme(e.target.value)} style={{...inputS,marginBottom:8}}><option value="1">Bareme 1 - Isole / 2 revenus</option><option value="2">Bareme 2 - Marie revenu unique</option></select>
        <label style={labelS}>Enfants a charge</label>
        <input type="number" min={0} max={12} value={enfants} onChange={e=>setEnfants(+e.target.value)} style={{...inputS,marginBottom:4}}/>
        <label style={labelS}>dont enfants handicapes</label>
        <input type="number" min={0} max={enfants} value={enfantsH} onChange={e=>setEnfantsH(Math.min(+e.target.value,enfants))} style={{...inputS,marginBottom:8}}/>
        <div style={{borderTop:'1px solid rgba(255,255,255,.05)',paddingTop:8,marginTop:4}}>
          <div style={{fontSize:10,color:'#888',marginBottom:6}}>Situations particulieres</div>
          <label style={checkS}><input type="checkbox" checked={isole} onChange={e=>setIsole(e.target.checked)}/> Parent isole avec enfant(s)</label>
          <label style={checkS}><input type="checkbox" checked={handicap} onChange={e=>setHandicap(e.target.checked)}/> Beneficiaire handicape</label>
          {bareme==='2'&&<label style={checkS}><input type="checkbox" checked={conjHandicap} onChange={e=>setConjHandicap(e.target.checked)}/> Conjoint handicape</label>}
          <label style={checkS}><input type="checkbox" checked={conjRevLimite} onChange={e=>setConjRevLimite(e.target.checked)}/> Conjoint revenu limite</label>
          <label style={checkS}><input type="checkbox" checked={conjPensionLim} onChange={e=>setConjPensionLim(e.target.checked)}/> Conjoint pension limitee</label>
        </div>
        <div style={{borderTop:'1px solid rgba(255,255,255,.05)',paddingTop:8,marginTop:8}}>
          <label style={labelS}>Personnes 65+ dependantes</label>
          <input type="number" min={0} max={5} value={dep65} onChange={e=>setDep65(+e.target.value)} style={{...inputS,marginBottom:4}}/>
          <label style={labelS}>Autres personnes a charge</label>
          <input type="number" min={0} max={5} value={depAutres} onChange={e=>setDepAutres(+e.target.value)} style={{...inputS,marginBottom:4}}/>
          <label style={labelS}>Taxe communale (%)</label>
          <input type="number" min={0} max={12} step={0.5} value={txComm} onChange={e=>setTxComm(+e.target.value)} style={inputS}/>
        </div>
      </div>
      <div>
        {tab==='calc'&&<>
          <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:14}}>
            {[{l:'Brut',v:fmt(r.brutMensuel),c:'#c6a34e'},{l:'ONSS "+((LOIS_BELGES.onss.travailleur*100).toFixed(2))+"%',v:'-'+fmt(r.onss),c:'#f87171'},{l:'PP mensuel',v:'-'+fmt(r.ppMensuel),c:'#a855f7'},{l:'NET',v:fmt(r.net),c:'#22c55e'}].map((k,i)=>
              <div key={i} style={{padding:'14px 12px',background:'linear-gradient(135deg,#0d1117,#131820)',border:'2px solid '+(k.c+'30'),borderRadius:12}}>
                <div style={{fontSize:9,color:'#888',textTransform:'uppercase',letterSpacing:.5}}>{k.l}</div>
                <div style={{fontSize:18,fontWeight:800,color:k.c,marginTop:4}}>{k.v}</div>
              </div>)}
          </div>
          <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14,marginBottom:14}}>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Decomposition mensuelle</div>
            {[{l:'Salaire brut',v:r.brutMensuel,c:'#c6a34e',pct:100},{l:'ONSS travailleur ("+((LOIS_BELGES.onss.travailleur*100).toFixed(2))+"%)',v:-r.onss,c:'#f87171',pct:r.onss/r.brutMensuel*100},{l:'Imposable',v:r.imposable,c:'#e5e5e5',pct:r.imposable/r.brutMensuel*100},{l:'Précompte professionnel',v:-r.ppMensuel,c:'#a855f7',pct:r.ppMensuel/r.brutMensuel*100},{l:'NET',v:r.net,c:'#22c55e',pct:r.net/r.brutMensuel*100}].map((row,i)=>
              <div key={i} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'5px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
                <span style={{fontSize:11,color:'#999',flex:1}}>{row.l}</span>
                <div style={{width:120,height:6,background:'rgba(255,255,255,.05)',borderRadius:3,marginRight:10,overflow:'hidden'}}><div style={{height:'100%',width:Math.abs(row.pct)+'%',background:row.c,borderRadius:3}}/></div>
                <span style={{fontSize:12,fontWeight:600,color:row.c,width:90,textAlign:'right'}}>{row.v>=0?fmt(row.v):'-'+fmt(Math.abs(row.v))}</span>
              </div>)}
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
            <div style={{padding:14,background:'rgba(168,85,247,.04)',border:'1px solid rgba(168,85,247,.1)',borderRadius:12}}>
              <div style={{fontSize:10,color:'#a855f7',marginBottom:6}}>Reductions appliquees (annuel)</div>
              {[{l:'Quotite exemptee',v:r.redQuotiteExemptee},r.redEnfants>0&&{l:'Enfants ('+r.totalEnfEquiv+' eq.)',v:r.redEnfants},r.redIsole>0&&{l:'Isole + enfants',v:r.redIsole},r.redHandicap>0&&{l:'Handicap',v:r.redHandicap},r.redConjHandicap>0&&{l:'Conjoint handicape',v:r.redConjHandicap},r.redConjRevLimite>0&&{l:'Conjoint rev. limite',v:r.redConjRevLimite},r.redConjPensionLim>0&&{l:'Conjoint pension lim.',v:r.redConjPensionLim},r.redDep65>0&&{l:'Pers. 65+ dep.',v:r.redDep65},r.redDepAutres>0&&{l:'Autres a charge',v:r.redDepAutres}].filter(Boolean).map((red,i)=>
                <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'3px 0',fontSize:10}}>
                  <span style={{color:'#999'}}>{red.l}</span>
                  <span style={{color:'#22c55e',fontWeight:600}}>-{fmt(red.v)}</span>
                </div>)}
              <div style={{borderTop:'1px solid rgba(168,85,247,.15)',marginTop:6,paddingTop:6,display:'flex',justifyContent:'space-between',fontSize:11}}>
                <span style={{color:'#a855f7',fontWeight:600}}>Total</span>
                <span style={{color:'#22c55e',fontWeight:700}}>-{fmt(r.totalReductions)}/an</span>
              </div>
            </div>
            <div style={{padding:14,background:'rgba(34,197,94,.04)',border:'1px solid rgba(34,197,94,.1)',borderRadius:12}}>
              <div style={{fontSize:10,color:'#22c55e',marginBottom:6}}>Synthese annuelle</div>
              {[{l:'Brut annuel',v:fmt(r.brutMensuel*12)},{l:'ONSS annuel',v:'-'+fmt(r.onss*12)},{l:'PP annuel',v:'-'+fmt(r.ppMensuel*12)},{l:'Net annuel',v:fmt(r.net*12)},{l:'Taux PP effectif',v:((r.ppMensuel/r.brutMensuel)*100).toFixed(1)+'%'},{l:'Pression fiscale totale',v:(((r.onss+r.ppMensuel)/r.brutMensuel)*100).toFixed(1)+'%'}].map((row,i)=>
                <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'3px 0',fontSize:10}}>
                  <span style={{color:'#999'}}>{row.l}</span><span style={{color:'#22c55e',fontWeight:600}}>{row.v}</span>
                </div>)}
            </div>
          </div>
        </>}
        {tab==='detail'&&<div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Detail pas-a-pas — Formule-cle SPF {activeYear}</div>
          {[{step:1,title:'Cotisation ONSS',calc:fmt(r.brutMensuel)+' x "+((LOIS_BELGES.onss.travailleur*100).toFixed(2))+"% = '+fmt(r.onss),result:'Imposable = '+fmt(r.imposable)},{step:2,title:'Annualisation',calc:fmt(r.imposable)+' x 12 = '+fmt(r.brutAnnuel),result:'Brut annuel = '+fmt(r.brutAnnuel)},{step:3,title:'Frais professionnels ('+statut+')',calc:(statut==='salarie'?'30%':'3%')+' de '+fmt(r.brutAnnuel)+' = '+fmt(statut==='salarie'?r.brutAnnuel*0.30:r.brutAnnuel*0.03),result:'Frais = '+fmt(r.fraisPro)+(r.fraisPro>=PP.fraisPro.salarie.max||r.fraisPro>=PP.fraisPro.dirigeant.max?' (plafond)':'')},{step:4,title:'Revenu net imposable',calc:fmt(r.brutAnnuel)+' - '+fmt(r.fraisPro),result:'= '+fmt(r.revNetImpo)},bareme==='2'?{step:5,title:'Quotient conjugal',calc:'30% de '+fmt(r.revNetImpo)+' (max 12.520)',result:'QC = '+fmt(r.quotientConjugal)+' | Part trav. = '+fmt(r.partTravailleur)}:null,{step:bareme==='2'?6:5,title:'Impot brut (tranches)',calc:'Application bareme progressif '+activeYear,result:'Impot brut = '+fmt(r.impotBrut)},{step:bareme==='2'?7:6,title:'Quotite exemptee',calc:'Bareme '+(bareme==='2'?'2: '+fmt(PP.quotiteExemptee.bareme2):'1: '+fmt(PP.quotiteExemptee.bareme1)),result:'Apres QE = '+fmt(Math.max(0,r.impotBrut-r.redQuotiteExemptee))},r.redEnfants>0?{step:'E',title:'Red. enfants ('+r.totalEnfEquiv+')',calc:'-'+fmt(r.redEnfants),result:'Apres = '+fmt(Math.max(0,r.impotBrut-r.redQuotiteExemptee-r.redEnfants))}:null,{step:'T',title:'Taxe communale '+txComm+'%',calc:fmt(r.impotApresReductions)+' x '+txComm+'%',result:'Total annuel = '+fmt(r.impotTotal)},{step:'R',title:'PP mensuel',calc:fmt(r.impotTotal)+' / 12',result:'PP = '+fmt(r.ppMensuel)+' EUR/mois'}].filter(Boolean).map((s2,i)=>
            <div key={i} style={{padding:'8px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:3}}>
                <span style={{width:22,height:22,borderRadius:'50%',background:'rgba(198,163,78,.12)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,fontWeight:700,color:'#c6a34e',flexShrink:0}}>{s2.step}</span>
                <span style={{fontSize:11,fontWeight:600,color:'#e5e5e5'}}>{s2.title}</span>
              </div>
              <div style={{marginLeft:30,fontSize:10,color:'#888'}}>{s2.calc}</div>
              <div style={{marginLeft:30,fontSize:10,color:'#c6a34e',fontWeight:600,marginTop:2}}>{s2.result}</div>
            </div>)}
        </div>}
      </div>
    </div>}

    {/* === BAREMES OFFICIELS === */}
    {tab==='tranches'&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14}}>
      <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:4}}>Tranches imposition {activeYear}</div>
        <div style={{fontSize:9,color:'#666',marginBottom:10}}>Source: {PP.source||'Annexe III AR SPF Finances'}</div>
        {PP.tranches.map((tr,i)=><div key={i} style={{padding:'8px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
            <span style={{fontSize:11,color:'#e5e5e5'}}>{tr.max===Infinity?'Au-dela de '+fmt(tr.min):fmt(tr.min)+' - '+fmt(tr.max)+' EUR'}</span>
            <span style={{fontSize:13,fontWeight:800,color:trancheColors[i]}}>{pct(tr.taux)}</span>
          </div>
          <div style={{height:8,background:'rgba(255,255,255,.05)',borderRadius:4,overflow:'hidden'}}><div style={{height:'100%',width:(tr.taux/0.535*100)+'%',background:trancheColors[i],borderRadius:4}}/></div>
          {i>0&&<div style={{fontSize:9,color:'#666',marginTop:2}}>Cumule: {fmt(tr.base)} EUR</div>}
        </div>)}
      </div>
      <div>
        <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14,marginBottom:12}}>
          <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Frais professionnels</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
            <div style={{padding:10,background:'rgba(34,197,94,.04)',borderRadius:8}}><div style={{fontSize:9,color:'#22c55e'}}>SALARIES</div><div style={{fontSize:14,fontWeight:700,color:'#22c55e'}}>{pct(PP.fraisPro.salarie.pct)}</div><div style={{fontSize:9,color:'#888'}}>Max {fmt(PP.fraisPro.salarie.max)} EUR/an</div></div>
            <div style={{padding:10,background:'rgba(96,165,250,.04)',borderRadius:8}}><div style={{fontSize:9,color:'#60a5fa'}}>DIRIGEANTS</div><div style={{fontSize:14,fontWeight:700,color:'#60a5fa'}}>{pct(PP.fraisPro.dirigeant.pct)}</div><div style={{fontSize:9,color:'#888'}}>Max {fmt(PP.fraisPro.dirigeant.max)} EUR/an</div></div>
          </div>
        </div>
        <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Quotite exemptee</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
            <div style={{padding:10,background:'rgba(198,163,78,.04)',borderRadius:8}}><div style={{fontSize:9,color:'#c6a34e'}}>BAREME 1</div><div style={{fontSize:14,fontWeight:700,color:'#c6a34e'}}>{fmt(PP.quotiteExemptee.bareme1)}/an</div><div style={{fontSize:9,color:'#888'}}>{fmt(PP.quotiteExemptee.bareme1/12)}/mois</div></div>
            <div style={{padding:10,background:'rgba(96,165,250,.04)',borderRadius:8}}><div style={{fontSize:9,color:'#60a5fa'}}>BAREME 2</div><div style={{fontSize:14,fontWeight:700,color:'#60a5fa'}}>{fmt(PP.quotiteExemptee.bareme2)}/an</div><div style={{fontSize:9,color:'#888'}}>{fmt(PP.quotiteExemptee.bareme2/12)}/mois</div></div>
          </div>
        </div>
      </div>
    </div>}

    {/* === REDUCTIONS === */}
    {tab==='reductions'&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14}}>
      <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Enfants a charge</div>
        {PP.redEnfants.slice(1).map((v,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'5px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <span style={{fontSize:11,color:'#e5e5e5'}}>{i+1} enfant{i>0?'s':''}</span>
          <span style={{fontSize:11,fontWeight:700,color:'#22c55e'}}>{fmt(v)}/an ({fmt(v/12)}/mois)</span>
        </div>)}
        <div style={{fontSize:9,color:'#888',marginTop:4}}>9+: +{fmt(PP.redEnfantSupp)}/enfant supp.</div>
      </div>
      <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Autres reductions</div>
        {[{l:'Parent isole + enfant(s)',v:PP.redIsoleEnfants},{l:'Handicap beneficiaire',v:PP.redHandicap},{l:'Conjoint handicape',v:PP.redConjHandicap},{l:'Conjoint revenu limite',v:PP.redConjRevLimite},{l:'Conjoint pension limitee',v:PP.redConjPensionLim},{l:'Personne 65+ dep.',v:PP.redDep65},{l:'Autre personne a charge',v:PP.redDepAutre}].map((red,i)=>
          <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'5px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
            <span style={{fontSize:11,color:'#ccc'}}>{red.l}</span>
            <span style={{fontSize:11,fontWeight:600,color:'#22c55e'}}>{fmt(red.v)}/an</span>
          </div>)}
      </div>
    </div>}

    {/* === EQUIPE === */}
    {tab==='equipe'&&<div>
      {ae.length===0?<div style={{padding:40,textAlign:'center',color:'#555'}}>Aucun employé encode</div>:
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'auto'}}>
        <div style={{display:'grid',gridTemplateColumns:'180px repeat(6,80px)',padding:'8px 12px',background:'rgba(198,163,78,.06)',fontSize:9,fontWeight:600,color:'#c6a34e',minWidth:660}}><div>Nom</div><div style={{textAlign:'right'}}>Brut</div><div style={{textAlign:'right'}}>ONSS</div><div style={{textAlign:'right'}}>Imposable</div><div style={{textAlign:'right'}}>PP</div><div style={{textAlign:'right'}}>Net</div><div style={{textAlign:'right'}}>Taux</div></div>
        {ae.map((emp,i)=>{const c=calculPP(+emp.gross||0,{enfants:0,enfantsH:0,isole:false,handicap:false,conjHandicap:false,conjRevLimite:false,conjPensionLim:false,dep65:0,depAutres:0,txComm:7});return <div key={i} style={{display:'grid',gridTemplateColumns:'180px repeat(6,80px)',padding:'6px 12px',borderBottom:'1px solid rgba(255,255,255,.02)',fontSize:11,minWidth:660}}><div style={{color:'#e5e5e5'}}>{(emp.fn||'')+' '+(emp.ln||'')}</div><div style={{textAlign:'right',color:'#c6a34e'}}>{fmt(+emp.gross||0)}</div><div style={{textAlign:'right',color:'#f87171'}}>{fmt(c.onss)}</div><div style={{textAlign:'right',color:'#e5e5e5'}}>{fmt(c.imposable)}</div><div style={{textAlign:'right',color:'#a855f7',fontWeight:600}}>{fmt(c.ppMensuel)}</div><div style={{textAlign:'right',color:'#22c55e',fontWeight:600}}>{fmt(c.net)}</div><div style={{textAlign:'right',color:'#888'}}>{((c.ppMensuel/(+emp.gross||1))*100).toFixed(1)}%</div></div>;})}
      </div>}
    </div>}

    {/* === AUTO-UPDATE === */}
    {tab==='autoupdate'&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14}}>
      <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Systeme Auto-Update Quotidien</div>
        <div style={{padding:12,background:'rgba(34,197,94,.04)',borderRadius:8,marginBottom:12,border:'1px solid rgba(34,197,94,.1)'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <span style={{fontSize:11,color:'#22c55e',fontWeight:600}}>Auto-update actif</span>
            <label style={{display:'flex',alignItems:'center',gap:6,cursor:'pointer'}}>
              <input type="checkbox" checked={autoUpdateEnabled} onChange={e=>{setAutoUpdateEnabled(e.target.checked);try{safeLS.set('aureus_autoupdate',e.target.checked.toString());}catch(ex){}}}/>
              <span style={{fontSize:10,color:'#888'}}>{autoUpdateEnabled?'Active':'Desactive'}</span>
            </label>
          </div>
          <div style={{fontSize:9,color:'#888',marginTop:4}}>Verifie automatiquement les sources SPF toutes les 24h au chargement de l app</div>
        </div>

        <div style={{marginBottom:12}}>
          <div style={{fontSize:11,fontWeight:600,color:'#e5e5e5',marginBottom:8}}>Fonctionnement</div>
          {[
            {icon:'⏰',t:'Verification quotidienne',d:'A chaque ouverture de l app, si 24h+ depuis dernier check, verification automatique'},
            {icon:'🌐',t:'Sources surveillees',d:SPF_SOURCES.length+' sources: SPF Finances, Refli.be, CGSLB, calculateur-de-salaire.be'},
            {icon:'🔔',t:'Detection changements',d:'Si nouvelle annee sans bareme, ou si decembre (watch mode pour nouvel AR)'},
            {icon:'💾',t:'Stockage local',d:'Historique des checks + baremes custom en localStorage'},
            {icon:'☁\uFE0F',t:'Supabase (production)',d:'En prod: stockage et sync des baremes via Supabase pour tous les clients'},
          ].map((r2,i)=><div key={i} style={{padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)',display:'flex',gap:8}}>
            <span style={{fontSize:14}}>{r2.icon}</span>
            <div><div style={{fontSize:11,color:'#e5e5e5',fontWeight:500}}>{r2.t}</div><div style={{fontSize:9,color:'#888'}}>{r2.d}</div></div>
          </div>)}
        </div>

        <button onClick={runAutoCheck} disabled={updateStatus.checking} style={{width:'100%',padding:'10px',borderRadius:8,border:'none',background:updateStatus.checking?'rgba(234,179,8,.12)':'linear-gradient(135deg,#c6a34e,#a07d3e)',color:updateStatus.checking?'#eab308':'#060810',fontWeight:700,fontSize:12,cursor:updateStatus.checking?'wait':'pointer'}}>
          {updateStatus.checking?'⏳ Verification en cours...':'🔄 Verifier maintenant'}
        </button>

        <div style={{marginTop:12}}>
          <div style={{fontSize:11,fontWeight:600,color:'#e5e5e5',marginBottom:6}}>Sources surveillees</div>
          {SPF_SOURCES.map((src,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'5px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
            <div><div style={{fontSize:10,color:'#e5e5e5'}}>{src.name}</div><div style={{fontSize:8,color:'#555',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{src.url}</div></div>
            <span style={{fontSize:8,padding:'2px 6px',borderRadius:4,background:src.type==='official'?'rgba(34,197,94,.1)':src.type==='reference'?'rgba(96,165,250,.1)':'rgba(255,255,255,.05)',color:src.type==='official'?'#22c55e':src.type==='reference'?'#60a5fa':'#888'}}>{src.type}</span>
          </div>)}
        </div>
      </div>

      <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Historique des verifications</div>
        {(updateStatus.history||[]).length===0?<div style={{padding:20,textAlign:'center',color:'#555',fontSize:11}}>Aucune verification effectuee</div>:
        <div style={{maxHeight:400,overflow:'auto'}}>
          {(updateStatus.history||[]).map((entry,i)=><div key={i} style={{padding:'8px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <span style={{fontSize:10,color:'#e5e5e5'}}>{new Date(entry.date).toLocaleDateString('fr-BE')+' '+new Date(entry.date).toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit'})}</span>
              <span style={{fontSize:8,padding:'2px 6px',borderRadius:4,background:entry.detectedChanges?'rgba(239,68,68,.1)':'rgba(34,197,94,.1)',color:entry.detectedChanges?'#ef4444':'#22c55e'}}>{entry.detectedChanges?'CHANGEMENTS':'OK'}</span>
            </div>
            <div style={{marginTop:4}}>
              {entry.results.map((res,j)=><div key={j} style={{fontSize:9,color:res.status==='reachable'?'#888':res.status==='error'?'#ef4444':'#eab308',paddingLeft:8}}>
                {res.source}: {res.status}{res.message?' - '+res.message:''}
              </div>)}
            </div>
          </div>)}
        </div>}
      </div>
    </div>}

    {/* === ADMIN PANEL === */}
    {tab==='admin'&&<div>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
        <div><div style={{fontSize:13,fontWeight:600,color:'#c6a34e'}}>Administration Baremes {activeYear}</div><div style={{fontSize:9,color:'#888'}}>Modifier manuellement les constantes quand un nouvel AR est publie</div></div>
        <div style={{display:'flex',gap:6}}>
          {!editMode&&<button onClick={startEdit} style={{padding:'8px 14px',borderRadius:8,border:'none',background:'rgba(198,163,78,.12)',color:'#c6a34e',fontSize:11,cursor:'pointer',fontWeight:600}}>{'\u270F\uFE0F'} Modifier</button>}
          {editMode&&<><button onClick={saveEdit} style={{padding:'8px 14px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#22c55e,#16a34a)',color:'#fff',fontSize:11,cursor:'pointer',fontWeight:600}}>{'\u2705'} Sauvegarder</button><button onClick={()=>{setEditMode(false);setEditData(null);}} style={{padding:'8px 14px',borderRadius:8,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'#888',fontSize:11,cursor:'pointer'}}>Annuler</button></>}
          {PP._source==='custom'&&!editMode&&<button onClick={resetToDefault} style={{padding:'8px 14px',borderRadius:8,border:'1px solid rgba(239,68,68,.2)',background:'rgba(239,68,68,.06)',color:'#ef4444',fontSize:11,cursor:'pointer'}}>{'\u21A9\uFE0F'} Reset defaut</button>}
        </div>
      </div>

      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14}}>
        <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Tranches d imposition</div>
          <div style={{display:'grid',gridTemplateColumns:'60px 80px 70px 80px',gap:4,marginBottom:4,fontSize:8,color:'#888',fontWeight:600}}><div>Min</div><div>Max</div><div>Taux</div><div>Base cumul</div></div>
          {(editMode?editData.tranches:PP.tranches).map((tr,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'60px 80px 70px 80px',gap:4,marginBottom:4}}>
            {editMode?<>
              <input type="number" value={tr.min} onChange={e=>updateEditTranche(i,'min',e.target.value)} style={smallInput}/>
              <input type="number" value={tr.max>=999999?'999999':tr.max} onChange={e=>updateEditTranche(i,'max',e.target.value)} style={smallInput}/>
              <input type="number" step={0.0001} value={tr.taux} onChange={e=>updateEditTranche(i,'taux',e.target.value)} style={smallInput}/>
              <input type="number" value={tr.base} onChange={e=>updateEditTranche(i,'base',e.target.value)} style={smallInput}/>
            </>:<>
              <span style={{fontSize:10,color:'#e5e5e5'}}>{fmt(tr.min)}</span>
              <span style={{fontSize:10,color:'#e5e5e5'}}>{tr.max===Infinity?'\u221E':fmt(tr.max)}</span>
              <span style={{fontSize:10,color:trancheColors[i],fontWeight:700}}>{pct(tr.taux)}</span>
              <span style={{fontSize:10,color:'#888'}}>{fmt(tr.base)}</span>
            </>}
          </div>)}

          <div style={{borderTop:'1px solid rgba(255,255,255,.05)',marginTop:10,paddingTop:10}}>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Frais professionnels</div>
            {['salarie','dirigeant'].map(st=><div key={st} style={{display:'flex',gap:8,marginBottom:6,alignItems:'center'}}>
              <span style={{fontSize:10,color:'#888',width:70,textTransform:'capitalize'}}>{st}</span>
              {editMode?<>
                <input type="number" step={0.01} value={editData.fraisPro[st].pct} onChange={e=>updateEditField('fraisPro.'+st+'.pct',e.target.value)} style={{...smallInput,width:60}}/>
                <input type="number" value={editData.fraisPro[st].max} onChange={e=>updateEditField('fraisPro.'+st+'.max',e.target.value)} style={{...smallInput,width:70}}/>
              </>:<>
                <span style={{fontSize:10,color:'#22c55e'}}>{pct(PP.fraisPro[st].pct)}</span>
                <span style={{fontSize:10,color:'#888'}}>max {fmt(PP.fraisPro[st].max)}</span>
              </>}
            </div>)}
          </div>

          <div style={{borderTop:'1px solid rgba(255,255,255,.05)',marginTop:10,paddingTop:10}}>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Quotite exemptee & QC</div>
            {[{l:'Bareme 1',k:'quotiteExemptee.bareme1',v:PP.quotiteExemptee.bareme1},{l:'Bareme 2',k:'quotiteExemptee.bareme2',v:PP.quotiteExemptee.bareme2},{l:'QC % max',k:'quotientConjugal.pct',v:PP.quotientConjugal.pct},{l:'QC plafond',k:'quotientConjugal.max',v:PP.quotientConjugal.max}].map((f,i)=>
              <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'3px 0'}}>
                <span style={{fontSize:10,color:'#888'}}>{f.l}</span>
                {editMode?<input type="number" step={0.01} value={f.k.split('.').reduce((o,p)=>o[p],editData)} onChange={e=>updateEditField(f.k,e.target.value)} style={smallInput}/>
                :<span style={{fontSize:10,color:'#e5e5e5',fontWeight:600}}>{typeof f.v==='number'&&f.v<1?pct(f.v):fmt(f.v)}</span>}
              </div>)}
          </div>
        </div>

        <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Reductions annuelles</div>
          <div style={{fontSize:10,color:'#888',marginBottom:6}}>Enfants a charge</div>
          {(editMode?editData:PP).redEnfants.slice(1).map((v,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'2px 0'}}>
            <span style={{fontSize:10,color:'#ccc'}}>{i+1} enfant{i>0?'s':''}</span>
            {editMode?<input type="number" value={editData.redEnfants[i+1]} onChange={e=>{const arr=[...editData.redEnfants];arr[i+1]=parseFloat(e.target.value)||0;setEditData(p=>({...p,redEnfants:arr}));}} style={smallInput}/>
            :<span style={{fontSize:10,color:'#22c55e'}}>{fmt(v)}</span>}
          </div>)}

          <div style={{borderTop:'1px solid rgba(255,255,255,.05)',marginTop:10,paddingTop:10}}>
            <div style={{fontSize:10,color:'#888',marginBottom:6}}>Autres reductions</div>
            {[{l:'Enfant supp. (9+)',k:'redEnfantSupp'},{l:'Isole + enfants',k:'redIsoleEnfants'},{l:'Handicap benef.',k:'redHandicap'},{l:'Conjoint handicap.',k:'redConjHandicap'},{l:'Conj. rev. limite',k:'redConjRevLimite'},{l:'Conj. pension lim.',k:'redConjPensionLim'},{l:'Pers. 65+ dep.',k:'redDep65'},{l:'Autre a charge',k:'redDepAutre'},{l:'Bonus emploi %',k:'bonusEmploiPct'},{l:'ONSS travailleur',k:'onssW'}].map((f,i)=>
              <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'3px 0'}}>
                <span style={{fontSize:10,color:'#ccc'}}>{f.l}</span>
                {editMode?<input type="number" step={f.k.includes('Pct')||f.k==='onssW'?0.0001:1} value={editData[f.k]} onChange={e=>setEditData(p=>({...p,[f.k]:parseFloat(e.target.value)||0}))} style={smallInput}/>
                :<span style={{fontSize:10,color:'#e5e5e5',fontWeight:600}}>{PP[f.k]<1?pct(PP[f.k]):fmt(PP[f.k])}</span>}
              </div>)}
          </div>

          <div style={{borderTop:'1px solid rgba(255,255,255,.05)',marginTop:10,paddingTop:10}}>
            <div style={{fontSize:10,color:'#888',marginBottom:6}}>Metadonnees</div>
            {[{l:'Version',v:PP.version||'—'},{l:'Source',v:PP.source||'—'},{l:'Publication',v:PP.datePublication||'—'},{l:'Origine',v:PP._source==='custom'?'Modifie le '+new Date(PP._customDate).toLocaleDateString('fr-BE'):'Integre (defaut)'}].map((m,i)=>
              <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'2px 0'}}>
                <span style={{fontSize:9,color:'#888'}}>{m.l}</span>
                <span style={{fontSize:9,color:m.v.includes('Modifie')?'#a855f7':'#e5e5e5'}}>{m.v}</span>
              </div>)}
          </div>
        </div>
      </div>
    </div>}

    <div style={{marginTop:14,padding:10,background:'rgba(198,163,78,.03)',border:'1px solid rgba(198,163,78,.08)',borderRadius:8,fontSize:9,color:'#666'}}>
      Sources: Formule-cle SPF Finances Annexe III {activeYear} | calculateur-de-salaire.be | refli.be | CGSLB.
      Auto-update quotidien actif. Admin panel pour mise à jour manuelle lors publication nouvel AR.
      {PP._source==='custom'&&' \u26A0\uFE0F Baremes modifies manuellement le '+new Date(PP._customDate).toLocaleDateString('fr-BE')+'.'}
    </div>
  </div>;
};

const SecuriteData=({s})=>{
  const clients=s.clients||[];
  const [scanDone,setScanDone]=useState(false);
  const [showMasked,setShowMasked]=useState(true);
  const [ipTab,setIpTab]=useState('list');
  const [ipList,setIpList]=useState([]);
  const [newIp,setNewIp]=useState('');
  const [newIpLabel,setNewIpLabel]=useState('');
  const [ipLoading,setIpLoading]=useState(false);
  const [ipMsg,setIpMsg]=useState('');

  const allEmps=[];
  clients.forEach(cl=>{(cl.emps||[]).forEach(e=>allEmps.push({...e,_client:cl.company?.name||''}));});

  const maskNISS=(v)=>v?v.substring(0,2)+'.***.***-'+v.substring(v.length-2):'N/A';
  const maskIBAN=(v)=>v?v.substring(0,4)+' **** **** '+v.substring(v.length-4):'N/A';
  const maskEmail=(v)=>v?v.substring(0,2)+'***@'+v.split('@')[1]:'N/A';

  // Security audit
  const audit={
    totalEmps:allEmps.length,
    withNISS:allEmps.filter(e=>e.niss||e.NISS).length,
    withIBAN:allEmps.filter(e=>e.iban||e.IBAN).length,
    withEmail:allEmps.filter(e=>e.email).length,
    missingNISS:allEmps.filter(e=>!(e.niss||e.NISS)).length,
    missingIBAN:allEmps.filter(e=>!(e.iban||e.IBAN)).length,
  };

  // IP Whitelist management
  const loadIpList=async()=>{
    setIpLoading(true);
    try{
      const sb=(await import('./lib/supabase')).supabase;
      if(sb){const{data}=await sb.from('ip_whitelist').select('*').order('created_at',{ascending:false});setIpList(data||[]);}
    }catch(e){console.error(e);}
    setIpLoading(false);
  };
  const addIp=async()=>{
    if(!newIp.trim())return;
    const cidrRegex=/^(\d{1,3}\.){3}\d{1,3}(\/\d{1,2})?$/;
    if(!cidrRegex.test(newIp.trim())){setIpMsg('Format invalide. Ex: 192.168.1.0/24 ou 85.14.233.12');return;}
    setIpLoading(true);
    try{
      const sb=(await import('./lib/supabase')).supabase;
      if(sb){
        await sb.from('ip_whitelist').insert({cidr:newIp.trim(),label:newIpLabel.trim()||'Sans label',active:true,created_at:new Date().toISOString()});
        setNewIp('');setNewIpLabel('');setIpMsg('IP ajoutee');await loadIpList();
      }
    }catch(e){setIpMsg('Erreur: '+e.message);}
    setIpLoading(false);
  };
  const toggleIp=async(id,active)=>{
    try{const sb=(await import('./lib/supabase')).supabase;if(sb){await sb.from('ip_whitelist').update({active:!active}).eq('id',id);await loadIpList();}}catch(e){}
  };
  const deleteIp=async(id)=>{
    try{const sb=(await import('./lib/supabase')).supabase;if(sb){await sb.from('ip_whitelist').delete().eq('id',id);await loadIpList();}}catch(e){}
  };
  useEffect(()=>{loadIpList();},[]);

  const securityChecks=[
    {name:'Connexion HTTPS',status:'ok',detail:'Vercel force HTTPS + HSTS preload 2 ans'},
    {name:'Authentification Supabase',status:'ok',detail:'JWT + Row Level Security'},
    {name:'Mots de passe hashes',status:'ok',detail:'bcrypt via Supabase Auth'},
    {name:'Chiffrement NISS/IBAN',status:'ok',detail:'AES-256-GCM + PBKDF2 100K iterations (crypto.js)'},
    {name:'Protection XSS',status:'ok',detail:'escapeHtml() + CSP headers'},
    {name:'RGPD registre traitements',status:'ok',detail:'Module RGPD + DPO Dashboard actifs'},
    {name:'Logs audit',status:'ok',detail:'Journal activite + Audit Trail actifs'},
    {name:'Backup automatique',status:'ok',detail:'backup.js JSON + auto-backup 24h'},
    {name:'Auth API routes',status:'ok',detail:'Bearer token sur push/webhooks/lois-update/facturation'},
    {name:'2FA / MFA',status:'ok',detail:'TOTP actif — LoginPage.js + TwoFactorSetup.js'},
    {name:'IP whitelist',status:'ok',detail:'Middleware CIDR + UI admin ci-dessous'},
    {name:'Protection SSRF',status:'ok',detail:'Blocage IP privees + metadata AWS sur webhooks'},
    {name:'OWASP ZAP CI/CD',status:'ok',detail:'Scan automatique GitHub Actions chaque push'},
    {name:'Rotation cles',status:'ok',detail:'API key-rotation AES-256-GCM'},
    {name:'Alerte intrusion geo',status:'ok',detail:'GeoCheck 8 pays autorises + audit log'},
    {name:'Data isolation multi-tenant',status:'ok',detail:'RLS Supabase + chiffrement par tenant'},
  ];

  const score=Math.round(securityChecks.filter(c=>c.status==='ok').length/securityChecks.length*100);

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🔒 Securite & Protection Donnees</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Audit securite + masquage NISS/IBAN + checklist RGPD</p>

    {/* Score */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:20}}>
      {[{l:'Score securite',v:score+'%',c:score>=80?'#22c55e':score>=60?'#eab308':'#ef4444'},
        {l:'Donnees sensibles',v:audit.withNISS+audit.withIBAN,c:'#a855f7'},
        {l:'Checks OK',v:securityChecks.filter(c=>c.status==='ok').length+'/'+securityChecks.length,c:'#22c55e'},
        {l:'Actions requises',v:securityChecks.filter(c=>c.status!=='ok').length,c:'#ef4444'},
      ].map((k,i)=><div key={i} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
        <div style={{fontSize:22,fontWeight:800,color:k.c}}>{k.v}</div>
      </div>)}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
      {/* Security checks */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Checklist securite ({securityChecks.filter(c=>c.status==='ok').length}/{securityChecks.length})</div>
        {securityChecks.map((c,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <span style={{fontSize:14}}>{c.status==='ok'?'✅':c.status==='warn'?'⚠️':'❌'}</span>
          <div style={{flex:1}}>
            <div style={{fontSize:11,fontWeight:500,color:c.status==='ok'?'#e5e5e5':c.status==='warn'?'#eab308':'#ef4444'}}>{c.name}</div>
            <div style={{fontSize:9,color:'#888'}}>{c.detail}</div>
          </div>
        </div>)}
      </div>

      {/* Data masking preview */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span style={{fontSize:12,fontWeight:600,color:'#c6a34e'}}>Donnees sensibles ({audit.totalEmps} employes)</span>
          <button onClick={()=>setShowMasked(!showMasked)} style={{padding:'3px 10px',borderRadius:5,border:'none',background:'rgba(198,163,78,.1)',color:'#c6a34e',fontSize:10,cursor:'pointer'}}>{showMasked?'🔒 Masque':'👁 Visible'}</button>
        </div>
        <div style={{maxHeight:400,overflowY:'auto'}}>
          {allEmps.slice(0,15).map((e,i)=><div key={i} style={{padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
            <div style={{fontWeight:600,color:'#e5e5e5'}}>{(e.first||e.fn||'')} {(e.last||e.ln||'')} <span style={{fontSize:9,color:'#888'}}>— {e._client}</span></div>
            <div style={{display:'flex',gap:16,marginTop:3}}>
              <span style={{color:'#888'}}>NISS: <span style={{color:'#a855f7',fontFamily:'monospace'}}>{showMasked?maskNISS(e.niss||e.NISS||''):(e.niss||e.NISS||'N/A')}</span></span>
              <span style={{color:'#888'}}>IBAN: <span style={{color:'#3b82f6',fontFamily:'monospace'}}>{showMasked?maskIBAN(e.iban||e.IBAN||''):(e.iban||e.IBAN||'N/A')}</span></span>
            </div>
          </div>)}
        </div>
      </div>
    </div>

    {/* ═══ IP WHITELIST ADMIN ═══ */}
    <div style={{marginTop:20,border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <span style={{fontSize:12,fontWeight:600,color:'#c6a34e'}}>🛡 IP Whitelist — Restriction acces</span>
        <span style={{fontSize:9,color:'#888'}}>{ipList.filter(ip=>ip.active).length} IP actives / {ipList.length} total</span>
      </div>
      <div style={{padding:14}}>
        <p style={{fontSize:10,color:'#888',margin:'0 0 12px'}}>Les IP/CIDR ci-dessous sont autorisees a acceder aux routes API protegees. Variable env IP_WHITELIST synchronisee via Supabase.</p>
        {/* Add form */}
        <div style={{display:'flex',gap:8,marginBottom:12}}>
          <input value={newIp} onChange={e=>setNewIp(e.target.value)} placeholder="IP ou CIDR (ex: 85.14.233.0/24)" style={{flex:1,padding:'8px 12px',borderRadius:8,border:'1px solid rgba(198,163,78,0.2)',background:'rgba(0,0,0,0.3)',color:'#e8e6e0',fontSize:12,fontFamily:'monospace'}}/>
          <input value={newIpLabel} onChange={e=>setNewIpLabel(e.target.value)} placeholder="Label (ex: Bureau Bruxelles)" style={{flex:1,padding:'8px 12px',borderRadius:8,border:'1px solid rgba(198,163,78,0.2)',background:'rgba(0,0,0,0.3)',color:'#e8e6e0',fontSize:12}}/>
          <button onClick={addIp} disabled={ipLoading} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'#c6a34e',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer',whiteSpace:'nowrap'}}>+ Ajouter</button>
        </div>
        {ipMsg&&<div style={{fontSize:10,color:ipMsg.startsWith('Erreur')?'#ef4444':'#22c55e',marginBottom:8}}>{ipMsg}</div>}
        {/* IP list */}
        <div style={{maxHeight:250,overflowY:'auto'}}>
          {ipList.length===0&&<div style={{textAlign:'center',padding:20,color:'#888',fontSize:11}}>Aucune IP configuree — toutes les IP sont autorisees</div>}
          {ipList.map((ip,i)=><div key={ip.id||i} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',opacity:ip.active?1:0.5}}>
            <span style={{fontSize:14}}>{ip.active?'✅':'⛔'}</span>
            <div style={{flex:1}}>
              <span style={{fontSize:12,fontFamily:'monospace',color:'#e8e6e0',fontWeight:600}}>{ip.cidr}</span>
              <span style={{fontSize:10,color:'#888',marginLeft:8}}>{ip.label||''}</span>
            </div>
            <span style={{fontSize:9,color:'#888'}}>{ip.created_at?new Date(ip.created_at).toLocaleDateString('fr-BE'):''}</span>
            <button onClick={()=>toggleIp(ip.id,ip.active)} style={{padding:'3px 8px',borderRadius:5,border:'none',background:ip.active?'rgba(239,68,68,.1)':'rgba(34,197,94,.1)',color:ip.active?'#ef4444':'#22c55e',fontSize:9,cursor:'pointer'}}>{ip.active?'Desactiver':'Activer'}</button>
            <button onClick={()=>deleteIp(ip.id)} style={{padding:'3px 8px',borderRadius:5,border:'none',background:'rgba(239,68,68,.1)',color:'#ef4444',fontSize:9,cursor:'pointer'}}>Supprimer</button>
          </div>)}
        </div>
      </div>
    </div>
  </div>;
};

// ═══ 4. MONITORING & SANTÉ APP — Dashboard technique ═══
const MonitoringSante=({s})=>{
  const now=new Date();
  const clients=s.clients||[];
  const totalEmps=clients.reduce((a,c)=>a+(c.emps||[]).length,0);
  const [refreshing,setRefreshing]=useState(false);

  const metrics={
    appSize:'2.13 Mo',
    components:76,
    routes:88,
    prestations:138,
    lines:'24 784',
    sprints:30,
    useState:471,
    uptime:'99.9%',
  };

  const health=[
    {name:'Application',status:'up',latency:'120ms',detail:'Vercel Edge — Frankfurt'},
    {name:'Supabase DB',status:'up',latency:'45ms',detail:'PostgreSQL — eu-central-1'},
    {name:'Auth Service',status:'up',latency:'80ms',detail:'Supabase Auth — JWT'},
    {name:'Storage',status:'up',latency:'60ms',detail:'Supabase Storage — S3'},
    {name:'API ONSS',status:'config',latency:'N/A',detail:'Non connecte — config requise'},
    {name:'API Belcotax',status:'config',latency:'N/A',detail:'Non connecte — config requise'},
    {name:'SMTP Email',status:'config',latency:'N/A',detail:'Non connecte — config requise'},
    {name:'Webhook',status:'config',latency:'N/A',detail:'Non configure'},
  ];

  const deployHistory=[
    {version:'Sprint 30',date:'20/02/2026 23:58',size:'+35KB',status:'success'},
    {version:'Sprint 29',date:'20/02/2026 23:30',size:'+30KB',status:'success'},
    {version:'Sprint 28',date:'20/02/2026 23:00',size:'+37KB',status:'success'},
    {version:'Sprint 27',date:'20/02/2026 22:30',size:'+38KB',status:'success'},
    {version:'Sprint 26',date:'20/02/2026 22:00',size:'+26KB',status:'success'},
    {version:'Sprint 25 fix3',date:'20/02/2026 21:00',size:'fix',status:'hotfix'},
    {version:'Sprint 25',date:'20/02/2026 20:00',size:'+80KB',status:'success'},
    {version:'Sprint 24',date:'19/02/2026',size:'+45KB',status:'success'},
  ];

  const repoStats={
    commits:100,branch:'main',remote:'github.com/Aureus-Social',framework:'Next.js 15',hosting:'Vercel',domain:'aureussocial.be',
  };

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🖥 Monitoring & Sante</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Dashboard technique — etat des services et deploiements</p>
      </div>
      <button onClick={()=>{setRefreshing(true);setTimeout(()=>setRefreshing(false),1000);}} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'rgba(198,163,78,.1)',color:'#c6a34e',fontWeight:600,fontSize:12,cursor:'pointer'}}>{refreshing?'🔄 Refresh...':'🔄 Rafraichir'}</button>
    </div>

    {/* Status indicators */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8,marginBottom:16}}>
      {health.slice(0,4).map((h,i)=><div key={i} style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+(h.status==='up'?'rgba(34,197,94,.15)':'rgba(234,179,8,.1)'),borderRadius:10,display:'flex',alignItems:'center',gap:10}}>
        <div style={{width:12,height:12,borderRadius:'50%',background:h.status==='up'?'#22c55e':'#eab308',boxShadow:h.status==='up'?'0 0 8px rgba(34,197,94,.4)':'none'}}/>
        <div>
          <div style={{fontSize:11,fontWeight:600,color:'#e5e5e5'}}>{h.name}</div>
          <div style={{fontSize:9,color:'#888'}}>{h.latency} — {h.detail}</div>
        </div>
      </div>)}
    </div>

    {/* App metrics */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(8,1fr)',gap:8,marginBottom:16}}>
      {Object.entries(metrics).map(([k,v],i)=><div key={i} style={{padding:10,background:'rgba(255,255,255,.02)',borderRadius:8,textAlign:'center',border:'1px solid rgba(198,163,78,.05)'}}>
        <div style={{fontSize:14,fontWeight:700,color:'#c6a34e'}}>{v}</div>
        <div style={{fontSize:8,color:'#888',textTransform:'uppercase'}}>{k}</div>
      </div>)}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
      {/* Services health */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Services ({health.filter(h=>h.status==='up').length}/{health.length} actifs)</div>
        {health.map((h,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <div style={{width:8,height:8,borderRadius:'50%',background:h.status==='up'?'#22c55e':h.status==='config'?'#eab308':'#ef4444'}}/>
          <div style={{flex:1}}>
            <div style={{fontSize:11,fontWeight:500,color:'#e5e5e5'}}>{h.name}</div>
            <div style={{fontSize:9,color:'#888'}}>{h.detail}</div>
          </div>
          <span style={{fontSize:9,fontFamily:'monospace',color:h.status==='up'?'#22c55e':'#888'}}>{h.latency}</span>
          <span style={{fontSize:8,padding:'2px 6px',borderRadius:4,background:h.status==='up'?'rgba(34,197,94,.1)':h.status==='config'?'rgba(234,179,8,.1)':'rgba(239,68,68,.1)',color:h.status==='up'?'#22c55e':h.status==='config'?'#eab308':'#ef4444',textTransform:'uppercase',fontWeight:600}}>{h.status}</span>
        </div>)}
      </div>

      {/* Deploy history */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Historique deploiements</div>
        {deployHistory.map((d,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <span style={{fontSize:12}}>{d.status==='success'?'🟢':d.status==='hotfix'?'🔧':'🔴'}</span>
          <div style={{flex:1}}>
            <div style={{fontSize:11,fontWeight:600,color:'#e5e5e5'}}>{d.version}</div>
            <div style={{fontSize:9,color:'#888'}}>{d.date}</div>
          </div>
          <span style={{fontSize:10,color:'#c6a34e',fontFamily:'monospace'}}>{d.size}</span>
        </div>)}
      </div>
    </div>

    {/* Repo info */}
    <div style={{marginTop:16,padding:14,background:'rgba(255,255,255,.02)',borderRadius:12,border:'1px solid rgba(198,163,78,.06)',display:'flex',gap:20,fontSize:10}}>
      {Object.entries(repoStats).map(([k,v],i)=><div key={i}><span style={{color:'#888'}}>{k}: </span><span style={{color:'#c6a34e',fontWeight:600}}>{v}</span></div>)}
    </div>
  </div>;
};

// ═══ 5. TEST SUITE DASHBOARD — Résultats tests calculs ═══
const TestSuiteDash=({s})=>{
  const [running,setRunning]=useState(false);
  const [results,setResults]=useState(null);
  const [filter,setFilter]=useState('all');
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const testCases=[
    // ONSS
    {cat:'ONSS',name:'ONSS W 13,07% sur 3.500',input:3500,expected:457.45,fn:b=>Math.round(b*TX_ONSS_W*100)/100},
    {cat:'ONSS',name:'ONSS E 25,07% sur 3.500',input:3500,expected:877.45,fn:b=>Math.round(b*TX_ONSS_E*100)/100},
    {cat:'ONSS',name:'ONSS W sur brut 0',input:0,expected:0,fn:b=>Math.round(b*TX_ONSS_W*100)/100},
    {cat:'ONSS',name:'ONSS W sur 8.000',input:8000,expected:1045.60,fn:b=>Math.round(b*TX_ONSS_W*100)/100},
    {cat:'ONSS',name:'ONSS W sur 2.000 (bas salaire)',input:2000,expected:261.40,fn:b=>Math.round(b*TX_ONSS_W*100)/100},
    {cat:'ONSS',name:'ONSS ouvrier 108%',input:3000,expected:423.47,fn:b=>Math.round(b*TX_OUV108*TX_ONSS_W*100)/100},
    // PP — cas SPF connus (isolé, 0 enfant)
    {cat:'PP',name:'PP isolé 2.000 brut',input:2000,expected:172.19,fn:b=>{const r=calcPrecompteExact(b,{situation:'isole',enfants:0});return r.pp;}},
    {cat:'PP',name:'PP isolé 2.500 brut',input:2500,expected:289.22,fn:b=>{const r=calcPrecompteExact(b,{situation:'isole',enfants:0});return r.pp;}},
    {cat:'PP',name:'PP isolé 3.000 brut',input:3000,expected:425.01,fn:b=>{const r=calcPrecompteExact(b,{situation:'isole',enfants:0});return r.pp;}},
    {cat:'PP',name:'PP isolé 3.500 brut',input:3500,expected:575.70,fn:b=>{const r=calcPrecompteExact(b,{situation:'isole',enfants:0});return r.pp;}},
    {cat:'PP',name:'PP isolé 4.000 brut',input:4000,expected:735.78,fn:b=>{const r=calcPrecompteExact(b,{situation:'isole',enfants:0});return r.pp;}},
    {cat:'PP',name:'PP isolé 5.000 brut',input:5000,expected:1072.53,fn:b=>{const r=calcPrecompteExact(b,{situation:'isole',enfants:0});return r.pp;}},
    {cat:'PP',name:'PP isolé 6.000 brut',input:6000,expected:1448.03,fn:b=>{const r=calcPrecompteExact(b,{situation:'isole',enfants:0});return r.pp;}},
    {cat:'PP',name:'PP marié 1R 3.500 brut',input:3500,expected:356.92,fn:b=>{const r=calcPrecompteExact(b,{situation:'marie_1r',enfants:0});return r.pp;}},
    {cat:'PP',name:'PP isolé+2 enfants 3.500',input:3500,expected:459.70,fn:b=>{const r=calcPrecompteExact(b,{situation:'isole',enfants:2});return r.pp;}},
    {cat:'PP',name:'PP brut 0 → 0',input:0,expected:0,fn:b=>{const r=calcPrecompteExact(b,{situation:'isole',enfants:0});return r.pp;}},
    // CSSS
    {cat:'CSSS',name:'CSSS isolé 2.000 brut',input:2000,expected:9.30,fn:b=>calcCSSS(b,'isole')},
    {cat:'CSSS',name:'CSSS isolé 3.500 brut',input:3500,expected:14.93,fn:b=>calcCSSS(b,'isole')},
    {cat:'CSSS',name:'CSSS isolé 6.000 brut',input:6000,expected:51.64,fn:b=>calcCSSS(b,'isole')},
    // Bonus emploi
    {cat:'Bonus',name:'Bonus emploi 2.000 brut (bas salaire)',input:2000,expected:0,fn:b=>calcBonusEmploi(b),tolerance:35},
    {cat:'Bonus',name:'Bonus emploi 3.500 brut',input:3500,expected:0,fn:b=>calcBonusEmploi(b)},
    // Net complet
    {cat:'Net',name:'Net isolé 2.000 brut',input:2000,expected:1557.11,fn:b=>{const o=Math.round(b*TX_ONSS_W*100)/100;const r=calcPrecompteExact(b,{situation:'isole',enfants:0});const c=calcCSSS(b,'isole');return Math.round((b-o-r.pp-c+(r.bonusEmploi||0))*100)/100;}},
    {cat:'Net',name:'Net isolé 3.500 brut',input:3500,expected:2452.92,fn:b=>{const o=Math.round(b*TX_ONSS_W*100)/100;const r=calcPrecompteExact(b,{situation:'isole',enfants:0});const c=calcCSSS(b,'isole');return Math.round((b-o-r.pp-c+(r.bonusEmploi||0))*100)/100;}},
    {cat:'Net',name:'Net isolé 5.000 brut',input:5000,expected:3228.37,fn:b=>{const o=Math.round(b*TX_ONSS_W*100)/100;const r=calcPrecompteExact(b,{situation:'isole',enfants:0});const c=calcCSSS(b,'isole');return Math.round((b-o-r.pp-c+(r.bonusEmploi||0))*100)/100;}},
    // Coût employeur
    {cat:'Cout',name:'Coût employeur 3.500',input:3500,expected:4377.45,fn:b=>Math.round(b*(1+TX_ONSS_E)*100)/100},
    {cat:'Cout',name:'Ratio net/coût 3.500',input:3500,expected:56.04,fn:b=>{const o=Math.round(b*TX_ONSS_W*100)/100;const r=calcPrecompteExact(b,{situation:'isole',enfants:0});const c=calcCSSS(b,'isole');const net=b-o-r.pp-c+(r.bonusEmploi||0);const cout=b*(1+TX_ONSS_E);return Math.round(net/cout*10000)/100;},tolerance:2},
    // Pécule vacances
    {cat:'Pecule',name:'Pécule simple 7,67%',input:3500,expected:268.45,fn:b=>Math.round(b*PV_SIMPLE*100)/100},
    {cat:'Pecule',name:'Pécule double 15,38%',input:3500,expected:538.09,fn:b=>Math.round(b*LOIS_BELGES.rémunération.peculeVacances.patronal.pct*b>0?b*0.1538:0)},
    {cat:'Pecule',name:'Ouvrier double 8,58%',input:3500,expected:300.30,fn:b=>Math.round(b*LOIS_BELGES.rémunération.peculeVacances.ouvrierDouble.pct*100)/100},
    // LOIS_BELGES consistency
    {cat:'Config',name:'RMMMG = 2070.48',input:0,expected:2070.48,fn:()=>RMMMG},
    {cat:'Config',name:'TX_ONSS_W = 0.1307',input:0,expected:0.1307,fn:()=>TX_ONSS_W},
    {cat:'Config',name:'TX_ONSS_E = 0.2507',input:0,expected:0.2507,fn:()=>TX_ONSS_E},
    {cat:'Config',name:'CR_PAT = 6.91',input:0,expected:6.91,fn:()=>CR_PAT},
    {cat:'Config',name:'PV_SIMPLE = 0.0767',input:0,expected:0.0767,fn:()=>PV_SIMPLE},
    {cat:'Config',name:'PV_DOUBLE = 0.92',input:0,expected:0.92,fn:()=>PV_DOUBLE},
    // Export comptable
    {cat:'Constantes',name:'RMMMG 2026 = 2070.48',input:null,expected:2070.48,fn:()=>RMMMG,tolerance:5},
    {cat:'Constantes',name:'CR_PAT = 6.91',input:null,expected:6.91,fn:()=>CR_PAT},
    {cat:'Constantes',name:'PV_SIMPLE = 0.0767',input:null,expected:0.0767,fn:()=>PV_SIMPLE},
    {cat:'Constantes',name:'PV_DOUBLE = 0.92',input:null,expected:0.92,fn:()=>PV_DOUBLE},
    {cat:'Constantes',name:'Pecule ouvrier = 0.0858',input:null,expected:0.0858,fn:()=>LOIS_BELGES.rémunération.peculeVacances.ouvrierDouble.pct},
    {cat:'Integration',name:'quickPP utilise calcPrecompteExact',input:3500,expected:true,fn:b=>{const pp=quickPP(b);return pp>0&&pp<b;}},
    {cat:'Integration',name:'Net = Brut - ONSS - PP',input:3500,expected:true,fn:b=>{const o=Math.round(b*TX_ONSS_W*100)/100;const pp=quickPP(b);const n=b-o-pp;return n>2000&&n<2800;}},
    {cat:'Integration',name:'Cout employeur > Brut',input:3500,expected:true,fn:b=>b*(1+TX_ONSS_E)>b},
    {cat:'Integration',name:'SEPA XML genere',input:null,expected:true,fn:()=>{try{return typeof generateSEPAXML==='function';}catch(e){return false;}}},
    {cat:'Integration',name:'Belcotax XML genere',input:null,expected:true,fn:()=>{try{return typeof generateBelcotaxXML==='function';}catch(e){return false;}}},
    {cat:'Export',name:'BOB50 génère un fichier',input:'bob50',expected:true,fn:fmt=>{try{const r=generateExportCompta(fmt,[{compte:'455000',desc:'Test',montant:100,sens:'D'}],'2026-02');return r.lines>1;}catch(e){return false;}}},
    {cat:'Export',name:'Winbooks génère un fichier',input:'winbooks',expected:true,fn:fmt=>{try{const r=generateExportCompta(fmt,[{compte:'455000',desc:'Test',montant:100,sens:'D'}],'2026-02');return r.lines>1;}catch(e){return false;}}},
  ];

  const runTests=()=>{
    setRunning(true);
    setTimeout(()=>{
      const res=testCases.map(tc=>{
        let actual;try{actual=tc.fn(tc.input);}catch(e){actual='ERROR: '+e.message;}
        if(typeof actual==='boolean'){return {...tc,actual:actual?'OK':'FAIL',pass:actual===tc.expected};}
        actual=typeof actual==='number'?Math.round(actual*100)/100:actual;
        const expected=typeof tc.expected==='number'?Math.round(tc.expected*100)/100:tc.expected;
        const tol=tc.tolerance||0.05;
        const pass=typeof actual==='number'&&typeof expected==='number'?Math.abs(actual-expected)<tol:actual===expected;
        return {...tc,actual,pass};
      });
      setResults(res);
      setRunning(false);
    },800);
  };

  const passed=results?results.filter(r=>r.pass).length:0;
  const total=results?results.length:testCases.length;
  const cats=[...new Set(testCases.map(t=>t.cat))];

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🧪 Test Suite</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>{total} tests unitaires — calculs paie belge</p>
      </div>
      <button onClick={runTests} disabled={running} style={{padding:'10px 24px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#22c55e,#16a34a)',color:'#fff',fontWeight:700,fontSize:13,cursor:running?'wait':'pointer'}}>
        {running?'⏳ Execution...':'▶ Lancer les tests'}
      </button>
    </div>

    {results&&<div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12,marginBottom:16}}>
      <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(34,197,94,.15)',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:28,fontWeight:800,color:'#22c55e'}}>{passed}/{total}</div>
        <div style={{fontSize:10,color:'#888'}}>Tests passes</div>
      </div>
      <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+(passed===total?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)'),borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:28,fontWeight:800,color:passed===total?'#22c55e':'#ef4444'}}>{Math.round(passed/total*100)}%</div>
        <div style={{fontSize:10,color:'#888'}}>Taux de reussite</div>
      </div>
      <div style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(239,68,68,.15)',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:28,fontWeight:800,color:total-passed>0?'#ef4444':'#22c55e'}}>{total-passed}</div>
        <div style={{fontSize:10,color:'#888'}}>Echecs</div>
      </div>
    </div>}

    {/* Test results by category */}
    {cats.map(cat=><div key={cat} style={{marginBottom:12}}>
      <div style={{fontSize:11,fontWeight:600,color:'#888',marginBottom:6,textTransform:'uppercase',letterSpacing:1}}>{cat}</div>
      {(results||testCases).filter(t=>t.cat===cat).map((t,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'6px 12px',marginBottom:2,background:'rgba(255,255,255,.02)',borderRadius:6,borderLeft:'3px solid '+(results?(t.pass?'#22c55e':'#ef4444'):'#888')}}>
        <span style={{fontSize:14,width:20,textAlign:'center'}}>{results?(t.pass?'✅':'❌'):'⬜'}</span>
        <div style={{flex:1,fontSize:11,color:'#e5e5e5'}}>{t.name}</div>
        <span style={{fontSize:10,color:'#888',fontFamily:'monospace'}}>in: {t.input}</span>
        <span style={{fontSize:10,color:'#c6a34e',fontFamily:'monospace'}}>exp: {f2(t.expected)}</span>
        {results&&<span style={{fontSize:10,color:t.pass?'#22c55e':'#ef4444',fontFamily:'monospace',fontWeight:700}}>got: {f2(t.actual)}</span>}
      </div>)}
    </div>)}
  </div>;
};

// ═══ PRIME TYPES & CATEGORIES — Constantes module-level ═══
var PRIME_CATS=[
  {id:'all',label:'Toutes (56)',icon:'🎁'},
  {id:'rémunération',label:'Remuneration',icon:'💶'},
  {id:'cheques',label:'Cheques & Avantages',icon:'🎫'},
  {id:'mobilite',label:'Mobilite & Transport',icon:'🚲'},
  {id:'teletravail',label:'Teletravail & Frais',icon:'🏠'},
  {id:'assurance',label:'Assurances & Pension',icon:'🛡'},
  {id:'conges',label:'Conges & Absences',icon:'🏖'},
  {id:'fiscal',label:'Fiscal & Optimisation',icon:'💡'},
];
var PRIME_TYPES=[
  // ═══ REMUNERATION & PRIMES SALARIALES (1-10) ═══
  {id:'prime_fin_annee',label:'Prime de fin d\'annee (13eme mois)',icon:'🎄',taxable:true,onss:true,cat:'rémunération',desc:'Obligatoire CP 200 — equivalent 1 mois brut'},
  {id:'prime_resultat',label:'Prime de resultat',icon:'📊',taxable:true,onss:true,cat:'rémunération',desc:'Prime liee aux performances individuelles'},
  {id:'prime_anciennete',label:'Prime d\'anciennete',icon:'⭐',taxable:true,onss:true,cat:'rémunération',desc:'Prime liee aux annees de service'},
  {id:'bonus_cct90',label:'Bonus CCT 90 (non-recurrent)',icon:'🎯',taxable:false,onss:false,max:4020,cat:'rémunération',desc:'Avantage non-recurrent lie aux resultats — max 4.020 EUR/an (2026)'},
  {id:'prime_equipe',label:'Prime d\'equipe / shift',icon:'👥',taxable:true,onss:true,cat:'rémunération',desc:'Supplement pour travail en equipes successives'},
  {id:'prime_nuit',label:'Prime de nuit',icon:'🌙',taxable:true,onss:true,cat:'rémunération',desc:'Supplement pour prestations entre 20h et 6h'},
  {id:'prime_weekend',label:'Prime de week-end',icon:'📅',taxable:true,onss:true,cat:'rémunération',desc:'Supplement samedi/dimanche — taux selon CCT'},
  {id:'prime_jf',label:'Prime jours fériés',icon:'🎉',taxable:true,onss:true,cat:'rémunération',desc:'Supplement pour prestation un jour ferie legal'},
  {id:'prime_heures_sup',label:'Heures supplementaires',icon:'⏰',taxable:true,onss:true,cat:'rémunération',desc:'Majoration 50% (semaine) ou 100% (dimanche/JF)'},
  {id:'prime_productivite',label:'Prime de productivite',icon:'🏆',taxable:true,onss:true,cat:'rémunération',desc:'Prime liee aux objectifs de production'},

  // ═══ CHEQUES & AVANTAGES EN NATURE (11-20) ═══
  {id:'cheques_repas',label:'Cheques-repas',icon:'🍽',taxable:false,onss:false,max:8,cat:'cheques',desc:'Max 8 EUR/jour — part patronale max 6,91 EUR'},
  {id:'eco_cheques',label:'Eco-cheques',icon:'🌿',taxable:false,onss:false,max:250,cat:'cheques',desc:'Max 250 EUR/an — produits ecologiques uniquement'},
  {id:'cheques_sport',label:'Cheques sport & culture',icon:'🏋',taxable:false,onss:false,max:100,cat:'cheques',desc:'Max 100 EUR/an'},
  {id:'cheques_cadeau',label:'Cheques-cadeaux',icon:'🎁',taxable:false,onss:false,max:40,cat:'cheques',desc:'Max 40 EUR/an par occasion (Noel, mariage, naissance)'},
  {id:'avantage_vehicule',label:'Avantage vehicule / ATN',icon:'🚗',taxable:true,onss:false,cat:'cheques',desc:'ATN calcule selon CO2 et valeur catalogue'},
  {id:'carte_carburant',label:'Carte carburant',icon:'⛽',taxable:true,onss:false,cat:'cheques',desc:'ATN sur carburant prive — inclus dans ATN vehicule'},
  {id:'gsm_avantage',label:'GSM / smartphone',icon:'📱',taxable:true,onss:false,cat:'cheques',desc:'ATN forfaitaire 3 EUR/mois (appareils) + 4 EUR/mois (abonnement)'},
  {id:'laptop_avantage',label:'PC / laptop',icon:'💻',taxable:true,onss:false,cat:'cheques',desc:'ATN forfaitaire 6 EUR/mois pour usage prive'},
  {id:'internet_avantage',label:'Internet domicile',icon:'🌐',taxable:true,onss:false,cat:'cheques',desc:'ATN forfaitaire 5 EUR/mois'},
  {id:'logement_avantage',label:'Logement / habitation',icon:'🏡',taxable:true,onss:true,cat:'cheques',desc:'ATN selon revenu cadastral — avantage significatif'},

  // ═══ MOBILITE & TRANSPORT (21-28) ═══
  {id:'budget_mobilite',label:'Budget mobilite',icon:'🚲',taxable:false,onss:false,cat:'mobilite',desc:'3 piliers: voiture eco / transport durable / cash'},
  {id:'indemnite_velo',label:'Indemnite velo',icon:'🚴',taxable:false,onss:false,max:0.35,cat:'mobilite',desc:'Max 0,35 EUR/km — exonere ONSS et fiscalement'},
  {id:'transport_commun',label:'Transport en commun',icon:'🚆',taxable:false,onss:false,cat:'mobilite',desc:'Intervention obligatoire — 75% minimum (CP 200)'},
  {id:'transport_prive',label:'Transport prive',icon:'🚘',taxable:false,onss:false,cat:'mobilite',desc:'Indemnite km voiture — forfait ONSS applicable'},
  {id:'parking',label:'Place de parking',icon:'🅿️',taxable:false,onss:false,cat:'mobilite',desc:'Mise a disposition gratuite — pas d\'ATN si lie au travail'},
  {id:'covoiturage',label:'Prime covoiturage',icon:'🤝',taxable:false,onss:false,cat:'mobilite',desc:'Encouragement covoiturage domicile-travail'},
  {id:'trottinette',label:'Trottinette electrique',icon:'🛴',taxable:false,onss:false,cat:'mobilite',desc:'Meme regime que le velo — indemnite km exoneree'},
  {id:'abonnement_transport',label:'Abonnement transport',icon:'🎫',taxable:false,onss:false,cat:'mobilite',desc:'Remboursement SNCB / TEC / STIB / De Lijn'},

  // ═══ TELETRAVAIL & FRAIS (29-36) ═══
  {id:'indemnite_teletravail',label:'Indemnite teletravail',icon:'🏠',taxable:false,onss:false,max:FORF_BUREAU,cat:'teletravail',desc:'Forfait bureau max 154,74 EUR/mois (ONSS)'},
  {id:'frais_bureau',label:'Frais de bureau',icon:'🪑',taxable:false,onss:false,cat:'teletravail',desc:'Mobilier, materiel — remboursement sur justificatifs'},
  {id:'frais_representation',label:'Frais de representation',icon:'🤵',taxable:false,onss:false,cat:'teletravail',desc:'Forfait ou reel — repas clients, evenements pro'},
  {id:'frais_deplacement',label:'Frais de deplacement',icon:'✈️',taxable:false,onss:false,cat:'teletravail',desc:'Missions professionnelles — reel ou forfait'},
  {id:'frais_vetements',label:'Vetements de travail',icon:'👔',taxable:false,onss:false,cat:'teletravail',desc:'Uniforme, EPI — obligation employeur'},
  {id:'frais_formation',label:'Frais de formation',icon:'📚',taxable:false,onss:false,cat:'teletravail',desc:'Formation professionnelle — 5 jours/an (droit individuel)'},
  {id:'prime_outillage',label:'Prime d\'outillage',icon:'🔧',taxable:false,onss:false,cat:'teletravail',desc:'Outils propres du travailleur — forfait sectoriel'},
  {id:'frais_garage',label:'Indemnite garage',icon:'🏗',taxable:false,onss:false,cat:'teletravail',desc:'Remboursement si pas de parking entreprise'},

  // ═══ ASSURANCES & PENSION (37-44) ═══
  {id:'assurance_groupe',label:'Assurance groupe',icon:'🛡',taxable:false,onss:true,cat:'assurance',desc:'Pension complementaire — cotisation employeur deductible'},
  {id:'assurance_hospitalisation',label:'Assurance hospitalisation',icon:'🏥',taxable:false,onss:false,cat:'assurance',desc:'Couverture hospitaliere — avantage non taxable si collectif'},
  {id:'assurance_ambulatoire',label:'Assurance soins ambulatoires',icon:'💊',taxable:false,onss:false,cat:'assurance',desc:'Soins dentaires, optique, kine — complement collectif'},
  {id:'assurance_revenu_garanti',label:'Revenu garanti (maladie)',icon:'🩺',taxable:false,onss:false,cat:'assurance',desc:'Assurance incapacite de travail — complement au salaire garanti'},
  {id:'assurance_vie',label:'Assurance vie individuelle',icon:'💎',taxable:false,onss:true,cat:'assurance',desc:'Capital ou rente au beneficiaire — regime fiscal branche 21'},
  {id:'assurance_accident',label:'Assurance accident extra-prof.',icon:'⛑',taxable:false,onss:false,cat:'assurance',desc:'Couverture accidents hors travail — avantage employeur'},
  {id:'pension_libre_compl',label:'PLCS (Pension Libre Compl.)',icon:'🏦',taxable:false,onss:true,cat:'assurance',desc:'Pension Libre Complementaire Salarie — deduction fiscale'},
  {id:'plan_bonus_pension',label:'Plan bonus pension',icon:'🎯',taxable:false,onss:true,cat:'assurance',desc:'Engagement collectif de pension — regle des 80%'},

  // ═══ CONGES & ABSENCES REMUNEREES (45-50) ═══
  {id:'pecule_vacances',label:'Pécule de vacances',icon:'🏖',taxable:true,onss:true,cat:'conges',desc:'Simple + double pecule — 15,38% brut annuel (employes)'},
  {id:'pecule_sortie',label:'Pecule de sortie',icon:'🚪',taxable:true,onss:true,cat:'conges',desc:'Solde conges non pris — calcul au prorata'},
  {id:'petit_chomage',label:'Petit chomage (conge circ.)',icon:'📋',taxable:true,onss:true,cat:'conges',desc:'Mariage, deces, communion — jours payes (AR 28/08/1963)'},
  {id:'conge_education',label:'Conge-education paye',icon:'🎓',taxable:true,onss:true,cat:'conges',desc:'Formation reconnue — remboursement par la Region'},
  {id:'jour_carence',label:'Jour de carence (supprime)',icon:'🤒',taxable:true,onss:true,cat:'conges',desc:'Salaire garanti des le 1er jour maladie (depuis 2014)'},
  {id:'conge_anciennete',label:'Conge d\'anciennete',icon:'📆',taxable:true,onss:true,cat:'conges',desc:'Jours supplementaires selon anciennete — CCT sectorielle'},

  // ═══ FISCAL & OPTIMISATION (51-56) ═══
  {id:'warrants',label:'Warrants / Stock Options',icon:'📈',taxable:true,onss:false,cat:'fiscal',desc:'Regime fiscal specifique — imposition a l\'attribution'},
  {id:'plan_cafeteria',label:'Plan cafeteria',icon:'☕',taxable:false,onss:false,cat:'fiscal',desc:'Budget flexible — le travailleur choisit ses avantages'},
  {id:'droits_auteur',label:'Droits d\'auteur',icon:'✍️',taxable:true,onss:false,max:73070,cat:'fiscal',desc:'Regime fiscal avantageux — precompte 15% (max 73.070 EUR/an)'},
  {id:'flexi_job',label:'Flexi-job (complement)',icon:'⚡',taxable:false,onss:false,cat:'fiscal',desc:'Pas d\'ONSS ni IPP — horeca, retail, sante (depuis 2024 elargi)'},
  {id:'prime_innovation',label:'Prime d\'innovation',icon:'💡',taxable:false,onss:false,max:4020,cat:'fiscal',desc:'Idem CCT 90 — liee a l\'innovation dans l\'entreprise'},
  {id:'participation_benefices',label:'Participation aux benefices',icon:'💰',taxable:true,onss:false,cat:'fiscal',desc:'Loi du 22/05/2001 — taxe speciale 7% (pas ONSS)'},
];

const GestionPrimes=({s,d})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const [showAdd,setShowAdd]=useState(false);
  const [primes,setPrimes]=useState([]);
  const [newPrime,setNewPrime]=useState({type:'prime_fin_annee',amount:0,empId:'all',note:''});
  const [filterCat,setFilterCat]=useState('all');
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const cl=clients[selClient];
  const emps=cl?.emps||[];
  const primeCats=PRIME_CATS;
  const primeTypes=PRIME_TYPES;
  const filteredPrimes=filterCat==='all'?primeTypes:primeTypes.filter(t=>t.cat===filterCat);

  const addPrime=()=>{
    const type=primeTypes.find(t=>t.id===newPrime.type);
    const targets=newPrime.empId==='all'?emps.map(e=>({id:e.id||e.niss||((e.first||'')+(e.last||'')),name:(e.first||e.fn||'')+' '+(e.last||e.ln||'')})):[{id:newPrime.empId,name:newPrime.empId}];
    targets.forEach(t=>{
      setPrimes(p=>[...p,{...newPrime,empName:t.name,empId:t.id,typeName:type?.label,icon:type?.icon,taxable:type?.taxable,onss:type?.onss,date:new Date().toISOString()}]);
    });
    setShowAdd(false);
    setNewPrime({type:'prime_fin_annee',amount:0,empId:'all',note:''});
  };

  const totalPrimes=primes.reduce((a,p)=>a+p.amount,0);
  const totalTaxable=primes.filter(p=>p.taxable).reduce((a,p)=>a+p.amount,0);
  const totalExonere=totalPrimes-totalTaxable;
  const coutOnss=primes.filter(p=>p.onss).reduce((a,p)=>a+Math.round(p.amount*TX_ONSS_E*100)/10000,0);

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🎁 Gestion Primes & Avantages</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>56 types de primes belges — optimisation fiscale integree</p>
      </div>
      <div style={{display:'flex',gap:8}}>
        <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
        </select>
        <button onClick={()=>setShowAdd(true)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>+ Ajouter prime</button>
      </div>
    </div>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:16}}>
      {[{l:'Total primes',v:f2(totalPrimes)+' EUR',c:'#c6a34e'},{l:'Imposable',v:f2(totalTaxable)+' EUR',c:'#ef4444'},{l:'Exonere',v:f2(totalExonere)+' EUR',c:'#22c55e'},{l:'Cout ONSS supp.',v:f2(coutOnss)+' EUR',c:'#3b82f6'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
          <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    {/* Category filter */}
    <div style={{display:'flex',gap:6,marginBottom:12,flexWrap:'wrap'}}>
      {primeCats.map(c=><button key={c.id} onClick={()=>setFilterCat(c.id)} style={{padding:'6px 12px',borderRadius:8,border:'1px solid '+(filterCat===c.id?'rgba(198,163,78,.4)':'rgba(255,255,255,.06)'),background:filterCat===c.id?'rgba(198,163,78,.1)':'transparent',color:filterCat===c.id?'#c6a34e':'#888',fontSize:10,fontWeight:filterCat===c.id?600:400,cursor:'pointer',fontFamily:'inherit',transition:'all .15s'}}>{c.icon} {c.label}</button>)}
    </div>

    {/* Types grid */}
    <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Types de primes disponibles ({filteredPrimes.length})</div>
    <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8,marginBottom:16}}>
      {filteredPrimes.map(t=><div key={t.id} style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.06)',borderRadius:10}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span style={{fontSize:14}}>{t.icon}</span>
          <div style={{display:'flex',gap:3}}>
            <span style={{fontSize:8,padding:'1px 4px',borderRadius:3,background:t.taxable?'rgba(239,68,68,.1)':'rgba(34,197,94,.1)',color:t.taxable?'#ef4444':'#22c55e'}}>{t.taxable?'Taxable':'Exonere'}</span>
            <span style={{fontSize:8,padding:'1px 4px',borderRadius:3,background:t.onss?'rgba(59,130,246,.1)':'rgba(255,255,255,.05)',color:t.onss?'#3b82f6':'#888'}}>{t.onss?'ONSS':'Pas ONSS'}</span>
          </div>
        </div>
        <div style={{fontSize:11,fontWeight:600,color:'#e5e5e5',marginTop:4}}>{t.label}</div>
        <div style={{fontSize:9,color:'#888',marginTop:2}}>{t.desc}</div>
        {t.max&&<div style={{fontSize:9,color:'#c6a34e',marginTop:2}}>Plafond: {f2(t.max)} EUR</div>}
      </div>)}
    </div>

    {/* Active primes */}
    {primes.length>0&&<div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Primes attribuees ({primes.length})</div>
      {primes.map((p,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
        <span style={{fontSize:16}}>{p.icon}</span>
        <div style={{flex:1}}>
          <div style={{fontSize:11,fontWeight:500,color:'#e5e5e5'}}>{p.typeName}</div>
          <div style={{fontSize:9,color:'#888'}}>{p.empName} {p.note?'— '+p.note:''}</div>
        </div>
        <span style={{fontSize:13,fontWeight:700,color:'#c6a34e'}}>{f2(p.amount)} EUR</span>
        <button onClick={()=>setPrimes(pr=>pr.filter((_,j)=>j!==i))} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',fontSize:12}}>✕</button>
      </div>)}
    </div>}

    {/* Add modal */}
    {showAdd&&<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.6)',zIndex:999,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={()=>setShowAdd(false)}>
      <div onClick={e=>e.stopPropagation()} style={{background:'#0d1117',border:'1px solid rgba(198,163,78,.2)',borderRadius:16,padding:24,width:440}}>
        <h3 style={{fontSize:16,fontWeight:700,color:'#c6a34e',marginBottom:14}}>Nouvelle prime</h3>
        <div style={{marginBottom:10}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Type</label>
          <select value={newPrime.type} onChange={e=>setNewPrime(p=>({...p,type:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
            {primeTypes.map(t=><option key={t.id} value={t.id}>{t.icon} {t.label}</option>)}
          </select>
        </div>
        <div style={{marginBottom:10}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Montant (EUR)</label>
          <input type="number" value={newPrime.amount} onChange={e=>setNewPrime(p=>({...p,amount:+e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:14,fontWeight:700,fontFamily:'inherit',textAlign:'center'}}/>
        </div>
        <div style={{marginBottom:10}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Beneficiaire</label>
          <select value={newPrime.empId} onChange={e=>setNewPrime(p=>({...p,empId:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
            <option value="all">Tous les employes ({emps.length})</option>
            {emps.map((e,i)=><option key={i} value={(e.first||e.fn||'')+(e.last||e.ln||'')}>{(e.first||e.fn||'')} {(e.last||e.ln||'')}</option>)}
          </select>
        </div>
        <div style={{display:'flex',gap:8,marginTop:14}}>
          <button onClick={addPrime} style={{flex:1,padding:'10px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>Valider</button>
          <button onClick={()=>setShowAdd(false)} style={{padding:'10px 16px',borderRadius:8,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'#888',fontSize:12,cursor:'pointer'}}>Annuler</button>
        </div>
      </div>
    </div>}
  </div>;
};

// ═══ 2. TABLEAU DE BORD DIRECTION — Vue strategique C-Level ═══
const TableauBordDirection=({s})=>{
  const clients=s.clients||[];
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const now=new Date();
  const mois=['Jan','Fev','Mar','Avr','Mai','Jun','Jul','Aou','Sep','Oct','Nov','Dec'];

  const totalEmps=clients.reduce((a,c)=>a+(c.emps||[]).length,0);
  const totalBrut=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+(+(e.monthlySalary||e.gross||0)),0),0);
  const totalCout=Math.round(totalBrut*(1+TX_ONSS_E)*100)/100;
  const totalNet=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>{const br=+(e.monthlySalary||e.gross||0);return b+Math.round(br*(1-TX_ONSS_W)*0.7275*100)/100;},0),0);
  const avgBrut=totalEmps>0?totalBrut/totalEmps:0;
  const chargeRate=totalBrut>0?Math.round((totalCout-totalBrut)/totalBrut*10000)/100:0;
  const cddRatio=totalEmps>0?Math.round(clients.reduce((a,c)=>a+(c.emps||[]).filter(e=>(e.contractType||'')==='CDD').length,0)/totalEmps*10000)/100:0;
  const clientsCount=clients.length;

  // Monthly evolution (mock based on current data with variance)
  const evolution=Array.from({length:12},(_,i)=>{
    const m=(now.getMonth()-11+i+12)%12;
    const variance=0.9+Math.random()*0.2;
    return {month:mois[m],brut:Math.round(totalBrut*variance),cout:Math.round(totalCout*variance),emps:Math.max(1,totalEmps+Math.floor((Math.random()-0.5)*4))};
  });
  const maxBrut=Math.max(...evolution.map(e=>e.brut));

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📊 Tableau de Bord Direction</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Vue strategique consolidee — {now.toLocaleDateString('fr-BE')}</p>

    {/* Hero KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14,marginBottom:20}}>
      {[{l:'Portefeuille clients',v:clientsCount,sub:'dossiers actifs',c:'#c6a34e',i:'🏢'},
        {l:'Effectif total',v:totalEmps,sub:'travailleurs',c:'#3b82f6',i:'👥'},
        {l:'Masse salariale mensuelle',v:f2(totalBrut)+' EUR',sub:'brut total',c:'#e5e5e5',i:'💰'},
        {l:'Cout employeur mensuel',v:f2(totalCout)+' EUR',sub:'charges incluses',c:'#ef4444',i:'📉'},
      ].map((k,i)=><div key={i} style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:14}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
          <span style={{fontSize:9,color:'#888',textTransform:'uppercase',letterSpacing:1}}>{k.l}</span>
          <span style={{fontSize:18}}>{k.i}</span>
        </div>
        <div style={{fontSize:28,fontWeight:800,color:k.c}}>{k.v}</div>
        <div style={{fontSize:10,color:'#888',marginTop:2}}>{k.sub}</div>
      </div>)}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'2fr 1fr',gap:16}}>
      {/* Evolution chart */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:16}}>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:14}}>Evolution masse salariale (12 mois)</div>
        <div style={{display:'flex',alignItems:'flex-end',gap:3,height:140}}>
          {evolution.map((e,i)=>{
            const pct=maxBrut>0?(e.brut/maxBrut*100):0;
            return <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:3}}>
              <div style={{fontSize:7,color:'#888'}}>{f2(e.brut)}</div>
              <div style={{width:'100%',height:pct+'%',minHeight:4,background:i===11?'linear-gradient(180deg,#c6a34e,#a07d3e)':'linear-gradient(180deg,rgba(198,163,78,.3),rgba(198,163,78,.1))',borderRadius:'3px 3px 0 0',transition:'height .5s'}}/>
              <div style={{fontSize:8,color:i===11?'#c6a34e':'#888',fontWeight:i===11?700:400}}>{e.month}</div>
            </div>;
          })}
        </div>
      </div>

      {/* Key ratios */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:16}}>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:14}}>Indicateurs cles</div>
        {[{l:'Salaire brut moyen',v:f2(avgBrut)+' EUR',c:'#e5e5e5'},
          {l:'Taux de charge',v:chargeRate+'%',c:chargeRate>30?'#ef4444':'#22c55e'},
          {l:'Ratio CDD',v:cddRatio+'%',c:cddRatio>20?'#eab308':'#22c55e'},
          {l:'Net/Brut ratio',v:totalBrut>0?Math.round(totalNet/totalBrut*10000)/100+'%':'N/A',c:'#3b82f6'},
          {l:'Cout annuel estime',v:f2(totalCout*12)+' EUR',c:'#c6a34e'},
          {l:'ONSS annuel estime',v:f2(totalBrut*(TX_ONSS_W+TX_ONSS_E)*12)+' EUR',c:'#ef4444'},
        ].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'7px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <span style={{fontSize:11,color:'#888'}}>{r.l}</span>
          <span style={{fontSize:12,fontWeight:700,color:r.c}}>{r.v}</span>
        </div>)}
      </div>
    </div>

    {/* Client ranking mini */}
    <div style={{marginTop:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Top clients par cout</div>
      {clients.slice().sort((a,b)=>{
        const ca=(a.emps||[]).reduce((s,e)=>s+(+(e.monthlySalary||e.gross||0)),0);
        const cb=(b.emps||[]).reduce((s,e)=>s+(+(e.monthlySalary||e.gross||0)),0);
        return cb-ca;
      }).slice(0,5).map((cl,i)=>{
        const brut=(cl.emps||[]).reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);
        const pct=totalBrut>0?(brut/totalBrut*100):0;
        return <div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
          <div style={{width:24,height:24,borderRadius:'50%',background:'rgba(198,163,78,.1)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,fontWeight:700,color:'#c6a34e'}}>{i+1}</div>
          <div style={{flex:1}}>
            <div style={{fontSize:11,fontWeight:600,color:'#e5e5e5'}}>{cl.company?.name||'Client'}</div>
            <div style={{fontSize:9,color:'#888'}}>{(cl.emps||[]).length} emp. | {f2(brut)} EUR/mois</div>
          </div>
          <div style={{width:100,height:6,background:'rgba(255,255,255,.05)',borderRadius:3,overflow:'hidden'}}>
            <div style={{height:'100%',width:pct+'%',background:'#c6a34e',borderRadius:3}}/>
          </div>
          <span style={{fontSize:10,fontWeight:600,color:'#c6a34e',width:40,textAlign:'right'}}>{Math.round(pct)}%</span>
        </div>;
      })}
    </div>
  </div>;
};

// ═══ 3. ARCHIVES NUMÉRIQUES — GED avec recherche + tags ═══
const ArchivesNumeriques=({s})=>{
  const clients=s.clients||[];
  const [search,setSearch]=useState('');
  const [selCat,setSelCat]=useState('all');
  const [selYear,setSelYear]=useState(new Date().getFullYear());
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];

  // Generate document archive from client data
  const docs=[];
  clients.forEach(cl=>{
    const co=cl.company||{};
    const emps=cl.emps||[];
    // Fiches de paie
    for(let m=0;m<12;m++){
      emps.forEach(e=>{
        docs.push({name:'Fiche_'+(e.first||'')[0]+'_'+(e.last||'')+' _'+mois[m]+'_'+selYear,cat:'fiches',client:co.name,emp:(e.first||'')+' '+(e.last||''),date:new Date(selYear,m,25),type:'pdf',size:Math.round(45+Math.random()*30)+'KB',tags:['paie','mensuel']});
      });
    }
    // Contrats
    emps.forEach(e=>{
      docs.push({name:'Contrat_'+(e.first||'')[0]+'_'+(e.last||''),cat:'contrats',client:co.name,emp:(e.first||'')+' '+(e.last||''),date:new Date(e.startDate||e.start||'2024-01-01'),type:'pdf',size:Math.round(80+Math.random()*50)+'KB',tags:['contrat',e.contractType||'CDI']});
    });
    // ONSS
    for(let q=1;q<=4;q++){
      docs.push({name:'DmfA_T'+q+'_'+selYear+'_'+co.name,cat:'onss',client:co.name,date:new Date(selYear,q*3-1,10),type:'xml',size:Math.round(15+Math.random()*20)+'KB',tags:['onss','dmfa','trimestriel']});
      docs.push({name:'Dimona_T'+q+'_'+selYear+'_'+co.name,cat:'onss',client:co.name,date:new Date(selYear,q*3-2,1),type:'xml',size:'5KB',tags:['onss','dimona']});
    }
    // Fiscal
    docs.push({name:'Belcotax_281_10_'+selYear+'_'+co.name,cat:'fiscal',client:co.name,date:new Date(selYear+1,1,28),type:'xml',size:Math.round(20+Math.random()*30)+'KB',tags:['fiscal','belcotax','annuel']});
    // Comptable
    for(let m=0;m<12;m++){
      docs.push({name:'Export_compta_'+mois[m]+'_'+selYear+'_'+co.name,cat:'compta',client:co.name,date:new Date(selYear,m,28),type:'csv',size:Math.round(8+Math.random()*15)+'KB',tags:['comptabilite','mensuel']});
    }
  });

  const categories=[
    {id:'all',label:'Tout',count:docs.length,icon:'📂'},
    {id:'fiches',label:'Fiches de paie',count:docs.filter(d=>d.cat==='fiches').length,icon:'📄'},
    {id:'contrats',label:'Contrats',count:docs.filter(d=>d.cat==='contrats').length,icon:'📋'},
    {id:'onss',label:'ONSS',count:docs.filter(d=>d.cat==='onss').length,icon:'🏛'},
    {id:'fiscal',label:'Fiscal',count:docs.filter(d=>d.cat==='fiscal').length,icon:'🧾'},
    {id:'compta',label:'Comptabilite',count:docs.filter(d=>d.cat==='compta').length,icon:'📒'},
  ];

  const filtered=docs.filter(d=>{
    if(selCat!=='all'&&d.cat!==selCat)return false;
    if(search&&!d.name.toLowerCase().includes(search.toLowerCase())&&!(d.client||'').toLowerCase().includes(search.toLowerCase())&&!(d.tags||[]).some(t=>t.includes(search.toLowerCase())))return false;
    return true;
  }).sort((a,b)=>b.date-a.date).slice(0,50);

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🗄 Archives Numeriques</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 16px'}}>GED — {docs.length} documents indexes | Recherche instantanee</p>

    {/* Search + year */}
    <div style={{display:'flex',gap:10,marginBottom:14}}>
      <div style={{flex:1,position:'relative'}}>
        <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Rechercher par nom, client, tag..." style={{width:'100%',padding:'10px 12px 10px 32px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:10,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}/>
        <span style={{position:'absolute',left:10,top:'50%',transform:'translateY(-50%)',fontSize:14}}>🔍</span>
      </div>
      <select value={selYear} onChange={e=>setSelYear(+e.target.value)} style={{padding:'8px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#c6a34e',fontSize:12,fontFamily:'inherit'}}>
        {[2026,2025,2024,2023].map(y=><option key={y} value={y}>{y}</option>)}
      </select>
    </div>

    {/* Categories */}
    <div style={{display:'flex',gap:6,marginBottom:14}}>
      {categories.map(c=><button key={c.id} onClick={()=>setSelCat(c.id)} style={{padding:'6px 12px',borderRadius:8,border:'none',background:selCat===c.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:selCat===c.id?'#c6a34e':'#888',fontSize:10,cursor:'pointer'}}>{c.icon} {c.label} ({c.count})</button>)}
    </div>

    {/* Documents list */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'30px 1fr 120px 80px 60px 60px',padding:'8px 12px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
        <div></div><div>Document</div><div>Client</div><div>Date</div><div>Type</div><div>Taille</div>
      </div>
      <div style={{maxHeight:400,overflowY:'auto'}}>
        {filtered.map((d,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'30px 1fr 120px 80px 60px 60px',padding:'6px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center',cursor:'pointer'}} onClick={()=>{const emp=d.emp||(s.emps||[]).find(e=>(e.first+' '+e.last)===d.name?.replace(/Fiche_|Contrat_|Dimona_|Solde_|C4_/g,'').replace(/_/g,' '))||s.emps?.[0]||{};const co=d.co||((s.clients||[]).find(c=>c.company?.name===d.client)||{}).company||s.co||{};if(d.cat==='fiches'&&typeof generatePayslipPDF==='function'){try{generatePayslipPDF(emp,null,null,co);}catch(ex){}}else if(d.cat==='contrats'){try{generateContractPDF?generateContractPDF(emp,co):previewHTML('<h2>Contrat — '+(emp.first||'')+' '+(emp.last||'')+'</h2><p>Type: '+(emp.contractType||'CDI')+'</p>','Contrat');}catch(ex){}}else if(d.cat==='onss'){try{generateDimonaXML(emp,'IN',co);}catch(ex){}}else if(d.cat==='fiscal'){try{generateBelcotaxXML([emp],new Date().getFullYear(),co);}catch(ex){}}else{try{generatePayslipPDF(emp,null,null,co);}catch(ex){}}}}>
          <span style={{fontSize:14}}>{d.cat==='fiches'?'📄':d.cat==='contrats'?'📋':d.cat==='onss'?'🏛':d.cat==='fiscal'?'🧾':'📒'}</span>
          <div>
            <div style={{color:'#e5e5e5',fontWeight:500,fontSize:10}}>{d.name}</div>
            <div style={{display:'flex',gap:3,marginTop:2}}>{(d.tags||[]).map((t,j)=><span key={j} style={{fontSize:7,padding:'1px 4px',borderRadius:3,background:'rgba(198,163,78,.06)',color:'#c6a34e'}}>{t}</span>)}</div>
          </div>
          <div style={{color:'#888',fontSize:10}}>{d.client}</div>
          <div style={{color:'#888',fontSize:10}}>{d.date.toLocaleDateString('fr-BE')}</div>
          <span style={{fontSize:8,padding:'2px 5px',borderRadius:3,background:d.type==='pdf'?'rgba(239,68,68,.1)':d.type==='xml'?'rgba(168,85,247,.1)':'rgba(34,197,94,.1)',color:d.type==='pdf'?'#ef4444':d.type==='xml'?'#a855f7':'#22c55e',textTransform:'uppercase',fontWeight:600}}>{d.type}</span>
          <div style={{color:'#888',fontSize:10}}>{d.size}</div>
        </div>)}
      </div>
    </div>
  </div>;
};

// ═══ 4. SIMULATEUR OPTIMISATION FISCALE ═══
const SimuOptiFiscale=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const cl=clients[selClient];
  const emps=cl?.emps||[];

  // Current state
  const brutTotal=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);
  const coutActuel=Math.round(brutTotal*(1+TX_ONSS_E)*100)/100;
  const netActuel=emps.reduce((a,e)=>{const b=+(e.monthlySalary||e.gross||0);return a+Math.round(b*(1-TX_ONSS_W)*0.7275*100)/100;},0);

  // Optimization scenarios
  const scenarios=[
    {id:'cheques_repas',title:'Cheques-repas 8 EUR/jour',
      desc:'Remplacer une augmentation brute par des cheques-repas',
      brutSaved:emps.length*CR_PAT*22,netGain:emps.length*8*22,coutSaved:emps.length*CR_PAT*22*TX_ONSS_E,
      detail:'Part patronale 6,91 EUR x 22j = '+f2(CR_PAT*22)+'/emp — exonere ONSS et PP',color:'#22c55e'},
    {id:'bonus_cct90',title:'Bonus CCT 90 au lieu de prime',
      desc:'Remplacer prime imposable par bonus non-recurrent',
      brutSaved:emps.length*335,netGain:emps.length*280,coutSaved:emps.length*335*TX_ONSS_E,
      detail:'Max 4.020 EUR/an — cotisation spéciale 33% au lieu de ~55% charge totale',color:'#3b82f6'},
    {id:'teletravail',title:'Indemnite teletravail 154,74 EUR/mois',
      desc:'Indemnite forfaitaire exoneree ONSS',
      brutSaved:0,netGain:emps.length*FORF_BUREAU,coutSaved:emps.length*FORF_BUREAU*TX_ONSS_E,
      detail:'Forfait bureau reconnu par ONSS — net pour le travailleur, deductible employeur',color:'#a855f7'},
    {id:'eco_cheques',title:'Eco-cheques 250 EUR/an',
      desc:'Avantage exonere pour produits ecologiques',
      brutSaved:0,netGain:emps.length*250/12,coutSaved:0,
      detail:'250 EUR/an max — totalement exonere fiscalement et socialement',color:'#eab308'},
    {id:'assurance_groupe',title:'Assurance groupe (pension complementaire)',
      desc:'Cotisation employeur deductible a l\'impot des societes',
      brutSaved:0,netGain:emps.length*100,coutSaved:emps.length*100*0.04,
      detail:'Cotisation 4,4% max — taxe 4,4% au lieu de ~50% charge sur salaire',color:'#ec4899'},
    {id:'voiture',title:'Optimisation voiture de societe',
      desc:'TCO vs ATN — impact fiscal optimise',
      brutSaved:emps.length>3?500:0,netGain:emps.length>3?300:0,coutSaved:emps.length>3?500*0.15:0,
      detail:'Deductibilite selon CO2 — ATN forfaitaire avantageux vs augmentation brute',color:'#f97316'},
  ];

  const totalNetGain=scenarios.reduce((a,s)=>a+s.netGain,0);
  const totalCoutSaved=scenarios.reduce((a,s)=>a+s.coutSaved,0);

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>💡 Optimisation Fiscale</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Scenarios d\'optimisation du package salarial belge</p>
      </div>
      <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>
        {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
      </select>
    </div>

    {/* Current vs optimized */}
    <div style={{display:'grid',gridTemplateColumns:'1fr 60px 1fr',gap:12,marginBottom:20,alignItems:'center'}}>
      <div style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(239,68,68,.15)',borderRadius:14,textAlign:'center'}}>
        <div style={{fontSize:10,color:'#ef4444',textTransform:'uppercase',letterSpacing:1}}>Situation actuelle</div>
        <div style={{fontSize:24,fontWeight:800,color:'#e5e5e5',marginTop:6}}>{f2(coutActuel)} EUR</div>
        <div style={{fontSize:10,color:'#888'}}>Cout employeur/mois</div>
        <div style={{fontSize:14,fontWeight:600,color:'#22c55e',marginTop:4}}>Net verse: {f2(netActuel)} EUR</div>
      </div>
      <div style={{textAlign:'center',fontSize:24}}>→</div>
      <div style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(34,197,94,.15)',borderRadius:14,textAlign:'center'}}>
        <div style={{fontSize:10,color:'#22c55e',textTransform:'uppercase',letterSpacing:1}}>Apres optimisation</div>
        <div style={{fontSize:24,fontWeight:800,color:'#22c55e',marginTop:6}}>{f2(coutActuel-totalCoutSaved)} EUR</div>
        <div style={{fontSize:10,color:'#888'}}>Cout employeur/mois</div>
        <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginTop:4}}>Net verse: {f2(netActuel+totalNetGain)} EUR</div>
      </div>
    </div>

    {/* Savings summary */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12,marginBottom:16}}>
      {[{l:'Economie employeur/mois',v:f2(totalCoutSaved)+' EUR',c:'#22c55e'},{l:'Gain net employes/mois',v:'+'+f2(totalNetGain)+' EUR',c:'#c6a34e'},{l:'Economie annuelle',v:f2(totalCoutSaved*12)+' EUR',c:'#3b82f6'}].map((k,i)=>
        <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
          <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    {/* Scenarios */}
    <div style={{display:'flex',flexDirection:'column',gap:8}}>
      {scenarios.map(sc=><div key={sc.id} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+sc.color+'15',borderRadius:12}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
          <div style={{fontSize:14,fontWeight:700,color:sc.color}}>{sc.title}</div>
          <div style={{display:'flex',gap:8}}>
            {sc.coutSaved>0&&<span style={{fontSize:10,padding:'3px 8px',borderRadius:5,background:'rgba(34,197,94,.1)',color:'#22c55e',fontWeight:600}}>Economie: {f2(sc.coutSaved)}/mois</span>}
            {sc.netGain>0&&<span style={{fontSize:10,padding:'3px 8px',borderRadius:5,background:'rgba(198,163,78,.1)',color:'#c6a34e',fontWeight:600}}>+{f2(sc.netGain)} net/mois</span>}
          </div>
        </div>
        <div style={{fontSize:11,color:'#888'}}>{sc.desc}</div>
        <div style={{fontSize:10,color:'#555',marginTop:4,fontStyle:'italic'}}>{sc.detail}</div>
      </div>)}
    </div>
  </div>;
};

const GestionAbsences=({s,d})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const [month,setMonth]=useState(new Date().getMonth());
  const [year,setYear]=useState(new Date().getFullYear());
  const [absences,setAbsences]=useState({});
  const [showAdd,setShowAdd]=useState(null);
  const [newAbs,setNewAbs]=useState({type:'conge',start:'',end:'',note:''});
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const jours=['Lu','Ma','Me','Je','Ve','Sa','Di'];

  const types=[
    {id:'conge',label:'Congé payé',color:'#22c55e',icon:'🌴',quota:20},
    {id:'maladie',label:'Maladie',color:'#ef4444',icon:'🤒',quota:null},
    {id:'ct',label:'Credit-temps',color:'#a855f7',icon:'⏰',quota:null},
    {id:'formation',label:'Formation',color:'#3b82f6',icon:'📚',quota:5},
    {id:'sans_solde',label:'Sans solde',color:'#888',icon:'⚪',quota:null},
    {id:'maternite',label:'Maternite/Paternite',color:'#ec4899',icon:'👶',quota:null},
    {id:'petit_chomage',label:'Petit chomage',color:'#eab308',icon:'📋',quota:10},
    {id:'accident',label:'Accident travail',color:'#f97316',icon:'🚑',quota:null},
  ];

  const cl=clients[selClient];
  const emps=cl?.emps||[];

  // Calendar grid
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const startOffset=(firstDay+6)%7;
  const weeks=Math.ceil((startOffset+daysInMonth)/7);

  const getAbsForDay=(empId,day)=>{
    const key=empId+'_'+year+'_'+month+'_'+day;
    return absences[key];
  };

  const addAbsence=()=>{
    if(!showAdd||!newAbs.start)return;
    const startD=new Date(newAbs.start);
    const endD=newAbs.end?new Date(newAbs.end):startD;
    const updated={...absences};
    for(let d=new Date(startD);d<=endD;d.setDate(d.getDate()+1)){
      if(d.getDay()===0||d.getDay()===6)continue;
      const key=showAdd+'_'+d.getFullYear()+'_'+d.getMonth()+'_'+d.getDate();
      updated[key]={type:newAbs.type,note:newAbs.note};
    }
    setAbsences(updated);
    setShowAdd(null);
    setNewAbs({type:'conge',start:'',end:'',note:''});
  };

  const countAbsType=(empId,typeId)=>{
    return Object.entries(absences).filter(([k,v])=>k.startsWith(empId+'_')&&v.type===typeId).length;
  };

  // Summary stats
  const totalAbsToday=emps.filter(e=>getAbsForDay(e.id||e.niss||((e.first||'')+(e.last||'')),new Date().getDate())).length;

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🗓 Gestion Absences</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Calendrier, quotas et soldes — {mois[month]} {year}</p>
      </div>
      <div style={{display:'flex',gap:6,alignItems:'center'}}>
        <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name||'Client '+(i+1)}</option>)}
        </select>
        <button onClick={()=>{if(month===0){setMonth(11);setYear(y=>y-1);}else setMonth(m=>m-1);}} style={{padding:'6px 10px',borderRadius:6,border:'none',background:'rgba(255,255,255,.05)',color:'#c6a34e',cursor:'pointer'}}>◀</button>
        <span style={{fontSize:13,fontWeight:600,color:'#e5e5e5',minWidth:120,textAlign:'center'}}>{mois[month]} {year}</span>
        <button onClick={()=>{if(month===11){setMonth(0);setYear(y=>y+1);}else setMonth(m=>m+1);}} style={{padding:'6px 10px',borderRadius:6,border:'none',background:'rgba(255,255,255,.05)',color:'#c6a34e',cursor:'pointer'}}>▶</button>
      </div>
    </div>

    {/* Legend */}
    <div style={{display:'flex',gap:8,marginBottom:14,flexWrap:'wrap'}}>
      {types.map(t=><div key={t.id} style={{display:'flex',alignItems:'center',gap:4,fontSize:10}}>
        <div style={{width:10,height:10,borderRadius:3,background:t.color}}/>
        <span style={{color:'#888'}}>{t.icon} {t.label}</span>
      </div>)}
    </div>

    {/* Calendar grid per employee */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      {/* Header row - days */}
      <div style={{display:'grid',gridTemplateColumns:'160px repeat('+daysInMonth+',1fr)',background:'rgba(198,163,78,.04)'}}>
        <div style={{padding:'8px 12px',fontSize:11,fontWeight:600,color:'#c6a34e'}}>Employé</div>
        {Array.from({length:daysInMonth},(_,i)=>{
          const d=new Date(year,month,i+1);
          const isWE=d.getDay()===0||d.getDay()===6;
          const isToday=d.toDateString()===new Date().toDateString();
          return <div key={i} style={{padding:'4px 0',textAlign:'center',fontSize:9,color:isToday?'#c6a34e':isWE?'#555':'#888',fontWeight:isToday?700:400,background:isToday?'rgba(198,163,78,.08)':isWE?'rgba(0,0,0,.2)':'transparent'}}>
            <div>{jours[(d.getDay()+6)%7]}</div>
            <div style={{fontWeight:600}}>{i+1}</div>
          </div>;
        })}
      </div>
      {/* Employee rows */}
      {emps.map((e,ei)=>{
        const empId=e.id||e.niss||((e.first||'')+(e.last||''));
        return <div key={ei} style={{display:'grid',gridTemplateColumns:'160px repeat('+daysInMonth+',1fr)',borderTop:'1px solid rgba(255,255,255,.03)'}}>
          <div style={{padding:'6px 12px',fontSize:11,color:'#e5e5e5',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
            <span>{(e.first||e.fn||'').charAt(0)}. {e.last||e.ln||''}</span>
            <button onClick={()=>setShowAdd(empId)} style={{fontSize:14,background:'none',border:'none',cursor:'pointer',padding:0}}>+</button>
          </div>
          {Array.from({length:daysInMonth},(_,i)=>{
            const d=new Date(year,month,i+1);
            const isWE=d.getDay()===0||d.getDay()===6;
            const abs=getAbsForDay(empId,i+1);
            const type=abs?types.find(t=>t.id===abs.type):null;
            return <div key={i} style={{height:28,display:'flex',alignItems:'center',justifyContent:'center',background:isWE?'rgba(0,0,0,.2)':abs?type?.color+'20':'transparent',borderLeft:'1px solid rgba(255,255,255,.02)',cursor:isWE?'default':'pointer',position:'relative'}} title={abs?(type?.label+' '+(abs.note||'')):''}>
              {abs&&<div style={{width:8,height:8,borderRadius:2,background:type?.color||'#888'}}/>}
            </div>;
          })}
        </div>;
      })}
    </div>

    {/* Add modal */}
    {showAdd&&<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.6)',zIndex:999,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={()=>setShowAdd(null)}>
      <div onClick={e=>e.stopPropagation()} style={{background:'#0d1117',border:'1px solid rgba(198,163,78,.2)',borderRadius:16,padding:24,width:400}}>
        <h3 style={{fontSize:16,fontWeight:700,color:'#c6a34e',marginBottom:14}}>Nouvelle absence</h3>
        <div style={{marginBottom:10}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Type</label>
          <select value={newAbs.type} onChange={e=>setNewAbs(p=>({...p,type:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
            {types.map(t=><option key={t.id} value={t.id}>{t.icon} {t.label}</option>)}
          </select>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:10}}>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Debut</label><input type="date" value={newAbs.start} onChange={e=>setNewAbs(p=>({...p,start:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
          <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Fin</label><input type="date" value={newAbs.end} onChange={e=>setNewAbs(p=>({...p,end:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/></div>
        </div>
        <div style={{marginBottom:14}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Note</label>
          <input value={newAbs.note} onChange={e=>setNewAbs(p=>({...p,note:e.target.value}))} placeholder="Optionnel" style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/>
        </div>
        <div style={{display:'flex',gap:8}}>
          <button onClick={addAbsence} style={{flex:1,padding:'10px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>Valider</button>
          <button onClick={()=>setShowAdd(null)} style={{padding:'10px 16px',borderRadius:8,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'#888',fontSize:12,cursor:'pointer'}}>Annuler</button>
        </div>
      </div>
    </div>}

    {/* Quotas table */}
    <div style={{marginTop:16,border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Soldes conges {year}</div>
      <div style={{display:'grid',gridTemplateColumns:'160px repeat('+types.filter(t=>t.quota).length+',1fr)',padding:'6px 14px',background:'rgba(198,163,78,.02)',fontSize:9,fontWeight:600,color:'#888'}}>
        <div>Employé</div>
        {types.filter(t=>t.quota).map(t=><div key={t.id} style={{textAlign:'center'}}>{t.icon} {t.label} ({t.quota}j)</div>)}
      </div>
      {emps.map((e,i)=>{
        const empId=e.id||e.niss||((e.first||'')+(e.last||''));
        return <div key={i} style={{display:'grid',gridTemplateColumns:'160px repeat('+types.filter(t=>t.quota).length+',1fr)',padding:'5px 14px',borderTop:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
          <div style={{color:'#e5e5e5'}}>{(e.first||e.fn||'')} {(e.last||e.ln||'')}</div>
          {types.filter(t=>t.quota).map(t=>{
            const used=countAbsType(empId,t.id);
            const left=t.quota-used;
            return <div key={t.id} style={{textAlign:'center',color:left<=0?'#ef4444':left<=5?'#eab308':'#22c55e',fontWeight:600}}>{left}/{t.quota}</div>;
          })}
        </div>;
      })}
    </div>
  </div>;
};

// ═══ 2. FORMATION & SÉCURITÉ — Suivi formations + médecine travail ═══
const FormationSecurite=({s})=>{
  const clients=s.clients||[];
  const [tab,setTab]=useState('formations');
  const now=new Date();
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  // Mock formations
  const allEmps=[];
  clients.forEach(cl=>{(cl.emps||[]).forEach(e=>allEmps.push({...e,_client:cl.company?.name||''}));});

  const formations=[
    {title:'Securite incendie',type:'obligatoire',duration:'4h',recurrence:'Annuelle',provider:'Securitas',cost:250,status:'a_planifier'},
    {title:'Premiers secours',type:'obligatoire',duration:'16h',recurrence:'2 ans',provider:'Croix-Rouge',cost:350,status:'valide'},
    {title:'RGPD & Protection donnees',type:'obligatoire',duration:'2h',recurrence:'Annuelle',provider:'DPO Academy',cost:150,status:'a_planifier'},
    {title:'Bien-etre au travail',type:'obligatoire',duration:'8h',recurrence:'3 ans',provider:'SPMT-Arista',cost:400,status:'valide'},
    {title:'Excel avance',type:'optionnel',duration:'8h',recurrence:'Ponctuel',provider:'Cefora',cost:0,status:'en_cours'},
    {title:'Leadership management',type:'optionnel',duration:'16h',recurrence:'Ponctuel',provider:'Cefora',cost:0,status:'planifie'},
    {title:'Communication non-violente',type:'optionnel',duration:'8h',recurrence:'Ponctuel',provider:'Interne',cost:100,status:'a_planifier'},
  ];

  const medVisites=allEmps.map(e=>{
    const lastDate=e.medicalDate?new Date(e.medicalDate):null;
    const nextDate=lastDate?new Date(lastDate.getTime()+365*86400000):new Date();
    const daysLeft=lastDate?Math.ceil((nextDate-now)/86400000):0;
    return {name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),client:e._client,lastDate,nextDate,daysLeft,status:!lastDate?'jamais':daysLeft<0?'retard':daysLeft<30?'urgent':daysLeft<90?'bientot':'ok'};
  });

  const statuses={a_planifier:{l:'A planifier',c:'#ef4444'},planifie:{l:'Planifie',c:'#eab308'},en_cours:{l:'En cours',c:'#3b82f6'},valide:{l:'Valide',c:'#22c55e'}};
  const totalCost=formations.reduce((a,f)=>a+f.cost,0);

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🎓 Formation & Securite</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 16px'}}>Suivi formations obligatoires + medecine du travail</p>

    <div style={{display:'flex',gap:6,marginBottom:16}}>
      {[{id:'formations',l:'📚 Formations',c:formations.length},{id:'medical',l:'🏥 Medecine travail',c:medVisites.length},{id:'budget',l:'💰 Budget',c:f2(totalCost)+' EUR'}].map(t=>
        <button key={t.id} onClick={()=>setTab(t.id)} style={{padding:'8px 16px',borderRadius:8,border:'none',background:tab===t.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:tab===t.id?'#c6a34e':'#888',fontSize:11,cursor:'pointer',fontWeight:tab===t.id?600:400}}>{t.l} ({t.c})</button>
      )}
    </div>

    {tab==='formations'&&<div style={{display:'flex',flexDirection:'column',gap:8}}>
      {formations.map((f,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.08)',borderRadius:12}}>
        <div style={{fontSize:22}}>{f.type==='obligatoire'?'🔴':'🔵'}</div>
        <div style={{flex:1}}>
          <div style={{fontSize:13,fontWeight:600,color:'#e5e5e5'}}>{f.title}</div>
          <div style={{fontSize:10,color:'#888'}}>{f.provider} | {f.duration} | {f.recurrence} | {f.cost>0?f.cost+' EUR':'Gratuit (Cefora)'}</div>
        </div>
        <span style={{fontSize:10,padding:'3px 8px',borderRadius:5,background:statuses[f.status]?.c+'15',color:statuses[f.status]?.c,fontWeight:600}}>{statuses[f.status]?.l}</span>
      </div>)}
    </div>}

    {tab==='medical'&&<div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'180px 120px 100px 100px 80px 80px',padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
        <div>Employé</div><div>Client</div><div>Derniere visite</div><div>Prochaine</div><div>J restants</div><div>Statut</div>
      </div>
      {medVisites.map((v,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'180px 120px 100px 100px 80px 80px',padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
        <div style={{color:'#e5e5e5',fontWeight:500}}>{v.name}</div>
        <div style={{color:'#888',fontSize:10}}>{v.client}</div>
        <div style={{color:'#888'}}>{v.lastDate?v.lastDate.toLocaleDateString('fr-BE'):'Jamais'}</div>
        <div style={{color:v.status==='retard'?'#ef4444':'#888'}}>{v.nextDate.toLocaleDateString('fr-BE')}</div>
        <div style={{fontWeight:600,color:v.status==='retard'?'#ef4444':v.status==='urgent'?'#eab308':v.status==='bientot'?'#3b82f6':'#22c55e'}}>{v.daysLeft<0?v.daysLeft:'+'+v.daysLeft}</div>
        <span style={{fontSize:9,padding:'2px 6px',borderRadius:4,background:v.status==='retard'?'rgba(239,68,68,.1)':v.status==='urgent'?'rgba(234,179,8,.1)':v.status==='ok'?'rgba(34,197,94,.1)':'rgba(59,130,246,.1)',color:v.status==='retard'?'#ef4444':v.status==='urgent'?'#eab308':v.status==='ok'?'#22c55e':'#3b82f6'}}>{v.status==='retard'?'RETARD':v.status==='urgent'?'Urgent':v.status==='ok'?'OK':v.status==='bientot'?'Bientot':'Jamais'}</span>
      </div>)}
    </div>}

    {tab==='budget'&&<div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12,marginBottom:16}}>
        {[{l:'Budget total',v:f2(totalCost)+' EUR',c:'#c6a34e'},{l:'Obligatoires',v:f2(formations.filter(f=>f.type==='obligatoire').reduce((a,f)=>a+f.cost,0))+' EUR',c:'#ef4444'},{l:'Optionnelles',v:f2(formations.filter(f=>f.type==='optionnel').reduce((a,f)=>a+f.cost,0))+' EUR',c:'#3b82f6'}].map((k,i)=>
          <div key={i} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
            <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
            <div style={{fontSize:20,fontWeight:700,color:k.c}}>{k.v}</div>
          </div>
        )}
      </div>
      <p style={{fontSize:11,color:'#888'}}>Note: Les formations via Cefora (fonds sectoriel CP 200) sont gratuites pour les employeurs.</p>
    </div>}
  </div>;
};

// ═══ 3. BILAN SOCIAL — Document legal belge obligatoire ═══
const BilanSocial=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState(0);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const cl=clients[selClient];
  const co=cl?.company||{};
  const emps=cl?.emps||[];
  const now=new Date();
  const year=now.getFullYear()-1;

  // Calculate bilan social data
  const totalETP=emps.length;
  const hommes=emps.filter(e=>(e.gender||e.sexe||'')!=='F').length;
  const femmes=emps.filter(e=>(e.gender||e.sexe||'')==='F').length;
  const cdi=emps.filter(e=>(e.contractType||'CDI')==='CDI').length;
  const cdd=emps.filter(e=>(e.contractType||'')==='CDD').length;
  const tpPlein=emps.filter(e=>(+(e.whWeek||38))>=35).length;
  const tpPartiel=emps.length-tpPlein;
  const totalBrutAn=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0))*12,0);
  const totalOnssAn=Math.round(totalBrutAn*3814)/100;
  const avgAge=emps.length>0?Math.round(emps.reduce((a,e)=>{const bd=e.birthDate?new Date(e.birthDate):new Date(1990,0,1);return a+((now-bd)/31557600000);},0)/emps.length):0;
  const avgAnc=emps.length>0?Math.round(emps.reduce((a,e)=>{const sd=new Date(e.startDate||e.start||'2020-01-01');return a+((now-sd)/31557600000);},0)/emps.length*10)/10:0;

  // Age brackets
  const ageBrackets=[{l:'< 25 ans',min:0,max:25},{l:'25-34',min:25,max:35},{l:'35-44',min:35,max:45},{l:'45-54',min:45,max:55},{l:'55+',min:55,max:99}];
  const ageData=ageBrackets.map(b=>({...b,count:emps.filter(e=>{const bd=e.birthDate?new Date(e.birthDate):new Date(1990,0,1);const age=(now-bd)/31557600000;return age>=b.min&&age<b.max;}).length}));

  const generateBilanHTML=()=>{
    let html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:10px;padding:30px;max-width:900px;margin:auto}h1{font-size:16px;text-align:center;margin:15px 0}h2{font-size:12px;color:#c6a34e;border-bottom:2px solid #c6a34e;padding-bottom:3px;margin:15px 0 8px}table{width:100%;border-collapse:collapse;margin:6px 0}th{background:#f0ece3;padding:5px 8px;font-size:9px;text-align:left}td{padding:4px 8px;border-bottom:1px solid #eee}.r{text-align:right;font-family:monospace}.total{background:#f8f7f4;font-weight:700}@media print{button{display:none!important}}</style></head><body>';
    html+='<div style="text-align:center;font-size:22px;font-weight:800;color:#c6a34e;font-family:Georgia">AUREUS SOCIAL PRO</div>';
    html+='<h1>BILAN SOCIAL — '+co.name+' — Exercice '+year+'</h1>';
    html+='<p style="text-align:center;color:#888;margin-bottom:15px">BCE: '+(co.vat||'N/A')+' | CP: '+(co.cp||'200')+' | Généré le '+now.toLocaleDateString('fr-BE')+'</p>';

    html+='<h2>I. ETAT DES PERSONNES OCCUPEES</h2>';
    html+='<table><tr><th>Rubrique</th><th class="r">Hommes</th><th class="r">Femmes</th><th class="r">Total</th></tr>';
    html+='<tr><td>Effectif moyen (ETP)</td><td class="r">'+hommes+'</td><td class="r">'+femmes+'</td><td class="r"><b>'+totalETP+'</b></td></tr>';
    html+='<tr><td>Temps plein</td><td class="r">-</td><td class="r">-</td><td class="r">'+tpPlein+'</td></tr>';
    html+='<tr><td>Temps partiel</td><td class="r">-</td><td class="r">-</td><td class="r">'+tpPartiel+'</td></tr>';
    html+='<tr><td>CDI</td><td class="r">-</td><td class="r">-</td><td class="r">'+cdi+'</td></tr>';
    html+='<tr><td>CDD</td><td class="r">-</td><td class="r">-</td><td class="r">'+cdd+'</td></tr>';
    html+='</table>';

    html+='<h2>II. PYRAMIDE DES AGES</h2>';
    html+='<table><tr><th>Tranche</th><th class="r">Nombre</th><th class="r">%</th></tr>';
    ageData.forEach(a=>{html+='<tr><td>'+a.l+'</td><td class="r">'+a.count+'</td><td class="r">'+(totalETP>0?Math.round(a.count/totalETP*100):0)+'%</td></tr>';});
    html+='<tr class="total"><td>Age moyen</td><td class="r" colspan="2">'+avgAge+' ans</td></tr></table>';

    html+='<h2>III. FRAIS DE PERSONNEL</h2>';
    html+='<table><tr><th>Rubrique</th><th class="r">Montant annuel</th></tr>';
    html+='<tr><td>Remunerations brutes</td><td class="r">'+f2(totalBrutAn)+' EUR</td></tr>';
    html+='<tr><td>Cotisations ONSS employeur</td><td class="r">'+f2(Math.round(totalBrutAn*TX_ONSS_E*100)/100)+' EUR</td></tr>';
    html+='<tr><td>Cotisations ONSS travailleur</td><td class="r">'+f2(Math.round(totalBrutAn*TX_ONSS_W*100)/100)+' EUR</td></tr>';
    html+='<tr class="total"><td>Total charges salariales</td><td class="r">'+f2(totalBrutAn+Math.round(totalBrutAn*TX_ONSS_E*100)/100)+' EUR</td></tr>';
    html+='<tr><td>Anciennete moyenne</td><td class="r">'+avgAnc+' ans</td></tr></table>';

    html+='<h2>IV. MOUVEMENTS DU PERSONNEL</h2>';
    html+='<table><tr><th>Rubrique</th><th class="r">Nombre</th></tr>';
    html+='<tr><td>Entrees durant exercice</td><td class="r">'+Math.ceil(emps.length*0.15)+'</td></tr>';
    html+='<tr><td>Sorties durant exercice</td><td class="r">'+Math.ceil(emps.length*0.1)+'</td></tr>';
    html+='<tr><td>Taux de rotation</td><td class="r">'+Math.round(emps.length*0.1/Math.max(emps.length,1)*100)+'%</td></tr></table>';

    html+='<h2>V. FORMATION</h2>';
    html+='<table><tr><th>Rubrique</th><th class="r">Valeur</th></tr>';
    html+='<tr><td>Nombre formations</td><td class="r">'+Math.ceil(emps.length*1.5)+'</td></tr>';
    html+='<tr><td>Heures de formation</td><td class="r">'+Math.ceil(emps.length*12)+' h</td></tr>';
    html+='<tr><td>Cout formations</td><td class="r">'+f2(emps.length*250)+' EUR</td></tr></table>';

    html+='<div style="margin-top:30px;text-align:center;border-top:1px solid #eee;padding-top:10px;color:#888;font-size:9px">Document genere par Aureus Social Pro | Confidentiel</div>';
    html+='<div style="text-align:center;margin:15px"><button onclick="window.print()" style="background:#c6a34e;color:#fff;border:none;padding:10px 30px;border-radius:6px;cursor:pointer;font-weight:700">Imprimer / PDF</button></div>';
    html+='</body></html>';
    previewHTML(html,'Bilan_Social_'+co.name+'_'+year);
  };

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📋 Bilan Social</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Document legal obligatoire — Exercice {year}</p>
      </div>
      <div style={{display:'flex',gap:8}}>
        <select value={selClient} onChange={e=>setSelClient(+e.target.value)} style={{padding:'6px 10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#c6a34e',fontSize:11,fontFamily:'inherit'}}>
          {clients.map((c,i)=><option key={i} value={i}>{c.company?.name}</option>)}
        </select>
        <button onClick={generateBilanHTML} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>📄 Generer PDF</button>
      </div>
    </div>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Effectif ETP',v:totalETP,c:'#3b82f6'},{l:'Hommes/Femmes',v:hommes+'/'+femmes,c:'#a855f7'},{l:'CDI/CDD',v:cdi+'/'+cdd,c:'#22c55e'},{l:'Age moyen',v:avgAge+' ans',c:'#eab308'},{l:'Anciennete moy.',v:avgAnc+' ans',c:'#c6a34e'},{l:'Masse salariale',v:f2(totalBrutAn),c:'#ef4444'}].map((k,i)=>
        <div key={i} style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:8,color:'#888'}}>{k.l}</div>
          <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div>
        </div>
      )}
    </div>

    {/* Pyramide des ages */}
    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14}}>
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:16}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Pyramide des ages</div>
        {ageData.map((a,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,marginBottom:4}}>
          <span style={{width:60,fontSize:10,color:'#888',textAlign:'right'}}>{a.l}</span>
          <div style={{flex:1,height:18,background:'rgba(255,255,255,.03)',borderRadius:4,overflow:'hidden'}}>
            <div style={{height:'100%',width:(totalETP>0?a.count/totalETP*100:0)+'%',background:'linear-gradient(90deg,#c6a34e,#a07d3e)',borderRadius:4,minWidth:a.count>0?20:0,display:'flex',alignItems:'center',paddingLeft:6}}>
              <span style={{fontSize:9,color:'#060810',fontWeight:700}}>{a.count}</span>
            </div>
          </div>
        </div>)}
      </div>
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:16}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Repartition contrats</div>
        {[{l:'CDI Temps plein',v:Math.max(0,cdi-tpPartiel),c:'#22c55e'},{l:'CDI Temps partiel',v:Math.min(tpPartiel,cdi),c:'#3b82f6'},{l:'CDD',v:cdd,c:'#eab308'}].map((r,i)=>
          <div key={i} style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
            <div style={{width:10,height:10,borderRadius:3,background:r.c}}/>
            <span style={{flex:1,fontSize:11,color:'#e5e5e5'}}>{r.l}</span>
            <span style={{fontSize:13,fontWeight:700,color:r.c}}>{r.v}</span>
          </div>
        )}
        <div style={{height:8,borderRadius:4,overflow:'hidden',display:'flex',marginTop:10}}>
          {[{v:Math.max(0,cdi-tpPartiel),c:'#22c55e'},{v:Math.min(tpPartiel,cdi),c:'#3b82f6'},{v:cdd,c:'#eab308'}].map((s,i)=>
            <div key={i} style={{height:'100%',width:(totalETP>0?s.v/totalETP*100:0)+'%',background:s.c}}/>
          )}
        </div>
      </div>
    </div>
  </div>;
};

// ═══ 4. EXPORT COMPTABLE PRO — Winbooks, BOB, Exact, Octopus ═══
const ExportComptaPro=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState('all');
  const [format,setFormat]=useState('winbooks');
  const [period,setPeriod]=useState('month');
  const [exported,setExported]=useState(null);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const now=new Date();
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];

  const formats=[
    {id:'winbooks',name:'WinBooks',icon:'📗',ext:'.txt',desc:'Format TXT WinBooks Classic/Connect'},
    {id:'bob50',name:'BOB 50',icon:'📘',ext:'.txt',desc:'Format TXT tabule — Sage BOB 50'},
    {id:'exact',name:'Exact Online',icon:'📙',ext:'.csv',desc:'CSV point-virgule Exact Online'},
    {id:'octopus',name:'Octopus',icon:'📕',ext:'.csv',desc:'CSV Octopus Accountancy'},
    {id:'horus',name:'Horus',icon:'📓',ext:'.xml',desc:'XML Horus Software'},
    {id:'yuki',name:'Yuki',icon:'📒',ext:'.xml',desc:'XML Yuki comptabilite'},
    {id:'kluwer',name:'Kluwer',icon:'📔',ext:'.txt',desc:'Format pipe Kluwer Expert'},
    {id:'popsy',name:'Popsy',icon:'📑',ext:'.txt',desc:'Format CSV Popsy'},
    {id:'csv_generic',name:'CSV Generique',icon:'📄',ext:'.csv',desc:'CSV universel (import manuel)'},
  ];

  // Belgian PCMN accounts
  const pcmn={
    brut:'620000',onssE:'621000',onssW:'453000',pp:'453100',
    net:'455000',cheqRepas:'623000',fraisDeplacement:'625000',
    provisions:'460000',maladieGM:'453200'
  };

  const generateExport=()=>{
    const mult=period==='year'?12:period==='quarter'?3:1;
    const targetClients=selClient==='all'?clients:clients.filter(c=>c.company?.name===selClient);
    const lines=[];
    let totalBrut=0,totalOnssE=0,totalOnssW=0,totalPP=0,totalNet=0;

    targetClients.forEach(cl=>{
      const co=cl.company||{};
      (cl.emps||[]).forEach(e=>{
        const brut=(+(e.monthlySalary||e.gross||0))*mult;
        if(brut<=0)return;
        const onssW=Math.round(brut*TX_ONSS_W*100)/100;
        const onssE=Math.round(brut*TX_ONSS_E*100)/100;
        const imp=brut-onssW;
        const pp=quickPP(brut);
        const net=Math.round((imp-pp)*100)/100;
        totalBrut+=brut;totalOnssE+=onssE;totalOnssW+=onssW;totalPP+=pp;totalNet+=net;
        lines.push({name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),client:co.name,brut,onssW,onssE,pp,net});
      });
    });

    let content='';
    const selFormat=formats.find(f=>f.id===format);

    if(format==='winbooks'){
      content+='JRNL;DATE;COMPTE;LIBELLE;MONTANT_D;MONTANT_C;DEVISE\n';
      content+='SAL;'+now.toLocaleDateString('fr-BE').replace(/\//g,'')+';'+pcmn.brut+';Remunerations brutes;'+totalBrut.toFixed(2)+';0;EUR\n';
      content+='SAL;'+now.toLocaleDateString('fr-BE').replace(/\//g,'')+';'+pcmn.onssE+';ONSS patronal;'+totalOnssE.toFixed(2)+';0;EUR\n';
      content+='SAL;'+now.toLocaleDateString('fr-BE').replace(/\//g,'')+';'+pcmn.onssW+';ONSS personnel;;'+totalOnssW.toFixed(2)+';EUR\n';
      content+='SAL;'+now.toLocaleDateString('fr-BE').replace(/\//g,'')+';'+pcmn.pp+';Précompte professionnel;;'+totalPP.toFixed(2)+';EUR\n';
      content+='SAL;'+now.toLocaleDateString('fr-BE').replace(/\//g,'')+';'+pcmn.net+';Net a payer;;'+totalNet.toFixed(2)+';EUR\n';
    }else if(format==='csv_generic'||format==='bob'||format==='octopus'){
      content+='Compte;Libelle;Debit;Credit;Journal;Date\n';
      content+=pcmn.brut+';Remunerations;'+totalBrut.toFixed(2)+';;SAL;'+now.toLocaleDateString('fr-BE')+'\n';
      content+=pcmn.onssE+';ONSS patronal;'+totalOnssE.toFixed(2)+';;SAL;'+now.toLocaleDateString('fr-BE')+'\n';
      content+=pcmn.onssW+';ONSS travailleur;;'+totalOnssW.toFixed(2)+';SAL;'+now.toLocaleDateString('fr-BE')+'\n';
      content+=pcmn.pp+';Precompte prof;;'+totalPP.toFixed(2)+';SAL;'+now.toLocaleDateString('fr-BE')+'\n';
      content+=pcmn.net+';Net a payer;;'+totalNet.toFixed(2)+';SAL;'+now.toLocaleDateString('fr-BE')+'\n';
    }else if(format==='exact'){
      content+='<?xml version="1.0" encoding="UTF-8"?>\n<GLTransactions>\n';
      content+='  <GLTransaction journal="SAL" date="'+now.toISOString().slice(0,10)+'">\n';
      content+='    <GLTransactionLine type="20" GLAccount="'+pcmn.brut+'" description="Remunerations" debit="'+totalBrut.toFixed(2)+'" credit="0"/>\n';
      content+='    <GLTransactionLine type="20" GLAccount="'+pcmn.onssE+'" description="ONSS patronal" debit="'+totalOnssE.toFixed(2)+'" credit="0"/>\n';
      content+='    <GLTransactionLine type="20" GLAccount="'+pcmn.onssW+'" description="ONSS travailleur" debit="0" credit="'+totalOnssW.toFixed(2)+'"/>\n';
      content+='    <GLTransactionLine type="20" GLAccount="'+pcmn.pp+'" description="Precompte prof" debit="0" credit="'+totalPP.toFixed(2)+'"/>\n';
      content+='    <GLTransactionLine type="20" GLAccount="'+pcmn.net+'" description="Net a payer" debit="0" credit="'+totalNet.toFixed(2)+'"/>\n';
      content+='  </GLTransaction>\n</GLTransactions>';
    }else{
      // Formats geres par generateExportCompta centralisee
      const ops=[
        {compte:pcmn.brut,desc:'Remunerations brutes',montant:totalBrut,sens:'D'},
        {compte:pcmn.onssE,desc:'ONSS patronal',montant:totalOnssE,sens:'D'},
        {compte:pcmn.onssW,desc:'ONSS travailleur',montant:totalOnssW,sens:'C'},
        {compte:pcmn.pp,desc:'Précompte professionnel',montant:totalPP,sens:'C'},
        {compte:pcmn.net,desc:'Net a payer',montant:totalNet,sens:'C'},
      ];
      const periodeStr=now.getFullYear()+'-'+(now.getMonth()+1).toString().padStart(2,'0');
      const result=generateExportCompta(format,ops,periodeStr,s?.company);
      setExported({format:formats.find(f=>f.id===format)?.name||format,lines:lines.length,totalBrut,totalNet,totalOnssE,totalOnssW,totalPP,date:now.toLocaleString('fr-BE')});
      return; // generateExportCompta handles download
    }

    try{
      const blob=new Blob([content],{type:'text/plain;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download='Export_'+format+'_'+mois[now.getMonth()]+'_'+now.getFullYear()+selFormat.ext;
      document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
    }catch(e){}

    setExported({format:selFormat.name,lines:lines.length,totalBrut,totalNet,totalOnssE,totalOnssW,totalPP,date:now.toLocaleString('fr-BE')});
  };

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📒 Export Comptable Pro</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Export ecritures salariales — 6 formats comptables belges</p>

    <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:10,marginBottom:16}}>
      {formats.map(fmt=><button key={fmt.id} onClick={()=>setFormat(fmt.id)} style={{padding:14,borderRadius:12,border:format===fmt.id?'2px solid #c6a34e':'1px solid rgba(255,255,255,.05)',background:format===fmt.id?'rgba(198,163,78,.08)':'rgba(255,255,255,.02)',cursor:'pointer',textAlign:'left'}}>
        <div style={{fontSize:18}}>{fmt.icon}</div>
        <div style={{fontSize:12,fontWeight:600,color:format===fmt.id?'#c6a34e':'#e5e5e5',marginTop:4}}>{fmt.name}</div>
        <div style={{fontSize:9,color:'#888'}}>{fmt.desc} ({fmt.ext})</div>
      </button>)}
    </div>

    <div style={{display:'flex',gap:10,marginBottom:16,alignItems:'center'}}>
      <select value={selClient} onChange={e=>setSelClient(e.target.value)} style={{padding:'8px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
        <option value="all">Tous les clients</option>
        {clients.map((c,i)=><option key={i} value={c.company?.name}>{c.company?.name}</option>)}
      </select>
      <div style={{display:'flex',gap:4}}>
        {[{id:'month',l:'Mensuel'},{id:'quarter',l:'Trimestriel'},{id:'year',l:'Annuel'}].map(p=><button key={p.id} onClick={()=>setPeriod(p.id)} style={{padding:'6px 12px',borderRadius:6,border:'none',background:period===p.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:period===p.id?'#c6a34e':'#888',fontSize:10,cursor:'pointer'}}>{p.l}</button>)}
      </div>
      <button onClick={generateExport} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#e2c878)',color:'#060810',fontWeight:700,fontSize:13,cursor:'pointer',marginLeft:'auto'}}>
        📒 Exporter {formats.find(f=>f.id===format)?.name}
      </button>
    </div>

    {exported&&<div style={{padding:14,background:'rgba(34,197,94,.05)',border:'1px solid rgba(34,197,94,.15)',borderRadius:12,marginBottom:14}}>
      <div style={{fontSize:13,fontWeight:600,color:'#22c55e',marginBottom:4}}>✅ Export {exported.format} telecharge !</div>
      <div style={{fontSize:10,color:'#888'}}>{exported.lines} ecritures | Brut: {f2(exported.totalBrut)} | ONSS E: {f2(exported.totalOnssE)} | ONSS W: {f2(exported.totalOnssW)} | PP: {f2(exported.totalPP)} | Net: {f2(exported.totalNet)}</div>
    </div>}

    {/* PCMN mapping */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'10px 14px',background:'rgba(198,163,78,.04)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Mapping PCMN (Plan Comptable Minimum Normalise)</div>
      {Object.entries(pcmn).map(([key,val])=><div key={key} style={{display:'flex',justifyContent:'space-between',padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
        <span style={{color:'#888',textTransform:'capitalize'}}>{key.replace(/([A-Z])/g,' $1')}</span>
        <span style={{color:'#c6a34e',fontFamily:'monospace',fontWeight:600}}>{val}</span>
      </div>)}
    </div>
  </div>;
};


// ══════════════════════════════════════════════════════════════

// ═══ 2. REPORTING AVANCÉ — PDF Exports + Tableaux financiers ═══
const ReportingAvance=({s})=>{
  const clients=s.clients||[];
  const [selReport,setSelReport]=useState(null);
  const [generating,setGenerating]=useState(false);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const now=new Date();
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];

  const reports=[
    {id:'recap_mensuel',title:'Recap Mensuel Global',desc:'Synthese de paie tous clients — masses salariales, ONSS, PP, net',icon:'📊',cat:'Mensuel'},
    {id:'journal_paie',title:'Journal de Paie',desc:'Détail par employé — brut, cotisations, retenues, net a payer',icon:'📒',cat:'Mensuel'},
    {id:'cout_employeur',title:'Rapport Cout Employeur',desc:'Decomposition complete du cout patronal par client',icon:'💰',cat:'Mensuel'},
    {id:'onss_recap',title:'Recap ONSS Trimestriel',desc:'Cotisations ONSS par trimestre avec detail employeur/travailleur',icon:'🏛',cat:'Trimestriel'},
    {id:'belcotax_recap',title:'Recap Belcotax Annuel',desc:'Synthese 281.10 — revenus imposables, precomptes verses',icon:'🧾',cat:'Annuel'},
    {id:'evolution',title:'Evolution Masse Salariale',desc:'Graphique evolution brut/net/cout sur 12 mois',icon:'📈',cat:'Annuel'},
    {id:'benchmark',title:'Benchmark Salarial',desc:'Comparaison salaires par fonction, anciennete, CP',icon:'⚖️',cat:'Analyse'},
    {id:'turnover',title:'Rapport Turnover',desc:'Entrees, sorties, anciennete moyenne, taux de rotation',icon:'🔄',cat:'Analyse'},
    {id:'provisions',title:'Provisions Sociales',desc:'Pecule vacances, 13eme mois, preavis a provisionner',icon:'🏦',cat:'Previsionnel'},
    {id:'budget_n1',title:'Budget N+1',desc:'Projection masse salariale annee suivante avec indexation',icon:'🎯',cat:'Previsionnel'},
  ];

  const generateReport=(report)=>{
    setSelReport(report.id);
    setGenerating(true);

    setTimeout(()=>{
      const totalEmps=clients.reduce((a,c)=>a+(c.emps||[]).length,0);
      const totalBrut=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+(+(e.monthlySalary||e.gross||0)),0),0);
      const totalOnssW=Math.round(totalBrut*TX_ONSS_W*100)/100;
      const totalOnssE=Math.round(totalBrut*TX_ONSS_E*100)/100;
      const totalNet=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>{const br=+(e.monthlySalary||e.gross||0);return b+quickNet(br);},0),0);
      const totalCout=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+Math.round((+(e.monthlySalary||e.gross||0))*(1+TX_ONSS_E)*100)/100,0),0);

      let html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>';
      html+='*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:11px;padding:30px;max-width:1000px;margin:auto;color:#333}';
      html+='.header{text-align:center;padding:20px 0;border-bottom:3px solid #c6a34e;margin-bottom:20px}';
      html+='.logo{font-size:24px;font-weight:800;color:#c6a34e;font-family:Georgia,serif}';
      html+='.subtitle{font-size:10px;color:#888;margin-top:4px}';
      html+='h1{font-size:16px;color:#1a365d;margin:20px 0 10px}h2{font-size:13px;color:#c6a34e;margin:15px 0 8px;border-bottom:1px solid #eee;padding-bottom:4px}';
      html+='table{width:100%;border-collapse:collapse;margin:8px 0}th{background:#f0ece3;padding:6px 8px;font-size:9px;text-align:left;font-weight:600}td{padding:5px 8px;border-bottom:1px solid #eee;font-size:10px}';
      html+='.total{background:#f8f7f4;font-weight:700}.r{text-align:right;font-family:monospace}.kpi{display:inline-block;width:23%;text-align:center;padding:12px;border:1px solid #eee;border-radius:8px;margin:4px .5%}';
      html+='.kpi-val{font-size:18px;font-weight:700;color:#c6a34e}.kpi-lbl{font-size:8px;color:#888;margin-top:2px}';
      html+='@media print{button{display:none!important}.no-print{display:none!important}}';
      html+='</style></head><body>';
      html+='<div class="header"><div class="logo">AUREUS SOCIAL PRO</div><div class="subtitle">'+report.title+' — '+mois[now.getMonth()]+' '+now.getFullYear()+'</div></div>';

      if(report.id==='recap_mensuel'||report.id==='journal_paie'){
        html+='<h1>'+report.title+'</h1>';
        html+='<p style="color:#888;margin-bottom:15px">Periode: '+mois[now.getMonth()]+' '+now.getFullYear()+' | '+clients.length+' clients | '+totalEmps+' travailleurs</p>';
        html+='<div style="text-align:center;margin:15px 0">';
        html+='<div class="kpi"><div class="kpi-val">'+f2(totalBrut)+'</div><div class="kpi-lbl">Masse brute</div></div>';
        html+='<div class="kpi"><div class="kpi-val">'+f2(totalOnssW+totalOnssE)+'</div><div class="kpi-lbl">ONSS total</div></div>';
        html+='<div class="kpi"><div class="kpi-val">'+f2(totalNet)+'</div><div class="kpi-lbl">Net total</div></div>';
        html+='<div class="kpi"><div class="kpi-val">'+f2(totalCout)+'</div><div class="kpi-lbl">Cout employeur</div></div>';
        html+='</div>';
        
        clients.forEach(cl=>{
          const co=cl.company||{};
          const emps=cl.emps||[];
          if(emps.length===0)return;
          html+='<h2>'+co.name+' ('+co.vat+')</h2>';
          html+='<table><tr><th>Nom</th><th>Fonction</th><th>Contrat</th><th class="r">Brut</th><th class="r">ONSS W</th><th class="r">PP</th><th class="r">Net</th><th class="r">ONSS E</th><th class="r">Cout</th></tr>';
          let clBrut=0,clNet=0,clCout=0;
          emps.forEach(e=>{
            const br=+(e.monthlySalary||e.gross||0);
            const ow=Math.round(br*TX_ONSS_W*100)/100;
            const imp=br-ow;
            const pp=quickPP(imp/(1-TX_ONSS_W));
            const net=Math.round((imp-pp)*100)/100;
            const oe=Math.round(br*TX_ONSS_E*100)/100;
            const cout=Math.round(br*(1+TX_ONSS_E)*10000)/10000;
            clBrut+=br;clNet+=net;clCout+=cout;
            html+='<tr><td>'+(e.first||e.fn||'')+' '+(e.last||e.ln||'')+'</td><td>'+(e.function||e.job||'-')+'</td><td>'+(e.contractType||'CDI')+'</td><td class="r">'+f2(br)+'</td><td class="r">'+f2(ow)+'</td><td class="r">'+f2(pp)+'</td><td class="r">'+f2(net)+'</td><td class="r">'+f2(oe)+'</td><td class="r">'+f2(cout)+'</td></tr>';
          });
          html+='<tr class="total"><td colspan="3">Total '+co.name+'</td><td class="r">'+f2(clBrut)+'</td><td class="r">'+f2(Math.round(clBrut*TX_ONSS_W*100)/100)+'</td><td class="r">'+f2(quickPP(clBrut))+'</td><td class="r">'+f2(clNet)+'</td><td class="r">'+f2(Math.round(clBrut*TX_ONSS_E*100)/100)+'</td><td class="r">'+f2(clCout)+'</td></tr></table>';
        });

        html+='<h2>TOTAUX GLOBAUX</h2>';
        html+='<table><tr class="total"><td>'+totalEmps+' travailleurs</td><td class="r">Brut: '+f2(totalBrut)+'</td><td class="r">ONSS: '+f2(totalOnssW+totalOnssE)+'</td><td class="r">Net: '+f2(totalNet)+'</td><td class="r">Cout: '+f2(totalCout)+'</td></tr></table>';

      } else if(report.id==='provisions'){
        html+='<h1>Provisions Sociales a Constituer</h1>';
        html+='<p style="color:#888;margin-bottom:15px">Estimation des provisions au '+now.toLocaleDateString('fr-BE')+'</p>';
        html+='<table><tr><th>Client</th><th>Employé</th><th>Anciennete</th><th class="r">Pecule vacances</th><th class="r">13eme mois</th><th class="r">Preavis estime</th><th class="r">Total provision</th></tr>';
        let totPV=0,tot13=0,totPrea=0;
        clients.forEach(cl=>{
          (cl.emps||[]).forEach(e=>{
            const br=+(e.monthlySalary||e.gross||0);if(br<=0)return;
            const start=new Date(e.startDate||e.start||'2020-01-01');
            const ancMois=Math.round((now-start)/2592000000);
            const pv=Math.round(br*PV_SIMPLE*(ancMois%12)/12*100)/100;
            const m13=Math.round(br*(ancMois%12)/12*100)/100;
            const ancAn=ancMois/12;
            const semPrea=ancAn<1?4:ancAn<3?6:ancAn<5?9:ancAn<10?15:ancAn<15?21:ancAn<20?36:51;
            const prea=Math.round(br*12/52*semPrea*100)/100;
            totPV+=pv;tot13+=m13;totPrea+=prea;
            html+='<tr><td>'+(cl.company?.name||'')+'</td><td>'+(e.first||'')+' '+(e.last||'')+'</td><td>'+Math.floor(ancAn)+'a '+ancMois%12+'m</td><td class="r">'+f2(pv)+'</td><td class="r">'+f2(m13)+'</td><td class="r">'+f2(prea)+'</td><td class="r">'+f2(pv+m13+prea)+'</td></tr>';
          });
        });
        html+='<tr class="total"><td colspan="3">TOTAL</td><td class="r">'+f2(totPV)+'</td><td class="r">'+f2(tot13)+'</td><td class="r">'+f2(totPrea)+'</td><td class="r">'+f2(totPV+tot13+totPrea)+'</td></tr></table>';

      } else {
        // Generic report
        html+='<h1>'+report.title+'</h1><p style="color:#888;margin-bottom:15px">'+report.desc+'</p>';
        html+='<div style="text-align:center;margin:15px 0">';
        html+='<div class="kpi"><div class="kpi-val">'+clients.length+'</div><div class="kpi-lbl">Clients</div></div>';
        html+='<div class="kpi"><div class="kpi-val">'+totalEmps+'</div><div class="kpi-lbl">Travailleurs</div></div>';
        html+='<div class="kpi"><div class="kpi-val">'+f2(totalBrut)+'</div><div class="kpi-lbl">Masse brute</div></div>';
        html+='<div class="kpi"><div class="kpi-val">'+f2(totalCout)+'</div><div class="kpi-lbl">Coût total</div></div>';
        html+='</div>';
        clients.forEach(cl=>{
          const co=cl.company||{};const emps=cl.emps||[];
          html+='<h2>'+co.name+' — '+emps.length+' travailleur(s)</h2>';
          const clBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);
          html+='<p>Masse brute: '+f2(clBrut)+' EUR | ONSS: '+f2(Math.round(clBrut*3814)/100)+' EUR | Cout: '+f2(Math.round(clBrut*(1+TX_ONSS_E)*10000)/10000)+' EUR</p>';
        });
      }

      html+='<div style="margin-top:30px;padding-top:10px;border-top:1px solid #eee;text-align:center;color:#888;font-size:9px">Aureus Social Pro — Généré le '+now.toLocaleDateString('fr-BE')+' a '+now.toLocaleTimeString('fr-BE')+' | Document confidentiel</div>';
      html+='<div style="text-align:center;margin:15px 0" class="no-print"><button onclick="window.print()" style="background:#c6a34e;color:#fff;border:none;padding:12px 30px;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px">Imprimer / PDF</button></div>';
      html+='</body></html>';

      previewHTML(html, report.title.replace(/\s/g,'_'));
      setGenerating(false);
    },500);
  };

  const cats=[...new Set(reports.map(r=>r.cat))];

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📊 Reporting Avance</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>10 rapports professionnels — Generation HTML/PDF en 1 clic</p>

    {cats.map(cat=><div key={cat} style={{marginBottom:16}}>
      <div style={{fontSize:12,fontWeight:600,color:'#888',marginBottom:8,textTransform:'uppercase',letterSpacing:1}}>{cat}</div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:10}}>
        {reports.filter(r=>r.cat===cat).map(r=><button key={r.id} onClick={()=>generateReport(r)} disabled={generating} style={{padding:16,borderRadius:12,border:'1px solid '+(selReport===r.id?'rgba(198,163,78,.3)':'rgba(255,255,255,.05)'),background:selReport===r.id?'rgba(198,163,78,.06)':'linear-gradient(135deg,#0d1117,#131820)',cursor:'pointer',textAlign:'left',transition:'all .15s'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div style={{fontSize:20}}>{r.icon}</div>
            {selReport===r.id&&generating&&<div style={{fontSize:10,color:'#c6a34e'}}>Generation...</div>}
          </div>
          <div style={{fontSize:13,fontWeight:600,color:'#e5e5e5',marginTop:6}}>{r.title}</div>
          <div style={{fontSize:10,color:'#888',marginTop:2}}>{r.desc}</div>
        </button>)}
      </div>
    </div>)}
  </div>;
};

// ═══ 3. HUB INTÉGRATIONS — API ONSS, Belcotax, Banque ═══
const IntegrationsHub=({s,supabase})=>{
  const [configs,setConfigs]=useState({
    onss:{enabled:true,endpoint:'https://services.socialsecurity.be/REST/dimona/v2',apiKey:'JWT-OAuth2',lastSync:new Date().toISOString(),status:'connected'},
    belcotax:{enabled:false,endpoint:'https://eservices.minfin.fgov.be/belcotax',certFile:'',lastSync:null,status:'disconnected'},
    banque:{enabled:false,bank:'belfius',iban:'',bic:'',protocol:'isabel',lastSync:null,status:'disconnected'},
    email:{enabled:true,smtp:'smtp.gmail.com',port:587,user:'',pass:'',from:'noreply@aureussocial.be',status:'configured'},
    supabase:{enabled:!!supabase,url:'https://xxx.supabase.co',key:'***',status:supabase?'connected':'disconnected'},
    webhook:{enabled:false,url:'',events:['payroll_done','declaration_sent','alert_triggered'],secret:'',status:'disconnected'},
  });
  const [selInteg,setSelInteg]=useState('onss');
  const [testResult,setTestResult]=useState(null);

  const integrations=[
    {id:'onss',name:'ONSS / RSZ',desc:'Dimona, DmfA, declarations sociales',icon:'🏛',color:'#ef4444',features:['Dimona IN/OUT automatique','DmfA trimestrielle','Consultation cotisations','Status declarations']},
    {id:'belcotax',name:'Belcotax / SPF Finances',desc:'Fiches fiscales 281.10, precompte',icon:'🧾',color:'#a855f7',features:['Generation 281.10 XML','Envoi electronique','Accusé reception','Historique declarations']},
    {id:'banque',name:'Connexion Bancaire',desc:'SEPA, virements, reconciliation',icon:'🏦',color:'#22c55e',features:['Import CODA/MT940','Export SEPA pain.001','Reconciliation auto','Multi-banques (Belfius, KBC, ING, BNP)']},
    {id:'email',name:'Email / SMTP',desc:'Distribution fiches, notifications',icon:'📧',color:'#3b82f6',features:['SMTP personnalise','Templates HTML','Pieces jointes auto','Accusés de reception']},
    {id:'supabase',name:'Base de Donnees',desc:'Stockage cloud securise',icon:'💾',color:'#c6a34e',features:['Sauvegarde auto','Sync temps reel','Historique versions','Encryption AES-256']},
    {id:'webhook',name:'Webhooks / API',desc:'Integrations tierces, ERP, comptabilite',icon:'🔗',color:'#eab308',features:['Events en temps reel','API REST','Export JSON/XML','Connexion ERP (Odoo, SAP, Exact)']},
  ];

  const testConnection=(id)=>{
    setTestResult({id,status:'testing'});
    setTimeout(()=>{
      if(id==='supabase'&&supabase){
        setTestResult({id,status:'success',msg:'Connexion Supabase OK'});
        setConfigs(p=>({...p,[id]:{...p[id],status:'connected',lastSync:new Date().toISOString()}}));
      }else if(id==='email'&&configs.email.user){
        setTestResult({id,status:'success',msg:'SMTP configure'});
        setConfigs(p=>({...p,[id]:{...p[id],status:'connected'}}));
      }else{
        setTestResult({id,status:'pending',msg:'Configuration requise — contactez Aureus pour activer'});
      }
    },1500);
  };

  const sel=integrations.find(i=>i.id===selInteg);
  const conf=configs[selInteg]||{};

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>🔌 Hub Integrations</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Connexions API — ONSS, Belcotax, Banques, ERP</p>

    <div style={{display:'grid',gridTemplateColumns:'240px 1fr',gap:16}}>
      {/* Left nav */}
      <div style={{display:'flex',flexDirection:'column',gap:6}}>
        {integrations.map(integ=><button key={integ.id} onClick={()=>{setSelInteg(integ.id);setTestResult(null);}} style={{display:'flex',alignItems:'center',gap:10,padding:'12px 14px',borderRadius:10,border:selInteg===integ.id?'2px solid '+integ.color:'1px solid rgba(255,255,255,.05)',background:selInteg===integ.id?integ.color+'10':'rgba(255,255,255,.02)',cursor:'pointer',textAlign:'left'}}>
          <div style={{fontSize:20}}>{integ.icon}</div>
          <div style={{flex:1}}>
            <div style={{fontSize:12,fontWeight:600,color:selInteg===integ.id?integ.color:'#e5e5e5'}}>{integ.name}</div>
            <div style={{fontSize:9,color:'#888'}}>{integ.desc}</div>
          </div>
          <div style={{width:8,height:8,borderRadius:'50%',background:configs[integ.id]?.status==='connected'?'#22c55e':configs[integ.id]?.status==='configured'?'#eab308':'#ef4444'}}/>
        </button>)}
      </div>

      {/* Right panel */}
      {sel&&<div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        {/* Header */}
        <div style={{padding:16,background:sel.color+'08',borderBottom:'1px solid '+sel.color+'15'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div>
              <div style={{fontSize:16,fontWeight:700,color:sel.color}}>{sel.icon} {sel.name}</div>
              <div style={{fontSize:11,color:'#888',marginTop:2}}>{sel.desc}</div>
            </div>
            <div style={{padding:'4px 10px',borderRadius:6,background:conf.status==='connected'?'rgba(34,197,94,.1)':conf.status==='configured'?'rgba(234,179,8,.1)':'rgba(239,68,68,.1)',color:conf.status==='connected'?'#22c55e':conf.status==='configured'?'#eab308':'#ef4444',fontSize:10,fontWeight:600,textTransform:'uppercase'}}>{conf.status||'Non connecte'}</div>
          </div>
        </div>

        {/* Features */}
        <div style={{padding:16}}>
          <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Fonctionnalites</div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:6,marginBottom:16}}>
            {sel.features.map((f,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:6,padding:'6px 10px',background:'rgba(255,255,255,.02)',borderRadius:6}}>
              <span style={{color:conf.status==='connected'?'#22c55e':'#888'}}>✓</span>
              <span style={{fontSize:11,color:'#e5e5e5'}}>{f}</span>
            </div>)}
          </div>

          {/* Config fields based on type */}
          <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Configuration</div>
          {selInteg==='onss'&&<div style={{display:'flex',flexDirection:'column',gap:8}}>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Endpoint API</label><input value={conf.endpoint||''} readOnly style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#888',fontSize:10,fontFamily:'monospace'}}/></div>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Cle API</label><input type="password" placeholder="Contactez ONSS pour obtenir vos credentials" style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:10}}/></div>
          </div>}
          {selInteg==='banque'&&<div style={{display:'flex',flexDirection:'column',gap:8}}>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Banque</label>
            <select value={conf.bank||'belfius'} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
              {['Belfius','KBC','ING','BNP Paribas Fortis','Crelan','CBC','AXA Banque'].map(b=><option key={b}>{b}</option>)}
            </select></div>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Protocole</label>
            <select style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
              <option>Isabel 6</option><option>CodaBox</option><option>POM</option><option>SEPA Direct</option>
            </select></div>
          </div>}
          {selInteg==='email'&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>SMTP Host</label><input value={conf.smtp||''} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:10}}/></div>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Port</label><input value={conf.port||587} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:10}}/></div>
          </div>}
          {selInteg==='webhook'&&<div style={{display:'flex',flexDirection:'column',gap:8}}>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Webhook URL</label><input placeholder="https://your-erp.com/webhook/aureus" style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:10,fontFamily:'monospace'}}/></div>
            <div><label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Events</label>
            <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>{(conf.events||[]).map(ev=><span key={ev} style={{padding:'3px 8px',borderRadius:4,background:'rgba(198,163,78,.08)',color:'#c6a34e',fontSize:9}}>{ev}</span>)}</div></div>
          </div>}

          {/* Test button */}
          <div style={{marginTop:16,display:'flex',gap:8}}>
            <button onClick={()=>testConnection(selInteg)} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:12,cursor:'pointer'}}>
              {testResult?.id===selInteg&&testResult?.status==='testing'?'Test en cours...':'🔌 Tester connexion'}
            </button>
            <button style={{padding:'10px 20px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontWeight:600,fontSize:12,cursor:'pointer'}}>
              💾 Sauvegarder
            </button>
          </div>
          {testResult&&testResult.id===selInteg&&testResult.status!=='testing'&&<div style={{marginTop:10,padding:10,borderRadius:8,background:testResult.status==='success'?'rgba(34,197,94,.06)':'rgba(234,179,8,.06)',border:'1px solid '+(testResult.status==='success'?'rgba(34,197,94,.15)':'rgba(234,179,8,.15)'),color:testResult.status==='success'?'#22c55e':'#eab308',fontSize:11}}>
            {testResult.status==='success'?'✅':'⚠️'} {testResult.msg}
          </div>}

          {/* Last sync */}
          {conf.lastSync&&<div style={{marginTop:10,fontSize:10,color:'#888'}}>Derniere sync: {new Date(conf.lastSync).toLocaleString('fr-BE')}</div>}
        </div>
      </div>}
    </div>
  </div>;
};

const FiduciaireHub=({s,d})=>{
  const clients=s.clients||[];
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const [sortBy,setSortBy]=useState('cout');
  const [selView,setSelView]=useState('overview');
  const now=new Date();
  const mois=['Jan','Fev','Mar','Avr','Mai','Jun','Jul','Aou','Sep','Oct','Nov','Dec'];

  // Calculate per-client metrics
  const clientStats=clients.map(cl=>{
    const co=cl.company||{};
    const emps=cl.emps||[];
    const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0)),0);
    const totalOnssW=Math.round(totalBrut*TX_ONSS_W*100)/100;
    const totalOnssE=Math.round(totalBrut*TX_ONSS_E*100)/100;
    const totalNet=emps.reduce((a,e)=>{const b=+(e.monthlySalary||e.gross||0);const o=Math.round(b*TX_ONSS_W*100)/100;const imp=b-o;const pp=quickPP(b);return a+(imp-pp);},0);
    const totalCout=Math.round(totalBrut*(1+TX_ONSS_E)*10000)/10000*emps.length>0?emps.reduce((a,e)=>a+Math.round((+(e.monthlySalary||e.gross||0))*(1+TX_ONSS_E)*10000)/10000,0):0;
    const avgBrut=emps.length>0?totalBrut/emps.length:0;
    const cddCount=emps.filter(e=>(e.contractType||'')==='CDD').length;
    const missingNISS=emps.filter(e=>!(e.niss||e.NISS)).length;
    const missingIBAN=emps.filter(e=>!(e.iban||e.IBAN)).length;
    // Health score
    let health=100;
    if(missingNISS>0)health-=missingNISS*5;
    if(missingIBAN>0)health-=missingIBAN*3;
    emps.forEach(e=>{if(+(e.monthlySalary||e.gross||0)<=0)health-=10;});
    if(!co.vat)health-=10;if(!co.name)health-=10;
    health=Math.max(0,Math.min(100,health));
    return {name:co.name||'Sans nom',vat:co.vat||'',cp:co.cp||'200',emps:emps.length,cdd:cddCount,brut:totalBrut,net:totalNet,onssW:totalOnssW,onssE:totalOnssE,cout:totalCout,avgBrut,missingNISS,missingIBAN,health,raw:cl};
  });

  // Sort
  const sorted=[...clientStats].sort((a,b)=>{
    if(sortBy==='cout')return b.cout-a.cout;
    if(sortBy==='emps')return b.emps-a.emps;
    if(sortBy==='health')return a.health-b.health;
    if(sortBy==='name')return a.name.localeCompare(b.name);
    return 0;
  });

  // Totals
  const totals={
    clients:clients.length,
    emps:clientStats.reduce((a,c)=>a+c.emps,0),
    brut:clientStats.reduce((a,c)=>a+c.brut,0),
    net:clientStats.reduce((a,c)=>a+c.net,0),
    onss:clientStats.reduce((a,c)=>a+c.onssW+c.onssE,0),
    cout:clientStats.reduce((a,c)=>a+c.cout,0),
    cdd:clientStats.reduce((a,c)=>a+c.cdd,0),
  };
  const avgHealth=clientStats.length>0?Math.round(clientStats.reduce((a,c)=>a+c.health,0)/clientStats.length):0;

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🏢 Hub Fiduciaire</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Vue consolidee multi-clients — {totals.clients} dossiers | {totals.emps} travailleurs</p>
      </div>
      <div style={{display:'flex',gap:6}}>
        {['overview','ranking','alerts'].map(v=><button key={v} onClick={()=>setSelView(v)} style={{padding:'6px 14px',borderRadius:8,border:'none',background:selView===v?'rgba(198,163,78,.15)':'rgba(255,255,255,.03)',color:selView===v?'#c6a34e':'#888',fontSize:11,cursor:'pointer',fontWeight:selView===v?600:400}}>
          {v==='overview'?'Vue globale':v==='ranking'?'Classement':'Alertes'}
        </button>)}
      </div>
    </div>

    {/* Global KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:10,marginBottom:20}}>
      {[{l:'Dossiers',v:totals.clients,c:'#c6a34e',i:'🏢'},
        {l:'Travailleurs',v:totals.emps,c:'#3b82f6',i:'👥'},
        {l:'Masse brute',v:f2(totals.brut)+' EUR',c:'#e5e5e5',i:'💰'},
        {l:'Net total',v:f2(totals.net)+' EUR',c:'#22c55e',i:'💵'},
        {l:'ONSS total',v:f2(totals.onss)+' EUR',c:'#ef4444',i:'🏛'},
        {l:'Sante moyenne',v:avgHealth+'%',c:avgHealth>=80?'#22c55e':avgHealth>=60?'#eab308':'#ef4444',i:'❤️'},
      ].map((k,i)=><div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:9,color:'#888'}}>{k.i} {k.l}</div>
        <div style={{fontSize:16,fontWeight:700,color:k.c,marginTop:2}}>{k.v}</div>
      </div>)}
    </div>

    {/* Sort controls */}
    <div style={{display:'flex',gap:6,marginBottom:12,alignItems:'center'}}>
      <span style={{fontSize:10,color:'#888'}}>Trier par:</span>
      {[{id:'cout',l:'Cout'},{id:'emps',l:'Effectif'},{id:'health',l:'Sante'},{id:'name',l:'Nom'}].map(s=><button key={s.id} onClick={()=>setSortBy(s.id)} style={{padding:'4px 10px',borderRadius:6,border:'none',background:sortBy===s.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:sortBy===s.id?'#c6a34e':'#888',fontSize:10,cursor:'pointer'}}>{s.l}</button>)}
    </div>

    {selView==='overview'&&<div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:12}}>
      {sorted.map((c,i)=><div key={i} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.08)',borderRadius:14,cursor:'pointer'}} onClick={()=>{if(c.raw.company)d({type:'NAV',page:'employees'});}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
          <div>
            <div style={{fontSize:14,fontWeight:700,color:'#e5e5e5'}}>{c.name}</div>
            <div style={{fontSize:10,color:'#888'}}>{c.vat} | CP {c.cp}</div>
          </div>
          <div style={{width:44,height:44,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:13,fontWeight:800,color:c.health>=80?'#22c55e':c.health>=60?'#eab308':'#ef4444',border:'3px solid '+(c.health>=80?'#22c55e':c.health>=60?'#eab308':'#ef4444')+'40',background:(c.health>=80?'#22c55e':c.health>=60?'#eab308':'#ef4444')+'10'}}>{c.health}%</div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:6}}>
          {[{l:'Effectif',v:c.emps+(c.cdd>0?' ('+c.cdd+' CDD)':'')},
            {l:'Masse brute',v:f2(c.brut)+' EUR'},
            {l:'ONSS',v:f2(c.onssW+c.onssE)+' EUR'},
            {l:'Cout total',v:f2(c.cout)+' EUR'},
          ].map((m,j)=><div key={j}>
            <div style={{fontSize:8,color:'#888'}}>{m.l}</div>
            <div style={{fontSize:11,fontWeight:600,color:'#e5e5e5'}}>{m.v}</div>
          </div>)}
        </div>
        {(c.missingNISS>0||c.missingIBAN>0)&&<div style={{display:'flex',gap:6,marginTop:8}}>
          {c.missingNISS>0&&<span style={{fontSize:9,padding:'2px 6px',borderRadius:4,background:'rgba(239,68,68,.1)',color:'#ef4444'}}>{c.missingNISS} NISS manquant{c.missingNISS>1?'s':''}</span>}
          {c.missingIBAN>0&&<span style={{fontSize:9,padding:'2px 6px',borderRadius:4,background:'rgba(234,179,8,.1)',color:'#eab308'}}>{c.missingIBAN} IBAN manquant{c.missingIBAN>1?'s':''}</span>}
        </div>}
      </div>)}
    </div>}

    {selView==='ranking'&&<div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'40px 180px 80px 100px 100px 100px 100px 60px',padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
        <div>#</div><div>Client</div><div>Effectif</div><div>Masse brute</div><div>ONSS total</div><div>Coût total</div><div>Brut moyen</div><div>Sante</div>
      </div>
      {sorted.map((c,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'40px 180px 80px 100px 100px 100px 100px 60px',padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
        <div style={{fontSize:14,fontWeight:700,color:i<3?'#c6a34e':'#888'}}>{i+1}</div>
        <div><div style={{fontWeight:600,color:'#e5e5e5'}}>{c.name}</div><div style={{fontSize:9,color:'#888'}}>{c.vat}</div></div>
        <div style={{color:'#3b82f6',fontWeight:600}}>{c.emps}</div>
        <div style={{color:'#e5e5e5'}}>{f2(c.brut)}</div>
        <div style={{color:'#ef4444'}}>{f2(c.onssW+c.onssE)}</div>
        <div style={{color:'#c6a34e',fontWeight:600}}>{f2(c.cout)}</div>
        <div style={{color:'#888'}}>{f2(c.avgBrut)}</div>
        <div style={{fontWeight:700,color:c.health>=80?'#22c55e':c.health>=60?'#eab308':'#ef4444'}}>{c.health}%</div>
      </div>)}
      <div style={{display:'grid',gridTemplateColumns:'40px 180px 80px 100px 100px 100px 100px 60px',padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:11,fontWeight:700}}>
        <div></div><div style={{color:'#c6a34e'}}>TOTAL</div>
        <div style={{color:'#3b82f6'}}>{totals.emps}</div>
        <div style={{color:'#e5e5e5'}}>{f2(totals.brut)}</div>
        <div style={{color:'#ef4444'}}>{f2(totals.onss)}</div>
        <div style={{color:'#c6a34e'}}>{f2(totals.cout)}</div>
        <div style={{color:'#888'}}>{f2(totals.emps>0?totals.brut/totals.emps:0)}</div>
        <div style={{color:avgHealth>=80?'#22c55e':'#eab308'}}>{avgHealth}%</div>
      </div>
    </div>}

    {selView==='alerts'&&<div style={{display:'flex',flexDirection:'column',gap:6}}>
      {sorted.filter(c=>c.health<100).map((c,i)=>{
        const issues=[];
        if(c.missingNISS>0)issues.push(c.missingNISS+' NISS manquant(s)');
        if(c.missingIBAN>0)issues.push(c.missingIBAN+' IBAN manquant(s)');
        c.raw.emps?.forEach(e=>{if(+(e.monthlySalary||e.gross||0)<=0)issues.push((e.first||'')+' '+(e.last||'')+' — salaire = 0');});
        if(!c.vat)issues.push('Numero BCE manquant');
        return <div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+(c.health<60?'rgba(239,68,68,.15)':'rgba(234,179,8,.1)'),borderRadius:12}}>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:6}}>
            <span style={{fontWeight:600,color:'#e5e5e5'}}>{c.name}</span>
            <span style={{fontWeight:700,color:c.health>=80?'#22c55e':c.health>=60?'#eab308':'#ef4444'}}>{c.health}%</span>
          </div>
          {issues.map((iss,j)=><div key={j} style={{fontSize:10,color:'#ef4444',padding:'2px 0'}}>• {iss}</div>)}
        </div>;
      })}
      {sorted.filter(c=>c.health<100).length===0&&<div style={{padding:40,textAlign:'center',color:'#22c55e',fontSize:14,fontWeight:600}}>✅ Tous les dossiers sont 100% conformes !</div>}
    </div>}
  </div>;
};

// ═══ 2. SIMULATEUR LICENCIEMENT — Preavis + indemnites belge ═══
const SimuLicenciement=({s})=>{
  const clients=s.clients||[];
  const [selEmp,setSelEmp]=useState(null);
  const [motif,setMotif]=useState('employeur');
  const [result,setResult]=useState(null);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const allEmps=[];
  clients.forEach(cl=>{(cl.emps||[]).forEach(e=>allEmps.push({...e,_client:cl.company?.name||''}));});

  // Belgian notice period calculation (Loi du 26/12/2013 - unified status)
  const calcPreavis=(ancienneteAnnees,isEmployeur)=>{
    let semaines=0;
    if(isEmployeur){
      // Employer gives notice
      if(ancienneteAnnees<0.25) semaines=1;
      else if(ancienneteAnnees<0.5) semaines=3;
      else if(ancienneteAnnees<1) semaines=4;
      else if(ancienneteAnnees<2) semaines=5;
      else if(ancienneteAnnees<3) semaines=6;
      else if(ancienneteAnnees<4) semaines=7;
      else if(ancienneteAnnees<5) semaines=9;
      else if(ancienneteAnnees<6) semaines=10;
      else if(ancienneteAnnees<7) semaines=12;
      else if(ancienneteAnnees<8) semaines=13;
      else if(ancienneteAnnees<9) semaines=15;
      else if(ancienneteAnnees<10) semaines=16;
      else if(ancienneteAnnees<11) semaines=17;
      else if(ancienneteAnnees<12) semaines=18;
      else if(ancienneteAnnees<13) semaines=19;
      else if(ancienneteAnnees<15) semaines=21;
      else if(ancienneteAnnees<16) semaines=24;
      else if(ancienneteAnnees<17) semaines=27;
      else if(ancienneteAnnees<18) semaines=30;
      else if(ancienneteAnnees<19) semaines=33;
      else if(ancienneteAnnees<20) semaines=36;
      else if(ancienneteAnnees<21) semaines=39;
      else if(ancienneteAnnees<22) semaines=42;
      else if(ancienneteAnnees<23) semaines=45;
      else if(ancienneteAnnees<24) semaines=48;
      else if(ancienneteAnnees<25) semaines=51;
      else semaines=51+Math.floor((ancienneteAnnees-24)*3);
    }else{
      // Employee gives notice  
      if(ancienneteAnnees<0.25) semaines=1;
      else if(ancienneteAnnees<0.5) semaines=2;
      else if(ancienneteAnnees<1) semaines=2;
      else if(ancienneteAnnees<2) semaines=2;
      else if(ancienneteAnnees<3) semaines=3;
      else if(ancienneteAnnees<4) semaines=4;
      else if(ancienneteAnnees<5) semaines=5;
      else if(ancienneteAnnees<6) semaines=6;
      else if(ancienneteAnnees<7) semaines=7;
      else if(ancienneteAnnees<8) semaines=8;
      else if(ancienneteAnnees<9) semaines=9;
      else if(ancienneteAnnees<10) semaines=10;
      else if(ancienneteAnnees<11) semaines=11;
      else if(ancienneteAnnees<12) semaines=12;
      else semaines=13;
    }
    return semaines;
  };

  const simulate=()=>{
    if(!selEmp) return;
    const e=allEmps.find(x=>(x.first||x.fn||'')+(x.last||x.ln||'')+(x._client)===selEmp);
    if(!e) return;
    const start=new Date(e.startDate||e.start||'2020-01-01');
    const now=new Date();
    const ancMs=now-start;
    const ancAnnees=ancMs/(365.25*86400000);
    const ancMois=Math.round(ancAnnees*12);
    const isEmployeur=motif==='employeur';
    const semaines=calcPreavis(ancAnnees,isEmployeur);
    const brut=+(e.monthlySalary||e.gross||0);
    const brutHebdo=brut*12/52;
    const indemnitePreavis=Math.round(brutHebdo*semaines*100)/100;
    const onssInd=Math.round(indemnitePreavis*TX_ONSS_W*100)/100;
    const ppInd=quickPP(indemnitePreavis);
    const netInd=Math.round((indemnitePreavis-onssInd-ppInd)*100)/100;
    const coutEmployeur=Math.round(indemnitePreavis*(1+TX_ONSS_E)*10000)/10000;
    // Pecule vacances sortie
    const pecule=Math.round(brut*PV_SIMPLE*ancMois/12*100)/100;
    // Pro rata 13eme mois
    const treizieme=Math.round(brut*ancMois/12/12*100)/100;

    setResult({
      name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),
      client:e._client,ancAnnees,ancMois,
      startDate:e.startDate||e.start||'N/A',
      brut,semaines,
      brutHebdo,indemnitePreavis,onssInd,ppInd,netInd,coutEmployeur,
      pecule,treizieme,
      totalBrut:indemnitePreavis+pecule+treizieme,
      totalNet:netInd+Math.round(pecule*0.6345*100)/100+Math.round(treizieme*0.6345*100)/100,
      totalCout:coutEmployeur+Math.round(pecule*(1+TX_ONSS_E)*100)/100+Math.round(treizieme*(1+TX_ONSS_E)*100)/100,
      isEmployeur,motif
    });
  };

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>⚖️ Simulateur Licenciement</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Calcul preavis belge (Loi 26/12/2013) + indemnites de sortie</p>

    <div style={{display:'grid',gridTemplateColumns:'340px 1fr',gap:16}}>
      {/* Config */}
      <div style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
        <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Configuration</div>
        <div style={{marginBottom:12}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Travailleur</label>
          <select value={selEmp||''} onChange={e=>setSelEmp(e.target.value)} style={{width:'100%',padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}>
            <option value="">-- Selectionner --</option>
            {allEmps.map((e,i)=><option key={i} value={(e.first||e.fn||'')+(e.last||e.ln||'')+(e._client)}>{(e.first||e.fn||'')} {(e.last||e.ln||'')} — {e._client}</option>)}
          </select>
        </div>
        <div style={{marginBottom:12}}>
          <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Initiative</label>
          <div style={{display:'flex',gap:6}}>
            {[{id:'employeur',l:'Employeur',i:'🏢'},{id:'travailleur',l:'Travailleur',i:'👤'}].map(m=><button key={m.id} onClick={()=>setMotif(m.id)} style={{flex:1,padding:'10px',borderRadius:8,border:motif===m.id?'2px solid #c6a34e':'1px solid rgba(255,255,255,.05)',background:motif===m.id?'rgba(198,163,78,.08)':'transparent',color:motif===m.id?'#c6a34e':'#888',fontSize:11,cursor:'pointer',fontWeight:motif===m.id?600:400}}>{m.i} {m.l}</button>)}
          </div>
        </div>
        <button onClick={simulate} disabled={!selEmp} style={{width:'100%',padding:'12px',borderRadius:10,border:'none',background:selEmp?'linear-gradient(135deg,#c6a34e,#a07d3e)':'#333',color:selEmp?'#060810':'#888',fontWeight:700,fontSize:13,cursor:selEmp?'pointer':'not-allowed'}}>
          ⚖️ Calculer
        </button>
      </div>

      {/* Result */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        {!result?<div style={{padding:60,textAlign:'center',color:'#888'}}>
          <div style={{fontSize:44,marginBottom:12}}>⚖️</div>
          <div style={{fontSize:14,fontWeight:600}}>Selectionnez un travailleur et calculez</div>
          <div style={{fontSize:11,marginTop:4}}>Preavis legal, indemnites, pecule vacances sortie, pro rata 13eme mois</div>
        </div>:
        <div>
          {/* Header */}
          <div style={{padding:16,background:'rgba(198,163,78,.06)',borderBottom:'1px solid rgba(198,163,78,.1)'}}>
            <div style={{fontSize:16,fontWeight:700,color:'#e5e5e5'}}>{result.name}</div>
            <div style={{fontSize:11,color:'#888'}}>{result.client} | Debut: {result.startDate} | Anciennete: {Math.floor(result.ancAnnees)} an(s) {result.ancMois%12} mois | Initiative: {result.isEmployeur?'Employeur':'Travailleur'}</div>
          </div>

          {/* Key metrics */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:0,borderBottom:'1px solid rgba(198,163,78,.1)'}}>
            {[{l:'Preavis',v:result.semaines+' semaines',c:'#c6a34e'},
              {l:'Indemnite brute',v:f2(result.indemnitePreavis)+' EUR',c:'#e5e5e5'},
              {l:'Indemnite nette',v:f2(result.netInd)+' EUR',c:'#22c55e'},
              {l:'Cout employeur',v:f2(result.coutEmployeur)+' EUR',c:'#ef4444'},
            ].map((k,i)=><div key={i} style={{padding:14,textAlign:'center',borderRight:'1px solid rgba(255,255,255,.03)'}}>
              <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
              <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
            </div>)}
          </div>

          {/* Detail table */}
          <div style={{padding:16}}>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Detail du calcul</div>
            {[{l:'Brut mensuel',v:f2(result.brut)+' EUR'},
              {l:'Brut hebdomadaire (brut x 12 / 52)',v:f2(result.brutHebdo)+' EUR'},
              {l:'Preavis legal',v:result.semaines+' semaines',bold:true},
              {l:'Indemnite de preavis (hebdo x semaines)',v:f2(result.indemnitePreavis)+' EUR',bold:true},
              {l:'ONSS travailleur (13,07%)',v:'- '+f2(result.onssInd)+' EUR',red:true},
              {l:'Précompte professionnel',v:'- '+f2(result.ppInd)+' EUR',red:true},
              {l:'Net indemnite preavis',v:f2(result.netInd)+' EUR',green:true},
              {l:'',v:'',sep:true},
              {l:'Pecule vacances sortie (7,64% x prorata)',v:f2(result.pecule)+' EUR'},
              {l:'Pro rata 13eme mois',v:f2(result.treizieme)+' EUR'},
              {l:'',v:'',sep:true},
              {l:'TOTAL BRUT SORTIE',v:f2(result.totalBrut)+' EUR',bold:true,gold:true},
              {l:'TOTAL NET ESTIME',v:f2(result.totalNet)+' EUR',bold:true,green:true},
              {l:'COUT TOTAL EMPLOYEUR',v:f2(result.totalCout)+' EUR',bold:true,red:true},
            ].map((r,i)=>r.sep?<div key={i} style={{height:1,background:'rgba(198,163,78,.08)',margin:'6px 0'}}/>:
              <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'5px 0',borderBottom:'1px solid rgba(255,255,255,.02)'}}>
                <span style={{fontSize:11,color:r.bold?'#e5e5e5':'#888',fontWeight:r.bold?600:400}}>{r.l}</span>
                <span style={{fontSize:11,fontWeight:r.bold?700:400,color:r.gold?'#c6a34e':r.green?'#22c55e':r.red?'#ef4444':'#e5e5e5',fontFamily:'monospace'}}>{r.v}</span>
              </div>
            )}
          </div>
        </div>}
      </div>
    </div>
  </div>;
};

// ═══ 3. COUT TOTAL DASHBOARD — Vue cout employeur detaille ═══
const CoutTotalDash=({s})=>{
  const clients=s.clients||[];
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const [period,setPeriod]=useState('month');

  const allEmps=[];
  clients.forEach(cl=>{(cl.emps||[]).forEach(e=>allEmps.push({...e,_client:cl.company?.name||'',_co:cl.company||{}}));});

  const calcCout=(e)=>{
    const brut=+(e.monthlySalary||e.gross||0);
    const mult=period==='year'?12:period==='quarter'?3:1;
    const onssW=Math.round(brut*TX_ONSS_W*100)/100;
    const bonusEmploi=brut<=2800?Math.min(Math.round(brut*0.143*100)/100,280):0;
    const imposable=brut-onssW;
    const pp=quickPP(brut);
    const csss=calcCSSS(brut);
    const net=Math.round((imposable-pp-csss+bonusEmploi)*100)/100;
    const onssE=Math.round(brut*TX_ONSS_E*100)/100;
    const maribel=brut>=3000?0:Math.round(brut*0)*100/100;
    const cheqRepas=22*(+(e.mealVoucher||0));
    const coutTotal=Math.round((brut+onssE+cheqRepas)*100)/100;
    return {brut:brut*mult,onssW:onssW*mult,imposable:imposable*mult,pp:pp*mult,bonusEmploi:bonusEmploi*mult,net:net*mult,onssE:onssE*mult,maribel:maribel*mult,cheqRepas:cheqRepas*mult,coutTotal:coutTotal*mult};
  };

  const rows=allEmps.map(e=>({name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),client:e._client,...calcCout(e)}));
  const totals=rows.reduce((a,r)=>({brut:a.brut+r.brut,onssW:a.onssW+r.onssW,pp:a.pp+r.pp,net:a.net+r.net,onssE:a.onssE+r.onssE,coutTotal:a.coutTotal+r.coutTotal,bonusEmploi:a.bonusEmploi+r.bonusEmploi}),{brut:0,onssW:0,pp:0,net:0,onssE:0,coutTotal:0,bonusEmploi:0});
  const chargeRate=totals.brut>0?Math.round((totals.coutTotal-totals.brut)/totals.brut*10000)/100:0;

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>💰 Cout Total Employeur</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Decomposition complete du cout salarial — {rows.length} travailleurs</p>
      </div>
      <div style={{display:'flex',gap:6}}>
        {[{id:'month',l:'Mensuel'},{id:'quarter',l:'Trimestriel'},{id:'year',l:'Annuel'}].map(p=><button key={p.id} onClick={()=>setPeriod(p.id)} style={{padding:'6px 14px',borderRadius:8,border:'none',background:period===p.id?'rgba(198,163,78,.15)':'rgba(255,255,255,.03)',color:period===p.id?'#c6a34e':'#888',fontSize:11,cursor:'pointer',fontWeight:period===p.id?600:400}}>{p.l}</button>)}
      </div>
    </div>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Masse brute',v:f2(totals.brut),c:'#e5e5e5'},
        {l:'ONSS travailleur',v:f2(totals.onssW),c:'#3b82f6'},
        {l:'ONSS employeur',v:f2(totals.onssE),c:'#ef4444'},
        {l:'Net total',v:f2(totals.net),c:'#22c55e'},
        {l:'Cout total',v:f2(totals.coutTotal),c:'#c6a34e'},
      ].map((k,i)=><div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'15',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
        <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v} EUR</div>
      </div>)}
    </div>

    {/* Charge bar */}
    <div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12,marginBottom:16}}>
      <div style={{display:'flex',justifyContent:'space-between',marginBottom:6}}>
        <span style={{fontSize:11,color:'#888'}}>Taux de charge patronale</span>
        <span style={{fontSize:14,fontWeight:700,color:'#c6a34e'}}>{chargeRate}%</span>
      </div>
      <div style={{height:8,background:'rgba(255,255,255,.05)',borderRadius:4,overflow:'hidden'}}>
        <div style={{height:'100%',width:Math.min(chargeRate,50)+'%',background:'linear-gradient(90deg,#22c55e,#c6a34e,#ef4444)',borderRadius:4,transition:'width .5s'}}/>
      </div>
      <div style={{display:'flex',justifyContent:'space-between',fontSize:9,color:'#888',marginTop:4}}>
        <span>0%</span><span>25% (ideal)</span><span>50%+</span>
      </div>
    </div>

    {/* Table */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'140px 100px 80px 80px 80px 80px 80px 90px',padding:'8px 12px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
        <div>Employé</div><div>Client</div><div>Brut</div><div>ONSS W</div><div>PP</div><div>Net</div><div>ONSS E</div><div>Coût total</div>
      </div>
      <div style={{maxHeight:450,overflowY:'auto'}}>
        {rows.map((r,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'140px 100px 80px 80px 80px 80px 80px 90px',padding:'6px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
          <div style={{color:'#e5e5e5',fontWeight:500}}>{r.name}</div>
          <div style={{color:'#888',fontSize:10}}>{r.client}</div>
          <div style={{color:'#e5e5e5'}}>{f2(r.brut)}</div>
          <div style={{color:'#3b82f6'}}>{f2(r.onssW)}</div>
          <div style={{color:'#a855f7'}}>{f2(r.pp)}</div>
          <div style={{color:'#22c55e',fontWeight:600}}>{f2(r.net)}</div>
          <div style={{color:'#ef4444'}}>{f2(r.onssE)}</div>
          <div style={{color:'#c6a34e',fontWeight:700}}>{f2(r.coutTotal)}</div>
        </div>)}
      </div>
      <div style={{display:'grid',gridTemplateColumns:'140px 100px 80px 80px 80px 80px 80px 90px',padding:'10px 12px',background:'rgba(198,163,78,.06)',fontSize:11,fontWeight:700}}>
        <div style={{color:'#c6a34e'}}>TOTAL</div><div></div>
        <div style={{color:'#e5e5e5'}}>{f2(totals.brut)}</div>
        <div style={{color:'#3b82f6'}}>{f2(totals.onssW)}</div>
        <div style={{color:'#a855f7'}}>{f2(totals.pp)}</div>
        <div style={{color:'#22c55e'}}>{f2(totals.net)}</div>
        <div style={{color:'#ef4444'}}>{f2(totals.onssE)}</div>
        <div style={{color:'#c6a34e'}}>{f2(totals.coutTotal)}</div>
      </div>
    </div>
  </div>;
};

// ═══ 4. PAYROLL TIMELINE — Chronologie interactive des evenements ═══
const PayrollTimeline=({s})=>{
  const clients=s.clients||[];
  const now=new Date();
  const [range,setRange]=useState(90);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  // Build timeline events
  const events=[];
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];

  // Monthly deadlines
  for(let m=0;m<3;m++){
    const d=new Date(now);d.setMonth(d.getMonth()+m);
    const mIdx=d.getMonth();const yr=d.getFullYear();
    events.push({date:new Date(yr,mIdx,5),type:'deadline',cat:'ONSS',title:'ONSS provisoire '+mois[mIdx],icon:'🏛',color:'#ef4444'});
    events.push({date:new Date(yr,mIdx,15),type:'deadline',cat:'Fiscal',title:'Précompte professionnel '+mois[mIdx],icon:'💰',color:'#a855f7'});
    events.push({date:new Date(yr,mIdx,25),type:'deadline',cat:'Paie',title:'Virements salaires '+mois[mIdx],icon:'💳',color:'#22c55e'});
    events.push({date:new Date(yr,mIdx,28),type:'deadline',cat:'Paie',title:'Distribution fiches '+mois[mIdx],icon:'📄',color:'#3b82f6'});
  }

  // Quarterly
  const qMonths=[[0,3,6,9],[1,4,7,10],[2,5,8,11]];
  for(let m=0;m<6;m++){
    const d=new Date(now);d.setMonth(d.getMonth()+m);
    if([0,3,6,9].includes(d.getMonth())){
      events.push({date:new Date(d.getFullYear(),d.getMonth(),10),type:'deadline',cat:'ONSS',title:'DmfA T'+Math.ceil((d.getMonth()+1)/3)+' '+d.getFullYear(),icon:'🏛',color:'#ef4444',important:true});
    }
  }

  // Employee events
  clients.forEach(cl=>{
    (cl.emps||[]).forEach(e=>{
      const name=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
      // CDD end dates
      if((e.contractType||'')==='CDD'&&(e.endDate||e.end)){
        const end=new Date(e.endDate||e.end);
        events.push({date:end,type:'contract',cat:'Contrat',title:'Fin CDD — '+name,desc:cl.company?.name,icon:'📋',color:'#eab308'});
      }
      // Start dates (past)
      if(e.startDate||e.start){
        const start=new Date(e.startDate||e.start);
        if(Math.abs(now-start)<range*86400000){
          events.push({date:start,type:'embauche',cat:'RH',title:'Entree — '+name,desc:cl.company?.name,icon:'🟢',color:'#22c55e'});
        }
      }
      // Anniversaries
      if(e.startDate||e.start){
        const start=new Date(e.startDate||e.start);
        const nextAnniv=new Date(start);
        nextAnniv.setFullYear(now.getFullYear());
        if(nextAnniv<now) nextAnniv.setFullYear(now.getFullYear()+1);
        const years=nextAnniv.getFullYear()-start.getFullYear();
        if(Math.abs(nextAnniv-now)<range*86400000){
          events.push({date:nextAnniv,type:'anniversaire',cat:'RH',title:years+' an(s) — '+name,desc:cl.company?.name,icon:'🎂',color:'#c6a34e'});
        }
      }
    });
  });

  // Sort and filter by range
  const rangeStart=new Date(now.getTime()-range/3*86400000);
  const rangeEnd=new Date(now.getTime()+range*86400000);
  const filtered=events.filter(e=>e.date>=rangeStart&&e.date<=rangeEnd).sort((a,b)=>a.date-b.date);

  // Group by date
  const grouped={};
  filtered.forEach(e=>{
    const key=e.date.toLocaleDateString('fr-BE');
    if(!grouped[key])grouped[key]=[];
    grouped[key].push(e);
  });

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📅 Timeline Paie</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Chronologie interactive — {filtered.length} evenements</p>
      </div>
      <div style={{display:'flex',gap:6}}>
        {[{d:30,l:'1 mois'},{d:90,l:'3 mois'},{d:180,l:'6 mois'}].map(r=><button key={r.d} onClick={()=>setRange(r.d)} style={{padding:'6px 14px',borderRadius:8,border:'none',background:range===r.d?'rgba(198,163,78,.15)':'rgba(255,255,255,.03)',color:range===r.d?'#c6a34e':'#888',fontSize:11,cursor:'pointer'}}>{r.l}</button>)}
      </div>
    </div>

    {/* Legend */}
    <div style={{display:'flex',gap:12,marginBottom:16,flexWrap:'wrap'}}>
      {[{c:'#ef4444',l:'ONSS'},{c:'#a855f7',l:'Fiscal'},{c:'#22c55e',l:'Paie/RH'},{c:'#eab308',l:'Contrats'},{c:'#c6a34e',l:'Anniversaires'}].map(l=><div key={l.l} style={{display:'flex',alignItems:'center',gap:4}}>
        <div style={{width:8,height:8,borderRadius:'50%',background:l.c}}/>
        <span style={{fontSize:10,color:'#888'}}>{l.l}</span>
      </div>)}
    </div>

    {/* Timeline */}
    <div style={{position:'relative',paddingLeft:20}}>
      <div style={{position:'absolute',left:9,top:0,bottom:0,width:2,background:'rgba(198,163,78,.1)'}}/>
      {Object.entries(grouped).map(([date,evts],gi)=>{
        const d=evts[0].date;
        const isToday=d.toDateString()===now.toDateString();
        const isPast=d<now;
        return <div key={gi} style={{marginBottom:16,position:'relative'}}>
          {/* Date marker */}
          <div style={{position:'absolute',left:-15,top:4,width:10,height:10,borderRadius:'50%',background:isToday?'#c6a34e':isPast?'#888':'#e5e5e5',border:'2px solid '+(isToday?'#c6a34e':'rgba(255,255,255,.1)'),zIndex:1}}/>
          <div style={{marginLeft:10}}>
            <div style={{fontSize:11,fontWeight:600,color:isToday?'#c6a34e':isPast?'#888':'#e5e5e5',marginBottom:4}}>
              {isToday&&'🔴 '}
              {d.toLocaleDateString('fr-BE',{weekday:'short',day:'numeric',month:'long',year:'numeric'})}
            </div>
            {evts.map((ev,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'6px 10px',marginBottom:2,background:isToday?'rgba(198,163,78,.04)':isPast?'rgba(255,255,255,.01)':'rgba(255,255,255,.02)',borderRadius:8,borderLeft:'3px solid '+ev.color,opacity:isPast?0.6:1}}>
              <span style={{fontSize:16}}>{ev.icon}</span>
              <div style={{flex:1}}>
                <div style={{fontSize:11,fontWeight:500,color:isPast?'#888':'#e5e5e5'}}>{ev.title}</div>
                {ev.desc&&<div style={{fontSize:9,color:'#888'}}>{ev.desc}</div>}
              </div>
              <span style={{fontSize:9,padding:'2px 6px',borderRadius:4,background:ev.color+'15',color:ev.color}}>{ev.cat}</span>
            </div>)}
          </div>
        </div>;
      })}
    </div>
  </div>;
};

const SepaGenerator=({s})=>{
  const clients=s.clients||[];
  const [selClient,setSelClient]=useState('all');
  const [execDate,setExecDate]=useState(new Date(new Date().setDate(25)).toISOString().slice(0,10));
  const [generated,setGenerated]=useState(null);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const prevMonth=new Date().getMonth()===0?11:new Date().getMonth()-1;
  const prevYear=new Date().getMonth()===0?new Date().getFullYear()-1:new Date().getFullYear();

  const getPayments=()=>{
    const payments=[];
    const targetClients=selClient==='all'?clients:clients.filter(c=>c.company?.name===selClient);
    targetClients.forEach(cl=>{
      const co=cl.company||{};
      (cl.emps||[]).forEach(e=>{
        const brut=+(e.monthlySalary||e.gross||0);
        if(brut<=0) return;
        const onss=Math.round(brut*TX_ONSS_W*100)/100;
        const imp=brut-onss;
        const pp=quickPP(brut);
        const net=Math.round((imp-pp)*100)/100;
        const iban=(e.iban||e.IBAN||'').replace(/\s/g,'');
        payments.push({
          name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),
          iban,bic:e.bic||'',
          amount:net,brut,
          ref:'SAL-'+mois[prevMonth].substring(0,3).toUpperCase()+prevYear+'-'+(e.id||e.niss||'').substring(0,6),
          client:co.name||'',clientIBAN:co.iban||'',clientBIC:co.bic||'',clientName:co.name||'',
          valid:iban.length>=16&&net>0,
          email:e.email||''
        });
      });
    });
    return payments;
  };

  const generateSEPA=()=>{
    const payments=getPayments().filter(p=>p.valid);
    if(payments.length===0){alert('Aucun virement valide (verifier IBAN)');return;}
    const totalAmount=payments.reduce((a,p)=>a+p.amount,0);
    const msgId='AUREUS-'+Date.now();
    const now=new Date().toISOString();

    // Generate SEPA Credit Transfer XML (pain.001.001.03)
    let xml='<?xml version="1.0" encoding="UTF-8"?>\n';
    xml+='<Document xmlns="urn:iso:std:iso:20022:tech:xsd:pain.001.001.03">\n';
    xml+='<CstmrCdtTrfInitn>\n';
    xml+='  <GrpHdr>\n';
    xml+='    <MsgId>'+msgId+'</MsgId>\n';
    xml+='    <CreDtTm>'+now+'</CreDtTm>\n';
    xml+='    <NbOfTxs>'+payments.length+'</NbOfTxs>\n';
    xml+='    <CtrlSum>'+totalAmount.toFixed(2)+'</CtrlSum>\n';
    xml+='    <InitgPty><Nm>Aureus Social Pro</Nm></InitgPty>\n';
    xml+='  </GrpHdr>\n';
    xml+='  <PmtInf>\n';
    xml+='    <PmtInfId>'+msgId+'-PMT</PmtInfId>\n';
    xml+='    <PmtMtd>TRF</PmtMtd>\n';
    xml+='    <NbOfTxs>'+payments.length+'</NbOfTxs>\n';
    xml+='    <CtrlSum>'+totalAmount.toFixed(2)+'</CtrlSum>\n';
    xml+='    <PmtTpInf><SvcLvl><Cd>SEPA</Cd></SvcLvl></PmtTpInf>\n';
    xml+='    <ReqdExctnDt>'+execDate+'</ReqdExctnDt>\n';
    xml+='    <Dbtr><Nm>'+(payments[0].clientName||'Employeur')+'</Nm></Dbtr>\n';
    xml+='    <DbtrAcct><Id><IBAN>'+(payments[0].clientIBAN||'BE00000000000000')+'</IBAN></Id></DbtrAcct>\n';
    xml+='    <DbtrAgt><FinInstnId><BIC>'+(payments[0].clientBIC||'GEBABEBB')+'</BIC></FinInstnId></DbtrAgt>\n';
    xml+='    <ChrgBr>SLEV</ChrgBr>\n';
    
    payments.forEach(p=>{
      xml+='    <CdtTrfTxInf>\n';
      xml+='      <PmtId><EndToEndId>'+p.ref+'</EndToEndId></PmtId>\n';
      xml+='      <Amt><InstdAmt Ccy="EUR">'+p.amount.toFixed(2)+'</InstdAmt></Amt>\n';
      xml+='      <CdtrAgt><FinInstnId><BIC>'+(p.bic||'GEBABEBB')+'</BIC></FinInstnId></CdtrAgt>\n';
      xml+='      <Cdtr><Nm>'+p.name+'</Nm></Cdtr>\n';
      xml+='      <CdtrAcct><Id><IBAN>'+p.iban+'</IBAN></Id></CdtrAcct>\n';
      xml+='      <RmtInf><Ustrd>Salaire '+mois[prevMonth]+' '+prevYear+'</Ustrd></RmtInf>\n';
      xml+='    </CdtTrfTxInf>\n';
    });
    
    xml+='  </PmtInf>\n';
    xml+='</CstmrCdtTrfInitn>\n';
    xml+='</Document>';

    setGenerated({xml,payments,totalAmount,msgId,date:execDate});

    // Download XML
    try{
      const blob=new Blob([xml],{type:'application/xml;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download='SEPA_Salaires_'+mois[prevMonth]+'_'+prevYear+'.xml';
      document.body.appendChild(a);a.click();document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }catch(e){}
  };

  const allPayments=getPayments();
  const validCount=allPayments.filter(p=>p.valid).length;
  const invalidCount=allPayments.length-validCount;
  const totalNet=allPayments.filter(p=>p.valid).reduce((a,p)=>a+p.amount,0);

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>💳 Generateur SEPA</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Fichier XML pain.001 — Virements salaires {mois[prevMonth]} {prevYear}</p>
      </div>
    </div>

    {/* Config */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:16}}>
      <div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:12}}>
        <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Client</label>
        <select value={selClient} onChange={e=>setSelClient(e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}>
          <option value="all">Tous les clients</option>
          {clients.map((c,i)=><option key={i} value={c.company?.name}>{c.company?.name}</option>)}
        </select>
      </div>
      <div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:12}}>
        <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Date execution SEPA</label>
        <input type="date" value={execDate} onChange={e=>setExecDate(e.target.value)} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit'}}/>
      </div>
      <div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(34,197,94,.15)',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:9,color:'#888'}}>Virements valides</div>
        <div style={{fontSize:24,fontWeight:700,color:'#22c55e'}}>{validCount}</div>
        {invalidCount>0&&<div style={{fontSize:9,color:'#ef4444'}}>{invalidCount} sans IBAN</div>}
      </div>
      <div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:9,color:'#888'}}>Montant total</div>
        <div style={{fontSize:20,fontWeight:700,color:'#c6a34e'}}>{f2(totalNet)} EUR</div>
      </div>
    </div>

    <button onClick={generateSEPA} disabled={validCount===0} style={{padding:'14px 28px',borderRadius:12,border:'none',background:validCount>0?'linear-gradient(135deg,#c6a34e,#e2c878)':'#333',color:validCount>0?'#060810':'#888',fontWeight:800,fontSize:14,cursor:validCount>0?'pointer':'not-allowed',marginBottom:16}}>
      💳 Generer fichier SEPA XML ({validCount} virements — {f2(totalNet)} EUR)
    </button>

    {generated&&<div style={{padding:14,background:'rgba(34,197,94,.05)',border:'1px solid rgba(34,197,94,.15)',borderRadius:12,marginBottom:16}}>
      <div style={{fontSize:13,fontWeight:600,color:'#22c55e',marginBottom:6}}>✅ Fichier SEPA genere et telecharge !</div>
      <div style={{fontSize:10,color:'#888'}}>ID: {generated.msgId} | {generated.payments.length} virements | {f2(generated.totalAmount)} EUR | Execution: {generated.date}</div>
    </div>}

    {/* Payments table */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'30px 140px 110px 160px 90px 90px 80px',padding:'8px 12px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
        <div></div><div>Beneficiaire</div><div>Client</div><div>IBAN</div><div>Brut</div><div>Net</div><div>Ref</div>
      </div>
      <div style={{maxHeight:400,overflowY:'auto'}}>
        {allPayments.map((p,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'30px 140px 110px 160px 90px 90px 80px',padding:'6px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center',opacity:p.valid?1:.5}}>
          <div>{p.valid?'✅':'❌'}</div>
          <div style={{color:'#e5e5e5',fontWeight:500}}>{p.name}</div>
          <div style={{color:'#888',fontSize:10}}>{p.client}</div>
          <div style={{color:p.iban?'#888':'#ef4444',fontSize:10,fontFamily:'monospace'}}>{p.iban||'MANQUANT'}</div>
          <div style={{color:'#888'}}>{f2(p.brut)}</div>
          <div style={{color:'#22c55e',fontWeight:600}}>{f2(p.amount)}</div>
          <div style={{color:'#888',fontSize:9}}>{p.ref}</div>
        </div>)}
      </div>
    </div>
  </div>;
};

// ═══ 2. SMART ALERTS — Alertes proactives temps reel ═══
const SmartAlerts=({s})=>{
  const clients=s.clients||[];
  const now=new Date();
  const [filter,setFilter]=useState('all');

  // Generate all alerts automatically
  const alerts=[];
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];

  // Deadline alerts
  const day=now.getDate();
  const month=now.getMonth();
  if(day<=5) alerts.push({type:'urgent',cat:'ONSS',title:'ONSS provisoire',desc:'Paiement ONSS du avant le 5 '+mois[month],deadline:5-day,icon:'🏛'});
  if(day<=15) alerts.push({type:day<=10?'urgent':'warn',cat:'Fiscal',title:'Précompte professionnel',desc:'Versement PP du avant le 15 '+mois[month],deadline:15-day,icon:'💰'});
  if(day<=25) alerts.push({type:day<=20?'warn':'info',cat:'Paie',title:'Virements salaires',desc:'SEPA a executer avant le 25 '+mois[month],deadline:25-day,icon:'💳'});
  if(day<=28) alerts.push({type:day<=25?'info':'warn',cat:'Paie',title:'Distribution fiches',desc:'Fiches de paie a distribuer avant fin de mois',deadline:28-day,icon:'📄'});

  // Quarterly
  if([0,3,6,9].includes(month)&&day<=10){
    alerts.push({type:'urgent',cat:'ONSS',title:'DmfA trimestrielle',desc:'Declaration DmfA T'+Math.ceil((month+1)/3)+' a soumettre',deadline:10-day,icon:'🏛'});
  }

  // Annual
  if(month===1&&day<=28) alerts.push({type:'urgent',cat:'Fiscal',title:'Belcotax 281.10',desc:'Fiches fiscales avant le 1er mars',deadline:28-day+(month===1?0:0),icon:'🧾'});
  if(month===11&&day<=20) alerts.push({type:'urgent',cat:'Paie',title:'13eme mois',desc:'Versement prime fin annee avant le 20 dec',deadline:20-day,icon:'🎄'});

  // Employee alerts
  clients.forEach(cl=>{
    const co=cl.company||{};
    (cl.emps||[]).forEach(e=>{
      const name=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
      // CDD expiring
      if((e.contractType||'')=='CDD'){
        const end=new Date(e.endDate||e.end||'2099-12-31');
        const daysLeft=Math.ceil((end-now)/86400000);
        if(daysLeft<0) alerts.push({type:'urgent',cat:'Contrat',title:'CDD expire — '+name,desc:co.name+' — Expire depuis '+Math.abs(daysLeft)+' jours',deadline:daysLeft,icon:'🔴',emp:name});
        else if(daysLeft<=30) alerts.push({type:'warn',cat:'Contrat',title:'CDD expire bientot — '+name,desc:co.name+' — '+daysLeft+' jours restants',deadline:daysLeft,icon:'🟡',emp:name});
        else if(daysLeft<=90) alerts.push({type:'info',cat:'Contrat',title:'CDD a surveiller — '+name,desc:co.name+' — '+daysLeft+' jours restants',deadline:daysLeft,icon:'🔵',emp:name});
      }
      // Period end probation (6 months)
      const start=new Date(e.startDate||e.start||'2020-01-01');
      const monthsIn=Math.round((now-start)/2592000000);
      if(monthsIn>=5&&monthsIn<=6) alerts.push({type:'info',cat:'RH',title:'Fin periode essai — '+name,desc:co.name+' — '+monthsIn+' mois (evaluation?)',deadline:180-Math.ceil((now-start)/86400000),icon:'📋',emp:name});
      // Anniversary
      const startMonth=start.getMonth();const startDay=start.getDate();
      if(startMonth===month&&startDay>=day&&startDay<=day+14&&(now.getFullYear()-start.getFullYear())>0){
        alerts.push({type:'info',cat:'RH',title:'Anniversaire '+( now.getFullYear()-start.getFullYear())+' an(s) — '+name,desc:co.name,deadline:startDay-day,icon:'🎂',emp:name});
      }
      // No salary
      if(+(e.monthlySalary||e.gross||0)<=0) alerts.push({type:'urgent',cat:'Paie',title:'Salaire = 0 — '+name,desc:co.name+' — Aucun salaire brut defini',deadline:0,icon:'❌',emp:name});
      // Missing IBAN
      if(!(e.iban||e.IBAN)) alerts.push({type:'warn',cat:'Paie',title:'IBAN manquant — '+name,desc:co.name+' — Virement impossible',deadline:0,icon:'🏦',emp:name});
    });
  });

  // Sort: urgent first, then by deadline
  alerts.sort((a,b)=>{
    const pri={urgent:0,warn:1,info:2};
    if(pri[a.type]!==pri[b.type]) return pri[a.type]-pri[b.type];
    return (a.deadline||999)-(b.deadline||999);
  });

  const filtered=filter==='all'?alerts:filter==='urgent'?alerts.filter(a=>a.type==='urgent'):alerts.filter(a=>a.cat===filter);
  const cats=[...new Set(alerts.map(a=>a.cat))];
  const urgentCount=alerts.filter(a=>a.type==='urgent').length;

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🔔 Smart Alerts</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Alertes proactives — {alerts.length} alertes dont {urgentCount} urgentes</p>
      </div>
      {urgentCount>0&&<div style={{padding:'8px 16px',borderRadius:20,background:'rgba(239,68,68,.1)',border:'1px solid rgba(239,68,68,.2)',color:'#ef4444',fontWeight:700,fontSize:13,animation:'pulse 2s infinite'}}>
        {urgentCount} URGENTE{urgentCount>1?'S':''}
      </div>}
    </div>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Total',v:alerts.length,c:'#c6a34e',f:'all'},{l:'Urgentes',v:urgentCount,c:'#ef4444',f:'urgent'},...cats.slice(0,3).map(c=>({l:c,v:alerts.filter(a=>a.cat===c).length,c:'#888',f:c}))].map((k,i)=>
        <button key={i} onClick={()=>setFilter(k.f)} style={{padding:12,borderRadius:10,border:filter===k.f?'2px solid '+k.c:'1px solid rgba(255,255,255,.05)',background:filter===k.f?k.c+'10':'linear-gradient(135deg,#0d1117,#131820)',cursor:'pointer',textAlign:'center'}}>
          <div style={{fontSize:20,fontWeight:700,color:k.c}}>{k.v}</div>
          <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
        </button>
      )}
    </div>

    {/* Alerts list */}
    <div style={{display:'flex',flexDirection:'column',gap:6}}>
      {filtered.map((a,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',background:a.type==='urgent'?'rgba(239,68,68,.04)':a.type==='warn'?'rgba(234,179,8,.03)':'rgba(59,130,246,.02)',border:'1px solid '+(a.type==='urgent'?'rgba(239,68,68,.15)':a.type==='warn'?'rgba(234,179,8,.1)':'rgba(59,130,246,.08)'),borderRadius:12}}>
        <div style={{fontSize:22}}>{a.icon}</div>
        <div style={{flex:1}}>
          <div style={{fontSize:12,fontWeight:600,color:a.type==='urgent'?'#ef4444':a.type==='warn'?'#eab308':'#e5e5e5'}}>{a.title}</div>
          <div style={{fontSize:10,color:'#888'}}>{a.desc}</div>
        </div>
        <div style={{textAlign:'right'}}>
          <span style={{fontSize:9,padding:'3px 8px',borderRadius:6,background:a.cat==='ONSS'?'rgba(239,68,68,.1)':a.cat==='Fiscal'?'rgba(168,85,247,.1)':a.cat==='Paie'?'rgba(34,197,94,.1)':'rgba(59,130,246,.1)',color:a.cat==='ONSS'?'#ef4444':a.cat==='Fiscal'?'#a855f7':a.cat==='Paie'?'#22c55e':'#3b82f6',fontWeight:600}}>{a.cat}</span>
          {typeof a.deadline==='number'&&a.deadline>=0&&<div style={{fontSize:10,color:a.deadline<=3?'#ef4444':a.deadline<=7?'#eab308':'#888',fontWeight:600,marginTop:4}}>J-{a.deadline}</div>}
          {typeof a.deadline==='number'&&a.deadline<0&&<div style={{fontSize:10,color:'#ef4444',fontWeight:700,marginTop:4}}>RETARD {Math.abs(a.deadline)}j</div>}
        </div>
      </div>)}
      {filtered.length===0&&<div style={{padding:40,textAlign:'center',color:'#888'}}>Aucune alerte dans cette categorie</div>}
    </div>
  </div>;
};

// ═══ 3. BATCH DECLARATIONS — Dimona / DmfA en masse ═══
const BatchDeclarations=({s})=>{
  const clients=s.clients||[];
  const [declType,setDeclType]=useState('dimona_in');
  const [logs,setLogs]=useState([]);
  const [running,setRunning]=useState(false);
  const now=new Date();
  const mois=['Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre'];
  const quarter=Math.ceil((now.getMonth()+1)/3);
  const addLog=(msg,type='info')=>setLogs(p=>[{msg,type,time:new Date().toLocaleTimeString('fr-BE'),id:Date.now()+Math.random()},...p]);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const types=[
    {id:'dimona_in',icon:'🟢',label:'Dimona IN — Entrees',desc:'Declarations entree en service'},
    {id:'dimona_out',icon:'🔴',label:'Dimona OUT — Sorties',desc:'Declarations sortie de service'},
    {id:'dmfa',icon:'🏛',label:'DmfA T'+quarter,desc:'Déclaration trimestrielle ONSS'},
    {id:'belcotax',icon:'🧾',label:'Belcotax 281.10',desc:'Fiches fiscales annuelles'},
  ];

  const runBatch=async()=>{
    setRunning(true);setLogs([]);
    const delay=ms=>new Promise(r=>setTimeout(r,ms));

    if(declType==='dimona_in'){
      addLog('🟢 BATCH DIMONA IN — Scanning nouvelles entrees...','info');
      await delay(300);
      let count=0;
      for(const cl of clients){
        for(const e of (cl.emps||[])){
          const start=new Date(e.startDate||e.start||'2020-01-01');
          if((now-start)<90*86400000&&!e.dimonaDone){
            count++;
            addLog('📋 Dimona IN: '+(e.first||'')+' '+(e.last||'')+' — '+(cl.company?.name||'')+' — NISS: '+(e.niss||'N/A')+' — Debut: '+(e.startDate||'N/A'),'success');
            await delay(100);
          }
        }
      }
      addLog(count>0?'✅ '+count+' declaration(s) Dimona IN preparee(s)':'✅ Aucune nouvelle entree a declarer','success');

    } else if(declType==='dimona_out'){
      addLog('🔴 BATCH DIMONA OUT — Scanning fins de contrat...','info');
      await delay(300);
      let count=0;
      for(const cl of clients){
        for(const e of (cl.emps||[])){
          if((e.contractType||'')==='CDD'){
            const end=new Date(e.endDate||e.end||'2099-12-31');
            if(end<now){
              count++;
              addLog('📋 Dimona OUT: '+(e.first||'')+' '+(e.last||'')+' — Fin: '+end.toLocaleDateString('fr-BE'),'success');
              await delay(100);
            }
          }
        }
      }
      addLog(count>0?'✅ '+count+' declaration(s) Dimona OUT preparee(s)':'✅ Aucune sortie a declarer','success');

    } else if(declType==='dmfa'){
      addLog('🏛 BATCH DmfA T'+quarter+' '+now.getFullYear()+' — Generation...','info');
      await delay(300);
      for(const cl of clients){
        const emps=cl.emps||[];
        if(emps.length===0) continue;
        const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0))*3,0);
        const onssW=Math.round(totalBrut*TX_ONSS_W*100)/100;
        const onssE=Math.round(totalBrut*TX_ONSS_E*100)/100;
        addLog('🏛 '+(cl.company?.name||'Client')+' — '+emps.length+' travailleurs — Brut T'+quarter+': '+f2(totalBrut)+' EUR — ONSS: '+f2(onssW+onssE)+' EUR','success');
        await delay(150);
      }
      addLog('✅ DmfA T'+quarter+' preparee pour '+clients.length+' employeur(s)','success');
      
      // Generate DmfA XML preview
      const totalEmps=clients.reduce((a,c)=>a+(c.emps||[]).length,0);
      const totalBrut=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+(+(e.monthlySalary||e.gross||0))*3,0),0);
      const html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:11px;padding:30px;max-width:900px;margin:auto}h1{text-align:center;font-size:18px;color:#1a365d;margin-bottom:15px}table{width:100%;border-collapse:collapse;margin:10px 0}th{background:#f0ece3;padding:6px 8px;font-size:10px;text-align:left}td{padding:5px 8px;border-bottom:1px solid #eee;font-size:10px}.total{background:#f8f7f4;font-weight:700}.r{text-align:right;font-family:monospace}@media print{button{display:none!important}}</style></head><body>'+
      '<div style="text-align:center;font-size:22px;font-weight:800;color:#c6a34e;font-family:Georgia,serif;margin-bottom:5px">AUREUS SOCIAL PRO</div>'+
      '<h1>DECLARATION DmfA — T'+quarter+' '+now.getFullYear()+'</h1>'+
      '<p style="text-align:center;color:#666;margin-bottom:20px">'+totalEmps+' travailleurs | '+clients.length+' employeur(s) | Masse brute: '+f2(totalBrut)+' EUR</p>'+
      clients.map(cl=>{
        const emps=cl.emps||[];
        const co=cl.company||{};
        return '<h2 style="font-size:13px;border-bottom:2px solid #c6a34e;padding:8px 0 4px;margin-top:20px">'+co.name+' ('+co.vat+')</h2>'+
        '<table><tr><th>Nom</th><th>NISS</th><th>Statut</th><th class="r">Brut T'+quarter+'</th><th class="r">ONSS W</th><th class="r">ONSS P</th></tr>'+
        emps.map(e=>{
          const b=(+(e.monthlySalary||e.gross||0))*3;
          return '<tr><td>'+(e.first||'')+' '+(e.last||'')+'</td><td>'+(e.niss||'N/A')+'</td><td>'+(e.contractType||'CDI')+'</td><td class="r">'+f2(b)+'</td><td class="r">'+f2(b*TX_ONSS_W)+'</td><td class="r">'+f2(b*TX_ONSS_E)+'</td></tr>';
        }).join('')+
        '<tr class="total"><td colspan="3">Total '+co.name+'</td><td class="r">'+f2(emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0))*3,0))+'</td><td class="r">'+f2(emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0))*3,0)*TX_ONSS_W)+'</td><td class="r">'+f2(emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||0))*3,0)*TX_ONSS_E)+'</td></tr></table>';
      }).join('')+
      '<div style="text-align:center;margin:20px 0"><button onclick="window.print()" style="background:#c6a34e;color:#fff;border:none;padding:10px 30px;border-radius:6px;cursor:pointer;font-weight:600">Imprimer</button></div></body></html>';
      previewHTML(html,'DmfA_T'+quarter+'_'+now.getFullYear());

    } else if(declType==='belcotax'){
      addLog('🧾 BATCH BELCOTAX 281.10 — Generation fiches fiscales...','info');
      await delay(300);
      for(const cl of clients){
        for(const e of (cl.emps||[])){
          const brut=(+(e.monthlySalary||e.gross||0))*12;
          if(brut<=0) continue;
          addLog('🧾 281.10: '+(e.first||'')+' '+(e.last||'')+' — Brut annuel: '+f2(brut)+' EUR — ONSS: '+f2(brut*TX_ONSS_W)+' EUR','success');
          await delay(50);
        }
      }
      addLog('✅ Belcotax 281.10 prepare pour '+(now.getFullYear()-1),'success');
    }

    setRunning(false);
  };

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📋 Declarations en Masse</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Dimona, DmfA, Belcotax — Generation batch pour tous les clients</p>

    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:20}}>
      {types.map(t=><button key={t.id} onClick={()=>setDeclType(t.id)} style={{padding:14,borderRadius:12,border:declType===t.id?'2px solid #c6a34e':'1px solid rgba(255,255,255,.05)',background:declType===t.id?'rgba(198,163,78,.08)':'rgba(255,255,255,.02)',cursor:'pointer',textAlign:'left'}}>
        <div style={{fontSize:18,marginBottom:4}}>{t.icon}</div>
        <div style={{fontSize:12,fontWeight:600,color:declType===t.id?'#c6a34e':'#e5e5e5'}}>{t.label}</div>
        <div style={{fontSize:9,color:'#888'}}>{t.desc}</div>
      </button>)}
    </div>

    <button onClick={runBatch} disabled={running} style={{padding:'14px 28px',borderRadius:12,border:'none',background:running?'#333':'linear-gradient(135deg,#c6a34e,#e2c878)',color:running?'#888':'#060810',fontWeight:800,fontSize:14,cursor:running?'wait':'pointer',marginBottom:16}}>
      {running?'En cours...':'🚀 Lancer '+types.find(t=>t.id===declType)?.label}
    </button>

    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',display:'flex',justifyContent:'space-between'}}>
        <span style={{fontSize:12,fontWeight:600,color:'#c6a34e'}}>Execution</span>
        <button onClick={()=>setLogs([])} style={{padding:'3px 10px',borderRadius:5,border:'none',background:'rgba(255,255,255,.05)',color:'#888',fontSize:9,cursor:'pointer'}}>Effacer</button>
      </div>
      <div style={{maxHeight:400,overflowY:'auto',padding:'8px 12px'}}>
        {logs.length===0?<div style={{padding:30,textAlign:'center',color:'#888',fontSize:11}}>Selectionnez un type et lancez</div>:
        logs.map(l=><div key={l.id} style={{padding:'4px 8px',marginBottom:1,fontSize:10,color:l.type==='success'?'#22c55e':l.type==='error'?'#ef4444':l.type==='warn'?'#eab308':'#888',borderLeft:'2px solid '+(l.type==='success'?'#22c55e':l.type==='error'?'#ef4444':'#333'),paddingLeft:10}}>
          <span style={{color:'#555',marginRight:6}}>{l.time}</span>{l.msg}
        </div>)}
      </div>
    </div>
  </div>;
};

const ComplianceRadar=({s,d})=>{
  const clients=s.clients||[];
  const now=new Date();
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  const checkClient=(cl)=>{
    const co=cl.company||{};
    const emps=cl.emps||[];
    const checks=[];
    const score={total:0,passed:0};

    // 1. Company data
    const hasVAT=!!co.vat;
    const hasName=!!co.name;
    const hasAddress=!!co.address;
    const hasCP=!!co.cp;
    checks.push({cat:'Entreprise',item:'Nom',ok:hasName,fix:'Ajouter le nom'});
    checks.push({cat:'Entreprise',item:'TVA/BCE',ok:hasVAT,fix:'Ajouter le numero BCE'});
    checks.push({cat:'Entreprise',item:'Adresse',ok:hasAddress,fix:'Ajouter adresse siege social'});
    checks.push({cat:'Entreprise',item:'Commission paritaire',ok:hasCP,fix:'Definir la CP'});

    // 2. Per employee checks
    emps.forEach(e=>{
      const name=(e.first||e.fn||'')+'.'+(e.last||e.ln||'');
      const brut=+(e.monthlySalary||e.gross||0);
      
      // Identity
      checks.push({cat:'Identite',item:name+' — NISS',ok:!!(e.niss||e.NISS),fix:'NISS manquant',emp:name});
      checks.push({cat:'Identite',item:name+' — IBAN',ok:!!(e.iban||e.IBAN),fix:'IBAN manquant',emp:name});
      checks.push({cat:'Identite',item:name+' — Email',ok:!!e.email,fix:'Email manquant',emp:name});
      
      // Contract
      checks.push({cat:'Contrat',item:name+' — Type',ok:!!(e.contractType||e.contrat),fix:'Type contrat non defini',emp:name});
      checks.push({cat:'Contrat',item:name+' — Date debut',ok:!!(e.startDate||e.start),fix:'Date entree manquante',emp:name});
      checks.push({cat:'Contrat',item:name+' — Salaire',ok:brut>0,fix:'Salaire brut = 0',emp:name,critical:true});
      
      // CDD expiry
      if((e.contractType||'')=='CDD'){
        const end=new Date(e.endDate||e.end||'2099-12-31');
        checks.push({cat:'Contrat',item:name+' — CDD valide',ok:end>now,fix:'CDD expire le '+end.toLocaleDateString('fr-BE'),emp:name,critical:end<now});
      }
      
      // Dimona
      const start=new Date(e.startDate||e.start||'2020-01-01');
      if((now-start)<90*86400000){
        checks.push({cat:'ONSS',item:name+' — Dimona IN',ok:!!e.dimonaDone,fix:'Verifier declaration Dimona',emp:name});
      }
      
      // Medical
      const lastMed=e.medicalDate?new Date(e.medicalDate):null;
      checks.push({cat:'Sante',item:name+' — Medecine travail',ok:lastMed&&(now-lastMed)<365*86400000,fix:'Visite annuelle a planifier',emp:name});
      
      // RMMMG
      if(brut>0&&brut<1900){
        checks.push({cat:'Salaire',item:name+' — RMMMG',ok:false,fix:'Brut '+f2(brut)+' < RMMMG 1.900',emp:name});
      }
    });

    checks.forEach(c=>{score.total++;if(c.ok)score.passed++;});
    const pct=score.total>0?Math.round(score.passed/score.total*100):0;
    return {name:co.name||'Client',vat:co.vat||'',emps:emps.length,checks,score,pct};
  };

  const results=clients.map(checkClient);
  const globalScore=results.reduce((a,r)=>({t:a.t+r.score.total,p:a.p+r.score.passed}),{t:0,p:0});
  const globalPct=globalScore.t>0?Math.round(globalScore.p/globalScore.t*100):0;
  const [selClient,setSelClient]=useState(0);
  const [filter,setFilter]=useState('all');

  const sel=results[selClient]||results[0];
  const filteredChecks=sel?(filter==='all'?sel.checks:filter==='fail'?sel.checks.filter(c=>!c.ok):sel.checks.filter(c=>c.cat===filter)):[];

  const cats=[...new Set((sel?.checks||[]).map(c=>c.cat))];

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🛡 Compliance Radar</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Conformite en temps reel — Chaque obligation verifiee</p>
      </div>
      <div style={{textAlign:'center'}}>
        <div style={{fontSize:36,fontWeight:800,color:globalPct>=90?'#22c55e':globalPct>=70?'#eab308':'#ef4444'}}>{globalPct}%</div>
        <div style={{fontSize:10,color:'#888'}}>Score global</div>
      </div>
    </div>

    {/* Client cards */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:20}}>
      {results.map((r,i)=><div key={i} onClick={()=>setSelClient(i)} style={{padding:14,borderRadius:12,cursor:'pointer',background:selClient===i?'rgba(198,163,78,.08)':'linear-gradient(135deg,#0d1117,#131820)',border:selClient===i?'2px solid #c6a34e':'1px solid rgba(255,255,255,.05)',transition:'all .15s'}}>
        <div style={{fontSize:13,fontWeight:600,color:selClient===i?'#c6a34e':'#e5e5e5',marginBottom:4}}>{r.name}</div>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span style={{fontSize:10,color:'#888'}}>{r.emps} emp.</span>
          <div style={{fontSize:18,fontWeight:700,color:r.pct>=90?'#22c55e':r.pct>=70?'#eab308':'#ef4444'}}>{r.pct}%</div>
        </div>
        <div style={{height:4,background:'rgba(255,255,255,.05)',borderRadius:2,marginTop:6,overflow:'hidden'}}>
          <div style={{height:'100%',width:r.pct+'%',borderRadius:2,background:r.pct>=90?'#22c55e':r.pct>=70?'#eab308':'#ef4444',transition:'width .5s'}}/>
        </div>
      </div>)}
    </div>

    {sel&&<div style={{display:'grid',gridTemplateColumns:'200px 1fr',gap:16}}>
      {/* Category filter */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:12,fontWeight:600,color:'#c6a34e'}}>Filtres</div>
        {[{id:'all',l:'Tout ('+sel.checks.length+')',c:'#c6a34e'},{id:'fail',l:'Echoues ('+sel.checks.filter(c=>!c.ok).length+')',c:'#ef4444'},...cats.map(c=>({id:c,l:c+' ('+sel.checks.filter(x=>x.cat===c).length+')',c:'#888'}))].map(f=><button key={f.id} onClick={()=>setFilter(f.id)} style={{display:'block',width:'100%',padding:'8px 14px',border:'none',borderLeft:filter===f.id?'3px solid '+f.c:'3px solid transparent',background:filter===f.id?'rgba(198,163,78,.04)':'transparent',color:filter===f.id?'#e5e5e5':'#888',fontSize:11,textAlign:'left',cursor:'pointer',fontFamily:'inherit'}}>{f.l}</button>)}
      </div>

      {/* Checks list */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',display:'flex',justifyContent:'space-between'}}>
          <span style={{fontSize:12,fontWeight:600,color:'#c6a34e'}}>{sel.name} — {filteredChecks.length} verifications</span>
          <span style={{fontSize:12,fontWeight:700,color:sel.pct>=90?'#22c55e':sel.pct>=70?'#eab308':'#ef4444'}}>{sel.score.passed}/{sel.score.total}</span>
        </div>
        <div style={{maxHeight:500,overflowY:'auto'}}>
          {filteredChecks.map((c,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',background:c.critical?'rgba(239,68,68,.03)':'transparent'}}>
            <div style={{fontSize:14,width:20}}>{c.ok?'✅':'❌'}</div>
            <div style={{flex:1}}>
              <div style={{fontSize:11,color:c.ok?'#888':'#e5e5e5',fontWeight:c.ok?400:500}}>{c.item}</div>
              {!c.ok&&<div style={{fontSize:9,color:'#ef4444'}}>Fix: {c.fix}</div>}
            </div>
            <span style={{fontSize:9,padding:'2px 6px',borderRadius:4,background:'rgba(255,255,255,.03)',color:'#888'}}>{c.cat}</span>
          </div>)}
        </div>
      </div>
    </div>}
  </div>;
};

// ═══ 2. AUTO-INDEXATION — Moteur indexation salariale belge ═══
const AutoIndexation=({s,d})=>{
  const clients=s.clients||[];
  const [indexRate,setIndexRate]=useState(2.0);
  const [applyDate,setApplyDate]=useState(new Date().getFullYear()+'-01-01');
  const [preview,setPreview]=useState(null);
  const [applied,setApplied]=useState(false);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);

  // Belgian CP index history (approximate)
  const indexHistory=[
    {date:'01/01/2026',cp:'200',rate:2.0,source:'Indice-sante'},
    {date:'01/01/2025',cp:'200',rate:2.0,source:'Indice-sante'},
    {date:'01/11/2024',cp:'200',rate:1.48,source:'Indice-sante'},
    {date:'01/01/2024',cp:'200',rate:1.88,source:'Indice-sante'},
    {date:'01/05/2023',cp:'200',rate:2.35,source:'Indice-sante'},
    {date:'01/01/2023',cp:'200',rate:11.08,source:'Indice-sante'},
  ];

  const calcPreview=()=>{
    const rate=indexRate/100;
    const results=[];
    let totalOldBrut=0,totalNewBrut=0,totalDiff=0;
    clients.forEach(cl=>{
      (cl.emps||[]).forEach(e=>{
        const oldBrut=+(e.monthlySalary||e.gross||0);
        if(oldBrut<=0) return;
        const newBrut=Math.round(oldBrut*(1+rate)*100)/100;
        const diff=newBrut-oldBrut;
        const oldNet=quickNet(oldBrut);
        const newNet=quickNet(newBrut);
        const oldCout=Math.round(oldBrut*(1+TX_ONSS_E)*100)/100;
        const newCout=Math.round(newBrut*(1+TX_ONSS_E)*100)/100;
        totalOldBrut+=oldBrut;totalNewBrut+=newBrut;totalDiff+=diff;
        results.push({name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),client:cl.company?.name||'',oldBrut,newBrut,diff,oldNet,newNet,oldCout,newCout,id:e.id||e.niss});
      });
    });
    setPreview({results,totalOldBrut,totalNewBrut,totalDiff,totalOldCout:Math.round(totalOldBrut*(1+TX_ONSS_E)*100)/100,totalNewCout:Math.round(totalNewBrut*(1+TX_ONSS_E)*100)/100});
  };

  const applyIndex=()=>{
    if(!preview) return;
    if(!confirm('Appliquer indexation de '+indexRate+'% a '+preview.results.length+' employes ?\nAugmentation totale: +'+f2(preview.totalDiff)+' EUR/mois\n\nCette action modifie les salaires bruts.')) return;
    const rate=indexRate/100;
    const updClients=clients.map(cl=>({
      ...cl,
      emps:(cl.emps||[]).map(e=>{
        const oldBrut=+(e.monthlySalary||e.gross||0);
        if(oldBrut<=0) return e;
        const newBrut=Math.round(oldBrut*(1+rate)*100)/100;
        return {...e,monthlySalary:newBrut,gross:newBrut,prevSalary:oldBrut,indexDate:applyDate,indexRate:indexRate};
      })
    }));
    d({type:'SET_CLIENTS',data:updClients});
    setApplied(true);
  };

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>📈 Auto-Indexation Salariale</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Indexation automatique selon indice-sante belge</p>
      </div>
    </div>

    <div style={{display:'grid',gridTemplateColumns:'340px 1fr',gap:16}}>
      {/* Config */}
      <div>
        <div style={{padding:18,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14,marginBottom:14}}>
          <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Paramètres</div>
          <div style={{marginBottom:10}}>
            <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Taux indexation (%)</label>
            <input type="number" step="0.01" value={indexRate} onChange={e=>setIndexRate(+e.target.value)} style={{width:'100%',padding:'10px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:16,fontWeight:700,fontFamily:'inherit',textAlign:'center'}}/>
          </div>
          <div style={{marginBottom:12}}>
            <label style={{fontSize:10,color:'#888',display:'block',marginBottom:3}}>Date application</label>
            <input type="date" value={applyDate} onChange={e=>setApplyDate(e.target.value)} style={{width:'100%',padding:'8px 12px',background:'#090c16',border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#e5e5e5',fontSize:12,fontFamily:'inherit'}}/>
          </div>
          <button onClick={calcPreview} style={{width:'100%',padding:'12px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontWeight:700,fontSize:13,cursor:'pointer',marginBottom:8}}>
            🔍 Simuler indexation
          </button>
          {preview&&!applied&&<button onClick={applyIndex} style={{width:'100%',padding:'12px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#22c55e,#16a34a)',color:'#fff',fontWeight:700,fontSize:13,cursor:'pointer'}}>
            ✅ Appliquer a {preview.results.length} employes
          </button>}
          {applied&&<div style={{padding:12,background:'rgba(34,197,94,.08)',border:'1px solid rgba(34,197,94,.2)',borderRadius:10,textAlign:'center',color:'#22c55e',fontWeight:600}}>✅ Indexation appliquee !</div>}
        </div>

        {/* History */}
        <div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>Historique indexation CP 200</div>
          {indexHistory.map((h,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'5px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:10}}>
            <span style={{color:'#888'}}>{h.date}</span>
            <span style={{color:h.rate>2?'#ef4444':'#22c55e',fontWeight:600}}>+{h.rate}%</span>
          </div>)}
        </div>
      </div>

      {/* Preview table */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        {!preview?<div style={{padding:60,textAlign:'center',color:'#888'}}>
          <div style={{fontSize:40,marginBottom:12}}>📈</div>
          <div style={{fontSize:14,fontWeight:600}}>Configurez le taux et cliquez "Simuler"</div>
          <div style={{fontSize:11,marginTop:4}}>Le systeme calculera automatiquement le nouveau brut, net et cout employeur</div>
        </div>:
        <div>
          {/* Totals */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:0,borderBottom:'2px solid rgba(198,163,78,.1)'}}>
            {[{l:'Masse brute actuelle',v:f2(preview.totalOldBrut),c:'#888'},
              {l:'Nouvelle masse brute',v:f2(preview.totalNewBrut),c:'#c6a34e'},
              {l:'Augmentation mensuelle',v:'+'+f2(preview.totalDiff),c:'#22c55e'},
              {l:'Cout annuel supplementaire',v:'+'+f2(preview.totalDiff*(1+TX_ONSS_E)*12),c:'#ef4444'},
            ].map((k,i)=><div key={i} style={{padding:14,textAlign:'center',borderRight:'1px solid rgba(255,255,255,.03)'}}>
              <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
              <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v} EUR</div>
            </div>)}
          </div>
          {/* Table */}
          <div style={{maxHeight:450,overflowY:'auto'}}>
            <div style={{display:'grid',gridTemplateColumns:'140px 100px 90px 90px 70px 90px 90px',padding:'8px 12px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
              <div>Employé</div><div>Client</div><div>Brut actuel</div><div>Nouveau brut</div><div>Diff</div><div>Ancien net</div><div>Nouveau net</div>
            </div>
            {preview.results.map((r,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'140px 100px 90px 90px 70px 90px 90px',padding:'6px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
              <div style={{color:'#e5e5e5',fontWeight:500}}>{r.name}</div>
              <div style={{color:'#888',fontSize:10}}>{r.client}</div>
              <div style={{color:'#888'}}>{f2(r.oldBrut)}</div>
              <div style={{color:'#c6a34e',fontWeight:600}}>{f2(r.newBrut)}</div>
              <div style={{color:'#22c55e',fontWeight:600}}>+{f2(r.diff)}</div>
              <div style={{color:'#888'}}>{f2(r.oldNet)}</div>
              <div style={{color:'#22c55e'}}>{f2(r.newNet)}</div>
            </div>)}
          </div>
        </div>}
      </div>
    </div>
  </div>;
};

// ═══ 3. HISTORIQUE PILOTE — Dashboard historique des runs ═══
const HistoriquePilote=({s,supabase})=>{
  const [history,setHistory]=useState([]);
  const [loading,setLoading]=useState(true);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const mois=['Jan','Fev','Mar','Avr','Mai','Jun','Jul','Aou','Sep','Oct','Nov','Dec'];

  useEffect(()=>{
    const load=async()=>{
      if(!supabase){
        // Generate mock history from client data
        const clients=s.clients||[];
        const totalEmps=clients.reduce((a,c)=>a+(c.emps||[]).length,0);
        const totalBrut=clients.reduce((a,c)=>a+(c.emps||[]).reduce((b,e)=>b+(+(e.monthlySalary||e.gross||0)),0),0);
        const mock=[];
        for(let i=0;i<6;i++){
          const d=new Date();
          d.setMonth(d.getMonth()-1-i);
          mock.push({
            month:d.getMonth()+1,year:d.getFullYear(),
            stats:{sent:totalEmps-Math.floor(Math.random()*3),failed:Math.floor(Math.random()*3),held:Math.floor(Math.random()*2),
              brut:totalBrut*(0.95+Math.random()*0.1),net:totalBrut*0.565*(0.95+Math.random()*0.1)},
            completedAt:d.toISOString(),status:'done'
          });
        }
        setHistory(mock);
        setLoading(false);
        return;
      }
      try{
        const {data}=await supabase.from('app_state').select('*').like('key','pilote_%').order('updated_at',{ascending:false}).limit(24);
        if(data){
          const h=data.map(r=>{
            const val=(()=>{try{return JSON.parse(r.val||{})}catch(e){return null}})();
            const parts=r.key.replace('pilote_','').split('_');
            return {month:+parts[1],year:+parts[0],...val};
          });
          setHistory(h);
        }
      }catch(e){console.error(e);}
      setLoading(false);
    };
    load();
  },[]);

  const totalSent=history.reduce((a,h)=>a+(h.stats?.sent||0),0);
  const totalBrut=history.reduce((a,h)=>a+(h.stats?.brut||0),0);
  const avgTime=history.length>0?'~2 min':'N/A';

  return <div style={{padding:24}}>
    <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:'0 0 4px'}}>📊 Historique Pilote Auto</h2>
    <p style={{fontSize:12,color:'#888',margin:'0 0 20px'}}>Suivi de toutes les executions du Pilote Automatique</p>

    {/* KPIs */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:20}}>
      {[{l:'Executions',v:history.length,c:'#c6a34e',i:'🔄'},
        {l:'Fiches envoyees',v:totalSent,c:'#22c55e',i:'📧'},
        {l:'Volume brut traite',v:f2(totalBrut)+' EUR',c:'#a855f7',i:'💰'},
        {l:'Temps moyen',v:avgTime,c:'#3b82f6',i:'⏱'},
      ].map((k,i)=><div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:9,color:'#888'}}>{k.i} {k.l}</div>
        <div style={{fontSize:20,fontWeight:700,color:k.c}}>{k.v}</div>
      </div>)}
    </div>

    {/* Chart-like visualization */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,padding:16,marginBottom:16}}>
      <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:12}}>Volume mensuel</div>
      <div style={{display:'flex',alignItems:'flex-end',gap:4,height:120}}>
        {history.slice().reverse().map((h,i)=>{
          const maxBrut=Math.max(...history.map(x=>x.stats?.brut||0));
          const pct=maxBrut>0?((h.stats?.brut||0)/maxBrut*100):0;
          return <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:4}}>
            <div style={{fontSize:8,color:'#888'}}>{f2(h.stats?.brut||0)}</div>
            <div style={{width:'100%',height:pct+'%',minHeight:4,background:'linear-gradient(180deg,#c6a34e,#a07d3e)',borderRadius:'4px 4px 0 0',transition:'height .5s'}}/>
            <div style={{fontSize:9,color:'#888'}}>{mois[(h.month||1)-1]}</div>
          </div>;
        })}
      </div>
    </div>

    {/* History table */}
    <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'100px 80px 80px 80px 120px 120px 1fr',padding:'8px 14px',background:'rgba(198,163,78,.04)',fontSize:9,fontWeight:600,color:'#c6a34e'}}>
        <div>Periode</div><div>Envoyees</div><div>Echouees</div><div>En attente</div><div>Masse brute</div><div>Net total</div><div>Date</div>
      </div>
      {loading?<div style={{padding:30,textAlign:'center',color:'#888'}}>Chargement...</div>:
      history.map((h,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'100px 80px 80px 80px 120px 120px 1fr',padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
        <div style={{color:'#c6a34e',fontWeight:600}}>{mois[(h.month||1)-1]} {h.year}</div>
        <div style={{color:'#22c55e',fontWeight:600}}>{h.stats?.sent||0}</div>
        <div style={{color:(h.stats?.failed||0)>0?'#ef4444':'#888'}}>{h.stats?.failed||0}</div>
        <div style={{color:(h.stats?.held||0)>0?'#eab308':'#888'}}>{h.stats?.held||0}</div>
        <div style={{color:'#e5e5e5'}}>{f2(h.stats?.brut||0)} EUR</div>
        <div style={{color:'#22c55e'}}>{f2(h.stats?.net||0)} EUR</div>
        <div style={{color:'#888',fontSize:10}}>{h.completedAt?new Date(h.completedAt).toLocaleDateString('fr-BE'):'-'}</div>
      </div>)}
    </div>
  </div>;
};

const PiloteAuto=({s,d,supabase,user})=>{
  const [phase,setPhase]=useState('idle'); // idle|scanning|review|sending|done
  const [scanResults,setScanResults]=useState(null);
  const [validations,setValidations]=useState({});
  const [attachments,setAttachments]=useState({});
  const [logs,setLogs]=useState([]);
  const [autoRunning,setAutoRunning]=useState(false);
  const [expandedFiche,setExpandedFiche]=useState(null);
  const [corrections,setCorrections]=useState({});
  const [sendProgress,setSendProgress]=useState({sent:0,total:0});
  
  const clients=s.clients||[];
  const allEmps=clients.reduce((a,c)=>[...a,...(c.emps||[]).map(e=>({...e,clientName:c.company?.name,company:c.company}))],[]);
  const now=new Date();
  const mois=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
  const prevMonth=now.getMonth()===0?11:now.getMonth()-1;
  const prevYear=now.getMonth()===0?now.getFullYear()-1:now.getFullYear();
  const periodeStr=mois[prevMonth]+' '+prevYear;
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  const delay=ms=>new Promise(r=>setTimeout(r,ms));

  const addLog=(msg,type='info')=>setLogs(p=>[{msg,type,time:new Date().toLocaleTimeString('fr-BE'),id:Date.now()+Math.random()},...p]);

  // ════════════════════════════════════════════
  // ═══ PHASE 1: SCAN AUTOMATIQUE COMPLET ═══
  // ════════════════════════════════════════════
  const runFullScan=async()=>{
    setPhase('scanning');
    setAutoRunning(true);
    setLogs([]);
    addLog('🚀 PILOTE AUTOMATIQUE — Scan complet lancé','info');
    addLog('📅 Période : '+periodeStr,'info');
    await delay(300);

    const fiches=[];
    const anomalies=[];
    const documents=[];
    const alertes=[];

    // ── 1. Scan all employees & calculate ──
    addLog('🔍 Phase 1/6 — Scan des employés...','info');
    await delay(200);
    for(const cl of clients){
      const co=cl.company||{};
      for(const e of (cl.emps||[])){
        const id=e.id||e.niss||((e.first||'')+'-'+(e.last||'')+'-'+Math.random().toString(36).substr(2,4));
        const name=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
        const brut=+(e.monthlySalary||e.gross||e.brut||0);

        // ── ANOMALY DETECTION ENGINE ──
        const empAnomalies=[];

        // A1: No salary
        if(brut<=0) empAnomalies.push({code:'A1',severity:'error',msg:'Pas de salaire brut défini',fix:'Définir le salaire dans la fiche employé'});
        // A2: Below minimum wage (CP200 = ~2029€ for 2026)
        if(brut>0&&brut<1900) empAnomalies.push({code:'A2',severity:'warn',msg:'Brut ('+f2(brut)+'€) inférieur au RMMMG (~1.900€)',fix:'Vérifier barème CP et ancienneté'});
        // A3: No NISS
        if(!e.niss&&!e.NISS) empAnomalies.push({code:'A3',severity:'warn',msg:'NISS manquant',fix:'Compléter le numéro national',doc:'attestation_identite'});
        // A4: No IBAN
        if(!e.iban&&!e.IBAN) empAnomalies.push({code:'A4',severity:'warn',msg:'IBAN manquant — Virement impossible',fix:'Demander RIB au travailleur',doc:'formulaire_iban'});
        // A5: No email
        if(!e.email) empAnomalies.push({code:'A5',severity:'info',msg:'Email manquant — Envoi fiche impossible',fix:'Demander email au travailleur'});
        // A6: No start date
        if(!e.startDate&&!e.start) empAnomalies.push({code:'A6',severity:'warn',msg:'Date d\'entrée manquante',fix:'Compléter la date de début',doc:'contrat_travail'});
        // A7: Contract expired (CDD)
        if((e.contractType||e.contrat)==='CDD'){
          const endDate=new Date(e.endDate||e.end||'2099-12-31');
          if(endDate<now) empAnomalies.push({code:'A7',severity:'error',msg:'CDD expiré le '+endDate.toLocaleDateString('fr-BE'),fix:'Renouveler ou transformer en CDI',doc:'avenant_contrat'});
          else if((endDate-now)<30*86400000) empAnomalies.push({code:'A7b',severity:'warn',msg:'CDD expire dans '+(Math.ceil((endDate-now)/86400000))+' jours',fix:'Préparer renouvellement',doc:'avenant_contrat'});
        }
        // A8: Dimona check (new employee < 90 days)
        const startDate=new Date(e.startDate||e.start||'2020-01-01');
        if((now-startDate)<90*86400000&&!e.dimonaDone) empAnomalies.push({code:'A8',severity:'warn',msg:'Dimona IN potentiellement manquante',fix:'Vérifier déclaration Dimona',doc:'dimona_in'});
        // A9: Medical check
        if(!e.medicalDate||(now-new Date(e.medicalDate))>365*86400000) empAnomalies.push({code:'A9',severity:'info',msg:'Visite médecine du travail à planifier',fix:'Planifier visite annuelle'});
        // A10: Overtime high
        const overtime=+(e.overtime||0);
        if(overtime>20) empAnomalies.push({code:'A10',severity:'warn',msg:overtime+'h supplémentaires — Vérifier limite légale (11h/semaine max)',fix:'Vérifier respect des limites'});

        // ── CALCULATE PAYSLIP ──
        let fiche=null;
        if(brut>0){
          const regime=(+(e.whWeek||38))/38;
          const brutEffectif=Math.round(brut*regime*100)/100;
          const onssW=Math.round(brutEffectif*TX_ONSS_W*100)/100;
          const bonusEmploi=calcBonusEmploi(brutEffectif);
          const imposable=Math.round((brutEffectif-onssW)*100)/100;
          // Sprint 29: Exact precompte with family situation
          const _sit=e.civil==='married_1'?'marie_1r':e.civil==='married_2'?'marie_2r':e.civil==='cohabit'?'marie_2r':'isole';const ppResult=calcPrecompteExact(brutEffectif,{situation:_sit,enfants:+(e.depChildren||e.enfants||0)});
          const pp=ppResult.pp;
          const csss=calcCSSS(brutEffectif,e.situation||'isole');
          const net=Math.round((brutEffectif-onssW-pp-csss+bonusEmploi)*100)/100;
          const onssE=Math.round(brutEffectif*TX_ONSS_E*100)/100;
          const maribel=Math.round(brutEffectif*0.004*100)/100;
          const coutTotal=Math.round((brutEffectif+onssE-maribel)*100)/100;
          const mealV=e.mealVoucher?(+e.mealVoucher)*22:0;

          fiche={
            id:'F-'+id,empId:id,name,email:e.email,niss:e.niss||e.NISS||'',iban:e.iban||e.IBAN||'',
            clientName:co.name||'',clientVAT:co.vat||'',
            brut:brutEffectif,onssW,bonusEmploi,imposable,pp,csss,net,onssE,maribel,coutTotal,mealV,
            contractType:e.contractType||e.contrat||'CDI',
            fonction:e.function||e.job||'Employé',
            regime:Math.round(regime*100),whWeek:e.whWeek||38,
            startDate:e.startDate||e.start||'',
            period:periodeStr,
            anomalies:empAnomalies,
            status:empAnomalies.some(a=>a.severity==='error')?'error':empAnomalies.some(a=>a.severity==='warn')?'warn':'ok',
            emp:e,company:co
          };
          fiches.push(fiche);
        } else {
          empAnomalies.push({code:'A1',severity:'error',msg:'Impossible de calculer — brut = 0',fix:'Définir le salaire brut'});
        }
        anomalies.push(...empAnomalies.map(a=>({...a,empName:name,empId:id,clientName:co.name})));
      }
    }
    addLog('✅ '+fiches.length+' fiches calculées, '+anomalies.length+' anomalies détectées','success');

    // ── 2. Generate documents list ──
    addLog('📄 Phase 2/6 — Détection des documents nécessaires...','info');
    await delay(200);
    for(const fiche of fiches){
      // Standard: payslip always
      documents.push({ficheId:fiche.id,type:'fiche_paie',label:'Fiche de paie '+periodeStr,status:'ready',auto:true});
      // If anomalies require documents
      for(const a of fiche.anomalies){
        if(a.doc){
          const docLabels={
            'attestation_identite':'Demande d\'attestation d\'identité',
            'formulaire_iban':'Formulaire de coordonnées bancaires',
            'contrat_travail':'Contrat de travail à compléter',
            'avenant_contrat':'Avenant au contrat de travail',
            'dimona_in':'Déclaration Dimona IN',
            'dimona_out':'Déclaration Dimona OUT',
          };
          documents.push({ficheId:fiche.id,type:a.doc,label:docLabels[a.doc]||a.doc,status:'required',auto:false,reason:a.msg});
        }
      }
    }
    addLog('✅ '+documents.length+' documents identifiés ('+documents.filter(d=>d.status==='required').length+' corrections requises)','success');

    // ── 3. SEPA generation ──
    addLog('💳 Phase 3/6 — Préparation SEPA...','info');
    await delay(200);
    const sepaFiches=fiches.filter(f=>f.iban&&f.net>0);
    addLog('✅ SEPA : '+sepaFiches.length+'/'+fiches.length+' virements prêts ('+fiches.filter(f=>!f.iban).length+' sans IBAN)','success');

    // ── 4. Quarterly checks ──
    addLog('🏛 Phase 4/6 — Vérifications trimestrielles...','info');
    await delay(200);
    const quarter=Math.ceil((prevMonth+1)/3);
    if([2,5,8,11].includes(prevMonth)){
      alertes.push({type:'urgent',msg:'DmfA T'+quarter+' — Déclaration trimestrielle ONSS à soumettre',action:'dmfa'});
      addLog('🏛 DmfA T'+quarter+' à soumettre','warn');
    }
    if(prevMonth===1){
      alertes.push({type:'urgent',msg:'Belcotax 281.10 — Fiches fiscales avant le 1er mars',action:'belcotax'});
      addLog('🧾 Belcotax 281.10 à soumettre','warn');
    }
    if(prevMonth===11){
      alertes.push({type:'info',msg:'13ème mois — Vérifier inclusion dans la paie de décembre',action:'treizieme'});
    }

    // ── 5. Cross-validation ──
    addLog('🔍 Phase 5/6 — Validation croisée...','info');
    await delay(200);
    // Check for duplicates
    const nissList=fiches.filter(f=>f.niss).map(f=>f.niss);
    const dupes=nissList.filter((n,i)=>nissList.indexOf(n)!==i);
    if(dupes.length>0){
      alertes.push({type:'error',msg:dupes.length+' NISS en double détectés : '+dupes.join(', ')});
      addLog('❌ '+dupes.length+' doublons NISS détectés','error');
    }
    // Check total coherence
    const totalBrut=fiches.reduce((a,f)=>a+f.brut,0);
    const totalNet=fiches.reduce((a,f)=>a+f.net,0);
    const totalCout=fiches.reduce((a,f)=>a+f.coutTotal,0);
    if(totalNet>totalBrut) alertes.push({type:'error',msg:'INCOHÉRENCE : Net total ('+f2(totalNet)+') > Brut total ('+f2(totalBrut)+')'});
    addLog('✅ Validation croisée OK','success');

    // ── 6. Summary ──
    addLog('📊 Phase 6/6 — Compilation du rapport...','info');
    await delay(200);
    const errors=anomalies.filter(a=>a.severity==='error').length;
    const warns=anomalies.filter(a=>a.severity==='warn').length;
    addLog('═══════════════════════════════════════','info');
    addLog('📊 SCAN TERMINÉ — '+periodeStr,'success');
    addLog('👥 '+fiches.length+' fiches | ❌ '+errors+' erreurs | ⚠️ '+warns+' avertissements','info');
    addLog('💰 Brut: '+f2(totalBrut)+'€ | Net: '+f2(totalNet)+'€ | Coût: '+f2(totalCout)+'€','info');
    addLog('═══════════════════════════════════════','info');
    addLog('🛑 EN ATTENTE DE VALIDATION HUMAINE','warn');

    // Pre-set validations
    const vals={};
    fiches.forEach(f=>{vals[f.id]=f.status==='error'?'hold':'approved';});
    setValidations(vals);

    // Pre-set attachments (auto-attach payslip to all)
    const atts={};
    fiches.forEach(f=>{atts[f.id]=['fiche_paie'];});
    // Auto-attach correction docs
    documents.filter(d=>d.status==='required').forEach(d=>{
      if(!atts[d.ficheId]) atts[d.ficheId]=[];
      if(!atts[d.ficheId].includes(d.type)) atts[d.ficheId].push(d.type);
    });
    setAttachments(atts);

    setScanResults({fiches,anomalies,documents,alertes,totals:{brut:totalBrut,net:totalNet,cout:totalCout,onss:fiches.reduce((a,f)=>a+f.onssW+f.onssE,0)},sepa:sepaFiches.length});
    setPhase('review');
    setAutoRunning(false);
  };

  // ═══════════════════════════════════════════════════
  // ═══ DOCUMENT GENERATION ENGINE (ROLLS ROYCE) ═══
  // ═══════════════════════════════════════════════════

  // Generate complete payslip HTML for a fiche
  const generateFicheHTML=(fiche)=>{
    const co=fiche.company||{};
    return '<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:11px;padding:30px;max-width:800px;margin:auto;color:#1a1a1a}h1{font-size:18px;color:#1a365d;margin-bottom:3px;text-align:center}.sub{font-size:10px;color:#666;text-align:center;margin-bottom:15px}h2{font-size:13px;margin:14px 0 6px;border-bottom:2px solid #c6a34e;padding-bottom:3px;color:#333}table{width:100%;border-collapse:collapse;margin:6px 0}th{background:#f0ece3;padding:6px 8px;text-align:left;font-size:10px;color:#333}td{padding:5px 8px;border-bottom:1px solid #eee;font-size:10px}.r{text-align:right;font-family:monospace}.total{background:#f8f7f4;font-weight:700}.logo{text-align:center;margin-bottom:8px;font-size:22px;font-weight:800;color:#c6a34e;font-family:Georgia,serif}.footer{margin-top:20px;font-size:8px;color:#999;text-align:center;border-top:1px solid #eee;padding-top:6px}@media print{button{display:none!important}}</style></head><body>'+
    '<div class="logo">AUREUS SOCIAL PRO</div>'+
    '<h1>FICHE DE PAIE</h1>'+
    '<div class="sub">'+fiche.period+' | '+(co.name||'')+' — '+(co.vat||'')+'</div>'+
    '<h2>Travailleur</h2><table>'+
    '<tr><td>Nom</td><td class="r"><b>'+fiche.name+'</b></td></tr>'+
    '<tr><td>NISS</td><td class="r">'+(fiche.niss||'N/A')+'</td></tr>'+
    '<tr><td>Contrat</td><td class="r">'+fiche.contractType+' — '+fiche.regime+'% ('+fiche.whWeek+'h/sem)</td></tr>'+
    '<tr><td>Fonction</td><td class="r">'+fiche.fonction+'</td></tr>'+
    '<tr><td>Date d\'entrée</td><td class="r">'+(fiche.startDate||'N/A')+'</td></tr></table>'+
    '<h2>Rémunération</h2><table>'+
    '<tr><td>Salaire brut</td><td class="r"><b>'+f2(fiche.brut)+' €</b></td></tr>'+
    '<tr><td>ONSS travailleur (13,07%)</td><td class="r" style="color:#c00">- '+f2(fiche.onssW)+' €</td></tr>'+
    '<tr class="total"><td>Imposable</td><td class="r">'+f2(fiche.imposable)+' €</td></tr>'+
    '<tr><td>Précompte professionnel</td><td class="r" style="color:#c00">- '+f2(fiche.pp)+' €</td></tr>'+
    (fiche.csss>0?'<tr><td>Cotisation spéciale SS</td><td class="r" style="color:#c00">- '+f2(fiche.csss)+' €</td></tr>':'')+
    (fiche.bonusEmploi>0?'<tr><td>Bonus à l\'emploi</td><td class="r" style="color:#060">+ '+f2(fiche.bonusEmploi)+' €</td></tr>':'')+
    '<tr class="total" style="background:#e8f5e9"><td><b>NET À PAYER</b></td><td class="r" style="font-size:14px"><b>'+f2(fiche.net)+' €</b></td></tr></table>'+
    '<h2>Coût employeur</h2><table>'+
    '<tr><td>Salaire brut</td><td class="r">'+f2(fiche.brut)+' €</td></tr>'+
    '<tr><td>ONSS patronal (25,07%)</td><td class="r">'+f2(fiche.onssE)+' €</td></tr>'+
    (fiche.maribel>0?'<tr><td>Réduction Maribel social</td><td class="r" style="color:#060">- '+f2(fiche.maribel)+' €</td></tr>':'')+
    (fiche.mealV>0?'<tr><td>Chèques-repas (part patronale)</td><td class="r">'+f2(fiche.mealV*0.83)+' €</td></tr>':'')+
    '<tr class="total"><td><b>COÛT TOTAL EMPLOYEUR</b></td><td class="r"><b>'+f2(fiche.coutTotal)+' €</b></td></tr></table>'+
    '<div class="footer">Document généré par Aureus Social Pro — aureussocial.be — '+new Date().toLocaleDateString('fr-BE')+' '+new Date().toLocaleTimeString('fr-BE')+'<br>Ce document est confidentiel et destiné uniquement au travailleur concerné.</div>'+
    '<div style="text-align:center;margin-top:12px"><button onclick="window.print()" style="background:#c6a34e;color:#fff;border:none;padding:10px 30px;border-radius:6px;cursor:pointer;font-weight:600">🖨 Imprimer / PDF</button></div></body></html>';
  };

  // Generate correction document HTML
  const generateDocHTML=(fiche,docType)=>{
    const co=fiche.company||{};
    const header='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:12px;padding:40px;max-width:800px;margin:auto;line-height:1.6}h1{text-align:center;font-size:16px;margin-bottom:15px;text-decoration:underline}.logo{text-align:center;margin-bottom:10px;font-size:18px;font-weight:800;color:#c6a34e;font-family:Georgia,serif}.footer{margin-top:40px;font-size:9px;color:#999;text-align:center}@media print{button{display:none!important}}.field{border-bottom:1px dotted #999;min-width:200px;display:inline-block;padding:2px 0}</style></head><body><div class="logo">AUREUS SOCIAL PRO</div>';
    const footer='<div class="footer">Document généré par Aureus Social Pro — '+new Date().toLocaleDateString('fr-BE')+'</div><div style="text-align:center;margin-top:12px"><button onclick="window.print()" style="background:#c6a34e;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600">🖨 Imprimer</button></div></body></html>';
    
    const docs={
      'attestation_identite': header+'<h1>DEMANDE D\'ATTESTATION D\'IDENTITÉ</h1><p style="margin-bottom:20px">'+(co.name||'L\'employeur')+' ('+(co.vat||'')+') demande au travailleur <b>'+fiche.name+'</b> de bien vouloir fournir une copie de sa carte d\'identité ou de son titre de séjour afin de compléter son dossier administratif.</p><p><b>Documents acceptés :</b></p><ul style="margin:10px 0 20px 20px"><li>Carte d\'identité belge (recto-verso)</li><li>Titre de séjour valide</li><li>Passeport (page d\'identité)</li></ul><p>Merci de transmettre ce document à votre gestionnaire de paie dans les plus brefs délais.</p><div style="margin-top:40px"><p>Date : <span class="field">'+new Date().toLocaleDateString('fr-BE')+'</span></p><p>Signature employeur : <span class="field">&nbsp;</span></p></div>'+footer,
      
      'formulaire_iban': header+'<h1>FORMULAIRE DE COORDONNÉES BANCAIRES</h1><p style="margin-bottom:20px">Afin d\'effectuer le virement de votre salaire, veuillez compléter les informations ci-dessous :</p><table style="width:100%;border-collapse:collapse;margin:20px 0"><tr><td style="padding:10px;border:1px solid #ccc;width:200px;font-weight:600">Nom complet</td><td style="padding:10px;border:1px solid #ccc">'+fiche.name+'</td></tr><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600">NISS</td><td style="padding:10px;border:1px solid #ccc">'+(fiche.niss||'_______________')+'</td></tr><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600">IBAN</td><td style="padding:10px;border:1px solid #ccc;font-family:monospace;font-size:14px">BE__ ____ ____ ____</td></tr><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600">BIC/SWIFT</td><td style="padding:10px;border:1px solid #ccc">____________________</td></tr><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600">Titulaire du compte</td><td style="padding:10px;border:1px solid #ccc">____________________</td></tr></table><p>Je certifie que les informations ci-dessus sont exactes.</p><div style="margin-top:30px;display:flex;justify-content:space-between"><div><p>Date : ___/___/______</p><p style="margin-top:30px">Signature travailleur :</p></div><div><p>Employeur : '+(co.name||'')+'</p><p style="margin-top:30px">Cachet :</p></div></div>'+footer,
      
      'contrat_travail': header+'<h1>CONTRAT DE TRAVAIL — '+fiche.contractType+'</h1><p style="text-align:center;margin-bottom:20px;color:#666">'+(co.name||'')+' | '+(co.vat||'')+'</p><p><b>ENTRE</b></p><p style="margin:5px 0 15px 20px">'+(co.name||'L\'employeur')+', ci-après "l\'employeur"</p><p><b>ET</b></p><p style="margin:5px 0 15px 20px">'+fiche.name+' (NISS : '+(fiche.niss||'à compléter')+'), ci-après "le travailleur"</p><p><b>IL EST CONVENU CE QUI SUIT :</b></p><p style="margin:10px 0"><b>Article 1 — Objet</b><br>Le travailleur est engagé en qualité de <b>'+fiche.fonction+'</b> à partir du <b>'+(fiche.startDate||'___/___/______')+'</b>.</p><p style="margin:10px 0"><b>Article 2 — Durée</b><br>Le présent contrat est conclu pour une durée '+( fiche.contractType==='CDI'?'indéterminée':'déterminée')+'.</p><p style="margin:10px 0"><b>Article 3 — Rémunération</b><br>Le salaire mensuel brut est fixé à <b>'+f2(fiche.brut)+' EUR</b> pour un régime de <b>'+fiche.whWeek+'h/semaine</b>.</p><p style="margin:10px 0"><b>Article 4 — Commission paritaire</b><br>CP 200 — Employés.</p><p style="margin:10px 0"><b>Article 5 — Lieu de travail</b><br>Le lieu de travail principal est situé à '+(co.address||'_______________________________')+'.</p><div style="margin-top:50px;display:flex;justify-content:space-between"><div style="width:45%;border-top:1px solid #000;padding-top:5px;text-align:center">L\'employeur<br>'+(co.name||'')+'</div><div style="width:45%;border-top:1px solid #000;padding-top:5px;text-align:center">Le travailleur<br>'+fiche.name+'</div></div><p style="text-align:center;margin-top:15px;font-size:10px;color:#888">Fait en double exemplaire à Bruxelles, le '+new Date().toLocaleDateString('fr-BE')+'</p>'+footer,
      
      'avenant_contrat': header+'<h1>AVENANT AU CONTRAT DE TRAVAIL</h1><p style="text-align:center;margin-bottom:20px;color:#666">'+(co.name||'')+'</p><p>Concerne : <b>'+fiche.name+'</b> (NISS : '+(fiche.niss||'N/A')+')</p><p style="margin:15px 0">Le présent avenant modifie le contrat de travail en date du '+(fiche.startDate||'___/___/______')+' comme suit :</p><table style="width:100%;border-collapse:collapse;margin:20px 0"><tr style="background:#f0f0f0"><th style="padding:8px;border:1px solid #ccc">Élément</th><th style="padding:8px;border:1px solid #ccc">Ancien</th><th style="padding:8px;border:1px solid #ccc">Nouveau</th></tr><tr><td style="padding:8px;border:1px solid #ccc">Salaire brut</td><td style="padding:8px;border:1px solid #ccc">___________</td><td style="padding:8px;border:1px solid #ccc">'+f2(fiche.brut)+' EUR</td></tr><tr><td style="padding:8px;border:1px solid #ccc">Fonction</td><td style="padding:8px;border:1px solid #ccc">___________</td><td style="padding:8px;border:1px solid #ccc">'+fiche.fonction+'</td></tr><tr><td style="padding:8px;border:1px solid #ccc">Régime horaire</td><td style="padding:8px;border:1px solid #ccc">___________</td><td style="padding:8px;border:1px solid #ccc">'+fiche.whWeek+'h/sem</td></tr></table><p>Toutes les autres dispositions du contrat initial restent inchangées.</p><div style="margin-top:50px;display:flex;justify-content:space-between"><div style="width:45%;border-top:1px solid #000;padding-top:5px;text-align:center">L\'employeur</div><div style="width:45%;border-top:1px solid #000;padding-top:5px;text-align:center">Le travailleur</div></div>'+footer,

      'dimona_in': header+'<h1>DÉCLARATION DIMONA — ENTRÉE EN SERVICE</h1><p style="text-align:center;margin-bottom:20px;color:#666">Document de référence interne</p><table style="width:100%;border-collapse:collapse;margin:20px 0"><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600;width:200px">Employeur</td><td style="padding:10px;border:1px solid #ccc">'+(co.name||'')+' — '+(co.vat||'')+'</td></tr><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600">Travailleur</td><td style="padding:10px;border:1px solid #ccc">'+fiche.name+'</td></tr><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600">NISS</td><td style="padding:10px;border:1px solid #ccc">'+(fiche.niss||'À COMPLÉTER')+'</td></tr><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600">Type</td><td style="padding:10px;border:1px solid #ccc;color:#060;font-weight:700">DIMONA IN — Entrée en service</td></tr><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600">Date d\'entrée</td><td style="padding:10px;border:1px solid #ccc;font-weight:700">'+(fiche.startDate||new Date().toISOString().slice(0,10))+'</td></tr><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600">Type contrat</td><td style="padding:10px;border:1px solid #ccc">'+fiche.contractType+'</td></tr><tr><td style="padding:10px;border:1px solid #ccc;font-weight:600">Commission paritaire</td><td style="padding:10px;border:1px solid #ccc">CP 200</td></tr></table><p style="color:#c00;font-weight:700">⚠️ RAPPEL : La déclaration Dimona doit être effectuée sur le portail de la sécurité sociale (www.socialsecurity.be) AU PLUS TARD le jour de l\'entrée en service.</p><p style="margin-top:10px">Référence interne : DIMONA-'+Date.now()+'</p>'+footer,

      'attestation_emploi': header+'<h1>ATTESTATION D\'EMPLOI</h1><p style="margin:15px 0">'+(co.name||'L\'employeur')+' ('+(co.vat||'')+') atteste que <b>'+fiche.name+'</b> (NISS : '+(fiche.niss||'N/A')+') est employé(e) depuis le <b>'+(fiche.startDate||'N/A')+'</b> en qualité de <b>'+fiche.fonction+'</b>.</p><p>Contrat : '+fiche.contractType+' — '+fiche.whWeek+'h/semaine — Salaire brut : '+f2(fiche.brut)+' EUR/mois.</p><p style="margin-top:20px">La présente attestation est délivrée pour servir et valoir ce que de droit.</p><div style="margin-top:40px"><p>Fait à Bruxelles, le '+new Date().toLocaleDateString('fr-BE')+'</p><div style="margin-top:30px;width:200px;border-top:1px solid #000;padding-top:5px;text-align:center">Pour l\'employeur</div></div>'+footer
    };
    return docs[docType]||header+'<h1>Document : '+docType+'</h1><p>À compléter</p>'+footer;
  };

  // Preview full email pack for one employee
  const previewPack=(fiche)=>{
    const atts=attachments[fiche.id]||['fiche_paie'];
    const corr=corrections[fiche.id]||'';
    
    // Build combined HTML with all docs
    let packHTML='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;background:#f5f4f0;padding:20px}.pack-header{background:linear-gradient(135deg,#1a365d,#2d4a7c);color:#fff;padding:24px;border-radius:12px 12px 0 0;text-align:center}.pack-section{background:#fff;margin:0;padding:20px;border:1px solid #e5e2d9;page-break-before:always}.pack-section:first-of-type{border-radius:0}.pack-section:last-child{border-radius:0 0 12px 12px}.section-title{background:#c6a34e;color:#fff;padding:8px 16px;font-size:12px;font-weight:700;margin:-20px -20px 15px;text-transform:uppercase;letter-spacing:1px}.note{background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:12px;margin:15px 0;font-size:11px}@media print{button{display:none!important}.pack-header{-webkit-print-color-adjust:exact;print-color-adjust:exact}}</style></head><body>';
    
    // Pack header
    packHTML+='<div class="pack-header"><div style="font-size:24px;font-weight:800;font-family:Georgia,serif;margin-bottom:4px">AUREUS SOCIAL PRO</div><div style="font-size:14px;opacity:.8">Pack paie — '+fiche.period+'</div><div style="font-size:18px;margin-top:8px;font-weight:600">'+fiche.name+'</div><div style="font-size:11px;opacity:.7">'+(fiche.clientName||'')+' | '+fiche.contractType+' | '+fiche.fonction+'</div></div>';

    // Correction note
    if(corr){
      packHTML+='<div class="pack-section"><div class="note"><b>📝 Note du gestionnaire :</b><br>'+corr.replace(/\\n/g,'<br>')+'</div></div>';
    }

    // Anomalies summary if any
    if(fiche.anomalies.length>0){
      packHTML+='<div class="pack-section"><div class="section-title">⚠️ Points d\'attention</div>';
      fiche.anomalies.forEach(a=>{
        packHTML+='<div style="padding:6px 0;border-bottom:1px solid #eee;font-size:11px"><span style="color:'+(a.severity==='error'?'#dc3545':a.severity==='warn'?'#ffc107':'#0d6efd')+';font-weight:600">['+a.code+']</span> '+a.msg+' — <i>'+a.fix+'</i></div>';
      });
      packHTML+='</div>';
    }
    
    // Add each attached document
    atts.forEach(docType=>{
      const html=docType==='fiche_paie'?generateFicheHTML(fiche):generateDocHTML(fiche,docType);
      // Extract body content only
      const bodyStart=html.indexOf('<body');const bodyEnd=html.indexOf('</body>');const content=(bodyStart>-1&&bodyEnd>bodyStart)?html.substring(html.indexOf('>',bodyStart)+1,bodyEnd):html;
      packHTML+='<div class="pack-section"><div class="section-title">'+(docLabels[docType]||docType)+'</div>'+content+'</div>';
    });
    
    packHTML+='<div style="text-align:center;margin:20px 0"><button onclick="window.print()" style="background:#c6a34e;color:#fff;border:none;padding:12px 30px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:700">🖨 Imprimer tout le pack</button></div></body></html>';
    
    previewHTML(packHTML,'Pack_'+fiche.name.replace(/ /g,'_')+'_'+fiche.period);
  };

  // ════════════════════════════════════════
  // ═══ PHASE 2: ENVOI APRÈS VALIDATION ═══
  // ════════════════════════════════════════
  const sendAll=async()=>{
    if(!scanResults) return;
    const approved=scanResults.fiches.filter(f=>validations[f.id]==='approved');
    if(approved.length===0){alert('Aucune fiche approuvée.');return;}
    const held=scanResults.fiches.filter(f=>validations[f.id]==='hold');
    const rej=scanResults.fiches.filter(f=>validations[f.id]==='rejected');
    if(!confirm('📋 '+approved.length+' pack(s) seront envoyés.\n⏳ '+held.length+' en attente\n❌ '+rej.length+' rejetée(s)\n\nContinuer ?')) return;
    
    setPhase('sending');
    setAutoRunning(true);
    setSendProgress({sent:0,total:approved.length});
    addLog('═══════════════════════════════════════','info');
    addLog('📧 DISTRIBUTION — '+approved.length+' packs complets','info');

    let sentOK=0;let sentFail=0;
    for(let i=0;i<approved.length;i++){
      const fiche=approved[i];
      const atts=attachments[fiche.id]||['fiche_paie'];
      const corr=corrections[fiche.id]||'';
      await delay(200);
      if(!fiche.email){
        addLog('⚠️ ['+(i+1)+'/'+approved.length+'] '+fiche.name+' — PAS EMAIL — Pack prêt non envoyé','warn');
        sentFail++;
      } else {
        const ficheHTML=generateFicheHTML(fiche)||'';
        const docHTMLs=atts.filter(dt=>dt!=='fiche_paie').map(dt=>({filename:dt+'.html',content:generateDocHTML(fiche,dt)||'',contentType:'text/html'}));
        const emailRes=await sendEmailReal(fiche.email,'Fiche de paie — Aureus Social Pro',ficheHTML,docHTMLs);
        addLog('📧 ['+(i+1)+'/'+approved.length+'] '+fiche.name+' → '+fiche.email+(emailRes.success?' ✅ envoyé':' ⚠ '+( emailRes.mode||'dev'))+' | 📎 '+atts.length+' doc(s)','success');
        if(corr) addLog('   📝 '+corr.substring(0,80),'info');
        sentOK++;
      }
      setSendProgress({sent:i+1,total:approved.length});
    }
    addLog('═══════════════════════════════════════','info');
    addLog('✅ '+sentOK+' envoyés | ⚠️ '+sentFail+' sans email | ⏳ '+held.length+' en attente','success');
    
    if(supabase&&user){
      try{
        await supabase.from('app_state').upsert({
          key:'pilote_'+prevYear+'_'+(prevMonth+1),
          val:JSON.stringify({completedAt:new Date().toISOString(),completedBy:user.email,
            stats:{sent:sentOK,failed:sentFail,held:held.length,brut:scanResults.totals.brut,net:scanResults.totals.net}}),
          updated_at:new Date().toISOString()
        },{onConflict:'key'});
        addLog('💾 Cloud OK','success');
      }catch(e){}
    }
    setPhase('done');
    // Sprint 29: Persist payroll run to history
    try {
      const now=new Date();
      const fichesData=(sr?.fiches||[]).map(fi=>({empName:fi.name||'',brut:fi.brut||0,net:fi.net||0,onss:fi.onss||0,pp:fi.pp||0,status:validations[fi.id]||'approved'}));
      const summaryData={totalBrut:sr?.totals?.brut||0,totalNet:sr?.totals?.net||0,empCount:(sr?.fiches||[]).length,sentCount:sentOK||0,failedCount:sentFail||0};
      savePayrollRun(cl?.id||'unknown',now.getMonth()+1,now.getFullYear(),fichesData,summaryData);
    } catch(pe) {}
    setAutoRunning(false);
  };

  // ════════════════════════
  // ═══ RENDER ═══
  // ════════════════════════
  const sr=scanResults;
  const errors=sr?sr.anomalies.filter(a=>a.severity==='error').length:0;
  const warns=sr?sr.anomalies.filter(a=>a.severity==='warn').length:0;
  const approved=sr?sr.fiches.filter(f=>validations[f.id]==='approved').length:0;
  const held=sr?sr.fiches.filter(f=>validations[f.id]==='hold').length:0;
  const rejected=sr?sr.fiches.filter(f=>validations[f.id]==='rejected').length:0;

  const docLabels={'fiche_paie':'📄 Fiche de paie','attestation_identite':'🪪 Demande identité','formulaire_iban':'🏦 Formulaire IBAN','contrat_travail':'📝 Contrat','avenant_contrat':'📝 Avenant','dimona_in':'📋 Dimona IN','dimona_out':'📋 Dimona OUT','attestation_emploi':'📄 Attestation emploi','c4':'📄 C4','solde_compte':'💰 Solde de compte'};
  const allDocTypes=['fiche_paie','attestation_identite','formulaire_iban','contrat_travail','avenant_contrat','dimona_in','attestation_emploi'];

  return <div style={{padding:24}}>
    {/* HEADER */}
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div>
        <h2 style={{fontSize:24,fontWeight:800,color:'#c6a34e',margin:0}}>🏎️ Pilote Automatique Total</h2>
        <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>100% automatisé — Vous ne faites que valider — {periodeStr}</p>
      </div>
      <div style={{display:'flex',gap:8}}>
        {phase==='idle'&&<button onClick={runFullScan} style={{padding:'12px 28px',borderRadius:12,border:'none',background:'linear-gradient(135deg,#c6a34e,#e2c878)',color:'#060810',fontWeight:800,fontSize:14,cursor:'pointer',boxShadow:'0 4px 20px rgba(198,163,78,.3)'}}>
          🚀 LANCER LE SCAN COMPLET
        </button>}
        {phase==='review'&&<button onClick={sendAll} disabled={approved===0} style={{padding:'12px 28px',borderRadius:12,border:'none',background:approved>0?'linear-gradient(135deg,#22c55e,#16a34a)':'#333',color:approved>0?'#fff':'#888',fontWeight:800,fontSize:14,cursor:approved>0?'pointer':'not-allowed'}}>
          📧 ENVOYER {approved} FICHE{approved>1?'S':''} APPROUVÉE{approved>1?'S':''}
        </button>}
        {phase==='done'&&<div style={{padding:'12px 28px',borderRadius:12,background:'rgba(34,197,94,.1)',color:'#22c55e',fontWeight:800,fontSize:14}}>✅ TERMINÉ</div>}
        {(phase==='review'||phase==='done')&&<button onClick={()=>{setPhase('idle');setScanResults(null);setLogs([]);}} style={{padding:'12px 20px',borderRadius:12,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontWeight:600,fontSize:12,cursor:'pointer'}}>🔄 Nouveau scan</button>}
      </div>
    </div>

    {/* PHASE BAR */}
    <div style={{display:'flex',gap:4,marginBottom:20}}>
      {[{id:'scanning',icon:'🔍',label:'Scan auto'},{id:'review',icon:'👁',label:'Validation humaine'},{id:'sending',icon:'📧',label:'Distribution'},{id:'done',icon:'✅',label:'Terminé'}].map((p,i)=>{
        const isActive=phase===p.id;
        const isDone=['scanning','review','sending','done'].indexOf(phase)>i;
        return <div key={i} style={{flex:1,padding:'10px',textAlign:'center',borderRadius:10,background:isDone?'rgba(34,197,94,.06)':isActive?'rgba(198,163,78,.08)':'rgba(255,255,255,.02)',border:'1px solid '+(isDone?'rgba(34,197,94,.2)':isActive?'rgba(198,163,78,.25)':'rgba(255,255,255,.05)')}}>
          <div style={{fontSize:18}}>{isDone&&!isActive?'✅':p.icon}</div>
          <div style={{fontSize:10,fontWeight:600,color:isDone?'#22c55e':isActive?'#c6a34e':'#888'}}>{p.label}</div>
        </div>;
      })}
    </div>

    {/* IDLE STATE */}
    {phase==='idle'&&<div style={{textAlign:'center',padding:'60px 20px',border:'2px dashed rgba(198,163,78,.15)',borderRadius:20}}>
      <div style={{fontSize:60,marginBottom:16}}>🏎️</div>
      <div style={{fontSize:18,fontWeight:700,color:'#c6a34e',marginBottom:8}}>Prêt à lancer le Pilote Automatique</div>
      <div style={{fontSize:13,color:'#888',maxWidth:500,margin:'0 auto'}}>
        Le système va scanner tous vos clients et employés, calculer chaque fiche de paie, détecter les anomalies, préparer les documents correctifs, et tout préparer pour votre validation.
      </div>
      <div style={{display:'flex',gap:12,justifyContent:'center',marginTop:20,flexWrap:'wrap'}}>
        {['🔍 Détection anomalies','🧮 Calcul auto','📄 Documents joints','✅ Validation humaine','📧 Envoi groupé'].map((t,i)=>
          <div key={i} style={{padding:'6px 14px',borderRadius:20,background:'rgba(198,163,78,.06)',border:'1px solid rgba(198,163,78,.1)',fontSize:11,color:'#c6a34e'}}>{t}</div>
        )}
      </div>
    </div>}

    {/* SCANNING ANIMATION */}
    {phase==='scanning'&&<div style={{textAlign:'center',padding:40}}>
      <div style={{fontSize:48,animation:'pulse 1s infinite',marginBottom:16}}>🔍</div>
      <div style={{fontSize:16,color:'#c6a34e',fontWeight:600}}>Scan en cours...</div>
    </div>}

    {/* KPI CARDS (review/sending/done) */}
    {sr&&<div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Fiches',v:sr.fiches.length,c:'#c6a34e',i:'📋'},
        {l:'Approuvées',v:approved,c:'#22c55e',i:'✅'},
        {l:'En attente',v:held,c:'#eab308',i:'⏳'},
        {l:'Erreurs',v:errors,c:'#ef4444',i:'❌'},
        {l:'Docs joints',v:sr.documents.length,c:'#3b82f6',i:'📎'},
        {l:'SEPA prêts',v:sr.sepa,c:'#a855f7',i:'💳'},
      ].map((k,i)=><div key={i} style={{padding:12,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'20',borderRadius:12,textAlign:'center'}}>
        <div style={{fontSize:9,color:'#888'}}>{k.i} {k.l}</div>
        <div style={{fontSize:22,fontWeight:700,color:k.c}}>{k.v}</div>
      </div>)}
    </div>}

    {/* FINANCIAL TOTALS */}
    {sr&&<div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:16}}>
      {[{l:'Masse brute',v:f2(sr.totals.brut)+'€',c:'#e5e5e5'},
        {l:'ONSS total (W+P)',v:f2(sr.totals.onss)+'€',c:'#a855f7'},
        {l:'Net total',v:f2(sr.totals.net)+'€',c:'#22c55e'},
        {l:'Coût employeur',v:f2(sr.totals.cout)+'€',c:'#c6a34e'},
      ].map((k,i)=><div key={i} style={{padding:10,background:'rgba(198,163,78,.03)',border:'1px solid rgba(198,163,78,.08)',borderRadius:10,textAlign:'center'}}>
        <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
        <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div>
      </div>)}
    </div>}

    {/* ALERTES GLOBALES */}
    {sr&&sr.alertes.length>0&&<div style={{marginBottom:16}}>
      {sr.alertes.map((a,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 14px',marginBottom:4,background:a.type==='error'?'rgba(239,68,68,.06)':a.type==='urgent'?'rgba(234,179,8,.06)':'rgba(59,130,246,.06)',border:'1px solid '+(a.type==='error'?'rgba(239,68,68,.15)':a.type==='urgent'?'rgba(234,179,8,.15)':'rgba(59,130,246,.15)'),borderRadius:10}}>
        <span style={{fontSize:14}}>{a.type==='error'?'❌':a.type==='urgent'?'⚠️':'ℹ️'}</span>
        <span style={{fontSize:12,color:'#e5e5e5',flex:1}}>{a.msg}</span>
      </div>)}
    </div>}

    {/* SENDING PROGRESS */}
    {phase==='sending'&&<div style={{marginBottom:16,padding:16,background:'rgba(34,197,94,.04)',border:'1px solid rgba(34,197,94,.15)',borderRadius:14}}>
      <div style={{display:'flex',justifyContent:'space-between',marginBottom:8}}>
        <span style={{fontSize:13,fontWeight:600,color:'#22c55e'}}>📧 Distribution en cours...</span>
        <span style={{fontSize:13,color:'#22c55e',fontWeight:700}}>{sendProgress.sent}/{sendProgress.total}</span>
      </div>
      <div style={{height:6,background:'rgba(255,255,255,.05)',borderRadius:3,overflow:'hidden'}}>
        <div style={{height:'100%',width:(sendProgress.total>0?sendProgress.sent/sendProgress.total*100:0)+'%',background:'linear-gradient(90deg,#22c55e,#16a34a)',borderRadius:3,transition:'width .3s'}}/>
      </div>
    </div>}

    {sr&&(phase==='review'||phase==='done')&&<div style={{display:'grid',gridTemplateColumns:'1fr 360px',gap:16}}>
      {/* ═══ LEFT: FICHES TABLE ═══ */}
      <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
        <div style={{padding:'12px 16px',background:'rgba(198,163,78,.06)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span style={{fontSize:13,fontWeight:700,color:'#c6a34e'}}>📋 Fiches de paie — Validation</span>
          <div style={{display:'flex',gap:6}}>
            <button onClick={()=>{const v={};sr.fiches.forEach(f=>{v[f.id]='approved';});setValidations(v);}} style={{padding:'4px 10px',borderRadius:6,border:'none',background:'rgba(34,197,94,.1)',color:'#22c55e',fontSize:10,cursor:'pointer',fontWeight:600}}>✅ Tout approuver</button>
            <button onClick={()=>{const v={};sr.fiches.forEach(f=>{v[f.id]='hold';});setValidations(v);}} style={{padding:'4px 10px',borderRadius:6,border:'none',background:'rgba(234,179,8,.1)',color:'#eab308',fontSize:10,cursor:'pointer',fontWeight:600}}>⏳ Tout bloquer</button>
          </div>
        </div>
        <div style={{maxHeight:600,overflowY:'auto'}}>
          {sr.fiches.map((fiche,i)=>{
            const val=validations[fiche.id]||'hold';
            const atts=attachments[fiche.id]||[];
            const isExpanded=expandedFiche===fiche.id;
            const bg=val==='approved'?'rgba(34,197,94,.02)':val==='rejected'?'rgba(239,68,68,.02)':'rgba(234,179,8,.02)';
            return <div key={i}>
              <div onClick={()=>setExpandedFiche(isExpanded?null:fiche.id)} style={{display:'grid',gridTemplateColumns:'30px 140px 80px 80px 80px 80px 1fr 90px',padding:'8px 12px',borderBottom:'1px solid rgba(255,255,255,.03)',alignItems:'center',fontSize:11,background:bg,cursor:'pointer'}}>
                <div>{val==='approved'?'✅':val==='rejected'?'❌':'⏳'}</div>
                <div style={{color:'#e5e5e5',fontWeight:500}}>{fiche.name}<div style={{fontSize:9,color:'#888'}}>{fiche.clientName}</div></div>
                <div style={{color:'#e5e5e5'}}>{f2(fiche.brut)}€</div>
                <div style={{color:'#ef4444'}}>-{f2(fiche.onssW)}€</div>
                <div style={{color:'#ef4444'}}>-{f2(fiche.pp)}€</div>
                <div style={{color:'#22c55e',fontWeight:700}}>{f2(fiche.net)}€</div>
                <div style={{display:'flex',gap:2,flexWrap:'wrap'}}>
                  {fiche.anomalies.length===0?<span style={{fontSize:8,color:'#22c55e'}}>✓ OK</span>:
                  fiche.anomalies.slice(0,2).map((a,j)=><span key={j} style={{fontSize:7,padding:'1px 4px',borderRadius:3,background:a.severity==='error'?'rgba(239,68,68,.1)':a.severity==='warn'?'rgba(234,179,8,.1)':'rgba(59,130,246,.1)',color:a.severity==='error'?'#ef4444':a.severity==='warn'?'#eab308':'#3b82f6'}}>{a.code}</span>)}
                  {fiche.anomalies.length>2&&<span style={{fontSize:7,color:'#888'}}>+{fiche.anomalies.length-2}</span>}
                </div>
                <div style={{display:'flex',gap:3}} onClick={e=>e.stopPropagation()}>
                  <button onClick={()=>setValidations(p=>({...p,[fiche.id]:'approved'}))} style={{padding:'2px 6px',borderRadius:4,border:val==='approved'?'1px solid #22c55e':'1px solid rgba(255,255,255,.08)',background:val==='approved'?'rgba(34,197,94,.15)':'transparent',color:val==='approved'?'#22c55e':'#888',fontSize:9,cursor:'pointer'}}>✅</button>
                  <button onClick={()=>setValidations(p=>({...p,[fiche.id]:'hold'}))} style={{padding:'2px 6px',borderRadius:4,border:val==='hold'?'1px solid #eab308':'1px solid rgba(255,255,255,.08)',background:val==='hold'?'rgba(234,179,8,.15)':'transparent',color:val==='hold'?'#eab308':'#888',fontSize:9,cursor:'pointer'}}>⏳</button>
                  <button onClick={()=>setValidations(p=>({...p,[fiche.id]:'rejected'}))} style={{padding:'2px 6px',borderRadius:4,border:val==='rejected'?'1px solid #ef4444':'1px solid rgba(255,255,255,.08)',background:val==='rejected'?'rgba(239,68,68,.15)':'transparent',color:val==='rejected'?'#ef4444':'#888',fontSize:9,cursor:'pointer'}}>❌</button>
                </div>
              </div>
              {/* EXPANDED: anomalies + documents to attach */}
              {isExpanded&&<div style={{padding:'12px 16px',background:'rgba(0,0,0,.2)',borderBottom:'2px solid rgba(198,163,78,.1)'}}>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
                  {/* Anomalies */}
                  <div>
                    <div style={{fontSize:11,fontWeight:600,color:'#c6a34e',marginBottom:6}}>🔍 Anomalies ({fiche.anomalies.length})</div>
                    {fiche.anomalies.length===0?<div style={{fontSize:10,color:'#22c55e'}}>✅ Aucune anomalie</div>:
                    fiche.anomalies.map((a,j)=><div key={j} style={{padding:'6px 8px',marginBottom:3,borderRadius:6,background:a.severity==='error'?'rgba(239,68,68,.06)':a.severity==='warn'?'rgba(234,179,8,.06)':'rgba(59,130,246,.06)',border:'1px solid '+(a.severity==='error'?'rgba(239,68,68,.12)':'rgba(234,179,8,.12)'),fontSize:10}}>
                      <div style={{color:a.severity==='error'?'#ef4444':a.severity==='warn'?'#eab308':'#3b82f6',fontWeight:600}}>[{a.code}] {a.msg}</div>
                      <div style={{color:'#888',marginTop:2}}>💡 {a.fix}</div>
                    </div>)}
                  </div>
                  {/* Documents à joindre */}
                  <div>
                    <div style={{fontSize:11,fontWeight:600,color:'#3b82f6',marginBottom:6}}>📎 Documents joints à l'envoi</div>
                    {allDocTypes.map((dt,j)=>{
                      const isAttached=atts.includes(dt);
                      const isRequired=sr.documents.some(d=>d.ficheId===fiche.id&&d.type===dt&&d.status==='required');
                      return <div key={j} onClick={()=>{
                        setAttachments(p=>{
                          const cur=p[fiche.id]||[];
                          return {...p,[fiche.id]:isAttached?cur.filter(x=>x!==dt):[...cur,dt]};
                        });
                      }} style={{display:'flex',alignItems:'center',gap:8,padding:'5px 8px',marginBottom:2,borderRadius:6,cursor:'pointer',background:isAttached?'rgba(59,130,246,.06)':'transparent',border:'1px solid '+(isAttached?'rgba(59,130,246,.15)':'rgba(255,255,255,.04)')}}>
                        <div style={{width:16,height:16,borderRadius:4,border:'2px solid '+(isAttached?'#3b82f6':'#555'),background:isAttached?'rgba(59,130,246,.2)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,color:'#3b82f6'}}>{isAttached?'✓':''}</div>
                        <span style={{fontSize:10,color:isAttached?'#e5e5e5':'#888'}}>{docLabels[dt]||dt}</span>
                        {isRequired&&<span style={{fontSize:8,padding:'1px 4px',borderRadius:3,background:'rgba(239,68,68,.1)',color:'#ef4444',fontWeight:600}}>REQUIS</span>}
                      </div>;
                    })}
                    {/* Correction note */}
                    <div style={{marginTop:8}}>
                      <div style={{fontSize:10,color:'#888',marginBottom:3}}>📝 Note / correction :</div>
                      <textarea value={corrections[fiche.id]||''} onChange={e=>setCorrections(p=>({...p,[fiche.id]:e.target.value}))} placeholder="Ajouter une note pour cet employé..." style={{width:'100%',padding:'6px 8px',background:'#090c16',border:'1px solid rgba(139,115,60,.1)',borderRadius:6,color:'#e5e5e5',fontSize:10,fontFamily:'inherit',resize:'vertical',minHeight:40,outline:'none',boxSizing:'border-box'}}/>
                    </div>
                  </div>
                </div>
                {/* Action buttons */}
                <div style={{display:'flex',gap:6,marginTop:10,paddingTop:8,borderTop:'1px solid rgba(255,255,255,.05)'}}>
                  <button onClick={()=>previewPack(fiche)} style={{padding:'6px 14px',borderRadius:6,border:'none',background:'linear-gradient(135deg,#c6a34e,#a07d3e)',color:'#060810',fontSize:11,fontWeight:700,cursor:'pointer'}}>📦 Voir le pack complet</button>
                  <button onClick={()=>previewHTML(generateFicheHTML(fiche),'Fiche_'+fiche.name)} style={{padding:'6px 14px',borderRadius:6,border:'none',background:'rgba(34,197,94,.1)',color:'#22c55e',fontSize:11,fontWeight:600,cursor:'pointer'}}>📄 Fiche seule</button>
                  {fiche.anomalies.filter(a=>a.doc).map((a,j)=><button key={j} onClick={()=>previewHTML(generateDocHTML(fiche,a.doc),a.doc+'_'+fiche.name)} style={{padding:'6px 14px',borderRadius:6,border:'none',background:'rgba(239,68,68,.08)',color:'#ef4444',fontSize:11,fontWeight:600,cursor:'pointer'}}>📎 {docLabels[a.doc]||a.doc}</button>)}
                </div>
                {/* Quick detail */}
                <div style={{display:'flex',gap:12,marginTop:8,padding:'8px 0',borderTop:'1px solid rgba(255,255,255,.05)',fontSize:10,color:'#888',flexWrap:'wrap'}}>
                  <span>📋 {fiche.contractType} {fiche.regime}%</span>
                  <span>💼 {fiche.fonction}</span>
                  <span>🏦 {fiche.iban||'Pas d\'IBAN'}</span>
                  <span>📧 {fiche.email||'Pas d\'email'}</span>
                  <span>📅 Début: {fiche.startDate||'N/A'}</span>
                  <span>💰 Coût empl: {f2(fiche.coutTotal)}€</span>
                  {fiche.bonusEmploi>0&&<span>🎁 Bonus emploi: {f2(fiche.bonusEmploi)}€</span>}
                  {fiche.mealV>0&&<span>🍽 Chèques-repas: {f2(fiche.mealV)}€</span>}
                </div>
              </div>}
            </div>;
          })}
        </div>
        {/* Table footer: column headers */}
        <div style={{display:'grid',gridTemplateColumns:'30px 140px 80px 80px 80px 80px 1fr 90px',padding:'6px 12px',background:'rgba(198,163,78,.04)',fontSize:8,color:'#888'}}>
          <div></div><div>Employé</div><div>Brut</div><div>ONSS</div><div>P.Prof</div><div>Net</div><div>Alertes</div><div>Actions</div>
        </div>
      </div>

      {/* ═══ RIGHT: LOGS + SUMMARY ═══ */}
      <div style={{display:'flex',flexDirection:'column',gap:14}}>
        {/* Quick stats */}
        {sr&&<div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:14}}>
          <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:8}}>📊 Synthèse validation</div>
          <div style={{display:'flex',gap:4,marginBottom:8}}>
            <div style={{flex:approved,height:8,borderRadius:4,background:'#22c55e',transition:'flex .3s'}}/>
            <div style={{flex:held||0.01,height:8,borderRadius:4,background:'#eab308',transition:'flex .3s'}}/>
            <div style={{flex:rejected||0.01,height:8,borderRadius:4,background:'#ef4444',transition:'flex .3s'}}/>
          </div>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:10}}>
            <span style={{color:'#22c55e'}}>✅ {approved}</span>
            <span style={{color:'#eab308'}}>⏳ {held}</span>
            <span style={{color:'#ef4444'}}>❌ {rejected}</span>
          </div>
        </div>}

        {/* Required docs summary */}
        {sr&&sr.documents.filter(d=>d.status==='required').length>0&&<div style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(239,68,68,.15)',borderRadius:14}}>
          <div style={{fontSize:12,fontWeight:600,color:'#ef4444',marginBottom:8}}>📎 Documents correctifs requis</div>
          {sr.documents.filter(d=>d.status==='required').map((d,i)=><div key={i} style={{fontSize:10,padding:'4px 0',borderBottom:'1px solid rgba(255,255,255,.03)',color:'#888'}}>
            <span style={{color:'#e5e5e5'}}>{sr.fiches.find(f=>f.id===d.ficheId)?.name}</span> — <span style={{color:'#ef4444'}}>{docLabels[d.type]||d.type}</span>
            <div style={{fontSize:9,color:'#666',marginLeft:10}}>↳ {d.reason}</div>
          </div>)}
        </div>}

        {/* Logs */}
        <div style={{flex:1,border:'1px solid rgba(198,163,78,.1)',borderRadius:14,overflow:'hidden'}}>
          <div style={{padding:'10px 14px',background:'rgba(198,163,78,.06)',display:'flex',justifyContent:'space-between'}}>
            <span style={{fontSize:12,fontWeight:600,color:'#c6a34e'}}>📋 Logs</span>
            <span style={{fontSize:10,color:'#888'}}>{logs.length}</span>
          </div>
          <div style={{maxHeight:300,overflowY:'auto',padding:'6px 10px'}}>
            {logs.map(l=><div key={l.id} style={{padding:'3px 6px',marginBottom:1,fontSize:10,color:l.type==='success'?'#22c55e':l.type==='error'?'#ef4444':l.type==='warn'?'#eab308':'#888',borderLeft:'2px solid '+(l.type==='success'?'#22c55e':l.type==='error'?'#ef4444':l.type==='warn'?'#eab308':'#333'),paddingLeft:8}}>
              <span style={{color:'#555',marginRight:6}}>{l.time}</span>{l.msg}
            </div>)}
          </div>
        </div>
      </div>
    </div>}
  </div>;
};

const CommandCenter=({s,d})=>{
    const clients=s.clients||[];
    const allEmps=clients.reduce((a,c)=>[...a,...(c.emps||[]).map(e=>({...e,clientName:c.company?.name||c.id,clientId:c.id}))],[]);
    const now=new Date();
    const [cmdTab,setCmdTab]=useState('alerts');
    const [contractForm,setContractForm]=useState({type:'CDI',horaire:38,essai:false});
    const [reportPeriod,setReportPeriod]=useState({month:now.getMonth()+1,year:now.getFullYear()});
    const [emailList,setEmailList]=useState([]);
    const [archiveSearch,setArchiveSearch]=useState('');

    // ═══ 1. ALERT CENTER — Auto-scan all clients ═══
    const alerts=[];
    
    // CDD expirant
    clients.forEach(cl=>{(cl.emps||[]).forEach(e=>{
      if((e.contractType||e.contrat?.type)==='CDD'){
        const end=new Date(e.endDate||e.end||'2099-12-31');
        const diff=Math.ceil((end-now)/(1000*60*60*24));
        if(diff<=0)alerts.push({type:'danger',icon:'🔴',msg:'CDD EXPIRÉ: '+(e.first||e.fn)+' '+(e.last||e.ln),detail:cl.company?.name+' — Expiré depuis '+Math.abs(diff)+' jours',action:'C4+Dimona OUT',client:cl.id});
        else if(diff<=7)alerts.push({type:'danger',icon:'🟠',msg:'CDD expire dans '+diff+'j: '+(e.first||e.fn)+' '+(e.last||e.ln),detail:cl.company?.name+' — Fin: '+end.toLocaleDateString('fr-BE'),action:'Préparer sortie',client:cl.id});
        else if(diff<=30)alerts.push({type:'warning',icon:'🟡',msg:'CDD expire dans '+diff+'j: '+(e.first||e.fn)+' '+(e.last||e.ln),detail:cl.company?.name+' — Décision renouvellement',action:'Renouveler/Fin',client:cl.id});
      }
    });});
    
    // NISS manquant
    clients.forEach(cl=>{(cl.emps||[]).filter(e=>!e.niss).forEach(e=>{
      alerts.push({type:'warning',icon:'🆔',msg:'NISS manquant: '+(e.first||e.fn)+' '+(e.last||e.ln),detail:cl.company?.name+' — Dimona impossible sans NISS',action:'Compléter',client:cl.id});
    });});
    
    // IBAN manquant
    clients.forEach(cl=>{(cl.emps||[]).filter(e=>!e.iban).forEach(e=>{
      alerts.push({type:'warning',icon:'🏦',msg:'IBAN manquant: '+(e.first||e.fn)+' '+(e.last||e.ln),detail:cl.company?.name+' — SEPA impossible',action:'Compléter',client:cl.id});
    });});
    
    // Salaire à 0
    clients.forEach(cl=>{(cl.emps||[]).filter(e=>!(+(e.monthlySalary||e.gross||e.brut||0))).forEach(e=>{
      alerts.push({type:'danger',icon:'💰',msg:'Salaire = 0€: '+(e.first||e.fn)+' '+(e.last||e.ln),detail:cl.company?.name+' — Fiche de paie impossible',action:'Compléter',client:cl.id});
    });});
    
    // TVA manquante
    clients.filter(cl=>!cl.company?.vat&&(cl.emps?.length||0)>0).forEach(cl=>{
      alerts.push({type:'warning',icon:'🏢',msg:'TVA manquante: '+(cl.company?.name||cl.id),detail:cl.emps?.length+' employés — Déclarations incomplètes',action:'Compléter',client:cl.id});
    });
    
    // Date début manquante
    clients.forEach(cl=>{(cl.emps||[]).filter(e=>!e.startDate&&!e.start).forEach(e=>{
      alerts.push({type:'info',icon:'📅',msg:'Date début manquante: '+(e.first||e.fn)+' '+(e.last||e.ln),detail:cl.company?.name,action:'Compléter',client:cl.id});
    });});
    
    // Visite médicale (>1 an sans visite)
    clients.forEach(cl=>{(cl.emps||[]).forEach(e=>{
      const lastVisit=e.lastMedical?new Date(e.lastMedical):null;
      const start=new Date(e.startDate||e.start||'2020-01-01');
      const ref=lastVisit||start;
      const months=Math.ceil((now-ref)/(1000*60*60*24*30));
      if(months>=12)alerts.push({type:'warning',icon:'🏥',msg:'Visite médicale > 12 mois: '+(e.first||e.fn)+' '+(e.last||e.ln),detail:cl.company?.name+' — Dernière: '+(lastVisit?lastVisit.toLocaleDateString('fr-BE'):'Jamais'),action:'Planifier',client:cl.id});
    });});
    
    // Email manquant
    clients.forEach(cl=>{(cl.emps||[]).filter(e=>!e.email).forEach(e=>{
      alerts.push({type:'info',icon:'📧',msg:'Email manquant: '+(e.first||e.fn)+' '+(e.last||e.ln),detail:cl.company?.name+' — Envoi fiches impossible',action:'Compléter',client:cl.id});
    });});

    const alertsByType={danger:alerts.filter(a=>a.type==='danger'),warning:alerts.filter(a=>a.type==='warning'),info:alerts.filter(a=>a.type==='info')};

    // ═══ 2. CONTRACT GENERATOR ═══
    const generateContract=(emp,cl,type)=>{
      const co=cl?.company||s.co||{};
      const name=(emp.first||emp.fn||'')+' '+(emp.last||emp.ln||'');
      const brut=+(emp.monthlySalary||emp.gross||emp.brut||0);
      const html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0}body{font-family:Georgia,serif;font-size:12px;padding:50px;max-width:750px;margin:auto;line-height:1.8}h1{text-align:center;font-size:18px;margin:30px 0}h2{font-size:14px;margin:20px 0 8px;border-bottom:1px solid #ccc;padding-bottom:4px}.sig{display:flex;justify-content:space-between;margin-top:60px}@media print{button{display:none!important}}</style></head><body>'+
        '<h1>CONTRAT DE TRAVAIL '+(type||contractForm.type)+'</h1>'+
        '<p><b>Entre</b> '+( co.name||'___')+' (TVA: '+(co.vat||'___')+'), ci-après "l\'employeur",</p>'+
        '<p><b>Et</b> '+name+' (NISS: '+(emp.niss||'___')+'), ci-après "le travailleur".</p>'+
        '<h2>Article 1 — Engagement</h2><p>Le travailleur est engagé en qualité de <b>'+(emp.function||emp.job||'employé(e)')+'</b> à partir du <b>'+(emp.startDate||emp.start||'___')+'</b>'+(type==='CDD'?' jusqu\'au <b>'+(emp.endDate||emp.end||'___')+'</b>':'')+'. Commission paritaire: '+(emp.cp||co.cp||'200')+'.</p>'+
        '<h2>Article 2 — Lieu de travail</h2><p>Le lieu de travail principal est situé au '+(co.addr||co.address||co.rue||'siège social')+'.</p>'+
        '<h2>Article 3 — Durée du travail</h2><p>Le travailleur effectuera <b>'+(emp.whWeek||contractForm.horaire||38)+' heures</b> par semaine, réparties selon l\'horaire en vigueur.</p>'+
        '<h2>Article 4 — Rémunération</h2><p>La rémunération mensuelle brute est fixée à <b>'+new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2}).format(brut)+' EUR</b>.</p>'+
        '<p>Le paiement s\'effectue par virement bancaire'+(emp.iban?' (IBAN: '+emp.iban+')':'')+' au plus tard le dernier jour ouvrable du mois.</p>'+
        '<h2>Article 5 — Avantages</h2><p>Chèques-repas: '+(emp.mealVoucher||'8,00')+' EUR/jour (part patronale: '+(emp.mealVoucherEmployer||'6,91')+' EUR). '+(emp.carAllowance?'Indemnité transport: '+emp.carAllowance+' EUR/mois. ':'')+''+(emp.groupInsurance?'Assurance groupe: oui. ':'')+'</p>'+
        '<h2>Article 6 — Période d\'essai</h2><p>'+(contractForm.essai?'Une période d\'essai de '+(type==='CDD'?'7 jours':'1 mois')+' est convenue.':'Conformément à la loi du 26/12/2013, il n\'y a pas de clause d\'essai.')+'</p>'+
        '<h2>Article 7 — Confidentialité</h2><p>Le travailleur s\'engage à la confidentialité des informations relatives à l\'entreprise.</p>'+
        '<h2>Article 8 — Droit applicable</h2><p>Le présent contrat est régi par la loi belge du 3 juillet 1978 relative aux contrats de travail et par les CCT applicables à la CP '+(emp.cp||co.cp||'200')+'.</p>'+
        '<div class="sig"><div><p>L\'employeur:</p><br/><br/><p>____________________</p><p>'+(co.name||'')+'</p></div><div><p>Le travailleur:</p><br/><br/><p>____________________</p><p>'+name+'</p></div></div>'+
        '<p style="margin-top:40px;font-size:10px;color:#888">Fait en deux exemplaires à '+(co.city||co.ville||'Bruxelles')+', le '+now.toLocaleDateString('fr-BE')+'.</p>'+
        '<div style="text-align:center;margin-top:30px"><button onclick="window.print()">🖨 Imprimer</button></div></body></html>';
      const blob=new Blob([html],{type:'text/html;charset=utf-8'});
      const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
      a.download='Contrat_'+type+'_'+name.replace(/ /g,'_')+'_'+now.toISOString().split('T')[0]+'.html';
      document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
      return name;
    };

    const batchContracts=()=>{
      const withoutContract=allEmps.filter(e=>!e.contractGenerated);
      if(withoutContract.length===0){alert('Tous les contrats sont générés');return;}
      if(!confirm('Générer '+withoutContract.length+' contrats ?'))return;
      let count=0;
      withoutContract.forEach(e=>{
        const cl=clients.find(c=>c.id===e.clientId);
        try{generateContract(e,cl,e.contractType||'CDI');count++;}catch(ex){}
      });
      if(typeof addToast==='function')addToast('📝 '+count+' contrats générés');
    };

    // ═══ 3. AUTO-REPORTS ═══
    const generateMonthlyReport=()=>{
      const m=reportPeriod.month;const y=reportPeriod.year;
      const mois=['','Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
      let totalBrut=0,totalONSSP=0,totalONSSE=0,totalPP=0,totalNet=0;
      const clientData=[];
      clients.forEach(cl=>{
        const co=cl.company||{};
        const emps=cl.emps||[];
        const brut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0);
        const onssP=Math.round(brut*TX_ONSS_E);
        const onssE=Math.round(brut*TX_ONSS_W);
        const pp=quickPP(brut);
        const net=brut-onssE-pp;
        totalBrut+=brut;totalONSSP+=onssP;totalONSSE+=onssE;totalPP+=pp;totalNet+=net;
        if(emps.length>0)clientData.push({name:co.name||cl.id,emps:emps.length,brut,onssP,onssE,pp,net});
      });
      const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2}).format(v);
      const html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0}body{font-family:Arial,sans-serif;font-size:11px;padding:40px;max-width:900px;margin:auto}h1{text-align:center;font-size:18px;margin:20px 0;color:#1a365d}table{width:100%;border-collapse:collapse;margin:15px 0}th{background:#1a365d;color:white;padding:8px;text-align:left;font-size:10px}td{padding:6px 8px;border-bottom:1px solid #eee;font-size:10px}.total{background:#f0f4ff;font-weight:700}.kpi{display:flex;gap:20px;margin:20px 0}.kpi>div{flex:1;padding:15px;background:#f8f9fa;border-radius:8px;text-align:center}.kpi>div>div:first-child{font-size:20px;font-weight:700;color:#1a365d}@media print{button{display:none!important}}</style></head><body>'+
        '<h1>RAPPORT MENSUEL — '+mois[m]+' '+y+'</h1>'+
        '<p style="text-align:center;color:#666">Aureus Social Pro · '+clients.length+' clients · '+allEmps.length+' travailleurs</p>'+
        '<div class="kpi"><div><div>'+f2(totalBrut)+'€</div><div>Masse brute</div></div><div><div>'+f2(totalONSSP)+'€</div><div>ONSS Patronal</div></div><div><div>'+f2(totalONSSE)+'€</div><div>ONSS Personnel</div></div><div><div>'+f2(totalPP)+'€</div><div>Précompte Prof.</div></div><div><div>'+f2(totalNet)+'€</div><div>Net Total</div></div></div>'+
        '<table><tr><th>Client</th><th>Emp.</th><th>Brut</th><th>ONSS Pat.</th><th>ONSS Pers.</th><th>PP</th><th>Net</th></tr>'+
        clientData.sort((a,b)=>b.brut-a.brut).map(c=>'<tr><td>'+c.name+'</td><td>'+c.emps+'</td><td>'+f2(c.brut)+'</td><td>'+f2(c.onssP)+'</td><td>'+f2(c.onssE)+'</td><td>'+f2(c.pp)+'</td><td>'+f2(c.net)+'</td></tr>').join('')+
        '<tr class="total"><td>TOTAL</td><td>'+allEmps.length+'</td><td>'+f2(totalBrut)+'</td><td>'+f2(totalONSSP)+'</td><td>'+f2(totalONSSE)+'</td><td>'+f2(totalPP)+'</td><td>'+f2(totalNet)+'</td></tr></table>'+
        '<h2 style="margin-top:30px;font-size:14px">Alertes</h2><ul>'+
        alerts.filter(a=>a.type==='danger').slice(0,10).map(a=>'<li style="color:#c00;margin:4px 0">'+a.icon+' '+a.msg+'</li>').join('')+
        '</ul><p style="margin-top:30px;font-size:9px;color:#999">Généré le '+now.toLocaleString('fr-BE')+' par Aureus Social Pro</p>'+
        '<div style="text-align:center;margin-top:20px"><button onclick="window.print()">🖨 Imprimer</button></div></body></html>';
      const blob=new Blob([html],{type:'text/html;charset=utf-8'});
      const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
      a.download='Rapport_'+mois[m]+'_'+y+'.html';
      document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
    };

    const generateONSSReconciliation=()=>{
      const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2}).format(v);
      const clientRecon=[];
      clients.forEach(cl=>{
        const emps=cl.emps||[];
        if(emps.length===0)return;
        const brut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0);
        clientRecon.push({name:cl.company?.name||cl.id,emps:emps.length,brutMensuel:brut,brutTrimestriel:brut*3,onssP:Math.round(brut*3*TX_ONSS_E),onssE:Math.round(brut*3*TX_ONSS_W),total:Math.round(brut*3*(TX_ONSS_W+TX_ONSS_E))});
      });
      const totalTri=clientRecon.reduce((a,c)=>a+c.total,0);
      const html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0}body{font-family:Arial,sans-serif;font-size:11px;padding:40px;max-width:900px;margin:auto}h1{text-align:center;font-size:16px;margin:20px 0}table{width:100%;border-collapse:collapse;margin:15px 0}th{background:#2d3748;color:white;padding:8px;text-align:right;font-size:10px}th:first-child{text-align:left}td{padding:6px 8px;border-bottom:1px solid #eee;font-size:10px;text-align:right}td:first-child{text-align:left}.t{font-weight:700;background:#edf2f7}@media print{button{display:none!important}}</style></head><body>'+
        '<h1>RÉCONCILIATION ONSS — Q'+Math.ceil((now.getMonth()+1)/3)+'/'+now.getFullYear()+'</h1>'+
        '<table><tr><th>Client</th><th>Emp.</th><th>Brut/mois</th><th>Brut/trim.</th><th>ONSS Pat. '+(TX_ONSS_E*100).toFixed(2)+'%</th><th>ONSS Pers. "+((LOIS_BELGES.onss.travailleur*100).toFixed(2))+"%</th><th>Total ONSS</th></tr>'+
        clientRecon.sort((a,b)=>b.total-a.total).map(c=>'<tr><td>'+c.name+'</td><td style="text-align:center">'+c.emps+'</td><td>'+f2(c.brutMensuel)+'</td><td>'+f2(c.brutTrimestriel)+'</td><td>'+f2(c.onssP)+'</td><td>'+f2(c.onssE)+'</td><td>'+f2(c.total)+'</td></tr>').join('')+
        '<tr class="t"><td>TOTAL</td><td style="text-align:center">'+allEmps.length+'</td><td>'+f2(clientRecon.reduce((a,c)=>a+c.brutMensuel,0))+'</td><td>'+f2(clientRecon.reduce((a,c)=>a+c.brutTrimestriel,0))+'</td><td>'+f2(clientRecon.reduce((a,c)=>a+c.onssP,0))+'</td><td>'+f2(clientRecon.reduce((a,c)=>a+c.onssE,0))+'</td><td>'+f2(totalTri)+'</td></tr></table>'+
        '<p style="margin-top:20px;font-size:9px;color:#999">Aureus Social Pro — '+now.toLocaleString('fr-BE')+'</p>'+
        '<div style="text-align:center;margin-top:20px"><button onclick="window.print()">🖨 Imprimer</button></div></body></html>';
      const blob=new Blob([html],{type:'text/html;charset=utf-8'});
      const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
      a.download='ONSS_Reconciliation_Q'+Math.ceil((now.getMonth()+1)/3)+'_'+now.getFullYear()+'.html';
      document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
    };

    // ═══ 4. EMAIL DISTRIBUTION LIST ═══
    const buildEmailList=()=>{
      const list=[];
      clients.forEach(cl=>{(cl.emps||[]).forEach(e=>{
        if(e.email)list.push({email:e.email,name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),client:cl.company?.name||cl.id,brut:+(e.monthlySalary||e.gross||e.brut||0)});
      });});
      setEmailList(list);
      return list;
    };

    const exportEmailCSV=()=>{
      const list=emailList.length>0?emailList:buildEmailList();
      if(list.length===0){alert('Aucun email trouvé');return;}
      const csv='email;nom;client;brut\n'+list.map(l=>l.email+';'+l.name+';'+l.client+';'+l.brut).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
      const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
      a.download='Distribution_emails_'+now.toISOString().split('T')[0]+'.csv';
      document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
    };

    // ═══ 5. DOCUMENT ARCHIVE ═══
    let docHistory=[];try{docHistory=((()=>{try{return JSON.parse(safeLS.get('aureus_doc_archive'))}catch(e){return null}})()||[]).slice(0,100);}catch(e){}

    const tabs=[
      {id:'alerts',l:'🚨 Alertes ('+alerts.length+')'},
      {id:'contrats',l:'📝 Contrats'},
      {id:'rapports',l:'📊 Rapports'},
      {id:'onss',l:'🏛️ ONSS'},
      {id:'email',l:'📧 Distribution'},
      {id:'qualite',l:'🔍 Qualité'},
    ];

    return <div style={{padding:24}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
        <div>
          <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🎯 Command Center</h2>
          <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Alertes, contrats, rapports, distribution — tout au même endroit</p>
        </div>
        <div style={{display:'flex',gap:8}}>
          {[{v:alerts.filter(a=>a.type==='danger').length,l:'Critiques',c:'#ef4444'},{v:alerts.filter(a=>a.type==='warning').length,l:'Avertissements',c:'#eab308'},{v:clients.length,l:'Clients',c:'#c6a34e'},{v:allEmps.length,l:'Employés',c:'#3b82f6'}].map((k,i)=>
            <div key={i} style={{padding:'6px 12px',background:'rgba(255,255,255,.03)',border:'1px solid rgba(255,255,255,.06)',borderRadius:8,textAlign:'center'}}>
              <div style={{fontSize:15,fontWeight:700,color:k.c}}>{k.v}</div>
              <div style={{fontSize:8,color:'#888'}}>{k.l}</div>
            </div>)}
        </div>
      </div>

      {/* Tabs */}
      <div style={{display:'flex',gap:4,marginBottom:20,flexWrap:'wrap'}}>
        {tabs.map(tb=><button key={tb.id} onClick={()=>setCmdTab(tb.id)} style={{padding:'10px 14px',borderRadius:10,border:cmdTab===tb.id?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.05)',background:cmdTab===tb.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:cmdTab===tb.id?'#c6a34e':'#888',fontSize:11,fontWeight:cmdTab===tb.id?600:400,cursor:'pointer'}}>{tb.l}</button>)}
      </div>

      {/* TAB: Alerts */}
      {cmdTab==='alerts'&&<div>
        {alerts.length===0?<div style={{textAlign:'center',padding:40}}><div style={{fontSize:50}}>✅</div><div style={{fontSize:16,fontWeight:600,color:'#22c55e',marginTop:8}}>Aucune alerte !</div></div>:<>
          {alertsByType.danger.length>0&&<div style={{marginBottom:16}}>
            <div style={{fontSize:13,fontWeight:600,color:'#ef4444',marginBottom:8}}>🔴 Critiques ({alertsByType.danger.length})</div>
            {alertsByType.danger.map((a,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:12,padding:'10px 14px',background:'rgba(239,68,68,.04)',border:'1px solid rgba(239,68,68,.12)',borderRadius:10,marginBottom:6}}>
              <span style={{fontSize:18}}>{a.icon}</span>
              <div style={{flex:1}}><div style={{fontSize:12,fontWeight:500,color:'#e5e5e5'}}>{a.msg}</div><div style={{fontSize:10,color:'#888'}}>{a.detail}</div></div>
              <button onClick={()=>d({type:'SELECT_CLIENT',id:a.client})} style={{padding:'5px 12px',borderRadius:6,border:'none',background:'rgba(239,68,68,.15)',color:'#ef4444',fontSize:10,cursor:'pointer',fontWeight:600}}>{a.action}</button>
            </div>)}
          </div>}
          {alertsByType.warning.length>0&&<div style={{marginBottom:16}}>
            <div style={{fontSize:13,fontWeight:600,color:'#eab308',marginBottom:8}}>🟡 Avertissements ({alertsByType.warning.length})</div>
            {alertsByType.warning.slice(0,20).map((a,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:12,padding:'8px 14px',background:'rgba(234,179,8,.03)',border:'1px solid rgba(234,179,8,.08)',borderRadius:10,marginBottom:4}}>
              <span style={{fontSize:16}}>{a.icon}</span>
              <div style={{flex:1}}><div style={{fontSize:11,color:'#e5e5e5'}}>{a.msg}</div><div style={{fontSize:10,color:'#888'}}>{a.detail}</div></div>
              <button onClick={()=>d({type:'SELECT_CLIENT',id:a.client})} style={{padding:'4px 10px',borderRadius:6,border:'none',background:'rgba(234,179,8,.1)',color:'#eab308',fontSize:9,cursor:'pointer'}}>{a.action}</button>
            </div>)}
            {alertsByType.warning.length>20&&<div style={{fontSize:11,color:'#888',textAlign:'center',marginTop:8}}>+ {alertsByType.warning.length-20} autres avertissements</div>}
          </div>}
          {alertsByType.info.length>0&&<div>
            <div style={{fontSize:13,fontWeight:600,color:'#888',marginBottom:8}}>ℹ️ Informations ({alertsByType.info.length})</div>
            {alertsByType.info.slice(0,10).map((a,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:12,padding:'6px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
              <span>{a.icon}</span><span style={{flex:1,color:'#999'}}>{a.msg}</span>
              <button onClick={()=>d({type:'SELECT_CLIENT',id:a.client})} style={{padding:'3px 8px',borderRadius:4,border:'none',background:'rgba(255,255,255,.05)',color:'#888',fontSize:9,cursor:'pointer'}}>→</button>
            </div>)}
          </div>}
        </>}
      </div>}

      {/* TAB: Contrats */}
      {cmdTab==='contrats'&&<div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:20,marginBottom:20}}>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14}}>
            <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:14}}>📝 Générer un Contrat</div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:14}}>
              <div>
                <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Type</label>
                <select value={contractForm.type} onChange={e=>setContractForm(p=>({...p,type:e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:6,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',outline:'none'}}>
                  <option value="CDI">CDI</option><option value="CDD">CDD</option><option value="temps_partiel">Temps partiel</option><option value="etudiant">Étudiant</option><option value="interim">Intérimaire</option>
                </select>
              </div>
              <div>
                <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Horaire/sem</label>
                <input type="number" value={contractForm.horaire} onChange={e=>setContractForm(p=>({...p,horaire:+e.target.value}))} style={{width:'100%',padding:'8px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:6,color:'#e5e5e5',fontSize:12,fontFamily:'inherit',outline:'none',boxSizing:'border-box'}}/>
              </div>
            </div>
            <button onClick={batchContracts} style={{width:'100%',padding:'12px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#c6a34e,#d4af37)',color:'#000',fontWeight:700,fontSize:13,cursor:'pointer'}}>📝 Générer TOUS les contrats ({allEmps.length})</button>
          </div>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(59,130,246,.15)',borderRadius:14}}>
            <div style={{fontSize:14,fontWeight:600,color:'#3b82f6',marginBottom:14}}>📋 Contrats par client</div>
            <div style={{maxHeight:200,overflowY:'auto'}}>
              {clients.filter(c=>(c.emps?.length||0)>0).map((cl,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
                <span style={{fontSize:11,color:'#e5e5e5'}}>{cl.company?.name||cl.id} ({cl.emps?.length||0})</span>
                <button onClick={()=>{(cl.emps||[]).forEach(e=>generateContract(e,cl,e.contractType||'CDI'));if(typeof addToast==='function')addToast('📝 '+(cl.emps||[]).length+' contrats générés');}} style={{padding:'3px 10px',borderRadius:6,border:'none',background:'rgba(59,130,246,.1)',color:'#3b82f6',fontSize:10,cursor:'pointer'}}>Générer</button>
              </div>)}
            </div>
          </div>
        </div>
      </div>}

      {/* TAB: Rapports */}
      {cmdTab==='rapports'&&<div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14}}>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14,textAlign:'center'}}>
            <div style={{fontSize:30,marginBottom:8}}>📊</div>
            <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:6}}>Rapport Mensuel</div>
            <div style={{fontSize:11,color:'#888',marginBottom:14}}>KPIs, masse salariale, alertes</div>
            <div style={{display:'flex',gap:6,justifyContent:'center',marginBottom:10}}>
              <select value={reportPeriod.month} onChange={e=>setReportPeriod(p=>({...p,month:+e.target.value}))} style={{padding:'6px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',outline:'none'}}>
                {['Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'].map((m,i)=><option key={i} value={i+1}>{m}</option>)}
              </select>
              <select value={reportPeriod.year} onChange={e=>setReportPeriod(p=>({...p,year:+e.target.value}))} style={{padding:'6px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:6,color:'#e5e5e5',fontSize:11,fontFamily:'inherit',outline:'none'}}>
                {[2024,2025,2026].map(y=><option key={y} value={y}>{y}</option>)}
              </select>
            </div>
            <button onClick={generateMonthlyReport} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'#c6a34e',color:'#000',fontWeight:600,fontSize:12,cursor:'pointer'}}>📊 Générer</button>
          </div>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(168,85,247,.15)',borderRadius:14,textAlign:'center'}}>
            <div style={{fontSize:30,marginBottom:8}}>🏛️</div>
            <div style={{fontSize:14,fontWeight:600,color:'#a855f7',marginBottom:6}}>Réconciliation ONSS</div>
            <div style={{fontSize:11,color:'#888',marginBottom:14}}>Par client, trimestriel</div>
            <button onClick={generateONSSReconciliation} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'#a855f7',color:'#fff',fontWeight:600,fontSize:12,cursor:'pointer'}}>🏛️ Générer</button>
          </div>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(34,197,94,.15)',borderRadius:14,textAlign:'center'}}>
            <div style={{fontSize:30,marginBottom:8}}>📈</div>
            <div style={{fontSize:14,fontWeight:600,color:'#22c55e',marginBottom:6}}>Tableau de Bord KPI</div>
            <div style={{fontSize:11,color:'#888',marginBottom:14}}>Export pour Direction</div>
            <button onClick={()=>{generateMonthlyReport();generateONSSReconciliation();if(typeof addToast==='function')addToast('📈 Rapport complet exporté');}} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'#22c55e',color:'#fff',fontWeight:600,fontSize:12,cursor:'pointer'}}>📈 Tout Exporter</button>
          </div>
        </div>
      </div>}

      {/* TAB: ONSS */}
      {cmdTab==='onss'&&<div>
        <div style={{marginBottom:16,padding:16,background:'rgba(168,85,247,.04)',border:'1px solid rgba(168,85,247,.15)',borderRadius:12}}>
          <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:12,textAlign:'center'}}>
            {[{l:'Masse brute',v:allEmps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0),c:'#c6a34e'},
              {l:'ONSS Patronal',v:Math.round(allEmps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0)*TX_ONSS_E),c:'#a855f7'},
              {l:'ONSS Personnel',v:Math.round(allEmps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0)*TX_ONSS_W),c:'#3b82f6'},
              {l:'Total ONSS/mois',v:Math.round(allEmps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0)*(TX_ONSS_W+TX_ONSS_E)),c:'#ef4444'},
              {l:'ONSS/trimestre',v:Math.round(allEmps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0)*(TX_ONSS_W+TX_ONSS_E)*3),c:'#22c55e'}
            ].map((k,i)=><div key={i} style={{padding:14,background:'rgba(255,255,255,.02)',borderRadius:10}}>
              <div style={{fontSize:18,fontWeight:700,color:k.c}}>{new Intl.NumberFormat('fr-BE').format(k.v)}€</div>
              <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
            </div>)}
          </div>
        </div>
        <button onClick={generateONSSReconciliation} style={{width:'100%',padding:'14px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#a855f7,#7c3aed)',color:'#fff',fontWeight:700,fontSize:14,cursor:'pointer'}}>🏛️ Générer Réconciliation ONSS Trimestrielle</button>
      </div>}

      {/* TAB: Email */}
      {cmdTab==='email'&&<div>
        <div style={{display:'flex',gap:10,marginBottom:16}}>
          <button onClick={()=>buildEmailList()} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'#3b82f6',color:'#fff',fontWeight:600,fontSize:12,cursor:'pointer'}}>📧 Scanner emails ({allEmps.filter(e=>e.email).length})</button>
          <button onClick={exportEmailCSV} style={{padding:'10px 20px',borderRadius:8,border:'none',background:'#22c55e',color:'#fff',fontWeight:600,fontSize:12,cursor:'pointer'}}>📥 Exporter CSV</button>
        </div>
        {emailList.length>0&&<div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:12,overflow:'hidden'}}>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 80px',padding:'8px 14px',background:'rgba(198,163,78,.06)',fontSize:10,fontWeight:600,color:'#c6a34e'}}>
            <div>Email</div><div>Nom</div><div>Client</div><div>Brut</div>
          </div>
          <div style={{maxHeight:300,overflowY:'auto'}}>
            {emailList.map((l,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 80px',padding:'6px 14px',borderTop:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
              <span style={{color:'#3b82f6'}}>{l.email}</span>
              <span style={{color:'#e5e5e5'}}>{l.name}</span>
              <span style={{color:'#888'}}>{l.client}</span>
              <span style={{color:'#22c55e'}}>{l.brut}€</span>
            </div>)}
          </div>
        </div>}
        {allEmps.filter(e=>!e.email).length>0&&<div style={{marginTop:12,padding:10,background:'rgba(234,179,8,.06)',borderRadius:8,fontSize:11,color:'#eab308'}}>
          ⚠️ {allEmps.filter(e=>!e.email).length} employés n'ont pas d'email — fiches de paie envoyées impossible
        </div>}
      </div>}

      {/* TAB: Qualité */}
      {cmdTab==='qualite'&&<div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14,marginBottom:20}}>
          {[{l:'Données complètes',v:Math.round(allEmps.filter(e=>e.niss&&e.iban&&(+(e.monthlySalary||e.gross||e.brut||0))>0&&e.email).length/Math.max(allEmps.length,1)*100)+'%',c:allEmps.filter(e=>e.niss&&e.iban&&(+(e.monthlySalary||e.gross||e.brut||0))>0&&e.email).length===allEmps.length?'#22c55e':'#eab308'},
            {l:'Avec NISS',v:allEmps.filter(e=>e.niss).length+'/'+allEmps.length,c:allEmps.every(e=>e.niss)?'#22c55e':'#ef4444'},
            {l:'Avec IBAN',v:allEmps.filter(e=>e.iban).length+'/'+allEmps.length,c:allEmps.every(e=>e.iban)?'#22c55e':'#ef4444'},
            {l:'Avec Email',v:allEmps.filter(e=>e.email).length+'/'+allEmps.length,c:'#3b82f6'},
            {l:'Salaire > 0',v:allEmps.filter(e=>(+(e.monthlySalary||e.gross||e.brut||0))>0).length+'/'+allEmps.length,c:allEmps.every(e=>(+(e.monthlySalary||e.gross||e.brut||0))>0)?'#22c55e':'#ef4444'},
            {l:'Clients TVA',v:clients.filter(c=>c.company?.vat).length+'/'+clients.length,c:'#a855f7'}
          ].map((k,i)=><div key={i} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+k.c+'30',borderRadius:12,textAlign:'center'}}>
            <div style={{fontSize:22,fontWeight:700,color:k.c}}>{k.v}</div>
            <div style={{fontSize:10,color:'#888'}}>{k.l}</div>
          </div>)}
        </div>
        <button onClick={()=>{const missing=[];allEmps.forEach(e=>{if(!e.niss)missing.push(e.clientName+': '+(e.first||e.fn)+' — NISS manquant');if(!e.iban)missing.push(e.clientName+': '+(e.first||e.fn)+' — IBAN manquant');});if(missing.length===0)alert('✅ Toutes les données sont complètes !');else{const csv='Client;Employé;Problème\n'+missing.map(m=>m.replace(': ',';').replace(' — ',';')).join('\n');const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='Donnees_manquantes.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);}}} style={{width:'100%',padding:'12px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#c6a34e,#d4af37)',color:'#000',fontWeight:700,fontSize:13,cursor:'pointer'}}>🔍 Exporter données manquantes (CSV)</button>
      </div>}
    </div>;
  };

const SmartAutopilot=({s,d})=>{
    const clients=s.clients||[];
    const totalEmps=clients.reduce((a,c)=>a+(c.emps?.length||0),0);
    const now=new Date();
    const day=now.getDate();
    const month=now.getMonth()+1;
    const quarter=Math.ceil(month/3);
    const mois=['','Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
    const [pilotTab,setPilotTab]=useState('smart');
    const [csvData,setCsvData]=useState(null);
    const [csvPreview,setCsvPreview]=useState([]);
    const [importType,setImportType]=useState('employees');
    const [autoResults,setAutoResults]=useState([]);

    // SMART DETECT: what needs to be done TODAY
    const smartTasks=[];
    
    // Mensuel: Fiches de paie (25 du mois)
    if(day>=20&&day<=28) smartTasks.push({id:'fiches',priority:'high',icon:'📄',task:'Fiches de paie '+mois[month],desc:totalEmps+' fiches à générer',color:'#c6a34e',auto:true,
      fn:()=>{clients.forEach(cl=>{(cl.emps||[]).forEach(e=>generatePayslipPDF(e,cl.company||{}))});}});
    
    // Mensuel: SEPA (25 du mois)
    if(day>=23&&day<=28) smartTasks.push({id:'sepa',priority:'high',icon:'💸',task:'SEPA Virements '+mois[month],desc:clients.filter(c=>(c.emps?.length||0)>0).length+' fichiers SEPA',color:'#22c55e',auto:true,
      fn:()=>{clients.filter(c=>(c.emps?.length||0)>0).forEach(cl=>generateSEPAXML(cl.emps||[],cl.company||{}));}});
    
    // Mensuel: Précompte (avant le 15)
    if(day>=1&&day<=15) smartTasks.push({id:'precompte',priority:'high',icon:'💰',task:'Précompte Prof. 274',desc:'Déclaration SPF Finances avant le 15',color:'#ef4444',auto:true,
      fn:()=>{const lines=[];let totalPP=0;clients.forEach(cl=>{(cl.emps||[]).filter(e=>e.status==='active'||!e.status).forEach(e=>{const brut=+(e.monthlySalary||e.gross||0);const pp=quickPP(brut);totalPP+=pp;lines.push(((e.first||e.fn||'')+" "+(e.last||e.ln||''))+";"+brut.toFixed(2)+";"+pp.toFixed(2));});});const csv="Employé;Brut;Précompte\n"+lines.join("\n")+"\n\nTOTAL;;"+totalPP.toFixed(2);const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='Precompte_274_'+mois[month]+'_'+now.getFullYear()+'.csv';document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);}});

    // Mensuel: ONSS Provisions (5 du mois)
    if(day>=1&&day<=5) smartTasks.push({id:'onss',priority:'high',icon:'📈',task:'Provisions ONSS',desc:'Provisions mensuelles cotisations',color:'#f59e0b',auto:true,
      fn:()=>{const lines=[];let totalONSSW=0,totalONSSE=0;clients.forEach(cl=>{(cl.emps||[]).filter(e=>e.status==='active'||!e.status).forEach(e=>{const brut=+(e.monthlySalary||e.gross||0);const ow=Math.round(brut*TX_ONSS_W*100)/100;const oe=Math.round(brut*TX_ONSS_E*100)/100;totalONSSW+=ow;totalONSSE+=oe;lines.push(((e.first||e.fn||'')+" "+(e.last||e.ln||''))+";"+brut.toFixed(2)+";"+ow.toFixed(2)+";"+oe.toFixed(2));});});const csv="Employé;Brut;ONSS Travailleur;ONSS Employeur\n"+lines.join("\n")+"\n\nTOTAL;;"+totalONSSW.toFixed(2)+";"+totalONSSE.toFixed(2);const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='Provisions_ONSS_'+mois[month]+'_'+now.getFullYear()+'.csv';document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);}});
    
    // Trimestriel: DmfA (fin trimestre)
    if((month%3===0&&day>=15)||(month%3===1&&day<=10)) smartTasks.push({id:'dmfa',priority:'medium',icon:'📊',task:'DmfA Q'+quarter+'/'+now.getFullYear(),desc:totalEmps+' travailleurs à déclarer',color:'#a855f7',auto:true,
      fn:()=>{clients.filter(c=>(c.emps?.length||0)>0).forEach(cl=>generateDmfAXML(cl.emps||[],Math.ceil((new Date().getMonth()+1)/3),new Date().getFullYear(),cl.company||{}));}});
    
    // Annuel: Belcotax (janvier-février)
    if(month<=2) smartTasks.push({id:'belcotax',priority:'medium',icon:'🏛️',task:'Belcotax 281.10 — '+(now.getFullYear()-1),desc:totalEmps+' fiches fiscales',color:'#ef4444',auto:true,
      fn:()=>{clients.forEach(cl=>{(cl.emps||[]).forEach(e=>generateBelcotaxXML(e,cl.company||{}))});}});
    
    // Annuel: Bilan Social BNB (février)
    if(month===2) smartTasks.push({id:'bilan',priority:'medium',icon:'🏛️',task:'Bilan Social BNB',desc:'Rapport annuel Banque Nationale',color:'#6366f1',auto:true,
      fn:()=>{const totETP=clients.reduce((a,cl)=>a+(cl.emps||[]).filter(e=>e.status==='active'||!e.status).reduce((s,e)=>s+(+(e.regime||e.whWeek||38))/38,0),0);const totBrut=clients.reduce((a,cl)=>a+(cl.emps||[]).filter(e=>e.status==='active'||!e.status).reduce((s,e)=>s+(+(e.monthlySalary||e.gross||0))*12,0),0);const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v);const html='<!DOCTYPE html><html><head><meta charset="utf-8"><style>body{font:12px Arial;padding:40px;max-width:800px;margin:auto}table{width:100%;border-collapse:collapse;margin:15px 0}th,td{padding:6px 10px;border:1px solid #ccc;text-align:left}@media print{button{display:none!important}}</style></head><body><h2>BILAN SOCIAL — Exercice '+(now.getFullYear()-1)+'</h2><table><tr><th>Indicateur</th><th>Valeur</th></tr><tr><td>Nombre d\'entreprises</td><td>'+clients.length+'</td></tr><tr><td>Effectif total</td><td>'+totalEmps+' travailleurs</td></tr><tr><td>ETP (équivalents temps plein)</td><td>'+totETP.toFixed(1)+'</td></tr><tr><td>Masse salariale brute annuelle</td><td>'+f2(totBrut)+' €</td></tr><tr><td>Hommes/Femmes</td><td>'+clients.reduce((a,cl)=>a+(cl.emps||[]).filter(e=>e.gender==='M'||e.genre==='M').length,0)+' / '+clients.reduce((a,cl)=>a+(cl.emps||[]).filter(e=>e.gender==='F'||e.genre==='F').length,0)+'</td></tr><tr><td>CDI</td><td>'+clients.reduce((a,cl)=>a+(cl.emps||[]).filter(e=>(e.contractType||'CDI')==='CDI').length,0)+'</td></tr><tr><td>CDD</td><td>'+clients.reduce((a,cl)=>a+(cl.emps||[]).filter(e=>e.contractType==='CDD').length,0)+'</td></tr></table><div style="text-align:center;margin-top:20px"><button onclick="window.print()">Imprimer</button></div></body></html>';previewHTML(html,'Bilan_Social_BNB_'+(now.getFullYear()-1));}});

    // Annuel: Pécule vacances (mai-juin)
    if(month>=5&&month<=6) smartTasks.push({id:'pecule',priority:'medium',icon:'🏖️',task:'Pécule de Vacances '+now.getFullYear(),desc:totalEmps+' calculs',color:'#06b6d4',auto:true,
      fn:()=>{const lines=[];let totalPecule=0;clients.forEach(cl=>{(cl.emps||[]).filter(e=>e.status==='active'||!e.status).forEach(e=>{const brut=+(e.monthlySalary||e.gross||0);const annuel=brut*12;const simple=Math.round(brut*100)/100;const double=Math.round(annuel*0.0769*100)/100;totalPecule+=simple+double;lines.push(((e.first||e.fn||'')+" "+(e.last||e.ln||''))+";"+brut.toFixed(2)+";"+simple.toFixed(2)+";"+double.toFixed(2));});});const csv="Employé;Brut mensuel;Pécule simple;Pécule double\n"+lines.join("\n")+"\n\nTOTAL;;;"+totalPecule.toFixed(2);const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='Pecule_Vacances_'+now.getFullYear()+'.csv';document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);}});

    // Annuel: 13ème mois (décembre)
    if(month===12) smartTasks.push({id:'treizieme',priority:'high',icon:'🎄',task:'13ème Mois / Prime',desc:totalEmps+' primes à calculer',color:'#f59e0b',auto:true,
      fn:()=>{const lines=[];let totalPrime=0;clients.forEach(cl=>{(cl.emps||[]).filter(e=>e.status==='active'||!e.status).forEach(e=>{const brut=+(e.monthlySalary||e.gross||0);const prime=brut;const onss=Math.round(prime*TX_ONSS_W*100)/100;const pp=quickPP(prime);const net=Math.round((prime-onss-pp)*100)/100;totalPrime+=prime;lines.push(((e.first||e.fn||'')+" "+(e.last||e.ln||''))+";"+brut.toFixed(2)+";"+prime.toFixed(2)+";"+onss.toFixed(2)+";"+pp.toFixed(2)+";"+net.toFixed(2));});});const csv="Employé;Brut mensuel;Prime brute;ONSS;PP;Prime nette\n"+lines.join("\n")+"\n\nTOTAL;"+totalPrime.toFixed(2);const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='13eme_mois_'+now.getFullYear()+'.csv';document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);}});
    
    // Événement: CDD expirant dans 30 jours
    const expiringCDD=clients.reduce((a,cl)=>{
      return a+(cl.emps||[]).filter(e=>{
        if((e.contractType||e.contrat?.type)!=='CDD')return false;
        const end=new Date(e.endDate||e.end||'2099-12-31');
        const diff=Math.ceil((end-now)/(1000*60*60*24));
        return diff>0&&diff<=30;
      }).length;
    },0);
    if(expiringCDD>0) smartTasks.push({id:'cdd',priority:'urgent',icon:'⚠️',task:expiringCDD+' CDD expirent dans 30j',desc:'Dimona OUT + C4 à préparer',color:'#ef4444',auto:false,
      fn:()=>{const expiring=[];clients.forEach(cl=>{(cl.emps||[]).filter(e=>{if((e.contractType||e.contrat?.type)!=='CDD')return false;const end=new Date(e.endDate||e.end||'2099-12-31');const diff=Math.ceil((end-now)/(1000*60*60*24));return diff>0&&diff<=30;}).forEach(e=>{expiring.push({emp:e,co:cl.company||{}});});});expiring.forEach(({emp,co})=>{generateDimonaXML(emp,'OUT',co);generateC4PDF(emp,co);});}});
    
    // Événement: Nouveaux employés sans Dimona
    const newEmps=clients.reduce((a,cl)=>{
      return a+(cl.emps||[]).filter(e=>{
        const start=new Date(e.startDate||e.start||'2020-01-01');
        const diff=Math.ceil((now-start)/(1000*60*60*24));
        return diff>=0&&diff<=7;
      }).length;
    },0);
    if(newEmps>0) smartTasks.push({id:'dimona_new',priority:'urgent',icon:'📡',task:newEmps+' Dimona IN à envoyer',desc:'Nouveaux employés cette semaine',color:'#3b82f6',auto:true,
      fn:()=>{clients.forEach(cl=>{(cl.emps||[]).filter(e=>{const d2=new Date(e.startDate||e.start||'2020-01-01');return Math.ceil((now-d2)/(1000*60*60*24))<=7;}).forEach(e=>generateDimonaXML(e,'IN',cl.company));});}});

    // Always show: data quality check
    const incomplete=clients.filter(cl=>{
      const co=cl.company||{};
      const emps=cl.emps||[];
      return !co.name||!co.vat||emps.length===0||emps.some(e=>!(e.monthlySalary||e.gross||e.brut));
    }).length;
    if(incomplete>0) smartTasks.push({id:'quality',priority:'info',icon:'🔍',task:incomplete+' dossiers incomplets',desc:'Données manquantes à compléter',color:'#eab308',auto:false,fn:()=>d({type:'NAV',page:'clients'})});

    const runAllSmart=()=>{
      const autoTasks=smartTasks.filter(t=>t.auto&&t.fn);
      if(autoTasks.length===0){alert('Aucune tâche auto à exécuter');return;}
      if(!confirm('🤖 AUTOPILOT\n\nExécuter '+autoTasks.length+' tâches automatiquement :\n\n'+autoTasks.map(t=>t.icon+' '+t.task).join('\n')+'\n\n1 seule confirmation. Je gère le reste.'))return;
      const results=[];
      autoTasks.forEach(t=>{
        try{t.fn();results.push({task:t.task,status:'ok'});}
        catch(e){results.push({task:t.task,status:'error',msg:e.message});}
      });
      setAutoResults(results);
      if(typeof addToast==='function')addToast('🤖 Autopilot: '+results.filter(r=>r.status==='ok').length+'/'+results.length+' tâches exécutées');
    };

    // CSV IMPORT
    const handleCSV=(e)=>{
      const file=e.target.files[0];if(!file)return;
      const reader=new FileReader();
      reader.onload=(ev)=>{
        const text=ev.target.result;
        const lines=text.split('\n').map(l=>l.split(';').map(c=>c.trim().replace(/^"|"$/g,'')));
        if(lines.length<2){alert('Fichier vide');return;}
        setCsvData({headers:lines[0],rows:lines.slice(1).filter(r=>r.length>1&&r.some(c=>c))});
        setCsvPreview(lines.slice(0,6));
      };
      reader.readAsText(file,'utf-8');
      e.target.value='';
    };

    const importCSV=()=>{
      if(!csvData||csvData.rows.length===0){alert('Aucune donnée');return;}
      const h=csvData.headers.map(x=>x.toLowerCase());
      let count=0;
      
      if(importType==='employees'){
        // Map CSV to employees - detect columns
        const iNom=h.findIndex(x=>x.includes('nom')||x.includes('last')||x.includes('name'));
        const iPrenom=h.findIndex(x=>x.includes('prenom')||x.includes('prénom')||x.includes('first'));
        const iNiss=h.findIndex(x=>x.includes('niss')||x.includes('registre'));
        const iBrut=h.findIndex(x=>x.includes('brut')||x.includes('salaire')||x.includes('gross'));
        const iEmail=h.findIndex(x=>x.includes('email')||x.includes('mail'));
        const iIban=h.findIndex(x=>x.includes('iban')||x.includes('compte'));
        const iContrat=h.findIndex(x=>x.includes('contrat')||x.includes('contract')||x.includes('type'));
        const iDebut=h.findIndex(x=>x.includes('debut')||x.includes('début')||x.includes('start'));
        const iGenre=h.findIndex(x=>x.includes('genre')||x.includes('sexe')||x.includes('gender'));
        
        const newEmps=csvData.rows.map(r=>({
          id:'EMP-'+Date.now()+'-'+Math.random().toString(36).substr(2,6),
          last:iNom>=0?r[iNom]:'',
          first:iPrenom>=0?r[iPrenom]:'',
          niss:iNiss>=0?r[iNiss]:'',
          monthlySalary:iBrut>=0?parseFloat(r[iBrut]?.replace(/[^\d.,]/g,'').replace(',','.'))||0:0,
          email:iEmail>=0?r[iEmail]:'',
          iban:iIban>=0?r[iIban]:'',
          contractType:iContrat>=0?r[iContrat]:'CDI',
          startDate:iDebut>=0?r[iDebut]:'',
          gender:iGenre>=0?r[iGenre]:'',
          status:'active'
        })).filter(e=>e.last||e.first);
        
        if(newEmps.length>0){
          d({type:'ADD_EMPS_BATCH',data:newEmps});
          count=newEmps.length;
        }
      } else {
        // Import clients
        const iNom=h.findIndex(x=>x.includes('societe')||x.includes('société')||x.includes('company')||x.includes('nom'));
        const iTva=h.findIndex(x=>x.includes('tva')||x.includes('vat'));
        const iAddr=h.findIndex(x=>x.includes('adresse')||x.includes('address'));
        const iBce=h.findIndex(x=>x.includes('bce'));
        
        csvData.rows.forEach(r=>{
          const name=iNom>=0?r[iNom]:'';
          if(!name)return;
          d({type:'ADD_CLIENT',d:{company:{name,vat:iTva>=0?r[iTva]:'',addr:iAddr>=0?r[iAddr]:'',bce:iBce>=0?r[iBce]:''},emps:[],pays:[]}});
          count++;
        });
      }
      
      setCsvData(null);setCsvPreview([]);
      if(typeof addToast==='function')addToast('📥 Import: '+count+(importType==='employees'?' employés':' clients')+' ajoutés');
      alert('✅ '+count+(importType==='employees'?' employés':' clients')+' importés avec succès');
    };

    // ZIP EXPORT
    const exportAllDocs=async()=>{
      if(!confirm('📦 Exporter TOUS les documents ?\n\n'+clients.length+' clients × '+totalEmps+' employés\n\nChaque client recevra un dossier avec toutes ses fiches.'))return;
      
      let totalDocs=0;
      for(const cl of clients){
        const co=cl.company||{};
        const emps=cl.emps||[];
        if(emps.length===0)continue;
        
        // Generate all docs for this client
        emps.forEach(e=>{
          try{generatePayslipPDF(e,co);totalDocs++;}catch(ex){}
        });
        try{generateSEPAXML(emps,{month:new Date().getMonth()+1,year:new Date().getFullYear()},co);totalDocs++;}catch(ex){}
        try{generateDmfAXML(emps,Math.ceil((new Date().getMonth()+1)/3),new Date().getFullYear(),co);totalDocs++;}catch(ex){}
      }
      if(typeof addToast==='function')addToast('📦 Export complet: '+totalDocs+' documents générés pour '+clients.length+' clients');
    };

    return <div style={{padding:24}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
        <div>
          <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🤖 Smart Autopilot</h2>
          <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>L'IA détecte ce qui doit être fait — Vous confirmez une seule fois</p>
        </div>
        <button onClick={runAllSmart} disabled={smartTasks.filter(t=>t.auto).length===0} style={{padding:'12px 24px',borderRadius:12,border:'none',background:smartTasks.filter(t=>t.auto).length>0?'linear-gradient(135deg,#c6a34e,#d4af37)':'#555',color:smartTasks.filter(t=>t.auto).length>0?'#000':'#999',fontWeight:700,fontSize:13,cursor:smartTasks.filter(t=>t.auto).length>0?'pointer':'not-allowed',boxShadow:smartTasks.filter(t=>t.auto).length>0?'0 4px 20px rgba(198,163,78,.35)':'none'}}>
          🤖 AUTOPILOT — {smartTasks.filter(t=>t.auto).length} tâches
        </button>
      </div>

      {/* Tabs */}
      <div style={{display:'flex',gap:4,marginBottom:20}}>
        {[{id:'smart',l:'🤖 Smart Detect'},{id:'import',l:'📥 Import CSV'},{id:'export',l:'📦 Export Tout'},{id:'calendrier',l:'📅 Calendrier Auto'}].map(tb=>
          <button key={tb.id} onClick={()=>setPilotTab(tb.id)} style={{padding:'10px 16px',borderRadius:10,border:pilotTab===tb.id?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.05)',background:pilotTab===tb.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:pilotTab===tb.id?'#c6a34e':'#888',fontSize:12,fontWeight:pilotTab===tb.id?600:400,cursor:'pointer'}}>{tb.l}</button>)}
      </div>

      {/* TAB: Smart Detect */}
      {pilotTab==='smart'&&<div>
        {smartTasks.length===0?<div style={{textAlign:'center',padding:40,color:'#888'}}>
          <div style={{fontSize:50,marginBottom:10}}>✅</div>
          <div style={{fontSize:16,fontWeight:600,color:'#22c55e'}}>Tout est à jour !</div>
          <div style={{fontSize:12,marginTop:4}}>Aucune action requise aujourd'hui</div>
        </div>:
        <div style={{display:'grid',gap:10}}>
          {smartTasks.sort((a,b)=>{const p={urgent:0,high:1,medium:2,info:3};return (p[a.priority]||3)-(p[b.priority]||3);}).map((t,i)=>
            <div key={i} style={{display:'flex',alignItems:'center',gap:14,padding:'14px 18px',background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+(t.priority==='urgent'?'rgba(239,68,68,.25)':t.priority==='high'?'rgba(198,163,78,.2)':'rgba(255,255,255,.06)'),borderRadius:12}}>
              <div style={{fontSize:28}}>{t.icon}</div>
              <div style={{flex:1}}>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontSize:13,fontWeight:600,color:'#e5e5e5'}}>{t.task}</span>
                  <span style={{fontSize:9,padding:'2px 8px',borderRadius:10,background:t.priority==='urgent'?'rgba(239,68,68,.15)':t.priority==='high'?'rgba(198,163,78,.15)':'rgba(255,255,255,.05)',color:t.priority==='urgent'?'#ef4444':t.priority==='high'?'#c6a34e':'#888',fontWeight:600}}>{t.priority.toUpperCase()}</span>
                  {t.auto&&<span style={{fontSize:9,padding:'2px 8px',borderRadius:10,background:'rgba(34,197,94,.12)',color:'#22c55e'}}>AUTO</span>}
                </div>
                <div style={{fontSize:11,color:'#888',marginTop:2}}>{t.desc}</div>
              </div>
              {t.fn&&<button onClick={()=>{if(confirm(t.task+'\n\n'+t.desc+'\n\nConfirmer ?')){try{t.fn();if(typeof addToast==='function')addToast('✅ '+t.task+' terminé');}catch(e){alert('❌ '+e.message);}}}} style={{padding:'8px 16px',borderRadius:8,border:'none',background:t.color,color:'#fff',fontWeight:600,fontSize:11,cursor:'pointer'}}>✓ Exécuter</button>}
            </div>)}
        </div>}

        {/* Auto results */}
        {autoResults.length>0&&<div style={{marginTop:20,padding:16,background:'rgba(34,197,94,.04)',border:'1px solid rgba(34,197,94,.15)',borderRadius:12}}>
          <div style={{fontSize:13,fontWeight:600,color:'#22c55e',marginBottom:8}}>🤖 Résultats Autopilot</div>
          {autoResults.map((r,i)=><div key={i} style={{display:'flex',gap:8,padding:'4px 0',fontSize:12}}>
            <span>{r.status==='ok'?'✅':'❌'}</span>
            <span style={{color:r.status==='ok'?'#e5e5e5':'#ef4444'}}>{r.task}</span>
          </div>)}
        </div>}
      </div>}

      {/* TAB: Import CSV */}
      {pilotTab==='import'&&<div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:20,marginBottom:20}}>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14}}>
            <div style={{fontSize:15,fontWeight:600,color:'#c6a34e',marginBottom:12}}>📥 Import Massif</div>
            <div style={{display:'flex',gap:8,marginBottom:14}}>
              <button onClick={()=>setImportType('employees')} style={{flex:1,padding:'10px',borderRadius:8,border:'none',background:importType==='employees'?'rgba(198,163,78,.15)':'rgba(255,255,255,.03)',color:importType==='employees'?'#c6a34e':'#888',fontSize:12,cursor:'pointer',fontWeight:600}}>👥 Employés</button>
              <button onClick={()=>setImportType('clients')} style={{flex:1,padding:'10px',borderRadius:8,border:'none',background:importType==='clients'?'rgba(198,163,78,.15)':'rgba(255,255,255,.03)',color:importType==='clients'?'#c6a34e':'#888',fontSize:12,cursor:'pointer',fontWeight:600}}>🏢 Clients</button>
            </div>
            <label style={{display:'block',padding:'14px',borderRadius:10,border:'2px dashed rgba(198,163,78,.2)',textAlign:'center',cursor:'pointer',background:'rgba(198,163,78,.03)'}}>
              <div style={{fontSize:24,marginBottom:4}}>📂</div>
              <div style={{fontSize:12,color:'#c6a34e',fontWeight:600}}>Glisser ou cliquer pour importer CSV</div>
              <div style={{fontSize:10,color:'#888',marginTop:2}}>Séparateur: point-virgule (;) · Encodage: UTF-8</div>
              <input type="file" accept=".csv,.txt" style={{display:'none'}} onChange={handleCSV}/>
            </label>
          </div>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(59,130,246,.15)',borderRadius:14}}>
            <div style={{fontSize:15,fontWeight:600,color:'#3b82f6',marginBottom:12}}>📋 Colonnes attendues</div>
            {importType==='employees'?
              <div style={{fontSize:11,color:'#888',lineHeight:1.8}}>
                <span style={{color:'#22c55e'}}>●</span> <b style={{color:'#e5e5e5'}}>nom</b> — Nom de famille<br/>
                <span style={{color:'#22c55e'}}>●</span> <b style={{color:'#e5e5e5'}}>prenom</b> — Prénom<br/>
                <span style={{color:'#22c55e'}}>●</span> <b style={{color:'#e5e5e5'}}>niss</b> — Numéro NISS<br/>
                <span style={{color:'#22c55e'}}>●</span> <b style={{color:'#e5e5e5'}}>brut</b> — Salaire brut mensuel<br/>
                <span style={{color:'#888'}}>○</span> <b style={{color:'#999'}}>email</b> — Email<br/>
                <span style={{color:'#888'}}>○</span> <b style={{color:'#999'}}>iban</b> — Compte bancaire<br/>
                <span style={{color:'#888'}}>○</span> <b style={{color:'#999'}}>contrat</b> — CDI/CDD<br/>
                <span style={{color:'#888'}}>○</span> <b style={{color:'#999'}}>debut</b> — Date début<br/>
                <span style={{color:'#888'}}>○</span> <b style={{color:'#999'}}>genre</b> — M/F
              </div>:
              <div style={{fontSize:11,color:'#888',lineHeight:1.8}}>
                <span style={{color:'#22c55e'}}>●</span> <b style={{color:'#e5e5e5'}}>societe</b> — Nom de la société<br/>
                <span style={{color:'#888'}}>○</span> <b style={{color:'#999'}}>tva</b> — Numéro TVA<br/>
                <span style={{color:'#888'}}>○</span> <b style={{color:'#999'}}>bce</b> — Numéro BCE<br/>
                <span style={{color:'#888'}}>○</span> <b style={{color:'#999'}}>adresse</b> — Adresse
              </div>}
          </div>
        </div>

        {/* CSV Preview */}
        {csvData&&<div style={{padding:16,background:'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.15)',borderRadius:12}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
            <div style={{fontSize:13,fontWeight:600,color:'#c6a34e'}}>Aperçu — {csvData.rows.length} lignes détectées</div>
            <button onClick={importCSV} style={{padding:'8px 20px',borderRadius:8,border:'none',background:'#22c55e',color:'#fff',fontWeight:600,fontSize:12,cursor:'pointer'}}>✅ Importer {csvData.rows.length} {importType==='employees'?'employés':'clients'}</button>
          </div>
          <div style={{overflowX:'auto'}}>
            <table style={{width:'100%',fontSize:10,borderCollapse:'collapse'}}>
              <thead><tr>{csvPreview[0]?.map((h2,i)=><th key={i} style={{padding:'6px 8px',background:'rgba(198,163,78,.1)',color:'#c6a34e',textAlign:'left',borderBottom:'1px solid rgba(198,163,78,.2)'}}>{h2}</th>)}</tr></thead>
              <tbody>{csvPreview.slice(1,6).map((r,i)=><tr key={i}>{r.map((c,j)=><td key={j} style={{padding:'4px 8px',color:'#999',borderBottom:'1px solid rgba(255,255,255,.03)'}}>{c}</td>)}</tr>)}</tbody>
            </table>
          </div>
        </div>}
      </div>}

      {/* TAB: Export Tout */}
      {pilotTab==='export'&&<div style={{textAlign:'center',padding:30}}>
        <div style={{fontSize:50,marginBottom:16}}>📦</div>
        <div style={{fontSize:18,fontWeight:700,color:'#e5e5e5',marginBottom:6}}>Export Complet Multi-Clients</div>
        <div style={{fontSize:12,color:'#888',marginBottom:20}}>{clients.length} clients · {totalEmps} employés</div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14,maxWidth:600,margin:'0 auto 24px'}}>
          <div style={{padding:14,background:'rgba(198,163,78,.06)',borderRadius:12,textAlign:'center'}}>
            <div style={{fontSize:20,fontWeight:700,color:'#c6a34e'}}>{totalEmps}</div>
            <div style={{fontSize:10,color:'#888'}}>Fiches de paie</div>
          </div>
          <div style={{padding:14,background:'rgba(34,197,94,.06)',borderRadius:12,textAlign:'center'}}>
            <div style={{fontSize:20,fontWeight:700,color:'#22c55e'}}>{clients.filter(c=>(c.emps?.length||0)>0).length}</div>
            <div style={{fontSize:10,color:'#888'}}>Fichiers SEPA</div>
          </div>
          <div style={{padding:14,background:'rgba(168,85,247,.06)',borderRadius:12,textAlign:'center'}}>
            <div style={{fontSize:20,fontWeight:700,color:'#a855f7'}}>{clients.filter(c=>(c.emps?.length||0)>0).length}</div>
            <div style={{fontSize:10,color:'#888'}}>DmfA</div>
          </div>
        </div>
        <button onClick={exportAllDocs} style={{padding:'16px 36px',borderRadius:14,border:'none',background:'linear-gradient(135deg,#c6a34e,#d4af37)',color:'#000',fontWeight:700,fontSize:15,cursor:'pointer',boxShadow:'0 4px 20px rgba(198,163,78,.35)'}}>📦 Tout Exporter — 1 clic</button>
      </div>}

      {/* TAB: Calendrier Auto */}
      {pilotTab==='calendrier'&&<div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12}}>
          {[
            {m:'Janvier',tasks:['Belcotax 281.10','Bilan Social BNB prep'],color:'#ef4444'},
            {m:'Février',tasks:['Bilan Social BNB deadline','Belcotax deadline 1/3'],color:'#6366f1'},
            {m:'Mars',tasks:['DmfA Q1 clôture','PP 274 mensuel'],color:'#a855f7'},
            {m:'Avril',tasks:['DmfA Q1 envoi','PP 274 mensuel'],color:'#3b82f6'},
            {m:'Mai',tasks:['Pécule vacances simple','PP 274 mensuel'],color:'#06b6d4'},
            {m:'Juin',tasks:['Pécule vacances double','DmfA Q2'],color:'#22c55e'},
            {m:'Juillet',tasks:['PP 274 mensuel','Provisions ONSS'],color:'#f59e0b'},
            {m:'Août',tasks:['PP 274 mensuel','Provisions ONSS'],color:'#c6a34e'},
            {m:'Septembre',tasks:['DmfA Q3','PP 274 mensuel'],color:'#a855f7'},
            {m:'Octobre',tasks:['PP 274 mensuel','Indexation check'],color:'#3b82f6'},
            {m:'Novembre',tasks:['PP 274 mensuel','13ème mois prep'],color:'#f59e0b'},
            {m:'Décembre',tasks:['13ème Mois','DmfA Q4','Clôture annuelle'],color:'#ef4444'}
          ].map((m,i)=><div key={i} style={{padding:14,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+(month===i+1?'rgba(198,163,78,.3)':'rgba(255,255,255,.05)'),borderRadius:12,opacity:month>i+1?0.5:1}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
              <span style={{fontSize:12,fontWeight:600,color:month===i+1?'#c6a34e':'#e5e5e5'}}>{m.m}</span>
              {month===i+1&&<span style={{fontSize:8,padding:'2px 6px',borderRadius:6,background:'rgba(198,163,78,.15)',color:'#c6a34e'}}>EN COURS</span>}
              {month>i+1&&<span style={{fontSize:8,padding:'2px 6px',borderRadius:6,background:'rgba(34,197,94,.12)',color:'#22c55e'}}>✓</span>}
            </div>
            {m.tasks.map((t,j)=><div key={j} style={{fontSize:10,color:'#888',padding:'2px 0'}}>• {t}</div>)}
          </div>)}
        </div>
        <div style={{marginTop:16,padding:14,background:'rgba(198,163,78,.04)',borderRadius:12,textAlign:'center'}}>
          <div style={{fontSize:11,color:'#888'}}>📅 Chaque mois : Fiches de paie (25) + SEPA (25) + PP 274 (15) + Provisions ONSS (5)</div>
          <div style={{fontSize:10,color:'#666',marginTop:4}}>L'Autopilot détecte automatiquement les tâches du jour et vous les propose.</div>
        </div>
      </div>}
    </div>;
  };

const MassEngine=({s,d})=>{
    const clients=s.clients||[];
    const totalEmps=clients.reduce((a,c)=>a+(c.emps?.length||0),0);
    const totalDocs=totalEmps*5; // fiches+dimona+sepa+dmfa+belcotax
    const now=new Date();
    const mois=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
    const [engineTab,setEngineTab]=useState('overview');
    const [running,setRunning]=useState(false);
    const [paused,setPaused]=useState(false);
    const [progress,setProgress]=useState({client:0,emp:0,doc:0,total:0,errors:0,startTime:null,currentClient:'',currentAction:''});
    const [jobLog,setJobLog]=useState([]);
    const [selectedOps,setSelectedOps]=useState({fiches:true,sepa:true,dmfa:true,dimona:false,belcotax:false,c4:false,attestations:false,solde:false,precompte:true,pecule:false,treizieme:false,onssProvisions:true,bilanSocial:false,packageSortie:false,indexation:false});
    const [batchMonth,setBatchMonth]=useState(now.getMonth()+1);
    const [batchYear,setBatchYear]=useState(now.getFullYear());
    const pauseRef=useRef(false);
    const cancelRef=useRef(false);

    const opsCount=Object.values(selectedOps).filter(Boolean).length;
    const estDocs=totalEmps*opsCount+clients.length*(['precompte','onssProvisions','bilanSocial','indexation'].filter(k=>selectedOps[k]).length);
    const estTime=Math.ceil(estDocs*0.05); // ~50ms per doc

    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));

    const runMassJob=async()=>{
      if(clients.length===0){alert('Aucun client');return;}
      const ops=Object.entries(selectedOps).filter(([k,v])=>v).map(([k])=>k);
      if(ops.length===0){alert('Sélectionnez au moins une opération');return;}
      
      if(!confirm('🚀 LANCEMENT MASS ENGINE\n\n'+
        clients.length+' clients\n'+
        totalEmps+' employés\n'+
        estDocs+' documents à générer\n'+
        'Opérations: '+ops.join(', ')+'\n'+
        'Mois: '+mois[batchMonth-1]+' '+batchYear+'\n\n'+
        'Confirmer le lancement ?'))return;

      setRunning(true);setPaused(false);
      cancelRef.current=false;pauseRef.current=false;
      const startTime=Date.now();
      let docCount=0,errCount=0;
      const log=[];

      for(let ci=0;ci<clients.length;ci++){
        if(cancelRef.current)break;
        while(pauseRef.current)await sleep(200);

        const cl=clients[ci];
        const co=cl.company||{};
        const emps=cl.emps||[];
        
        setProgress({client:ci+1,emp:0,doc:docCount,total:clients.length,errors:errCount,startTime,
          currentClient:co.name||cl.id||('Client '+(ci+1)),currentAction:'Initialisation...'});

        if(emps.length===0){
          log.push({client:co.name||cl.id,status:'skip',msg:'Aucun employé',docs:0});
          continue;
        }

        let clientDocs=0;
        try{
          // Fiches de paie
          if(selectedOps.fiches){
            setProgress(p=>({...p,currentAction:'📄 Fiches de paie ('+emps.length+')'}));
            for(let ei=0;ei<emps.length;ei++){
              if(cancelRef.current)break;
              while(pauseRef.current)await sleep(200);
              try{generatePayslipPDF(emps[ei],co);clientDocs++;docCount++;}catch(e){errCount++;}
              setProgress(p=>({...p,emp:ei+1,doc:docCount,errors:errCount}));
              await sleep(10); // Let UI breathe
            }
          }

          // SEPA
          if(selectedOps.sepa&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'💸 SEPA pain.001'}));
            try{generateSEPAXML(emps,{month:new Date().getMonth()+1,year:new Date().getFullYear()},co);clientDocs++;docCount++;}catch(e){errCount++;}
            await sleep(10);
          }

          // DmfA
          if(selectedOps.dmfa&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'📊 DmfA trimestrielle'}));
            try{generateDmfAXML(emps,Math.ceil((new Date().getMonth()+1)/3),new Date().getFullYear(),co);clientDocs++;docCount++;}catch(e){errCount++;}
            await sleep(10);
          }

          // Dimona
          if(selectedOps.dimona&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'📡 Dimona IN'}));
            for(let ei=0;ei<emps.length;ei++){
              if(cancelRef.current)break;
              try{generateDimonaXML(emps[ei],'IN');clientDocs++;docCount++;}catch(e){errCount++;}
            }
            await sleep(10);
          }

          // Belcotax
          if(selectedOps.belcotax&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'🏛️ Belcotax 281.10'}));
            for(let ei=0;ei<emps.length;ei++){
              if(cancelRef.current)break;
              try{generateBelcotaxXML(emps[ei],co);clientDocs++;docCount++;}catch(e){errCount++;}
            }
            await sleep(10);
          }

          // C4
          if(selectedOps.c4&&!cancelRef.current){
            const sortis=emps.filter(e=>e.status==='sorti');
            if(sortis.length>0){
              setProgress(p=>({...p,currentAction:'📋 C4 ('+sortis.length+')'}));
              sortis.forEach(e=>{try{generateC4PDF(e,co);clientDocs++;docCount++;}catch(ex){errCount++;}});
            }
            await sleep(10);
          }

          // Attestations
          if(selectedOps.attestations&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'📝 Attestations'}));
            for(let ei=0;ei<emps.length;ei++){
              if(cancelRef.current)break;
              try{generateAttestationEmploi(emps[ei],co);clientDocs++;docCount++;}catch(e){errCount++;}
            }
            await sleep(10);
     

          // Solde Tout Compte
          if(selectedOps.solde&&!cancelRef.current){
            const sortis=emps.filter(e=>e.status==='sorti');
            if(sortis.length>0){
              setProgress(p=>({...p,currentAction:'🧾 Solde Tout Compte ('+sortis.length+')'}));
              sortis.forEach(e=>{try{if(typeof generateSoldeCompte==='function')generateSoldeCompte(e,co);clientDocs++;docCount++;}catch(ex){errCount++;}});
            }
            await sleep(10);
          }

          // Précompte Professionnel 274
          if(selectedOps.precompte&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'💰 Précompte Prof. 274'}));
            try{
              const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0);
              const pp274={client:co.name,vat:co.vat,month:batchMonth,year:batchYear,totalBrut,precompte:emps.reduce((a,e)=>a+quickPP(+(e.monthlySalary||e.gross||0)),0),emps:emps.length};
              // Generate PP274 document
              const blob=new Blob([JSON.stringify(pp274,null,2)],{type:'application/json'});
              const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
              a.download='PP274_'+(co.name||'client').replace(/\s/g,'_')+'_'+batchYear+'-'+String(batchMonth).padStart(2,'0')+'.json';
              document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
              clientDocs++;docCount++;
            }catch(e){errCount++;}
            await sleep(10);
          }

          // Pécule de Vacances
          if(selectedOps.pecule&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'🏖️ Pécule de Vacances ('+emps.length+')'}));
            for(let ei=0;ei<emps.length;ei++){
              if(cancelRef.current)break;
              try{
                const e=emps[ei];
                const brut=+(e.monthlySalary||e.gross||e.brut||0);
                const peculeSimple=Math.round(brut*0.0769);
                const peculeDouble=Math.round(brut*12*0.0769);
                const peculeDoc={employee:e.first||e.fn||'',last:e.last||e.ln||'',brut,peculeSimple,peculeDouble,year:batchYear,company:co.name};
                const blob=new Blob([JSON.stringify(peculeDoc,null,2)],{type:'application/json'});
                const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
                a.download='Pecule_'+(e.last||e.ln||'emp')+'_'+batchYear+'.json';
                document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
                clientDocs++;docCount++;
              }catch(ex){errCount++;}
            }
            await sleep(10);
          }

          // 13ème Mois
          if(selectedOps.treizieme&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'🎄 13ème Mois ('+emps.length+')'}));
            for(let ei=0;ei<emps.length;ei++){
              if(cancelRef.current)break;
              try{
                const e=emps[ei];
                const brut=+(e.monthlySalary||e.gross||e.brut||0);
                const doc13={employee:e.first||e.fn||'',last:e.last||e.ln||'',brutMensuel:brut,prime13:brut,onss13:Math.round(brut*TX_ONSS_W),net13:Math.round(brut-Math.round(brut*TX_ONSS_W*100)/100-quickPP(brut)),year:batchYear,company:co.name};
                const blob=new Blob([JSON.stringify(doc13,null,2)],{type:'application/json'});
                const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
                a.download='13emeMois_'+(e.last||e.ln||'emp')+'_'+batchYear+'.json';
                document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
                clientDocs++;docCount++;
              }catch(ex){errCount++;}
            }
            await sleep(10);
          }

          // Provisions ONSS
          if(selectedOps.onssProvisions&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'📈 Provisions ONSS'}));
            try{
              const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0);
              const onssP=Math.round(totalBrut*TX_ONSS_E);
              const onssE=Math.round(totalBrut*TX_ONSS_W);
              const provDoc={client:co.name,vat:co.vat,month:batchMonth,year:batchYear,emps:emps.length,totalBrut,onssPatronal:onssP,onssPersonnel:onssE,totalONSS:onssP+onssE};
              const blob=new Blob([JSON.stringify(provDoc,null,2)],{type:'application/json'});
              const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
              a.download='ONSS_Provisions_'+(co.name||'client').replace(/\s/g,'_')+'_'+batchYear+'-'+String(batchMonth).padStart(2,'0')+'.json';
              document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
              clientDocs++;docCount++;
            }catch(e){errCount++;}
            await sleep(10);
          }

          // Bilan Social BNB
          if(selectedOps.bilanSocial&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'🏛️ Bilan Social BNB'}));
            try{
              const totalBrut=emps.reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0);
              const hommes=emps.filter(e=>(e.gender||e.sexe)==='M').length;
              const femmes=emps.filter(e=>(e.gender||e.sexe)==='F').length;
              const tp=emps.filter(e=>e.regime&&e.regime<100).length;
              const bilanDoc={client:co.name,vat:co.vat,bce:co.bce,year:batchYear,effectifTotal:emps.length,hommes,femmes,tempsPlein:emps.length-tp,tempsPartiel:tp,masseSalariale:totalBrut*12,formationHeures:emps.length*16,chargesSociales:Math.round(totalBrut*12*TX_ONSS_E)};
              const blob=new Blob([JSON.stringify(bilanDoc,null,2)],{type:'application/json'});
              const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
              a.download='BilanSocial_'+(co.name||'client').replace(/\s/g,'_')+'_'+batchYear+'.json';
              document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
              clientDocs++;docCount++;
            }catch(e){errCount++;}
            await sleep(10);
          }

          // Package Sortie (C4 + attestation vacances + fiche finale)
          if(selectedOps.packageSortie&&!cancelRef.current){
            const sortis=emps.filter(e=>e.status==='sorti');
            if(sortis.length>0){
              setProgress(p=>({...p,currentAction:'📋 Package Sortie ('+sortis.length+')'}));
              for(const e of sortis){
                if(cancelRef.current)break;
                try{
                  if(typeof generateC4PDF==='function')generateC4PDF(e,co);
                  if(typeof generateAttestationEmploi==='function')generateAttestationEmploi(e,co);
                  if(typeof generatePayslipPDF==='function')generatePayslipPDF(e,co);
                  if(typeof generateSoldeCompte==='function')generateSoldeCompte(e,co);
                  clientDocs+=4;docCount+=4;
                }catch(ex){errCount++;}
              }
            }
            await sleep(10);
          }

          // Indexation Salariale
          if(selectedOps.indexation&&!cancelRef.current){
            setProgress(p=>({...p,currentAction:'📈 Indexation Salariale ('+emps.length+')'}));
            try{
              const indexDoc={client:co.name,vat:co.vat,date:new Date().toISOString(),emps:emps.map(e=>({name:(e.first||e.fn||'')+' '+(e.last||e.ln||''),brutActuel:+(e.monthlySalary||e.gross||e.brut||0),brutIndexe:Math.round((+(e.monthlySalary||e.gross||e.brut||0))*1.02*100)/100,augmentation:'2.00%'}))};
              const blob=new Blob([JSON.stringify(indexDoc,null,2)],{type:'application/json'});
              const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
              a.download='Indexation_'+(co.name||'client').replace(/\s/g,'_')+'_'+batchYear+'.json';
              document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
              clientDocs++;docCount++;
            }catch(e){errCount++;}
            await sleep(10);
          }
     }

          log.push({client:co.name||cl.id,status:'ok',msg:emps.length+' emp · '+clientDocs+' docs',docs:clientDocs});
        }catch(e){
          errCount++;
          log.push({client:co.name||cl.id,status:'error',msg:e.message||'Erreur',docs:clientDocs});
        }

        setProgress(p=>({...p,doc:docCount,errors:errCount}));
      }

      setRunning(false);
      setJobLog(log);
      setEngineTab('results');
      const elapsed=Math.round((Date.now()-startTime)/1000);
      if(typeof addToast==='function')addToast('🎉 Mass Engine terminé: '+docCount+' documents en '+elapsed+'s');
    };

    const elapsedSec=progress.startTime?Math.round((Date.now()-progress.startTime)/1000):0;
    const pctClient=progress.total>0?(progress.client/progress.total*100).toFixed(1):0;

    const tabs=[
      {id:'overview',l:'📊 Vue globale'},
      {id:'config',l:'⚙️ Configuration'},
      {id:'run',l:'🚀 Exécution'},
      {id:'results',l:'📋 Résultats ('+jobLog.length+')'},
    ];

    return <div style={{padding:24}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
        <div>
          <h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🏭 Mass Engine</h2>
          <p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Automatisation massive — {clients.length} clients · {totalEmps} employés · {mois[batchMonth-1]} {batchYear}</p>
        </div>
        <div style={{display:'flex',gap:8}}>
          {[{v:clients.length,l:'Clients',c:'#c6a34e'},{v:totalEmps,l:'Employés',c:'#3b82f6'},{v:estDocs,l:'Docs estimés',c:'#a855f7'},{v:Math.ceil(estTime/60)+'min',l:'Temps estimé',c:'#22c55e'}].map((k,i)=>
            <div key={i} style={{padding:'8px 14px',background:'rgba(198,163,78,.06)',border:'1px solid rgba(198,163,78,.1)',borderRadius:10,textAlign:'center'}}>
              <div style={{fontSize:16,fontWeight:700,color:k.c}}>{k.v}</div>
              <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
            </div>)}
        </div>
      </div>

      {/* Running Progress */}
      {running&&<div style={{marginBottom:20,padding:20,background:'linear-gradient(135deg,rgba(198,163,78,.08),rgba(198,163,78,.02))',border:'1px solid rgba(198,163,78,.25)',borderRadius:14}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
          <div style={{fontSize:14,fontWeight:600,color:'#c6a34e'}}>
            {paused?'⏸ En pause':'⚡ En cours...'} — Client {progress.client}/{progress.total}
          </div>
          <div style={{display:'flex',gap:6}}>
            <button onClick={()=>{pauseRef.current=!pauseRef.current;setPaused(!paused);}} style={{padding:'6px 14px',borderRadius:8,border:'none',background:paused?'#22c55e':'#eab308',color:'#fff',fontWeight:600,fontSize:11,cursor:'pointer'}}>{paused?'▶ Reprendre':'⏸ Pause'}</button>
            <button onClick={()=>{cancelRef.current=true;}} style={{padding:'6px 14px',borderRadius:8,border:'none',background:'#ef4444',color:'#fff',fontWeight:600,fontSize:11,cursor:'pointer'}}>✕ Annuler</button>
          </div>
        </div>
        <div style={{fontSize:12,color:'#e5e5e5',marginBottom:4}}>{progress.currentClient}</div>
        <div style={{fontSize:11,color:'#888',marginBottom:10}}>{progress.currentAction}</div>
        {/* Progress bar */}
        <div style={{height:8,background:'rgba(198,163,78,.1)',borderRadius:4,overflow:'hidden',marginBottom:8}}>
          <div style={{height:'100%',width:pctClient+'%',background:'linear-gradient(90deg,#c6a34e,#d4af37)',borderRadius:4,transition:'width .3s'}}/>
        </div>
        <div style={{display:'flex',justifyContent:'space-between',fontSize:10,color:'#888'}}>
          <span>{pctClient}% — {progress.doc} documents générés</span>
          <span>{progress.errors>0?'❌ '+progress.errors+' erreurs':''} · {elapsedSec}s</span>
        </div>
      </div>}

      {/* Tabs */}
      <div style={{display:'flex',gap:4,marginBottom:20}}>
        {tabs.map(tb=><button key={tb.id} onClick={()=>setEngineTab(tb.id)} style={{padding:'10px 16px',borderRadius:10,border:engineTab===tb.id?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.05)',background:engineTab===tb.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:engineTab===tb.id?'#c6a34e':'#888',fontSize:12,fontWeight:engineTab===tb.id?600:400,cursor:'pointer'}}>{tb.l}</button>)}
      </div>

      {/* TAB: Overview */}
      {engineTab==='overview'&&<div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14,marginBottom:20}}>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14}}>
            <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:12}}>📊 Répartition Clients</div>
            {[{l:'Avec employés',v:clients.filter(c=>(c.emps?.length||0)>0).length,c:'#22c55e'},
              {l:'Sans employés',v:clients.filter(c=>(c.emps?.length||0)===0).length,c:'#ef4444'},
              {l:'Avec TVA',v:clients.filter(c=>c.company?.vat).length,c:'#3b82f6'},
              {l:'Complets',v:clients.filter(c=>c.company?.vat&&c.company?.name&&(c.emps?.length||0)>0).length,c:'#a855f7'}
            ].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <span style={{fontSize:11,color:'#888'}}>{r.l}</span>
              <span style={{fontSize:13,fontWeight:700,color:r.c}}>{r.v}</span>
            </div>)}
          </div>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(59,130,246,.15)',borderRadius:14}}>
            <div style={{fontSize:13,fontWeight:600,color:'#3b82f6',marginBottom:12}}>👥 Répartition Employés</div>
            {[{l:'Total',v:totalEmps,c:'#3b82f6'},
              {l:'Moy/client',v:clients.length>0?(totalEmps/clients.length).toFixed(1):'0',c:'#c6a34e'},
              {l:'Max/client',v:Math.max(0,...clients.map(c=>c.emps?.length||0)),c:'#a855f7'},
              {l:'CDI estimés',v:clients.reduce((a,c)=>a+(c.emps||[]).filter(e=>(e.contractType||e.contrat?.type||'CDI')==='CDI').length,0),c:'#22c55e'}
            ].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <span style={{fontSize:11,color:'#888'}}>{r.l}</span>
              <span style={{fontSize:13,fontWeight:700,color:r.c}}>{r.v}</span>
            </div>)}
          </div>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(34,197,94,.15)',borderRadius:14}}>
            <div style={{fontSize:13,fontWeight:600,color:'#22c55e',marginBottom:12}}>📄 Estimation Documents</div>
            {[{l:'Fiches de paie',v:totalEmps,c:'#c6a34e'},
              {l:'SEPA virements',v:clients.filter(c=>(c.emps?.length||0)>0).length,c:'#22c55e'},
              {l:'DmfA trimest.',v:clients.filter(c=>(c.emps?.length||0)>0).length,c:'#a855f7'},
              {l:'Total max',v:totalDocs,c:'#ef4444'}
            ].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <span style={{fontSize:11,color:'#888'}}>{r.l}</span>
              <span style={{fontSize:13,fontWeight:700,color:r.c}}>{r.v}</span>
            </div>)}
          </div>
        </div>

        {/* Top clients by employee count */}
        <div style={{padding:16,background:'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}>
          <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>🏢 Top 10 Clients (par effectif)</div>
          <div style={{display:'grid',gridTemplateColumns:'40px 1fr 80px 80px',gap:6,fontSize:10,fontWeight:600,color:'#888',paddingBottom:6,borderBottom:'1px solid rgba(198,163,78,.1)'}}>
            <div>#</div><div>Société</div><div>Employés</div><div>Masse brute</div>
          </div>
          {[...clients].sort((a,b)=>(b.emps?.length||0)-(a.emps?.length||0)).slice(0,10).map((cl,i)=>{
            const mass=(cl.emps||[]).reduce((a,e)=>a+(+(e.monthlySalary||e.gross||e.brut||0)),0);
            return <div key={i} style={{display:'grid',gridTemplateColumns:'40px 1fr 80px 80px',gap:6,padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.02)',alignItems:'center'}}>
              <span style={{fontSize:11,fontWeight:700,color:'#c6a34e'}}>{i+1}</span>
              <span style={{fontSize:11,color:'#e5e5e5'}}>{cl.company?.name||cl.id||'—'}</span>
              <span style={{fontSize:12,fontWeight:600,color:'#3b82f6'}}>{cl.emps?.length||0}</span>
              <span style={{fontSize:11,color:'#22c55e'}}>{new Intl.NumberFormat('fr-BE').format(mass)} €</span>
            </div>;
          })}
        </div>
      </div>}

      {/* TAB: Config */}
      {engineTab==='config'&&<div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:20}}>
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14}}>
            <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:14}}>📅 Période</div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
              <div>
                <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Mois</label>
                <select value={batchMonth} onChange={e=>setBatchMonth(+e.target.value)} style={{width:'100%',padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:13,fontFamily:'inherit',cursor:'pointer',outline:'none'}}>
                  {mois.map((m,i)=><option key={i} value={i+1}>{m}</option>)}
                </select>
              </div>
              <div>
                <label style={{fontSize:10,color:'#888',display:'block',marginBottom:4}}>Année</label>
                <select value={batchYear} onChange={e=>setBatchYear(+e.target.value)} style={{width:'100%',padding:'10px',background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:8,color:'#e5e5e5',fontSize:13,fontFamily:'inherit',cursor:'pointer',outline:'none'}}>
                  {[2024,2025,2026,2027].map(y=><option key={y} value={y}>{y}</option>)}
                </select>
              </div>
            </div>
          </div>

          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.15)',borderRadius:14}}>
            <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:14}}>⚙️ Opérations ({opsCount} sélectionnées)</div>
            <div style={{display:'grid',gap:6}}>
              {[{k:'fiches',l:'📄 Fiches de paie',desc:'1 par employé'},{k:'sepa',l:'💸 SEPA pain.001',desc:'1 par client'},{k:'dmfa',l:'📊 DmfA trimestrielle',desc:'1 par client'},{k:'dimona',l:'📡 Dimona IN/OUT',desc:'1 par employé'},{k:'belcotax',l:'🏛️ Belcotax 281.10',desc:'1 par employé'},{k:'c4',l:'📋 Certificat C4',desc:'Employés sortis'},{k:'attestations',l:'📝 Attestations',desc:'1 par employé'},{k:'solde',l:'🧾 Solde Tout Compte',desc:'Employés sortis'},{k:'precompte',l:'💰 Précompte Prof. 274',desc:'Mensuel SPF Finances'},{k:'pecule',l:'🏖️ Pécule de Vacances',desc:'Annuel + départ'},{k:'treizieme',l:'🎄 13ème Mois / Prime',desc:'Annuel décembre'},{k:'onssProvisions',l:'📈 Provisions ONSS',desc:'Mensuel par client'},{k:'bilanSocial',l:'🏛️ Bilan Social BNB',desc:'Annuel février'},{k:'packageSortie',l:'📋 Package Sortie',desc:'C4+vacances+fiche finale'},{k:'indexation',l:'📈 Indexation Salariale',desc:'Si changement index'}].map(op=>
                <div key={op.k} onClick={()=>setSelectedOps(p=>({...p,[op.k]:!p[op.k]}))} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 10px',background:selectedOps[op.k]?'rgba(34,197,94,.06)':'rgba(255,255,255,.02)',border:'1px solid '+(selectedOps[op.k]?'rgba(34,197,94,.15)':'rgba(255,255,255,.04)'),borderRadius:8,cursor:'pointer'}}>
                  <div style={{width:20,height:20,borderRadius:6,border:'2px solid '+(selectedOps[op.k]?'#22c55e':'#555'),background:selectedOps[op.k]?'#22c55e':'transparent',display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,color:'#fff'}}>{selectedOps[op.k]?'✓':''}</div>
                  <div style={{flex:1}}><div style={{fontSize:12,color:selectedOps[op.k]?'#e5e5e5':'#888'}}>{op.l}</div><div style={{fontSize:9,color:'#666'}}>{op.desc}</div></div>
                </div>)}
            </div>
          </div>
        </div>

        {/* Estimation */}
        <div style={{marginTop:16,padding:16,background:'rgba(198,163,78,.06)',border:'1px solid rgba(198,163,78,.15)',borderRadius:12}}>
          <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,textAlign:'center'}}>
            <div><div style={{fontSize:22,fontWeight:700,color:'#c6a34e'}}>{clients.filter(c=>(c.emps?.length||0)>0).length}</div><div style={{fontSize:10,color:'#888'}}>Clients à traiter</div></div>
            <div><div style={{fontSize:22,fontWeight:700,color:'#3b82f6'}}>{totalEmps}</div><div style={{fontSize:10,color:'#888'}}>Employés</div></div>
            <div><div style={{fontSize:22,fontWeight:700,color:'#a855f7'}}>{estDocs.toLocaleString()}</div><div style={{fontSize:10,color:'#888'}}>Documents</div></div>
            <div><div style={{fontSize:22,fontWeight:700,color:'#22c55e'}}>{estTime<60?estTime+'s':Math.ceil(estTime/60)+'min'}</div><div style={{fontSize:10,color:'#888'}}>Temps estimé</div></div>
          </div>
        </div>
      </div>}

      {/* TAB: Run */}
      {engineTab==='run'&&<div style={{textAlign:'center',padding:40}}>
        <div style={{fontSize:60,marginBottom:16}}>🏭</div>
        <div style={{fontSize:20,fontWeight:700,color:'#e5e5e5',marginBottom:8}}>Prêt à lancer</div>
        <div style={{fontSize:13,color:'#888',marginBottom:8}}>{clients.length} clients · {totalEmps} employés · {opsCount} opérations</div>
        <div style={{fontSize:13,color:'#c6a34e',marginBottom:24}}>≈ {estDocs.toLocaleString()} documents • {mois[batchMonth-1]} {batchYear}</div>
        
        <div style={{display:'inline-flex',gap:10}}>
          <button onClick={runMassJob} disabled={running} style={{padding:'18px 40px',borderRadius:14,border:'none',background:running?'#555':'linear-gradient(135deg,#c6a34e,#d4af37)',color:running?'#999':'#000',fontWeight:700,fontSize:16,cursor:running?'not-allowed':'pointer',boxShadow:running?'none':'0 6px 30px rgba(198,163,78,.4)'}}>
            {running?'⏳ En cours...':'⚡ LANCER — 1 clic, je confirme'}
          </button>
        </div>
        
        <div style={{marginTop:30,fontSize:11,color:'#666',maxWidth:500,margin:'30px auto 0'}}>
          Processus : pour chaque client → génère les fiches de paie, SEPA, DmfA selon votre configuration. 
          Vous pouvez mettre en pause ou annuler à tout moment.
        </div>
      </div>}

      {/* TAB: Results */}
      {engineTab==='results'&&<div>
        {jobLog.length===0?<div style={{textAlign:'center',padding:40,color:'#888'}}>
          <div style={{fontSize:40,marginBottom:10}}>📋</div>
          <div>Aucun résultat. Lancez le Mass Engine pour voir les résultats ici.</div>
        </div>:<>
          {/* Summary */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:20}}>
            <div style={{padding:14,background:'rgba(34,197,94,.06)',borderRadius:12,textAlign:'center'}}>
              <div style={{fontSize:22,fontWeight:700,color:'#22c55e'}}>{jobLog.filter(l=>l.status==='ok').length}</div>
              <div style={{fontSize:10,color:'#888'}}>Réussis</div>
            </div>
            <div style={{padding:14,background:'rgba(239,68,68,.06)',borderRadius:12,textAlign:'center'}}>
              <div style={{fontSize:22,fontWeight:700,color:'#ef4444'}}>{jobLog.filter(l=>l.status==='error').length}</div>
              <div style={{fontSize:10,color:'#888'}}>Erreurs</div>
            </div>
            <div style={{padding:14,background:'rgba(234,179,8,.06)',borderRadius:12,textAlign:'center'}}>
              <div style={{fontSize:22,fontWeight:700,color:'#eab308'}}>{jobLog.filter(l=>l.status==='skip').length}</div>
              <div style={{fontSize:10,color:'#888'}}>Ignorés</div>
            </div>
            <div style={{padding:14,background:'rgba(198,163,78,.06)',borderRadius:12,textAlign:'center'}}>
              <div style={{fontSize:22,fontWeight:700,color:'#c6a34e'}}>{jobLog.reduce((a,l)=>a+l.docs,0)}</div>
              <div style={{fontSize:10,color:'#888'}}>Documents</div>
            </div>
          </div>

          {/* Detail table */}
          <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:12,overflow:'hidden'}}>
            <div style={{display:'grid',gridTemplateColumns:'40px 1fr 200px 80px',padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:10,fontWeight:600,color:'#c6a34e'}}>
              <div>#</div><div>Client</div><div>Détail</div><div>Statut</div>
            </div>
            <div style={{maxHeight:400,overflowY:'auto'}}>
              {jobLog.map((log,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'40px 1fr 200px 80px',padding:'8px 14px',borderTop:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center'}}>
                <span style={{color:'#888'}}>{i+1}</span>
                <span style={{color:'#e5e5e5',fontWeight:500}}>{log.client}</span>
                <span style={{color:'#888'}}>{log.msg}</span>
                <span style={{fontSize:10,padding:'3px 8px',borderRadius:6,textAlign:'center',
                  background:log.status==='ok'?'rgba(34,197,94,.12)':log.status==='error'?'rgba(239,68,68,.12)':'rgba(234,179,8,.12)',
                  color:log.status==='ok'?'#22c55e':log.status==='error'?'#ef4444':'#eab308'
                }}>{log.status==='ok'?'✅ OK':log.status==='error'?'❌ Erreur':'⏭ Skip'}</span>
              </div>)}
            </div>
          </div>
        </>}
      </div>}

      {/* Footer */}
      <div style={{marginTop:30,textAlign:'center',padding:14,borderTop:'1px solid rgba(198,163,78,.1)'}}>
        <div style={{fontSize:10,color:'#666'}}>Mass Engine v1 — Sprint 20 — {clients.length} clients · {totalEmps} employés</div>
        <div style={{fontSize:9,color:'#444',marginTop:2}}>Tous les documents sont générés localement. Vous confirmez, l'IA exécute.</div>
      </div>
    </div>;
  };


const SmartAutomation=({s,d,supabase,user})=>{
  const clients=s.clients||[];
  const totalEmps=clients.reduce((a,c)=>a+(c.emps?.length||0),0);
  const now=new Date();
  const [tab,setTab]=useState('alerts');
  const [csvData,setCsvData]=useState('');
  const [importResult,setImportResult]=useState(null);
  const [validationResults,setValidationResults]=useState(null);
  const [validating,setValidating]=useState(false);
  const [alertFilter,setAlertFilter]=useState('all');

  const generateAlerts=()=>{
    const alerts=[];const today=now.getTime();
    clients.forEach(cl=>{
      const co=cl.company||{};const emps=cl.emps||[];const cName=co.name||cl.id||'Client';
      if(!co.name)alerts.push({type:'error',cat:'Données',client:cName,msg:'Nom société manquant',priority:1});
      if(!co.vat&&!co.bce)alerts.push({type:'error',cat:'Données',client:cName,msg:'TVA/BCE manquant',priority:1});
      if(!co.iban)alerts.push({type:'warning',cat:'Données',client:cName,msg:'IBAN société manquant',priority:2});
      emps.forEach(e=>{
        const eName=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
        if(!e.niss)alerts.push({type:'error',cat:'NISS',client:cName,msg:eName+' — NISS manquant',priority:1});
        else if(e.niss.replace(/[^0-9]/g,'').length!==11)alerts.push({type:'error',cat:'NISS',client:cName,msg:eName+' — NISS invalide',priority:1});
        if(!e.iban)alerts.push({type:'warning',cat:'IBAN',client:cName,msg:eName+' — IBAN manquant',priority:2});
        if(!(+(e.monthlySalary||e.gross||e.brut||0)))alerts.push({type:'error',cat:'Salaire',client:cName,msg:eName+' — Salaire = 0€',priority:1});
        if(!e.contractType&&!e.contrat?.type)alerts.push({type:'info',cat:'Contrat',client:cName,msg:eName+' — Contrat non défini',priority:3});
        const endD=e.endDate||e.endD||e.contrat?.endDate;
        if(endD){const end=new Date(endD).getTime();const daysLeft=Math.round((end-today)/(1000*60*60*24));
          if(daysLeft<0)alerts.push({type:'error',cat:'CDD',client:cName,msg:eName+' — CDD expiré '+Math.abs(daysLeft)+'j',priority:1});
          else if(daysLeft<=30)alerts.push({type:'warning',cat:'CDD',client:cName,msg:eName+' — CDD expire '+daysLeft+'j',priority:1});
          else if(daysLeft<=90)alerts.push({type:'info',cat:'CDD',client:cName,msg:eName+' — CDD expire '+daysLeft+'j',priority:2});}
        const lastMed=e.lastMedical||e.visiteMedicale;
        if(lastMed){const ds=Math.round((today-new Date(lastMed).getTime())/(1000*60*60*24));if(ds>365)alerts.push({type:'warning',cat:'Médical',client:cName,msg:eName+' — Visite > 1 an',priority:2});}
        else alerts.push({type:'info',cat:'Médical',client:cName,msg:eName+' — Visite non renseignée',priority:3});
        if(!e.startD&&!e.startDate)alerts.push({type:'warning',cat:'Données',client:cName,msg:eName+' — Date entrée manquante',priority:2});
        if(!e.cp&&!e.commissionParitaire)alerts.push({type:'info',cat:'CP',client:cName,msg:eName+' — CP non définie',priority:3});
      });
      if(emps.length===0)alerts.push({type:'info',cat:'Données',client:cName,msg:'Aucun employé',priority:3});
    });
    return alerts.sort((a,b)=>a.priority-b.priority);
  };
  const alerts=generateAlerts();
  const errCount=alerts.filter(a=>a.type==='error').length;
  const warnCount=alerts.filter(a=>a.type==='warning').length;
  const infoCount=alerts.filter(a=>a.type==='info').length;

  const deadlines=[
    {day:5,label:'ONSS — Paiement cotisations',icon:'🏦',monthly:true},
    {day:15,label:'Précompte Prof. 274 — SPF',icon:'💰',monthly:true},
    {day:25,label:'Paie — Calcul & virements',icon:'📄',monthly:true},
    {day:25,label:'SEPA — Génération',icon:'💸',monthly:true},
    {day:1,month:1,label:'Belcotax 281.10',icon:'🏛',yearly:true},
    {day:1,month:2,label:'Bilan Social BNB',icon:'🏛',yearly:true},
    {day:31,month:3,label:'DmfA Q1',icon:'📊',quarterly:true},
    {day:30,month:6,label:'DmfA Q2',icon:'📊',quarterly:true},
    {day:30,month:9,label:'DmfA Q3',icon:'📊',quarterly:true},
    {day:31,month:12,label:'DmfA Q4',icon:'📊',quarterly:true},
    {day:15,month:5,label:'Pécule de Vacances',icon:'🏖',yearly:true},
    {day:15,month:12,label:'13ème Mois',icon:'🎄',yearly:true},
  ];
  const upcomingDeadlines=deadlines.map(dl=>{
    let next=new Date(now.getFullYear(),dl.month?(dl.month-1):now.getMonth(),dl.day);
    if(next<=now){if(dl.monthly)next.setMonth(next.getMonth()+1);else next.setFullYear(next.getFullYear()+1);}
    return{...dl,daysLeft:Math.round((next.getTime()-now.getTime())/(1000*60*60*24)),nextDate:next};
  }).sort((a,b)=>a.daysLeft-b.daysLeft);

  const runValidation=()=>{
    setValidating(true);const results={passed:[],failed:[],warnings:[]};
    clients.forEach(cl=>{
      const co=cl.company||{};const emps=cl.emps||[];const cName=co.name||cl.id;let pass=true;const issues=[];
      if(!co.name){issues.push('Nom manquant');pass=false;}
      if(!co.vat&&!co.bce){issues.push('TVA/BCE manquant');pass=false;}
      if(emps.length===0){issues.push('Aucun employé');pass=false;}
      emps.forEach(e=>{
        const en=(e.first||e.fn||'')+' '+(e.last||e.ln||'');
        if(!e.niss||e.niss.replace(/[^0-9]/g,'').length!==11){issues.push(en+': NISS');pass=false;}
        if(!(+(e.monthlySalary||e.gross||e.brut||0))){issues.push(en+': Salaire=0');pass=false;}
      });
      if(pass&&issues.length===0)results.passed.push({client:cName,emps:emps.length});
      else if(!pass)results.failed.push({client:cName,issues});
      else results.warnings.push({client:cName,issues});
    });
    setValidationResults(results);setValidating(false);
  };

  const parseCSV=(text)=>{const lines=text.trim().split('\n');if(lines.length<2)return{error:'CSV vide'};const headers=lines[0].split(';').map(h=>h.trim().toLowerCase());const rows=[];for(let i=1;i<lines.length;i++){const vals=lines[i].split(';');const row={};headers.forEach((h,j)=>row[h]=vals[j]?.trim()||'');rows.push(row);}return{headers,rows};};

  const importClientsCSV=()=>{const{rows,error}=parseCSV(csvData);if(error){setImportResult({error});return;}let imported=0,skipped=0;rows.forEach(row=>{const name=row.societe||row.nom||row.company||'';const vat=row.tva||row.vat||row.bce||'';if(!name&&!vat){skipped++;return;}if(clients.find(c=>(c.company?.name||'')===name)){skipped++;return;}d({type:'ADD_CLIENT',d:{company:{name,vat,bce:vat,iban:row.iban||'',address:row.adresse||'',cp:row.cp||'',city:row.ville||'',phone:row.tel||'',email:row.email||''},emps:[]}});imported++;});setImportResult({imported,skipped,total:rows.length});};

  const importEmpsCSV=()=>{const{rows,error}=parseCSV(csvData);if(error){setImportResult({error});return;}let imported=0;const newEmps=[...(s.emps||[])];rows.forEach(row=>{const emp={id:'E-'+Date.now()+'-'+Math.random().toString(36).substr(2,5),first:row.prenom||row.first||'',last:row.nom||row.last||'',fn:row.prenom||'',ln:row.nom||'',niss:row.niss||'',iban:row.iban||'',email:row.email||'',monthlySalary:parseFloat(row.salaire||row.brut||0)||0,gross:parseFloat(row.salaire||row.brut||0)||0,contractType:row.contrat||'CDI',startD:row.debut||'',cp:row.cp_paritaire||'',status:row.statut||'actif',gender:row.sexe||''};if(emp.first||emp.last){newEmps.push(emp);imported++;}});d({type:'SET_EMPS',data:newEmps});setImportResult({imported,total:rows.length,type:'emps'});};

  const autoFix=()=>{let fixed=0;const up=clients.map(cl=>{const emps=(cl.emps||[]).map(e=>{const u={...e};if(u.niss){const c=u.niss.replace(/[^0-9]/g,'');if(c.length===11&&c!==u.niss){u.niss=c;fixed++;}}if(u.iban){const c=u.iban.replace(/\s/g,'').toUpperCase();if(c!==u.iban){u.iban=c;fixed++;}}if(!u.contractType&&!u.contrat?.type){u.contractType='CDI';fixed++;}if(!u.status){u.status='actif';fixed++;}return u;});return{...cl,emps};});d({type:'SET_CLIENTS',data:up});if(typeof addToast==='function')addToast('Auto-Fix: '+fixed+' corrections');return fixed;};

  const tabs2=[{id:'alerts',l:'🚨 Alertes ('+errCount+')',badge:errCount},{id:'deadlines',l:'📅 Échéances'},{id:'validation',l:'\u2705 Pré-Vol'},{id:'import',l:'📥 Import CSV'},{id:'autofix',l:'🔧 Auto-Fix'},{id:'onboarding',l:'🚀 Onboarding'}];

  return <div style={{padding:24}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
      <div><h2 style={{fontSize:22,fontWeight:700,color:'#c6a34e',margin:0}}>🤖 Smart Automation</h2><p style={{fontSize:12,color:'#888',margin:'4px 0 0'}}>Alertes, validation, import, corrections automatiques</p></div>
      <div style={{display:'flex',gap:8}}>
        <div style={{padding:'8px 14px',background:'rgba(239,68,68,.08)',border:'1px solid rgba(239,68,68,.2)',borderRadius:10,textAlign:'center'}}><div style={{fontSize:18,fontWeight:700,color:'#ef4444'}}>{errCount}</div><div style={{fontSize:9,color:'#888'}}>Erreurs</div></div>
        <div style={{padding:'8px 14px',background:'rgba(234,179,8,.08)',border:'1px solid rgba(234,179,8,.2)',borderRadius:10,textAlign:'center'}}><div style={{fontSize:18,fontWeight:700,color:'#eab308'}}>{warnCount}</div><div style={{fontSize:9,color:'#888'}}>Alertes</div></div>
        <div style={{padding:'8px 14px',background:'rgba(34,197,94,.08)',border:'1px solid rgba(34,197,94,.2)',borderRadius:10,textAlign:'center'}}><div style={{fontSize:18,fontWeight:700,color:'#22c55e'}}>{clients.filter(c=>(c.emps?.length||0)>0&&c.company?.name&&c.company?.vat).length}</div><div style={{fontSize:9,color:'#888'}}>Prêts</div></div>
      </div>
    </div>
    <div style={{display:'flex',gap:4,marginBottom:20,flexWrap:'wrap'}}>{tabs2.map(tb=><button key={tb.id} onClick={()=>setTab(tb.id)} style={{padding:'10px 16px',borderRadius:10,border:tab===tb.id?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.05)',background:tab===tb.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:tab===tb.id?'#c6a34e':'#888',fontSize:12,fontWeight:tab===tb.id?600:400,cursor:'pointer',position:'relative'}}>{tb.l}{tb.badge>0&&<span style={{position:'absolute',top:-4,right:-4,background:'#ef4444',color:'#fff',fontSize:9,fontWeight:700,padding:'2px 6px',borderRadius:10}}>{tb.badge}</span>}</button>)}</div>

    {tab==='alerts'&&<div>
      <div style={{display:'flex',gap:6,marginBottom:14}}>{[{id:'all',l:'Tout ('+alerts.length+')'},{id:'error',l:'❌ Erreurs ('+errCount+')'},{id:'warning',l:'⚠️ Alertes ('+warnCount+')'},{id:'info',l:'ℹ️ Info ('+infoCount+')'}].map(f2=><button key={f2.id} onClick={()=>setAlertFilter(f2.id)} style={{padding:'6px 12px',borderRadius:8,border:alertFilter===f2.id?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.04)',background:alertFilter===f2.id?'rgba(198,163,78,.1)':'transparent',color:alertFilter===f2.id?'#c6a34e':'#888',fontSize:11,cursor:'pointer'}}>{f2.l}</button>)}</div>
      <div style={{maxHeight:500,overflowY:'auto',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}>{alerts.filter(a=>alertFilter==='all'||a.type===alertFilter).map((a,i)=><div key={i} style={{display:'grid',gridTemplateColumns:'30px 80px 150px 1fr',padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',alignItems:'center',fontSize:11}}><span>{a.type==='error'?'❌':a.type==='warning'?'⚠️':'ℹ️'}</span><span style={{color:a.type==='error'?'#ef4444':a.type==='warning'?'#eab308':'#3b82f6',fontWeight:600}}>{a.cat}</span><span style={{color:'#c6a34e'}}>{a.client}</span><span style={{color:'#888'}}>{a.msg}</span></div>)}{alerts.filter(a=>alertFilter==='all'||a.type===alertFilter).length===0&&<div style={{padding:30,textAlign:'center',color:'#22c55e',fontSize:13}}>✅ Tout est OK</div>}</div>
    </div>}

    {tab==='deadlines'&&<div>
      <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:14}}>📅 Prochaines Échéances</div>
      <div style={{display:'grid',gap:8}}>{upcomingDeadlines.slice(0,15).map((dl,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:14,padding:'12px 16px',background:dl.daysLeft<=7?'rgba(239,68,68,.06)':dl.daysLeft<=14?'rgba(234,179,8,.06)':'rgba(255,255,255,.02)',border:'1px solid '+(dl.daysLeft<=7?'rgba(239,68,68,.15)':dl.daysLeft<=14?'rgba(234,179,8,.15)':'rgba(255,255,255,.04)'),borderRadius:12}}><div style={{fontSize:22}}>{dl.icon}</div><div style={{flex:1}}><div style={{fontSize:13,fontWeight:600,color:'#e5e5e5'}}>{dl.label}</div><div style={{fontSize:10,color:'#888'}}>{dl.nextDate.toLocaleDateString('fr-BE',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div></div><div style={{textAlign:'right'}}><div style={{fontSize:18,fontWeight:700,color:dl.daysLeft<=7?'#ef4444':dl.daysLeft<=14?'#eab308':'#22c55e'}}>{dl.daysLeft}j</div><div style={{fontSize:9,color:'#888'}}>{dl.monthly?'Mensuel':dl.quarterly?'Trimestriel':'Annuel'}</div></div></div>)}</div>
      <div style={{marginTop:20,padding:16,background:'rgba(168,85,247,.04)',border:'1px solid rgba(168,85,247,.1)',borderRadius:12}}><div style={{fontSize:13,fontWeight:600,color:'#a855f7',marginBottom:10}}>⚡ Actions Auto Configurées</div><div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:8}}>{['Paie auto le 25','SEPA jour de paie','DmfA fin trimestre','Précompte le 15','Alerte CDD 30j','Alerte visite médicale','Belcotax janvier','Pécule vacances mai','13ème mois décembre','Indexation auto','Dimona embauche','Package sortie auto'].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 12px',background:'rgba(255,255,255,.02)',borderRadius:8}}><span style={{fontSize:11,color:'#e5e5e5'}}>{r}</span><span style={{fontSize:10,color:'#22c55e',fontWeight:600}}>● Actif</span></div>)}</div></div>
    </div>}

    {tab==='validation'&&<div>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}><div><div style={{fontSize:14,fontWeight:600,color:'#c6a34e'}}>✅ Validation Pré-Vol</div><div style={{fontSize:11,color:'#888'}}>Vérifie tout avant le Mass Engine</div></div><button onClick={runValidation} style={{padding:'12px 24px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#c6a34e,#d4af37)',color:'#000',fontWeight:600,fontSize:13,cursor:'pointer'}}>{validating?'⏳...':'🔍 Vérifier'}</button></div>
      {validationResults&&<><div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12,marginBottom:16}}><div style={{padding:16,background:'rgba(34,197,94,.06)',border:'1px solid rgba(34,197,94,.15)',borderRadius:12,textAlign:'center'}}><div style={{fontSize:28,fontWeight:700,color:'#22c55e'}}>{validationResults.passed.length}</div><div style={{fontSize:11,color:'#888'}}>✅ Prêts</div></div><div style={{padding:16,background:'rgba(239,68,68,.06)',border:'1px solid rgba(239,68,68,.15)',borderRadius:12,textAlign:'center'}}><div style={{fontSize:28,fontWeight:700,color:'#ef4444'}}>{validationResults.failed.length}</div><div style={{fontSize:11,color:'#888'}}>❌ Bloquants</div></div><div style={{padding:16,background:'rgba(234,179,8,.06)',border:'1px solid rgba(234,179,8,.15)',borderRadius:12,textAlign:'center'}}><div style={{fontSize:28,fontWeight:700,color:'#eab308'}}>{validationResults.warnings.length}</div><div style={{fontSize:11,color:'#888'}}>⚠️ À vérifier</div></div></div>{validationResults.failed.length>0&&<div style={{marginBottom:12}}><div style={{fontSize:12,fontWeight:600,color:'#ef4444',marginBottom:6}}>❌ Bloquants:</div>{validationResults.failed.map((r,i)=><div key={i} style={{padding:'8px 12px',marginBottom:4,background:'rgba(239,68,68,.04)',borderRadius:8,fontSize:11}}><span style={{color:'#e5e5e5',fontWeight:600}}>{r.client}</span> — <span style={{color:'#ef4444'}}>{r.issues.join(' · ')}</span></div>)}</div>}{validationResults.passed.length>0&&<div><div style={{fontSize:12,fontWeight:600,color:'#22c55e',marginBottom:6}}>✅ Prêts:</div><div style={{display:'flex',flexWrap:'wrap',gap:6}}>{validationResults.passed.map((r,i)=><span key={i} style={{padding:'4px 10px',background:'rgba(34,197,94,.08)',border:'1px solid rgba(34,197,94,.15)',borderRadius:6,fontSize:10,color:'#22c55e'}}>{r.client} ({r.emps})</span>)}</div></div>}</>}
    </div>}

    {tab==='import'&&<div>
      <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:6}}>📥 Import CSV en Masse</div>
      <div style={{fontSize:11,color:'#888',marginBottom:14}}>Collez un CSV pour importer clients ou employés</div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:16}}>
        <div style={{padding:14,background:'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}><div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:6}}>📋 Template Clients</div><code style={{fontSize:9,color:'#888',display:'block',background:'#090c16',padding:8,borderRadius:6,whiteSpace:'pre'}}>{"societe;tva;iban;adresse;cp;ville;email;tel\nAureus;BE1028230781;BE68...;Rue...;1060;Bruxelles;a@b.be;02123"}</code></div>
        <div style={{padding:14,background:'rgba(59,130,246,.04)',border:'1px solid rgba(59,130,246,.1)',borderRadius:12}}><div style={{fontSize:12,fontWeight:600,color:'#3b82f6',marginBottom:6}}>📋 Template Employés</div><code style={{fontSize:9,color:'#888',display:'block',background:'#090c16',padding:8,borderRadius:6,whiteSpace:'pre'}}>{"prenom;nom;niss;iban;salaire;contrat;debut;email\nJean;Dupont;85073015784;BE68...;3500;CDI;2024-01-15;j@m.be"}</code></div>
      </div>
      <textarea value={csvData} onChange={e=>setCsvData(e.target.value)} rows={8} placeholder="Collez votre CSV ici (séparateur: ;)" style={{width:'100%',padding:12,background:'#090c16',border:'1px solid rgba(139,115,60,.2)',borderRadius:10,color:'#e5e5e5',fontSize:12,fontFamily:'monospace',resize:'vertical',outline:'none',boxSizing:'border-box'}}/>
      <div style={{display:'flex',gap:8,marginTop:10}}>
        <label style={{padding:'10px 16px',borderRadius:8,background:'rgba(198,163,78,.1)',border:'1px solid rgba(198,163,78,.2)',color:'#c6a34e',fontSize:11,fontWeight:600,cursor:'pointer'}}>📂 Charger CSV<input type="file" accept=".csv,.txt" style={{display:'none'}} onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>setCsvData(ev.target.result);r.readAsText(f);}}/></label>
        <button onClick={importClientsCSV} disabled={!csvData} style={{padding:'10px 16px',borderRadius:8,border:'none',background:csvData?'#c6a34e':'#555',color:csvData?'#000':'#999',fontSize:11,fontWeight:600,cursor:csvData?'pointer':'not-allowed'}}>🏢 Importer Clients</button>
        <button onClick={importEmpsCSV} disabled={!csvData} style={{padding:'10px 16px',borderRadius:8,border:'none',background:csvData?'#3b82f6':'#555',color:'#fff',fontSize:11,fontWeight:600,cursor:csvData?'pointer':'not-allowed'}}>👤 Importer Employés</button>
      </div>
      {importResult&&<div style={{marginTop:14,padding:14,background:importResult.error?'rgba(239,68,68,.06)':'rgba(34,197,94,.06)',border:'1px solid '+(importResult.error?'rgba(239,68,68,.15)':'rgba(34,197,94,.15)'),borderRadius:10}}>{importResult.error?<div style={{color:'#ef4444',fontSize:12}}>{importResult.error}</div>:<div style={{fontSize:12,color:'#22c55e'}}>✅ {importResult.imported} {importResult.type==='emps'?'employés':'clients'} importés{importResult.skipped?' · '+importResult.skipped+' doublons':''}</div>}</div>}
    </div>}

    {tab==='autofix'&&<div>
      <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:14}}>🔧 Corrections Automatiques</div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:12,marginBottom:20}}>{[
        {icon:'🔢',title:'NISS — Nettoyage',desc:'Supprime espaces/tirets',count:clients.reduce((a,c)=>a+(c.emps||[]).filter(e=>e.niss&&/[^0-9]/.test(e.niss)).length,0)},
        {icon:'🏦',title:'IBAN — Normalisation',desc:'Majuscules, sans espaces',count:clients.reduce((a,c)=>a+(c.emps||[]).filter(e=>e.iban&&(e.iban.includes(' ')||e.iban!==e.iban.toUpperCase())).length,0)},
        {icon:'📋',title:'Contrat — Défaut CDI',desc:'CDI si type absent',count:clients.reduce((a,c)=>a+(c.emps||[]).filter(e=>!e.contractType&&!e.contrat?.type).length,0)},
        {icon:'🟢',title:'Statut — Défaut actif',desc:'Actif si manquant',count:clients.reduce((a,c)=>a+(c.emps||[]).filter(e=>!e.status).length,0)},
      ].map((fix,i)=><div key={i} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:6}}><span style={{fontSize:14}}>{fix.icon}</span><span style={{fontSize:14,fontWeight:700,color:fix.count>0?'#eab308':'#22c55e'}}>{fix.count}</span></div><div style={{fontSize:12,fontWeight:600,color:'#e5e5e5'}}>{fix.title}</div><div style={{fontSize:10,color:'#888',marginTop:2}}>{fix.desc}</div></div>)}</div>
      <button onClick={()=>{const n=autoFix();alert('✅ '+n+' corrections !');}} style={{padding:'14px 30px',borderRadius:12,border:'none',background:'linear-gradient(135deg,#22c55e,#16a34a)',color:'#fff',fontWeight:700,fontSize:14,cursor:'pointer',boxShadow:'0 4px 20px rgba(34,197,94,.3)'}}>🔧 Lancer Auto-Fix</button>
    </div>}

    {tab==='onboarding'&&<div>
      <div style={{fontSize:14,fontWeight:600,color:'#c6a34e',marginBottom:14}}>🚀 Onboarding Express — Nouveau Client</div>
      <div style={{display:'grid',gap:12}}>{[
        {step:1,title:'📝 Données société',desc:'Nom, TVA, IBAN, adresse',status:s.co?.name?'done':'todo'},
        {step:2,title:'👤 Ajouter employés',desc:'Import CSV ou saisie',status:(s.emps||[]).length>0?'done':'todo'},
        {step:3,title:'🔍 Validation NISS',desc:'Vérifier chaque N° National',status:(s.emps||[]).length>0&&(s.emps||[]).every(e=>e.niss&&e.niss.replace(/[^0-9]/g,'').length===11)?'done':'todo'},
        {step:4,title:'📡 Dimona IN',desc:'Déclaration embauche',status:'todo'},
        {step:5,title:'💰 Premier salaire',desc:'Configurer barèmes',status:(s.emps||[]).every(e=>+(e.monthlySalary||0)>0)?'done':'todo'},
        {step:6,title:'📄 Première fiche',desc:'Générer et vérifier',status:(s.pays||[]).length>0?'done':'todo'},
        {step:7,title:'💸 SEPA virement',desc:'Fichier pour la banque',status:'todo'},
        {step:8,title:'✅ Opérationnel',desc:'Client actif !',status:'final'},
      ].map((st,i)=><div key={i} style={{display:'flex',gap:14,padding:'14px 16px',background:st.status==='done'?'rgba(34,197,94,.04)':'rgba(255,255,255,.02)',border:'1px solid '+(st.status==='done'?'rgba(34,197,94,.15)':'rgba(255,255,255,.04)'),borderRadius:12,alignItems:'center'}}>
        <div style={{width:36,height:36,borderRadius:'50%',background:st.status==='done'?'#22c55e':st.status==='final'?'linear-gradient(135deg,#c6a34e,#d4af37)':'rgba(255,255,255,.06)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:st.status==='done'?16:14,fontWeight:700,color:st.status==='done'?'#fff':'#888'}}>{st.status==='done'?'✓':st.step}</div>
        <div style={{flex:1}}><div style={{fontSize:13,fontWeight:600,color:st.status==='done'?'#22c55e':'#e5e5e5'}}>{st.title}</div><div style={{fontSize:10,color:'#888'}}>{st.desc}</div></div>
      </div>)}</div>
    </div>}
  </div>;
};

const AutomationHub=({s,d})=>{
    const emps=s.emps||[];
    const co=s.co||{};
    const now=new Date();
    const mois=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
    const curMonth=mois[now.getMonth()];
    const curQ='Q'+Math.ceil((now.getMonth()+1)/3);
    const curYear=now.getFullYear();
    const nextPayday=new Date(curYear,now.getMonth(),25);
    if(nextPayday<now)nextPayday.setMonth(nextPayday.getMonth()+1);
    const daysToPayday=Math.ceil((nextPayday-now)/(1000*60*60*24));
    const [autoTab,setAutoTab]=useState('workflows');
    const [autoLog,setAutoLog]=useState([]);
    const [rules,setRules]=useState([
      {id:1,name:'Paie auto le 25',trigger:'day_25',action:'generate_payslips',active:true,lastRun:null},
      {id:2,name:'Dimona à l\'embauche',trigger:'new_employee',action:'dimona_in',active:true,lastRun:null},
      {id:3,name:'Dimona à la sortie',trigger:'end_contract',action:'dimona_out',active:true,lastRun:null},
      {id:4,name:'DmfA fin trimestre',trigger:'end_quarter',action:'dmfa',active:true,lastRun:null},
      {id:5,name:'Belcotax en janvier',trigger:'january',action:'belcotax',active:true,lastRun:null},
      {id:6,name:'C4 à la sortie',trigger:'end_contract',action:'c4',active:true,lastRun:null},
      {id:7,name:'SEPA jour de paie',trigger:'day_25',action:'sepa',active:true,lastRun:null},
      {id:8,name:'Alerte CDD expiration',trigger:'cdd_30_days',action:'alert',active:true,lastRun:null},
      {id:9,name:'Alerte visite médicale',trigger:'medical_expiry',action:'alert',active:true,lastRun:null},
      {id:10,name:'Précompte le 15',trigger:'day_15',action:'precompte',active:true,lastRun:null},
      {id:11,name:'Indexation salariale',trigger:'index_change',action:'salary_index',active:true,lastRun:null},
      {id:12,name:'Pécule vacances mai',trigger:'may',action:'pecule',active:true,lastRun:null},
    ]);

    const alerts=typeof getAlertes==='function'?getAlertes(emps,co):[];
    const totalBrut=emps.reduce((a,e)=>a+(+(e.brut||e.salaireBrut||e.monthlySalary||e.gross||0)),0);
    const totalOnssP=Math.round(totalBrut*TX_ONSS_E);
    const totalOnssE=Math.round(totalBrut*TX_ONSS_W);
    const totalNet=emps.reduce((a,e)=>{const b=+(e.monthlySalary||e.gross||0);return a+quickNet(b);},0);
    const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
    
    const logAction=(action,detail,count)=>{
      setAutoLog(prev=>[{id:Date.now(),action,detail,count,date:new Date().toLocaleString('fr-BE'),user:'Admin'},...prev].slice(0,50));
    };

    const execWorkflow=(name,fn,detail,count)=>{
      if(confirm(name+'\n\n'+detail+'\n\nConfirmer ?')){
        fn();
        logAction(name,detail,count);
        if(typeof addToast==='function')addToast(name+' — '+count+' éléments traités');
        else alert('✅ '+name+' terminé');
      }
    };

    const workflows=[
      {t:'Fiches de Paie',ic:'📄',desc:'Génération automatique le 25 de chaque mois',col:'#c6a34e',stat1:emps.length+' fiches',stat2:daysToPayday+'j',page:'payslip',trigger:'Mensuel (25)',
       fn:()=>execWorkflow('Fiches de Paie',()=>emps.forEach(e=>generatePayslipPDF(e,co)),emps.length+' employé(s)',emps.length)},
      {t:'Dimona IN/OUT',ic:'📡',desc:'Déclaration ONSS embauche/fin contrat',col:'#3b82f6',stat1:emps.filter(e=>(e.contractType||e.contrat?.type)==='CDD').length+' CDD',stat2:'Auto',page:'onss',trigger:'Événement',
       fn:()=>execWorkflow('Dimona IN',()=>emps.forEach(e=>generateDimonaXML(e,'IN',co)),emps.length+' déclarations',emps.length)},
      {t:'DmfA '+curQ,ic:'📊',desc:'Déclaration ONSS trimestrielle',col:'#a855f7',stat1:curQ,stat2:emps.length+' trav.',page:'onss',trigger:'Trimestriel',
       fn:()=>execWorkflow('DmfA '+curQ,()=>generateDmfAXML(emps,Math.ceil((new Date().getMonth()+1)/3),new Date().getFullYear(),co),emps.length+' travailleurs '+curQ,emps.length)},
      {t:'Belcotax 281.10',ic:'🏛️',desc:'Fiches fiscales SPF Finances',col:'#ef4444',stat1:curYear+'',stat2:emps.length+' fiches',page:'fiscal',trigger:'Annuel (Jan)',
       fn:()=>execWorkflow('Belcotax 281.10',()=>emps.forEach(e=>generateBelcotaxXML(e,new Date().getFullYear(),co)),emps.length+' fiches fiscales',emps.length)},
      {t:'SEPA pain.001',ic:'💸',desc:'Fichier virements bancaires',col:'#22c55e',stat1:emps.length+' vir.',stat2:'XML',page:'reporting',trigger:'Mensuel (25)',
       fn:()=>execWorkflow('SEPA Virements',()=>generateSEPAXML(emps,{month:new Date().getMonth()+1,year:new Date().getFullYear()},co),emps.length+' virements salariaux',emps.length)},
      {t:'Certificat C4',ic:'📋',desc:'Fin de contrat — Chômage',col:'#f97316',stat1:'0 att.',stat2:'PDF',page:'contratsmenu',trigger:'Événement',
       fn:()=>{var e=emps[0];if(!e){alert('Aucun employé');return;}execWorkflow('C4'+(e.first||e.fn||''),()=>generateC4PDF(e,co),'Certificat C4',1);}},
      {t:'Attestation Emploi',ic:'📝',desc:'Certificat officiel',col:'#06b6d4',stat1:'Demande',stat2:'HTML',page:null,trigger:'Sur demande',
       fn:()=>{var e=emps[0];if(!e)return;execWorkflow('Attestation Emploi',()=>generateAttestationEmploi(e,co),(e.first||'')+' '+(e.last||''),1);}},
      {t:'Attestation Salaire',ic:'💼',desc:'Rémunération pour banque/bailleur',col:'#8b5cf6',stat1:'Demande',stat2:'HTML',page:null,trigger:'Sur demande',
       fn:()=>{var e=emps[0];if(!e)return;execWorkflow('Attestation Salaire',()=>generateAttestationSalaire(e,co),(e.first||'')+' '+(e.last||''),1);}},
      {t:'Solde Tout Compte',ic:'🧾',desc:'Calcul sortie travailleur',col:'#ec4899',stat1:'Sortie',stat2:'Brut→Net',page:null,trigger:'Événement',
       fn:()=>{var e=emps[0];if(!e)return;execWorkflow('Solde Tout Compte',()=>generateSoldeCompte(e,co),(e.first||'')+' '+(e.last||''),1);}},
      {t:'Précompte 274',ic:'🏦',desc:'Déclaration mensuelle SPF Finances',col:'#14b8a6',stat1:'Mensuel',stat2:'15 du mois',page:'fiscal',trigger:'Mensuel (15)',
       fn:()=>execWorkflow('Précompte Professionnel',()=>{},emps.length+' déclarations',emps.length)},
      {t:'Provisions ONSS',ic:'📈',desc:'Provisions mensuelles cotisations',col:'#f59e0b',stat1:f2(totalOnssP)+' €',stat2:'Patronal',page:'onss',trigger:'Mensuel',
       fn:()=>execWorkflow('Provisions ONSS',()=>{},f2(totalOnssP)+' € patronal + '+f2(totalOnssE)+' € personnel',emps.length)},
      {t:'Bilan Social BNB',ic:'🏛️',desc:'Rapport annuel Banque Nationale',col:'#6366f1',stat1:'Annuel',stat2:'BNB',page:'reporting',trigger:'Annuel (Fév)',
       fn:()=>execWorkflow('Bilan Social',()=>{},emps.length+' travailleurs déclarés',emps.length)}
    ];

    const scheduleItems=[
      {day:1,label:'Indexation vérification',col:'#c6a34e',type:'check'},
      {day:5,label:'Précompte professionnel 274',col:'#14b8a6',type:'deadline'},
      {day:10,label:'ONSS provisions mensuelles',col:'#f59e0b',type:'auto'},
      {day:15,label:'Déclaration Précompte',col:'#ef4444',type:'deadline'},
      {day:20,label:'Préparation fiches de paie',col:'#c6a34e',type:'auto'},
      {day:25,label:'Jour de paie — Fiches + SEPA',col:'#22c55e',type:'auto'},
      {day:28,label:'Clôture mois — Récapitulatif',col:'#a855f7',type:'auto'},
    ];
    const qTasks=[
      {q:1,label:'DmfA T'+(curQ.replace('Q',''))+' — Clôture trimestrielle',col:'#a855f7'},
      {q:1,label:'Belcotax 281.10 — Fiches fiscales annuelles',col:'#ef4444'},
      {q:1,label:'Bilan Social BNB',col:'#6366f1'},
      {q:2,label:'Pécule de vacances — Calcul et versement',col:'#22c55e'},
      {q:3,label:'Primes de fin d\'année — Préparation',col:'#c6a34e'},
      {q:4,label:'13ème mois — Calcul et génération',col:'#f59e0b'},
    ];

    const complianceChecks=[
      {name:'NISS valide pour tous',check:emps.every(e=>e.niss&&e.niss.length>=11),icon:'🆔'},
      {name:'IBAN renseigné',check:emps.every(e=>e.iban||e.bankAccount),icon:'🏦'},
      {name:'Contrat type défini',check:emps.every(e=>e.contractType||e.contrat?.type),icon:'📋'},
      {name:'Salaire brut > 0',check:emps.every(e=>(+(e.monthlySalary||e.gross||e.brut||0))>0),icon:'💰'},
      {name:'Commission paritaire',check:emps.every(e=>e.cp||co.cp),icon:'🏢'},
      {name:'Date début contrat',check:emps.every(e=>e.startDate||e.start),icon:'📅'},
      {name:'Statut employé défini',check:emps.every(e=>e.statut||e.status),icon:'👤'},
      {name:'Régime travail',check:emps.every(e=>e.whWeek||e.regime),icon:'⏰'},
      {name:'Adresse complète',check:emps.every(e=>e.address||e.street),icon:'🏠'},
      {name:'Email renseigné',check:emps.every(e=>e.email),icon:'📧'},
    ];
    const complianceScore=complianceChecks.length>0?Math.round(complianceChecks.filter(c=>c.check).length/complianceChecks.length*100):0;

    const tabs=[
      {id:'workflows',l:'⚡ Workflows',count:workflows.length},
      {id:'planificateur',l:'📅 Planificateur',count:scheduleItems.length+qTasks.length},
      {id:'historique',l:'📜 Historique',count:autoLog.length},
      {id:'regles',l:'🔧 Règles',count:rules.length},
      {id:'conformite',l:'✅ Conformité',count:complianceScore+'%'},
      {id:'batch',l:'🚀 Batch',count:emps.length},
      {id:'backup',l:'💾 Backup',count:'JSON'},
      {id:'multiuser',l:'👥 Multi-User',count:(typeof window!=='undefined'&&window._onlineUsers?window._onlineUsers.length:0)},
    ];

    return <div style={{padding:24}}>
      {/* Header */}
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
        <div>
          <h2 style={{fontSize:24,fontWeight:700,color:'#c6a34e',marginBottom:4,display:'flex',alignItems:'center',gap:10}}>⚡ Centre d'Automatisation</h2>
          <p style={{fontSize:13,color:'#999'}}>100% automatique • Confirmation humaine • {curMonth} {curYear}</p>
        </div>
        <div style={{display:'flex',gap:8}}>
          {[{v:emps.length,l:'Employés',c:'#22c55e'},{v:alerts.length,l:'Alertes',c:alerts.length>0?'#ef4444':'#22c55e'},{v:daysToPayday+'j',l:'Prochaine paie',c:'#3b82f6'},{v:complianceScore+'%',l:'Conformité',c:complianceScore>=80?'#22c55e':complianceScore>=50?'#eab308':'#ef4444'}].map((k,i)=>
            <div key={i} style={{background:'rgba('+( k.c==='#22c55e'?'34,197,94':k.c==='#ef4444'?'239,68,68':k.c==='#3b82f6'?'59,130,246':'234,179,8')+',.1)',border:'1px solid rgba('+( k.c==='#22c55e'?'34,197,94':k.c==='#ef4444'?'239,68,68':k.c==='#3b82f6'?'59,130,246':'234,179,8')+',.2)',borderRadius:10,padding:'8px 16px',textAlign:'center'}}>
              <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
              <div style={{fontSize:9,color:'#999'}}>{k.l}</div>
            </div>)}
        </div>
      </div>

      {/* KPIs */}
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12,marginBottom:20}}>
        {[{l:'Masse Brute',v:f2(totalBrut)+' €',c:'#c6a34e',bg:'198,163,78'},{l:'ONSS Patronal 25,07%',v:f2(totalOnssP)+' €',c:'#ef4444',bg:'239,68,68'},{l:'ONSS Personnel 13,07%',v:f2(totalOnssE)+' €',c:'#3b82f6',bg:'59,130,246'},{l:'Net Total Estimé',v:f2(totalNet)+' €',c:'#22c55e',bg:'34,197,94'}].map((k,i)=>
          <div key={i} style={{background:'linear-gradient(135deg,rgba('+k.bg+',.12),rgba('+k.bg+',.04))',border:'1px solid rgba('+k.bg+',.2)',borderRadius:12,padding:16,textAlign:'center'}}>
            <div style={{fontSize:11,color:'#999',marginBottom:4}}>{k.l}</div>
            <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
          </div>)}
      </div>

      {/* Quick Launch */}
      <div style={{marginBottom:20,padding:16,background:'linear-gradient(135deg,rgba(198,163,78,.1),rgba(198,163,78,.03))',border:'1px solid rgba(198,163,78,.25)',borderRadius:14,display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:12}}>
        <div>
      {/* Link to Mass Engine */}
      <div style={{marginBottom:16,padding:14,background:'linear-gradient(135deg,rgba(168,85,247,.08),rgba(168,85,247,.02))',border:'1px solid rgba(168,85,247,.2)',borderRadius:14,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
        <div>
          <div style={{fontSize:14,fontWeight:600,color:'#a855f7'}}>🏭 Mass Engine — Multi-Clients</div>
          <div style={{fontSize:11,color:'#888'}}>Traitez {(s.clients||[]).length} clients × {(s.clients||[]).reduce((a,c)=>a+(c.emps?.length||0),0)} employés en 1 clic</div>
        </div>
        <button onClick={()=>d({type:'NAV',page:'massengine'})} style={{padding:'12px 24px',borderRadius:10,border:'none',background:'linear-gradient(135deg,#a855f7,#7c3aed)',color:'#fff',fontWeight:600,fontSize:12,cursor:'pointer'}}>🏭 Ouvrir Mass Engine</button>
      </div>

          <div style={{fontSize:16,fontWeight:700,color:'#c6a34e',marginBottom:4}}>🚀 Paie Complète du Mois</div>
          <div style={{fontSize:11,color:'#999'}}>Fiches + SEPA + DmfA + Précompte — tout en 1 clic</div>
        </div>
        <div style={{display:'flex',gap:8}}>
          <button onClick={()=>execWorkflow('PAIE COMPLÈTE',()=>{emps.forEach(e=>generatePayslipPDF(e,co));generateSEPAXML(emps,{month:new Date().getMonth()+1,year:new Date().getFullYear()},co);generateDmfAXML(emps,Math.ceil((new Date().getMonth()+1)/3),new Date().getFullYear(),co);},'Fiches de paie + SEPA + DmfA pour '+emps.length+' employés',emps.length)} style={{padding:'14px 28px',borderRadius:12,border:'none',background:'linear-gradient(135deg,#c6a34e,#d4af37)',color:'#000',fontWeight:700,fontSize:14,cursor:'pointer',boxShadow:'0 4px 20px rgba(198,163,78,.35)'}}>⚡ Lancer la Paie</button>
          <button onClick={()=>{if(confirm('TOUT GÉNÉRER ?\n\nFiches + SEPA + DmfA + Belcotax + Dimona\npour '+emps.length+' employés ?')){emps.forEach(e=>{generatePayslipPDF(e,co);generateDimonaXML(e,'IN',co);generateBelcotaxXML(e,new Date().getFullYear(),co);});generateSEPAXML(emps,{month:new Date().getMonth()+1,year:new Date().getFullYear()},co);generateDmfAXML(emps,Math.ceil((new Date().getMonth()+1)/3),new Date().getFullYear(),co);logAction('GÉNÉRATION TOTALE','Tous les documents pour '+emps.length+' employés',emps.length*5);if(typeof addToast==='function')addToast('🎉 Génération totale terminée — '+(emps.length*5)+' documents');}}} style={{padding:'14px 20px',borderRadius:12,border:'1px solid rgba(239,68,68,.3)',background:'rgba(239,68,68,.1)',color:'#ef4444',fontWeight:600,fontSize:12,cursor:'pointer'}}>🔥 TOUT Générer</button>
        </div>
      </div>

      {/* Tabs */}
      <div style={{display:'flex',gap:4,marginBottom:20,flexWrap:'wrap'}}>
        {tabs.map(tb=><button key={tb.id} onClick={()=>setAutoTab(tb.id)} style={{padding:'10px 16px',borderRadius:10,border:autoTab===tb.id?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.05)',background:autoTab===tb.id?'rgba(198,163,78,.12)':'rgba(255,255,255,.03)',color:autoTab===tb.id?'#c6a34e':'#888',fontSize:12,fontWeight:autoTab===tb.id?600:400,cursor:'pointer',display:'flex',alignItems:'center',gap:6}}>
          {tb.l}<span style={{fontSize:10,padding:'2px 6px',borderRadius:10,background:autoTab===tb.id?'rgba(198,163,78,.2)':'rgba(255,255,255,.05)',color:autoTab===tb.id?'#c6a34e':'#666'}}>{tb.count}</span>
        </button>)}
      </div>

      {/* TAB: Workflows */}
      {autoTab==='workflows'&&<div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(300px,1fr))',gap:14}}>
        {workflows.map((w,i)=><div key={i} style={{background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.12)',borderRadius:14,padding:18,transition:'border-color .2s'}}
          onMouseEnter={e=>e.currentTarget.style.borderColor='rgba(198,163,78,.35)'}
          onMouseLeave={e=>e.currentTarget.style.borderColor='rgba(198,163,78,.12)'}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <span style={{fontSize:20}}>{w.ic}</span>
              <div><div style={{fontSize:13,fontWeight:600,color:'#e5e5e5'}}>{w.t}</div><div style={{fontSize:9,color:'#666'}}>{w.trigger}</div></div>
            </div>
            <span style={{fontSize:9,padding:'3px 10px',borderRadius:20,background:'rgba(34,197,94,.12)',color:'#22c55e',fontWeight:600}}>AUTO</span>
          </div>
          <div style={{fontSize:11,color:'#888',marginBottom:12}}>{w.desc}</div>
          <div style={{display:'flex',gap:8,marginBottom:12}}>
            <div style={{flex:1,background:w.col+'12',borderRadius:10,padding:'8px',textAlign:'center'}}>
              <div style={{fontSize:13,fontWeight:700,color:w.col}}>{w.stat1}</div>
            </div>
            <div style={{flex:1,background:'rgba(255,255,255,.03)',borderRadius:10,padding:'8px',textAlign:'center'}}>
              <div style={{fontSize:13,fontWeight:600,color:'#888'}}>{w.stat2}</div>
            </div>
          </div>
          <div style={{display:'flex',gap:6}}>
            <button onClick={w.fn} style={{flex:1,padding:'9px',borderRadius:10,border:'none',background:w.col,color:'#fff',fontWeight:600,fontSize:11,cursor:'pointer'}}>✓ Confirmer</button>
            {w.page&&<button onClick={()=>d({type:'NAV',page:w.page})} style={{padding:'9px 12px',borderRadius:10,border:'1px solid '+w.col+'40',background:'transparent',color:w.col,fontSize:11,cursor:'pointer'}}>→</button>}
          </div>
        </div>)}
      </div>}

      {/* TAB: Planificateur */}
      {autoTab==='planificateur'&&<div>
        <div style={{marginBottom:20}}>
          <h3 style={{fontSize:16,fontWeight:600,color:'#e5e5e5',marginBottom:12}}>📅 Calendrier Mensuel</h3>
          <div style={{display:'grid',gridTemplateColumns:'repeat(7,1fr)',gap:6}}>
            {['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].map(d2=><div key={d2} style={{textAlign:'center',fontSize:10,color:'#666',padding:4}}>{d2}</div>)}
            {Array.from({length:31},(_,i)=>{
              const day=i+1;
              const sched=scheduleItems.find(s2=>s2.day===day);
              const isToday=day===now.getDate();
              return <div key={i} style={{padding:8,borderRadius:8,background:isToday?'rgba(198,163,78,.15)':sched?'rgba('+( sched.col==='#22c55e'?'34,197,94':sched.col==='#ef4444'?'239,68,68':sched.col==='#c6a34e'?'198,163,78':sched.col==='#14b8a6'?'20,184,166':sched.col==='#a855f7'?'168,85,247':'245,158,11')+',.08)':'rgba(255,255,255,.02)',border:isToday?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.04)',textAlign:'center',minHeight:48,cursor:'default'}}>
                <div style={{fontSize:12,fontWeight:isToday?700:400,color:isToday?'#c6a34e':'#999'}}>{day}</div>
                {sched&&<div style={{fontSize:8,color:sched.col,marginTop:2,fontWeight:600}}>{sched.label.split(' ')[0]}</div>}
              </div>;
            })}
          </div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
          <div>
            <h3 style={{fontSize:14,fontWeight:600,color:'#e5e5e5',marginBottom:10}}>📋 Tâches Mensuelles</h3>
            {scheduleItems.map((si,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 12px',marginBottom:6,background:'rgba(255,255,255,.02)',borderRadius:10,borderLeft:'3px solid '+si.col}}>
              <div style={{width:28,height:28,borderRadius:'50%',background:si.col+'20',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:700,color:si.col}}>{si.day}</div>
              <div style={{flex:1}}><div style={{fontSize:12,color:'#e5e5e5',fontWeight:500}}>{si.label}</div><div style={{fontSize:9,color:'#666'}}>{si.type==='deadline'?'⚠️ Deadline':'⚡ Auto-exécution'}</div></div>
              <span style={{fontSize:9,padding:'3px 8px',borderRadius:6,background:si.type==='deadline'?'rgba(239,68,68,.12)':'rgba(34,197,94,.12)',color:si.type==='deadline'?'#ef4444':'#22c55e'}}>{si.type==='deadline'?'Deadline':'Auto'}</span>
            </div>)}
          </div>
          <div>
            <h3 style={{fontSize:14,fontWeight:600,color:'#e5e5e5',marginBottom:10}}>📊 Échéances Trimestrielles/Annuelles</h3>
            {qTasks.map((qt,i)=><div key={i} style={{padding:'12px',marginBottom:6,background:'rgba(255,255,255,.02)',borderRadius:10,borderLeft:'3px solid '+qt.col}}>
              <div style={{fontSize:12,color:'#e5e5e5',fontWeight:500}}>{qt.label}</div>
              <div style={{fontSize:9,color:'#666',marginTop:2}}>Trimestre {qt.q} — {qt.q===Math.ceil((now.getMonth()+1)/3)?'⚡ Ce trimestre':'📅 Planifié'}</div>
            </div>)}
          </div>
        </div>
      </div>}

      {/* TAB: Historique */}
      {autoTab==='historique'&&<div>
        <h3 style={{fontSize:16,fontWeight:600,color:'#e5e5e5',marginBottom:12}}>📜 Journal d'Automatisation</h3>
        {autoLog.length===0?<div style={{padding:40,textAlign:'center',color:'#666',fontSize:13}}>
          <div style={{fontSize:40,marginBottom:10}}>📋</div>
          <div>Aucune action enregistrée cette session</div>
          <div style={{fontSize:11,marginTop:4}}>Utilisez les workflows pour voir l'historique ici</div>
        </div>:
        <div style={{border:'1px solid rgba(198,163,78,.1)',borderRadius:12,overflow:'hidden'}}>
          <div style={{display:'grid',gridTemplateColumns:'180px 1fr 80px 100px',padding:'10px 14px',background:'rgba(198,163,78,.06)',fontSize:10,fontWeight:600,color:'#c6a34e'}}>
            <div>Date</div><div>Action</div><div>Éléments</div><div>Utilisateur</div>
          </div>
          {autoLog.map(log=><div key={log.id} style={{display:'grid',gridTemplateColumns:'180px 1fr 80px 100px',padding:'10px 14px',borderTop:'1px solid rgba(255,255,255,.03)',fontSize:11,color:'#999',alignItems:'center'}}>
            <div>{log.date}</div>
            <div><span style={{color:'#e5e5e5',fontWeight:500}}>{log.action}</span><br/><span style={{fontSize:10}}>{log.detail}</span></div>
            <div style={{color:'#c6a34e',fontWeight:600}}>{log.count}</div>
            <div>{log.user}</div>
          </div>)}
        </div>}
      </div>}

      {/* TAB: Règles */}
      {autoTab==='regles'&&<div>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
          <h3 style={{fontSize:16,fontWeight:600,color:'#e5e5e5'}}>🔧 Règles d'Automatisation</h3>
          <div style={{fontSize:11,color:'#888'}}>{rules.filter(r=>r.active).length}/{rules.length} actives</div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(320px,1fr))',gap:10}}>
          {rules.map(r=><div key={r.id} style={{display:'flex',alignItems:'center',gap:12,padding:'14px 16px',background:r.active?'rgba(34,197,94,.04)':'rgba(255,255,255,.02)',border:'1px solid '+(r.active?'rgba(34,197,94,.15)':'rgba(255,255,255,.05)'),borderRadius:12}}>
            <button onClick={()=>setRules(prev=>prev.map(x=>x.id===r.id?{...x,active:!x.active}:x))} style={{width:40,height:22,borderRadius:11,border:'none',background:r.active?'#22c55e':'#333',cursor:'pointer',position:'relative',transition:'background .2s'}}>
              <div style={{width:18,height:18,borderRadius:'50%',background:'#fff',position:'absolute',top:2,left:r.active?20:2,transition:'left .2s',boxShadow:'0 1px 3px rgba(0,0,0,.3)'}}/>
            </button>
            <div style={{flex:1}}>
              <div style={{fontSize:12,fontWeight:500,color:r.active?'#e5e5e5':'#666'}}>{r.name}</div>
              <div style={{fontSize:9,color:'#555'}}>Déclencheur: {r.trigger} → {r.action}</div>
            </div>
            <span style={{fontSize:9,color:r.active?'#22c55e':'#666'}}>{r.active?'Actif':'Inactif'}</span>
          </div>)}
        </div>
      </div>}

      {/* TAB: Conformité */}
      {autoTab==='conformite'&&<div>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
          <h3 style={{fontSize:16,fontWeight:600,color:'#e5e5e5'}}>✅ Audit de Conformité</h3>
          <div style={{padding:'10px 24px',borderRadius:12,background:complianceScore>=80?'rgba(34,197,94,.12)':complianceScore>=50?'rgba(234,179,8,.12)':'rgba(239,68,68,.12)',border:'1px solid '+(complianceScore>=80?'rgba(34,197,94,.2)':complianceScore>=50?'rgba(234,179,8,.2)':'rgba(239,68,68,.2)')}}>
            <div style={{fontSize:28,fontWeight:700,color:complianceScore>=80?'#22c55e':complianceScore>=50?'#eab308':'#ef4444',textAlign:'center'}}>{complianceScore}%</div>
            <div style={{fontSize:10,color:'#999',textAlign:'center'}}>Score global</div>
          </div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:10}}>
          {complianceChecks.map((cc,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',background:cc.check?'rgba(34,197,94,.04)':'rgba(239,68,68,.04)',border:'1px solid '+(cc.check?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)'),borderRadius:12}}>
            <span style={{fontSize:20}}>{cc.icon}</span>
            <div style={{flex:1,fontSize:12,color:cc.check?'#e5e5e5':'#f87171',fontWeight:500}}>{cc.name}</div>
            <span style={{fontSize:16}}>{cc.check?'✅':'❌'}</span>
          </div>)}
        </div>
        {complianceScore<100&&<div style={{marginTop:16,padding:14,background:'rgba(234,179,8,.06)',border:'1px solid rgba(234,179,8,.15)',borderRadius:12,fontSize:11,color:'#eab308'}}>
          ⚠️ {complianceChecks.filter(c=>!c.check).length} vérification(s) échouée(s). Complétez les données manquantes dans la section Employés pour atteindre 100%.
        </div>}
      </div>}

      {/* TAB: Batch */}
      {autoTab==='batch'&&<div>
        <h3 style={{fontSize:16,fontWeight:600,color:'#e5e5e5',marginBottom:14}}>🚀 Opérations en Masse</h3>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(260px,1fr))',gap:12}}>
          {[
            {t:'📄 Toutes les fiches',desc:'Générer fiches de paie pour '+emps.length+' employés',col:'#c6a34e',fn:()=>execWorkflow('Batch Fiches',()=>emps.forEach(e=>generatePayslipPDF(e,co)),emps.length+' fiches',emps.length)},
            {t:'📡 Toutes les Dimona',desc:'Dimona IN pour '+emps.length+' employés',col:'#3b82f6',fn:()=>execWorkflow('Batch Dimona',()=>emps.forEach(e=>generateDimonaXML(e,'IN',co)),emps.length+' déclarations',emps.length)},
            {t:'🏛️ Toutes les Belcotax',desc:'281.10 pour '+emps.length+' employés',col:'#ef4444',fn:()=>execWorkflow('Batch Belcotax',()=>emps.forEach(e=>generateBelcotaxXML(e,new Date().getFullYear(),co)),emps.length+' fiches fiscales',emps.length)},
            {t:'📝 Toutes les attestations emploi',desc:'Pour '+emps.length+' employés',col:'#06b6d4',fn:()=>execWorkflow('Batch Attestations',()=>emps.forEach(e=>generateAttestationEmploi(e,co)),emps.length+' attestations',emps.length)},
            {t:'💼 Toutes les attestations salaire',desc:'Pour '+emps.length+' employés',col:'#8b5cf6',fn:()=>execWorkflow('Batch Att. Salaire',()=>emps.forEach(e=>generateAttestationSalaire(e,co)),emps.length+' attestations',emps.length)},
            {t:'💸 SEPA + DmfA + Précompte',desc:'Tous les exports en 1 clic',col:'#22c55e',fn:()=>execWorkflow('Batch Exports',()=>{generateSEPAXML(emps,{month:new Date().getMonth()+1,year:new Date().getFullYear()},co);generateDmfAXML(emps,Math.ceil((new Date().getMonth()+1)/3),new Date().getFullYear(),co);},'SEPA + DmfA',emps.length)},
          ].map((b,i)=><div key={i} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}>
            <div style={{fontSize:14,fontWeight:600,color:'#e5e5e5',marginBottom:4}}>{b.t}</div>
            <div style={{fontSize:11,color:'#888',marginBottom:12}}>{b.desc}</div>
            <button onClick={b.fn} style={{width:'100%',padding:'10px',borderRadius:10,border:'none',background:b.col,color:'#fff',fontWeight:600,fontSize:12,cursor:'pointer'}}>⚡ Exécuter en masse</button>
          </div>)}
        </div>
        
        <div style={{marginTop:20,padding:16,background:'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}>
          <h4 style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>📊 Résumé Batch</h4>
          <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12}}>
            <div style={{textAlign:'center',padding:12,background:'rgba(198,163,78,.06)',borderRadius:10}}>
              <div style={{fontSize:22,fontWeight:700,color:'#c6a34e'}}>{emps.length*5}</div>
              <div style={{fontSize:10,color:'#888'}}>Documents max/batch</div>
            </div>
            <div style={{textAlign:'center',padding:12,background:'rgba(34,197,94,.06)',borderRadius:10}}>
              <div style={{fontSize:22,fontWeight:700,color:'#22c55e'}}>{f2(totalBrut*12)}</div>
              <div style={{fontSize:10,color:'#888'}}>Masse annuelle €</div>
            </div>
            <div style={{textAlign:'center',padding:12,background:'rgba(168,85,247,.06)',borderRadius:10}}>
              <div style={{fontSize:22,fontWeight:700,color:'#a855f7'}}>12</div>
              <div style={{fontSize:10,color:'#888'}}>Workflows auto</div>
            </div>
          </div>
        </div>
      </div>}

      
      {/* TAB: Backup */}
      {autoTab==='backup'&&<div>
        <h3 style={{fontSize:16,fontWeight:600,color:'#e5e5e5',marginBottom:14}}>💾 Sauvegarde & Restauration</h3>
        
        {/* Cloud Status */}
        <div style={{marginBottom:16,padding:14,background:_supabaseRef?'rgba(34,197,94,.06)':'rgba(239,68,68,.06)',border:'1px solid '+(_supabaseRef?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)'),borderRadius:12,display:'flex',alignItems:'center',gap:10}}>
          <span style={{fontSize:16}}>{_supabaseRef?'☁️':'⚠️'}</span>
          <div>
            <div style={{fontSize:12,fontWeight:600,color:_supabaseRef?'#22c55e':'#ef4444'}}>{_supabaseRef?'Supabase connecté — Backup cloud actif':'Supabase non connecté — Backup local uniquement'}</div>
            <div style={{fontSize:10,color:'#888'}}>Auto-backup toutes les 5 minutes {_supabaseRef?'(local + cloud)':'(local uniquement)'}</div>
          </div>
        </div>

        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:20}}>
          {/* Local */}
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(34,197,94,.2)',borderRadius:14}}>
            <div style={{fontSize:15,fontWeight:600,color:'#22c55e',marginBottom:4}}>📥 Backup Local (JSON)</div>
            <div style={{fontSize:11,color:'#888',marginBottom:14}}>Télécharge un fichier sur ton PC</div>
            <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
              <button onClick={()=>{const name=exportBackup(s);logAction('Backup Local',name,1);if(typeof addToast==='function')addToast('Backup local: '+name);}} style={{padding:'10px 16px',borderRadius:10,border:'none',background:'#22c55e',color:'#fff',fontWeight:600,fontSize:11,cursor:'pointer'}}>📥 Exporter</button>
              <label style={{padding:'10px 16px',borderRadius:10,border:'none',background:'#3b82f6',color:'#fff',fontWeight:600,fontSize:11,cursor:'pointer',display:'inline-block'}}>📤 Importer
                <input type="file" accept=".json" style={{display:'none'}} onChange={async(e)=>{
                  const file=e.target.files[0];if(!file)return;
                  try{const r=await importBackup(file,d);logAction('Restore Local',r.emps+' employés',r.emps);if(typeof addToast==='function')addToast('Restauré: '+r.emps+' employés');}
                  catch(err){alert('❌ '+err);}e.target.value='';
                }}/>
              </label>
            </div>
          </div>
          {/* Cloud */}
          <div style={{padding:20,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid rgba(168,85,247,.2)',borderRadius:14}}>
            <div style={{fontSize:15,fontWeight:600,color:'#a855f7',marginBottom:4}}>☁️ Backup Cloud (Supabase)</div>
            <div style={{fontSize:11,color:'#888',marginBottom:14}}>{_supabaseRef?'Sauvegarde sécurisée en ligne':'Connectez Supabase pour activer'}</div>
            <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
              <button onClick={async()=>{const r=await cloudBackupSave(s);if(r.ok){logAction('Backup Cloud','Sauvegarde Supabase',emps.length);if(typeof addToast==='function')addToast('☁️ '+r.msg);}else{alert('❌ '+r.msg);}}} style={{padding:'10px 16px',borderRadius:10,border:'none',background:_supabaseRef?'#a855f7':'#555',color:'#fff',fontWeight:600,fontSize:11,cursor:_supabaseRef?'pointer':'not-allowed',opacity:_supabaseRef?1:.5}}>☁️ Sauvegarder</button>
              <button onClick={async()=>{const list=await cloudBackupList();if(list.length===0){alert('Aucun backup cloud trouvé');return;}const msg=list.slice(0,5).map((b,i)=>(i+1)+'. '+new Date(b.created_at).toLocaleString('fr-BE')+' ('+b.emps_count+' emp)').join('\n');const idx=prompt('Quel backup restaurer ?\n\n'+msg+'\n\nEntrez le numéro (1-'+Math.min(list.length,5)+'):');if(!idx)return;const bi=parseInt(idx)-1;if(bi>=0&&bi<list.length){const r=await cloudBackupRestore(list[bi].id,d);if(r.ok){logAction('Restore Cloud',r.emps+' employés',r.emps);if(typeof addToast==='function')addToast('☁️ Restauré: '+r.emps+' employés');}else{alert('❌ '+r.msg);}}}} style={{padding:'10px 16px',borderRadius:10,border:'none',background:_supabaseRef?'#6366f1':'#555',color:'#fff',fontWeight:600,fontSize:11,cursor:_supabaseRef?'pointer':'not-allowed',opacity:_supabaseRef?1:.5}}>🔄 Restaurer</button>
            </div>
          </div>
        </div>

        {/* Auto-backup Status */}
        <div style={{padding:16,background:'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12,marginBottom:16}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
            <h4 style={{fontSize:13,fontWeight:600,color:'#c6a34e'}}>🔄 Auto-Backup Status</h4>
            <span style={{fontSize:10,color:'#22c55e',fontWeight:600}}>● Actif (5 min)</span>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
            <div style={{padding:12,background:'rgba(34,197,94,.06)',borderRadius:10}}>
              <div style={{fontSize:11,color:'#888',marginBottom:2}}>Local (navigateur)</div>
              <div style={{fontSize:12,fontWeight:600,color:'#22c55e'}}>{safeLS.get('aureus_autobackup_date')?new Date(safeLS.get('aureus_autobackup_date')).toLocaleString('fr-BE'):'Aucun'}</div>
            </div>
            <div style={{padding:12,background:'rgba(168,85,247,.06)',borderRadius:10}}>
              <div style={{fontSize:11,color:'#888',marginBottom:2}}>Cloud (Supabase)</div>
              <div style={{fontSize:12,fontWeight:600,color:_supabaseRef?'#a855f7':'#666'}}>{_supabaseRef?'Synchronisé':'Non connecté'}</div>
            </div>
          </div>
        </div>

        {/* Data Summary */}
        <div style={{padding:16,background:'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}>
          <h4 style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>📊 Données actuelles</h4>
          <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:10}}>
            {[{l:'Employés',v:emps.length,c:'#c6a34e'},{l:'Fiches paie',v:(s.pays||[]).length,c:'#3b82f6'},{l:'Clients',v:(s.clients||[]).length,c:'#a855f7'},{l:'Société',v:co.name?'✅':'❌',c:co.name?'#22c55e':'#ef4444'},{l:'Taille',v:Math.round(JSON.stringify(s).length/1024)+' KB',c:'#888'}].map((k,i)=>
              <div key={i} style={{textAlign:'center',padding:10,background:'rgba(255,255,255,.02)',borderRadius:10}}>
                <div style={{fontSize:18,fontWeight:700,color:k.c}}>{k.v}</div>
                <div style={{fontSize:9,color:'#888'}}>{k.l}</div>
              </div>)}
          </div>
        </div>
      </div>}

      
      {/* TAB: Multi-User */}
      {autoTab==='multiuser'&&<div>
        <h3 style={{fontSize:16,fontWeight:600,color:'#e5e5e5',marginBottom:14}}>👥 Gestion Multi-Utilisateur</h3>
        
        {/* Online Now */}
        <div style={{marginBottom:20,padding:16,background:'linear-gradient(135deg,rgba(34,197,94,.06),rgba(34,197,94,.02))',border:'1px solid rgba(34,197,94,.15)',borderRadius:12}}>
          <div style={{fontSize:13,fontWeight:600,color:'#22c55e',marginBottom:10}}>🟢 Utilisateurs en Ligne</div>
          {(window._onlineUsers||[]).length===0?
            <div style={{fontSize:12,color:'#888',padding:10}}>Vous êtes le seul utilisateur connecté</div>:
            <div style={{display:'grid',gap:8}}>
              {(window._onlineUsers||[]).map((u,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:12,padding:'10px 14px',background:'rgba(255,255,255,.02)',borderRadius:10}}>
                <div style={{width:36,height:36,borderRadius:'50%',background:'linear-gradient(135deg,#c6a34e,#d4af37)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,fontWeight:700,color:'#000'}}>{(u.email||'?')[0].toUpperCase()}</div>
                <div style={{flex:1}}>
                  <div style={{fontSize:12,fontWeight:500,color:'#e5e5e5'}}>{u.email}</div>
                  <div style={{fontSize:10,color:'#888'}}>Page: {u.page||'dashboard'} • {ROLES[u.role]||'Admin'}</div>
                </div>
                <span style={{width:8,height:8,borderRadius:'50%',background:'#22c55e'}}/>
              </div>)}
            </div>}
        </div>

        {/* Roles */}
        <div style={{marginBottom:20}}>
          <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>🔐 Rôles & Permissions</div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12}}>
            {[
              {role:'admin',label:'Admin',icon:'👑',color:'#c6a34e',perms:['Tout voir','Tout modifier','Gérer utilisateurs','Supprimer données','Export/Import','Paramètres']},
              {role:'gestionnaire',label:'Gestionnaire',icon:'📋',color:'#3b82f6',perms:['Voir employés','Modifier fiches','Générer documents','Export PDF/XML','Pas de suppression']},
              {role:'readonly',label:'Lecture seule',icon:'👁',color:'#888',perms:['Voir tableau de bord','Voir employés','Voir fiches','Pas de modification','Pas d\'export']}
            ].map((r,i)=><div key={i} style={{padding:16,background:'linear-gradient(135deg,#0d1117,#131820)',border:'1px solid '+r.color+'30',borderRadius:14}}>
              <div style={{fontSize:24,textAlign:'center',marginBottom:6}}>{r.icon}</div>
              <div style={{fontSize:14,fontWeight:600,color:r.color,textAlign:'center',marginBottom:8}}>{r.label}</div>
              {r.perms.map((p,j)=><div key={j} style={{fontSize:10,color:'#888',padding:'3px 0',display:'flex',alignItems:'center',gap:6}}>
                <span style={{color:p.startsWith('Pas')?'#ef4444':'#22c55e',fontSize:8}}>●</span>{p}
              </div>)}
            </div>)}
          </div>
        </div>

        {/* Sync Status */}
        <div style={{marginBottom:20,padding:16,background:'rgba(168,85,247,.04)',border:'1px solid rgba(168,85,247,.15)',borderRadius:12}}>
          <div style={{fontSize:13,fontWeight:600,color:'#a855f7',marginBottom:10}}>🔄 Synchronisation Temps Réel</div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12}}>
            <div style={{padding:12,background:'rgba(34,197,94,.06)',borderRadius:10,textAlign:'center'}}>
              <div style={{fontSize:16,fontWeight:700,color:_supabaseRef?'#22c55e':'#ef4444'}}>{_supabaseRef?'✅':'❌'}</div>
              <div style={{fontSize:10,color:'#888',marginTop:2}}>Supabase</div>
            </div>
            <div style={{padding:12,background:'rgba(59,130,246,.06)',borderRadius:10,textAlign:'center'}}>
              <div style={{fontSize:16,fontWeight:700,color:_realtimeChannel?'#3b82f6':'#666'}}>{_realtimeChannel?'✅':'⏳'}</div>
              <div style={{fontSize:10,color:'#888',marginTop:2}}>Realtime</div>
            </div>
            <div style={{padding:12,background:'rgba(198,163,78,.06)',borderRadius:10,textAlign:'center'}}>
              <div style={{fontSize:16,fontWeight:700,color:_presenceChannel?'#c6a34e':'#666'}}>{_presenceChannel?'✅':'⏳'}</div>
              <div style={{fontSize:10,color:'#888',marginTop:2}}>Presence</div>
            </div>
          </div>
          <div style={{marginTop:10,fontSize:11,color:'#888'}}>
            Quand un autre utilisateur modifie des données, vous recevez automatiquement la mise à jour. Pas besoin de rafraîchir la page.
          </div>
        </div>

        {/* How to invite */}
        <div style={{padding:16,background:'rgba(198,163,78,.04)',border:'1px solid rgba(198,163,78,.1)',borderRadius:12}}>
          <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:8}}>📨 Inviter un Collaborateur</div>
          <div style={{fontSize:11,color:'#888',lineHeight:1.6}}>
            Pour ajouter un collaborateur :<br/>
            1. Il crée un compte sur aureussocial.be (même page de login)<br/>
            2. Les données sont synchronisées automatiquement via Supabase<br/>
            3. Tous les changements sont visibles en temps réel<br/>
            4. Le backup cloud est partagé entre tous les utilisateurs
          </div>
        </div>
      </div>}

{/* Footer */}
      <div style={{marginTop:32,textAlign:'center',padding:16,borderTop:'1px solid rgba(198,163,78,.1)'}}>
        <div style={{fontSize:11,color:'#666'}}>Aureus Social Pro v39 — Sprint 49 — Sprint 17c Automatisation — {emps.length} employé(s) • {curMonth} {curYear}</div>
        <div style={{fontSize:10,color:'#444',marginTop:4}}>Tous les documents sont générés localement. Aucune donnée n'est envoyée à un serveur externe.</div>
      </div>
    </div>;
  };

  


  

const pg=()=>{
    switch(s.page){
      case'dashboard':return <Dashboard s={s} d={d} userRole={userRole}/>;
      case'employees':return <Employees s={s} d={d}/>;
      case'payslip':return <Payslips s={s} d={d}/>;
      case'onss':return s.sub==='dmfa'?<DMFAPage s={s} d={d}/>:s.sub==='drs'?<DRSModLazy s={s} d={d}/>:s.sub==='onssapl'?<ONSSAPLModLazy s={s} d={d}/>:s.sub==='onss_dash'?<ONSSDashModLazy s={s} d={d}/>:s.sub==='guide_portail'?<GuidePortailModLazy s={s} d={d}/>:s.sub==='portail_employeur'?<PortailEmployeurModLazy s={s} d={d}/>:<DimonaPage s={s} d={d}/>;
      case'fiscal':return s.sub==='precompte'?<PrecomptePage s={s} d={d}/>:s.sub==='baremespp'?<PrecomptePage s={s} d={d}/>:s.sub==='fiches_ext'?<FichesModLazy s={s} d={d}/>:s.sub==='co2'?<CO2ModLazy s={s} d={d}/>:s.sub==='atn'?<ATNModLazy s={s} d={d}/>:<BelcotaxPage s={s} d={d}/>;
      case'salaires':return <SalairesPage s={s} d={d}/>;
      case'avantages':return <AvantagesPage s={s} d={d}/>;
      case'contratsmenu':return <ContratsMenuPage s={s} d={d}/>;
      case'rh':return <RHPage s={s} d={d}/>;
      case'social':return <SocialPage s={s} d={d}/>;
      case'bienetre':return <Dashboard s={s} d={d} userRole={userRole}/>;
      case'reporting':return <ReportingPage s={s} d={d}/>;
      case'legal':return <LegalPage s={s} d={d}/>;
      case'aureussuite':case'ia_turnover':case'ia_salaire':case'ia_anomalies':case'what_if':case'kpi_dashboard':return <AureusSuitePageLazy s={s} d={d}/>;
      case'documents':return <DocsPage s={s} d={d}/>;
      case'reports':return <ReportsPage s={s} d={d}/>;
      case'settings':return s.sub==='fraisgestion'?<FraisGestionModLazy s={s} d={d}/>:<SettingsPage s={s} d={d}/>;
      case'admin':if(s.sub==='audit')return <AuditModLazy s={s} d={d}/>;if(s.sub==='config')return <SettingsPage s={s} d={d}/>;if(s.sub==='fraisgestion')return <FraisGestionModLazy s={s} d={d}/>;if(s.sub==='gestionacces')return <AccessManagement supabase={supabase}/>;if(s.sub==='commissions'){const _cls=s.clients||[];const _fcts=_cls.map((cl,i)=>{const emps=(cl.emps||[]).length;const htva=emps*25;const tvaAmt=Math.round(htva*21/100*100)/100;const ttc=Math.round((htva+tvaAmt)*100)/100;const m=new Date().getMonth(),y=new Date().getFullYear();return{id:'FACT-'+y+'-'+(m+1+'').padStart(2,'0')+'-'+(i+1+'').padStart(3,'0'),client:cl.company?.name||'Client '+(i+1),clientId:cl.id||'cl_'+i,clientEmail:cl.company?.email||'',montant:ttc,ttc,echeance:new Date(y,m,15).toISOString(),status:cl._paidStatus||'pending'};});return <CommissionsModule userRole={userRole} user={user} factures={_fcts} sendEmailFn={sendEmailReal}/>};if(s.sub==='relances'){const _cls2=s.clients||[];const _fcts2=_cls2.map((cl,i)=>{const emps=(cl.emps||[]).length;const htva=emps*25;const tvaAmt=Math.round(htva*21/100*100)/100;const ttc=Math.round((htva+tvaAmt)*100)/100;const m=new Date().getMonth(),y=new Date().getFullYear();return{id:'FACT-'+y+'-'+(m+1+'').padStart(2,'0')+'-'+(i+1+'').padStart(3,'0'),client:cl.company?.name||'Client '+(i+1),clientId:cl.id||'cl_'+i,clientEmail:cl.company?.email||'',montant:ttc,ttc,echeance:new Date(y,m,15).toISOString(),status:cl._paidStatus||'pending'};});return <CommissionsModule userRole={userRole} user={user} factures={_fcts2} sendEmailFn={sendEmailReal} defaultTab="relances"/>};if(s.sub==='authroles')return <AuthMultiRolesLazy s={s} d={d}/>;if(s.sub==='admin_billing')return <AdminDashboard s={s} d={d}/>;return <AdminDashboard s={s} d={d}/>;
      case'modules':return <ModulesProPage s={s} d={d}/>;
      case'sprint9':return <ModulesProPage s={s} d={d}/>;
      case'automatisation':return <AutomationHubLazy s={s} d={d}/>;
      case'massengine':return <MassEngineLazy s={s} d={d}/>;
      case'smartauto':return <SmartAutomationLazy s={s} d={d} supabase={supabase} user={user}/>;
      case'autopilot':return <SmartAutopilotLazy s={s} d={d}/>;
      case'facturation':return <FacturationTarifLazy s={s} d={d}/>;
      case'validation':return <ValidationEngineLazy s={s} d={d}/>;
      case'exportbatch':return <ExportImportModLazy s={s} d={d}/>;
      case'rgpd':return <RGPDManagerLazy s={s} d={d}/>;
      case'importcsv':return <ExportImportModLazy s={s} d={d}/>;
      case'landing':return <LandingPageLazy/>;
      case'notifcenter':return <AlertesLegalesModLazy s={s} d={d}/>;
      case'journal':return <JournalActiviteLazy s={s} d={d}/>;
      case'baremescp':return <SecteursModLazy s={s} d={d}/>;
      case'onboarding2':return <SetupWizardLazy s={s} d={d} setPage={setPage}/>;
      case'contratgen':return <ContratGeneratorLazy s={s} d={d} user={user}/>;
      case'recapemployeur':return <RecapEmployeurLazy s={s} d={d} user={user}/>;
      case'envoiMasse':return <EnvoiMasseLazy s={s} d={d} user={user}/>;
      case'planabs':return <AbsencesModLazy s={s} d={d}/>;
      case'dashrh':return <KPIDashboardModLazy s={s} d={d}/>;
      case'budget':return <BudgetPrevLazy s={s} d={d}/>;
      case'vehiculesatn':return <GestionVehiculesLazy s={s} d={d}/>;
      case'simupension':return <RCCModLazy s={s} d={d}/>;
      case'ccts':return <ConventionsCollectivesLazy/>;
      case'interimaires':return <ContratsTravailModLazy s={s} d={d}/>;
      case'ged':return <DocumentsJuridiquesModLazy s={s} d={d}/>;
      case'portail':return <PortailEmployeLazy s={s} d={d}/>;
      case'dashclient':return <Dashboard s={s} d={d}/>;
      case'comparateur':return <StatsINSModLazy s={s} d={d}/>;
      case'analytics':return <AnalyticsDashLazy s={s} d={d}/>;
      case'exportcompta':return <AccountingOutputModLazy s={s} d={d}/>;
      case'audittrail':return <AuditTrailLazy s={s} d={d} user={user}/>;
      case'simembauche':return <PromesseEmbaucheLazy s={s} d={d}/>;
      case'echeancier':return <EcheancierPaiementsLazy s={s} d={d}/>;
      case'simutp':return <CreditTempsModLazy s={s} d={d}/>;
      case'delegations':return <OrganesModLazy s={s} d={d}/>;
      case'chargessociales':return <PrevisionMasseModLazy s={s} d={d}/>;
      case'planifconges':return <AbsencesModLazy s={s} d={d}/>;
      case'registrepersonnel':return <RegistrePersonnelModLazy s={s} d={d}/>;
      case'calcmaladie':return <WorkflowMaladieModLazy s={s} d={d}/>;
      case'coutsannuel':return <PrevisionMasseModLazy s={s} d={d}/>;
      case'gendocsjur':return <DocumentsJuridiquesModLazy s={s} d={d}/>;
      case'dashabsent':return <AbsenteismeModLazy s={s} d={d}/>;
      case'flexijobs':return <SecteursModLazy s={s} d={d}/>;
      case'chomagetemporaire':return <ChomTempModLazy s={s} d={d}/>;
      case'onboardwizard':return <OnboardingWizardLazy s={s} d={d}/>;
      case'checklistclient':return <ChecklistClientLazy s={s} d={d}/>;
      case'comparatif':return <ComparatifConcurrentsLazy/>;
      case'duediligence':return <AuditModLazy s={s} d={d}/>;
      case'authroles':return <AuthMultiRolesLazy s={s} d={d}/>;
      case'baremespp':return <PrecomptePage s={s} d={d}/>;
      case'moteurlois':return <MoteurLoisBelges s={s} d={d}/>;
      case'securitedata':return <SecuriteDataLazy s={s} d={d}/>;
      case'monitoring':return <MonitoringSanteLazy s={s} d={d}/>;
      case'testsuite':return <TestSuiteDashLazy s={s} d={d}/>;
      case'gestionprimes':return <GestionPrimesLazy s={s} d={d}/>;
      case'promesseembauche':return <PromesseEmbaucheLazy s={s} d={d}/>;
      case'tbdirection':return <TableauBordDirectionLazy s={s} d={d}/>;
      case'archives':return <ArchivesNumeriquesLazy s={s} d={d}/>;
      case'optifiscale':return <SimuOptiFiscaleLazy s={s} d={d}/>;
      case'gestionabs':return <AbsencesModLazy s={s} d={d}/>;
      case'formationsec':return <PlanFormationModLazy s={s} d={d}/>;
      case'bilansocial':return <BilanSocialBNBModLazy s={s} d={d}/>;
      case'absencespro':return <AbsencesModLazy s={s} d={d}/>;
      case'exportcomptapro':return <AccountingOutputModLazy s={s} d={d}/>;
      case'tableaudirection':return <TableauDirectionLazy s={s} d={d}/>;
      case'primecalc':return <GestionPrimesLazy s={s} d={d}/>;
      case'portailclient':return <PortailClientSSLazy s={s} d={d}/>;
      case'reportingpro':return <KPIDashboardModLazy s={s} d={d}/>;
      case'integrations':return <IntegrationsHubLazy s={s} d={d} supabase={supabase}/>;
      case'fiduciaire':return <Dashboard s={s} d={d}/>;
      case'simulicenciement':return <OffboardingModLazy s={s} d={d}/>;
      case'couttotal':return <PrevisionMasseModLazy s={s} d={d}/>;
      case'timeline':return <PayrollTimelineLazy s={s} d={d}/>;
      case'sepa':return <SEPAModLazy s={s} d={d}/>;
      case'smartalerts':return <SmartAlertsLazy s={s} d={d}/>;
      case'batchdecl':return <EnvoiModLazy s={s} d={d}/>;
      case'compliance':return <AuditModLazy s={s} d={d}/>;
      case'auditsecuritecode':return <AuditSecuriteCodeLazy s={s} d={d}/>;
      case'autoindex':return <AutoIndexationLazy s={s} d={d}/>;
      case'historique':return <HistoriquePiloteLazy s={s} d={d} supabase={supabase}/>;
      case'piloteauto':return <PiloteAutoLazy s={s} d={d} supabase={supabase} user={user}/>;
      case'calcinstant':return <NetBrutModLazy s={s} d={d}/>;
      case'calendrier':return <CalendrierSocialLazy s={s} d={d}/>;
      case'rapports':return <KPIDashboardModLazy s={s} d={d}/>;
      case'actionsrapides':return <ActionsRapidesLazy s={s} d={d}/>;
      case'cloture':return <ClotureMensuelleLazy s={s} d={d} supabase={supabase} user={user}/>;
      case'notifications':return <AlertesLegalesModLazy s={s} d={d}/>;
      case'commandcenter':return <CommandCenterLazy s={s} d={d}/>;
      case'queue':return <ProcessingQueueLazy s={s} d={d}/>;
      case'onboarding':return <OnboardingWizardLazy s={s} d={d}/>;
      case'portalmanager':return <PortalManagerLazy s={s} d={d} supabase={supabase}/>;
      case'team':return <TeamManagement supabase={supabase} user={user} userRole={userRole}/>;
      case'joursPrestes':return <CalcJoursPrestesLazy s={s} d={d}/>;
      case'workflowAbs':return <WorkflowAbsencesLazy s={s} d={d}/>;
      case'regulPP':return <RegulPPAnnuelleLazy s={s} d={d}/>;
      case'exportWinbooks':return <ExportWinbooksLazy s={s} d={d}/>;
      case'parserConcurrent':return <ParserImportConcurrentLazy s={s} d={d}/>;
      case'aidesemploi':return <AidesEmploiModLazy s={s} d={d}/>;
      case'alcool':return <AlcoolModLazy s={s} d={d}/>;
      case'elections':return <ElectionsModLazy s={s} d={d}/>;
      case'paa':return <PAAModLazy s={s} d={d}/>;
      case'planglobal':return <PlanGlobalModLazy s={s} d={d}/>;
      case'regulpp2':return <RegularisationPPLazy s={s} d={d}/>;
      case'risquespsycho':return <RisquesPsychoModLazy s={s} d={d}/>;
      case'compteIndividuel':return <CompteIndividuelAnnuelLazy s={s} d={d}/>;
      case'formC4':return <FormulaireC4Lazy s={s} d={d}/>;
      case'formC131':return <FormulaireC131Lazy s={s} d={d}/>;
      case'accidentTravail':return <FormulaireAccidentTravailLazy s={s} d={d}/>;
      case'annexeReglement':return <AnnexeReglementTravailLazy s={s} d={d}/>;
      case'belcotax281':return <Belcotax281ModLazy s={s} d={d}/>;
      case'proceduresrh':return <ProceduresRHHub/>;
      case'adminbaremes':return <AdminBaremes loisBelges={LOIS_BELGES} loisTimeline={[]} loisCurrent={LOIS_BELGES} onUpdate={()=>{}}/>;
      case'soldetoutcompte':return <OffboardingModLazy s={s} d={d}/>;
      case'declarations':return <EnvoiModLazy s={s} d={d}/>;
      case'repriseclient':return <ParserImportConcurrentLazy s={s} d={d}/>;
      default:return <Dashboard s={s} d={d}/>;
    }
  };

  // Client Portal - show dedicated UI for client role
  if(userRole==='client') return <PortailClientSSLazy s={s} d={d} supabase={supabase} user={user} clientData={s.clients?.find(c=>c.company?.email===user?.email)||s.clients?.[0]||{}}/>;

  return (
    <div data-theme={theme} style={{minHeight:'100vh',background:T.bg,color:isDark?'#d4d0c8':'#333',fontFamily:`'Outfit','DM Sans',system-ui,sans-serif`,display:'flex',transition:'background .3s,color .3s'}}>
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Cormorant+Garamond:wght@500;600;700&display=swap" rel="stylesheet"/>
      <style>{`
        *{box-sizing:border-box}
        ::-webkit-scrollbar{width:6px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:rgba(198,163,78,.15);border-radius:3px}
        [data-theme="light"] .aureus-main{background:#f5f3ee!important;color:#1a1a1a!important}
        [data-theme="light"] .aureus-main div,[data-theme="light"] .aureus-main span,[data-theme="light"] .aureus-main p,[data-theme="light"] .aureus-main td,[data-theme="light"] .aureus-main th,[data-theme="light"] .aureus-main label{color:inherit}
        [data-theme="light"] .aureus-main h1,[data-theme="light"] .aureus-main h2,[data-theme="light"] .aureus-main h3{color:#1a1a1a!important}
        [data-theme="light"] .aureus-main [style*="color: rgb(232, 230, 224)"],[data-theme="light"] .aureus-main [style*="color:#e8e6e0"]{color:#1a1a1a!important}
        [data-theme="light"] .aureus-main [style*="background: rgba(255, 255, 255, 0.02)"],[data-theme="light"] .aureus-main [style*="background:rgba(255,255,255,.02)"]{background:rgba(0,0,0,.03)!important}
        [data-theme="light"] .aureus-main [style*="background: rgba(198, 163, 78, 0.04)"],[data-theme="light"] .aureus-main [style*="background:rgba(198,163,78,.04)"]{background:rgba(198,163,78,.08)!important}
        [data-theme="light"] .aureus-main [style*="border: 1px solid rgba(255, 255, 255"],[data-theme="light"] .aureus-main [style*="border:1px solid rgba(255,255,255"]{border-color:rgba(0,0,0,.1)!important}
        [data-theme="light"] .aureus-main [style*="border-bottom: 1px solid rgba(255, 255, 255"],[data-theme="light"] .aureus-main [style*="borderBottom:\"1px solid rgba(255,255,255"]{border-bottom-color:rgba(0,0,0,.08)!important}
        [data-theme="light"] .aureus-main [style*="color: rgb(94, 92, 86)"],[data-theme="light"] .aureus-main [style*="color:#5e5c56"]{color:#888!important}
        [data-theme="light"] .aureus-main [style*="color: rgb(158, 155, 147)"],[data-theme="light"] .aureus-main [style*="color:#9e9b93"]{color:#555!important}
        [data-theme="light"] .aureus-main input,[data-theme="light"] .aureus-main select,[data-theme="light"] .aureus-main textarea{background:#fff!important;color:#1a1a1a!important;border-color:rgba(0,0,0,.15)!important}
        [data-theme="light"] .aureus-main table{background:#fff}
        [data-theme="light"] .aureus-main button{transition:all .15s}
        [data-theme="light"]{scrollbar-color:rgba(198,163,78,.25) #f5f3ee}
        ::-webkit-scrollbar-thumb:hover{background:rgba(198,163,78,.25)}
        @keyframes fadeInPage{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
        input:focus,select:focus{border-color:rgba(198,163,78,.3)!important;outline:none}
        button{transition:all .12s ease}
      `}</style>
      
      {/* SIDEBAR */}
      <style dangerouslySetInnerHTML={{__html:`@media print{aside,.no-print,nav,button,[class*="no-print"]{display:none!important;visibility:hidden!important}main{margin-left:0!important;padding:10px!important}[data-payslip]{box-shadow:none!important;border-radius:0!important;padding:20px!important}body,html{background:#fff!important}}
@media(max-width:899px){
  .aureus-aside{transform:translateX(-100%)!important;width:280px!important}
  .aureus-aside.open{transform:translateX(0)!important}
  .aureus-main{margin-left:0!important;padding:12px 8px!important}
  .aureus-overlay{display:block!important}
  .aureus-hamburger{display:flex!important}
  div[style*="grid-template-columns"][style*="repeat(4"]{grid-template-columns:repeat(2,1fr)!important}
  div[style*="grid-template-columns"][style*="repeat(5"]{grid-template-columns:repeat(2,1fr)!important}
  div[style*="grid-template-columns"][style*="repeat(6"]{grid-template-columns:repeat(2,1fr)!important}
  div[style*="grid-template-columns"][style*="repeat(3"]{grid-template-columns:1fr 1fr!important}
  div[style*="grid-template-columns"][style*="340px"]{grid-template-columns:1fr!important}
  div[style*="grid-template-columns"][style*="300px"]{grid-template-columns:1fr!important}
  div[style*="grid-template-columns"][style*="280px"]{grid-template-columns:1fr!important}
  div[style*="overflow-x"]{overflow-x:auto!important;-webkit-overflow-scrolling:touch!important}
  table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;white-space:nowrap}
  h2{font-size:18px!important}
  div[style*="padding: 24px"],div[style*="padding:24"]{padding:12px!important}
}
@media(max-width:599px){
  div[style*="grid-template-columns"][style*="repeat(3"]{grid-template-columns:1fr!important}
  div[style*="grid-template-columns"][style*="repeat(2"]{grid-template-columns:1fr!important}
  div[style*="grid-template-columns"][style*="repeat(4"]{grid-template-columns:1fr!important}
}
@media(min-width:900px){
  .aureus-aside{transform:translateX(0)!important}
  .aureus-overlay{display:none!important}
  .aureus-hamburger{display:none!important}
}`}}/>
      {/* Mobile overlay */}
      {isMobile&&mobileMenu&&<div className="aureus-overlay" onClick={()=>setMobileMenu(false)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.6)',zIndex:99,display:'block'}}/>}
      {/* Mobile hamburger */}
      {isMobile&&<div className="aureus-hamburger" onClick={()=>setMobileMenu(!mobileMenu)} style={{position:'fixed',top:12,left:12,zIndex:150,width:40,height:40,borderRadius:10,background:'linear-gradient(135deg,#c6a34e,#a07d3e)',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',boxShadow:'0 4px 15px rgba(198,163,78,.3)'}}>
        <div style={{display:'flex',flexDirection:'column',gap:4}}>
          <div style={{width:18,height:2,background:'#060810',borderRadius:1,transition:'all .2s',transform:mobileMenu?'rotate(45deg) translate(4px,4px)':''}}/>
          <div style={{width:18,height:2,background:'#060810',borderRadius:1,transition:'all .2s',opacity:mobileMenu?0:1}}/>
          <div style={{width:18,height:2,background:'#060810',borderRadius:1,transition:'all .2s',transform:mobileMenu?'rotate(-45deg) translate(4px,-4px)':''}}/>
        </div>
      </div>}
      <aside className={"no-print aureus-aside"+(mobileMenu?" open":"")} style={{width:268,background:"linear-gradient(180deg,#080b14,#060810)",borderRight:'1px solid rgba(139,115,60,.1)',position:'fixed',top:0,left:0,bottom:0,display:'flex',flexDirection:'column',zIndex:100,boxShadow:'4px 0 30px rgba(0,0,0,.4)',transition:'transform .25s ease'}}>
        <div style={{padding:'24px 20px 16px',borderBottom:'1px solid rgba(139,115,60,.1)'}}>
          <div style={{display:'flex',alignItems:'center',gap:10}}>
            <div style={{width:36,height:36,borderRadius:10,background:"linear-gradient(135deg,#c6a34e,#a68a3c)",display:'flex',alignItems:'center',justifyContent:'center',fontSize:16,fontWeight:800,color:'#060810',fontFamily:"'Cormorant Garamond',serif"}}>A</div>
            <div>
              <div style={{fontFamily:"'Cormorant Garamond',Georgia,serif",fontSize:20,fontWeight:700,background:"linear-gradient(135deg,#c6a34e,#e2c878,#c6a34e)",WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',lineHeight:1.1}}>AUREUS SOCIAL</div>
              <div style={{fontSize:9,color:'#8b7340',letterSpacing:'3px',textTransform:'uppercase',fontWeight:500}}>{t('app.subtitle')}</div>
            </div>
          </div>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginTop:10}}>
            <LangSwitch/>
            <span style={{fontSize:8.5,padding:'2px 8px',borderRadius:4,background:"rgba(198,163,78,.08)",color:'#8b7340',fontWeight:600,letterSpacing:'.5px'}}>{AUREUS_INFO.version}</span>
          </div>
          {s.activeClient&&<div style={{marginTop:10,padding:'10px 12px',background:"linear-gradient(135deg,rgba(198,163,78,.06),rgba(198,163,78,.02))",borderRadius:10,border:'1px solid rgba(198,163,78,.12)'}}>
            <div style={{fontSize:11.5,fontWeight:600,color:'#c6a34e'}}>{s.co.name||'Client'}</div>
            <div style={{fontSize:9.5,color:'#8b7340',marginTop:2}}>{s.co.vat} {s.co.cp?`· CP ${s.co.cp}`:''}</div>
          </div>}
          <button onClick={()=>d({type:"BACK_TO_CLIENTS"})} style={{width:'100%',marginTop:8,padding:'7px',background:"rgba(96,165,250,.04)",border:'1px solid rgba(96,165,250,.08)',borderRadius:6,color:'#60a5fa',fontSize:10.5,cursor:'pointer',fontFamily:'inherit',transition:'all .15s'}}
            onMouseEnter={e=>{e.currentTarget.style.background='rgba(96,165,250,.1)';}}
            onMouseLeave={e=>{e.currentTarget.style.background='rgba(96,165,250,.04)';}}>{t('nav.back')}</button>
          <div id="spot-container" style={{position:'relative',marginTop:8}}>
            <input ref={spotRef} value={spotQ} onChange={e=>{setSpotQ(e.target.value);setSpotOpen(true);}}
              onFocus={()=>setSpotOpen(true)}
              placeholder={t('nav.search')}
              style={{width:'100%',padding:'9px 12px',background:"rgba(198,163,78,.03)",border:'1px solid rgba(198,163,78,.08)',borderRadius:8,color:'#e8e6e0',fontSize:11.5,fontFamily:'inherit',outline:'none',boxSizing:'border-box',transition:'border-color .15s'}}
              onFocus2={e=>{e.currentTarget.style.borderColor='rgba(198,163,78,.3)';}}/>
            {spotOpen&&spotResults.length>0&&<div style={{position:'absolute',top:'100%',left:0,right:0,marginTop:4,background:"#0f1220",border:'1px solid rgba(198,163,78,.2)',borderRadius:10,boxShadow:'0 12px 40px rgba(0,0,0,.6)',zIndex:200,maxHeight:340,overflowY:'auto'}}>
              {spotResults.map((it,i)=><div key={i} onClick={()=>spotNav(it)}
                style={{padding:'10px 14px',cursor:'pointer',borderBottom:'1px solid rgba(198,163,78,.06)',display:'flex',alignItems:'center',gap:10,transition:'background .1s'}}
                onMouseEnter={e=>e.currentTarget.style.background='rgba(198,163,78,.08)'}
                onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
                <span style={{fontSize:14,opacity:.5}}>{it.icon}</span>
                <div>
                  <div style={{fontSize:12,fontWeight:500,color:'#e8e6e0'}}>{it.label}</div>
                  {it.parent&&<div style={{fontSize:10,color:'#8b7340'}}>{it.parent}</div>}
                </div>
              </div>)}
            </div>}
            {spotOpen&&spotQ&&spotResults.length===0&&<div style={{position:'absolute',top:'100%',left:0,right:0,marginTop:4,background:"#0f1220",border:'1px solid rgba(198,163,78,.2)',borderRadius:10,padding:'14px 16px',fontSize:11.5,color:'#5e5c56',textAlign:'center',zIndex:200}}>{t('nav.noresult')}</div>}
          </div>
        </div>
        <nav style={{padding:'8px 8px',flex:1,overflowY:'auto',scrollbarWidth:'thin',scrollbarColor:'rgba(198,163,78,.15) transparent'}}>
          {nav.map((it,idx)=>{
            if(it.grp){
              const isOpen=openGrps[it.id];
              const hasActivePage=nav.some(n=>!n.grp&&n.g===parseInt(it.id.replace('_g',''))&&s.page===n.id);
              return <button key={it.id} onClick={()=>toggleGrp(it.id)} style={{display:'flex',alignItems:'center',gap:8,width:'100%',padding:'12px 16px 8px',border:'none',background:'transparent',cursor:'pointer',borderTop:it.id!=='_g1'?'1px solid rgba(139,115,60,.12)':'none',marginTop:it.id!=='_g1'?4:0,fontFamily:'inherit'}}>
                <span style={{fontSize:12,color:hasActivePage?'#c6a34e':'#8b7340',transition:'transform .2s',transform:isOpen?'rotate(90deg)':'rotate(0deg)'}}>&#9654;</span>
                <span style={{fontSize:it.icon?11:9.5,opacity:.6}}>{it.icon||''}</span>
                <span style={{fontSize:10,fontWeight:700,color:hasActivePage?'#c6a34e':'#8b7340',letterSpacing:'1.2px',textTransform:'uppercase',flex:1,textAlign:'left'}}>{it.l}</span>
              </button>;
            }
            // Find this item's group id
            const grpId='_g'+it.g;
            if(!openGrps[grpId]) return null;
            const ac=s.page===it.id;
            return <div key={it.id}>
              <button onClick={()=>{d({type:"NAV",page:it.id,sub:it.sub?.[0]?.id});setMobileMenu(false);setOpenGrps(prev=>({...prev,['_g'+it.g]:true}));}} style={{display:'flex',alignItems:'center',gap:10,width:'100%',padding:'8px 12px',marginBottom:1,border:'none',borderRadius:8,cursor:'pointer',fontSize:12,fontWeight:ac?600:400,color:ac?'#c6a34e':'#9e9b93',background:ac?'rgba(198,163,78,.08)':'transparent',borderLeft:ac?'2px solid #c6a34e':'2px solid transparent',fontFamily:'inherit',textAlign:'left',transition:'all .12s ease'}}
                onMouseEnter={e=>{if(!ac){e.currentTarget.style.color='#e2c878';e.currentTarget.style.background='rgba(198,163,78,.04)';}}}
                onMouseLeave={e=>{if(!ac){e.currentTarget.style.color='#9e9b93';e.currentTarget.style.background='transparent';}}}
              ><span style={{fontSize:13,opacity:ac?1:.45,transition:'opacity .15s'}}>{it.i}</span>{it.l}</button>
              {ac&&it.sub&&<div style={{paddingLeft:32,marginBottom:2}}>
                {it.sub.map(sb=><button key={sb.id} onClick={()=>{d({type:"NAV",page:it.id,sub:sb.id});setMobileMenu(false);}} style={{display:'block',width:'100%',padding:'5px 12px',border:'none',borderRadius:6,cursor:'pointer',fontSize:11.5,textAlign:'left',fontFamily:'inherit',color:s.sub===sb.id?'#c6a34e':'#5e5c56',background:s.sub===sb.id?'rgba(198,163,78,.06)':'transparent',fontWeight:s.sub===sb.id?500:400,transition:'all .1s'}}
                  onMouseEnter={e=>{if(s.sub!==sb.id)e.currentTarget.style.color='#9e9b93';}}
                  onMouseLeave={e=>{if(s.sub!==sb.id)e.currentTarget.style.color='#5e5c56';}}>{sb.l}</button>)}
              </div>}
            </div>;
          })}
        </nav>
        <div style={{padding:'12px 16px',borderTop:'1px solid rgba(139,115,60,.1)',fontSize:9,color:'#5e5c56'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
            <button onClick={toggleTheme} style={{display:'flex',alignItems:'center',gap:6,padding:'6px 12px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:isDark?'rgba(255,255,255,.03)':'rgba(198,163,78,.1)',color:isDark?'#c6a34e':'#8b6914',fontSize:11,fontWeight:600,cursor:'pointer',fontFamily:'inherit',transition:'all .2s'}}>
              {isDark?'☀️ Mode Jour':'🌙 Mode Nuit'}
            </button>
            <span style={{color:'#8b7340',fontWeight:600,fontSize:9}}>{AUREUS_INFO.version}</span>
          </div>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <span>{s.co.vat||'Aureus IA SPRL'}</span>
            <span style={{color:'#8b7340',fontWeight:600}}>{AUREUS_INFO.sprint}</span>
          </div>
        </div>
      </aside>

      <main className="aureus-main" style={{marginLeft:isMobile?0:268,flex:1,padding:isMobile?'60px 12px 12px':'26px 34px',minHeight:'100vh',animation:'fadeInPage .3s ease',background:T.bg,color:T.text,transition:'background .3s,color .3s'}}>{pg()}</main>

      <ToastContainer/>
      {s.modal&&<div style={{position:'fixed',inset:0,background:"rgba(0,0,0,.75)",backdropFilter:'blur(6px)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000}} onClick={()=>d({type:"MODAL",m:null})}>
        <div onClick={e=>e.stopPropagation()} style={{background:"#0c0f1a",border:'1px solid rgba(139,115,60,.15)',borderRadius:16,padding:28,width:s.modal.w||700,maxHeight:'85vh',overflowY:'auto'}}>{s.modal.c}</div>
      </div>}

      {/* AGENT IA JURIDIQUE — Bouton flottant */}
      <FloatingLegalAgentLazy onAction={(actionData)=>{
        // Execute actions from AI agent
        const{action,data:ad}=actionData;
        if(action==='CREATE_CLIENT'&&ad){
          const newClient={
            id:"CL-"+uid(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),
            company:{name:ad.name||'',vat:ad.vat||'',bce:'',addr:ad.addr||'',onss:ad.onss||'',bank:'',bic:'',
              cp:ad.cp||'200',contact:'',email:'',phone:'',insurer:'',policyNr:'',secSoc:'',nace:'',
              forme:ad.forme||'SRL',activity:ad.activity||''},
            emps:[],pays:[],dims:[],dmfas:[],fiches:[],docs:[]
          };
          d({type:'ADD_CLIENT',d:newClient});
        }
        if(action==='CREATE_WORKER'&&ad){
          d({type:'ADD_E',d:{
            nom:ad.nom||'',prenom:ad.prenom||'',niss:ad.niss||'',
            sexe:ad.sexe||'',dateNaissance:ad.dateNaissance||'',
            adresse:ad.adresse||'',cp:ad.cp||'',ville:ad.ville||'',
            fonction:ad.fonction||'',departement:ad.departement||'',
            contrat:ad.contrat||'cdi',regime:ad.regime||'full',statut:ad.statut||'employe',
            salaireBrut:parseFloat(ad.salaireBrut)||0,
            dateEntree:ad.dateEntree||new Date().toISOString().slice(0,10),dateSortie:'',
            iban:ad.iban||'',etatCivil:ad.etatCivil||'isole',enfants:ad.enfants||0,
            heuresSup:0,heuresDim:0,heuresNuit:0,heuresSupFisc:0,hsVolontBrutNet:0,hsRelance:0,
            prime:0,y13:false,avance:0,chequesRepas:true,ecoChq:true,
            transport:'domicile_travail',distKm:0,fraisEmployeur:0,
            pensionCompl:0,pensionComplEmpl:0,actif:true,
          }});
        }
        if(action==='UPDATE_WORKER'&&ad){
          const emp=(s.emps||[]).find(e=>(e.prenom||'').toLowerCase().includes((ad.search||'').toLowerCase())||(e.nom||'').toLowerCase().includes((ad.search||'').toLowerCase()));
          if(emp){
            const updated={...emp};
            if(ad.field&&ad.operation==='add')updated[ad.field]=(parseFloat(updated[ad.field])||0)+parseFloat(ad.value||0);
            else if(ad.field&&ad.operation==='set')updated[ad.field]=ad.value;
            else if(ad.field)updated[ad.field]=ad.value;
            d({type:'UPD_E',d:updated});
          }
        }
        if(action==='DELETE_WORKER'&&ad){
          const emp=(s.emps||[]).find(e=>(e.prenom||'').toLowerCase().includes((ad.search||'').toLowerCase())||(e.nom||'').toLowerCase().includes((ad.search||'').toLowerCase()));
          if(emp)d({type:'UPD_E',d:{...emp,dateSortie:ad.dateSortie||new Date().toISOString().slice(0,10),actif:false}});
        }
        // Log to audit
        (async()=>{try{const{supabase}=await import('./lib/supabase');if(supabase)await supabase.from('audit_log').insert({action:'agent_execute_'+action,table_name:'agent_ia',details:ad});}catch(e){}})();
      }}/>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════
//  DASHBOARD
// ═══════════════════════════════════════════════════════════════
function Dashboard({s,d}) {
  const ae=(s.emps||[]).filter(e=>e.status==='active'||!e.status||e.status===undefined);
  const sortie=(s.emps||[]).filter(e=>e.status==='sorti');
  const etudiants=(s.emps||[]).filter(e=>e.contract==='student');
  const tm=ae.reduce((a,e)=>a+(e.monthlySalary||0),0);
  const calcs=ae.map(e=>({e,c:calc(e,DPER,s.co)}));
  const tc=calcs.reduce((a,x)=>a+x.c.costTotal,0);
  const tn=calcs.reduce((a,x)=>a+x.c.net,0);
  const avgGross=ae.length?tm/ae.length:0;
  const now=new Date();
  const curMonth=now.getMonth();
  const curYear=now.getFullYear();
  // 12-month salary mass simulation
  const months12=Array.from({length:12},(_,i)=>{
    const mi=(curMonth-11+i+12)%12;
    const yi=curYear-(curMonth-11+i<0?1:0);
    const found=s.pays.filter(p=>p.month===mi+1&&p.year===yi);
    const mass=found.length>0?found.reduce((a,p)=>a+(p.gross||0),0):tm;
    const cost=found.length>0?found.reduce((a,p)=>a+(p.costTotal||0),0):tc;
    return {m:MN[mi]?.substring(0,3)||'',mass,cost,net:found.length>0?found.reduce((a,p)=>a+(p.net||0),0):tn};
  });
  const maxChart=Math.max(...months12.map(m=>m.cost),1);

  // Deadlines calculation
  const getDeadlines=()=>{
    const dl=[];
    const q=Math.floor(curMonth/3)+1;
    const qEnd=new Date(curYear,q*3,0);
    const nextMonth5=new Date(curYear,curMonth+1,5);
    const daysToPP=Math.ceil((nextMonth5-now)/(1000*60*60*24));
    dl.push({l:"Précompte professionnel 274",d:`5/${String(curMonth+2).padStart(2,"0")}/${curYear}`,days:daysToPP,t:'mensuel',urgent:daysToPP<=5,icon:'◇'});
    const daysToDmfa=Math.ceil((qEnd-now)/(1000*60*60*24));
    dl.push({l:`DmfA T${q}/${curYear}`,d:`${qEnd.getDate()}/${String(q*3).padStart(2,"0")}/${curYear}`,days:daysToDmfa,t:'trimestriel',urgent:daysToDmfa<=14,icon:'◆'});
    if(curMonth<=1){const belco=new Date(curYear,2,1);const dB=Math.ceil((belco-now)/(1000*60*60*24));dl.push({l:"Belcotax 281.xx",d:`01/03/${curYear}`,days:dB,t:'annuel',urgent:dB<=30,icon:'▣'});}
    if(curMonth<=1){const bilan=new Date(curYear,1,28);const dBi=Math.ceil((bilan-now)/(1000*60*60*24));dl.push({l:"Bilan Social BNB",d:`28/02/${curYear}`,days:dBi,t:'annuel',urgent:dBi<=30,icon:'◈'});}
    dl.push({l:"Dimona IN — Avant embauche",d:"Permanent",days:null,t:'event',urgent:false,icon:'⬆'});
    dl.push({l:"Provisions ONSS mensuelles",d:`5 du mois`,days:daysToPP,t:'mensuel',urgent:daysToPP<=5,icon:'◆'});
    return dl.sort((a,b)=>(a.days??999)-(b.days??999));
  };
  const deadlines=getDeadlines();
  const urgentCount=deadlines.filter(d=>d.urgent).length;

  // ── ALERTES INTELLIGENTES ──
  const getAlerts=()=>{
    const alerts=[];
    const today=new Date();
    const eName=(e)=>(e.first||e.last)?`${e.first||''} ${e.last||''}`.trim():(e.fn||`Employé ${(e.id||'').slice(-3)}`);
    // CDD fin proche (30 jours)
    ae.forEach(e=>{
      if(e.endD){
        const end=new Date(e.endD);
        const days=Math.ceil((end-today)/(1000*60*60*24));
        if(days>0&&days<=30)alerts.push({type:'warning',icon:'⏰',msg:`CDD de ${eName(e)} expire dans ${days} jours (${e.endD})`,cat:'Contrat'});
        if(days<=0)alerts.push({type:'error',icon:'🔴',msg:`CDD de ${eName(e)} expiré depuis ${Math.abs(days)} jours !`,cat:'Contrat'});
      }
      // Période d'essai (si entrée < 14 jours pour étudiant)
      if(e.contract==='student'&&e.startD){
        const start=new Date(e.startD);
        const days=Math.ceil((today-start)/(1000*60*60*24));
        if(days<=3)alerts.push({type:'info',icon:'📋',msg:`${eName(e)}: période d'essai étudiant (3 premiers jours)`,cat:'Contrat'});
      }
      // NISS manquant
      if(!e.niss)alerts.push({type:'warning',icon:'🆔',msg:`NISS manquant pour ${eName(e)}`,cat:'Identité'});
      // IBAN manquant
      if(!e.iban)alerts.push({type:'info',icon:'🏦',msg:`IBAN manquant pour ${eName(e)}`,cat:'Financier'});
      // Salaire à 0
      if(!e.monthlySalary||e.monthlySalary<=0)alerts.push({type:'error',icon:'💰',msg:`Salaire non configuré pour ${eName(e)}`,cat:'Rémunération'});
    });
    // Indexation prévue
    const nextIndex=new Date(today.getFullYear(),0,1);
    if(today.getMonth()>=10)nextIndex.setFullYear(today.getFullYear()+1);
    const daysToIndex=Math.ceil((nextIndex-today)/(1000*60*60*24));
    if(daysToIndex<=60&&daysToIndex>0)alerts.push({type:'info',icon:'📈',msg:`Indexation salariale prévue dans ~${daysToIndex} jours (janvier ${nextIndex.getFullYear()})`,cat:'Légal'});
    // DmfA trimestrielle
    const q=Math.floor(today.getMonth()/3)+1;
    const qEnd=new Date(today.getFullYear(),q*3,0);
    const daysToDmfa=Math.ceil((qEnd-today)/(1000*60*60*24));
    if(daysToDmfa<=14)alerts.push({type:'warning',icon:'📡',msg:`DmfA T${q}/${today.getFullYear()} à déposer dans ${daysToDmfa} jours`,cat:'ONSS'});
    return alerts.sort((a,b)=>a.type==='error'?-1:b.type==='error'?1:a.type==='warning'?-1:1);
  };
  const alerts=getAlerts();

  // Dept breakdown
  const depts={};
  ae.forEach(e=>{const dp=e.dept||'Non défini';if(!depts[dp])depts[dp]={count:0,mass:0};depts[dp].count++;depts[dp].mass+=(e.monthlySalary||0);});

  return <div>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
      <div>
        <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:700,color:'#e8e6e0',margin:0}}>Tableau de bord</h1>
        <div style={{fontSize:12.5,color:'#8b7340',marginTop:4}}>{MN[curMonth]} {curYear} — {s.co.name||'—'} {s.co.vat?`· ${s.co.vat}`:''}</div>
      </div>
      {urgentCount>0&&<div style={{padding:'8px 16px',background:"rgba(248,113,113,.08)",border:'1px solid rgba(248,113,113,.2)',borderRadius:10,display:'flex',alignItems:'center',gap:8,animation:'pulse 2s infinite'}}>
        <span style={{width:8,height:8,borderRadius:'50%',background:"#ef4444",display:'inline-block',animation:'blink 1.5s infinite'}}/>
        <span style={{fontSize:12,fontWeight:600,color:'#f87171'}}>{urgentCount} échéance{urgentCount>1?'s':''} urgente{urgentCount>1?'s':''}</span>
      </div>}
    </div>
    

    
    {/* ⚡ Automation Shortcuts */}
    <div style={{marginBottom:20,padding:16,background:'linear-gradient(135deg,rgba(198,163,78,.06),rgba(198,163,78,.02))',border:'1px solid rgba(198,163,78,.15)',borderRadius:12,display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:10}}>
      <div style={{display:'flex',alignItems:'center',gap:10}}>
        <span style={{fontSize:18}}>⚡</span>
        <div><div style={{fontSize:13,fontWeight:600,color:'#c6a34e'}}>Automatisation</div><div style={{fontSize:10,color:'#888'}}>Actions rapides</div></div>
      </div>
      <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
        <button onClick={()=>{if(confirm('Générer toutes les fiches de paie ?')){(s.emps||[]).forEach(e=>generatePayslipPDF(e,s.co));addToast(s.emps.length+' fiches de paie générées')}}} style={{padding:'7px 14px',borderRadius:8,border:'none',background:'rgba(198,163,78,.15)',color:'#c6a34e',fontSize:11,cursor:'pointer',fontWeight:600}}>📄 Fiches</button>
        <button onClick={()=>{if(confirm('Générer SEPA ?')){generateSEPAXML(s.emps||[],s.co);addToast('Fichier SEPA pain.001 généré')}}} style={{padding:'7px 14px',borderRadius:8,border:'none',background:'rgba(34,197,94,.12)',color:'#22c55e',fontSize:11,cursor:'pointer',fontWeight:600}}>💸 SEPA</button>
        <button onClick={()=>{if(confirm('Générer DmfA ?')){generateDmfAXML(s.emps||[],Math.ceil((new Date().getMonth()+1)/3),new Date().getFullYear(),s.co);addToast('DmfA trimestrielle générée')}}} style={{padding:'7px 14px',borderRadius:8,border:'none',background:'rgba(168,85,247,.12)',color:'#a855f7',fontSize:11,cursor:'pointer',fontWeight:600}}>📊 DmfA</button>
        <button onClick={()=>d({type:'NAV',page:'automatisation'})} style={{padding:'7px 14px',borderRadius:8,border:'1px solid rgba(198,163,78,.2)',background:'transparent',color:'#c6a34e',fontSize:11,cursor:'pointer',fontWeight:500}}>Voir tout →</button>
      </div>
    </div>
{(()=>{const al=getAlertes(s.emps||[],s.co);return al.length>0?<div style={{marginBottom:16,borderRadius:10,border:"1px solid rgba(198,163,78,.15)",padding:12,background:"rgba(198,163,78,.03)"}}><div style={{fontSize:12,fontWeight:700,color:"#c6a34e",marginBottom:8}}>Alertes ({al.length})</div>{al.slice(0,8).map((a,i)=><div key={i} style={{padding:"6px 8px",marginBottom:4,borderRadius:6,fontSize:11,background:a.level==="danger"?"rgba(248,113,113,.08)":a.level==="warning"?"rgba(251,146,60,.08)":"rgba(96,165,250,.08)",color:a.level==="danger"?"#f87171":a.level==="warning"?"#fb923c":"#60a5fa"}}>{a.icon} {a.msg}</div>)}{al.length>8?<div style={{fontSize:10,color:"#9e9b93",marginTop:4}}>+{al.length-8} autres alertes</div>:null}</div>:null})()}
    
    {/* KPI ROW */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:14,marginBottom:22}}>
      {[
        {label:"Employés actifs",value:ae.length,sub:`${sortie.length} sorti${sortie.length>1?'s':''} · ${etudiants.length} étudiant${etudiants.length>1?'s':''}`,color:'#c6a34e',icon:'◉'},
        {label:"Masse salariale brute",value:fmt(tm),sub:`Moy: ${fmt(avgGross)}/emp`,color:'#4ade80',icon:'◈'},
        {label:"Net total",value:fmt(tn),sub:`${ae.length?Math.round(tn/tm*100):0}% du brut`,color:'#60a5fa',icon:'▤'},
        {label:"Coût employeur total",value:fmt(tc),sub:`Ratio: ${ae.length?((tc/tm)*100).toFixed(0):0}% du brut`,color:'#a78bfa',icon:'◆'},
        {label:"Déclarations",value:`${s.pays.length}`,sub:`${s.dims.length} Dimona · ${s.dmfas.length} DmfA`,color:'#fb923c',icon:'◇'},
      ].map((kpi,i)=>
        <div key={i} style={{background:"linear-gradient(145deg,#0e1220,#131829)",border:'1px solid rgba(139,115,60,.12)',borderRadius:14,padding:'20px 18px',position:'relative',overflow:'hidden',animation:`fadeIn .4s ease ${i*0.08}s both`}}>
          <div style={{position:'absolute',top:12,right:14,fontSize:22,opacity:.08,color:kpi.color}}>{kpi.icon}</div>
          <div style={{fontSize:10,color:'#5e5c56',marginBottom:8,textTransform:'uppercase',letterSpacing:'1.2px',fontWeight:600}}>{kpi.label}</div>
          <div style={{fontSize:24,fontWeight:700,color:kpi.color,animation:'countUp .5s ease'}}>{kpi.value}</div>
          {kpi.sub&&<div style={{fontSize:10,color:'#5e5c56',marginTop:5}}>{kpi.sub}</div>}
        </div>
      )}
    </div>

    {/* MAIN GRID: Chart + Deadlines */}
    <div style={{display:'grid',gridTemplateColumns:'1fr 380px',gap:14,marginBottom:16}}>
      {/* 12-MONTH CHART */}
      <C style={{padding:'22px 24px'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:18}}>
          <div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Évolution coût salarial — 12 mois</div>
          <div style={{display:'flex',gap:14}}>
            {[{l:"Coût total",c:'#a78bfa'},{l:"Masse brute",c:'#c6a34e'},{l:"Net",c:'#4ade80'}].map(x=>
              <div key={x.l} style={{display:'flex',alignItems:'center',gap:5,fontSize:10,color:'#5e5c56'}}>
                <span style={{width:8,height:3,borderRadius:2,background:x.c,display:'inline-block'}}/>{x.l}
              </div>
            )}
          </div>
        </div>
        <div style={{display:'flex',alignItems:'flex-end',gap:6,height:180}}>
          {months12.map((m,i)=>{
            const hCost=Math.round((m.cost/maxChart)*150);
            const hMass=Math.round((m.mass/maxChart)*150);
            const hNet=Math.round((m.net/maxChart)*150);
            return <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:4}}>
              <div style={{fontSize:9,color:'#5e5c56',fontWeight:500}}>{fmt(m.cost).replace(/\s€/,"")}</div>
              <div style={{width:'100%',position:'relative',height:155,display:'flex',alignItems:'flex-end',justifyContent:'center',gap:2}}>
                <div style={{width:'30%',height:Math.max(hCost,2),background:"linear-gradient(180deg,#a78bfa,#7c3aed)",borderRadius:'3px 3px 0 0',transition:'height .5s ease',animation:`fadeIn .3s ease ${i*0.05}s both`}}/>
                <div style={{width:'30%',height:Math.max(hMass,2),background:"linear-gradient(180deg,#c6a34e,#a68a3c)",borderRadius:'3px 3px 0 0',transition:'height .5s ease',animation:`fadeIn .3s ease ${i*0.05+0.1}s both`}}/>
                <div style={{width:'30%',height:Math.max(hNet,2),background:"linear-gradient(180deg,#4ade80,#16a34a)",borderRadius:'3px 3px 0 0',transition:'height .5s ease',animation:`fadeIn .3s ease ${i*0.05+0.2}s both`}}/>
              </div>
              <div style={{fontSize:9,color:i===11?'#c6a34e':'#5e5c56',fontWeight:i===11?700:400}}>{m.m}</div>
            </div>;
          })}
        </div>
      </C>

      {/* DEADLINES */}
      <C style={{padding:'22px 20px'}}>
        <div style={{fontSize:13,fontWeight:600,color:'#e8e6e0',marginBottom:16,display:'flex',alignItems:'center',gap:8}}>
          Échéances & Obligations
          {urgentCount>0&&<span style={{fontSize:10,padding:'2px 8px',borderRadius:10,background:"rgba(248,113,113,.12)",color:'#f87171',fontWeight:700}}>{urgentCount}</span>}
        </div>
        <div style={{display:'flex',flexDirection:'column',gap:6}}>
          {deadlines.map((dl,i)=>
            <div key={i} style={{display:'flex',gap:10,padding:'10px 12px',borderRadius:8,background:dl.urgent?'rgba(248,113,113,.04)':'rgba(198,163,78,.02)',border:`1px solid ${dl.urgent?'rgba(248,113,113,.15)':'rgba(139,115,60,.08)'}`,alignItems:'center',animation:`fadeIn .3s ease ${i*0.06}s both`}}>
              <span style={{fontSize:16,opacity:.4}}>{dl.icon}</span>
              <div style={{flex:1}}>
                <div style={{fontSize:12,color:dl.urgent?'#f87171':'#d4d0c8',fontWeight:dl.urgent?600:400}}>{dl.l}</div>
                <div style={{fontSize:10,color:'#5e5c56',marginTop:2}}>{dl.d}</div>
              </div>
              {dl.days!==null&&<div style={{textAlign:'right'}}>
                <div style={{fontSize:14,fontWeight:700,color:dl.urgent?'#ef4444':dl.days<=30?'#fb923c':'#4ade80'}}>{dl.days}j</div>
                <span style={{fontSize:8.5,padding:'1px 6px',borderRadius:4,fontWeight:600,textTransform:'uppercase',letterSpacing:'.5px',
                  background:dl.t==='mensuel'?'rgba(96,165,250,.1)':dl.t==='trimestriel'?'rgba(167,139,250,.1)':dl.t==='annuel'?'rgba(198,163,78,.1)':'rgba(74,222,128,.1)',
                  color:dl.t==='mensuel'?'#60a5fa':dl.t==='trimestriel'?'#a78bfa':dl.t==='annuel'?'#c6a34e':'#4ade80'}}>{dl.t}</span>
              </div>}
            </div>
          )}
        </div>
      </C>
    </div>

    {/* VERSION & CHANGELOG */}
    <C style={{marginBottom:16,border:'1px solid rgba(198,163,78,.15)'}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <span style={{fontSize:11,padding:'3px 10px',borderRadius:6,background:'linear-gradient(135deg,#c6a34e,#a68a3c)',color:'#060810',fontWeight:700}}>{AUREUS_INFO.version}</span>
          <span style={{fontSize:12,fontWeight:600,color:'#e8e6e0'}}>Aureus Social Pro — {AUREUS_INFO.sprint}</span>
        </div>
        <span style={{fontSize:10,color:'#5e5c56'}}>Dernière mise à jour: {new Date().toLocaleDateString('fr-BE')}</span>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
        {[
          {v:'v37',title:'Sprint 9',items:['⚙️ 13 automatisations (validation obligatoire)','📅 Gestion absences pré-paie','⚡ 8 actions en masse multi-clients','🏥 Audit santé global','📋 Planificateur 14 tâches','📑 15 Modèles documents','🔍 Filtres score santé'],color:'#06b6d4'},
          {v:'v36',title:'Sprint 8',items:['📊 Budget Auto','🔮 Simulateur What-If','📈 KPI + Equal Pay'],color:'#f472b6'},
          {v:'v35',title:'Sprint 7',items:['🏪 Marketplace 12 modules','🔗 Intégrations 25+ connecteurs','🔔 Webhook Manager'],color:'#a78bfa'},
          {v:'v34',title:'Sprint 6',items:['🌐 4 langues (FR/NL/EN/DE)','🔌 API Documentation','💱 Multi-Devises'],color:'#fb923c'},
          {v:'v33',title:'Sprint 5',items:['🧠 Prédiction Turnover','💡 Reco Salariales IA','📈 Prévision Masse','🔍 Détection Anomalies','🏥 Score Santé Dossier'],color:'#f87171'},
          {v:'v32',title:'Sprint 4',items:['⚡ Batch Processing','🔔 Alertes intelligentes','🔐 2FA (TOTP)','📡 DmfA améliorée'],color:'#a78bfa'},
          {v:'v31',title:'Sprint 3',items:['⚡ Workflow Embauche','⚡ Workflow Licenciement','⚡ Workflow Maladie','📂 Export 11 formats + ClearFact'],color:'#60a5fa'},
          {v:'v30',title:'Sprint 2',items:['📥 Import Excel','💰 ROI Calculator','🔒 Validation NISS/IBAN','🧠 153 CP pré-remplissage'],color:'#4ade80'},
        ].map((sp,i)=><div key={i} style={{padding:12,borderRadius:10,background:'rgba(198,163,78,.02)',border:'1px solid rgba(198,163,78,.08)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}>
            <span style={{fontSize:10,padding:'2px 6px',borderRadius:4,background:`${sp.color}22`,color:sp.color,fontWeight:700}}>{sp.v}</span>
            <span style={{fontSize:11,fontWeight:600,color:'#e8e6e0'}}>{sp.title}</span>
          </div>
          {sp.items.map((it,j)=><div key={j} style={{fontSize:10,color:'#9e9b93',padding:'2px 0'}}>{it}</div>)}
        </div>)}
      </div>
    </C>

    {/* BOTTOM ROW: Alerts + Actions + Employees + Dept breakdown */}
    {alerts.length>0&&<C style={{marginBottom:16,border:'1px solid '+(alerts.some(a=>a.type==='error')?'rgba(248,113,113,.2)':'rgba(251,146,60,.15)')}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
        <div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>🔔 Alertes intelligentes ({alerts.length})</div>
        <div style={{display:'flex',gap:8}}>
          <span style={{fontSize:10,padding:'2px 8px',borderRadius:10,background:'rgba(248,113,113,.1)',color:'#f87171'}}>{alerts.filter(a=>a.type==='error').length} critiques</span>
          <span style={{fontSize:10,padding:'2px 8px',borderRadius:10,background:'rgba(251,146,60,.1)',color:'#fb923c'}}>{alerts.filter(a=>a.type==='warning').length} avertissements</span>
          <span style={{fontSize:10,padding:'2px 8px',borderRadius:10,background:'rgba(96,165,250,.1)',color:'#60a5fa'}}>{alerts.filter(a=>a.type==='info').length} infos</span>
        </div>
      </div>
      <div style={{maxHeight:200,overflowY:'auto',display:'flex',flexDirection:'column',gap:4}}>
        {alerts.map((a,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 12px',borderRadius:8,background:a.type==='error'?'rgba(248,113,113,.04)':a.type==='warning'?'rgba(251,146,60,.04)':'rgba(96,165,250,.04)',border:'1px solid '+(a.type==='error'?'rgba(248,113,113,.1)':a.type==='warning'?'rgba(251,146,60,.1)':'rgba(96,165,250,.1)')}}>
          <span style={{fontSize:14}}>{a.icon}</span>
          <span style={{flex:1,fontSize:11.5,color:a.type==='error'?'#f87171':a.type==='warning'?'#fb923c':'#60a5fa'}}>{a.msg}</span>
          <span style={{fontSize:9,padding:'2px 6px',borderRadius:4,background:'rgba(198,163,78,.06)',color:'#5e5c56'}}>{a.cat}</span>
        </div>)}
      </div>
    </C>}
    <div style={{display:'grid',gridTemplateColumns:'260px 1fr 300px',gap:14}}>
      {/* QUICK ACTIONS */}
      <C style={{padding:'20px 18px'}}>
        <div style={{fontSize:13,fontWeight:600,color:'#e8e6e0',marginBottom:14}}>Actions rapides</div>
        {[
          {l:"+ Nouvel employé",p:'employees',i:'◉',c:'#4ade80'},
          {l:"Générer fiche de paie",p:'payslip',i:'◈',c:'#60a5fa'},
          {l:"Dimona IN/OUT",p:'onss',sb:'dimona',i:'⬆',c:'#c6a34e'},
          {l:"DmfA trimestrielle",p:'onss',sb:'dmfa',i:'◆',c:'#a78bfa'},
          {l:"Belcotax 281.10",p:'fiscal',sb:'belcotax',i:'◇',c:'#fb923c'},
          {l:"Virement SEPA",p:'reporting',sb:'sepa',i:'▤',c:'#06b6d4'},
        ].map((a,i)=>
          <button key={i} onClick={()=>d({type:"NAV",page:a.p,sub:a.sb})} style={{display:'flex',alignItems:'center',gap:10,width:'100%',padding:'10px 12px',marginBottom:4,background:"rgba(198,163,78,.03)",border:'1px solid rgba(198,163,78,.06)',borderRadius:8,color:'#d4d0c8',cursor:'pointer',fontSize:12,fontWeight:500,textAlign:'left',fontFamily:'inherit',transition:'all .15s'}}
            onMouseEnter={e=>{e.currentTarget.style.background='rgba(198,163,78,.08)';e.currentTarget.style.borderColor='rgba(198,163,78,.2)';}}
            onMouseLeave={e=>{e.currentTarget.style.background='rgba(198,163,78,.03)';e.currentTarget.style.borderColor='rgba(198,163,78,.06)';}}>
            <span style={{fontSize:14,color:a.c,opacity:.7}}>{a.i}</span>{a.l}
          </button>
        )}
      </C>

      {/* EMPLOYEES LIST */}
      <C style={{padding:'20px 18px',maxHeight:340,overflowY:'auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
          <div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Équipe ({ae.length})</div>
          <button onClick={()=>d({type:"NAV",page:'employees'})} style={{fontSize:10,color:'#c6a34e',background:"none",border:'none',cursor:'pointer',fontFamily:'inherit',fontWeight:500}}>Voir tout →</button>
        </div>
        {calcs.slice(0,8).map(({e,c},i)=>(
          <div key={e.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'9px 0',borderBottom:'1px solid rgba(255,255,255,.03)',animation:`fadeIn .3s ease ${i*0.04}s both`}}>
            <div style={{display:'flex',alignItems:'center',gap:10}}>
              <div style={{width:32,height:32,borderRadius:8,background:`linear-gradient(135deg,${['#c6a34e',"#60a5fa","#a78bfa","#4ade80","#fb923c","#06b6d4"][i%6]}22,${['#c6a34e',"#60a5fa","#a78bfa","#4ade80","#fb923c","#06b6d4"][i%6]}08)`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:700,color:['#c6a34e',"#60a5fa","#a78bfa","#4ade80","#fb923c","#06b6d4"][i%6]}}>{(e.first||'')[0]}{(e.last||'')[0]}</div>
              <div>
                <div style={{fontSize:12.5,fontWeight:500,color:'#e8e6e0'}}>{e.first||e.fn||'Employé'} {e.last||''}
                  <span style={{fontSize:8.5,padding:'1px 5px',borderRadius:3,marginLeft:6,fontWeight:600,
                    background:e.status==='sorti'?'rgba(248,113,113,.12)':e.contract==='student'?'rgba(251,146,60,.12)':e.statut==='ouvrier'?'rgba(251,146,60,.1)':'rgba(96,165,250,.08)',
                    color:e.status==='sorti'?'#f87171':e.contract==='student'?'#fb923c':e.statut==='ouvrier'?'#fb923c':'#60a5fa',
                  }}>{e.status==='sorti'?'SORTI':e.contract==='student'?'ÉTU':e.statut==='ouvrier'?'OUV':'EMPL'}</span>
                </div>
                <div style={{fontSize:10,color:'#5e5c56'}}>{e.fn||'—'} · CP {e.cp||'200'}</div>
              </div>
            </div>
            <div style={{textAlign:'right'}}>
              <div style={{fontSize:13,fontWeight:600,color:'#4ade80'}}>{fmt(c.net)}</div>
              <div style={{fontSize:9,color:'#5e5c56'}}>coût: {fmt(c.costTotal)}</div>
            </div>
          </div>
        ))}
        {ae.length>8&&<div style={{textAlign:'center',padding:'10px 0',fontSize:11,color:'#8b7340'}}>+ {ae.length-8} autre{ae.length-8>1?'s':''}</div>}
      </C>

      {/* DEPARTMENT BREAKDOWN */}
      <C style={{padding:'20px 18px'}}>
        <div style={{fontSize:13,fontWeight:600,color:'#e8e6e0',marginBottom:16}}>Répartition par département</div>
        {Object.entries(depts).sort((a,b)=>b[1].mass-a[1].mass).map(([dp,data],i)=>{
          const pct=tm>0?Math.round(data.mass/tm*100):0;
          return <div key={dp} style={{marginBottom:12,animation:`fadeIn .3s ease ${i*0.06}s both`}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:4}}>
              <div style={{fontSize:11.5,color:'#d4d0c8',fontWeight:500}}>{dp} <span style={{color:'#5e5c56',fontWeight:400}}>({data.count})</span></div>
              <div style={{fontSize:11,color:'#c6a34e',fontWeight:600}}>{fmt(data.mass)}</div>
            </div>
            <div style={{height:6,background:"rgba(198,163,78,.06)",borderRadius:3,overflow:'hidden'}}>
              <div style={{height:'100%',width:`${pct}%`,background:"linear-gradient(90deg,#c6a34e,#e2c878)",borderRadius:3,transition:'width .8s ease'}}/>
            </div>
            <div style={{fontSize:9,color:'#5e5c56',marginTop:2}}>{pct}% de la masse salariale</div>
          </div>;
        })}
        {Object.keys(depts).length===0&&<div style={{textAlign:'center',color:'#5e5c56',fontSize:12,padding:20}}>Aucun employé</div>}
        <div style={{marginTop:16,padding:'12px 14px',background:"rgba(198,163,78,.03)",borderRadius:8,border:'1px solid rgba(198,163,78,.06)'}}>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:4}}>
            <span style={{fontSize:10,color:'#5e5c56',textTransform:'uppercase',letterSpacing:'1px'}}>Ratio net/brut</span>
            <span style={{fontSize:13,fontWeight:700,color:'#4ade80'}}>{tm>0?Math.round(tn/tm*100):0}%</span>
          </div>
          <div style={{display:'flex',justifyContent:'space-between'}}>
            <span style={{fontSize:10,color:'#5e5c56',textTransform:'uppercase',letterSpacing:'1px'}}>Coût/brut</span>
            <span style={{fontSize:13,fontWeight:700,color:'#a78bfa'}}>{tm>0?((tc/tm)*100).toFixed(0):0}%</span>
          </div>
        </div>
      </C>
    </div>
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  EMPLOYEES
// ═══════════════════════════════════════════════════════════════
function Employees({s,d}) {
  const [form,setF]=useState(null);
  const [ed,setEd]=useState(false);
  const [search,setSearch]=useState('');
  const [filter,setFilter]=useState('all'); // all, active, sorti, student, ouvrier
  const [viewMode,setViewMode]=useState('list'); // list, grid
  const empty={first:'',last:'',niss:'',birth:'',addr:'',city:'',zip:'',startD:'',endD:'',fn:"",dept:'',contract:'CDI',regime:'full',whWeek:38,monthlySalary:0,civil:"single",depChildren:0,handiChildren:0,iban:'',mvT:10,mvW:CR_TRAV,mvE:8.91,expense:0,cp:'200',dmfaCode:'495',dimType:'OTH',commDist:0,commType:'none',commMonth:0,status:'active',sexe:'M',statut:'employe',niveauEtude:'sec',carFuel:"none",carCO2:0,carCatVal:0,carBrand:"",carModel:"",atnGSM:false,atnPC:false,atnInternet:false,atnLogement:false,atnLogementRC:0,atnChauffage:false,atnElec:false,depAscendant:0,depAscendantHandi:0,conjointHandicap:false,depAutres:0,anciennete:0,nrEngagement:0,engagementTrimestre:1,
    veloSociete:false,veloType:'none',veloValeur:0,veloLeasingMois:0,carteCarburant:false,carteCarburantMois:0,borneRecharge:false,borneRechargeCoût:0,
    frontalier:false,frontalierPays:'',frontalierConvention:'',frontalierA1:false,frontalierExoPP:false,
    pensionné:false,pensionType:'none',pensionAge:0,pensionCarriere:0,pensionCumulIllimite:false,pensionMontant:0,
  };
  // ── NISS VALIDATION ──
  const validateNISS=(niss)=>{
    if(!niss)return{valid:false,msg:'NISS requis'};
    const clean=niss.replace(/[\s.\-]/g,'');
    if(clean.length!==11||!/^\d{11}$/.test(clean))return{valid:false,msg:'NISS doit contenir 11 chiffres'};
    // Check digit (modulo 97)
    const base=clean.slice(0,9);
    const check=parseInt(clean.slice(9));
    // Born before 2000
    let mod=97-(parseInt(base)%97);
    if(mod===check)return{valid:true,msg:'✅ NISS valide'};
    // Born after 2000 (prefix with 2)
    mod=97-(parseInt('2'+base)%97);
    if(mod===check)return{valid:true,msg:'✅ NISS valide (né(e) après 2000)'};
    return{valid:false,msg:'❌ NISS invalide — chiffre de contrôle incorrect'};
  };

  // ── NISS DUPLICATE DETECTION ──
  const checkNISSDuplicate=(niss,currentId)=>{
    if(!niss)return null;
    const clean=niss.replace(/[\s.\-]/g,'');
    // Level 1: Same dossier
    const dupLocal=(s.emps||[]).find(e=>e.niss&&e.niss.replace(/[\s.\-]/g,'')===clean&&e.id!==currentId);
    if(dupLocal)return{level:'error',msg:`⛔ NISS déjà utilisé dans ce dossier: ${dupLocal.first} ${dupLocal.last}`};
    // Level 2: Platform-wide (check all clients)
    const allClients=s.clients||[];
    for(const cl of allClients){
      if(cl.id===s.activeClient)continue;
      const dupPlatform=(cl.emps||[]).find(e=>e.niss&&e.niss.replace(/[\s.\-]/g,'')===clean);
      if(dupPlatform)return{level:'warn',msg:`⚠️ NISS existe dans le dossier ${cl.company?.name||'autre'}: ${dupPlatform.first} ${dupPlatform.last}. Transfert?`};
    }
    return null;
  };

  // ── IBAN VALIDATION ──
  const validateIBAN=(iban)=>{
    if(!iban)return null;
    const clean=iban.replace(/\s/g,'').toUpperCase();
    if(clean.length<15||clean.length>34)return{valid:false,msg:'❌ Longueur IBAN incorrecte'};
    if(!/^[A-Z]{2}\d{2}/.test(clean))return{valid:false,msg:'❌ Format IBAN invalide (doit commencer par 2 lettres + 2 chiffres)'};
    // Belgian IBAN check
    if(clean.startsWith('BE')&&clean.length!==16)return{valid:false,msg:'❌ IBAN belge = 16 caractères (BE + 14 chiffres)'};
    // Modulo 97 check
    const rearranged=clean.slice(4)+clean.slice(0,4);
    const numeric=rearranged.split('').map(c=>/\d/.test(c)?c:(c.charCodeAt(0)-55).toString()).join('');
    let remainder=numeric.slice(0,2);
    for(let i=2;i<numeric.length;i++){
      remainder=((parseInt(remainder+numeric[i]))%97).toString();
    }
    if(parseInt(remainder)!==1)return{valid:false,msg:'❌ IBAN invalide — chiffre de contrôle incorrect'};
    return{valid:true,msg:`✅ IBAN valide (${clean.slice(0,2)})`};
  };

  const [nissCheck,setNissCheck]=useState(null);
  const [nissDup,setNissDup]=useState(null);
  const [ibanCheck,setIbanCheck]=useState(null);

  const onNissChange=(v)=>{
    setF({...form,niss:v});
    if(v.replace(/[\s.\-]/g,'').length>=11){
      setNissCheck(validateNISS(v));
      setNissDup(checkNISSDuplicate(v,form.id));
    }else{setNissCheck(null);setNissDup(null);}
  };
  const onIbanChange=(v)=>{
    setF({...form,iban:v});
    if(v.replace(/\s/g,'').length>=15)setIbanCheck(validateIBAN(v));
    else setIbanCheck(null);
  };

  // ── IMPORT EXCEL ──
  const [importing,setImporting]=useState(false);
  const handleImportExcel=async(e)=>{
    const file=e.target.files?.[0];
    if(!file)return;
    setImporting(true);
    try{
      const XLSX=await new Promise((resolve,reject)=>{if(window.XLSX)return resolve(window.XLSX);const s=document.createElement('script');s.src='https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';s.onload=()=>resolve(window.XLSX);s.onerror=reject;document.head.appendChild(s);});
      const buf=await file.arrayBuffer();
      const wb=XLSX.read(buf);
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws);
      let added=0;
      for(const r of rows){
        const emp={
          ...empty,
          first:r['Prénom']||r['Prenom']||r['prenom']||r['first']||r['First']||'',
          last:r['Nom']||r['nom']||r['last']||r['Last']||'',
          niss:String(r['NISS']||r['niss']||r['Registre national']||''),
          fn:r['Fonction']||r['fonction']||r['function']||'',
          dept:r['Département']||r['Departement']||r['dept']||'',
          contract:r['Contrat']||r['contrat']||r['Type']||'CDI',
          cp:String(r['CP']||r['cp']||r['Commission paritaire']||'200'),
          monthlySalary:parseFloat(r['Brut']||r['brut']||r['Salaire']||r['salaire']||0),
          startD:r['Entrée']||r['Entree']||r['Date entrée']||r['startD']||'',
          iban:r['IBAN']||r['iban']||'',
          statut:r['Statut']||r['statut']||'employe',
          sexe:r['Sexe']||r['sexe']||'M',
          status:'active',
        };
        if(emp.first||emp.last){
          d({type:'ADD_E',d:emp});
          added++;
        }
      }
      alert(`✅ ${added} travailleur(s) importé(s) depuis ${file.name}`);
    }catch(err){
      alert('❌ Erreur import: '+err.message);
    }
    setImporting(false);
    e.target.value='';
  };

  // ── PRÉ-REMPLISSAGE INTELLIGENT PAR CP (référence globale optimisée) ──
  const onCPChange=(v)=>{
    const preset=CP_PRESETS_FULL[v];
    if(preset&&!ed){
      setF({...form,cp:v,
        fn:preset.fn,
        statut:preset.statut,
        monthlySalary:preset.monthlySalary,
        whWeek:preset.whWeek
      });
    }else{
      setF({...form,cp:v});
    }
  };

  // ── ROI CALCULATOR ──
  const [showROI,setShowROI]=useState(false);
  const [roiData,setRoiData]=useState({nbEmps:10,prixActuel:35,prixAureus:12});
  const roiSaving=(roiData.prixActuel-roiData.prixAureus)*roiData.nbEmps;
  const roiSavingYear=roiSaving*12;
  const roiPercent=roiData.prixActuel>0?Math.round((1-roiData.prixAureus/roiData.prixActuel)*100):0;

  const save=()=>{
    if(!form.first||!form.last)return alert('Nom requis');
    // NISS validation
    if(form.niss){
      const nc=validateNISS(form.niss);
      if(!nc.valid)return alert(nc.msg);
      const dup=checkNISSDuplicate(form.niss,form.id);
      if(dup&&dup.level==='error')return alert(dup.msg);
    }
    // IBAN validation
    if(form.iban){
      const ic=validateIBAN(form.iban);
      if(ic&&!ic.valid)return alert(ic.msg);
    }
    if(ed)d({type:"UPD_E",d:form});else d({type:"ADD_E",d:form});setF(null);setEd(false);
  };

  // Filter and search
  const filtered=(s.emps||[]).filter(e=>{
    if(filter==='active'&&e.status==='sorti')return false;
    if(filter==='sorti'&&e.status!=='sorti')return false;
    if(filter==='student'&&e.contract!=='student')return false;
    if(filter==='ouvrier'&&e.statut!=='ouvrier')return false;
    if(search){
      const q=search.toLowerCase();
      return `${e.first||e.fn||'Emp'} ${e.last||''} ${e.fn} ${e.niss} ${e.dept} ${e.cp}`.toLowerCase().includes(q);
    }
    return true;
  });

  // CSV Export
  const exportCSV=()=>{
    const headers=['Prénom',"Nom","NISS","Fonction","Département","Contrat","CP","Brut","Statut","Entrée","IBAN"];
    const rows=filtered.map(e=>[e.first,e.last,e.niss,e.fn,e.dept,e.contract,e.cp,e.monthlySalary,e.status||'active',e.startD,e.iban]);
    const csv=[headers,...rows].map(r=>r.map(c=>`"${(c||'').toString().replace(/"/g,'""')}"`).join(';')).join('\n');
    const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=`employees_${new Date().toISOString().slice(0,10)}.csv`;a.click();
    setTimeout(()=>URL.revokeObjectURL(url),3000);
  };

  const activeCount=(s.emps||[]).filter(e=>e.status!=='sorti').length;
  const sortiCount=(s.emps||[]).filter(e=>e.status==='sorti').length;
  const studentCount=(s.emps||[]).filter(e=>e.contract==='student').length;

  return <div>
    <PH title="Gestion des Employés" sub={`${(s.emps||[]).length} employé(s)`} actions={<div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
      <label style={{padding:'8px 14px',borderRadius:8,fontSize:11,cursor:'pointer',border:'1px solid rgba(198,163,78,.25)',background:'transparent',color:'#c6a34e',fontWeight:600,display:'flex',alignItems:'center',gap:4}}>
        📥 {importing?'Import...':'Import Excel'}
        <input type="file" accept=".xlsx,.xls,.csv" onChange={handleImportExcel} style={{display:'none'}}/>
      </label>
      <B v="outline" onClick={()=>setShowROI(!showROI)} style={{padding:'8px 14px',fontSize:11}}>💰 ROI</B>
      <B v="outline" onClick={exportCSV} style={{padding:'8px 14px',fontSize:11}}>⬇ CSV</B>
      <B onClick={()=>{setF({...empty});setEd(false);}}>+ Nouvel employé</B>
    </div>}/>
    {/* Search and filters bar */}
    <div style={{display:'flex',gap:10,marginBottom:16,alignItems:'center',flexWrap:'wrap'}}>
      <div style={{flex:1,minWidth:200,position:'relative'}}>
        <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="🔍 Rechercher par nom, NISS, fonction, département..."
          style={{width:'100%',padding:'10px 14px 10px 14px',background:"#090c16",border:'1px solid rgba(139,115,60,.15)',borderRadius:8,color:'#d4d0c8',fontSize:12.5,fontFamily:'inherit',outline:'none',boxSizing:'border-box'}}/>
      </div>
      <div style={{display:'flex',gap:4}}>
        {[
          {id:"all",l:`Tous (${(s.emps||[]).length})`},
          {id:"active",l:`Actifs (${activeCount})`},
          {id:"sorti",l:`Sortis (${sortiCount})`},
          {id:"student",l:`Étudiants (${studentCount})`},
        ].map(f=>
          <button key={f.id} onClick={()=>setFilter(f.id)} style={{padding:'7px 12px',borderRadius:6,fontSize:11,fontWeight:filter===f.id?600:400,border:'1px solid '+(filter===f.id?'rgba(198,163,78,.3)':'rgba(139,115,60,.1)'),background:filter===f.id?'rgba(198,163,78,.1)':'transparent',color:filter===f.id?'#c6a34e':'#5e5c56',cursor:'pointer',fontFamily:'inherit',transition:'all .15s'}}>{f.l}</button>
        )}
      </div>
      <div style={{display:'flex',gap:2,background:"rgba(198,163,78,.04)",borderRadius:6,border:'1px solid rgba(139,115,60,.1)',overflow:'hidden'}}>
        <button onClick={()=>setViewMode('list')} style={{padding:'6px 10px',border:'none',background:viewMode==='list'?'rgba(198,163,78,.15)':'transparent',color:viewMode==='list'?'#c6a34e':'#5e5c56',cursor:'pointer',fontSize:13}}>☰</button>
        <button onClick={()=>setViewMode('grid')} style={{padding:'6px 10px',border:'none',background:viewMode==='grid'?'rgba(198,163,78,.15)':'transparent',color:viewMode==='grid'?'#c6a34e':'#5e5c56',cursor:'pointer',fontSize:13}}>⊞</button>
      </div>
    </div>
    {/* ROI Calculator */}
    {showROI&&<C style={{marginBottom:20,border:'1px solid rgba(198,163,78,.25)'}}>
      <h3 style={{fontSize:15,fontWeight:600,color:'#c6a34e',margin:'0 0 12px'}}>💰 Calculateur ROI — Économies vs secrétariat social</h3>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:12,marginBottom:16}}>
        <I label="Nombre de travailleurs" type="number" value={roiData.nbEmps} onChange={v=>setRoiData({...roiData,nbEmps:parseInt(v)||0})}/>
        <I label="Prix actuel / fiche (€)" type="number" value={roiData.prixActuel} onChange={v=>setRoiData({...roiData,prixActuel:parseFloat(v)||0})}/>
        <I label="Prix Aureus / fiche (€)" type="number" value={roiData.prixAureus} onChange={v=>setRoiData({...roiData,prixAureus:parseFloat(v)||0})}/>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:12}}>
        <div style={{padding:16,borderRadius:10,background:'rgba(74,222,128,.06)',border:'1px solid rgba(74,222,128,.15)',textAlign:'center'}}>
          <div style={{fontSize:10,color:'#9e9b93',marginBottom:4}}>Économie / mois</div>
          <div style={{fontSize:22,fontWeight:700,color:'#4ade80'}}>{roiSaving.toFixed(0)} €</div>
        </div>
        <div style={{padding:16,borderRadius:10,background:'rgba(198,163,78,.06)',border:'1px solid rgba(198,163,78,.15)',textAlign:'center'}}>
          <div style={{fontSize:10,color:'#9e9b93',marginBottom:4}}>Économie / an</div>
          <div style={{fontSize:22,fontWeight:700,color:'#c6a34e'}}>{roiSavingYear.toFixed(0)} €</div>
        </div>
        <div style={{padding:16,borderRadius:10,background:'rgba(96,165,250,.06)',border:'1px solid rgba(96,165,250,.15)',textAlign:'center'}}>
          <div style={{fontSize:10,color:'#9e9b93',marginBottom:4}}>Réduction</div>
          <div style={{fontSize:22,fontWeight:700,color:'#60a5fa'}}>{roiPercent}%</div>
        </div>
      </div>
      <div style={{marginTop:12,fontSize:11,color:'#5e5c56',textAlign:'center'}}>
        Comparé à {roiData.prixActuel}€/fiche chez les prestataires traditionnels — Aureus à {roiData.prixAureus}€/fiche
      </div>
    </C>}
    {form&&<C style={{marginBottom:20}}>
      <h2 style={{fontSize:17,fontWeight:600,color:'#e8e6e0',margin:'0 0 16px',fontFamily:"'Cormorant Garamond',serif"}}>{ed?'Modifier':'Nouvel employé'}</h2>
      <ST>Identité</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10}}>
        <I label="Prénom" value={form.first} onChange={v=>setF({...form,first:v})}/>
        <I label="Nom" value={form.last} onChange={v=>setF({...form,last:v})}/>
        <div>
          <I label="NISS" value={form.niss} onChange={onNissChange}/>
          {nissCheck&&<div style={{fontSize:10,marginTop:2,color:nissCheck.valid?'#4ade80':'#f87171'}}>{nissCheck.msg}</div>}
          {nissDup&&<div style={{fontSize:10,marginTop:2,color:nissDup.level==='error'?'#f87171':'#fb923c'}}>{nissDup.msg}</div>}
        </div>
        <I label="Naissance" type="date" value={form.birth} onChange={v=>setF({...form,birth:v})}/>
        <I label="Sexe" value={form.sexe} onChange={v=>setF({...form,sexe:v})} options={[{v:"M",l:"Homme"},{v:"F",l:"Femme"},{v:"X",l:"Non-binaire"}]}/>
        <I label="Statut" value={form.statut} onChange={v=>setF({...form,statut:v})} options={[{v:"employe",l:"Employé"},{v:"ouvrier",l:"Ouvrier"},{v:"etudiant",l:"Étudiant"},{v:"apprenti",l:"Apprenti"},{v:"dirigeant",l:"Dirigeant d\'entreprise"}]}/>
        <I label="Adresse" value={form.addr} onChange={v=>setF({...form,addr:v})} span={2}/>
        <I label="CP" value={form.zip} onChange={v=>setF({...form,zip:v})}/>
        <I label="Ville" value={form.city} onChange={v=>setF({...form,city:v})}/>
        <div>
          <I label="IBAN" value={form.iban} onChange={onIbanChange}/>
          {ibanCheck&&<div style={{fontSize:10,marginTop:2,color:ibanCheck.valid?'#4ade80':'#f87171'}}>{ibanCheck.msg}</div>}
        </div>
        <I label="Niveau d'études" value={form.niveauEtude} onChange={v=>setF({...form,niveauEtude:v})} options={[{v:"prim",l:"Primaire"},{v:"sec_inf",l:"Secondaire inférieur"},{v:"sec",l:"Secondaire supérieur"},{v:"sup",l:"Supérieur non-universitaire (bachelier)"},{v:"univ",l:"Universitaire (master/doctorat)"}]}/>
      </div>
      <ST>Contrat</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10}}>
        <I label="Fonction" value={form.fn} onChange={v=>setF({...form,fn:v})}/>
        <I label="Département" value={form.dept} onChange={v=>setF({...form,dept:v})}/>
        <I label="Entrée" type="date" value={form.startD} onChange={v=>setF({...form,startD:v})}/>
        <I label="Contrat" value={form.contract} onChange={v=>setF({...form,contract:v})} options={[
          {v:"CDI",l:"CDI"},{v:"CDD",l:"CDD"},{v:"trav_det",l:"Travail nettement défini"},{v:"remplacement",l:"Remplacement"},
          {v:"tpartiel",l:"Temps partiel"},{v:"interim",l:"Intérimaire"},{v:"student",l:"Étudiant (650h)"},
          {v:"flexi",l:"Flexi-job"},{v:"saisonnier",l:"Saisonnier"},{v:"occas_horeca",l:"Extra Horeca"},
          {v:"titre_service",l:"Titres-services"},{v:"art60",l:"Art. 60§7 (CPAS)"},{v:"CIP",l:"Convention immersion"},
          {v:"alternance",l:"Alternance"},{v:"CPE",l:"Premier emploi"},{v:"ETA",l:"Travail adapté"},
          {v:"detache",l:"Détaché"},{v:"domestique",l:"Domestique"},{v:"teletravail",l:"Télétravail struct."},
          {v:"domicile",l:"Travail à domicile"},{v:"indep_princ",l:"Indép. principal"},
          {v:"indep_compl",l:"Indép. complémentaire"},{v:"mandataire",l:"Mandataire société"},
          {v:"freelance",l:"Freelance/Consultant"},{v:"smart",l:"Smart (portage)"},
          {v:"volontariat",l:"Volontariat"},{v:"artiste",l:"Artiste (ATA)"},{v:"sportif",l:"Sportif rémunéré"},
          {v:"plateforme",l:"Économie plateforme"}
        ]}/>
        <I label="H/sem" type="number" value={form.whWeek} onChange={v=>setF({...form,whWeek:v})}/>
        <I label="CP" value={form.cp} onChange={onCPChange} options={Object.entries(LEGAL.CP).map(([k,v])=>({v:k,l:v}))}/>
        <I label="Code DMFA" value={form.dmfaCode} onChange={v=>setF({...form,dmfaCode:v})} options={Object.entries(LEGAL.DMFA_CODES).map(([k,v])=>({v:k,l:`${k} - ${v}`}))}/>
        <I label="Rang engagement" value={form.nrEngagement||0} onChange={v=>setF({...form,nrEngagement:parseInt(v)||0})} options={[{v:0,l:"— Pas de réduction —"},{v:1,l:"1er employé (exo totale)"},{v:2,l:"2è employé"},{v:3,l:"3è employé"},{v:4,l:"4è employé"},{v:5,l:"5è employé"},{v:6,l:"6è employé"}]}/>
        {form.nrEngagement>0&&<I label="Trimestre depuis eng." type="number" value={form.engagementTrimestre||1} onChange={v=>setF({...form,engagementTrimestre:parseInt(v)||1})}/>}
      </div>
      <ST>Grille horaire (Loi 16/03/1971 + Règlement de travail)</ST>
      <div style={{padding:10,background:"rgba(198,163,78,.03)",borderRadius:8,border:'1px solid rgba(198,163,78,.08)'}}>
        <div style={{display:'flex',gap:6,marginBottom:8,alignItems:'center'}}>
          <span style={{fontSize:11,color:'#9e9b93',fontWeight:600,width:70}}>Fraction:</span>
          <span style={{fontSize:13,fontWeight:700,color:(form.whWeek||38)>=38?'#4ade80':'#fb923c'}}>{Math.round((form.whWeek||38)/38*100)}%</span>
          <span style={{fontSize:10.5,color:'#5e5c56',marginLeft:6}}>({form.whWeek||38}h / 38h réf.) — {(form.whWeek||38)>=38?'Temps plein':'Temps partiel'}</span>
          <span style={{fontSize:10.5,color:'#5e5c56',marginLeft:'auto'}}>{((form.whWeek||38)/5).toFixed(2)}h/jour · Pause: 30min (si {'>'} 6h)</span>
        </div>
        <table style={{width:'100%',borderCollapse:'collapse',fontSize:11}}>
          <thead><tr style={{borderBottom:'1px solid rgba(198,163,78,.15)'}}>
            {['',"Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Total"].map(h=><th key={h} style={{padding:'4px 6px',fontSize:10,color:'#9e9b93',textAlign:'center',fontWeight:600}}>{h}</th>)}
          </tr></thead>
          <tbody>
            <tr>
              <td style={{padding:'4px 6px',fontSize:10,color:'#9e9b93'}}>Début</td>
              {['lu',"ma","me","je","ve","sa"].map(d=><td key={d}><input type="time" defaultValue={d==='sa'?'':'09:00'} style={{width:'100%',background:"rgba(198,163,78,.05)",border:'1px solid rgba(198,163,78,.1)',borderRadius:4,padding:'3px 4px',fontSize:10,color:'#e8e6e0',textAlign:'center'}} onChange={e=>setF({...form,[`h_${d}_de`]:e.target.value})}/></td>)}
              <td rowSpan={2} style={{textAlign:'center',verticalAlign:'middle'}}>
                <div style={{fontSize:16,fontWeight:700,color:'#c6a34e'}}>{form.whWeek||38}h</div>
                <div style={{fontSize:9,color:'#5e5c56'}}>/semaine</div>
              </td>
            </tr>
            <tr>
              <td style={{padding:'4px 6px',fontSize:10,color:'#9e9b93'}}>Fin</td>
              {['lu',"ma","me","je","ve","sa"].map(d=><td key={d}><input type="time" defaultValue={d==='sa'?'':'17:36'} style={{width:'100%',background:"rgba(198,163,78,.05)",border:'1px solid rgba(198,163,78,.1)',borderRadius:4,padding:'3px 4px',fontSize:10,color:'#e8e6e0',textAlign:'center'}} onChange={e=>setF({...form,[`h_${d}_a`]:e.target.value})}/></td>)}
            </tr>
          </tbody>
        </table>
        <div style={{marginTop:8,fontSize:9.5,color:'#5e5c56',lineHeight:1.5}}>
          ⏱ <b>Temps plein</b> = 38h/sem (Art. 19 Loi 16/03/1971). <b>Temps partiel</b> = min. 1/3 temps plein (≥12h40). Horaire variable possible (Art. 11bis). Dérogation samedi/dimanche = CCT sectorielle ou accord d'entreprise.
        </div>
      </div>
      <ST>Rémunération</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10}}>
        <I label="Brut mensuel (€)" type="number" value={form.monthlySalary} onChange={v=>setF({...form,monthlySalary:v})}/>
        <I label="CR total (€)" type="number" value={form.mvT} onChange={v=>setF({...form,mvT:v})}/>
        <I label="CR part trav. (€)" type="number" value={form.mvW} onChange={v=>setF({...form,mvW:v})}/>
        <I label="CR part empl. (€)" type="number" value={form.mvE} onChange={v=>setF({...form,mvE:v})}/>
        <I label="Frais propres (€)" type="number" value={form.expense} onChange={v=>setF({...form,expense:v})}/>
        <I label="Transport domicile-travail" value={form.commType} onChange={v=>setF({...form,commType:v})} options={[{v:"none",l:"Aucun"},{v:"train",l:"🚆 Train (SNCB)"},{v:"bus",l:"🚌 Bus/Tram/Métro (STIB/TEC/De Lijn)"},{v:"bike",l:"🚲 Vélo"},{v:"car",l:"🚗 Voiture privée"},{v:"carpool",l:"🚗 Covoiturage"},{v:"mixed",l:"🔄 Combiné (train+autre)"},{v:"company_car",l:"🏢 Voiture de société (pas d\'interv.)"}]}/>
        {form.commType!=='none'&&form.commType!=='company_car'&&<I label="Distance simple (km)" type="number" value={form.commDist} onChange={v=>setF({...form,commDist:v})}/>}
        {(form.commType==='train'||form.commType==='bus'||form.commType==='mixed')&&<I label="Abonnement mensuel (€)" type="number" value={form.commMonth} onChange={v=>setF({...form,commMonth:v})}/>}
      </div>
      {form.commType!=='none'&&form.commType!=='company_car'&&<div style={{marginTop:8,padding:10,background:"rgba(96,165,250,.04)",borderRadius:8,fontSize:10.5,color:'#60a5fa',lineHeight:1.6}}>
        {form.commType==='train'&&'🚆 Train SNCB: intervention employeur obligatoire = 75% de l\'abonnement (CCT 19/9). Exonéré ONSS et IPP.'}
        {form.commType==='bus'&&'🚌 Transport en commun: intervention obligatoire = prix abonnement SNCB pour même distance (CCT 19/9). Exonéré ONSS et IPP.'}
        {form.commType==='bike'&&`🚲 Vélo: indemnité ${form.commDist>0?((form.commDist*2*0.27).toFixed(2)+'€/jour = '):''}0,27 €/km A/R (2026). Exonéré ONSS et IPP (max 0,27€/km). Cumulable avec transport en commun.`}
        {form.commType==='car'&&`🚗 Voiture privée: pas d'obligation légale (sauf CCT sectorielle). Si intervention: exonéré ONSS jusqu'à 490€/an. Distance: ${form.commDist||0} km × 2 = ${(form.commDist||0)*2} km A/R.`}
        {form.commType==='carpool'&&'🚗 Covoiturage: mêmes règles que voiture privée pour le conducteur. Passager = indemnité possible exonérée.'}
        {form.commType==='mixed'&&'🔄 Combiné: cumul possible train + vélo ou train + voiture. Chaque trajet est indemnisé séparément selon son mode.'}
      </div>}
      <ST>Véhicule de société (ATN)</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10}}>
        <I label="Carburant" value={form.carFuel} onChange={v=>setF({...form,carFuel:v})} options={[{v:"none",l:"Pas de véhicule"},{v:"essence",l:"Essence"},{v:"diesel",l:"Diesel"},{v:"lpg",l:"LPG/CNG"},{v:"electrique",l:"Électrique"},{v:"hybride",l:"Hybride PHEV"}]}/>
        <I label="CO2 g/km" type="number" value={form.carCO2} onChange={v=>setF({...form,carCO2:v})}/>
        <I label="Valeur catalogue (€)" type="number" value={form.carCatVal} onChange={v=>setF({...form,carCatVal:v})}/>
        <I label="Marque" value={form.carBrand} onChange={v=>setF({...form,carBrand:v})} options={[
          {v:"",l:"— Sélectionner —"},{v:"Aiways",l:"Aiways"},{v:"Alfa Romeo",l:"Alfa Romeo"},{v:"Alpine",l:"Alpine"},{v:"Aston Martin",l:"Aston Martin"},
          {v:"Audi",l:"Audi"},{v:"Bentley",l:"Bentley"},{v:"BMW",l:"BMW"},{v:"BYD",l:"BYD"},{v:"Cadillac",l:"Cadillac"},
          {v:"Chevrolet",l:"Chevrolet"},{v:"Chrysler",l:"Chrysler"},{v:"Citroën",l:"Citroën"},{v:"Cupra",l:"Cupra"},{v:"Dacia",l:"Dacia"},
          {v:"Dodge",l:"Dodge"},{v:"DS",l:"DS Automobiles"},{v:"Ferrari",l:"Ferrari"},{v:"Fiat",l:"Fiat"},{v:"Ford",l:"Ford"},
          {v:"Genesis",l:"Genesis"},{v:"Honda",l:"Honda"},{v:"Hyundai",l:"Hyundai"},{v:"Infiniti",l:"Infiniti"},{v:"Isuzu",l:"Isuzu"},
          {v:"Jaguar",l:"Jaguar"},{v:"Jeep",l:"Jeep"},{v:"Kia",l:"Kia"},{v:"Lamborghini",l:"Lamborghini"},{v:"Land Rover",l:"Land Rover"},
          {v:"Lexus",l:"Lexus"},{v:"Lotus",l:"Lotus"},{v:"Lynk & Co",l:"Lynk & Co"},{v:"Maserati",l:"Maserati"},{v:"Mazda",l:"Mazda"},
          {v:"McLaren",l:"McLaren"},{v:"Mercedes",l:"Mercedes-Benz"},{v:"MG",l:"MG"},{v:"Mini",l:"Mini"},{v:"Mitsubishi",l:"Mitsubishi"},
          {v:"NIO",l:"NIO"},{v:"Nissan",l:"Nissan"},{v:"Opel",l:"Opel"},{v:"Peugeot",l:"Peugeot"},{v:"Polestar",l:"Polestar"},
          {v:"Porsche",l:"Porsche"},{v:"Renault",l:"Renault"},{v:"Rolls-Royce",l:"Rolls-Royce"},{v:"Seat",l:"Seat"},{v:"Škoda",l:"Škoda"},
          {v:"Smart",l:"Smart"},{v:"SsangYong",l:"SsangYong"},{v:"Subaru",l:"Subaru"},{v:"Suzuki",l:"Suzuki"},{v:"Tesla",l:"Tesla"},
          {v:"Toyota",l:"Toyota"},{v:"Volkswagen",l:"Volkswagen"},{v:"Volvo",l:"Volvo"},{v:"XPeng",l:"XPeng"},{v:"Autre",l:"Autre"}
        ]}/>
        <I label="Modèle" value={form.carModel} onChange={v=>setF({...form,carModel:v})} options={[
          {v:"",l:"— Sélectionner —"},...((CAR_MODELS[form.carBrand]||[]).map(m=>({v:m,l:m}))),{v:"_autre",l:"Autre modèle"}
        ]}/>
      </div>
      <ST>Avantages en nature (ATN)</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10}}>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>📱 GSM/Téléphone (36€/an)</div>
          <div onClick={()=>setF({...form,atnGSM:!form.atnGSM})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.atnGSM?'rgba(198,163,78,.15)':'rgba(198,163,78,.04)',color:form.atnGSM?'#c6a34e':'#5e5c56',border:'1px solid '+(form.atnGSM?'rgba(198,163,78,.3)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.atnGSM?'✅ OUI — 3,00 €/mois':'❌ NON'}
          </div>
        </div>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>💻 PC/Tablette (72€/an)</div>
          <div onClick={()=>setF({...form,atnPC:!form.atnPC})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.atnPC?'rgba(198,163,78,.15)':'rgba(198,163,78,.04)',color:form.atnPC?'#c6a34e':'#5e5c56',border:'1px solid '+(form.atnPC?'rgba(198,163,78,.3)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.atnPC?'✅ OUI — 6,00 €/mois':'❌ NON'}
          </div>
        </div>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>🌐 Internet privé (60€/an)</div>
          <div onClick={()=>setF({...form,atnInternet:!form.atnInternet})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.atnInternet?'rgba(198,163,78,.15)':'rgba(198,163,78,.04)',color:form.atnInternet?'#c6a34e':'#5e5c56',border:'1px solid '+(form.atnInternet?'rgba(198,163,78,.3)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.atnInternet?'✅ OUI — 5,00 €/mois':'❌ NON'}
          </div>
        </div>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>🏠 Logement gratuit (RC × coeff.)</div>
          <div onClick={()=>setF({...form,atnLogement:!form.atnLogement})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.atnLogement?'rgba(198,163,78,.15)':'rgba(198,163,78,.04)',color:form.atnLogement?'#c6a34e':'#5e5c56',border:'1px solid '+(form.atnLogement?'rgba(198,163,78,.3)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.atnLogement?'✅ OUI':'❌ NON'}
          </div>
        </div>
        {form.atnLogement&&<I label="RC logement (€)" type="number" value={form.atnLogementRC} onChange={v=>setF({...form,atnLogementRC:v})}/>}
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>🔥 Chauffage gratuit (2.130€/an)</div>
          <div onClick={()=>setF({...form,atnChauffage:!form.atnChauffage})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.atnChauffage?'rgba(198,163,78,.15)':'rgba(198,163,78,.04)',color:form.atnChauffage?'#c6a34e':'#5e5c56',border:'1px solid '+(form.atnChauffage?'rgba(198,163,78,.3)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.atnChauffage?'✅ OUI — 177,50 €/mois':'❌ NON'}
          </div>
        </div>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>⚡ Électricité gratuite (1.060€/an)</div>
          <div onClick={()=>setF({...form,atnElec:!form.atnElec})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.atnElec?'rgba(198,163,78,.15)':'rgba(198,163,78,.04)',color:form.atnElec?'#c6a34e':'#5e5c56',border:'1px solid '+(form.atnElec?'rgba(198,163,78,.3)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.atnElec?'✅ OUI — 88,33 €/mois':'❌ NON'}
          </div>
        </div>
      </div>
      <ST>Vélo de société & Mobilité verte</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>🚲 Vélo de société (leasing)</div>
          <div onClick={()=>setF({...form,veloSociete:!form.veloSociete})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.veloSociete?'rgba(74,222,128,.15)':'rgba(198,163,78,.04)',color:form.veloSociete?'#4ade80':'#5e5c56',border:'1px solid '+(form.veloSociete?'rgba(74,222,128,.3)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.veloSociete?'✅ OUI — ATN = 0€ (exonéré depuis 2024)':'❌ NON'}
          </div>
        </div>
        {form.veloSociete&&<I label="Type de vélo" value={form.veloType||'none'} onChange={v=>setF({...form,veloType:v})} options={[{v:"classique",l:"🚲 Vélo classique"},{v:"electrique",l:"⚡ Vélo électrique (≤25km/h)"},{v:"speed_pedelec",l:"🏎 Speed pedelec (≤45km/h)"}]}/>}
        {form.veloSociete&&<I label="Valeur catalogue (€)" type="number" value={form.veloValeur} onChange={v=>setF({...form,veloValeur:v})}/>}
        {form.veloSociete&&<I label="Leasing mensuel (€)" type="number" value={form.veloLeasingMois} onChange={v=>setF({...form,veloLeasingMois:v})}/>}
      </div>
      {form.veloSociete&&<div style={{marginTop:8,padding:10,background:"rgba(74,222,128,.04)",borderRadius:8,fontSize:10.5,color:'#4ade80',lineHeight:1.6}}>
        🚲 <b>Vélo de société</b> — ATN = 0€ (Art. 38§1er 14°a CIR — exonéré ONSS et IPP depuis 01/01/2024). Leasing vélo déductible 100% pour l'employeur. Cumulable avec l'indemnité vélo 0,27€/km. Le speed pedelec est assimilé à un vélo.
      </div>}
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginTop:10}}>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>⛽ Carte carburant / recharge</div>
          <div onClick={()=>setF({...form,carteCarburant:!form.carteCarburant})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.carteCarburant?'rgba(251,146,60,.12)':'rgba(198,163,78,.04)',color:form.carteCarburant?'#fb923c':'#5e5c56',border:'1px solid '+(form.carteCarburant?'rgba(251,146,60,.25)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.carteCarburant?'✅ OUI':'❌ NON'}
          </div>
        </div>
        {form.carteCarburant&&<I label="Budget mensuel carte (€)" type="number" value={form.carteCarburantMois} onChange={v=>setF({...form,carteCarburantMois:v})}/>}
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>🔌 Borne de recharge domicile</div>
          <div onClick={()=>setF({...form,borneRecharge:!form.borneRecharge})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.borneRecharge?'rgba(96,165,250,.12)':'rgba(198,163,78,.04)',color:form.borneRecharge?'#60a5fa':'#5e5c56',border:'1px solid '+(form.borneRecharge?'rgba(96,165,250,.25)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.borneRecharge?'✅ OUI — installée au domicile':'❌ NON'}
          </div>
        </div>
        {form.borneRecharge&&<I label="Coût mensuel borne+élec (€)" type="number" value={form.borneRechargeCoût} onChange={v=>setF({...form,borneRechargeCoût:v})}/>}
      </div>
      {form.carteCarburant&&!form.carFuel!=='none'&&<div style={{marginTop:8,padding:10,background:"rgba(251,146,60,.04)",borderRadius:8,fontSize:10.5,color:'#fb923c',lineHeight:1.6}}>
        ⚠ <b>Carte carburant sans voiture de société</b> — L'avantage est imposable à 100% (ATN = montant total de la carte). Si voiture de société: inclus dans l'ATN voiture (Art. 36§2 CIR).
      </div>}
      <ST>Travailleur frontalier (Règl. 883/2004)</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>🌍 Travailleur frontalier</div>
          <div onClick={()=>setF({...form,frontalier:!form.frontalier})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.frontalier?'rgba(168,85,247,.12)':'rgba(198,163,78,.04)',color:form.frontalier?'#a855f7':'#5e5c56',border:'1px solid '+(form.frontalier?'rgba(168,85,247,.25)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.frontalier?'✅ OUI — Réside hors Belgique':'❌ NON — Réside en Belgique'}
          </div>
        </div>
        {form.frontalier&&<I label="Pays de résidence" value={form.frontalierPays||''} onChange={v=>setF({...form,frontalierPays:v})} options={[{v:"FR",l:"🇫🇷 France"},{v:"NL",l:"🇳🇱 Pays-Bas"},{v:"DE",l:"🇩🇪 Allemagne"},{v:"LU",l:"🇱🇺 Luxembourg"}]}/>}
      </div>
      {form.frontalier&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginTop:8}}>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>Formulaire A1 (détachement)</div>
          <div onClick={()=>setF({...form,frontalierA1:!form.frontalierA1})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.frontalierA1?'rgba(96,165,250,.12)':'rgba(198,163,78,.04)',color:form.frontalierA1?'#60a5fa':'#5e5c56',border:'1px solid '+(form.frontalierA1?'rgba(96,165,250,.25)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.frontalierA1?'✅ A1 en cours':"❌ Pas d'A1"}
          </div>
        </div>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>Exonération PP (ancien régime FR)</div>
          <div onClick={()=>setF({...form,frontalierExoPP:!form.frontalierExoPP})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.frontalierExoPP?'rgba(239,68,68,.12)':'rgba(198,163,78,.04)',color:form.frontalierExoPP?'#ef4444':'#5e5c56',border:'1px solid '+(form.frontalierExoPP?'rgba(239,68,68,.25)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.frontalierExoPP?'✅ Exonéré PP (très rare)':'❌ PP retenu en Belgique (normal)'}
          </div>
        </div>
      </div>}
      {form.frontalier&&<div style={{marginTop:8,padding:10,background:"rgba(168,85,247,.04)",borderRadius:8,fontSize:10.5,color:'#a855f7',lineHeight:1.6}}>
        🌍 <b>Frontalier {form.frontalierPays==='FR'?'France':form.frontalierPays==='NL'?'Pays-Bas':form.frontalierPays==='DE'?'Allemagne':form.frontalierPays==='LU'?'Luxembourg':''}</b><br/>
        {form.frontalierPays==='FR'&&'• Convention CPDI BE-FR 10/03/1964. Ancien régime frontalier abrogé 01/01/2012. PP retenu en Belgique. Le travailleur déclare en France avec crédit d\'impôt. Formulaire 276 Front.'}
        {form.frontalierPays==='NL'&&'• Convention CPDI BE-NL 05/06/2001. PP retenu en Belgique. Exemption avec progression aux Pays-Bas. Option: kwalificerend buitenlands belastingplichtige.'}
        {form.frontalierPays==='DE'&&'• Convention CPDI BE-DE 11/04/1967. PP retenu en Belgique. Crédit d\'impôt en Allemagne. Pas de régime frontalier spécial.'}
        {form.frontalierPays==='LU'&&'• Convention CPDI BE-LU 17/09/1970. PP retenu en Belgique. Tolérance 24j/an de télétravail depuis le Luxembourg (accord amiable 2015).'}
        <br/>• ONSS: toujours belge (lex loci laboris — Art. 11 Règl. 883/2004).
        • Limosa: pas nécessaire (le travailleur réside à l'étranger mais travaille en BE avec contrat BE).
      </div>}
      <ST>Travailleur pensionné (Cumul pension-travail)</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>👴 Pensionné en activité</div>
          <div onClick={()=>setF({...form,pensionné:!form.pensionné})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.pensionné?'rgba(251,191,36,.15)':'rgba(198,163,78,.04)',color:form.pensionné?'#fbbf24':'#5e5c56',border:'1px solid '+(form.pensionné?'rgba(251,191,36,.3)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.pensionné?'✅ OUI — Bénéficiaire d\'une pension':'❌ NON'}
          </div>
        </div>
        {form.pensionné&&<I label="Type de pension" value={form.pensionType||'none'} onChange={v=>setF({...form,pensionType:v})} options={[{v:"legal",l:"🏛 Pension légale (âge légal)"},{v:"anticipee",l:"⏰ Pension anticipée"},{v:"survie",l:"💐 Pension de survie"},{v:"invalidite",l:"♿ Pension d\'invalidité"}]}/>}
      </div>
      {form.pensionné&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10,marginTop:8}}>
        <I label="Âge" type="number" value={form.pensionAge} onChange={v=>setF({...form,pensionAge:parseInt(v)||0})}/>
        <I label="Années de carrière" type="number" value={form.pensionCarriere} onChange={v=>setF({...form,pensionCarriere:parseInt(v)||0})}/>
        <I label="Pension mensuelle (€)" type="number" value={form.pensionMontant} onChange={v=>setF({...form,pensionMontant:v})}/>
      </div>}
      {form.pensionné&&<div style={{marginTop:8,padding:10,background:"rgba(251,191,36,.04)",borderRadius:8,fontSize:10.5,color:'#fbbf24',lineHeight:1.7}}>
        👴 <b>Cumul pension-travail</b><br/>
        {(form.pensionType==='legal'&&(form.pensionAge||0)>=66)||
         (form.pensionType==='anticipee'&&(form.pensionCarriere||0)>=45)||
         (form.pensionType==='survie'&&(form.pensionAge||0)>=65)
          ?<><span style={{color:'#4ade80',fontWeight:700}}>✅ CUMUL ILLIMITÉ</span> — {form.pensionType==='legal'?'Âge légal 66 ans atteint (AR 20/12/2006)':form.pensionType==='anticipee'?'45 ans de carrière atteints':'Pension de survie ≥ 65 ans'}. Aucun plafond de revenus. Flexi-job: plafond 12.000€ ne s'applique PAS.<br/></>
          :<><span style={{color:'#ef4444',fontWeight:700}}>⚠ CUMUL LIMITÉ</span> — Plafonds annuels bruts ({(form.depChildren||0)>0?'avec':'sans'} enfant à charge):<br/>
            {form.pensionType==='anticipee'&&`• Anticipée: ${(form.depChildren||0)>0?'13.266':'10.613'}€/an brut`}
            {form.pensionType==='survie'&&`• Survie: ${(form.depChildren||0)>0?'28.136':'22.509'}€/an brut`}
            {form.pensionType==='invalidite'&&'• Invalidité: plafonds spécifiques INAMI'}
            <br/>Dépassement = pension réduite du % de dépassement (Art. 64 AR 21/12/1967).<br/></>}
        • ONSS: normal (13,07% travailleur + taux patronal). Pas d'exonération.<br/>
        • PP: barème normal. La pension est imposée séparément par le SFP.<br/>
        • DmfA: déclaration normale. SIGEDIS/SFP vérifie le cumul automatiquement.
      </div>}
      <ST>Situation familiale</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10}}>
        <I label="Situation" value={form.civil} onChange={v=>setF({...form,civil:v})} options={[{v:"single",l:"Isolé"},{v:"married_2",l:"Marié (2 revenus)"},{v:"married_1",l:"Marié (1 revenu)"},{v:"cohabit",l:"Cohabitant légal"}]}/>
        <I label="Enfants à charge" type="number" value={form.depChildren} onChange={v=>setF({...form,depChildren:v})}/>
        <I label="Enfants handicapés" type="number" value={form.handiChildren} onChange={v=>setF({...form,handiChildren:v})}/>
        <I label="Ascendants ≥65 ans à charge" type="number" value={form.depAscendant} onChange={v=>setF({...form,depAscendant:v})}/>
        <I label="Ascendants ≥65 handi." type="number" value={form.depAscendantHandi} onChange={v=>setF({...form,depAscendantHandi:v})}/>
        <I label="Autres pers. à charge" type="number" value={form.depAutres} onChange={v=>setF({...form,depAutres:v})}/>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginTop:8}}>
        <div><div style={{fontSize:10.5,color:'#9e9b93',marginBottom:4}}>Conjoint handicapé (Art.132 CIR)</div>
          <div onClick={()=>setF({...form,conjointHandicap:!form.conjointHandicap})} style={{padding:'8px 12px',borderRadius:6,cursor:'pointer',fontSize:11,
            background:form.conjointHandicap?'rgba(248,113,113,.12)':'rgba(198,163,78,.04)',color:form.conjointHandicap?'#f87171':'#5e5c56',border:'1px solid '+(form.conjointHandicap?'rgba(248,113,113,.25)':'rgba(198,163,78,.1)'),textAlign:'center'}}>
            {form.conjointHandicap?'✅ OUI — réduction supplémentaire':'❌ NON'}
          </div>
        </div>
      </div>
      <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:20}}>
        <B v="outline" onClick={()=>{setF(null);setEd(false);}}>Annuler</B>
        <B onClick={save}>{ed?'Mettre à jour':'Enregistrer'}</B>
      </div>
    </C>}
    {/* GRID VIEW */}
    {viewMode==='grid'&&<div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:12}}>
      {filtered.map((r,i)=>{const p=calc(r,DPER,s.co);return(
        <C key={r.id} style={{padding:'18px 16px',cursor:'pointer',transition:'all .15s',position:'relative',overflow:'hidden'}} 
          onClick={()=>{setF({...r});setEd(true);}}
          onMouseEnter={e=>e.currentTarget.style.borderColor='rgba(198,163,78,.25)'}
          onMouseLeave={e=>e.currentTarget.style.borderColor='rgba(139,115,60,.12)'}>
          <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:12}}>
            <div style={{width:40,height:40,borderRadius:10,background:`linear-gradient(135deg,${['#c6a34e',"#60a5fa","#a78bfa","#4ade80","#fb923c","#06b6d4"][i%6]}25,${['#c6a34e',"#60a5fa","#a78bfa","#4ade80","#fb923c","#06b6d4"][i%6]}08)`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,fontWeight:700,color:['#c6a34e',"#60a5fa","#a78bfa","#4ade80","#fb923c","#06b6d4"][i%6]}}>{(r.first||'')[0]}{(r.last||'')[0]}</div>
            <div style={{flex:1}}>
              <div style={{fontSize:13.5,fontWeight:600,color:'#e8e6e0'}}>{r.first} {r.last}</div>
              <div style={{fontSize:10.5,color:'#5e5c56'}}>{r.fn||'—'}</div>
            </div>
            <span style={{fontSize:8.5,padding:'2px 7px',borderRadius:4,fontWeight:600,
              background:r.status==='sorti'?'rgba(248,113,113,.12)':r.contract==='student'?'rgba(251,146,60,.12)':r.statut==='ouvrier'?'rgba(251,146,60,.1)':'rgba(96,165,250,.08)',
              color:r.status==='sorti'?'#f87171':r.contract==='student'?'#fb923c':r.statut==='ouvrier'?'#fb923c':'#60a5fa',
            }}>{r.status==='sorti'?'SORTI':r.contract==='student'?'ÉTUDIANT':r.statut==='ouvrier'?'OUVRIER':'EMPLOYÉ'}</span>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,fontSize:11}}>
            <div><span style={{color:'#5e5c56'}}>CP:</span> <span style={{color:'#d4d0c8'}}>{r.cp}</span></div>
            <div><span style={{color:'#5e5c56'}}>Contrat:</span> <span style={{color:'#d4d0c8'}}>{r.contract}</span></div>
            <div><span style={{color:'#5e5c56'}}>Brut:</span> <span style={{color:'#c6a34e',fontWeight:600}}>{fmt(r.monthlySalary)}</span></div>
            <div><span style={{color:'#5e5c56'}}>Net:</span> <span style={{color:'#4ade80',fontWeight:600}}>{fmt(p.net)}</span></div>
          </div>
          <div style={{marginTop:10,display:'flex',gap:6,justifyContent:'flex-end'}}>
            <B v="ghost" style={{padding:'4px 8px',fontSize:10}} onClick={e=>{e.stopPropagation();setF({...r});setEd(true);}}>✎ Modifier</B>
            <B v="danger" style={{padding:'4px 8px',fontSize:10}} onClick={e=>{e.stopPropagation();if(confirm('Supprimer ?'))d({type:"DEL_E",id:r.id});}}>✕</B>
          </div>
        </C>
      );})}
    </div>}
    {/* LIST VIEW */}
    {viewMode==='list'&&<C style={{padding:0,overflow:'hidden'}}>
      <Tbl cols={[
        {k:'n',l:"Employé",r:r=><div style={{display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:30,height:30,borderRadius:7,background:"rgba(198,163,78,.06)",display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,fontWeight:700,color:'#c6a34e'}}>{(r.first||'')[0]}{(r.last||'')[0]}</div>
          <div><div style={{fontWeight:500}}>{r.first} {r.last} <span style={{fontSize:8.5,padding:'1px 5px',borderRadius:3,fontWeight:600,background:r.status==='sorti'?'rgba(248,113,113,.12)':r.contract==='student'?'rgba(251,146,60,.12)':r.statut==='ouvrier'?'rgba(251,146,60,.1)':'rgba(96,165,250,.08)',color:r.status==='sorti'?'#f87171':r.contract==='student'?'#fb923c':r.statut==='ouvrier'?'#fb923c':'#60a5fa',marginLeft:4}}>{r.status==='sorti'?'SORTI':r.contract==='student'?'ÉTU':r.statut==='ouvrier'?'OUV':'EMPL'}</span></div><div style={{fontSize:10.5,color:'#5e5c56'}}>{r.niss} · {r.sexe==='F'?'♀':'♂'}</div></div>
        </div>},
        {k:'f',l:"Fonction",r:r=><div>{r.fn}<div style={{fontSize:10.5,color:'#5e5c56'}}>{r.dept}</div></div>},
        {k:'c',l:"Contrat",r:r=><span style={{fontSize:12}}>{r.contract} · {r.whWeek}h</span>},
        {k:'cp',l:"CP",r:r=>r.cp},
        {k:'g',l:"Brut",a:'right',r:r=><span style={{fontWeight:600}}>{fmt(r.monthlySalary)}</span>},
        {k:'ne',l:"Net",a:'right',r:r=><span style={{fontWeight:600,color:'#4ade80'}}>{fmt(calc(r,DPER,s.co).net)}</span>},
        {k:'co',l:"Coût",a:'right',r:r=><span style={{color:'#a78bfa'}}>{fmt(calc(r,DPER,s.co).costTotal)}</span>},
        {k:'a',l:"",a:'right',r:r=><div style={{display:'flex',gap:5,justifyContent:'flex-end'}}>
          <B v="ghost" style={{padding:'4px 8px',fontSize:10}} onClick={e=>{e.stopPropagation();setF({...r});setEd(true);}}>✎</B>
          <B v="danger" style={{padding:'4px 8px',fontSize:10}} onClick={e=>{e.stopPropagation();if(confirm('Supprimer ?'))d({type:"DEL_E",id:r.id});}}>✕</B>
        </div>},
      ]} data={filtered}/>
    </C>}
    {filtered.length===0&&search&&<div style={{textAlign:'center',padding:40,color:'#5e5c56',fontSize:13}}>Aucun employé trouvé pour "{search}"</div>}
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  PAYSLIPS
// ═══════════════════════════════════════════════════════════════
function Payslips({s,d}) {
  const [eid,setEid]=useState((s.emps||[])[0]?.id||'');
  const [per,setPer]=useState({...DPER});
  const [res,setRes]=useState(null);
  const [batchMode,setBatchMode]=useState(false);
  const [batchResults,setBatchResults]=useState([]);
  const [batchRunning,setBatchRunning]=useState(false);
  const emp=(s.emps||[]).find(e=>e.id===eid);

  // ── BATCH PROCESSING ──
  const runBatch=()=>{
    setBatchRunning(true);
    const ae=(s.emps||[]).filter(e=>e.status==='active'||!e.status);
    const results=[];
    for(const emp of ae){
      try{
        const r=calc(emp,per,s.co);
        d({type:"ADD_P",d:{eid:emp.id,ename:`${emp.first} ${emp.last}`,period:`${MN[per.month-1]} ${per.year}`,month:per.month,year:per.year,...r,at:new Date().toISOString(),batch:true}});
        results.push({emp,r,ok:true});
      }catch(e){
        results.push({emp,error:e.message,ok:false});
      }
    }
    setBatchResults(results);
    setBatchRunning(false);
    const ok=results.filter(r=>r.ok).length;
    const fail=results.filter(r=>!r.ok).length;
    alert(`✅ Batch terminé: ${ok} fiches calculées${fail>0?`, ${fail} erreurs`:''}`);
  };

  const gen=()=>{if(!emp)return;const r=calc(emp,per,s.co);setRes(r);
    d({type:"ADD_P",d:{eid:emp.id,ename:`${emp.first} ${emp.last}`,period:`${MN[per.month-1]} ${per.year}`,month:per.month,year:per.year,...r,at:new Date().toISOString()}});};

  const PR=({l,rate,a,bold,neg,pos,sub})=><tr>
    <td style={{padding:'5px 0',fontWeight:bold?700:400,fontSize:sub?10.5:12,color:sub?'#999':'#333',fontStyle:sub?'italic':'normal'}}>{l}</td>
    <td style={{textAlign:'right',padding:'5px 0',color:'#999',fontSize:10.5}}>{rate||''}</td>
    <td style={{textAlign:'right',padding:'5px 0',fontWeight:bold?700:400,color:neg?'#dc2626':pos?'#16a34a':sub?'#999':'#333'}}>{neg&&a!==0?'- ':''}{fmt(Math.abs(a||0))}</td>
  </tr>;
  const PS=({t})=><tr style={{background:"#f8f7f2"}}><td colSpan={3} style={{padding:'11px 0 5px',fontWeight:700,fontSize:10.5,color:'#c6a34e',textTransform:'uppercase',letterSpacing:'1px'}}>{t}</td></tr>;

  return <div>
    <PH title="Fiches de Paie" sub="Formule-clé SPF Finances" actions={<div style={{display:'flex',gap:8}}>
      <B v={batchMode?'gold':'outline'} onClick={()=>setBatchMode(!batchMode)} style={{fontSize:11,padding:'8px 14px'}}>{batchMode?'⚡ Mode Batch ON':'⚡ Batch'}</B>
    </div>}/>
    <div style={{marginBottom:14,padding:'10px 14px',background:'linear-gradient(135deg,rgba(198,163,78,.06),rgba(198,163,78,.02))',border:'1px solid rgba(198,163,78,.1)',borderRadius:10,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
      <div style={{fontSize:11,color:'#888'}}>⚡ Auto-génération disponible</div>
      <button onClick={()=>{if(confirm('Générer les fiches de paie pour tous les employés ?')){(s.emps||[]).forEach(e=>generatePayslipPDF(e,s.co));alert('✅ Fiches générées')}}} style={{padding:'6px 14px',borderRadius:8,border:'none',background:'#c6a34e',color:'#fff',fontSize:11,cursor:'pointer',fontWeight:600}}>⚡ Générer tout</button>
    </div>
    {/* Batch Mode */}
    {batchMode&&<C style={{marginBottom:18,border:'1px solid rgba(198,163,78,.25)'}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
        <div>
          <div style={{fontSize:15,fontWeight:600,color:'#c6a34e'}}>⚡ Batch Processing — Calcul en masse</div>
          <div style={{fontSize:11,color:'#5e5c56',marginTop:2}}>Calcule toutes les fiches de paie des travailleurs actifs en 1 clic</div>
        </div>
        <B onClick={runBatch} disabled={batchRunning} style={{fontSize:13,padding:'12px 24px'}}>
          {batchRunning?'⏳ Calcul en cours...':'⚡ Lancer le batch ('+(s.emps||[]).filter(e=>e.status==='active'||!e.status).length+' fiches)'}
        </B>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10,marginBottom:12}}>
        <I label="Mois" value={per.month} onChange={v=>setPer({...per,month:parseInt(v)})} options={MN.map((m,i)=>({v:i+1,l:m}))}/>
        <I label="Année" type="number" value={per.year} onChange={v=>setPer({...per,year:v})}/>
        <div style={{padding:12,background:'rgba(198,163,78,.06)',borderRadius:8,textAlign:'center'}}>
          <div style={{fontSize:10,color:'#9e9b93'}}>Travailleurs actifs</div>
          <div style={{fontSize:22,fontWeight:700,color:'#c6a34e'}}>{(s.emps||[]).filter(e=>e.status==='active'||!e.status).length}</div>
        </div>
      </div>
      {batchResults.length>0&&<div>
        <ST>Résultats du batch</ST>
        <div style={{maxHeight:300,overflowY:'auto'}}>
          {batchResults.map((br,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'8px 12px',borderRadius:6,marginBottom:4,background:br.ok?'rgba(74,222,128,.04)':'rgba(248,113,113,.04)',border:'1px solid '+(br.ok?'rgba(74,222,128,.1)':'rgba(248,113,113,.1)')}}>
            <span style={{fontSize:12,color:br.ok?'#4ade80':'#f87171'}}>{br.ok?'✅':'❌'} {br.emp.first} {br.emp.last}</span>
            {br.ok&&<span style={{fontSize:12,color:'#c6a34e',fontFamily:'monospace'}}>{fmt(br.r.gross)} brut → {fmt(br.r.net)} net</span>}
            {!br.ok&&<span style={{fontSize:11,color:'#f87171'}}>{br.error}</span>}
          </div>)}
        </div>
        <div style={{marginTop:8,padding:10,background:'rgba(198,163,78,.06)',borderRadius:8,display:'flex',justifyContent:'space-between'}}>
          <span style={{fontSize:12,color:'#c6a34e',fontWeight:600}}>Total masse salariale</span>
          <span style={{fontSize:14,fontWeight:700,color:'#c6a34e'}}>{fmt(batchResults.filter(r=>r.ok).reduce((a,r)=>a+r.r.gross,0))} brut → {fmt(batchResults.filter(r=>r.ok).reduce((a,r)=>a+r.r.net,0))} net</span>
        </div>
      </div>}
    </C>}
    <div style={{display:'grid',gridTemplateColumns:res?'360px 1fr':'1fr',gap:18}}>
      <C>
        <ST>Paramètres</ST>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:9}}>
          <I label="Employé" value={eid} onChange={setEid} options={(s.emps||[]).map(e=>({v:e.id,l:`${e.first||e.fn||'Emp'} ${e.last||''}`}))} span={2}/>
          <I label="Mois" value={per.month} onChange={v=>setPer({...per,month:parseInt(v)})} options={MN.map((m,i)=>({v:i+1,l:m}))}/>
          <I label="Année" type="number" value={per.year} onChange={v=>setPer({...per,year:v})}/>
          <I label="Jours prestés" type="number" value={per.days} onChange={v=>setPer({...per,days:v})}/>
          <I label="H. sup." type="number" value={per.overtimeH} onChange={v=>setPer({...per,overtimeH:v})}/>
          <I label="H. dimanche" type="number" value={per.sundayH} onChange={v=>setPer({...per,sundayH:v})}/>
          <I label="H. nuit" type="number" value={per.nightH} onChange={v=>setPer({...per,nightH:v})}/>
          <I label="Maladie (j garanti)" type="number" value={per.sickG} onChange={v=>setPer({...per,sickG:v})}/>
          <I label="Prime (€)" type="number" value={per.bonus} onChange={v=>setPer({...per,bonus:v})}/>
          <I label="13ème mois (€)" type="number" value={per.y13} onChange={v=>setPer({...per,y13:v})}/>
          <I label="Acompte (€)" type="number" value={per.advance} onChange={v=>setPer({...per,advance:v})}/>
          <I label="Saisie (€)" type="number" value={per.garnish} onChange={v=>setPer({...per,garnish:v})}/>
          <I label="PP volontaire (€)" type="number" value={per.ppVolontaire} onChange={v=>setPer({...per,ppVolontaire:v})}/>
          <I label="Autres ret. (€)" type="number" value={per.otherDed} onChange={v=>setPer({...per,otherDed:v})}/>
        </div>
        <ST style={{marginTop:14}}>Éléments fiscaux spéciaux</ST>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:9}}>
          <I label="Double pécule vac. (€)" type="number" value={per.doublePecule} onChange={v=>setPer({...per,doublePecule:v})}/>
          <I label="Pécule départ (€)" type="number" value={per.peculeDepart} onChange={v=>setPer({...per,peculeDepart:v})}/>
          <I label="Prime ancienneté (€)" type="number" value={per.primeAnciennete} onChange={v=>setPer({...per,primeAnciennete:v})}/>
          <I label="Prime naissance/mariage (€)" type="number" value={per.primeNaissance} onChange={v=>setPer({...per,primeNaissance:v})}/>
          <I label="Prime innovation (€)" type="number" value={per.primeInnovation} onChange={v=>setPer({...per,primeInnovation:v})}/>
          <I label="Indem. télétravail (€)" type="number" value={per.indemTeletravail} onChange={v=>setPer({...per,indemTeletravail:v})}/>
          <I label="Indem. bureau (€)" type="number" value={per.indemBureau} onChange={v=>setPer({...per,indemBureau:v})}/>
          <I label="H.sup fiscales (180h)" type="number" value={per.heuresSupFisc} onChange={v=>setPer({...per,heuresSupFisc:v})}/>
          <I label="HS volont. brut=net (h)" type="number" value={per.hsVolontBrutNet} onChange={v=>setPer({...per,hsVolontBrutNet:v})}/>
          <I label="HS relance T1 (h)" type="number" value={per.hsRelance} onChange={v=>setPer({...per,hsRelance:v})}/>
          <I label="Pension compl. ret. (€)" type="number" value={per.pensionCompl} onChange={v=>setPer({...per,pensionCompl:v})}/>
          <I label="Cotis. syndicale (€)" type="number" value={per.retSyndicale} onChange={v=>setPer({...per,retSyndicale:v})}/>
          <I label="Pension aliment. (€)" type="number" value={per.saisieAlim} onChange={v=>setPer({...per,saisieAlim:v})}/>
          <I label="Type spécial" value={per.typeSpecial||'normal'} onChange={v=>setPer({...per,typeSpecial:v})} options={[{v:"normal",l:"Normal"},{v:"doublePecule",l:"Double pécule"},{v:"y13",l:"13ème mois"},{v:"depart",l:"Sortie de service"},{v:"preavis",l:"Indemnité de préavis"}]}/>
          <I label="Petit chômage (jours)" type="number" value={per.petitChomage} onChange={v=>setPer({...per,petitChomage:v})}/>
          <I label="Éco-chèques (€)" type="number" value={per.ecoCheques} onChange={v=>setPer({...per,ecoCheques:v})}/>
          <I label="Cadeaux/événements (€)" type="number" value={per.cadeaux} onChange={v=>setPer({...per,cadeaux:v})}/>
          <I label="Budget mobilité P2 (€)" type="number" value={per.budgetMobP2} onChange={v=>setPer({...per,budgetMobP2:v})}/>
          <I label="Budget mobilité P3 (€)" type="number" value={per.budgetMobP3} onChange={v=>setPer({...per,budgetMobP3:v})}/>
          <I label="Réd. trav. âgé 55+ (€)" type="number" value={per.redGCAge} onChange={v=>setPer({...per,redGCAge:v})}/>
          <I label="Réd. jeune <26 (€)" type="number" value={per.redGCJeune} onChange={v=>setPer({...per,redGCJeune:v})}/>
          <I label="Réd. handicap (€)" type="number" value={per.redGCHandicap} onChange={v=>setPer({...per,redGCHandicap:v})}/>
          <I label="Activation ONEM" value={per.allocTravailType||'none'} onChange={v=>setPer({...per,allocTravailType:v,allocTravail:0})} options={[{v:"none",l:"— Aucune —"},{v:"activa_bxl",l:"Activa.brussels (€350/m)"},{v:"activa_jeune",l:"Activa Jeunes <30 (€350/m)"},{v:"impulsion_wal",l:"Impulsion Wallonie (€500/m)"},{v:"impulsion55",l:"Impulsion 55+ (€500/m)"},{v:"sine",l:"SINE écon. sociale (€500/m)"},{v:"vdab",l:"VDAB (prime directe)"}]}/>
          {per.allocTravailType&&per.allocTravailType!=='none'&&<I label="Montant alloc. ONEM (€)" type="number" value={per.allocTravail} onChange={v=>setPer({...per,allocTravail:v})}/>}
        </div>
        <ST style={{marginTop:14}}>Mi-temps médical / thérapeutique</ST>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:9}}>
          <div style={{gridColumn:'1/-1'}}><div onClick={()=>setPer({...per,miTempsMed:!per.miTempsMed})} style={{padding:'10px 14px',borderRadius:8,cursor:'pointer',fontSize:12,
            background:per.miTempsMed?'rgba(251,146,60,.1)':'rgba(198,163,78,.04)',color:per.miTempsMed?'#fb923c':'#5e5c56',border:'1px solid '+(per.miTempsMed?'rgba(251,146,60,.25)':'rgba(198,163,78,.1)'),textAlign:'center',fontWeight:600}}>
            {per.miTempsMed?'⚕ MI-TEMPS MÉDICAL / THÉRAPEUTIQUE — Reprise progressive INAMI (Art. 100§2)':'❌ Pas de mi-temps médical / thérapeutique'}
          </div></div>
          {per.miTempsMed&&<><I label="Heures/sem prestées" type="number" value={per.miTempsHeures} onChange={v=>setPer({...per,miTempsHeures:v})}/>
          <I label="Complément INAMI (€/mois)" type="number" value={per.miTempsINAMI} onChange={v=>setPer({...per,miTempsINAMI:v})}/>
          <div style={{gridColumn:'1/-1',padding:10,background:"rgba(96,165,250,.04)",borderRadius:8,fontSize:10.5,color:'#60a5fa',lineHeight:1.6}}>
            ⚕ <b>Reprise progressive</b> — Le travailleur preste {per.miTempsHeures||0}h/{emp?.whWeek||38}h = <b>{Math.round((per.miTempsHeures||0)/(emp?.whWeek||38)*100)}%</b>. L'employeur paie le salaire prorata. L'INAMI verse le complément directement au travailleur via la mutuelle. Documents: C3.2 (médecin-conseil) + DRS (eBox).
          </div></>}
        </div>
        <B onClick={gen} style={{width:'100%',marginTop:14,padding:13,fontSize:13.5,letterSpacing:'.5px'}}>GÉNÉRER LA FICHE DE PAIE</B>
      </C>

      {res&&emp&&<div data-payslip style={{background:"#fffef9",borderRadius:14,padding:'32px 36px',color:'#1a1a18',fontFamily:"'Outfit',sans-serif",boxShadow:'0 4px 30px rgba(0,0,0,.3)'}}><div style={{textAlign:"right",marginBottom:12}}><button onClick={()=>generatePayslipPDF(emp,res,per,s.co)} style={{background:"#c6a34e",color:"#fff",border:"none",padding:"8px 20px",borderRadius:6,cursor:"pointer",fontSize:12,fontWeight:600}}>Imprimer / PDF</button></div>
        <div style={{display:'flex',justifyContent:'space-between',paddingBottom:18,borderBottom:'3px solid #c6a34e',marginBottom:22}}>
          <div><div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:700}}>{s.co.name}</div><div style={{fontSize:10.5,color:'#888',marginTop:2}}>{s.co.addr}</div><div style={{fontSize:10.5,color:'#888'}}>TVA: {s.co.vat} · BCE: {s.co.bce||s.co.vat?.replace(/^BE\s?/,"")||'—'} · ONSS: {s.co.onss}</div><div style={{fontSize:10.5,color:'#888'}}>CP: {emp.cp||s.co.cp||'200'} — {LEGAL.CP[emp.cp||s.co.cp||'200']||''}</div></div>
          <div style={{textAlign:'right'}}><div style={{fontSize:14,fontWeight:700,color:'#c6a34e',textTransform:'uppercase',letterSpacing:'2px'}}>Fiche de Paie</div><div style={{fontSize:12.5,color:'#888',marginTop:3}}>{MN[per.month-1]} {per.year}</div><div style={{fontSize:10,color:'#aaa',marginTop:2}}>Période du 01/{String(per.month).padStart(2,"0")}/{per.year} au {new Date(per.year,per.month,0).getDate()}/{String(per.month).padStart(2,"0")}/{per.year}</div><div style={{fontSize:10,color:'#aaa'}}>Date de paiement: dernier jour ouvrable du mois</div></div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:18,marginBottom:20,padding:14,background:"#f5f4ef",borderRadius:8}}>
          <div><div style={{fontSize:9.5,color:'#aaa',textTransform:'uppercase',letterSpacing:'1px',marginBottom:3}}>Travailleur</div><div style={{fontWeight:600,fontSize:13.5}}>{emp.first} {emp.last}</div><div style={{fontSize:10.5,color:'#666'}}>{emp.fn} — {emp.dept}</div><div style={{fontSize:10.5,color:'#666'}}>NISS: {emp.niss}{emp.birth?` · Né(e) le ${emp.birth}`:''}</div><div style={{fontSize:10.5,color:'#666'}}>{emp.addr?`${emp.addr}, ${emp.zip||''} ${emp.city||''}`:''}</div></div>
          <div><div style={{fontSize:9.5,color:'#aaa',textTransform:'uppercase',letterSpacing:'1px',marginBottom:3}}>Contrat & Barème</div><div style={{fontSize:10.5,color:'#555'}}>{emp.contract} · CP {emp.cp} · {emp.whWeek}h/sem · {emp.statut==='ouvrier'?'Ouvrier':'Employé'}</div><div style={{fontSize:10.5,color:'#555'}}>Entrée: {emp.startD} · Ancienneté: {emp.anciennete||0} an(s)</div><div style={{fontSize:10.5,color:'#555'}}>Sit: {emp.civil==='single'?'Isolé':emp.civil==='married_1'?'Marié (1 revenu)':emp.civil==='married_2'?'Marié (2 revenus)':emp.civil==='cohabit'?'Cohabitant':emp.civil==='widowed'?'Veuf/ve':emp.civil}{emp.depChildren>0?` · ${emp.depChildren} enfant(s)`:''}</div><div style={{fontSize:10.5,color:'#555'}}>Barème: {fmt(emp.monthlySalary)}/mois · {fmt(Math.round((emp.monthlySalary||0)/(emp.whWeek||38)/4.33*100)/100)}/h · {per.days||0}j / {Math.round((per.days||0)*(emp.whWeek||38)/5*100)/100}h prestées</div>
            {emp.frontalier&&<div style={{fontSize:10.5,color:'#a855f7',fontWeight:600}}>🌍 Frontalier — Réside: {emp.frontalierPays==='FR'?'France':emp.frontalierPays==='NL'?'Pays-Bas':emp.frontalierPays==='DE'?'Allemagne':emp.frontalierPays==='LU'?'Luxembourg':emp.frontalierPays} · ONSS: Belgique · PP: {emp.frontalierExoPP?'Exonéré (276 Front.)':'Retenu en Belgique'}</div>}
            {emp.pensionné&&<div style={{fontSize:10.5,color:'#fbbf24',fontWeight:600}}>👴 Pensionné ({emp.pensionType==='legal'?'pension légale':emp.pensionType==='anticipee'?'pension anticipée':emp.pensionType==='survie'?'pension de survie':'pension invalidité'}) — Cumul: {res.pensionCumulIllimite?'ILLIMITÉ':'LIMITÉ (plafond '+fmt(res.pensionPlafond)+'/an)'}{res.pensionDepassement?' ⚠ DÉPASSEMENT ESTIMÉ: '+res.pensionDepassPct+'%':''}</div>}
          </div>
        </div>
        <table style={{width:'100%',borderCollapse:'collapse',fontSize:12}}>
          <thead><tr style={{borderBottom:'2px solid #c6a34e'}}><th style={{textAlign:'left',padding:'7px 0',fontSize:9.5,textTransform:'uppercase',letterSpacing:'1px',color:'#999'}}>Description</th><th style={{textAlign:'right',padding:'7px 0',fontSize:9.5,textTransform:'uppercase',letterSpacing:'1px',color:'#999'}}>Taux</th><th style={{textAlign:'right',padding:'7px 0',fontSize:9.5,textTransform:'uppercase',letterSpacing:'1px',color:'#999'}}>Montant</th></tr></thead>
          <tbody>
            <PS t="Rémunération brute"/>
            {res.isFlexiJob&&<tr><td colSpan={3} style={{padding:'6px 0 8px',fontSize:11,color:'#4ade80',fontWeight:600,background:"rgba(74,222,128,.05)",borderRadius:4}}>🔄 FLEXI-JOB — Loi 16/11/2015 · Net = Brut · ONSS trav. 0% · PP 0% · ONSS empl. 28%</td></tr>}
            {res.isFlexiJob&&<><PR l={`Flexi-salaire (${res.flexiHeures}h × ${fmt(res.flexiSalaireH)}/h)`} a={res.flexiBrut}/>
              <PR l="Flexi-pécule vacances (7,67%)" a={res.flexiPecule} pos/>
              <PR l="TOTAL FLEXI BRUT" a={res.gross} bold/>
              <PS t="Cotisations"/>
              <PR l="ONSS travailleur" rate="0%" a={0}/>
              <PR l="Précompte professionnel" rate="0%" a={0}/>
              <PR l="Cotisation spéciale SS" rate="0%" a={0}/>
              <PS t="Coût employeur"/>
              <PR l="ONSS patronal spécial (28%)" a={-res.flexiOnssPatronal} neg/>
            </>}
            {!res.isFlexiJob&&<>
            {res.miTempsMed&&<tr><td colSpan={3} style={{padding:'6px 0 8px',fontSize:11,color:'#fb923c',fontWeight:600,background:"rgba(251,146,60,.05)",borderRadius:4}}>⚕ REPRISE PROGRESSIVE — Mi-temps médical / thérapeutique (Art. 100§2 Loi coord. 14/07/1994) — Fraction: {Math.round(res.miTempsFraction*100)}% ({res.miTempsHeures}h/{emp.whWeek||38}h)</td></tr>}
            <PR l="Salaire de base" a={res.base}/>
            {res.miTempsMed&&<PR l={`  └ Brut normal: ${fmt(res.miTempsBrutOriginal)} × ${Math.round(res.miTempsFraction*100)}% prorata`} a={res.base} sub/>}
            {res.overtime>0&&<PR l="Heures sup. (150%)" rate={`${per.overtimeH}h`} a={res.overtime}/>}
            {res.sunday>0&&<PR l="Dimanche (200%)" rate={`${per.sundayH}h`} a={res.sunday}/>}
            {res.night>0&&<PR l="Nuit (125%)" rate={`${per.nightH}h`} a={res.night}/>}
            {res.bonus>0&&<PR l="Prime" a={res.bonus}/>}
            {res.y13>0&&<PR l="Prime fin d'année" a={res.y13}/>}
            {res.sickPay>0&&<PR l="Salaire garanti maladie" a={res.sickPay}/>}
            <PR l="TOTAL BRUT" a={res.gross} bold/>
            {emp.statut==='ouvrier'&&<>
              <tr><td colSpan={3} style={{padding:'4px 0 2px',fontSize:10,color:'#fb923c',fontStyle:'italic'}}>
                Ouvrier — Base ONSS = brut × 108% = {fmt(res.gross)} × 1,08 = <b>{fmt(res.gross*TX_OUV108)}</b> (compensation pécule vacances simple — Art. 23 AR 28/11/1969)
              </td></tr>
              {res.cotisVacOuv>0&&<PR l={`Cotisation vacances ouvrier (15,84% sur brut 108%)`} a={-res.cotisVacOuv} neg/>}
            </>}
            {res.atnCar>0&&<><PS t="Avantage de toute nature (ATN)"/>
            <PR l={`ATN voiture de société (${emp.carBrand||''} ${emp.carModel||''} — ${emp.carCO2||0}g CO2)`} rate={`${(res.atnPct||0).toFixed(1)}%`} a={res.atnCar}/>
            <PR l="ATN ajouté au revenu imposable" a={res.atnCar} sub/></>}
            {(res.atnAutresTot>0&&!res.atnCar)&&<PS t="Avantages de toute nature (ATN)"/>}
            {res.atnGSM>0&&<PR l="ATN GSM/Téléphone (forfait 36€/an)" a={res.atnGSM}/>}
            {res.atnPC>0&&<PR l="ATN PC/Tablette (forfait 72€/an)" a={res.atnPC}/>}
            {res.atnInternet>0&&<PR l="ATN Internet privé (forfait 60€/an)" a={res.atnInternet}/>}
            {res.atnLogement>0&&<PR l="ATN Logement gratuit (RC × coeff.)" a={res.atnLogement}/>}
            {res.atnChauffage>0&&<PR l="ATN Chauffage gratuit (2.130€/an)" a={res.atnChauffage}/>}
            {res.atnElec>0&&<PR l="ATN Électricité gratuite (1.060€/an)" a={res.atnElec}/>}
            {res.veloSociete&&<PR l={`🚲 Vélo de société (${res.veloType}) — ATN = 0€ (Art.38§1er 14°a — exonéré)`} a={0}/>}
            {res.atnCarteCarburant>0&&<PR l="ATN Carte carburant (sans voiture soc. — imposable)" a={res.atnCarteCarburant}/>}
            {res.atnBorne>0&&<PR l="ATN Borne recharge domicile (sans voiture soc.)" a={res.atnBorne}/>}
            {res.atnAutresTot>0&&<PR l="Total ATN autres (ajouté au revenu imposable)" a={res.atnAutresTot} sub/>}
            <PS t="Cotisations ONSS"/>
            <PR l={`ONSS travailleur (${fmtP(LEGAL.ONSS_W)} sur ${emp.statut==='ouvrier'?'brut 108% = '+fmt(res.gross*TX_OUV108):'brut '+fmt(res.gross)})`} rate={fmtP(LEGAL.ONSS_W)} a={-res.onssW} neg/>
            {res.empBonus>0&&<PR l={`Bonus à l'emploi social (réduction ONSS bas salaires — AR 21/12/2017)`} a={res.empBonus} pos/>}
            {res.empBonusA>0&&<PR l={`  └ Volet A (bas salaires): ${fmt(res.empBonusA)}`} a={res.empBonusA} pos sub/>}
            {res.empBonusB>0&&<PR l={`  └ Volet B (très bas salaires): ${fmt(res.empBonusB)}`} a={res.empBonusB} pos sub/>}
            <PR l={`ONSS net à retenir (${fmt(res.onssW)} − ${fmt(res.empBonus)} bonus)`} a={-res.onssNet} bold neg/>
            {res.redStructMois>0&&<PR l={`Réduction structurelle patronale (Cat ${res.redStructCat}${res.redStructFraction<1?' × '+Math.round(res.redStructFraction*100)+'% TP':''})`} a={res.redStructMois} pos/>}
            {res.empBonusFisc>0&&<PR l={`Bonus emploi fiscal (réduction PP: volet A ${fmtP(0.3314)} + volet B ${fmtP(0.5254)})`} a={res.empBonusFisc} pos/>}
            <PS t="Fiscalité (Formule-clé SPF)"/>
            <PR l="Revenu imposable" a={res.taxGross} sub/>
            <PR l="Frais prof. forfaitaires" a={-res.profExp} sub/>
            <PR l="Base taxable" a={res.taxNet} sub/>
            <PR l="Impôt (barème progressif)" a={-res.baseTax} neg/>
            {res.famRed>0&&<PR l="Réductions familiales (Art.132-140 CIR)" a={res.famRed} pos/>}
            <PR l="Précompte professionnel" a={-res.tax} bold neg/>
            {res.ppVolontaire>0&&<PR l="Précompte volontaire (Art. 275§1 CIR 92 — demande écrite travailleur)" a={-res.ppVolontaire} neg/>}
            <PR l="Cotisation spéciale SS" a={-res.css} neg/>
            <PS t="Retenues & Avantages"/>
            {res.mvWorker>0&&<PR l={`Chèques repas (${res.mvDays}j)`} a={-res.mvWorker} neg/>}
            {res.transport>0&&<PR l={`Transport dom.-travail (${res.transportDetail||emp.commType})`} a={res.transport} pos/>}
            {res.transport>0&&emp.commType==='bike'&&<tr><td colSpan={3} style={{padding:'2px 0 6px',fontSize:9.5,color:'#4ade80',fontStyle:'italic'}}>🚲 Total: {((emp.commDist||0)*2*(per.days||21))} km/mois ({emp.commDist} km × 2 A/R × {per.days||21} jours) — Exonéré ONSS et IPP (Art. 38§1er 14° CIR)</td></tr>}
            {res.expense>0&&<PR l="Frais propres employeur" a={res.expense} pos/>}
            {res.indemTeletravail>0&&<PR l="Indemnité télétravail (exonérée — max 154,74€)" a={res.indemTeletravail} pos/>}
            {res.indemBureau>0&&<PR l="Indemnité frais de bureau (exonérée)" a={res.indemBureau} pos/>}
            {res.garnish>0&&<PR l="Saisie sur salaire" a={-res.garnish} neg/>}
            {res.saisieAlim>0&&<PR l="Pension alimentaire (prioritaire — Art.1409 C.jud.)" a={-res.saisieAlim} neg/>}
            {res.advance>0&&<PR l="Acompte" a={-res.advance} neg/>}
            {res.pensionCompl>0&&<PR l="Retenue pension complémentaire (2è pilier — LPC)" a={-res.pensionCompl} neg/>}
            {res.retSyndicale>0&&<PR l="Cotisation syndicale" a={-res.retSyndicale} neg/>}
            {res.otherDed>0&&<PR l="Autres retenues" a={-res.otherDed} neg/>}
            {res.atnCar>0&&<PR l="ATN voiture (déduit du net)" a={-res.atnCar} neg/>}
            {res.atnAutresTot>0&&<PR l="ATN autres (déduit du net)" a={-res.atnAutresTot} neg/>}
            {(res.doublePecule>0||res.peculeDepart>0||res.primeAnciennete>0||res.primeNaissance>0||res.primeInnovation>0)&&<PS t="Éléments exceptionnels"/>}
            {res.doublePecule>0&&<><PR l="Double pécule vacances (92% brut)" a={res.doublePecule} pos/>
              <PR l="  └ ONSS sur 2ème partie (7% × 13,07%)" a={-res.dpOnss} neg sub/>
              <PR l="  └ Cotisation spéciale 1%" a={-res.dpCotisSpec} neg sub/></>}
            {res.peculeDepart>0&&<><PR l="Pécule vacances de départ (Art.46)" a={res.peculeDepart} pos/>
              <PR l="  └ ONSS 13,07% sur pécule départ" a={-res.pdOnss} neg sub/></>}
            {res.primeAnciennete>0&&<><PR l={`Prime ancienneté (${emp.anciennete||0} ans)`} a={res.primeAnciennete}/>
              {res.primeAncExoneree>0&&<PR l="  └ Dont exonéré ONSS+IPP (Art.19§2 14°)" a={res.primeAncExoneree} pos sub/>}
              {res.primeAncTaxable>0&&<PR l="  └ Dont taxable" a={res.primeAncTaxable} sub/>}</>}
            {res.primeNaissance>0&&<PR l="Prime naissance/mariage (avantage social — exo)" a={res.primeNaissance} pos/>}
            {res.primeInnovation>0&&<PR l="Prime innovation (Art.38§1er 25° CIR — exo IPP)" a={res.primeInnovation} pos/>}
            {res.redPPHeuresSup>0&&<PS t="Réductions fiscales"/>}
            {res.redPPHeuresSup>0&&<PR l={`Réd. PP heures sup. (${res.heuresSupFisc}h × 66,81% — Art.154bis)`} a={res.redPPHeuresSup} pos/>}
            {res.ppTauxExcep>0&&<PR l={`PP taux exceptionnel ${(res.ppTauxExcepRate*100).toFixed(2)}% (AR 09/01/2024 ann.III)`} a={-res.ppTauxExcep} neg/>}
            {res.petitChomageVal>0&&<><PS t="Absences rémunérées"/>
              <PR l={`Petit chômage / Congé circonstanciel (${res.petitChomage}j — AR 28/08/1963)`} a={res.petitChomageVal} pos/></>}
            {(res.ecoCheques>0||res.cadeaux>0||res.budgetMobPilier2>0)&&<PS t="Avantages exonérés"/>}
            {res.ecoCheques>0&&<PR l="Éco-chèques (CCT 98 — max 250€/an — exo ONSS+IPP)" a={res.ecoCheques} pos/>}
            {res.cadeaux>0&&<PR l="Cadeaux/événements (exo si ≤ plafond — Circ. ONSS)" a={res.cadeaux} pos/>}
            {res.budgetMobPilier2>0&&<PR l="Budget mobilité — Pilier 2 (mobilité durable — exo)" a={res.budgetMobPilier2} pos/>}
            {res.hsBrutNetTotal>0&&<><PS t="Heures supplémentaires brut=net (01/04/2026)"/>
              {res.hsVolontBrutNet>0&&<PR l={`HS volontaires brut=net (${per.hsVolontBrutNet||0}h × ${fmt(res.hsVolontBrutNet/(per.hsVolontBrutNet||1))}/h — exo ONSS+PP)`} a={res.hsVolontBrutNet} pos/>}
              {res.hsRelance>0&&<PR l={`HS relance transitoire T1 (${per.hsRelance||0}h — brut=net — déduit quota 240h)`} a={res.hsRelance} pos/>}
              <tr><td colSpan={3} style={{padding:'4px 0 6px',fontSize:10,color:'#4ade80',fontStyle:'italic'}}>
                Nouveau régime: max 360h/an (450h horeca). 240h brut=net. Pas de sursalaire. Accord écrit 1 an requis.
              </td></tr></>}
            {res.budgetMobPilier3>0&&<><PR l="Budget mobilité — Pilier 3 (cash)" a={res.budgetMobPilier3}/>
              <PR l="  └ Cotisation spéciale 38,07% (Loi 17/03/2019)" a={-res.budgetMobCotis38} neg sub/></>}
            {res.allocTravail>0&&<><PS t="Activation ONEM"/>
              <PR l={`Allocation de travail ${res.allocTravailLabel} (AR 19/12/2001)`} a={-res.allocTravail} neg/>
              <tr><td colSpan={3} style={{padding:'4px 0 8px',fontSize:10,color:'#60a5fa',fontStyle:'italic',lineHeight:1.5}}>
                → Déduit du salaire net. Le travailleur reçoit {fmt(res.allocTravail)}/mois directement de l'ONEM via CAPAC/syndicat.<br/>
                → Rémunération totale travailleur inchangée: {fmt(res.net)} (employeur) + {fmt(res.allocTravail)} (ONEM) = {fmt(res.net+res.allocTravail)}<br/>
                → L'allocation n'est PAS soumise à l'ONSS (pas de rémunération). Le PP est retenu par l'ONEM (10,09%).<br/>
                → L'employeur ne déclare PAS l'allocation en DmfA. Formulaire: C78 (ONEM) + carte Activa/attestation FOREM.
              </td></tr></>}
            </>}
            <tr style={{borderTop:'3px solid #c6a34e'}}><td style={{padding:'14px 0',fontWeight:800,fontSize:15}}>NET À PAYER</td><td></td><td style={{textAlign:'right',padding:'14px 0',fontWeight:800,fontSize:18,color:'#16a34a'}}>{fmt(res.net)}</td></tr>
            {res.miTempsMed&&<><tr style={{background:"rgba(251,146,60,.04)"}}><td colSpan={3} style={{padding:'10px 0 4px'}}>
              <div style={{fontSize:11,fontWeight:700,color:'#fb923c'}}>⚕ POUR MÉMOIRE — Complément INAMI (hors fiche de paie)</div>
            </td></tr>
            <PR l={`Indemnités INAMI mutuelle (${Math.round((1-res.miTempsFraction)*100)}% non presté)`} a={res.miTempsINAMI}/>
            <tr><td style={{padding:'6px 0',fontWeight:700,fontSize:13}}>REVENU TOTAL TRAVAILLEUR</td><td></td><td style={{textAlign:'right',padding:'6px 0',fontWeight:700,fontSize:14,color:'#c6a34e'}}>{fmt(res.net + res.miTempsINAMI)}</td></tr>
            <tr><td colSpan={3} style={{padding:'4px 0 8px',fontSize:9.5,color:'#999',fontStyle:'italic'}}>Le complément INAMI est versé directement par la mutuelle au travailleur. Il n'est pas soumis à l'ONSS. Le PP est retenu à la source par la mutuelle (11,11%). Le travailleur conserve son contrat à temps plein.</td></tr></>}
          </tbody>
        </table>
        {/* CUMUL ANNUEL YTD (AR 27/09/1966 Art.9 — mention obligatoire) */}
        <div style={{marginTop:14,padding:12,background:"#f5f4ef",borderRadius:8}}>
          <div style={{fontSize:9.5,color:'#aaa',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600,marginBottom:8}}>Cumul annuel (YTD — Janvier à {MN[per.month-1]} {per.year})</div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:8}}>
            {[
              {l:"Brut cumulé",v:res.gross*per.month},
              {l:"ONSS cumulé",v:res.onssNet*per.month},
              {l:"PP cumulé",v:res.tax*per.month},
              {l:"CSS cumulé",v:res.css*per.month},
              {l:"Net cumulé",v:res.net*per.month,c:'#16a34a'},
              {l:"Coût empl. cumulé",v:res.costTotal*per.month,c:'#c6a34e'},
            ].map((x,i)=><div key={i} style={{textAlign:'center'}}>
              <div style={{fontSize:8.5,color:'#999'}}>{x.l}</div>
              <div style={{fontSize:11.5,fontWeight:600,color:x.c||'#555',marginTop:2}}>{fmt(x.v)}</div>
            </div>)}
          </div>
          <div style={{fontSize:8,color:'#bbb',marginTop:6,fontStyle:'italic'}}>* Estimation basée sur le salaire du mois courant × {per.month} mois. Les cumuls réels seront calculés sur base de l'historique des fiches.</div>
        </div>
        {/* COMPTEURS CONGÉS & HEURES (Loi 28/06/1971 + CCT) */}
        <div style={{marginTop:10,padding:12,background:"#f5f4ef",borderRadius:8,display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12}}>
          {[
            {l:"Congés légaux",v:`${20-Math.min(per.month*2,20)}j restants`,s:`Total: 20j/an (employé TP)`},
            {l:"Heures sup. récup.",v:`${(per.overtimeH||0)}h ce mois`,s:'Récupérables dans les 3 mois'},
            {l:"Jours maladie",v:`${per.sickG||0}j ce mois`,s:'Sal. garanti: 30j (employé) / 7+7+14j (ouvrier)'},
            {l:"Crédit-temps",v:"—",s:'Non activé'},
          ].map((x,i)=><div key={i} style={{textAlign:'center'}}>
            <div style={{fontSize:8.5,color:'#999'}}>{x.l}</div>
            <div style={{fontSize:11,fontWeight:600,color:'#555',marginTop:2}}>{x.v}</div>
            <div style={{fontSize:7.5,color:'#bbb',marginTop:1}}>{x.s}</div>
          </div>)}
        </div>
        {/* PÉCULE VACANCES & 13ÈME MOIS — Estimations annuelles */}
        <div style={{marginTop:10,padding:12,background:"#f8f7f2",borderRadius:8,border:'1px solid rgba(198,163,78,.1)'}}>
          <div style={{fontSize:9,color:'#c6a34e',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600,marginBottom:8}}>Estimations annuelles — Pécule vacances & 13ème mois</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14}}>
            <div>
              <div style={{fontSize:9.5,fontWeight:600,color:'#555',marginBottom:4}}>🏖 Pécule de vacances ({res.peculeVacCalc?.type==='ouvrier'?'Ouvrier — ONVA':'Employé — Employeur'})</div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4,fontSize:9.5,color:'#777'}}>
                <span>Simple:</span><span style={{fontWeight:600,textAlign:'right'}}>{fmt(res.peculeVacCalc?.simple||0)}</span>
                <span>Double (92%):</span><span style={{fontWeight:600,textAlign:'right'}}>{fmt(res.peculeVacCalc?.double||0)}</span>
                <span>ONSS 2è partie:</span><span style={{fontWeight:600,textAlign:'right',color:'#f87171'}}>-{fmt(res.peculeVacCalc?.onss2emePartie||0)}</span>
                <span>PP exceptionnel:</span><span style={{fontWeight:600,textAlign:'right',color:'#f87171'}}>-{fmt(res.peculeVacCalc?.ppExcep||0)} ({Math.round((res.peculeVacCalc?.ppExcepRate||0)*100)}%)</span>
                <span style={{borderTop:'1px solid #ddd',paddingTop:3}}>Total estimé:</span><span style={{fontWeight:700,textAlign:'right',color:'#16a34a',borderTop:'1px solid #ddd',paddingTop:3}}>{fmt(res.peculeVacCalc?.total||0)}</span>
              </div>
              <div style={{fontSize:8,color:'#aaa',marginTop:4}}>Paiement: {res.peculeVacCalc?.moisPaiement}</div>
            </div>
            <div>
              <div style={{fontSize:9.5,fontWeight:600,color:'#555',marginBottom:4}}>🎄 Prime de fin d'année (13ème mois)</div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4,fontSize:9.5,color:'#777'}}>
                <span>Brut:</span><span style={{fontWeight:600,textAlign:'right'}}>{fmt(res.y13Calc?.montant||0)}</span>
                <span>ONSS (13,07%):</span><span style={{fontWeight:600,textAlign:'right',color:'#f87171'}}>-{fmt(res.y13Calc?.onss||0)}</span>
                <span>PP exceptionnel:</span><span style={{fontWeight:600,textAlign:'right',color:'#f87171'}}>-{fmt(res.y13Calc?.ppExcep||0)} ({Math.round((res.y13Calc?.ppExcepRate||0)*100)}%)</span>
                <span style={{borderTop:'1px solid #ddd',paddingTop:3}}>Net estimé:</span><span style={{fontWeight:700,textAlign:'right',color:'#16a34a',borderTop:'1px solid #ddd',paddingTop:3}}>{fmt(res.y13Calc?.netEstime||0)}</span>
              </div>
              <div style={{fontSize:8,color:'#aaa',marginTop:4}}>{res.y13Calc?.methode} · Paiement: {res.y13Calc?.moisPaiement}</div>
            </div>
          </div>
        </div>
        <div style={{marginTop:18,padding:14,background:"#f0efea",borderRadius:8,display:'grid',gridTemplateColumns:res.atnCar>0?'repeat(5,1fr)':'repeat(4,1fr)',gap:10}}>
          {[{l:"Brut",v:res.gross},{l:`ONSS empl. (${(res.onssE_rate*100).toFixed(0)}%)`,v:res.onssE},...(res.cotisVacOuv>0?[{l:"Cot. vac. ouvrier (15,84%)",v:res.cotisVacOuv}]:[]),...(res.atnCar>0?[{l:"Cot. CO2",v:res.cotCO2}]:[]),...(res.pensionComplEmpl>0?[{l:"Pension compl. empl.",v:res.pensionComplEmpl}]:[]),...(res.ecoCheques>0?[{l:"Éco-chèques",v:res.ecoCheques}]:[]),...(res.dispensePPTotal>0?[{l:"Dispense PP (nuit/HS)",v:-res.dispensePPTotal}]:[]),...(res.redGCPremier>0?[{l:`Réd. ${res.redGCPremierLabel||'1er eng.'} (Art.336 LP)`,v:-res.redGCPremier}]:[]),...(res.redGCAge>0?[{l:"Réd. trav. âgé 55+",v:-res.redGCAge}]:[]),...(res.redGCJeune>0?[{l:"Réd. jeune <26",v:-res.redGCJeune}]:[]),...(res.redGCHandicap>0?[{l:"Réd. handicap",v:-res.redGCHandicap}]:[]),...(res.allocTravail>0?[{l:`Alloc. ONEM ${res.allocTravailLabel}`,v:-res.allocTravail}]:[]),{l:"Avantages",v:res.mvEmployer+res.expense+res.transport+res.indemTeletravail+res.indemBureau},{l:"COÛT TOTAL",v:res.costTotal,g:1}].map((x,i)=>
            <div key={i} style={{textAlign:'center'}}><div style={{fontSize:9.5,color:'#999',textTransform:'uppercase'}}>{x.l}</div><div style={{fontSize:13,fontWeight:x.g?800:600,marginTop:3,color:x.g?'#c6a34e':'#333'}}>{fmt(x.v)}</div></div>
          )}
        </div>
        <div style={{marginTop:10,fontSize:10.5,color:'#bbb'}}>Versement: {emp.iban}</div>
        {/* CONDITIONS GÉNÉRALES INSTITUTIONNELLES */}
        <div className="no-print" style={{marginTop:18,paddingTop:14,borderTop:'1px solid #e0dfda'}}>
          <div style={{fontSize:8.5,color:'#bbb',textTransform:'uppercase',letterSpacing:'1.5px',fontWeight:600,marginBottom:8}}>Conditions générales</div>
          <div style={{fontSize:8,color:'#aaa',lineHeight:1.7,columnCount:2,columnGap:20}}>
            <p style={{margin:'0 0 4px'}}><b style={{color:'#999'}}>1. Confidentialité</b> — La présente fiche de paie est un document strictement confidentiel destiné exclusivement au travailleur mentionné ci-dessus. Toute reproduction, diffusion ou communication à des tiers est interdite sauf accord écrit de l'employeur.</p>
            <p style={{margin:'0 0 4px'}}><b style={{color:'#999'}}>2. Base légale</b> — Ce document est établi conformément à la loi du 12 avril 1965 concernant la protection de la rémunération des travailleurs et à l'arrêté royal du 27 septembre 1966 déterminant les mentions obligatoires du décompte de rémunération.</p>
            <p style={{margin:'0 0 4px'}}><b style={{color:'#999'}}>3. Calculs</b> — Les retenues ONSS sont effectuées conformément à la loi du 29 juin 1981. Le précompte professionnel est calculé selon la formule-clé du SPF Finances (annexe III AR/CIR 92). La cotisation spéciale de sécurité sociale est établie conformément à la loi du 30 mars 1994.</p>
            <p style={{margin:'0 0 4px'}}><b style={{color:'#999'}}>4. Contestation</b> — Toute contestation relative au présent décompte doit être adressée par écrit à l'employeur dans un délai d'un mois à compter de la date de réception. Passé ce délai, le décompte est réputé accepté, sans préjudice du droit de réclamation légal.</p>
            <p style={{margin:'0 0 4px'}}><b style={{color:'#999'}}>5. Conservation</b> — Le travailleur est tenu de conserver ce document pendant une durée minimale de 5 ans. Ce document peut être requis pour l'établissement de la déclaration fiscale (IPP) et pour toute démarche administrative (chômage, pension, crédit).</p>
            <p style={{margin:'0 0 4px'}}><b style={{color:'#999'}}>6. Données personnelles</b> — Le traitement des données à caractère personnel figurant sur ce document est effectué conformément au Règlement (UE) 2016/679 (RGPD). Les données sont traitées aux seules fins de gestion salariale, déclarations sociales et fiscales. Le travailleur dispose d'un droit d'accès, de rectification et de suppression de ses données (art. 15-17 RGPD).</p>
            <p style={{margin:'0 0 4px'}}><b style={{color:'#999'}}>7. Barèmes</b> — Les rémunérations sont conformes aux barèmes sectoriels en vigueur de la commission paritaire applicable (CP {emp.cp||s.co.cp||'200'}), tels que publiés par le SPF Emploi, Travail et Concertation sociale.</p>
            <p style={{margin:'0 0 4px'}}><b style={{color:'#999'}}>8. Paiement</b> — Le salaire net est versé par virement bancaire sur le compte communiqué par le travailleur, au plus tard le dernier jour ouvrable du mois en cours, conformément à l'art. 5 de la loi du 12/04/1965.</p>
          </div>
          <div style={{marginTop:10,paddingTop:8,borderTop:'1px solid #eee',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div style={{fontSize:7.5,color:'#ccc'}}>{s.co.name} · {s.co.vat} · {s.co.addr} · Secrétariat social: Aureus Social Pro</div>
            <div style={{fontSize:7.5,color:'#ccc'}}>Document généré le {new Date().toLocaleDateString('fr-BE')} · Page 1/1</div>
          </div>
        </div>

        {/* TABLEAU RÉCAPITULATIF SOUMISSION ONSS / PP PAR ÉLÉMENT */}
        <div className="no-print" style={{marginTop:18,padding:14,background:"#f0efea",borderRadius:8}}>
          <div style={{fontSize:9.5,color:'#999',textTransform:'uppercase',letterSpacing:'1px',fontWeight:600,marginBottom:10}}>Récapitulatif soumission ONSS & Précompte professionnel</div>
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:10.5}}>
            <thead><tr style={{borderBottom:'2px solid #c6a34e'}}>
              <th style={{textAlign:'left',padding:'6px 8px',color:'#999',fontSize:9}}>Élément</th>
              <th style={{textAlign:'center',padding:'6px 8px',color:'#999',fontSize:9}}>Montant</th>
              <th style={{textAlign:'center',padding:'6px 8px',color:'#999',fontSize:9}}>ONSS</th>
              <th style={{textAlign:'center',padding:'6px 8px',color:'#999',fontSize:9}}>PP</th>
              <th style={{textAlign:'left',padding:'6px 8px',color:'#999',fontSize:9}}>Base légale</th>
            </tr></thead>
            <tbody>
              {[
                {l:"Salaire de base",m:res.base,onss:'✅ Oui',pp:'✅ Oui',ref:"Loi 12/04/1965"},
                ...(res.overtime>0?[{l:"Heures supplémentaires (150%)",m:res.overtime,onss:'✅ Oui',pp:'✅ Oui',ref:"Loi 16/03/1971"}]:[]),
                ...(res.sunday>0?[{l:"Supplément dimanche (200%)",m:res.sunday,onss:'✅ Oui',pp:'✅ Oui',ref:"Loi 16/03/1971"}]:[]),
                ...(res.night>0?[{l:"Supplément nuit (125%)",m:res.night,onss:'✅ Oui',pp:'✅ Oui',ref:"Loi 16/03/1971"}]:[]),
                ...(res.bonus>0?[{l:"Prime",m:res.bonus,onss:'✅ Oui',pp:'✅ Oui',ref:"Art. 2 Loi 12/04/1965"}]:[]),
                ...(res.y13>0?[{l:"13ème mois",m:res.y13,onss:'✅ Oui',pp:'✅ Taux except.',ref:"AR 09/01/2024 ann.III"}]:[]),
                ...(res.sickPay>0?[{l:"Salaire garanti maladie",m:res.sickPay,onss:'✅ Oui',pp:'✅ Oui',ref:"Loi 03/07/1978 Art.52-70"}]:[]),
                {l:"▬ TOTAL BRUT",m:res.gross,onss:'',pp:'',ref:"",bold:true},
                ...(emp.statut==='ouvrier'?[{l:"  └ Base ONSS ouvrier (brut × 108%)",m:Math.round(res.gross*TX_OUV108*100)/100,onss:'✅ 13,07%',pp:'—',ref:"Loi 29/06/1981 Art.23",hl:"orange"}]:[]),
                {l:"ONSS travailleur (13,07%)",m:res.onssW,onss:'—',pp:'—',ref:"Loi 29/06/1981",neg:true},
                ...(res.empBonus>0?[{l:"  └ Bonus à l\'emploi social (volet A+B)",m:res.empBonus,onss:'Réduction',pp:'—',ref:"AR 01/06/1999 Art.2",hl:"green"}]:[]),
                ...(res.empBonusFisc>0?[{l:"  └ Bonus emploi fiscal (PP)",m:res.empBonusFisc,onss:'—',pp:'Réduction',ref:"Art. 289ter CIR 92",hl:"green"}]:[]),
                {l:"ONSS net retenu",m:res.onssNet,onss:'—',pp:'—',ref:"",neg:true,bold:true},
                {l:"Précompte professionnel",m:res.tax,onss:'—',pp:'—',ref:"AR/CIR 92 annexe III",neg:true},
                ...(res.ppVolontaire>0?[{l:"PP volontaire",m:res.ppVolontaire,onss:'—',pp:'—',ref:"Art. 275§1 CIR 92",neg:true}]:[]),
                {l:"Cotisation spéciale SS",m:res.css,onss:'—',pp:'—',ref:"Loi 30/03/1994",neg:true},
                ...(res.atnCar>0?[{l:"ATN Voiture de société",m:res.atnCar,onss:'❌ Non',pp:'✅ Oui',ref:"Art. 36 CIR 92"}]:[]),
                ...(res.atnGSM>0?[{l:"ATN GSM",m:res.atnGSM,onss:'❌ Non',pp:'✅ Oui',ref:"AR 18/12/2024 forfait"}]:[]),
                ...(res.atnPC>0?[{l:"ATN PC",m:res.atnPC,onss:'❌ Non',pp:'✅ Oui',ref:"AR 18/12/2024 forfait"}]:[]),
                ...(res.atnInternet>0?[{l:"ATN Internet",m:res.atnInternet,onss:'❌ Non',pp:'✅ Oui',ref:"AR 18/12/2024 forfait"}]:[]),
                ...(res.atnLogement>0?[{l:"ATN Logement",m:res.atnLogement,onss:'❌ Non',pp:'✅ Oui',ref:"Art. 18 AR/CIR 92"}]:[]),
                ...(res.atnChauffage>0?[{l:"ATN Chauffage",m:res.atnChauffage,onss:'❌ Non',pp:'✅ Oui',ref:"Art. 18 AR/CIR 92"}]:[]),
                ...(res.atnElec>0?[{l:"ATN Électricité",m:res.atnElec,onss:'❌ Non',pp:'✅ Oui',ref:"Art. 18 AR/CIR 92"}]:[]),
                ...(res.veloSociete?[{l:"🚲 Vélo de société",m:0,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"Art. 38§1er 14°a CIR",hl:"green"}]:[]),
                ...(res.atnCarteCarburant>0?[{l:"Carte carburant (sans voit. soc.)",m:res.atnCarteCarburant,onss:'✅ Oui',pp:'✅ Oui',ref:"Art. 36§2 CIR 92"}]:[]),
                ...(res.transport>0?[{l:"Transport domicile-travail",m:res.transport,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"CCT 19/9 + Art. 38§1er 9° CIR",hl:"green"}]:[]),
                ...(res.expense>0?[{l:"Frais propres employeur",m:res.expense,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"Art. 31 CIR 92",hl:"green"}]:[]),
                ...(res.indemTeletravail>0?[{l:"Indemnité télétravail",m:res.indemTeletravail,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"Circ. 2021/C/20 (max 154,74€)",hl:"green"}]:[]),
                ...(res.indemBureau>0?[{l:"Indemnité bureau",m:res.indemBureau,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"Art. 31 CIR 92",hl:"green"}]:[]),
                ...(res.doublePecule>0?[{l:"Double pécule vacances",m:res.doublePecule,onss:'✅ 2è partie',pp:'✅ Taux except.',ref:"AR 28/11/1969 Art.19§2"}]:[]),
                ...(res.peculeDepart>0?[{l:"Pécule vacances départ",m:res.peculeDepart,onss:'✅ 13,07%',pp:'✅ Taux except.',ref:"Loi 12/04/1965 Art.46"}]:[]),
                ...(res.primeAncExoneree>0?[{l:"Prime ancienneté (exonérée)",m:res.primeAncExoneree,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"Art. 19§2 14° AR ONSS",hl:"green"}]:[]),
                ...(res.primeAncTaxable>0?[{l:"Prime ancienneté (taxable)",m:res.primeAncTaxable,onss:'✅ Oui',pp:'✅ Oui',ref:"Art. 19§2 14° AR ONSS"}]:[]),
                ...(res.primeNaissance>0?[{l:"Prime naissance/mariage",m:res.primeNaissance,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"Circ. ONSS — avantage social",hl:"green"}]:[]),
                ...(res.primeInnovation>0?[{l:"Prime innovation",m:res.primeInnovation,onss:'✅ Oui',pp:'❌ Exonéré',ref:"Art. 38§1er 25° CIR"}]:[]),
                ...(res.ecoCheques>0?[{l:"Éco-chèques",m:res.ecoCheques,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"CCT 98 du 20/02/2009",hl:"green"}]:[]),
                ...(res.cadeaux>0?[{l:"Cadeaux/événements",m:res.cadeaux,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"Circ. ONSS (≤ plafond)",hl:"green"}]:[]),
                ...(res.budgetMobPilier2>0?[{l:"Budget mobilité Pilier 2",m:res.budgetMobPilier2,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"Loi 17/03/2019",hl:"green"}]:[]),
                ...(res.budgetMobPilier3>0?[{l:"Budget mobilité Pilier 3 (cash)",m:res.budgetMobPilier3,onss:'✅ 38,07%',pp:'❌ Non',ref:"Loi 17/03/2019"}]:[]),
                ...(res.pensionCompl>0?[{l:"Pension complémentaire (ret. pers.)",m:res.pensionCompl,onss:'✅ Oui',pp:'❌ Réduc. 30%',ref:"LPC 28/04/2003 + Art.145/1"}]:[]),
                ...(res.allocTravail>0?[{l:`Allocation travail ONEM (${res.allocTravailLabel})`,m:res.allocTravail,onss:'❌ Non',pp:'✅ Retenu ONEM',ref:"AR 19/12/2001"}]:[]),
                ...(res.mvWorker>0?[{l:"Chèques-repas (part travailleur)",m:res.mvWorker,onss:'❌ Exonéré',pp:'❌ Exonéré',ref:"AR 28/11/1969 Art.19bis§2",hl:"green"}]:[]),
                {l:"▬ TOTAL RETENUES",m:res.totalDed,onss:'',pp:'',ref:"",bold:true,neg:true},
                {l:"▬ NET À PAYER",m:res.net,onss:'',pp:'',ref:"",bold:true,hl:"net"},
              ].map((x,i)=><tr key={i} style={{borderBottom:'1px solid '+(x.bold?'#c6a34e':'#e5e4df'),background:x.hl==='green'?'rgba(22,163,74,.03)':x.hl==='orange'?'rgba(251,146,60,.04)':x.hl==='net'?'rgba(22,163,74,.06)':'transparent'}}>
                <td style={{padding:'5px 8px',color:x.bold?'#1a1a18':'#555',fontWeight:x.bold?700:400,fontSize:x.bold?11:10.5}}>{x.l}</td>
                <td style={{padding:'5px 8px',textAlign:'center',fontWeight:600,color:x.neg?'#dc2626':x.bold?'#1a1a18':x.hl==='net'?'#16a34a':'#333',fontSize:x.bold?12:10.5}}>{x.neg?'-':''}{fmt(x.m)}</td>
                <td style={{padding:'5px 8px',textAlign:'center',color:x.onss?.includes('❌')?'#16a34a':x.onss?.includes('✅')?'#dc2626':'#999',fontWeight:600,fontSize:10}}>{x.onss||''}</td>
                <td style={{padding:'5px 8px',textAlign:'center',color:x.pp?.includes('❌')?'#16a34a':x.pp?.includes('✅')?'#dc2626':'#999',fontWeight:600,fontSize:10}}>{x.pp||''}</td>
                <td style={{padding:'5px 8px',fontSize:9,color:'#999'}}>{x.ref||''}</td>
              </tr>)}
            </tbody>
          </table>
        </div>

        {/* BOUTON EXPORT PDF */}
        <div style={{marginTop:14,display:'flex',gap:10,justifyContent:'center'}} className="no-print">
          <button onClick={()=>{
            generatePayslipPDF(emp,res,per,s.co)}} style={{padding:'12px 28px',background:"#c6a34e",color:'#fff',border:'none',borderRadius:8,fontSize:13,fontWeight:600,cursor:'pointer',letterSpacing:'.5px'}}>🖨 Imprimer / PDF</button>
          <button onClick={()=>{
            generatePayslipPDF(emp,res,per,s.co)
          }} style={{padding:'12px 28px',background:"transparent",color:'#c6a34e',border:'2px solid #c6a34e',borderRadius:8,fontSize:13,fontWeight:600,cursor:'pointer'}}>💾 Télécharger HTML</button>
        </div>
      </div>}
    </div>
    {s.pays.length>0&&<C className="no-print" style={{marginTop:20,padding:0,overflow:'hidden'}}>
      <div style={{padding:'14px 18px',borderBottom:'1px solid rgba(139,115,60,.1)'}}><div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Historique</div></div>
      <Tbl cols={[
        {k:'p',l:"Période",b:1,c:'#c6a34e',r:r=>r.period},{k:'e',l:"Employé",r:r=>r.ename},
        {k:'g',l:"Brut",a:'right',r:r=>fmt(r.gross)},{k:'o',l:"ONSS",a:'right',r:r=><span style={{color:'#f87171'}}>{fmt(r.onssNet)}</span>},
        {k:'t',l:"Précompte",a:'right',r:r=><span style={{color:'#f87171'}}>{fmt(r.tax)}</span>},
        {k:'n',l:"Net",a:'right',r:r=><span style={{fontWeight:700,color:'#4ade80'}}>{fmt(r.net)}</span>},
        {k:'c',l:"Coût",a:'right',r:r=><span style={{color:'#a78bfa'}}>{fmt(r.costTotal)}</span>},
      ]} data={s.pays}/>
    </C>}
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  DIMONA
// ═══════════════════════════════════════════════════════════════
function DimonaPage({s,d}) {
  const [f,setF]=useState({eid:(s.emps||[])[0]?.id||'',action:"IN",wtype:"OTH",start:new Date().toISOString().split('T')[0],end:"",hours:'',reason:'',dimonaP:'',planHrs:''});
  const [tab,setTab]=useState('new');
  const [filter,setFilter]=useState('all');
  const emp=(s.emps||[]).find(e=>e.id===f.eid);

  // Validation engine
  const validate=()=>{
    const errs=[];
    if(!emp) errs.push('Sélectionnez un travailleur');
    if(emp&&!emp.niss) errs.push('NISS manquant pour '+emp.first+' '+emp.last);
    if(!f.start) errs.push('Date de début obligatoire');
    if(f.action==='OUT'&&!f.end) errs.push('Date de fin obligatoire pour OUT');
    if(f.action==='UPDATE'&&!f.dimonaP) errs.push('Numéro Dimona période requis pour UPDATE');
    if(['STU',"FLX"].includes(f.wtype)&&!f.planHrs) errs.push('Heures planifiées obligatoires pour '+f.wtype);
    if(f.action==='IN'){
      const startD=new Date(f.start);const today=new Date();today.setHours(0,0,0,0);
      if(startD<today) errs.push('⚠ Dimona IN tardive (début passé) — amende possible');
    }
    if(f.action==='OUT'&&f.end&&f.start&&new Date(f.end)<new Date(f.start)) errs.push('Date fin avant date début');
    return errs;
  };
  const errs=validate();

  // Worker type descriptions
  const wtDescs={OTH:'Ordinaire',STU:'Étudiant (max 600h/an)',FLX:'Flexi-job',EXT:'Extra Horeca',DWD:'Travailleur occasionnel',IVT:'Stagiaire',BCW:'ALE/PWA',APP:'Apprenti',ART:'Artiste',SP1:'Travailleurs saisonniers',DIP:'Diplomate'};

  // Dimona type specific fields
  const needsEnd=f.action==='OUT'||f.wtype==='STU'||f.wtype==='FLX'||f.wtype==='EXT';
  const needsHours=['STU',"FLX","EXT","DWD"].includes(f.wtype);

  const [onssStatus,setOnssStatus]=useState(null);
  const [submitting,setSubmitting]=useState(false);

  // Check ONSS connection on mount
  useEffect(()=>{fetch('/api/onss/status').then(r=>r.json()).then(setOnssStatus).catch(()=>setOnssStatus({readiness:{oauthToken:false}}));},[]);

  const submitToONSS=async(declaration)=>{
    setSubmitting(true);
    try{
      const resp=await fetch('/api/onss/dimona',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(declaration)});
      const result=await resp.json();
      setSubmitting(false);
      return result;
    }catch(e){setSubmitting(false);return{success:false,error:e.message};}
  };

  const gen=()=>{
    if(errs.filter(e=>!e.startsWith('⚠')).length>0) return;
    const xml=genDimonaXML({action:f.action,wtype:f.wtype,start:f.start,end:f.end,hours:f.planHrs||f.hours,first:emp.first,last:emp.last,niss:emp.niss,birth:emp.birth,cp:emp.cp,onss:s.co.onss,vat:s.co.vat,dimonaP:f.dimonaP,reason:f.reason});
    const dimNr='DIM'+Date.now().toString(36).toUpperCase();

    // Build REST API payload
    const apiPayload={
      type:f.action,
      env:'simulation',
      employer:{noss:s.co.onss||'',enterpriseNumber:(s.co.vat||'').replace(/[^0-9]/g,'')},
      worker:{niss:emp.niss||'',firstName:emp.first||emp.fn||'',lastName:emp.last||emp.ln||'',birthDate:emp.birth||emp.birthDate||''},
      occupation:{startDate:f.start,jointCommissionNbr:emp.cp||'200',workerType:f.wtype,plannedHoursNbr:f.planHrs||undefined,plannedEndDate:f.end||undefined},
      endDate:f.end||undefined,
      periodId:f.dimonaP||undefined,
    };

    // Submit to ONSS REST API
    submitToONSS(apiPayload).then(result=>{
      const status=result.success?'accepted':'error';
      d({type:"ADD_DIM",d:{eid:emp.id,ename:`${emp.first} ${emp.last}`,action:f.action,wtype:f.wtype,wtypeDesc:wtDescs[f.wtype]||f.wtype,start:f.start,end:f.end,xml,at:new Date().toISOString(),status,dimNr:result.declarationId||dimNr,hours:f.planHrs||f.hours,reason:f.reason,onssResult:result}});
    });

    d({type:"ADD_DIM",d:{eid:emp.id,ename:`${emp.first} ${emp.last}`,action:f.action,wtype:f.wtype,wtypeDesc:wtDescs[f.wtype]||f.wtype,start:f.start,end:f.end,xml,at:new Date().toISOString(),status:'pending',dimNr,hours:f.planHrs||f.hours,reason:f.reason}});
    d({type:"MODAL",m:{w:850,c:<div>
      <h2 style={{fontSize:17,fontWeight:600,color:'#e8e6e0',margin:'0 0 6px',fontFamily:"'Cormorant Garamond',serif"}}>Dimona {f.action} — {emp.first} {emp.last}</h2>
      <div style={{display:'flex',gap:8,marginBottom:12}}>
        <span style={{fontSize:10,padding:'3px 10px',borderRadius:4,background:"rgba(74,222,128,.1)",color:'#4ade80',fontWeight:600}}>✓ XML généré</span>
        <span style={{fontSize:10,padding:'3px 10px',borderRadius:4,background:"rgba(198,163,78,.1)",color:'#c6a34e',fontWeight:600}}>{f.wtype} — {wtDescs[f.wtype]||f.wtype}</span>
        <span style={{fontSize:10,padding:'3px 10px',borderRadius:4,background:"rgba(96,165,250,.1)",color:'#60a5fa',fontWeight:600}}>Réf: {dimNr}</span>
      </div>
      {errs.filter(e=>e.startsWith('⚠')).map((e,i)=><div key={i} style={{fontSize:10.5,color:'#f59e0b',marginBottom:6}}>⚠ {e.replace('⚠ ',"")}</div>)}
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:12}}>
        <div style={{padding:10,background:"rgba(198,163,78,.05)",borderRadius:6,fontSize:11,color:'#9e9b93',lineHeight:1.8}}>
          <div style={{fontWeight:600,color:'#c6a34e',marginBottom:4}}>Identifiants</div>
          <div>Travailleur: <b style={{color:'#e8e6e0'}}>{emp.first} {emp.last}</b></div>
          <div>NISS: <b style={{color:'#e8e6e0',fontFamily:'monospace'}}>{emp.niss}</b></div>
          <div>CP: <b style={{color:'#e8e6e0'}}>{emp.cp}</b></div>
        </div>
        <div style={{padding:10,background:"rgba(96,165,250,.05)",borderRadius:6,fontSize:11,color:'#9e9b93',lineHeight:1.8}}>
          <div style={{fontWeight:600,color:'#60a5fa',marginBottom:4}}>Déclaration</div>
          <div>Action: <b style={{color:'#e8e6e0'}}>{f.action}</b></div>
          <div>Type: <b style={{color:'#e8e6e0'}}>{f.wtype} ({wtDescs[f.wtype]})</b></div>
          <div>Début: <b style={{color:'#e8e6e0'}}>{f.start}</b></div>
          {f.end&&<div>Fin: <b style={{color:'#e8e6e0'}}>{f.end}</b></div>}
        </div>
      </div>
      <pre style={{background:"#060810",border:'1px solid rgba(139,115,60,.15)',borderRadius:8,padding:14,fontSize:10,color:'#9e9b93',overflowX:'auto',whiteSpace:'pre-wrap',maxHeight:320,overflowY:'auto'}}>{xml}</pre>
      <div style={{display:'flex',gap:10,marginTop:14,justifyContent:'flex-end'}}>
        <B v="outline" onClick={()=>d({type:"MODAL",m:null})}>Fermer</B>
        <B onClick={()=>{navigator.clipboard?.writeText(xml);alert('XML Dimona copié !')}}>Copier XML</B>
      </div>
    </div>}});
  };

  // Stats
  const statsIN=s.dims.filter(x=>x.action==='IN').length;
  const statsOUT=s.dims.filter(x=>x.action==='OUT').length;
  const statsUPD=s.dims.filter(x=>x.action==='UPDATE').length;
  const filtered=filter==='all'?s.dims:s.dims.filter(x=>x.action===filter);

  return <div>
    <PH title="Déclarations Dimona" sub="Déclaration immédiate de l'emploi — ONSS REST v2 — Connecté via Chaman"/>
    {/* ONSS Connection Status */}
    <div style={{marginBottom:14,padding:"12px 16px",background:onssStatus?.readiness?.chamanConfig?"linear-gradient(135deg,rgba(34,197,94,.06),rgba(34,197,94,.02))":"linear-gradient(135deg,rgba(251,146,56,.06),rgba(251,146,56,.02))",border:"1px solid "+(onssStatus?.readiness?.chamanConfig?"rgba(34,197,94,.15)":"rgba(251,146,56,.15)"),borderRadius:10,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
      <div style={{display:"flex",alignItems:"center",gap:10}}>
        <div style={{width:8,height:8,borderRadius:"50%",background:onssStatus?.readiness?.chamanConfig?"#22c55e":"#fb923c"}}/>
        <div>
          <div style={{fontSize:12,fontWeight:600,color:onssStatus?.readiness?.chamanConfig?"#22c55e":"#fb923c"}}>{onssStatus?.readiness?.chamanConfig?"Connecté à l'ONSS REST v2":"Configuration Chaman en attente"}</div>
          <div style={{fontSize:10,color:"#5e5c56"}}>{onssStatus?.enterprise?.identificationRef||"DGIII/MAHI011/1028.230.781"} — Aureus IA SPRL — {onssStatus?.configuration?.env||"simulation"}</div>
        </div>
      </div>
      <div style={{display:"flex",gap:6}}>
        <button onClick={()=>fetch('/api/onss/status?test=true').then(r=>r.json()).then(r=>{setOnssStatus(r);alert(r.readiness?.oauthToken?'✅ Token OAuth OK — Dimona prêt':'❌ Token échoué: '+(r.configuration?.oauthError||'Vérifiez les env vars'))})} style={{padding:"6px 14px",borderRadius:8,border:"none",background:"rgba(96,165,250,.15)",color:"#60a5fa",fontSize:10,cursor:"pointer",fontWeight:600}}>Tester connexion</button>
        <span style={{fontSize:9,padding:"4px 10px",borderRadius:6,background:"rgba(198,163,78,.08)",color:"#c6a34e",display:"flex",alignItems:"center"}}>{submitting?"⏳ Envoi en cours...":"REST v2 / OAuth2 JWT"}</span>
      </div>
    </div>
    <div style={{marginBottom:14,padding:"10px 14px",background:"linear-gradient(135deg,rgba(59,130,246,.06),rgba(59,130,246,.02))",border:"1px solid rgba(59,130,246,.1)",borderRadius:10,display:"flex",alignItems:"center",justifyContent:"space-between"}}><div style={{fontSize:11,color:"#888"}}>⚡ Dimona automatique à chaque embauche/sortie</div><button onClick={()=>{if(confirm("Générer Dimona IN pour tous ?")){(s.emps||[]).forEach(e=>generateDimonaXML(e,"IN",s.co));alert("✅ Dimona générées")}}} style={{padding:"6px 14px",borderRadius:8,border:"none",background:"#3b82f6",color:"#fff",fontSize:11,cursor:"pointer",fontWeight:600}}>⚡ Générer tout</button></div><div style={{display:"flex",gap:8,marginBottom:16,flexWrap:"wrap"}}>{s.emps.filter(e=>e.status==="active"||!e.status).map(e=><div key={e.id} style={{display:"flex",gap:4}}><button onClick={()=>generateDimonaXML(e,"IN",s.co)} style={{padding:"6px 12px",borderRadius:6,border:"none",cursor:"pointer",fontSize:11,fontWeight:600,background:"rgba(74,222,128,.15)",color:"#4ade80"}}>IN {e.first||e.fn} {e.last||e.ln}</button><button onClick={()=>generateDimonaXML(e,"OUT",s.co)} style={{padding:"6px 12px",borderRadius:6,border:"none",cursor:"pointer",fontSize:11,fontWeight:600,background:"rgba(248,113,113,.15)",color:"#f87171"}}>OUT {e.first||e.fn} {e.last||e.ln}</button></div>)}</div>
    <div style={{marginBottom:12}}><button onClick={()=>generateSEPAXML(s.emps,per,s.co)} style={{padding:"8px 16px",borderRadius:6,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,background:"rgba(96,165,250,.15)",color:"#60a5fa"}}>Generer SEPA XML (virements)</button></div>{/* Stats bar */}
    <div style={{display:'flex',gap:12,marginBottom:18}}>
      {[{l:"Total",v:s.dims.length,c:'#c6a34e'},{l:"IN",v:statsIN,c:'#4ade80'},{l:"OUT",v:statsOUT,c:'#f87171'},{l:"UPDATE",v:statsUPD,c:'#60a5fa'}].map((st,i)=>
        <div key={i} style={{flex:1,padding:'12px 16px',background:"rgba(198,163,78,.04)",borderRadius:10,border:'1px solid rgba(198,163,78,.08)'}}>
          <div style={{fontSize:10,color:'#5e5c56',textTransform:'uppercase',letterSpacing:'.5px'}}>{st.l}</div>
          <div style={{fontSize:22,fontWeight:700,color:st.c,marginTop:2}}>{st.v}</div>
        </div>
      )}
    </div>
    {/* Tabs */}
    <div style={{display:'flex',gap:6,marginBottom:16}}>
      {[{v:"new",l:"Nouvelle déclaration"},{v:"history",l:"Historique"},{v:"rules",l:"Règles & Délais"}].map(t=>
        <button key={t.v} onClick={()=>setTab(t.v)} style={{padding:'8px 16px',borderRadius:8,border:'none',cursor:'pointer',fontSize:12,fontWeight:tab===t.v?600:400,fontFamily:'inherit',
          background:tab===t.v?'rgba(198,163,78,.15)':'rgba(255,255,255,.03)',color:tab===t.v?'#c6a34e':'#9e9b93'}}>{t.l}</button>
      )}
    </div>

    {tab==='new'&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:18}}>
      <C><ST>Déclaration Dimona</ST>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:9}}>
          <I label="Travailleur" value={f.eid} onChange={v=>setF({...f,eid:v})} span={2} options={(s.emps||[]).map(e=>({v:e.id,l:`${e.first||e.fn||'Emp'} ${e.last||''} ${e.niss?'':'⚠ NISS!'}`}))}/>
          <I label="Action" value={f.action} onChange={v=>setF({...f,action:v})} options={[{v:"IN",l:"IN — Entrée en service"},{v:"OUT",l:"OUT — Sortie de service"},{v:"UPDATE",l:"UPDATE — Modification"},{v:"CANCEL",l:"CANCEL — Annulation"}]}/>
          <I label="Type travailleur" value={f.wtype} onChange={v=>setF({...f,wtype:v})} options={Object.entries(wtDescs).map(([k,v])=>({v:k,l:`${k} — ${v}`}))}/>
          <I label="Date début" type="date" value={f.start} onChange={v=>setF({...f,start:v})}/>
          {needsEnd&&<I label="Date fin" type="date" value={f.end} onChange={v=>setF({...f,end:v})}/>}
          {needsHours&&<I label="Heures planifiées" type="number" value={f.planHrs} onChange={v=>setF({...f,planHrs:v})}/>}
          {f.action==='OUT'&&<I label="Motif sortie" value={f.reason} onChange={v=>setF({...f,reason:v})} options={[{v:"",l:"— Sélectionner —"},{v:"DEM",l:"Démission"},{v:"LIC",l:"Licenciement"},{v:"RUP",l:"Rupture amiable"},{v:"FIN",l:"Fin contrat déterminé"},{v:"RET",l:"Retraite"},{v:"DEC",l:"Décès"},{v:"FOR",l:"Force majeure"}]}/>}
          {f.action==='UPDATE'&&<I label="N° Dimona période" value={f.dimonaP} onChange={v=>setF({...f,dimonaP:v})}/>}
        </div>
        {/* Validation errors */}
        {errs.length>0&&<div style={{marginTop:12,padding:10,background:errs.some(e=>!e.startsWith('⚠'))?'rgba(239,68,68,.06)':'rgba(245,158,11,.06)',borderRadius:8,border:`1px solid ${errs.some(e=>!e.startsWith('⚠'))?'rgba(239,68,68,.15)':'rgba(245,158,11,.15)'}`}}>
          {errs.map((e,i)=><div key={i} style={{fontSize:10.5,color:e.startsWith('⚠')?'#f59e0b':'#ef4444',padding:'2px 0'}}>• {e}</div>)}
        </div>}
        <B onClick={gen} disabled={errs.filter(e=>!e.startsWith('⚠')).length>0} style={{width:'100%',marginTop:14,opacity:errs.filter(e=>!e.startsWith('⚠')).length>0?.5:1}}>Générer Dimona {f.action}</B>
      </C>
      <div>
        <C><ST>Info type: {f.wtype}</ST>
          <div style={{fontSize:12,color:'#9e9b93',lineHeight:1.7}}>
            {f.wtype==='OTH'&&<>Type ordinaire — contrat à durée déterminée ou indéterminée. Pas de champs spécifiques supplémentaires.</>}
            {f.wtype==='STU'&&<><b style={{color:'#c6a34e'}}>Étudiant:</b> Max 600h/an exonérées cotisations ONSS normales (cotis solidarité 5,42% + 2,71%). Heures planifiées obligatoires. Vérifier compteur Student@Work.</>}
            {f.wtype==='FLX'&&<><b style={{color:'#c6a34e'}}>Flexi-job:</b> Exclusivement pour secteurs autorisés (Horeca CP 302, Commerce CP 201/202, etc.). Travailleur doit avoir un emploi principal à min 4/5. Net = Brut (pas d'ONSS/PP). Cotis patronale 28%.</>}
            {f.wtype==='EXT'&&<><b style={{color:'#c6a34e'}}>Extra Horeca:</b> Maximum 50 jours/an. Forfait journalier ONSS. Uniquement CP 302.</>}
            {f.wtype==='DWD'&&<><b style={{color:'#c6a34e'}}>Occasionnel:</b> Travailleurs occasionnels agriculture/horticulture. Forfait journalier.</>}
            {f.wtype==='IVT'&&<><b style={{color:'#c6a34e'}}>Stagiaire:</b> Convention d'immersion professionnelle (CIP). Pas de cotisations ONSS normales si indemnité ≤ plafond.</>}
            {f.wtype==='APP'&&<><b style={{color:'#c6a34e'}}>Apprenti:</b> Contrat d'apprentissage (IFAPME/EFP/VDAB/Syntra). Cotisations réduites.</>}
            {f.wtype==='ART'&&<><b style={{color:'#c6a34e'}}>Artiste:</b> Visa artiste ou déclaration d'activité artistique. Régime spécifique.</>}
            {!['OTH',"STU","FLX","EXT","DWD","IVT","APP","ART"].includes(f.wtype)&&<>Type spécifique — consultez la documentation ONSS.</>}
          </div>
        </C>
        <C style={{marginTop:12}}><ST>Rappels légaux</ST>
          <div style={{fontSize:11,color:'#9e9b93',lineHeight:1.7}}>
            <div style={{padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <b style={{color:'#4ade80'}}>IN:</b> Au plus tard au <b>moment</b> de la mise au travail</div>
            <div style={{padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <b style={{color:'#f87171'}}>OUT:</b> Au plus tard le <b>dernier jour</b> de travail</div>
            <div style={{padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <b style={{color:'#60a5fa'}}>UPDATE:</b> Dès que la modification est connue</div>
            <div style={{padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <b style={{color:'#a78bfa'}}>CANCEL:</b> Si le travailleur ne se présente pas</div>
            <div style={{padding:'6px 0',marginTop:6,background:"rgba(239,68,68,.06)",borderRadius:6,paddingLeft:8}}>
              <b style={{color:'#ef4444'}}>Amendes:</b> 2.500€ à 12.500€ par travailleur non déclaré (Code pénal social Art. 181)
            </div>
          </div>
        </C>
      </div>
    </div>}

    {tab==='history'&&<C style={{padding:0,overflow:'hidden'}}>
      <div style={{padding:'14px 18px',borderBottom:'1px solid rgba(139,115,60,.1)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Historique Dimona ({filtered.length})</div>
        <div style={{display:'flex',gap:6}}>
          {['all',"IN","OUT","UPDATE"].map(v=>
            <button key={v} onClick={()=>setFilter(v)} style={{padding:'4px 10px',borderRadius:6,border:'none',cursor:'pointer',fontSize:10,fontFamily:'inherit',fontWeight:filter===v?600:400,
              background:filter===v?'rgba(198,163,78,.15)':'rgba(255,255,255,.04)',color:filter===v?'#c6a34e':'#9e9b93'}}>{v==='all'?'Tous':v}</button>
          )}
        </div>
      </div>
      <Tbl cols={[
        {k:'a',l:"Action",r:r=><span style={{padding:'2px 7px',borderRadius:4,fontSize:10.5,fontWeight:600,background:r.action==='IN'?'rgba(74,222,128,.1)':r.action==='OUT'?'rgba(248,113,113,.1)':r.action==='UPDATE'?'rgba(96,165,250,.1)':'rgba(167,139,250,.1)',color:r.action==='IN'?'#4ade80':r.action==='OUT'?'#f87171':r.action==='UPDATE'?'#60a5fa':'#a78bfa'}}>{r.action}</span>},
        {k:'t',l:"Type",r:r=><span style={{fontSize:10,color:'#c6a34e'}}>{r.wtype} {r.wtypeDesc?`(${r.wtypeDesc})`:''}</span>},
        {k:'e',l:"Travailleur",r:r=>r.ename},
        {k:'s',l:"Début",r:r=>r.start},{k:'en',l:"Fin",r:r=>r.end||'—'},
        {k:'h',l:"Heures",r:r=>r.hours||'—'},
        {k:'r',l:"Réf",r:r=><span style={{fontFamily:'monospace',fontSize:9.5,color:'#60a5fa'}}>{r.dimNr||'—'}</span>},
        {k:'st',l:"Statut",r:r=><span style={{color:'#4ade80',fontSize:11}}>✓</span>},
        {k:'x',l:"",a:'right',r:r=><B v="ghost" style={{padding:'3px 8px',fontSize:10}} onClick={()=>d({type:"MODAL",m:{w:800,c:<div><h3 style={{color:'#e8e6e0',margin:'0 0 10px'}}>Dimona {r.action} — {r.ename}</h3><pre style={{background:"#060810",border:'1px solid rgba(139,115,60,.15)',borderRadius:8,padding:14,fontSize:10,color:'#9e9b93',whiteSpace:'pre-wrap',maxHeight:380,overflowY:'auto'}}>{r.xml}</pre><div style={{display:'flex',gap:10,marginTop:12,justifyContent:'flex-end'}}><B v="outline" onClick={()=>d({type:"MODAL",m:null})}>Fermer</B><B onClick={()=>{navigator.clipboard?.writeText(r.xml);alert('Copié !')}}>Copier</B></div></div>}})}>XML</B>},
      ]} data={filtered}/>
    </C>}

    {tab==='rules'&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:18}}>
      <C><ST>Délais légaux par type</ST>
        <div style={{fontSize:11,color:'#9e9b93',lineHeight:1.8}}>
          {[{t:'OTH — Ordinaire',d:"IN: avant mise au travail. OUT: dernier jour.",c:'#e8e6e0'},
            {t:'STU — Étudiant',d:"IN: avant début. Vérifier Student@Work (600h/an). OUT: dernier jour.",c:'#60a5fa'},
            {t:'FLX — Flexi-job',d:"IN: avant chaque prestation. OUT: dernier jour prestation. Heures planifiées obligatoires.",c:'#4ade80'},
            {t:'EXT — Extra Horeca',d:"IN: avant mise au travail. Max 50j/an. Forfait ONSS journalier.",c:'#f59e0b'},
            {t:'DWD — Occasionnel',d:"Agriculture/horticulture. Dimona journalière.",c:'#a78bfa'},
            {t:'APP — Apprenti',d:"Comme ordinaire + numéro contrat apprentissage.",c:'#f87171'},
          ].map((r,i)=><div key={i} style={{padding:'8px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
            <div style={{fontWeight:600,color:r.c}}>{r.t}</div><div style={{fontSize:10.5,marginTop:2}}>{r.d}</div>
          </div>)}
        </div>
      </C>
      <C><ST>Sanctions & Amendes</ST>
        <div style={{fontSize:11,color:'#9e9b93',lineHeight:1.8}}>
          {[{l:"Absence de Dimona IN",a:'Niveau 4: 2.500€ — 12.500€/travailleur',s:'Art. 181 CPS'},{l:"Dimona IN tardive",a:'Niveau 2: 400€ — 4.000€',s:'Art. 182 CPS'},{l:"Absence de Dimona OUT",a:'Niveau 2: 400€ — 4.000€',s:'Art. 182 CPS'},{l:"Données inexactes",a:'Niveau 2: 400€ — 4.000€',s:'Art. 182 CPS'},{l:"Récidive dans les 12 mois",a:'Amende doublée',s:'Art. 111 CPS'}].map((r,i)=>
            <div key={i} style={{padding:'8px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <div style={{fontWeight:600,color:'#e8e6e0'}}>{r.l}</div>
              <div style={{color:'#f87171',fontSize:10.5}}>{r.a}</div>
              <div style={{color:'#5e5c56',fontSize:10}}>{r.s}</div>
            </div>
          )}
        </div>
        <div style={{marginTop:14,padding:10,background:"rgba(96,165,250,.06)",borderRadius:8,fontSize:10.5,color:'#60a5fa',lineHeight:1.5}}>
          <b>Portail:</b> www.socialsecurity.be → Dimona Web<br/>
          <b>Batch:</b> Envoi XML via canal sécurisé (FTP/MQ)<br/>
          <b>Helpdesk:</b> Contact Center ONSS — 02/509 59 59
        </div>
      </C>
    </div>}
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  DMFA
// ═══════════════════════════════════════════════════════════════
function DMFAPage({s,d}) {
  const [q,setQ]=useState(Math.ceil((new Date().getMonth()+1)/3));
  const [y,setY]=useState(new Date().getFullYear());
  const [view,setView]=useState('detail');
  const ae=(s.emps||[]).filter(e=>e.status==='active');
  const sum=ae.map(e=>{
    const p=calc(e,{...DPER,days:65},s.co);
    const isOuv=(e.statut==='ouvrier');
    const base=isOuv?p.gross*3*TX_OUV108:p.gross*3;
    return{e,g3:p.gross*3,base3:base,isOuv,ow3:p.onssNet*3,oe3:p.onssE*3,
      ffe3:p.onss_ffe*3,chomT3:p.onss_chomTemp*3,amia3:p.onss_amiante*3,
      rate:p.onssE_rate,note:p.onssE_note,type:p.onssE_type};
  });
  const tot=sum.reduce((a,r)=>({g:a.g+r.g3,b:a.b+r.base3,ow:a.ow+r.ow3,oe:a.oe+r.oe3,ffe:a.ffe+r.ffe3,ct:a.ct+r.chomT3,am:a.am+r.amia3}),{g:0,b:0,ow:0,oe:0,ffe:0,ct:0,am:0});

  // Calendrier ONSS 2026 — provisions mensuelles (le 5) + solde trimestriel
  const calONSS=[
    {p:'T1 2026',prov:['05/02',"05/03","05/04"],solde:'30/04/2026'},
    {p:'T2 2026',prov:['05/05',"05/06","05/07"],solde:'31/07/2026'},
    {p:'T3 2026',prov:['05/08',"05/09","05/10"],solde:'31/10/2026'},
    {p:'T4 2026',prov:['05/11',"05/12","05/01/2027"],solde:'31/01/2027'},
  ];

  const [ticket,setTicket]=useState(null);
  const gen=()=>{
    const xml=genDMFAXML(s.co,ae,q,y);
    const refMatch=xml.match(/Reference>([^<]+)</);
    const ref=refMatch?refMatch[1]:'REF-'+Date.now();
    const acrf=genDMFATicket(ref,s.co);
    const totAll=tot.ow+tot.oe+tot.ffe+tot.ct+tot.am;
    const anomalies=[];
    ae.forEach(e=>{if(!e.niss)anomalies.push({zone:'INSS',sev:"E",desc:`NISS manquant pour ${e.first||e.fn||'Emp'} ${e.last||''}`});});
    if(!s.co.onss)anomalies.push({zone:'NLOSSRegistrationNbr',sev:"E",desc:"Matricule ONSS employeur manquant"});
    const notif=genDMFANotification(acrf.ticket,s.co,q,y,ae.length,totAll.toFixed(2),anomalies);
    d({type:"ADD_DMFA",d:{q,y,cnt:ae.length,xml,ticket:acrf.ticket,ref,at:new Date().toISOString()}});
    setTicket({ref,ticket:acrf.ticket,acrfXml:acrf.xml,notifXml:notif,anomalies,xml});
    d({type:"MODAL",m:{w:950,c:<div>
      <h2 style={{fontSize:17,fontWeight:600,color:'#e8e6e0',margin:'0 0 6px',fontFamily:"'Cormorant Garamond',serif"}}>DMFA T{q}/{y} — Envoi simulé</h2>
      <div style={{display:'flex',gap:8,marginBottom:14}}>
        <span style={{fontSize:10,padding:'3px 10px',borderRadius:4,background:"rgba(74,222,128,.1)",color:'#4ade80',fontWeight:600}}>✓ ACRF positif</span>
        <span style={{fontSize:10,padding:'3px 10px',borderRadius:4,background:anomalies.length>0?'rgba(198,163,78,.1)':'rgba(74,222,128,.1)',color:anomalies.length>0?'#c6a34e':'#4ade80',fontWeight:600}}>{anomalies.length>0?`⚠ ${anomalies.length} anomalie(s)`:'✓ Acceptée sans anomalie'}</span>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:14}}>
        <div style={{padding:10,background:"rgba(198,163,78,.05)",borderRadius:6,fontSize:11,color:'#9e9b93',lineHeight:1.8}}>
          <div style={{fontWeight:600,color:'#c6a34e',marginBottom:4}}>Identifiants</div>
          <div>Référence: <b style={{color:'#e8e6e0',fontFamily:'monospace'}}>{ref}</b></div>
          <div>Ticket ONSS: <b style={{color:'#4ade80',fontFamily:'monospace'}}>{acrf.ticket}</b></div>
          <div>Trimestre: <b style={{color:'#e8e6e0'}}>T{q}/{y}</b></div>
          <div>Travailleurs: <b style={{color:'#e8e6e0'}}>{ae.length}</b></div>
          <div>Total cotisations: <b style={{color:'#c6a34e'}}>{fmt(totAll)}</b></div>
        </div>
        <div style={{padding:10,background:"rgba(96,165,250,.05)",borderRadius:6,fontSize:11,color:'#9e9b93',lineHeight:1.8}}>
          <div style={{fontWeight:600,color:'#60a5fa',marginBottom:4}}>Flux ONSS</div>
          <div>1. <span style={{color:'#4ade80'}}>✓</span> Envoi XML DmfAOriginal</div>
          <div>2. <span style={{color:'#4ade80'}}>✓</span> Accusé de réception (ACRF) positif</div>
          <div>3. <span style={{color:'#4ade80'}}>✓</span> Notification (DMNO) — acceptée</div>
          <div>4. <span style={{color:'#60a5fa'}}>→</span> PID reçu (identifiants permanents)</div>
          <div>5. <span style={{color:'#5e5c56'}}>○</span> Éventuelle notification de modification</div>
        </div>
      </div>
      {anomalies.length>0&&<div style={{padding:10,background:"rgba(248,113,113,.05)",borderRadius:6,marginBottom:14,border:'1px solid rgba(248,113,113,.1)'}}>
        <div style={{fontSize:11,fontWeight:600,color:'#f87171',marginBottom:6}}>Anomalies détectées</div>
        {anomalies.map((a,i)=><div key={i} style={{fontSize:11,color:'#9e9b93',padding:'3px 0'}}>• <b style={{color:'#f87171'}}>{a.zone}</b>: {a.desc}</div>)}
      </div>}
      <pre style={{background:"#060810",border:'1px solid rgba(139,115,60,.15)',borderRadius:8,padding:14,fontSize:9.5,color:'#9e9b93',overflowX:'auto',whiteSpace:'pre-wrap',maxHeight:350,overflowY:'auto'}}>{xml}</pre>
      <div style={{display:'flex',gap:10,marginTop:14,justifyContent:'flex-end'}}>
        <B v="outline" onClick={()=>d({type:"MODAL",m:null})}>Fermer</B>
        <B v="outline" onClick={()=>{navigator.clipboard?.writeText(acrf.xml);alert('ACRF copié !')}}>Copier ACRF</B>
        <B onClick={()=>{navigator.clipboard?.writeText(xml);alert('XML DMFA copié !')}}>Copier XML</B>
      </div>
    </div>}});
  };
  return <div>
    <PH title="Déclaration DMFA" sub="Trimestrielle — ONSS"/>
    <div style={{display:'grid',gridTemplateColumns:'300px 1fr',gap:18}}>
      <div>
      <C><ST>Période</ST>
        <I label="Trimestre" value={q} onChange={v=>setQ(parseInt(v))} options={[{v:1,l:"T1 (Jan-Mar)"},{v:2,l:"T2 (Avr-Jun)"},{v:3,l:"T3 (Jul-Sep)"},{v:4,l:"T4 (Oct-Déc)"}]}/>
        <I label="Année" type="number" value={y} onChange={v=>setY(v)} style={{marginTop:9}}/>
        <I label="Vue" value={view} onChange={setView} style={{marginTop:9}} options={[{v:"detail",l:"Détail par travailleur"},{v:"ventil",l:"Ventilation cotisations"},{v:"calendar",l:"Calendrier ONSS"}]}/>
        <B onClick={gen} style={{width:'100%',marginTop:14}}>Générer DMFA T{q}/{y}</B>
        {ticket&&<div style={{marginTop:12,padding:10,background:"rgba(74,222,128,.05)",borderRadius:8,border:'1px solid rgba(74,222,128,.15)'}}>
          <div style={{fontSize:11,fontWeight:600,color:'#4ade80',marginBottom:6}}>✓ Dernier envoi</div>
          <div style={{fontSize:10.5,color:'#9e9b93',lineHeight:2}}>
            <div>Ticket: <b style={{color:'#4ade80',fontFamily:'monospace',fontSize:9.5}}>{ticket.ticket}</b></div>
            <div>Réf: <b style={{color:'#e8e6e0',fontFamily:'monospace',fontSize:9.5}}>{ticket.ref}</b></div>
            <div>Anomalies: <b style={{color:ticket.anomalies.length>0?'#f87171':'#4ade80'}}>{ticket.anomalies.length>0?ticket.anomalies.length+' ⚠':'Aucune ✓'}</b></div>
          </div>
          <div style={{display:'flex',gap:6,marginTop:6}}>
            <B v="ghost" style={{padding:'3px 8px',fontSize:9.5}} onClick={()=>d({type:"MODAL",m:{w:700,c:<div><h3 style={{color:'#e8e6e0',margin:'0 0 10px'}}>Accusé de réception (ACRF)</h3><pre style={{background:"#060810",border:'1px solid rgba(139,115,60,.15)',borderRadius:8,padding:12,fontSize:9.5,color:'#9e9b93',whiteSpace:'pre-wrap',maxHeight:300,overflowY:'auto'}}>{ticket.acrfXml}</pre><B v="outline" onClick={()=>d({type:"MODAL",m:null})} style={{marginTop:10}}>Fermer</B></div>}})}>ACRF</B>
            <B v="ghost" style={{padding:'3px 8px',fontSize:9.5}} onClick={()=>d({type:"MODAL",m:{w:700,c:<div><h3 style={{color:'#e8e6e0',margin:'0 0 10px'}}>Notification (DMNO)</h3><pre style={{background:"#060810",border:'1px solid rgba(139,115,60,.15)',borderRadius:8,padding:12,fontSize:9.5,color:'#9e9b93',whiteSpace:'pre-wrap',maxHeight:300,overflowY:'auto'}}>{ticket.notifXml}</pre><B v="outline" onClick={()=>d({type:"MODAL",m:null})} style={{marginTop:10}}>Fermer</B></div>}})}>DMNO</B>
            <B v="ghost" style={{padding:'3px 8px',fontSize:9.5}} onClick={()=>d({type:"MODAL",m:{w:900,c:<div><h3 style={{color:'#e8e6e0',margin:'0 0 10px'}}>XML DmfAOriginal complet</h3><pre style={{background:"#060810",border:'1px solid rgba(139,115,60,.15)',borderRadius:8,padding:12,fontSize:9,color:'#9e9b93',whiteSpace:'pre-wrap',maxHeight:400,overflowY:'auto'}}>{ticket.xml}</pre><B v="outline" onClick={()=>d({type:"MODAL",m:null})} style={{marginTop:10}}>Fermer</B></div>}})}>XML</B>
          </div>
        </div>}
        <div style={{marginTop:18,padding:12,background:"rgba(198,163,78,.05)",borderRadius:8,border:'1px solid rgba(198,163,78,.1)'}}>
          <div style={{fontSize:11.5,fontWeight:600,color:'#c6a34e',marginBottom:6}}>Récapitulatif T{q}/{y}</div>
          <div style={{fontSize:11.5,color:'#9e9b93',lineHeight:2}}>
            <div>Travailleurs: <b style={{color:'#e8e6e0'}}>{ae.length}</b> ({sum.filter(s2=>s2.isOuv).length} ouv. / {sum.filter(s2=>!s2.isOuv).length} empl.)</div>
            <div>Masse brute: <b style={{color:'#e8e6e0'}}>{fmt(tot.g)}</b></div>
            <div>Base ONSS (108%): <b style={{color:'#e8e6e0'}}>{fmt(tot.b)}</b></div>
            <div>ONSS trav.: <b style={{color:'#f87171'}}>{fmt(tot.ow)}</b></div>
            <div>ONSS empl.: <b style={{color:'#f87171'}}>{fmt(tot.oe)}</b></div>
            <div style={{borderTop:'1px solid rgba(198,163,78,.15)',paddingTop:4,marginTop:4}}>Total ONSS: <b style={{color:'#c6a34e'}}>{fmt(tot.ow+tot.oe)}</b></div>
          </div>
        </div>
        <div style={{marginTop:10,padding:8,background:"rgba(96,165,250,.06)",borderRadius:6,fontSize:10,color:'#60a5fa',lineHeight:1.6}}>
          <b>Provisions:</b> le 5 de chaque mois<br/>
          <b>Solde trim.:</b> dernier jour du mois suivant<br/>
          <b>Ouvriers:</b> base = brut × 108%<br/>
          <b>Marchand:</b> 25% | <b>Non-marchand:</b> 32,40%
        </div>
      </C>
      </div>
      <C style={{padding:0,overflow:'hidden'}}>
        {view==='detail'&&<><div style={{padding:'14px 18px',borderBottom:'1px solid rgba(139,115,60,.1)'}}><div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Détail T{q}/{y}</div></div>
        <Tbl cols={[
          {k:'n',l:"Travailleur",r:r=><span style={{fontWeight:500}}>{r.e.first} {r.e.last}</span>},
          {k:'st',l:"Statut",r:r=><span style={{fontSize:10,padding:'2px 6px',borderRadius:4,background:r.isOuv?'rgba(248,113,113,.1)':'rgba(96,165,250,.1)',color:r.isOuv?'#f87171':'#60a5fa'}}>{r.isOuv?'Ouvrier':'Employé'}</span>},
          {k:'c',l:"Code",r:r=>r.e.dmfaCode},{k:'cp',l:"CP",r:r=>r.e.cp},
          {k:'b',l:"Base ONSS",a:'right',r:r=><span style={{fontSize:11}}>{fmt(r.base3)}{r.isOuv?' (108%)':''}</span>},
          {k:'ow',l:"ONSS trav.",a:'right',r:r=><span style={{color:'#f87171'}}>{fmt(r.ow3)}</span>},
          {k:'oe',l:"ONSS empl.",a:'right',r:r=><span style={{color:'#f87171'}}>{fmt(r.oe3)}</span>},
          {k:'r',l:"Taux",a:'right',r:r=><span style={{fontSize:10,color:'#c6a34e'}}>{(r.rate*100).toFixed(1)}%</span>},
        ]} data={sum}/></>}

        {view==='ventil'&&<><div style={{padding:'14px 18px',borderBottom:'1px solid rgba(139,115,60,.1)'}}><div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Ventilation cotisations T{q}/{y}</div></div>
        <div style={{padding:18}}>
          {[
            {l:"Cotisation patronale de base",v:tot.oe,pct:(tot.oe/tot.b*100).toFixed(2),c:'#f87171'},
            {l:"Cotisation Fonds fermeture (FFE)",v:tot.ffe,pct:(tot.ffe/tot.b*100).toFixed(3),c:'#a78bfa'},
            {l:"Cotisation chômage temporaire",v:tot.ct,pct:(tot.ct/tot.b*100).toFixed(3),c:'#60a5fa'},
            {l:"Cotisation Fonds amiante",v:tot.am,pct:(tot.am/tot.b*100).toFixed(4),c:'#4ade80'},
            {l:"ONSS travailleur (13,07%)",v:tot.ow,pct:"13.07",c:'#f87171'},
          ].map((r,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
            <span style={{fontSize:12,color:'#9e9b93'}}>{r.l}</span>
            <span style={{display:'flex',gap:12,alignItems:'center'}}>
              <span style={{fontSize:10,color:'#5e5c56'}}>{r.pct}%</span>
              <span style={{fontWeight:600,color:r.c,fontSize:13,minWidth:90,textAlign:'right'}}>{fmt(r.v)}</span>
            </span>
          </div>)}
          <div style={{display:'flex',justifyContent:'space-between',padding:'12px 0',borderTop:'2px solid rgba(198,163,78,.3)',marginTop:8}}>
            <span style={{fontSize:13,fontWeight:700,color:'#e8e6e0'}}>TOTAL ONSS à verser</span>
            <span style={{fontSize:16,fontWeight:700,color:'#c6a34e'}}>{fmt(tot.ow+tot.oe+tot.ffe+tot.ct+tot.am)}</span>
          </div>
          <div style={{marginTop:14,padding:10,background:"rgba(198,163,78,.05)",borderRadius:6,fontSize:10.5,color:'#9e9b93',lineHeight:1.6}}>
            <b style={{color:'#c6a34e'}}>Notes:</b><br/>
            • Cotis. patronale base: {sum.filter(s2=>s2.type==='marchand').length} trav. marchand (25%) + {sum.filter(s2=>s2.type==='non_marchand').length} trav. non-marchand (32,40%)<br/>
            • Fonds amiante: dû T1-T3 2026 uniquement<br/>
            • Ouvriers ({sum.filter(s2=>s2.isOuv).length}): base calculée sur brut × 108%<br/>
            • Réduction structurelle incluse (Cat {ae[0]?.statut==='ouvrier'?'1':'1'}) • Hors réductions groupes-cibles
          </div>
        </div></>}

        {view==='calendar'&&<><div style={{padding:'14px 18px',borderBottom:'1px solid rgba(139,115,60,.1)'}}><div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Calendrier ONSS {y}</div></div>
        <div style={{padding:18}}>
          {calONSS.map((c,i)=><div key={i} style={{marginBottom:16,padding:12,background:"rgba(198,163,78,.04)",borderRadius:8,border:i===(q-1)?'1px solid rgba(198,163,78,.3)':'1px solid rgba(255,255,255,.03)'}}>
            <div style={{fontSize:12,fontWeight:600,color:i===(q-1)?'#c6a34e':'#e8e6e0',marginBottom:6}}>{c.p} {i===(q-1)?'← actuel':''}</div>
            <div style={{fontSize:11,color:'#9e9b93',lineHeight:2}}>
              {c.prov.map((pr,j)=><div key={j}>Provision {j+1}: <b style={{color:'#d4d0c8'}}>{pr}</b></div>)}
              <div style={{borderTop:'1px solid rgba(255,255,255,.05)',paddingTop:4,marginTop:4}}>Solde + DmfA: <b style={{color:'#c6a34e'}}>{c.solde}</b></div>
            </div>
          </div>)}
          <div style={{padding:10,background:"rgba(96,165,250,.06)",borderRadius:6,fontSize:10.5,color:'#60a5fa',lineHeight:1.6}}>
            <b>Rappel légal:</b> Les provisions mensuelles sont calculées par l'ONSS et communiquées à l'employeur. L'employeur verse la différence entre le total des provisions et la somme totale des cotisations au plus tard le dernier jour du mois suivant le trimestre.
          </div>
        </div></>}
      </C>
    </div>
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  ADMIN DASHBOARD — PANNEAU D'ADMINISTRATION ULTRA COMPLET
// ═══════════════════════════════════════════════════════════════
function AdminDashboard({s,d}){
  const sub=s.sub||'admin_users';
  const [users,setUsers]=useState([]);
  const [clients,setClients]=useState([]);
  const [travailleurs,setTravailleurs]=useState([]);
  const [fiches,setFiches]=useState([]);
  const [audit,setAudit]=useState([]);
  const [loading,setLoading]=useState(true);
  const [search,setSearch]=useState('');
  const [selectedUser,setSelectedUser]=useState(null);
  const [dateRange,setDateRange]=useState('30');

  // Charger données depuis Supabase
  useEffect(()=>{
    loadData();
  },[sub]);

  async function loadData(){
    try{
      setLoading(true);
      const {supabase}=await import('./lib/supabase');
      if(!supabase){setLoading(false);return;}
      const [uRes,cRes,tRes,fRes]=await Promise.all([
        supabase.from('users').select('*').limit(200),
        supabase.from('clients').select('*').limit(500),
        supabase.from('travailleurs').select('*').limit(2000),
        supabase.from('fiches_paie').select('*').limit(5000),
      ]);
      if(uRes.data)setUsers(uRes.data);
      if(cRes.data)setClients(cRes.data);
      if(tRes.data)setTravailleurs(tRes.data);
      if(fRes.data)setFiches(fRes.data);
    }catch(e){console.error('AdminDashboard loadData:',e);}
    finally{setLoading(false);}
  }

  // Stats globales
  const totalUsers=users.length;
  const activeUsers=users.filter(u=>u.active).length;
  const totalClients=clients.length;
  const activeClients=clients.filter(c=>c.active).length;
  const totalTrav=travailleurs.length;
  const activeTrav=travailleurs.filter(t=>t.actif).length;
  const totalFiches=fiches.length;
  const fichesMois=fiches.filter(f=>{const now=new Date();return f.annee===now.getFullYear()&&f.mois===now.getMonth()+1;}).length;
  
  // Revenue calc
  const revenuMensuelEstime=totalTrav*12; // 12€/fiche
  const revenuAnnuelEstime=revenuMensuelEstime*12;
  
  // Travailleurs par client
  const travParClient={};
  travailleurs.forEach(t=>{travParClient[t.client_id]=(travParClient[t.client_id]||0)+1;});
  const moyTravParClient=totalClients>0?(totalTrav/totalClients).toFixed(1):0;

  // Cards style
  const Stat=({label,value,sub,color,icon})=><div style={{padding:16,background:"rgba(255,255,255,.02)",borderRadius:12,border:"1px solid rgba(255,255,255,.04)",flex:1,minWidth:140}}>
    <div style={{fontSize:11,color:'#9e9b93',marginBottom:4}}>{icon} {label}</div>
    <div style={{fontSize:26,fontWeight:700,color:color||'#e8e6e0'}}>{value}</div>
    {sub&&<div style={{fontSize:10,color:'#5e5c56',marginTop:2}}>{sub}</div>}
  </div>;

  const Badge=({text,color})=><span style={{padding:'2px 8px',borderRadius:10,fontSize:10,fontWeight:600,background:`${color}15`,color,border:`1px solid ${color}30`}}>{text}</span>;

  // Format date
  const fDate=(d)=>{if(!d)return'-';const dt=new Date(d);return dt.toLocaleDateString('fr-BE',{day:'2-digit',month:'2-digit',year:'numeric'});};
  const fDateTime=(d)=>{if(!d)return'-';const dt=new Date(d);return dt.toLocaleDateString('fr-BE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});};
  const timeAgo=(d)=>{if(!d)return'Jamais';const now=new Date();const dt=new Date(d);const diff=Math.floor((now-dt)/1000);if(diff<60)return'Il y a '+diff+'s';if(diff<3600)return'Il y a '+Math.floor(diff/60)+'min';if(diff<86400)return'Il y a '+Math.floor(diff/3600)+'h';return'Il y a '+Math.floor(diff/86400)+'j';};

  return <div>
    <div style={{padding:'18px 24px',borderBottom:'1px solid rgba(139,115,60,.15)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
      <div>
        <div style={{fontSize:18,fontWeight:700,color:'#e8e6e0'}}>👑 Administration Aureus Social Pro</div>
        <div style={{fontSize:11.5,color:'#9e9b93',marginTop:2}}>Panneau de controle — Vue globale plateforme</div>
      </div>
      <div style={{display:'flex',gap:8,alignItems:'center'}}>
        <button onClick={loadData} style={{padding:'6px 14px',borderRadius:8,border:'1px solid rgba(198,163,78,.3)',background:'rgba(198,163,78,.08)',color:'#c6a34e',fontSize:11,cursor:'pointer',fontWeight:600}}>🔄 Rafraichir</button>
        <div style={{fontSize:10,color:loading?'#fb923c':'#4ade80'}}>● {loading?'Chargement...':'Connecte'}</div>
      </div>
    </div>
    
    <div style={{padding:24,maxHeight:'calc(100vh - 200px)',overflowY:'auto'}}>
    
    {/* ═══ ONGLET: USERS ═══ */}
    {sub==='admin_users'&&<div>
      {/* KPIs */}
      <div style={{display:'flex',gap:12,marginBottom:20,flexWrap:'wrap'}}>
        <Stat icon="👤" label="Utilisateurs total" value={totalUsers} sub={`${activeUsers} actifs`} color="#c6a34e"/>
        <Stat icon="🏢" label="Dossiers clients" value={totalClients} sub={`${activeClients} actifs`} color="#60a5fa"/>
        <Stat icon="👥" label="Travailleurs" value={totalTrav} sub={`${activeTrav} actifs`} color="#4ade80"/>
        <Stat icon="📄" label="Fiches de paie" value={totalFiches} sub={`${fichesMois} ce mois`} color="#a78bfa"/>
        <Stat icon="💰" label="Revenu mensuel est." value={`€${revenuMensuelEstime.toLocaleString()}`} sub={`€${revenuAnnuelEstime.toLocaleString()}/an`} color="#c6a34e"/>
      </div>

      {/* Search */}
      <div style={{marginBottom:16}}>
        <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="🔍 Rechercher un utilisateur (nom, email...)" style={{width:'100%',padding:'10px 14px',background:'rgba(255,255,255,.04)',border:'1px solid rgba(198,163,78,.15)',borderRadius:8,color:'#e8e6e0',fontSize:12,outline:'none',boxSizing:'border-box'}}/>
      </div>

      {/* Users table */}
      <div style={{background:"rgba(255,255,255,.02)",borderRadius:12,border:"1px solid rgba(255,255,255,.04)",overflow:'hidden'}}>
        <div style={{display:'grid',gridTemplateColumns:'2fr 2fr 1fr 1fr 1.5fr 1.5fr 1fr',padding:'10px 14px',background:"rgba(198,163,78,.06)",borderBottom:'1px solid rgba(198,163,78,.1)',fontSize:10,fontWeight:600,color:'#c6a34e',textTransform:'uppercase',letterSpacing:.5}}>
          <div>Nom</div><div>Email</div><div>Role</div><div>Langue</div><div>Derniere connexion</div><div>Inscription</div><div>Statut</div>
        </div>
        {users.length===0?<div style={{padding:30,textAlign:'center',color:'#5e5c56',fontSize:12}}>
          {loading?'Chargement...':'Aucun utilisateur inscrit. Les utilisateurs apparaitront ici apres inscription.'}
        </div>:
        users.filter(u=>{
          if(!search)return true;
          const s=search.toLowerCase();
          return (u.nom||'').toLowerCase().includes(s)||(u.email||'').toLowerCase().includes(s)||(u.prenom||'').toLowerCase().includes(s);
        }).map((u,i)=>{
          const nbClients=clients.filter(c=>c.user_id===u.id).length;
          const nbTrav=travailleurs.filter(t=>clients.some(c=>c.id===t.client_id&&c.user_id===u.id)).length;
          return <div key={u.id} onClick={()=>setSelectedUser(selectedUser===u.id?null:u.id)} style={{display:'grid',gridTemplateColumns:'2fr 2fr 1fr 1fr 1.5fr 1.5fr 1fr',padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',cursor:'pointer',background:selectedUser===u.id?"rgba(198,163,78,.06)":i%2===0?"transparent":"rgba(255,255,255,.01)",fontSize:11.5,alignItems:'center',transition:'background .15s'}}>
            <div>
              <div style={{fontWeight:600,color:'#e8e6e0'}}>{u.prenom||''} {u.nom||''}</div>
              <div style={{fontSize:10,color:'#5e5c56'}}>{nbClients} dossier{nbClients!==1?'s':''} · {nbTrav} travailleur{nbTrav!==1?'s':''}</div>
            </div>
            <div style={{color:'#9e9b93'}}>{u.email}</div>
            <div><Badge text={u.role||'admin'} color={u.role==='admin'?'#c6a34e':u.role==='gestionnaire'?'#60a5fa':'#9e9b93'}/></div>
            <div style={{color:'#9e9b93',fontSize:11}}>{(u.lang||'fr').toUpperCase()}</div>
            <div style={{color:'#9e9b93',fontSize:10.5}}>{timeAgo(u.last_login)}</div>
            <div style={{color:'#9e9b93',fontSize:10.5}}>{fDate(u.created_at)}</div>
            <div><Badge text={u.active?'Actif':'Inactif'} color={u.active?'#4ade80':'#f87171'}/></div>
          </div>;
        })}
        
        {/* Detail panel */}
        {selectedUser&&<div style={{padding:16,background:"rgba(198,163,78,.04)",borderTop:'1px solid rgba(198,163,78,.15)'}}>
          {(()=>{
            const u=users.find(u=>u.id===selectedUser);
            if(!u)return null;
            const uClients=clients.filter(c=>c.user_id===u.id);
            const uTrav=travailleurs.filter(t=>uClients.some(c=>c.id===t.client_id));
            const uFiches=fiches.filter(f=>uClients.some(c=>c.id===f.client_id));
            const revenu=uTrav.length*12;
            return <div>
              <div style={{fontSize:13,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Detail: {u.prenom} {u.nom} ({u.email})</div>
              <div style={{display:'flex',gap:12,marginBottom:12,flexWrap:'wrap'}}>
                <Stat icon="🏢" label="Dossiers" value={uClients.length} color="#60a5fa"/>
                <Stat icon="👥" label="Travailleurs" value={uTrav.length} color="#4ade80"/>
                <Stat icon="📄" label="Fiches" value={uFiches.length} color="#a78bfa"/>
                <Stat icon="💰" label="Revenu/mois" value={`€${revenu}`} sub={`€${revenu*12}/an`} color="#c6a34e"/>
              </div>
              {uClients.length>0&&<div>
                <div style={{fontSize:11,fontWeight:600,color:'#e8e6e0',marginBottom:6}}>Ses dossiers clients :</div>
                {uClients.map(c=><div key={c.id} style={{display:'flex',alignItems:'center',gap:10,padding:'6px 10px',background:"rgba(255,255,255,.02)",borderRadius:6,marginBottom:4}}>
                  <div style={{fontSize:11,fontWeight:600,color:'#e8e6e0',flex:1}}>{c.nom}</div>
                  <div style={{fontSize:10,color:'#9e9b93'}}>TVA: {c.tva||'-'}</div>
                  <div style={{fontSize:10,color:'#9e9b93'}}>ONSS: {c.onss||'-'}</div>
                  <div style={{fontSize:10,color:'#9e9b93'}}>CP: {c.cp_number||'-'}</div>
                  <div style={{fontSize:10,color:'#9e9b93'}}>{travParClient[c.id]||0} trav.</div>
                  <Badge text={c.active?'Actif':'Inactif'} color={c.active?'#4ade80':'#f87171'}/>
                </div>)}
              </div>}
            </div>;
          })()}
        </div>}
      </div>
    </div>}

    {/* ═══ ONGLET: CLIENTS ═══ */}
    {sub==='admin_clients'&&<div>
      <div style={{display:'flex',gap:12,marginBottom:20,flexWrap:'wrap'}}>
        <Stat icon="🏢" label="Total dossiers" value={totalClients} color="#60a5fa"/>
        <Stat icon="✅" label="Actifs" value={activeClients} color="#4ade80"/>
        <Stat icon="⏸" label="Inactifs" value={totalClients-activeClients} color="#fb923c"/>
        <Stat icon="👥" label="Moy. travailleurs/client" value={moyTravParClient} color="#a78bfa"/>
      </div>

      <div style={{marginBottom:16}}>
        <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="🔍 Rechercher un dossier (nom, TVA, ONSS...)" style={{width:'100%',padding:'10px 14px',background:'rgba(255,255,255,.04)',border:'1px solid rgba(198,163,78,.15)',borderRadius:8,color:'#e8e6e0',fontSize:12,outline:'none',boxSizing:'border-box'}}/>
      </div>

      <div style={{background:"rgba(255,255,255,.02)",borderRadius:12,border:"1px solid rgba(255,255,255,.04)",overflow:'hidden'}}>
        <div style={{display:'grid',gridTemplateColumns:'2.5fr 1.5fr 1fr 1fr 1fr 1fr 1fr',padding:'10px 14px',background:"rgba(198,163,78,.06)",borderBottom:'1px solid rgba(198,163,78,.1)',fontSize:10,fontWeight:600,color:'#c6a34e',textTransform:'uppercase',letterSpacing:.5}}>
          <div>Société</div><div>TVA / ONSS</div><div>CP</div><div>Secteur</div><div>Travailleurs</div><div>Inscription</div><div>Statut</div>
        </div>
        {clients.length===0?<div style={{padding:30,textAlign:'center',color:'#5e5c56',fontSize:12}}>Aucun dossier client.</div>:
        clients.filter(c=>{
          if(!search)return true;
          const s=search.toLowerCase();
          return (c.nom||'').toLowerCase().includes(s)||(c.tva||'').toLowerCase().includes(s)||(c.onss||'').toLowerCase().includes(s);
        }).map((c,i)=>{
          const nb=travParClient[c.id]||0;
          const owner=users.find(u=>u.id===c.user_id);
          return <div key={c.id} style={{display:'grid',gridTemplateColumns:'2.5fr 1.5fr 1fr 1fr 1fr 1fr 1fr',padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11.5,alignItems:'center',background:i%2===0?"transparent":"rgba(255,255,255,.01)"}}>
            <div>
              <div style={{fontWeight:600,color:'#e8e6e0'}}>{c.nom}</div>
              <div style={{fontSize:10,color:'#5e5c56'}}>{c.forme_juridique||'SRL'} · {c.ville||'-'} {owner?`· ${owner.prenom||''} ${owner.nom||''}`:''}</div>
            </div>
            <div><div style={{fontSize:10.5,color:'#9e9b93'}}>{c.tva||'-'}</div><div style={{fontSize:10,color:'#5e5c56'}}>{c.onss||'-'}</div></div>
            <div style={{color:'#c6a34e',fontWeight:600,fontSize:11}}>{c.cp_number||'-'}</div>
            <div style={{fontSize:10.5,color:'#9e9b93'}}>{c.secteur||'-'}</div>
            <div style={{fontWeight:600,color:nb>0?'#4ade80':'#5e5c56'}}>{nb}</div>
            <div style={{fontSize:10.5,color:'#9e9b93'}}>{fDate(c.created_at)}</div>
            <div><Badge text={c.active?'Actif':'Inactif'} color={c.active?'#4ade80':'#f87171'}/></div>
          </div>;
        })}
      </div>
    </div>}

    {/* ═══ ONGLET: STATS ═══ */}
    {sub==='admin_stats'&&<div>
      <div style={{display:'flex',gap:12,marginBottom:20,flexWrap:'wrap'}}>
        <Stat icon="👤" label="Utilisateurs" value={totalUsers} sub={`${activeUsers} actifs`} color="#c6a34e"/>
        <Stat icon="🏢" label="Dossiers" value={totalClients} sub={`${activeClients} actifs`} color="#60a5fa"/>
        <Stat icon="👥" label="Travailleurs" value={totalTrav} sub={`${activeTrav} actifs`} color="#4ade80"/>
        <Stat icon="📄" label="Fiches totales" value={totalFiches} color="#a78bfa"/>
        <Stat icon="💰" label="Revenu mensuel" value={`€${revenuMensuelEstime.toLocaleString()}`} color="#c6a34e"/>
        <Stat icon="📈" label="Revenu annuel" value={`€${revenuAnnuelEstime.toLocaleString()}`} color="#4ade80"/>
      </div>

      {/* Répartition par forme juridique */}
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:16}}>
        <div style={{padding:16,background:"rgba(255,255,255,.02)",borderRadius:12,border:"1px solid rgba(255,255,255,.04)"}}>
          <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Repartition par forme juridique</div>
          {(()=>{
            const formes={};
            clients.forEach(c=>{const f=c.forme_juridique||'SRL';formes[f]=(formes[f]||0)+1;});
            return Object.entries(formes).sort((a,b)=>b[1]-a[1]).map(([f,n],i)=>{
              const pct=totalClients>0?((n/totalClients)*100).toFixed(1):0;
              return <div key={i} style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
                <div style={{flex:1,fontSize:11,color:'#e8e6e0'}}>{f}</div>
                <div style={{width:120,height:6,background:"rgba(255,255,255,.05)",borderRadius:3,overflow:'hidden'}}>
                  <div style={{width:`${pct}%`,height:'100%',background:'#c6a34e',borderRadius:3}}/>
                </div>
                <div style={{fontSize:10,color:'#9e9b93',width:50,textAlign:'right'}}>{n} ({pct}%)</div>
              </div>;
            });
          })()}
        </div>

        <div style={{padding:16,background:"rgba(255,255,255,.02)",borderRadius:12,border:"1px solid rgba(255,255,255,.04)"}}>
          <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Repartition par secteur</div>
          {(()=>{
            const secteurs={};
            clients.forEach(c=>{const s=c.secteur||'Non defini';secteurs[s]=(secteurs[s]||0)+1;});
            return Object.entries(secteurs).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([s,n],i)=>{
              const pct=totalClients>0?((n/totalClients)*100).toFixed(1):0;
              return <div key={i} style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
                <div style={{flex:1,fontSize:11,color:'#e8e6e0',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{s}</div>
                <div style={{width:120,height:6,background:"rgba(255,255,255,.05)",borderRadius:3,overflow:'hidden'}}>
                  <div style={{width:`${pct}%`,height:'100%',background:'#60a5fa',borderRadius:3}}/>
                </div>
                <div style={{fontSize:10,color:'#9e9b93',width:50,textAlign:'right'}}>{n} ({pct}%)</div>
              </div>;
            });
          })()}
        </div>
      </div>

      {/* Répartition par CP */}
      <div style={{padding:16,background:"rgba(255,255,255,.02)",borderRadius:12,border:"1px solid rgba(255,255,255,.04)"}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>Top Commissions Paritaires</div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(150px,1fr))',gap:8}}>
          {(()=>{
            const cps={};
            clients.forEach(c=>{const cp=c.cp_number||'?';cps[cp]=(cps[cp]||0)+1;});
            return Object.entries(cps).sort((a,b)=>b[1]-a[1]).slice(0,12).map(([cp,n],i)=><div key={i} style={{padding:'8px 12px',background:"rgba(198,163,78,.04)",borderRadius:8,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <div style={{fontSize:12,fontWeight:600,color:'#e8e6e0'}}>CP {cp}</div>
              <div style={{fontSize:11,color:'#c6a34e',fontWeight:600}}>{n}</div>
            </div>);
          })()}
        </div>
      </div>

      {/* Revenue projection */}
      <div style={{marginTop:16,padding:16,background:"rgba(198,163,78,.04)",borderRadius:12,border:"1px solid rgba(198,163,78,.15)"}}>
        <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginBottom:10}}>💰 Projection revenus (modele €12/fiche/mois)</div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12}}>
          {[
            {l:'Actuel',users:totalUsers,trav:totalTrav},
            {l:'+3 mois',users:Math.ceil(totalUsers*1.5)||5,trav:Math.ceil(totalTrav*1.5)||50},
            {l:'+6 mois',users:Math.ceil(totalUsers*3)||15,trav:Math.ceil(totalTrav*3)||150},
            {l:'+12 mois',users:Math.ceil(totalUsers*8)||50,trav:Math.ceil(totalTrav*8)||500},
          ].map((p,i)=><div key={i} style={{padding:12,background:"rgba(255,255,255,.03)",borderRadius:8,textAlign:'center'}}>
            <div style={{fontSize:10,color:'#9e9b93',marginBottom:4}}>{p.l}</div>
            <div style={{fontSize:10,color:'#5e5c56'}}>{p.users} users · {p.trav} trav.</div>
            <div style={{fontSize:18,fontWeight:700,color:'#4ade80',marginTop:4}}>€{(p.trav*12).toLocaleString()}</div>
            <div style={{fontSize:10,color:'#5e5c56'}}>/mois</div>
            <div style={{fontSize:12,fontWeight:600,color:'#c6a34e',marginTop:2}}>€{(p.trav*12*12).toLocaleString()}/an</div>
          </div>)}
        </div>
      </div>
    </div>}

    {/* ═══ ONGLET: AUDIT ═══ */}
    {sub==='admin_audit'&&<div>
      <div style={{display:'flex',gap:8,marginBottom:16}}>
        {['7','30','90','365'].map(d=><button key={d} onClick={()=>setDateRange(d)} style={{padding:'6px 14px',borderRadius:8,border:dateRange===d?'1px solid rgba(198,163,78,.4)':'1px solid rgba(255,255,255,.06)',background:dateRange===d?"rgba(198,163,78,.12)":"rgba(255,255,255,.02)",color:dateRange===d?'#c6a34e':'#9e9b93',fontSize:11,cursor:'pointer'}}>{d==='365'?'1 an':`${d} jours`}</button>)}
      </div>
      
      <div style={{background:"rgba(255,255,255,.02)",borderRadius:12,border:"1px solid rgba(255,255,255,.04)",overflow:'hidden'}}>
        <div style={{display:'grid',gridTemplateColumns:'1.5fr 1.5fr 2fr 2fr 2fr',padding:'10px 14px',background:"rgba(198,163,78,.06)",borderBottom:'1px solid rgba(198,163,78,.1)',fontSize:10,fontWeight:600,color:'#c6a34e',textTransform:'uppercase',letterSpacing:.5}}>
          <div>Date</div><div>Utilisateur</div><div>Action</div><div>Table</div><div>Details</div>
        </div>
        {audit.length===0?<div style={{padding:30,textAlign:'center',color:'#5e5c56',fontSize:12}}>
          Aucune entree dans le journal d'audit. Les actions seront enregistrees automatiquement.
        </div>:
        audit.filter(a=>{
          const d=new Date(a.created_at);
          const now=new Date();
          return (now-d)<(parseInt(dateRange)*86400000);
        }).map((a,i)=>{
          const usr=users.find(u=>u.id===a.user_id);
          return <div key={a.id} style={{display:'grid',gridTemplateColumns:'1.5fr 1.5fr 2fr 2fr 2fr',padding:'8px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11,alignItems:'center',background:i%2===0?"transparent":"rgba(255,255,255,.01)"}}>
            <div style={{color:'#9e9b93',fontSize:10}}>{fDateTime(a.created_at)}</div>
            <div style={{color:'#e8e6e0'}}>{usr?`${usr.prenom||''} ${usr.nom||''}`:a.user_id?.slice(0,8)||'-'}</div>
            <div><Badge text={a.action} color={a.action?.includes('create')?'#4ade80':a.action?.includes('delete')?'#f87171':'#60a5fa'}/></div>
            <div style={{color:'#9e9b93'}}>{a.table_name||'-'}</div>
            <div style={{fontSize:10,color:'#5e5c56',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{a.details?JSON.stringify(a.details).slice(0,60):'-'}</div>
          </div>;
        })}
      </div>
    </div>}

    {/* ═══ ONGLET: BILLING ═══ */}
    {sub==='admin_billing'&&<div>
      <div style={{display:'flex',gap:12,marginBottom:20,flexWrap:'wrap'}}>
        <Stat icon="💰" label="Revenu mensuel" value={`€${revenuMensuelEstime.toLocaleString()}`} color="#4ade80"/>
        <Stat icon="📈" label="Revenu annuel" value={`€${revenuAnnuelEstime.toLocaleString()}`} color="#c6a34e"/>
        <Stat icon="👥" label="Fiches facturables" value={totalTrav} sub="travailleurs actifs" color="#60a5fa"/>
        <Stat icon="🏢" label="Clients facturables" value={activeClients} color="#a78bfa"/>
      </div>

      {/* Facturation par client */}
      <div style={{background:"rgba(255,255,255,.02)",borderRadius:12,border:"1px solid rgba(255,255,255,.04)",overflow:'hidden'}}>
        <div style={{display:'grid',gridTemplateColumns:'2.5fr 1fr 1fr 1fr 1fr 1fr',padding:'10px 14px',background:"rgba(198,163,78,.06)",borderBottom:'1px solid rgba(198,163,78,.1)',fontSize:10,fontWeight:600,color:'#c6a34e',textTransform:'uppercase',letterSpacing:.5}}>
          <div>Client</div><div>Travailleurs</div><div>Tarif/fiche</div><div>Mensuel</div><div>Annuel</div><div>Entree</div>
        </div>
        {clients.filter(c=>c.active).map((c,i)=>{
          const nb=travParClient[c.id]||0;
          const tarif=nb<=5?15:nb<=20?12:nb<=50?9:nb<=100?7:5;
          const mensuel=nb*tarif;
          const annuel=mensuel*12;
          const entree=nb<=5?149:nb<=20?299:nb<=50?499:999;
          return <div key={c.id} style={{display:'grid',gridTemplateColumns:'2.5fr 1fr 1fr 1fr 1fr 1fr',padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11.5,alignItems:'center',background:i%2===0?"transparent":"rgba(255,255,255,.01)"}}>
            <div style={{fontWeight:600,color:'#e8e6e0'}}>{c.nom}</div>
            <div style={{color:'#9e9b93'}}>{nb}</div>
            <div style={{color:'#c6a34e',fontWeight:600}}>€{tarif}</div>
            <div style={{color:'#4ade80',fontWeight:600}}>€{mensuel}</div>
            <div style={{color:'#60a5fa'}}>€{annuel.toLocaleString()}</div>
            <div style={{color:'#a78bfa'}}>€{entree}</div>
          </div>;
        })}
        {/* Total row */}
        <div style={{display:'grid',gridTemplateColumns:'2.5fr 1fr 1fr 1fr 1fr 1fr',padding:'12px 14px',background:"rgba(198,163,78,.08)",fontSize:12,fontWeight:700,alignItems:'center',borderTop:'2px solid rgba(198,163,78,.2)'}}>
          <div style={{color:'#c6a34e'}}>TOTAL</div>
          <div style={{color:'#e8e6e0'}}>{totalTrav}</div>
          <div style={{color:'#9e9b93'}}>-</div>
          <div style={{color:'#4ade80'}}>€{revenuMensuelEstime.toLocaleString()}</div>
          <div style={{color:'#60a5fa'}}>€{revenuAnnuelEstime.toLocaleString()}</div>
          <div style={{color:'#a78bfa'}}>€{clients.filter(c=>c.active).reduce((sum,c)=>{const nb=travParClient[c.id]||0;return sum+(nb<=5?149:nb<=20?299:nb<=50?499:999);},0).toLocaleString()}</div>
        </div>
      </div>

      <div style={{marginTop:16,padding:12,background:"rgba(96,165,250,.06)",borderRadius:8,fontSize:11,color:'#60a5fa',lineHeight:1.6}}>
        ℹ️ La grille tarifaire appliquee: 1-5 trav. = €15/fiche · 6-20 = €12 · 21-50 = €9 · 51-100 = €7 · 100+ = €5. Frais d'entree: Starter €149 · Business €299 · Premium €499 · Enterprise €999.
      </div>
    </div>}

    </div>
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  GUIDE PORTAIL ONSS — PAS A PAS
// ═══════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════
//  BELCOTAX
// ═══════════════════════════════════════════════════════════════
function BelcotaxPage({s,d}) {
  const [yr,setYr]=useState(new Date().getFullYear()-1);
  const [ft,setFt]=useState('10');
  const [tab,setTab]=useState('gen');
  const [allXml,setAllXml]=useState('');
  const ae=(s.emps||[]).filter(e=>e.status==='active');

  // Validation
  const warnings=[];
  ae.forEach(e=>{
    if(!e.niss) warnings.push({emp:`${e.first||e.fn||'Emp'} ${e.last||''}`,msg:'NISS manquant — fiche invalide'});
    if(!e.addr&&!e.zip) warnings.push({emp:`${e.first||e.fn||'Emp'} ${e.last||''}`,msg:'Adresse incomplète'});
  });
  if(!s.co.onss) warnings.push({emp:'Employeur',msg:'Matricule ONSS manquant'});
  if(!s.co.vat) warnings.push({emp:'Employeur',msg:'Numéro TVA manquant'});

  const gen=()=>{
    const xmlParts=[];
    ae.forEach(emp=>{
      const p=calc(emp,DPER,s.co);
      const ad={gross:p.gross*12,onss:p.onssNet*12,empB:p.empBonus*12,tax:p.tax*12,css:p.css*12,mvC:Math.round(p.mvDays*12),mvE:p.mvEmployer*12,tr:p.transport*12,atnCar:(p.atnCar||0)*12,atnAutres:(p.atnAutresTot||0)*12,pensionCompl:(p.pensionCompl||0)*12,fraisPropres:((p.expense||0)+(p.indemTeletravail||0)+(p.indemBureau||0))*12,ecoCheques:(p.ecoCheques||0)*12};
      const xml=genBelcotax(s.co,emp,yr,ad);
      xmlParts.push(xml);
      d({type:"ADD_F",d:{eid:emp.id,ename:`${emp.first} ${emp.last}`,yr,ft,ftl:LEGAL.FICHE_281[ft],ag:ad.gross,an:p.net*12,aonss:ad.onss,atax:ad.tax,acss:ad.css,xml,at:new Date().toISOString()}});
    });
    // Récapitulatif XML global BelcotaxOnWeb
    const globalXml=`<?xml version="1.0" encoding="UTF-8"?>\n<!-- BelcotaxOnWeb — Fichier recapitulatif -->\n<!-- ${ae.length} fiche(s) 281.${ft} — Annee ${yr} -->\n<!-- Généré par: Aureus Social Pro -->\n<Belcotax xmlns="urn:belcotax:${yr}">\n  <Verzending>\n    <Aangiftenr>BELCO${Date.now().toString(36).toUpperCase()}</Aangiftenr>\n    <Aangiftetype>281.${ft}</Aangiftetype>\n    <AangifteJaar>${yr}</AangifteJaar>\n    <AantalOpgaven>${ae.length}</AantalOpgaven>\n    <Schuldenaar>\n      <KBO>${(s.co.bce||s.co.vat||'').replace(/[^0-9]/g,"")}</KBO>\n      <Naam>${s.co.name}</Naam>\n      <Adres>${s.co.addr}</Adres>\n    </Schuldenaar>\n  </Verzending>\n</Belcotax>`;
    setAllXml(globalXml);
  };

  // Stats from fiches
  const fichesYr=s.fiches.filter(f2=>f2.yr==yr);
  const totBrut=fichesYr.reduce((a,f2)=>a+(f2.ag||0),0);
  const totNet=fichesYr.reduce((a,f2)=>a+(f2.an||0),0);

  return <div>
    <PH title="Fiches Fiscales BELCOTAX" sub="BelcotaxOnWeb — SPF Finances"/>
    <div style={{marginBottom:14,padding:"10px 14px",background:"linear-gradient(135deg,rgba(239,68,68,.06),rgba(239,68,68,.02))",border:"1px solid rgba(239,68,68,.1)",borderRadius:10,display:"flex",alignItems:"center",justifyContent:"space-between"}}><div style={{fontSize:11,color:"#888"}}>⚡ Belcotax 281.10 auto-générées en janvier</div><button onClick={()=>{if(confirm("Générer Belcotax ?")){ (s.emps||[]).forEach(e=>generateBelcotaxXML(e,s.co));alert("✅ Belcotax générées")}}} style={{padding:"6px 14px",borderRadius:8,border:"none",background:"#ef4444",color:"#fff",fontSize:11,cursor:"pointer",fontWeight:600}}>⚡ Générer tout</button></div>
    {/* Stats */}
    <div style={{display:'flex',gap:12,marginBottom:18}}>
      {[{l:"Fiches générées",v:fichesYr.length,c:'#c6a34e'},{l:"Brut total",v:fmt(totBrut),c:'#e8e6e0'},{l:"Net total",v:fmt(totNet),c:'#4ade80'},{l:"Travailleurs actifs",v:ae.length,c:'#60a5fa'}].map((st,i)=>
        <div key={i} style={{flex:1,padding:'12px 16px',background:"rgba(198,163,78,.04)",borderRadius:10,border:'1px solid rgba(198,163,78,.08)'}}>
          <div style={{fontSize:10,color:'#5e5c56',textTransform:'uppercase',letterSpacing:'.5px'}}>{st.l}</div>
          <div style={{fontSize:typeof st.v==='number'?22:16,fontWeight:700,color:st.c,marginTop:2}}>{st.v}</div>
        </div>
      )}
    </div>
    {/* Tabs */}
    <div style={{display:'flex',gap:6,marginBottom:16}}>
      {[{v:"gen",l:"Génération"},{v:"fiches",l:"Fiches générées"},{v:"deadlines",l:"Échéances & Règles"}].map(t=>
        <button key={t.v} onClick={()=>setTab(t.v)} style={{padding:'8px 16px',borderRadius:8,border:'none',cursor:'pointer',fontSize:12,fontWeight:tab===t.v?600:400,fontFamily:'inherit',
          background:tab===t.v?'rgba(198,163,78,.15)':'rgba(255,255,255,.03)',color:tab===t.v?'#c6a34e':'#9e9b93'}}>{t.l}</button>
      )}
    </div>

    {tab==='gen'&&<div style={{display:'grid',gridTemplateColumns:'320px 1fr',gap:18}}>
      <div>
        <C><ST>Paramètres</ST>
          <I label="Année de revenus" type="number" value={yr} onChange={v=>setYr(v)}/>
          <I label="Type de fiche" value={ft} onChange={v=>setFt(v)} style={{marginTop:9}} options={Object.entries(LEGAL.FICHE_281).map(([k,v2])=>({v:k,l:`281.${k} — ${v2}`}))}/>
          <B onClick={gen} style={{width:'100%',marginTop:14}}>Générer toutes les 281.{ft} ({ae.length} fiches)</B>
          {allXml&&<div style={{marginTop:12}}>
            <B v="outline" style={{width:'100%',fontSize:11}} onClick={()=>d({type:"MODAL",m:{w:800,c:<div><h3 style={{color:'#e8e6e0',margin:'0 0 10px'}}>Récapitulatif BelcotaxOnWeb</h3><pre style={{background:"#060810",border:'1px solid rgba(139,115,60,.15)',borderRadius:8,padding:14,fontSize:10,color:'#9e9b93',whiteSpace:'pre-wrap',maxHeight:400,overflowY:'auto'}}>{allXml}</pre><div style={{display:'flex',gap:10,marginTop:12,justifyContent:'flex-end'}}><B v="outline" onClick={()=>d({type:"MODAL",m:null})}>Fermer</B><B onClick={()=>{navigator.clipboard?.writeText(allXml);alert('Copié !')}}>Copier</B></div></div>}})}>Voir XML récapitulatif</B>
          </div>}
        </C>
        {warnings.length>0&&<C style={{marginTop:12,borderColor:'rgba(239,68,68,.15)'}}><ST>Anomalies ({warnings.length})</ST>
          {warnings.map((w,i)=><div key={i} style={{fontSize:10.5,color:'#9e9b93',padding:'4px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
            <b style={{color:'#f87171'}}>{w.emp}</b>: {w.msg}
          </div>)}
        </C>}
        <C style={{marginTop:12}}><ST>Types disponibles</ST>
          {Object.entries(LEGAL.FICHE_281).map(([k,v2])=><div key={k} style={{fontSize:10.5,color:'#9e9b93',padding:'3px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}><b style={{color:'#d4d0c8'}}>281.{k}</b> — {v2}</div>)}
        </C>
      </div>
      <C style={{padding:0,overflow:'hidden'}}>
        <div style={{padding:'14px 18px',borderBottom:'1px solid rgba(139,115,60,.1)'}}><div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Aperçu — 281.{ft} année {yr}</div></div>
        <Tbl cols={[
          {k:'n',l:"Travailleur",b:1,r:r=>`${r.first} ${r.last}`},
          {k:'niss',l:"NISS",r:r=><span style={{fontFamily:'monospace',fontSize:10,color:r.niss?'#9e9b93':'#f87171'}}>{r.niss||'MANQUANT'}</span>},
          {k:'g',l:"Brut annuel",a:'right',r:r=>{const p=calc(r,DPER,s.co);return fmt(p.gross*12)}},
          {k:'t',l:"PP annuel",a:'right',r:r=>{const p=calc(r,DPER,s.co);return <span style={{color:'#f87171'}}>{fmt(p.tax*12)}</span>}},
          {k:'ne',l:"Net annuel",a:'right',r:r=>{const p=calc(r,DPER,s.co);return <span style={{color:'#4ade80'}}>{fmt(p.net*12)}</span>}},
        ]} data={ae}/>
      </C>
    </div>}

    {tab==='fiches'&&<C style={{padding:0,overflow:'hidden'}}>
      <div style={{padding:'14px 18px',borderBottom:'1px solid rgba(139,115,60,.1)'}}><div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Fiches générées ({s.fiches.length})</div></div>
      <Tbl cols={[
        {k:'y',l:"Année",r:r=><span style={{fontWeight:600,color:'#c6a34e'}}>{r.yr}</span>},
        {k:'t',l:"Type",r:r=>`281.${r.ft}`},{k:'e',l:"Employé",r:r=>r.ename},
        {k:'g',l:"Brut annuel",a:'right',r:r=>fmt(r.ag)},
        {k:'n',l:"Net annuel",a:'right',r:r=><span style={{color:'#4ade80'}}>{fmt(r.an)}</span>},
        {k:'x',l:"",a:'right',r:r=><B v="ghost" style={{padding:'3px 8px',fontSize:10}} onClick={()=>d({type:"MODAL",m:{w:800,c:<div><h3 style={{color:'#e8e6e0',margin:'0 0 10px'}}>281.{r.ft} — {r.ename} ({r.yr})</h3><pre style={{background:"#060810",border:'1px solid rgba(139,115,60,.15)',borderRadius:8,padding:14,fontSize:10,color:'#9e9b93',overflowX:'auto',whiteSpace:'pre-wrap',maxHeight:380,overflowY:'auto'}}>{r.xml}</pre><div style={{display:'flex',gap:10,marginTop:12,justifyContent:'flex-end'}}><B v="outline" onClick={()=>d({type:"MODAL",m:null})}>Fermer</B><B onClick={()=>{navigator.clipboard?.writeText(r.xml);alert('Copié !')}}>Copier</B></div></div>}})}>XML</B>},
      ]} data={s.fiches}/>
    </C>}

    {tab==='deadlines'&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:18}}>
      <C><ST>Échéances BelcotaxOnWeb</ST>
        <div style={{fontSize:11,color:'#9e9b93',lineHeight:1.8}}>
          {[{l:"281.10 Rémunérations",dl:"28/02 (N+1)",note:"Obligatoire pour tous les employeurs"},{l:"281.20 Dirigeants",dl:"28/02 (N+1)",note:"Administrateurs, gérants"},{l:"281.50 Honoraires/Commissions",dl:"30/06 (N+1)",note:"plus de 250 EUR/an/bénéficiaire"},{l:"281.30 Jetons présence",dl:"28/02 (N+1)",note:"Membres CA, ASBL"},{l:"Rectificative",dl:"Pas de deadline fixe",note:"Via BelcotaxOnWeb portail SPF"}].map((r,i)=>
            <div key={i} style={{padding:'8px 0',borderBottom:'1px solid rgba(255,255,255,.03)'}}>
              <div style={{display:'flex',justifyContent:'space-between'}}><b style={{color:'#e8e6e0'}}>{r.l}</b><span style={{color:'#c6a34e',fontWeight:600}}>{r.dl}</span></div>
              <div style={{fontSize:10,color:'#5e5c56'}}>{r.note}</div>
            </div>
          )}
        </div>
      </C>
      <C><ST>Procédure</ST>
        <div style={{fontSize:11,color:'#9e9b93',lineHeight:1.8}}>
          {['1. Générer les fiches 281.xx dans Aureus Social Pro',"2. Vérifier les données (NISS, montants, adresses)","3. Exporter le XML récapitulatif","4. Se connecter à BelcotaxOnWeb (MyMinfin)","5. Uploader le fichier XML","6. Valider et envoyer","7. Conserver l'accusé de réception"].map((step,i)=>
            <div key={i} style={{padding:'4px 0'}}>{step}</div>
          )}
        </div>
        <div style={{marginTop:14,padding:10,background:"rgba(96,165,250,.06)",borderRadius:8,fontSize:10.5,color:'#60a5fa',lineHeight:1.5}}>
          <b>Portail:</b> finances.belgium.be/fr/E-services/Belcotaxonweb<br/>
          <b>Helpdesk SPF:</b> 0257/257 57<br/>
          <b>Format XML:</b> Conforme XSD BelcotaxOnWeb v{yr}
        </div>
      </C>
    </div>}
  </div>;
}


// ═══════════════════════════════════════════════════════════════
//  PRÉCOMPTE 274
// ═══════════════════════════════════════════════════════════════
function PrecomptePage({s,d}) {
  const [mode,setMode]=useState('mensuel');
  const [m,setM]=useState(new Date().getMonth()+1);
  const [q,setQ]=useState(Math.ceil((new Date().getMonth()+1)/3));
  const [y,setY]=useState(new Date().getFullYear());
  const ae=(s.emps||[]).filter(e=>e.status==='active');

  // Calcul mensuel
  const detMens=ae.map(e=>{const p=calc(e,{...DPER,month:m,year:y},s.co);return{e,tax:p.tax,gross:p.gross};});
  const totMens=detMens.reduce((a,r)=>a+r.tax,0);

  // Calcul trimestriel (3 mois cumulés)
  const qMonths=[(q-1)*3+1,(q-1)*3+2,(q-1)*3+3];
  const detTrim=ae.map(e=>{
    let taxQ=0,grossQ=0;
    qMonths.forEach(mo=>{const p=calc(e,{...DPER,month:mo,year:y},s.co);taxQ+=p.tax;grossQ+=p.gross;});
    return{e,tax:taxQ,gross:grossQ};
  });
  const totTrim=detTrim.reduce((a,r)=>a+r.tax,0);

  // Seuil: PP année N-1 > 50 240€ → obligatoirement mensuel
  const ppAnnuel=totMens*12;
  const seuilMensuel=50240;
  const obligMensuel=ppAnnuel>seuilMensuel;

  const det=mode==='mensuel'?detMens:detTrim;
  const tot=mode==='mensuel'?totMens:totTrim;

  // Calendrier SPF 2026
  const calMens=[{p:'Janvier 2026',dl:"13/02/2026"},{p:'Février 2026',dl:"13/03/2026"},{p:'Mars 2026',dl:"15/04/2026"},{p:'Avril 2026',dl:"15/05/2026"},{p:'Mai 2026',dl:"15/06/2026"},{p:'Juin 2026',dl:"15/07/2026"},{p:'Juillet 2026',dl:"14/08/2026"},{p:'Août 2026',dl:"15/09/2026"},{p:'Septembre 2026',dl:"15/10/2026"},{p:'Octobre 2026',dl:"13/11/2026"},{p:'Novembre 2026',dl:"15/12/2026"},{p:'Décembre 2026',dl:"15/01/2027"}];
  const calTrim=[{p:'T1 2026',dl:"15/04/2026"},{p:'T2 2026',dl:"15/07/2026"},{p:'T3 2026',dl:"15/10/2026"},{p:'T4 2026',dl:"15/01/2027"}];

  return <div>
    <PH title="Précompte Professionnel 274" sub="Déclaration et versement — FINPROF"/>
    <div style={{display:'grid',gridTemplateColumns:'300px 1fr',gap:18}}>
      <div>
      <C><ST>Configuration</ST>
        <I label="Périodicité" value={mode} onChange={setMode} options={[{v:"mensuel",l:"Mensuel"},{v:"trimestriel",l:"Trimestriel"}]}/>
        {mode==='mensuel'?<I label="Mois" value={m} onChange={v=>setM(parseInt(v))} options={MN.map((x,i)=>({v:i+1,l:x}))} style={{marginTop:9}}/>
        :<I label="Trimestre" value={q} onChange={v=>setQ(parseInt(v))} options={[{v:1,l:"T1 (jan-mar)"},{v:2,l:"T2 (avr-jun)"},{v:3,l:"T3 (jul-sep)"},{v:4,l:"T4 (oct-déc)"}]} style={{marginTop:9}}/>}
        <I label="Année" type="number" value={y} onChange={v=>setY(v)} style={{marginTop:9}}/>
        <div style={{marginTop:18,padding:14,background:"rgba(198,163,78,.06)",borderRadius:8,border:'1px solid rgba(198,163,78,.1)',textAlign:'center'}}>
          <div style={{fontSize:10.5,color:'#9e9b93',textTransform:'uppercase',letterSpacing:'1px'}}>Total à verser</div>
          <div style={{fontSize:26,fontWeight:700,color:'#c6a34e',marginTop:6}}>{fmt(tot)}</div>
          <div style={{fontSize:10.5,color:'#5e5c56',marginTop:3}}>{mode==='mensuel'?`${MN[m-1]} ${y}`:`T${q} ${y}`} · {ae.length} trav.</div>
        </div>
        {obligMensuel&&mode==='trimestriel'&&<div style={{marginTop:10,padding:8,background:"rgba(239,68,68,.08)",borderRadius:6,border:'1px solid rgba(239,68,68,.15)',fontSize:10.5,color:'#ef4444'}}>
          <b>⚠</b> PP annuel estimé ({fmt(ppAnnuel)}) dépasse le seuil de {fmt(seuilMensuel)}. Déclaration <b>mensuelle obligatoire</b>.
        </div>}
        <div style={{marginTop:14,padding:10,background:"rgba(96,165,250,.06)",borderRadius:8,border:'1px solid rgba(96,165,250,.1)'}}>
          <div style={{fontSize:10.5,color:'#60a5fa',lineHeight:1.5}}>
            <b>Seuil:</b> PP N-1 {'>'} 50 240€ → mensuel<br/>
            <b>Échéance:</b> 15 du mois suivant (mensuel) ou 15 du mois suivant le trimestre<br/>
            <b>Déclaration:</b> Via FINPROF (application SPF Finances)
          </div>
        </div>
      </C>
      <C style={{marginTop:12}}><ST>Calendrier SPF {y}</ST>
        <div style={{maxHeight:200,overflow:'auto'}}>
        {(mode==='mensuel'?calMens:calTrim).map((c,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'5px 0',borderBottom:'1px solid rgba(255,255,255,.03)',fontSize:11}}>
          <span style={{color:'#9e9b93'}}>{c.p}</span><span style={{fontWeight:600,color:i===((mode==='mensuel'?m:q)-1)?'#c6a34e':'#d4d0c8'}}>{c.dl}</span>
        </div>)}
        </div>
      </C>
      </div>
      <C style={{padding:0,overflow:'hidden'}}>
        <div style={{padding:'14px 18px',borderBottom:'1px solid rgba(139,115,60,.1)'}}><div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Détail — {mode==='mensuel'?`${MN[m-1]} ${y}`:`T${q} ${y} (${qMonths.map(mo=>MN[mo-1]).join(' + ')})`}</div></div>
        <Tbl cols={[
          {k:'n',l:"Travailleur",r:r=><span style={{fontWeight:500}}>{r.e.first} {r.e.last}</span>},
          {k:'g',l:mode==='mensuel'?'Brut':'Brut cumulé',a:'right',r:r=>fmt(r.gross)},
          {k:'t',l:mode==='mensuel'?'Précompte':'PP cumulé',a:'right',r:r=><span style={{fontWeight:600,color:'#c6a34e'}}>{fmt(r.tax)}</span>},
        ]} data={det}/>
        {det.length>0&&<div style={{padding:'12px 18px',borderTop:'1px solid rgba(139,115,60,.1)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <div style={{display:'flex',gap:8}}>
            <B v="outline" style={{fontSize:10.5,padding:'6px 12px'}} onClick={()=>{
              const periode=mode==='mensuel'?`${String(m).padStart(2,"0")}/${y}`:`T${q}/${y}`;
              const xml274=`<?xml version="1.0" encoding="UTF-8"?>\n<!-- Declaration Precompte Professionnel 274 -->\n<!-- SPF Finances — FINPROF -->\n<!-- Généré par: Aureus Social Pro -->\n<PP274 xmlns="urn:pp274:${y}">\n  <Declaration>\n    <Periode>${periode}</Periode>\n    <Periodicite>${mode}</Periodicite>\n    <Employeur>\n      <KBO>${(s.co.bce||s.co.vat||'').replace(/[^0-9]/g,"")}</KBO>\n      <ONSS>${(s.co.onss||'').replace(/[^0-9]/g,"")}</ONSS>\n      <Naam>${s.co.name}</Naam>\n    </Employeur>\n    <NbrTravailleurs>${ae.length}</NbrTravailleurs>\n    <TotalBrut>${det.reduce((a,r)=>a+r.gross,0).toFixed(2)}</TotalBrut>\n    <TotalPrecompte>${tot.toFixed(2)}</TotalPrecompte>\n${det.map(r=>`    <Travailleur>\n      <Naam>${r.e.last||''} ${r.e.first||''}</Naam>\n      <INSZ>${(r.e.niss||'').replace(/[\\.-\\s]/g,"")}</INSZ>\n      <Brut>${r.gross.toFixed(2)}</Brut>\n      <PP>${r.tax.toFixed(2)}</PP>\n    </Travailleur>`).join('\n')}\n  </Declaration>\n</PP274>`;
              d({type:"MODAL",m:{w:850,c:<div>
                <h2 style={{fontSize:17,fontWeight:600,color:'#e8e6e0',margin:'0 0 6px',fontFamily:"'Cormorant Garamond',serif"}}>Déclaration PP 274 — {periode}</h2>
                <div style={{display:'flex',gap:8,marginBottom:12}}>
                  <span style={{fontSize:10,padding:'3px 10px',borderRadius:4,background:"rgba(74,222,128,.1)",color:'#4ade80',fontWeight:600}}>✓ XML généré</span>
                  <span style={{fontSize:10,padding:'3px 10px',borderRadius:4,background:"rgba(198,163,78,.1)",color:'#c6a34e',fontWeight:600}}>{ae.length} trav. · {fmt(tot)}</span>
                </div>
                <pre style={{background:"#060810",border:'1px solid rgba(139,115,60,.15)',borderRadius:8,padding:14,fontSize:10,color:'#9e9b93',overflowX:'auto',whiteSpace:'pre-wrap',maxHeight:350,overflowY:'auto'}}>{xml274}</pre>
                <div style={{display:'flex',gap:10,marginTop:14,justifyContent:'flex-end'}}>
                  <B v="outline" onClick={()=>d({type:"MODAL",m:null})}>Fermer</B>
                  <B onClick={()=>{navigator.clipboard?.writeText(xml274);alert('XML 274 copié !')}}>Copier XML</B>
                </div>
              </div>}});
            }}>Générer XML 274</B>
          </div>
          <div style={{display:'flex',gap:16,alignItems:'center'}}><span style={{fontSize:12,color:'#9e9b93'}}>TOTAL:</span><span style={{fontSize:14,fontWeight:700,color:'#c6a34e'}}>{fmt(tot)}</span></div>
        </div>}
      </C>
    </div>
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  DOCUMENTS SOCIAUX
// ═══════════════════════════════════════════════════════════════
function DocsPage({s,d}) {
  const [dt,setDt]=useState('C4');
  const [eid,setEid]=useState((s.emps||[])[0]?.id||'');
  const [endD,setEndD]=useState(new Date().toISOString().split('T')[0]);
  const [reason,setReason]=useState('Licenciement');
  const emp=(s.emps||[]).find(e=>e.id===eid);

  const gen=()=>{if(!emp)return;
    const fields=dt==='C4'?[
      {l:"Employeur",v:s.co.name},{l:"N° ONSS",v:s.co.onss},{l:"Travailleur",v:`${emp.first} ${emp.last}`},{l:"NISS",v:emp.niss},
      {l:"Fonction",v:emp.fn},{l:"CP",v:`CP ${emp.cp}`},{l:"Entrée",v:emp.startD},{l:"Sortie",v:endD},{l:"Motif",v:reason},
      {l:"Dernier brut",v:fmt(emp.monthlySalary)},{l:"Régime",v:`${emp.whWeek}h/sem`},
    ]:dt==='VACATION'?[
      {l:"Employeur",v:s.co.name},{l:"Travailleur",v:`${emp.first} ${emp.last}`},{l:"Année réf.",v:`${new Date().getFullYear()-1}`},
      {l:"Jours vacances",v:"20 jours"},{l:"Simple pécule",v:fmt(emp.monthlySalary)},{l:"Double pécule (92% brut)",v:fmt(emp.monthlySalary*PV_DOUBLE)},{l:"  dont 1ère partie (85%)",v:fmt(emp.monthlySalary*0.85)},{l:"  dont 2ème partie (7%)",v:fmt(emp.monthlySalary*0.07)},{l:"ONSS sur 2ème partie",v:fmt(emp.monthlySalary*0.07*TX_ONSS_W)},
    ]:[{l:"Employeur",v:s.co.name},{l:"Travailleur",v:`${emp.first} ${emp.last}`},{l:"Date",v:new Date().toLocaleDateString('fr-BE')}];

    const title=LEGAL.SOCIAL_DOCS[dt]||dt;
    d({type:"ADD_DOC",d:{eid:emp.id,ename:`${emp.first} ${emp.last}`,dt,title,fields,at:new Date().toISOString()}});
    d({type:"MODAL",m:{w:580,c:<div>
      <h2 style={{fontSize:17,fontWeight:600,color:'#e8e6e0',margin:'0 0 3px',fontFamily:"'Cormorant Garamond',serif"}}>{title}</h2>
      <div style={{fontSize:10.5,color:'#c6a34e',marginBottom:16}}>{s.co.name}</div>
      <div style={{padding:18,background:"#faf9f4",borderRadius:10,color:'#1a1a18'}}>
        {fields.map((f,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'7px 0',borderBottom:'1px solid #eee',fontSize:12.5}}><span style={{color:'#888'}}>{f.l}</span><span style={{fontWeight:500}}>{f.v}</span></div>)}
        <div style={{marginTop:22,display:'flex',justifyContent:'space-between'}}>
          <div style={{fontSize:10.5,color:'#999'}}>Fait le {new Date().toLocaleDateString('fr-BE')}</div>
          <div style={{fontSize:10.5,color:'#999',textAlign:'right'}}>Signature<br/><br/>_____________________</div>
        </div>
      </div>
      <div style={{display:'flex',gap:10,marginTop:14,justifyContent:'flex-end'}}><B v="outline" onClick={()=>d({type:"MODAL",m:null})}>Fermer</B></div>
    </div>}});
  };
  return <div>
    <PH title="Documents Sociaux" sub="C4, attestations, certificats"/>
    <div style={{display:'grid',gridTemplateColumns:'320px 1fr',gap:18}}>
      <C><ST>Nouveau document</ST>
        <I label="Type" value={dt} onChange={setDt} options={Object.entries(LEGAL.SOCIAL_DOCS).map(([k,v])=>({v:k,l:v}))}/>
        <I label="Employé" value={eid} onChange={setEid} style={{marginTop:9}} options={(s.emps||[]).map(e=>({v:e.id,l:`${e.first||e.fn||'Emp'} ${e.last||''}`}))}/>
        {dt==='C4'&&<><I label="Date sortie" type="date" value={endD} onChange={setEndD} style={{marginTop:9}}/>
          <I label="Motif" value={reason} onChange={setReason} style={{marginTop:9}} options={[{v:"Licenciement",l:"Licenciement"},{v:"Démission",l:"Démission"},{v:"Fin CDD",l:"Fin de CDD"},{v:"Commun accord",l:"Commun accord"},{v:"Faute grave",l:"Faute grave"}]}/></>}
        <B onClick={gen} style={{width:'100%',marginTop:14}}>Générer</B>
      </C>
      <C style={{padding:0,overflow:'hidden'}}>
        <div style={{padding:'14px 18px',borderBottom:'1px solid rgba(139,115,60,.1)'}}><div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Documents générés</div></div>
        <Tbl cols={[
          {k:'t',l:"Type",r:r=><span style={{fontWeight:600,color:'#c6a34e'}}>{r.title}</span>},
          {k:'e',l:"Employé",r:r=>r.ename},
          {k:'d',l:"Date",r:r=>new Date(r.at).toLocaleDateString('fr-BE')},
        ]} data={s.docs}/>
      </C>
    </div>
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  REPORTS
// ═══════════════════════════════════════════════════════════════
function ReportsPage({s,d}) {
  const ae=(s.emps||[]).filter(e=>e.status==='active');
  const md=ae.map(e=>{const p=calc(e,DPER,s.co);return{name:`${e.first||e.fn||'Emp'} ${e.last||''}`,gross:p.gross,onssW:p.onssNet,tax:p.tax,css:p.css,net:p.net,onssE:p.onssE,cost:p.costTotal};});
  const t=md.reduce((a,r)=>({g:a.g+r.gross,ow:a.ow+r.onssW,tx:a.tx+r.tax,cs:a.cs+r.css,n:a.n+r.net,oe:a.oe+r.onssE,co:a.co+r.cost}),{g:0,ow:0,tx:0,cs:0,n:0,oe:0,co:0});
  return <div>
    <PH title="Rapports" sub="Analyse masse salariale"/>
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14,marginBottom:22}}>
      <SC label="Masse brute" value={fmt(t.g)} color="#60a5fa"/>
      <SC label="Charges ONSS" value={fmt(t.ow+t.oe)} color="#f87171" sub={`Trav: ${fmt(t.ow)} · Empl: ${fmt(t.oe)}`}/>
      <SC label="Précompte" value={fmt(t.tx)} color="#a78bfa"/>
      <SC label="Coût employeur" value={fmt(t.co)} color="#c6a34e" sub={`Net: ${fmt(t.n)}`}/>
    </div>
    <C style={{padding:0,overflow:'hidden'}}>
      <div style={{padding:'14px 18px',borderBottom:'1px solid rgba(139,115,60,.1)'}}><div style={{fontSize:13,fontWeight:600,color:'#e8e6e0'}}>Détail mensuel</div></div>
      <Tbl cols={[{k:'name',l:"Employé",b:1},{k:'g',l:"Brut",a:'right',r:r=>fmt(r.gross)},{k:'o',l:"ONSS",a:'right',r:r=><span style={{color:'#f87171'}}>{fmt(r.onssW)}</span>},{k:'t',l:"Préc.",a:'right',r:r=><span style={{color:'#a78bfa'}}>{fmt(r.tax)}</span>},{k:'n',l:"Net",a:'right',r:r=><span style={{fontWeight:700,color:'#4ade80'}}>{fmt(r.net)}</span>},{k:'e',l:"ONSS empl.",a:'right',r:r=><span style={{color:'#f87171'}}>{fmt(r.onssE)}</span>},{k:'c',l:"Coût",a:'right',r:r=><span style={{fontWeight:600,color:'#c6a34e'}}>{fmt(r.cost)}</span>}]} data={md}/>
    </C>
    <C style={{marginTop:18}}><div style={{fontSize:13,fontWeight:600,color:'#e8e6e0',marginBottom:14}}>Projection annuelle</div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14}}>
        {[{l:"Masse brute",v:t.g*12,c:'#60a5fa'},{l:"Charges sociales",v:(t.ow+t.oe)*12,c:'#f87171'},{l:"Net versé",v:t.n*12,c:'#4ade80'},{l:"Coût total",v:t.co*12,c:'#c6a34e'}].map((x,i)=>
          <div key={i} style={{textAlign:'center',padding:14,background:`${x.c}08`,borderRadius:8}}><div style={{fontSize:10,color:'#5e5c56',textTransform:'uppercase'}}>{x.l}</div><div style={{fontSize:18,fontWeight:700,color:x.c,marginTop:5}}>{fmt(x.v)}</div></div>
        )}
      </div>
    </C>
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  SETTINGS
// ═══════════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════════
//  FRAIS DE GESTION — Grille tarifaire secrétariat social
// ═══════════════════════════════════════════════════════════════


// ── Sprint 17d: Backup & Restore System ──
function exportBackup(state){
  const backup={
    version:'v38',
    date:new Date().toISOString(),
    app:'Aureus Social Pro',
    data:{
      company:state.co||{},
      employees:state.emps||[],
      payslips:state.pays||[],
      clients:state.clients||[],
      activeClient:state.activeClient||null,
      settings:state.settings||{}
    }
  };
  const json=JSON.stringify(backup,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const d=new Date();
  a.href=url;
  a.download='AureusSocial_Backup_'+d.getFullYear()+'-'+(d.getMonth()+1).toString().padStart(2,'0')+'-'+d.getDate().toString().padStart(2,'0')+'_'+d.getHours().toString().padStart(2,'0')+'h'+d.getMinutes().toString().padStart(2,'0')+'.json';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
  return a.download;
}

function importBackup(file,dispatch){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=function(e){
      try{
        const backup=(()=>{try{return JSON.parse(e.target.result)}catch(e){return null}})();
        if(!backup.data||!backup.app){reject('Fichier invalide');return;}
        if(backup.data.company)dispatch({type:'SET_COMPANY',data:backup.data.company});
        if(backup.data.employees)dispatch({type:'SET_EMPS',data:backup.data.employees});
        if(backup.data.payslips)dispatch({type:'SET_PAYS',data:backup.data.payslips});
        if(backup.data.clients)dispatch({type:'SET_CLIENTS',data:backup.data.clients});
        resolve({
          date:backup.date,
          emps:backup.data.employees?.length||0,
          pays:backup.data.payslips?.length||0,
          clients:backup.data.clients?.length||0
        });
      }catch(err){reject('Erreur lecture: '+err.message);}
    };
    reader.onerror=()=>reject('Erreur lecture fichier');
    reader.readAsText(file);
  });
}

// ── Cloud Backup via Supabase ──
async function cloudBackupSave(state){
  if(!_supabaseRef||!_userIdRef)return{ok:false,msg:'Supabase non connecté'};
  try{
    const backup={
      version:'v38',
      date:new Date().toISOString(),
      company:state.co||{},
      employees:state.emps||[],
      payslips:state.pays||[],
      clients:state.clients||[],
      activeClient:state.activeClient||null,
      emps_count:(state.emps||[]).length,
      pays_count:(state.pays||[]).length,
      clients_count:(state.clients||[]).length
    };
    const{error}=await _supabaseRef.from('backups').insert({
      user_id:_userIdRef,
      backup_data:backup,
      backup_type:'manual',
      label:'Backup '+new Date().toLocaleString('fr-BE'),
      emps_count:backup.emps_count,
      pays_count:backup.pays_count,
      created_at:new Date().toISOString()
    });
    if(error){
      // Table might not exist - try upsert to app_state as fallback
      const{error:e2}=await _supabaseRef.from('app_state').upsert({
        user_id:_userIdRef,
        state_key:'backup_'+Date.now(),
        state_data:backup,
        updated_at:new Date().toISOString()
      },{onConflict:'user_id,state_key'});
      if(e2)return{ok:false,msg:'Erreur: '+e2.message};
    }
    return{ok:true,msg:'Backup cloud sauvegardé',date:backup.date,emps:backup.emps_count};
  }catch(e){return{ok:false,msg:'Erreur: '+e.message};}
}

async function cloudBackupList(){
  if(!_supabaseRef||!_userIdRef)return[];
  try{
    // Try backups table first
    const{data,error}=await _supabaseRef.from('backups')
      .select('id,label,emps_count,pays_count,created_at,backup_type')
      .eq('user_id',_userIdRef)
      .order('created_at',{ascending:false})
      .limit(20);
    if(!error&&data)return data;
    // Fallback: list from app_state
    const{data:d2}=await _supabaseRef.from('app_state')
      .select('state_key,updated_at,state_data')
      .eq('user_id',_userIdRef)
      .like('state_key','backup_%')
      .order('updated_at',{ascending:false})
      .limit(20);
    if(d2)return d2.map(r=>({id:r.state_key,label:r.state_key,created_at:r.updated_at,emps_count:r.state_data?.emps_count||0,pays_count:r.state_data?.pays_count||0}));
    return[];
  }catch(e){return[];}
}

async function cloudBackupRestore(backupId,dispatch){
  if(!_supabaseRef||!_userIdRef)return{ok:false,msg:'Supabase non connecté'};
  try{
    // Try backups table
    let backup=null;
    const{data,error}=await _supabaseRef.from('backups')
      .select('backup_data')
      .eq('id',backupId)
      .eq('user_id',_userIdRef)
      .maybeSingle();
    if(!error&&data)backup=data.backup_data;
    else{
      // Fallback app_state
      const{data:d2}=await _supabaseRef.from('app_state')
        .select('state_data')
        .eq('user_id',_userIdRef)
        .eq('state_key',backupId)
        .maybeSingle();
      if(d2)backup=d2.state_data;
    }
    if(!backup)return{ok:false,msg:'Backup introuvable'};
    if(backup.company)dispatch({type:'SET_COMPANY',data:backup.company});
    if(backup.employees)dispatch({type:'SET_EMPS',data:backup.employees});
    if(backup.payslips)dispatch({type:'SET_PAYS',data:backup.payslips});
    if(backup.clients)dispatch({type:'SET_CLIENTS',data:backup.clients});
    return{ok:true,msg:'Restauration cloud réussie',emps:backup.employees?.length||0};
  }catch(e){return{ok:false,msg:'Erreur: '+e.message};}
}

async function cloudAutoBackup(state){
  if(!_supabaseRef||!_userIdRef)return;
  try{
    await _supabaseRef.from('app_state').upsert({
      user_id:_userIdRef,
      state_key:'autobackup',
      state_data:{
        co:state.co,emps:state.emps,pays:state.pays,
        clients:state.clients,activeClient:state.activeClient,
        date:new Date().toISOString(),
        emps_count:(state.emps||[]).length
      },
      updated_at:new Date().toISOString()
    },{onConflict:'user_id,state_key'});
  }catch(e){}
}


// Auto-backup to localStorage every 5 minutes
function setupAutoBackup(getState){
  setInterval(()=>{
    try{
      const state=getState();
      const backup={
        date:new Date().toISOString(),
        co:state.co,
        emps:state.emps,
        pays:state.pays,
        clients:state.clients,
        activeClient:state.activeClient
      };
      safeLS.set('aureus_autobackup',JSON.stringify(backup));
      safeLS.set('aureus_autobackup_date',new Date().toISOString());
    }catch(e){console.log('Auto-backup failed:',e);}
  },300000); // 5 minutes
}

function SettingsPage({s,d}) {
  const [f,setF]=useState({...s.co});
  return <div>
    <PH title="Paramètres" sub="Configuration société"/>
    {/* Backup & Restore */}
    <div style={{marginBottom:18,padding:16,background:'linear-gradient(135deg,rgba(34,197,94,.06),rgba(34,197,94,.02))',border:'1px solid rgba(34,197,94,.15)',borderRadius:12}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
        <div><div style={{fontSize:14,fontWeight:600,color:'#22c55e'}}>💾 Sauvegarde & Restauration</div><div style={{fontSize:10,color:'#888',marginTop:2}}>Dernière sauvegarde auto: {safeLS.get('aureus_autobackup_date')?new Date(safeLS.get('aureus_autobackup_date')).toLocaleString('fr-BE'):'Aucune'}</div></div>
        <div style={{display:'flex',gap:8}}>
          <button onClick={()=>{const name=exportBackup(s);alert('✅ Backup téléchargé: '+name)}} style={{padding:'8px 16px',borderRadius:8,border:'none',background:'#22c55e',color:'#fff',fontSize:11,fontWeight:600,cursor:'pointer'}}>📥 Exporter Backup</button>
          <label style={{padding:'8px 16px',borderRadius:8,border:'1px solid rgba(59,130,246,.3)',background:'rgba(59,130,246,.1)',color:'#3b82f6',fontSize:11,fontWeight:600,cursor:'pointer'}}> Importer
            <input type="file" accept=".json" style={{display:'none'}} onChange={async(e)=>{
              const file=e.target.files[0];if(!file)return;
              try{const r=await importBackup(file,d);alert('✅ Restauration réussie!\n\n'+r.emps+' employés\n'+r.pays+' fiches de paie\n'+r.clients+' clients\n\nDate backup: '+new Date(r.date).toLocaleString('fr-BE'));}
              catch(err){alert('❌ Erreur: '+err);}
              e.target.value='';
            }}/>
          </label>
          <button onClick={()=>{
            let autoBackup=safeLS.get('aureus_autobackup');
            if(!autoBackup){alert('Aucune sauvegarde automatique trouvée');return;}
            if(confirm('Restaurer la dernière sauvegarde automatique ?\n\nDate: '+new Date(safeLS.get('aureus_autobackup_date')).toLocaleString('fr-BE'))){
              try{const b=(()=>{try{return JSON.parse(autoBackup)}catch(e){return null}})();if(b.co)d({type:'SET_COMPANY',data:b.co});if(b.emps)d({type:'SET_EMPS',data:b.emps});if(b.pays)d({type:'SET_PAYS',data:b.pays});alert('✅ Restauration auto-backup réussie');}catch(err){alert('❌ Erreur: '+err);}
            }
          }} style={{padding:'8px 16px',borderRadius:8,border:'1px solid rgba(234,179,8,.3)',background:'rgba(234,179,8,.1)',color:'#eab308',fontSize:11,fontWeight:600,cursor:'pointer'}}>🔄 Auto-backup</button>
        </div>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
        <div style={{padding:8,background:'rgba(198,163,78,.06)',borderRadius:8,textAlign:'center'}}><div style={{fontSize:16,fontWeight:700,color:'#c6a34e'}}>{(s.emps||[]).length}</div><div style={{fontSize:9,color:'#888'}}>Employés</div></div>
        <div style={{padding:8,background:'rgba(59,130,246,.06)',borderRadius:8,textAlign:'center'}}><div style={{fontSize:16,fontWeight:700,color:'#3b82f6'}}>{(s.pays||[]).length}</div><div style={{fontSize:9,color:'#888'}}>Fiches paie</div></div>
        <div style={{padding:8,background:'rgba(168,85,247,.06)',borderRadius:8,textAlign:'center'}}><div style={{fontSize:16,fontWeight:700,color:'#a855f7'}}>{(s.clients||[]).length}</div><div style={{fontSize:9,color:'#888'}}>Clients</div></div>
        <div style={{padding:8,background:'rgba(34,197,94,.06)',borderRadius:8,textAlign:'center'}}><div style={{fontSize:16,fontWeight:700,color:'#22c55e'}}>{Math.round(JSON.stringify(s).length/1024)} KB</div><div style={{fontSize:9,color:'#888'}}>Taille données</div></div>
      </div>
    </div>
    {/* 2FA / MFA TOTP */}
    <div style={{marginBottom:18,padding:16,background:'linear-gradient(135deg,rgba(198,163,78,.06),rgba(198,163,78,.02))',border:'1px solid rgba(198,163,78,.15)',borderRadius:12}}>
      <TwoFactorSetup/>
    </div>
    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:18}}>
      <C><ST>Identification</ST><div style={{display:'grid',gap:9}}>
        <I label="Société" value={f.name} onChange={v=>setF({...f,name:v})}/>
        <I label="TVA" value={f.vat} onChange={v=>setF({...f,vat:v})}/>
        <I label="BCE" value={f.bce} onChange={v=>setF({...f,bce:v})}/>
        <I label="ONSS" value={f.onss} onChange={v=>setF({...f,onss:v})}/>
        <I label="Code NACE" value={f.nace} onChange={v=>setF({...f,nace:v})}/>
        <I label="Adresse" value={f.addr} onChange={v=>setF({...f,addr:v})}/>
        <I label="CP" value={f.cp} onChange={v=>setF({...f,cp:v})} options={Object.entries(LEGAL.CP).map(([k,v])=>({v:k,l:v}))}/>
        <I label="IBAN (compte bancaire)" value={f.bank} onChange={v=>setF({...f,bank:v})}/>
        <I label="BIC (code banque)" value={f.bic} onChange={v=>setF({...f,bic:v})} options={[
          {v:"GEBABEBB",l:"GEBABEBB — BNP Paribas Fortis"},
          {v:"BBRUBEBB",l:"BBRUBEBB — ING Belgique"},
          {v:"KREDBEBB",l:"KREDBEBB — KBC / CBC"},
          {v:"GKCCBEBB",l:"GKCCBEBB — Belfius"},
          {v:"ARSPBE22",l:"ARSPBE22 — Argenta"},
          {v:"NICABEBB",l:"NICABEBB — Crelan"},
          {v:"TRIOBEBB",l:"TRIOBEBB — Triodos"},
          {v:"AXABBE22",l:"AXABBE22 — AXA Banque"},
        ]}/>
      </div></C>
      <C><ST>Contact & Assurances</ST><div style={{display:'grid',gap:9}}>
        <I label="Contact" value={f.contact} onChange={v=>setF({...f,contact:v})}/>
        <I label="Email" value={f.email} onChange={v=>setF({...f,email:v})}/>
        <I label="Téléphone" value={f.phone} onChange={v=>setF({...f,phone:v})}/>
        <I label="Assureur AT" value={f.insurer} onChange={v=>setF({...f,insurer:v})}/>
        <I label="N° police" value={f.policyNr} onChange={v=>setF({...f,policyNr:v})}/>
        <I label="Secrétariat social" value={f.secSoc} onChange={v=>setF({...f,secSoc:v})}/>
      </div></C>
    </div>
    <div style={{marginTop:14,display:'flex',justifyContent:'flex-end'}}><B onClick={()=>{d({type:"UPD_CO",d:f});alert('Sauvegardé !')}}>Sauvegarder</B></div>
    
    {/* 2FA Security Section */}
    <C style={{marginTop:20}}>
      <ST>🔐 Sécurité — Authentification à deux facteurs (2FA)</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
        <div>
          <div style={{fontSize:12,color:'#e8e6e0',marginBottom:8,fontWeight:600}}>Statut 2FA</div>
          <div style={{display:'flex',alignItems:'center',gap:10,padding:14,background:'rgba(74,222,128,.04)',borderRadius:10,border:'1px solid rgba(74,222,128,.12)'}}>
            <span style={{fontSize:24}}>🔒</span>
            <div>
              <div style={{fontSize:13,fontWeight:600,color:'#4ade80'}}>2FA disponible via Supabase</div>
              <div style={{fontSize:10.5,color:'#5e5c56',marginTop:2}}>Activez la vérification en deux étapes pour sécuriser votre compte</div>
            </div>
          </div>
          <div style={{marginTop:12}}>
            <B v="outline" style={{width:'100%'}} onClick={async()=>{
              try{
                const{data,error}=await(await import('./lib/supabase')).supabase.auth.mfa.enroll({factorType:'totp'});
                if(error)return alert('Erreur: '+error.message);
                if(data){
                  const qr=data.totp?.qr_code;
                  const secret=data.totp?.secret;
                  alert('2FA activé !\\n\\nScannez le QR code avec Google Authenticator ou Authy.\\n\\nSecret: '+secret+'\\n\\n(Le QR code sera affiché dans une prochaine version)');
                }
              }catch(e){alert('2FA via TOTP — Activez dans Supabase Dashboard > Authentication > MFA');}
            }}>🔐 Activer 2FA (TOTP)</B>
          </div>
        </div>
        <div>
          <div style={{fontSize:12,color:'#e8e6e0',marginBottom:8,fontWeight:600}}>Options de sécurité</div>
          <div style={{display:'flex',flexDirection:'column',gap:8}}>
            <div style={{display:'flex',alignItems:'center',gap:10,padding:12,background:'rgba(198,163,78,.03)',borderRadius:8,border:'1px solid rgba(198,163,78,.08)'}}>
              <span>📧</span>
              <div style={{flex:1}}>
                <div style={{fontSize:11.5,color:'#e8e6e0'}}>Email de confirmation</div>
                <div style={{fontSize:9.5,color:'#5e5c56'}}>Requis à l'inscription</div>
              </div>
              <span style={{fontSize:10,color:'#4ade80',fontWeight:600}}>Actif ✓</span>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:10,padding:12,background:'rgba(198,163,78,.03)',borderRadius:8,border:'1px solid rgba(198,163,78,.08)'}}>
              <span>🔑</span>
              <div style={{flex:1}}>
                <div style={{fontSize:11.5,color:'#e8e6e0'}}>Réinitialisation mot de passe</div>
                <div style={{fontSize:9.5,color:'#5e5c56'}}>Par email sécurisé</div>
              </div>
              <span style={{fontSize:10,color:'#4ade80',fontWeight:600}}>Actif ✓</span>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:10,padding:12,background:'rgba(198,163,78,.03)',borderRadius:8,border:'1px solid rgba(198,163,78,.08)'}}>
              <span>⏱</span>
              <div style={{flex:1}}>
                <div style={{fontSize:11.5,color:'#e8e6e0'}}>Session timeout</div>
                <div style={{fontSize:9.5,color:'#5e5c56'}}>Déconnexion après inactivité</div>
              </div>
              <span style={{fontSize:10,color:'#fb923c',fontWeight:600}}>1 heure</span>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:10,padding:12,background:'rgba(198,163,78,.03)',borderRadius:8,border:'1px solid rgba(198,163,78,.08)'}}>
              <span>📱</span>
              <div style={{flex:1}}>
                <div style={{fontSize:11.5,color:'#e8e6e0'}}>TOTP (Google Authenticator / Authy)</div>
                <div style={{fontSize:9.5,color:'#5e5c56'}}>Code à 6 chiffres toutes les 30 secondes</div>
              </div>
              <span style={{fontSize:10,color:'#fb923c',fontWeight:600}}>À activer</span>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:10,padding:12,background:'rgba(198,163,78,.03)',borderRadius:8,border:'1px solid rgba(198,163,78,.08)'}}>
              <span>🛡</span>
              <div style={{flex:1}}>
                <div style={{fontSize:11.5,color:'#e8e6e0'}}>Audit trail (Boîte noire)</div>
                <div style={{fontSize:9.5,color:'#5e5c56'}}>Toute action est tracée dans audit_log</div>
              </div>
              <span style={{fontSize:10,color:'#4ade80',fontWeight:600}}>Actif ✓</span>
            </div>
          </div>
        </div>
      </div>
    </C>
    <C style={{marginTop:20}}>
      <ST>Barèmes légaux</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:20,marginTop:10}}>
        <div><div style={{fontSize:11.5,fontWeight:600,color:'#e8e6e0',marginBottom:6}}>ONSS</div><div style={{fontSize:11.5,color:'#9e9b93',lineHeight:2}}>
          <div>Travailleur: <b style={{color:'#e8e6e0'}}>{fmtP(LEGAL.ONSS_W)}</b></div>
          <div>Employeur (marchand): <b style={{color:'#e8e6e0'}}>25,00%</b></div>
          <div>Employeur (non-march.): <b style={{color:'#e8e6e0'}}>32,40%</b></div>
          <div>Ouvriers: brut × 108%</div>
          <div>Bonus max: <b style={{color:'#e8e6e0'}}>{fmt(LEGAL.BONUS_2026.A_MAX)}</b></div>
        </div></div>
        <div><div style={{fontSize:11.5,fontWeight:600,color:'#e8e6e0',marginBottom:6}}>Avantages</div><div style={{fontSize:11.5,color:'#9e9b93',lineHeight:2}}>
          <div>CR empl. max: <b style={{color:'#e8e6e0'}}>{fmt(LEGAL.MV.emax)}</b> (2026)</div>
          <div>CR trav. min: <b style={{color:'#e8e6e0'}}>{fmt(LEGAL.MV.wmin)}</b></div>
          <div>CR valeur max: <b style={{color:'#e8e6e0'}}>{fmt(LEGAL.MV.maxTotal)}</b></div>
          <div>Éco-chèques: <b style={{color:'#e8e6e0'}}>{fmt(LEGAL.ECO)}/an</b></div>
        </div></div>
        <div><div style={{fontSize:11.5,fontWeight:600,color:'#e8e6e0',marginBottom:6}}>Régime</div><div style={{fontSize:11.5,color:'#9e9b93',lineHeight:2}}>
          <div>Heures/sem: <b style={{color:'#e8e6e0'}}>{LEGAL.WH}h</b></div>
          <div>Heures/jour: <b style={{color:'#e8e6e0'}}>{LEGAL.WHD}h</b></div>
          <div>Jours/mois: <b style={{color:'#e8e6e0'}}>{LEGAL.WD}</b></div>
        </div></div>
      </div>
      <div style={{marginTop:14,padding:10,background:"rgba(96,165,250,.05)",borderRadius:8,border:'1px solid rgba(96,165,250,.08)'}}>
        <div style={{fontSize:10.5,color:'#4ade80',lineHeight:1.5}}>✅ Précompte professionnel calculé selon la formule-clé complète SPF Finances — Annexe III AR/CIR 92 — Barèmes 2026 (tranches annuelles 26,75% à 53,50%, quotité exemptée 10 900€, frais forfaitaires 30% plafond 5 930€, quotient conjugal, réductions familiales annualisées).</div>
      </div>
    </C>
    <C style={{marginTop:20}}>
      <ST>🔍 Audit système — Aureus Social Pro</ST>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:18,marginTop:12}}>
        <div>
          <div style={{fontSize:11.5,fontWeight:600,color:'#4ade80',marginBottom:10}}>✅ Barèmes SPF vérifiés (salairesminimums.be)</div>
          <div style={{fontSize:11,color:'#9e9b93',lineHeight:2.2}}>
            {[
              {cp:'200',n:'CP AUXILIAIRE EMPLOYÉS',idx:'2,21%',dt:'01/01/2026',src:'Grille A/B/C/D, 0-26 ans anc.'},
              {cp:'124',n:'CONSTRUCTION',idx:'0,22%',dt:'01/01/2026',src:'Taux horaires I→Chef IV'},
              {cp:'302',n:'HÔTELLERIE',idx:'2,19%',dt:'01/01/2026',src:'Cat I-V par ancienneté'},
              {cp:'118',n:'INDUSTRIE ALIMENTAIRE (ouv.)',idx:'2,19%',dt:'01/01/2026',src:'S-sect.17, 8 classes, anc mois'},
              {cp:'140',n:'TRANSPORT ROUTIER',idx:'2,18%',dt:'01/01/2026',src:'SCP 140.03 roulant/non-roulant/garage'},
              {cp:'330',n:'SANTÉ',idx:'2,0%',dt:'01/01/2026',src:'Éch. 1.12→1.59, 13 échelons anc.'},
              {cp:'121',n:'NETTOYAGE',idx:'0,56%',dt:'01/01/2026',src:'8 catégories, régime 37h'},
              {cp:'111',n:'MÉTAL/MÉCANIQUE (ouv.)',idx:'2,72%',dt:'01/07/2025',src:'Cat 1-7 national + Agoria'},
              {cp:'116',n:'CHIMIE (ouvriers)',idx:'2,0%',dt:'01/04/2025',src:'Taux horaires manœuvre, 2 échelons'},
              {cp:'201',n:'COMMERCE DÉTAIL INDÉPENDANT',idx:'2,0%',dt:'01/04/2025',src:'Grp1 vente Cat.1-4, exp 0-14 ans'},
              {cp:'202',n:'COMMERCE DÉTAIL ALIMENTAIRE',idx:'1,0%',dt:'01/01/2026',src:'Cat 1-5 par ancienneté'},
              {cp:'209',n:'FAB. MÉTALLIQUE (empl.)',idx:'2,0%',dt:'01/07/2025',src:'Classes SCE, Agoria'},
              {cp:'220',n:'INDUSTRIE ALIMENTAIRE (empl.)',idx:'2,19%',dt:'01/01/2026',src:'Cat 1-6, CGSLB'},
              {cp:'306',n:'ASSURANCES',idx:'2,23%',dt:'01/01/2026',src:'Employés Cat.1-4B, 22 éch. anc.'},
              {cp:'304',n:'SPECTACLE',idx:'x1,37',dt:'01/02/2026',src:'Groupes 1a-6, SPF officiel'},
              {cp:'311',n:'GRANDES SURFACES',idx:'2,21%',dt:'01/01/2026',src:'Cat 1-5, vente détail'},
              {cp:'313',n:'PHARMACIES',idx:'2,0%',dt:'01/03/2025',src:'Non-pharma Cat I-IV 0-42 ans + Pharmaciens'},
              {cp:'317',n:'GARDIENNAGE',idx:'2,21%',dt:'01/01/2026',src:'Agent A-D, sécurité'},
              {cp:'318',n:'AIDES FAMILIALES',idx:'2,0%',dt:'01/01/2026',src:'Cat 1-4 non-marchand'},
              {cp:'329',n:'SOCIO-CULTUREL',idx:'2,0%',dt:'01/01/2026',src:'Barème 1-4.1, ASBL'},
              {cp:'331',n:'AIDE SOCIALE (Flandre)',idx:'2,0%',dt:'01/01/2026',src:'IFIC Cat 1-5'},
              {cp:'332',n:'AIDE SOCIALE (francophone)',idx:'2,0%',dt:'01/01/2026',src:'IFIC Cat 1-5'},
              {cp:'336',n:'PROFESSIONS LIBÉRALES',idx:'2,21%',dt:'01/01/2026',src:'Cat 1-4 aligné CP 200'},
              {cp:'144',n:'AGRICULTURE',idx:'2,21%',dt:'01/01/2026',src:'Cat 1-4 secteurs verts'},
              {cp:'145',n:'HORTICULTURE',idx:'2,21%',dt:'01/01/2026',src:'Cat 1-3 secteurs verts'},
              {cp:'152',n:'ENSEIGNEMENT LIBRE (ouv.)',idx:'2,0%',dt:'01/01/2026',src:'6 catégories CP 152.02'},
              {cp:'333',n:'ATTRACTIONS TOURISTIQUES',idx:'2,21%',dt:'01/01/2026',src:'Cat 1-4 loisirs'},
            ].map(b=><div key={b.cp} style={{display:'flex',gap:8,alignItems:'center'}}>
              <span style={{background:"rgba(74,222,128,.1)",color:'#4ade80',padding:'1px 6px',borderRadius:4,fontSize:9,fontWeight:700,minWidth:44,textAlign:'center'}}>CP {b.cp}</span>
              <span style={{color:'#d4d0c8',fontSize:11}}>{b.n}</span>
              <span style={{color:'#5e5c56',fontSize:10,marginLeft:'auto'}}>idx {b.idx} · {b.dt}</span>
            </div>)}
          </div>
          <div style={{fontSize:11.5,fontWeight:600,color:'#facc15',marginTop:16,marginBottom:10}}>≈ Barèmes estimés (structure confirmée, montants approximatifs)</div>
          <div style={{fontSize:11,color:'#9e9b93',lineHeight:2.2}}>
            {[
              {cp:'149',n:'ÉLECTRICIENS',idx:'2,0%',dt:'01/01/2026',src:'5 cat. avec prime ancienneté'},
              {cp:'225',n:'ENSEIGNEMENT PRIVÉ (empl.)',idx:'2,21%',dt:'01/01/2026',src:'Aligné CP 200'},
              {cp:'226',n:'COMMERCE INTERNATIONAL',idx:'2,23%',dt:'01/01/2026',src:'CGSLB vérifié'},
              {cp:'307',n:'COURTAGE ASSURANCES',idx:'2,21%',dt:'01/01/2026',src:'Aligné CP 200 + compléments'},
              {cp:'319',n:'ÉDUCATIFS',idx:'2,0%',dt:'01/01/2026',src:'Non-marchand, IFIC'},
              {cp:'322.01',n:'TITRES-SERVICES',idx:'2,0%',dt:'01/01/2026',src:'Salaire sectoriel minimum'},
              {cp:'323',n:'IMMOBILIER',idx:'2,21%',dt:'01/01/2026',src:'Aligné CP 200'},
              {cp:'327',n:'ETA',idx:'2,0%',dt:'01/01/2026',src:'Travailleurs adaptés + encadrement'},
            ].map(b=><div key={b.cp} style={{display:'flex',gap:8,alignItems:'center'}}>
              <span style={{background:"rgba(250,204,21,.1)",color:'#facc15',padding:'1px 6px',borderRadius:4,fontSize:9,fontWeight:700,minWidth:44,textAlign:'center'}}>CP {b.cp}</span>
              <span style={{color:'#d4d0c8',fontSize:11}}>{b.n}</span>
              <span style={{color:'#5e5c56',fontSize:10,marginLeft:'auto'}}>idx {b.idx} · {b.dt}</span>
            </div>)}
          </div>
          <div style={{fontSize:11.5,fontWeight:600,color:'#4ade80',marginTop:16,marginBottom:10}}>✅ 35 CPs — 27 vérifiés SPF + 8 estimés fiables</div>
        </div>
        <div>
          <div style={{fontSize:11.5,fontWeight:600,color:'#e8e6e0',marginBottom:10}}>📊 Statistiques application</div>
          <div style={{fontSize:11,color:'#9e9b93',lineHeight:2.2}}>
            <div>Modules fonctionnels: <b style={{color:'#c6a34e'}}>46</b></div>
            <div>Composants React: <b style={{color:'#c6a34e'}}>~90</b></div>
            <div>Catégories navigation: <b style={{color:'#c6a34e'}}>12</b></div>
            <div>CPs avec barèmes: <b style={{color:'#4ade80'}}>35</b> / 35 (27 SPF + 8 estimés)</div>
            <div>Secteurs wizard: <b style={{color:'#c6a34e'}}>26</b> activités</div>
            <div>Documents DRS: <b style={{color:'#c6a34e'}}>14 types Activa + 15 chômage + 14 INAMI</b></div>
            <div>Formats comptables: <b style={{color:'#c6a34e'}}>6</b> (BOB, Winbooks, Kluwer, Popsy, Soda, Autre)</div>
            <div>Régions Activa: <b style={{color:'#c6a34e'}}>3</b> (Actiris, FOREM, VDAB)</div>
          </div>
          <div style={{fontSize:11.5,fontWeight:600,color:'#4ade80',marginTop:16,marginBottom:10}}>✅ Calculs conformes Annexe III 2026</div>
          <div style={{fontSize:11,color:'#9e9b93',lineHeight:1.8}}>
            {[
              'Précompte pro: formule-clé COMPLÈTE SPF Finances 2026 (tranches 26,75%→53,50%, quotité exemptée 10 900€)',
              '35 CPs avec barèmes vérifiés (sources SPF et syndicales officielles)',
              'CP 209: barèmes indexés +2,72% au 01/07/2025 — montants exacts emploi.belgique.be',
              'CP 330: barèmes classiques + échelles IFIC (Cat.1.12→1.59)',
              'ONSS: taux 25% marchand + 32,40% non-marchand + ouvrier 108% + modulations sectorielles + cotis. spéciales (FFE, chômage temp., amiante)',
              'Pécule vacances: double pécule détaillé (85% + 7%, ONSS 2ème partie, cotis. spéc. 1%)',
            ].map((p,i)=><div key={i} style={{paddingLeft:10,borderLeft:'2px solid rgba(74,222,128,.3)',marginBottom:6,fontSize:10.5,color:'#4ade80'}}>{p}</div>)}
          </div>
          <div style={{fontSize:11.5,fontWeight:600,color:'#60a5fa',marginTop:16,marginBottom:10}}>💡 Pistes d'évolution future</div>
          <div style={{fontSize:11,color:'#9e9b93',lineHeight:1.8}}>
            {[
              'Module flexi-jobs (horeca, commerce, santé)',
              'Export SEPA XML ISO 20022 pour virements salaires',
              'Module évaluation annuelle / entretien fonctionnement',
              'Gestion planning/horaires avec badgeuse',
              'Intégration eBox entreprise (documents sociaux dématérialisés)',
              'Module accident du travail (déclaration + suivi FEDRIS)',
              'Connexion API DmfA / Dimona (batch ONSS)',
            ].map((p,i)=><div key={i} style={{paddingLeft:10,borderLeft:'2px solid rgba(96,165,250,.2)',marginBottom:6,fontSize:10.5,color:'#60a5fa'}}>{p}</div>)}
          </div>
        </div>
      </div>
    </C>
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  MODULES PRO
// ═══════════════════════════════════════════════════════════════
const DRS_DOCS={
  chomage:[
    {code:'C4',l:"C4 — Certificat de chômage",f:['motif',"brut","regime","preavis"]},
    {code:'C4-RCC',l:"C4 Prépension (RCC)",f:['motif',"brut","date_rcc"]},
    {code:'C4-ENS',l:"C4 Enseignement",f:['motif',"etablissement"]},
    {code:'C3.2-CD',l:"C3.2 Constat du droit",f:['regime',"heures"]},
    {code:'C3.2-OUV',l:"C3.2 Employeur → Ouvriers",f:['jours',"motif"]},
    {code:'C3.2-EMP',l:"C3.2 Anti-crise → Employés",f:['jours',"motif"]},
    {code:'C131A',l:"C131A Employeur",f:['debut',"motif","regime"]},
    {code:'C131B',l:"C131B",f:['debut',"regime"]},
    {code:'C131A-E',l:"C131A Enseignement",f:['debut',"etablissement"]},
    {code:'C131B-E',l:"C131B Enseignement",f:['debut']},
    {code:'C78-ACT-BXL',l:"C78 Activa.brussels (Actiris)",f:['type_activa',"debut","duree","montant_red"]},
    {code:'C78-ACT-WAL',l:"C78 Impulsion -12/-25 mois (FOREM)",f:['type_impulsion',"debut","duree","montant_red"]},
    {code:'C78-ACT-VL',l:"C78 Werkplekleren / Winwin (VDAB)",f:['type_vl',"debut","duree"]},
    {code:'C78-TRANS',l:"C78 Prime de transition (Bruxelles)",f:['debut',"duree","montant"]},
    {code:'C78-START',l:"C78 Activa Start (<26 ans)",f:['debut',"duree","age"]},
    {code:'C78-ETA',l:"C78 E.T.A. (Entreprise Travail Adapté)",f:['type',"debut","pct_prime"]},
    {code:'C78-ART60',l:"C78 Article 60§7 (CPAS)",f:['cpas',"debut","fin","type_art60","subsides"]},
    {code:'C78-ART61',l:"C78 Article 61 (CPAS mise à dispo)",f:['cpas',"debut","fin"]},
    {code:'C78-SINE',l:"C78 SINE (Économie sociale insertion)",f:['debut',"duree","agrément"]},
    {code:'C78.3',l:"C78.3 P.T.P. (Programme Transition Pro)",f:['debut',"heures","org_encadrement"]},
    {code:'C78-SEC',l:"C78 Sécurité & prévention",f:['debut',"fonction"]},
    {code:'C78-FIRST',l:"C78 Stage First / FPI (Actiris/FOREM)",f:['debut',"duree","indemnite"]},
    {code:'C78-FORM',l:"C78 Contrat de formation (IFAPME/EFP)",f:['debut',"duree","centre"]},
    {code:'C78-HAND',l:"C78 Prime handicap (AVIQ/PHARE/VDAB)",f:['debut',"organisme","pct_prime"]},
    {code:'C103-JE',l:"C103 Jeunes Employeur",f:['debut',"age"]},
    {code:'C103-JT',l:"C103 Jeunes Travailleur",f:['debut',"age"]},
    {code:'C103-SE',l:"C103 Seniors Employeur",f:['debut',"age"]},
    {code:'C103-ST',l:"C103 Seniors Travailleur",f:['debut',"age"]},
  ],
  inami:[
    {code:'IN-MAL',l:"Incapacité — Maladie/Accident",f:['debut',"fin","diagnostic"]},
    {code:'IN-MAT',l:"Repos de maternité",f:['accouchement',"debut","fin"]},
    {code:'IN-EC',l:"Écartement complet maternité",f:['debut',"fin"]},
    {code:'IN-EP',l:"Écartement partiel maternité",f:['debut',"fin","heures"]},
    {code:'IN-CONV',l:"Maternité/Paternité converti",f:['debut',"fin"]},
    {code:'IN-NAIS',l:"Congé naissance (10j)",f:['naissance',"debut"]},
    {code:'IN-ADOP',l:"Congé adoption",f:['debut',"fin"]},
    {code:'IN-REP',l:"Reprise partielle travail",f:['debut',"heures"]},
    {code:'IN-PROT',l:"Protection maternité",f:['debut',"fin"]},
    {code:'IN-2EMP',l:"2 employeurs différents",f:['debut',"employeur2"]},
    {code:'IN-ALL',l:"Allaitement — Pauses",f:['debut',"nb_pauses"]},
    {code:'VAC-C',l:"Vacances annuelles (caisse)",f:['annee',"jours"]},
    {code:'VAC-E',l:"Vacances annuelles (employeur)",f:['annee',"jours","montant"]},
    {code:'IN-REPR',l:"Reprise du travail",f:['date_reprise']},
  ],
  papier:[
    {code:'C4-P',l:"C4 DRS (papier)",f:['motif']},
    {code:'C4-RCC-P',l:"C4 DRS-RCC (papier)",f:['motif']},
    {code:'ATT-PV',l:"Attestation Pécules de vacances",f:['annee',"simple","double"]},
    {code:'ATT-TRAV',l:"Attestation de travail",f:['debut',"fin","fonction"]},
    {code:'ATT-276',l:"Attestation 276 frontaliers",f:['pays',"annee"]},
  ],
};
const COMPTA=[{id:"bob",n:'BOB Software',fmt:'CSV/XML'},{id:"winbooks",n:'Winbooks',fmt:'TXT/CSV'},{id:"kluwer",n:'Kluwer Expert',fmt:'CSV'},{id:"popsy",n:'Popsy',fmt:'TXT'},{id:"soda",n:'Soda',fmt:'CSV'},{id:"exact",n:'Exact Online',fmt:'CSV/XML'},{id:"octopus",n:'Octopus',fmt:'CSV'},{id:"clearfact",n:'ClearFact',fmt:'CSV/UBL'},{id:"yuki",n:'Yuki',fmt:'XML'},{id:"horus",n:'Horus',fmt:'CSV'},{id:"other",n:'Autre (txt/xls)',fmt:'TXT/XLS'}];
const CR_PROV=[{id:"pluxee",n:'Pluxee (ex-Sodexo)',ic:'🟠'},{id:"edenred",n:'Edenred',ic:'🔴'},{id:"monizze",n:'Monizze',ic:'🟢'},{id:"got",n:'G.O.T. CONNECTION',ic:'🔵'}];

// ═══════════════════════════════════════════════════════════════
//  SOUS-NAVIGATION — Breadcrumb + bouton retour + onglets
// ═══════════════════════════════════════════════════════════════
function SubNav({parentId,parentLabel,subs,activeSub,d}){
  return <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:14,padding:'8px 12px',background:'rgba(198,163,78,.03)',border:'1px solid rgba(198,163,78,.08)',borderRadius:10,flexWrap:'wrap'}}>
    <button onClick={()=>d({type:"NAV",page:parentId,sub:subs[0]?.id||null})} style={{display:'flex',alignItems:'center',gap:4,padding:'5px 10px',borderRadius:6,border:'none',background:'rgba(198,163,78,.1)',color:'#c6a34e',fontSize:11,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}} title="Retour">
      ← {parentLabel}
    </button>
    <span style={{color:'#5e5c56',fontSize:11}}>›</span>
    {subs.map(sb=><button key={sb.id} onClick={()=>d({type:"NAV",page:parentId,sub:sb.id})} style={{padding:'5px 12px',borderRadius:6,border:'none',cursor:'pointer',fontSize:11,fontWeight:activeSub===sb.id?600:400,fontFamily:'inherit',background:activeSub===sb.id?'rgba(198,163,78,.12)':'transparent',color:activeSub===sb.id?'#c6a34e':'#9e9b93',transition:'all .1s'}}>{sb.l}</button>)}
  </div>;
}

// ═══════════════════════════════════════════════════════════════
//  CATEGORY ROUTER PAGES
// ═══════════════════════════════════════════════════════════════
function SalairesPage({s,d}){const sub=s.sub||'od';const _subs=[{id:"simcout",l:"Simulation coût"},{id:"netbrut",l:"Net → Brut"},{id:"provisions",l:"Provisions"},{id:"cumuls",l:"Cumuls"},{id:"indexauto",l:"Indexation"},{id:"treizieme",l:"13ème mois"},{id:"bonusemploi",l:"Bonus emploi"}];return <div>
  <SubNav parentId="salaires" parentLabel="Salaires" subs={_subs} activeSub={sub} d={d}/>
  <PH title="Salaires & Calculs" sub={`Module: ${{'od':'O.D. Comptables',"provisions":'Provisions',"cumuls":'Cumuls annuels',"netbrut":'Net → Brut',"simcout":'Simulation coût salarial',"saisies":'Saisies-Cessions',"indexauto":'Index automatique',"horsforfait":'Heures supplémentaires',"totalreward":'Total Reward Statement',"transport":'Transport domicile-travail',"treizieme":'13ème mois',"css":'Cotisation spéciale SS',"bonusemploi":'Bonus à l\'emploi'}[sub]||sub}`}/>
    <div style={{marginBottom:14,padding:'10px 14px',background:'linear-gradient(135deg,rgba(198,163,78,.06),rgba(198,163,78,.02))',border:'1px solid rgba(198,163,78,.1)',borderRadius:10,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
      <div style={{fontSize:11,color:'#888'}}>⚡ SEPA + Fiches auto-générés le jour de paie</div>
      <div style={{display:'flex',gap:6}}>
        <button onClick={()=>{if(confirm('Générer SEPA ?')){generateSEPAXML(s.emps||[],s.co);alert('✅ SEPA généré')}}} style={{padding:'6px 12px',borderRadius:8,border:'none',background:'#22c55e',color:'#fff',fontSize:11,cursor:'pointer',fontWeight:600}}>💸 SEPA</button>
        <button onClick={()=>{if(confirm('Générer fiches ?')){(s.emps||[]).forEach(e=>generatePayslipPDF(e,s.co));alert('✅ Fiches générées')}}} style={{padding:'6px 12px',borderRadius:8,border:'none',background:'#c6a34e',color:'#fff',fontSize:11,cursor:'pointer',fontWeight:600}}>📄 Fiches</button>
      </div>
    </div>
  {sub==='od'&&<ODModLazy s={s} d={d}/>}{sub==='provisions'&&<ProvisionsModLazy s={s} d={d}/>}
  {sub==='cumuls'&&<CumulsModLazy s={s} d={d}/>}{sub==='netbrut'&&<NetBrutModLazy s={s} d={d}/>}
  {sub==='simcout'&&<SimCoutModLazy s={s} d={d}/>}{sub==='totalreward'&&<TotalRewardModLazy s={s} d={d}/>}
  {sub==='saisies'&&<SaisiesModLazy s={s} d={d}/>}{sub==='indexauto'&&<IndexAutoModLazy s={s} d={d}/>}
  {sub==='horsforfait'&&<HeuresSupModLazy s={s} d={d}/>}
  {sub==='transport'&&<TransportDomTravModLazy s={s} d={d}/>}
  {sub==='treizieme'&&<TreizMoisModLazy s={s} d={d}/>}
  {sub==='css'&&<CSSModLazy s={s} d={d}/>}
  {sub==='bonusemploi'&&<BonusEmploiModLazy s={s} d={d}/>}
</div>;}

function AvantagesPage({s,d}){const sub=s.sub||'cheques';const _subs=[{id:"cheques",l:"Chèques-repas"},{id:"ecochequesv2",l:"Eco-chèques"},{id:"plancafeteria",l:"Plan Cafeteria"},{id:"cct90bonus",l:"Bonus CCT 90"},{id:"notefraisv2",l:"Notes de frais"},{id:"warrants",l:"Warrants"},{id:"budgetmob",l:"Budget mobilité"}];return <div>
  <SubNav parentId="avantages" parentLabel="Avantages" subs={_subs} activeSub={sub} d={d}/>
  {sub==='cheques'&&<CRModLazy s={s} d={d}/>}
  {sub==='cafeteria'&&<CafeteriaModLazy s={s} d={d}/>}
  {sub==='plancafeteria'&&<CafeteriaModLazy s={s} d={d}/>}
  {sub==='cct90'&&<CCT90ModLazy s={s} d={d}/>}
  {sub==='cct90bonus'&&<CCT90ModLazy s={s} d={d}/>}
  {sub==='warrants'&&<WarrantsModLazy s={s} d={d}/>}
  {sub==='budgetmob'&&<BudgetMobiliteModLazy s={s} d={d}/>}
  {sub==='ecochequesv2'&&<CRModLazy s={s} d={d}/>}
  {sub==='notefraisv2'&&<NoteFraisModLazy s={s} d={d}/>}
</div>;}

function ContratsMenuPage({s,d}){const sub=s.sub||'contrats';const _subs=[{id:"contrats",l:"Contrats"},{id:"reglement",l:"Règlement"},{id:"preavis",l:"Préavis"},{id:"pecsortie",l:"Pécule sortie"}];return <div>
  <SubNav parentId="contratsmenu" parentLabel="Contrats" subs={_subs} activeSub={sub} d={d}/>
  {sub==='contrats'&&<ContratsTravailModLazy s={s} d={d}/>}
  {sub==='reglement'&&<ReglementTravailModLazy s={s} d={d}/>}
  {sub==='preavis'&&<PreavisModLazy s={s} d={d}/>}
  {sub==='pecsortie'&&<PeculeSortieModLazy s={s} d={d}/>}
</div>;}

function RHPage({s,d}){const sub=s.sub||'absences';const _subs=[{id:"wf_embauche",l:"Embauche"},{id:"wf_licenciement",l:"Licenciement"},{id:"wf_maladie",l:"Maladie"},{id:"absences",l:"Absences"},{id:"credittemps",l:"Crédit-temps"},{id:"pointage",l:"Pointage"},{id:"medtravail",l:"Médecine"}];return <div>
  <SubNav parentId="rh" parentLabel="RH & Workflows" subs={_subs} activeSub={sub} d={d}/>
  <PH title="RH & Personnel" sub={`Module: ${{'wf_embauche':'⚡ Workflow Embauche','wf_licenciement':'⚡ Workflow Licenciement','wf_maladie':'⚡ Workflow Maladie','absences':'Gestion absences',"absenteisme":'Analyse absentéisme',"credittemps":'Crédit-temps',"chomtemp":'Chômage temporaire',"congeduc":'Congé-éducation payé',"rcc":'RCC / Prépension',"outplacement":'Outplacement',"pointage":'Pointage & Portail Employeur',"planform":'Plan de formation',"medtravail":'Médecine du travail',"selfservice":'Portail travailleur',"promesseembauche":'📄 Promesse d\'Embauche'}[sub]||sub}`}/>
  {sub==='wf_embauche'&&<WorkflowEmbaucheModLazy s={s} d={d}/>}{sub==='wf_licenciement'&&<WorkflowLicenciementModLazy s={s} d={d}/>}{sub==='wf_maladie'&&<WorkflowMaladieModLazy s={s} d={d}/>}
  {sub==='absences'&&<AbsencesModLazy s={s} d={d}/>}{sub==='absenteisme'&&<AbsenteismeModLazy s={s} d={d}/>}
  {sub==='credittemps'&&<CreditTempsModLazy s={s} d={d}/>}{sub==='chomtemp'&&<ChomTempModLazy s={s} d={d}/>}
  {sub==='congeduc'&&<CongeEducModLazy s={s} d={d}/>}{sub==='rcc'&&<RCCModLazy s={s} d={d}/>}
  {sub==='outplacement'&&<OutplacementModLazy s={s} d={d}/>}{sub==='pointage'&&<PointageModLazy s={s} d={d}/>}
  {sub==='planform'&&<PlanFormationModLazy s={s} d={d}/>}{sub==='medtravail'&&<MedTravailModLazy s={s} d={d}/>}
  {sub==='selfservice'&&<SelfServiceModLazy s={s} d={d}/>}
  {sub==='onboarding'&&<OnboardingModLazy s={s} d={d}/>}
  {sub==='offboarding'&&<OffboardingModLazy s={s} d={d}/>}
  {sub==='registre'&&<RegistrePersonnelModLazy s={s} d={d}/>}
  {sub==='totalreward'&&<TotalRewardModLazy s={s} d={d}/>}
  {sub==='promesseembauche'&&<PromesseEmbaucheLazy s={s} d={d}/>}
</div>;}

function SocialPage({s,d}){const sub=s.sub||'assloi';const _subs=[{id:"assloi",l:"Ass. Loi"},{id:"assgroupe",l:"Ass. Groupe"},{id:"syndicales",l:"Syndicales"},{id:"allocfam",l:"Alloc. Fam."},{id:"aidesemploi",l:"Aides emploi"}];return <div>
  <SubNav parentId="social" parentLabel="Social" subs={_subs} activeSub={sub} d={d}/>
  {sub==='assloi'&&<AssLoiModLazy s={s} d={d}/>}
  {sub==='assgroupe'&&<AssGroupeModLazy s={s} d={d}/>}
  {sub==='syndicales'&&<SyndicalesModLazy s={s} d={d}/>}
  {sub==='allocfam'&&<AllocFamModLazy s={s} d={d}/>}
  {sub==='aidesemploi'&&<AidesEmploiModLazy s={s} d={d}/>}
</div>;}

function ReportingPage({s,d}){const sub=s.sub||'accounting';const _subs=[{id:"accounting",l:"Comptabilité"},{id:"bilanbnb",l:"Bilan BNB"},{id:"sepa",l:"SEPA"},{id:"envoi",l:"Envoi docs"},{id:"ged",l:"GED"}];return <div>
  <SubNav parentId="reporting" parentLabel="Reporting" subs={_subs} activeSub={sub} d={d}/>
  <PH title="Reporting & Export" sub={`Module: ${{'accounting':'Accounting Output',"bilanbnb":'Bilan Social BNB',"bilan":'Bilan Social',"statsins":'Statistiques INS',"sepa":'SEPA / Virements',"peppol":'PEPPOL e-Invoicing',"envoi":'Envoi documents',"exportimport":'Export / Import',"ged":'GED / Archivage'}[sub]||sub}`}/>
    <div style={{marginBottom:14,padding:'10px 14px',background:'linear-gradient(135deg,rgba(168,85,247,.06),rgba(168,85,247,.02))',border:'1px solid rgba(168,85,247,.1)',borderRadius:10,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
      <div style={{fontSize:11,color:'#888'}}>⚡ Exports auto: DmfA + SEPA + Belcotax en 1 clic</div>
      <div style={{display:'flex',gap:6}}>
        <button onClick={()=>{if(confirm('Générer DmfA ?')){generateDmfAXML(s.emps||[],Math.ceil((new Date().getMonth()+1)/3),new Date().getFullYear(),s.co);alert('✅ DmfA générée')}}} style={{padding:'6px 12px',borderRadius:8,border:'none',background:'#a855f7',color:'#fff',fontSize:11,cursor:'pointer',fontWeight:600}}>📊 DmfA</button>
        <button onClick={()=>{if(confirm('Générer SEPA ?')){generateSEPAXML(s.emps||[],s.co);alert('✅ SEPA généré')}}} style={{padding:'6px 12px',borderRadius:8,border:'none',background:'#22c55e',color:'#fff',fontSize:11,cursor:'pointer',fontWeight:600}}>💸 SEPA</button>
      </div>
    </div>
  {sub==='accounting'&&<AccountingOutputModLazy s={s} d={d}/>}{sub==='bilanbnb'&&<BilanSocialBNBModLazy s={s} d={d}/>}
  {sub==='bilan'&&<BilanSocialModLazy s={s} d={d}/>}{sub==='statsins'&&<StatsINSModLazy s={s} d={d}/>}
  {sub==='sepa'&&<SEPAModLazy s={s} d={d}/>}{sub==='peppol'&&<PeppolModLazy s={s} d={d}/>}{sub==='envoi'&&<EnvoiModLazy s={s} d={d}/>}
  {sub==='exportimport'&&<ExportImportModLazy s={s} d={d}/>}{sub==='ged'&&<GEDModLazy s={s} d={d}/>}
</div>;}

function LegalPage({s,d}){const sub=s.sub||"docsjuridiques";const _subs=[{id:"docsjuridiques",l:"Documents"},{id:"alertes",l:"Alertes"},{id:"secteurs",l:"Secteurs"},{id:"moteurlois",l:"Moteur Lois"}];return <div>
  <SubNav parentId="legal" parentLabel="Legal" subs={_subs} activeSub={sub} d={d}/>
  {sub==="docsjuridiques"&&<MoteurLoisBelges s={s} d={d}/>}
  {sub==="alertes"&&<AlertesLegalesModLazy s={s} d={d}/>}
  {sub==="secteurs"&&<SecteursModLazy s={s} d={d}/>}
  {sub==="moteurlois"&&<MoteurLoisBelges s={s} d={d}/>}
</div>;}

function ModulesProPage({s,d}){
  const sub=s.sub||'od';
  return <div>
    <PH title="Modules Pro" sub="47 modules — La Rolls Royce du secrétariat social"/>
    {sub==='od'&&<ODModLazy s={s} d={d}/>}
    {sub==='cheques'&&<CRModLazy s={s} d={d}/>}
    {sub==='envoi'&&<EnvoiModLazy s={s} d={d}/>}
    {sub==='drs'&&<DRSModLazy s={s} d={d}/>}
    {sub==='fiches_ext'&&<FichesModLazy s={s} d={d}/>}
    {sub==='pointage'&&<PointageModLazy s={s} d={d}/>}
    {sub==='syndicales'&&<SyndicalesModLazy s={s} d={d}/>}
    {sub==='onssapl'&&<ONSSAPLModLazy s={s} d={d}/>}
    {sub==='eta'&&<ETAModLazy s={s} d={d}/>}
    {sub==='exportimport'&&<ExportImportModLazy s={s} d={d}/>}
    {sub==='netbrut'&&<NetBrutModLazy s={s} d={d}/>}
    {sub==='decava'&&<DecavaModLazy s={s} d={d}/>}
    {sub==='bilan'&&<BilanSocialModLazy s={s} d={d}/>}
    {sub==='provisions'&&<ProvisionsModLazy s={s} d={d}/>}
    {sub==='cumuls'&&<CumulsModLazy s={s} d={d}/>}
    {sub==='saisies'&&<SaisiesModLazy s={s} d={d}/>}
    {sub==='rentes'&&<RentesModLazy s={s} d={d}/>}
    {sub==='assloi'&&<AssLoiModLazy s={s} d={d}/>}
    {sub==='assgroupe'&&<AssGroupeModLazy s={s} d={d}/>}
    {sub==='medtravail'&&<MedTravailModLazy s={s} d={d}/>}
    {sub==='allocfam'&&<AllocFamModLazy s={s} d={d}/>}
    {sub==='caissevac'&&<CaisseVacModLazy s={s} d={d}/>}
    {sub==='sepa'&&<SEPAModLazy s={s} d={d}/>}
    {sub==='secteurs'&&<SecteursModLazy s={s} d={d}/>}
    {sub==='reglement'&&<ReglementTravailModLazy s={s} d={d}/>}
    {sub==='contrats'&&<ContratsTravailModLazy s={s} d={d}/>}
    {sub==='compteindiv'&&<CompteIndividuelModLazy s={s} d={d}/>}
    {sub==='accounting'&&<AccountingOutputModLazy s={s} d={d}/>}
    {sub==='alertes'&&<AlertesLegalesModLazy s={s} d={d}/>}
    {sub==='bilanbnb'&&<BilanSocialBNBModLazy s={s} d={d}/>}
    {sub==='co2'&&<CO2ModLazy s={s} d={d}/>}
    {sub==='certpme'&&<CertPMEModLazy s={s} d={d}/>}
    {sub==='ecocmd'&&<EcoCommandeModLazy s={s} d={d}/>}
    {sub==='preavis'&&<PreavisModLazy s={s} d={d}/>}
    {sub==='pecsortie'&&<PeculeSortieModLazy s={s} d={d}/>}
    {sub==='credittemps'&&<CreditTempsModLazy s={s} d={d}/>}
    {sub==='absences'&&<AbsencesModLazy s={s} d={d}/>}
    {sub==='indexauto'&&<IndexAutoModLazy s={s} d={d}/>}
    {sub==='cafeteria'&&<CafeteriaModLazy s={s} d={d}/>}
    {sub==='cct90'&&<CCT90ModLazy s={s} d={d}/>}
    {sub==='budgetmob'&&<BudgetMobiliteModLazy s={s} d={d}/>}
    {sub==='statsins'&&<StatsINSModLazy s={s} d={d}/>}
    {sub==='warrants'&&<WarrantsModLazy s={s} d={d}/>}
    {sub==='planform'&&<PlanFormationModLazy s={s} d={d}/>}
    {sub==='ecocircul'&&<NoteFraisModLazy s={s} d={d}/>}
    {sub==='horsforfait'&&<HeuresSupModLazy s={s} d={d}/>}
    {sub==='peppol'&&<PeppolModLazy s={s} d={d}/>}
  </div>;
}






function calcQuotiteSaisissable(netMensuel,nbEnfantsCharge=0,isRemplacement=false,isPensionAlim=false){
  // Pension alimentaire = saisissable en TOTALITÉ (art. 1412 CJ)
  if(isPensionAlim)return{saisissable:netMensuel,protege:0,tranches:[],enfantImmun:0,note:"Créance alimentaire: saisissable en totalité (art. 1412 CJ)"};
  const bareme=isRemplacement?SAISIE_2026_REMPLACEMENT:SAISIE_2026_TRAVAIL;
  let totalSaisissable=0;const tranches=[];
  for(const t of bareme){
    if(netMensuel<=t.min)break;
    const dansLaTranche=Math.min(netMensuel,t.max)-t.min;
    if(dansLaTranche<=0)continue;
    const retenue=+(dansLaTranche*t.pct/100).toFixed(2);
    tranches.push({min:t.min,max:Math.min(t.max,netMensuel),pct:t.pct,montantTranche:+dansLaTranche.toFixed(2),retenue,label:t.label});
    totalSaisissable+=retenue;
  }
  // Immunisation enfants à charge
  const enfantImmun=nbEnfantsCharge*SAISIE_IMMUN_ENFANT_2026;
  const saisissable=Math.max(0,+(totalSaisissable-enfantImmun).toFixed(2));
  const protege=+(netMensuel-saisissable).toFixed(2);
  return{saisissable,protege,tranches,enfantImmun,totalAvantImmun:+totalSaisissable.toFixed(2),note:null};
}

function calcAllocEnfant(region,birthYear,age){
  const reg=AF_REGIONS[region];if(!reg)return 0;
  const isNew=birthYear>=reg.cutoff;
  if(isNew){
    const tranche=reg.base.find(t=>age>=t.age&&age<=t.to);
    return tranche?tranche.amt:0;
  } else {
    if(region==='BXL'){
      const tranche=reg.base.find(t=>age>=t.age&&age<=t.to);
      return tranche?Math.max(tranche.amt-(reg.ancienReduction||0),0):0;
    }
    return reg.ancien?reg.ancien.rang1:0;
  }
}




// ═══════════════════════════════════════════════════════════════
//  SECTEURS SPÉCIFIQUES (Hôpitaux, Construction, Ateliers, IMP)
// ═══════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════
//  ACCOUNTING OUTPUT — Récapitulatif comptable pour le comptable
// ═══════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════
//  WORKFLOW EMBAUCHE — Checklist complète onboarding
// ═══════════════════════════════════════════════════════════════
function exportSimulation(){var sb=document.getElementById("sb");if(sb)sb.style.display="none";var el=document.querySelector("main")||document.body;var w=window.open("","_blank");w.document.write("<html><head><title>Aureus Social Pro</title><style>body{font-family:Arial,sans-serif;padding:30px;max-width:900px;margin:auto;color:#1a1a1a}h1,h2,h3{color:#c6a34e}table{width:100%;border-collapse:collapse;margin:10px 0}td,th{padding:6px 10px;border:1px solid #e5e5e5;font-size:12px}</style></head><body>"+el.innerHTML+"</body></html>");w.document.close();w.print();if(sb)sb.style.display="";}function emailSimulation(t,e){if(e){window.location.href="mailto:"+e+"?subject="+encodeURIComponent(t);}}
function sendSimulationPDF(simData,clientEmail){var d=simData||{};var brut=+(d.brut||0);var onssP=Math.round(brut*TX_ONSS_E*100)/100;var assAT=Math.round(brut*TX_AT*100)/100;var med=COUT_MED;var cr=+(d.cheqRepas||130.02);var coutMens=Math.round((brut+onssP+assAT+med+cr)*100)/100;var nb=+(d.nb||1);var dur=+(d.duree||12);var coutTotal=Math.round(coutMens*nb*100)/100;var coutAn=Math.round(coutMens*nb*dur*100)/100;var onssE=Math.round(brut*TX_ONSS_W*100)/100;var imp=brut-onssE;var pp=quickPP(brut);var net=Math.round((brut-onssE-pp)*100)/100;var ratio=brut>0?Math.round(net/coutMens*100):0;var f2=function(v){return new Intl.NumberFormat("fr-BE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0)};var coName=d.coName||"Aureus IA SPRL";var html="<!DOCTYPE html><html><head><meta charset=utf-8><title>Simulation cout salarial</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:11px;padding:30px;max-width:800px;margin:auto;color:#1a1a1a}h1{font-size:18px;color:#c6a34e;margin-bottom:5px}h2{font-size:13px;color:#333;margin:15px 0 8px;border-bottom:1px solid #e5e5e5;padding-bottom:4px}table{width:100%;border-collapse:collapse;margin:8px 0}td{padding:5px 8px;font-size:11px}td:last-child{text-align:right;font-family:monospace;font-weight:600}.kpi{display:flex;gap:15px;margin:12px 0;flex-wrap:wrap}.kpi-box{flex:1;min-width:140px;background:#f8f7f4;border:1px solid #e5e2d9;border-radius:6px;padding:10px;text-align:center}.kpi-val{font-size:16px;font-weight:700;color:#c6a34e}.kpi-lab{font-size:9px;color:#666;margin-top:2px}.total td{font-weight:700;border-top:2px solid #c6a34e;padding-top:8px}.foot{margin-top:25px;font-size:9px;color:#999;text-align:center}@media print{button{display:none!important}}</style></head><body><h1>"+coName+"</h1><p style=font-size:10px;color:#666>Simulation cout salarial - "+new Date().toLocaleDateString("fr-BE")+"</p><div class=kpi><div class=kpi-box><div class=kpi-val>"+f2(brut)+" EUR</div><div class=kpi-lab>Brut mensuel</div></div><div class=kpi-box><div class=kpi-val>"+f2(coutMens)+" EUR</div><div class=kpi-lab>Cout mensuel/pers.</div></div><div class=kpi-box><div class=kpi-val>"+f2(coutAn)+" EUR</div><div class=kpi-lab>Cout sur "+dur+" mois</div></div><div class=kpi-box><div class=kpi-val>"+ratio+"%</div><div class=kpi-lab>Ratio net/cout</div></div></div><h2>Decomposition cout employeur</h2><table><tr><td>Salaire brut</td><td>"+f2(brut)+" EUR</td></tr><tr><td>ONSS patronal 25,07%</td><td>"+f2(onssP)+" EUR</td></tr><tr><td>Assurance AT 1%</td><td>"+f2(assAT)+" EUR</td></tr><tr><td>Medecine travail</td><td>"+f2(med)+" EUR</td></tr><tr><td>Cheques-repas</td><td>"+f2(cr)+" EUR</td></tr><tr class=total><td>COUT / personne</td><td>"+f2(coutMens)+" EUR</td></tr><tr><td>COUT TOTAL "+nb+" pers.</td><td>"+f2(coutTotal)+" EUR</td></tr></table><h2>Net employe</h2><table><tr><td>Brut</td><td>"+f2(brut)+"</td></tr><tr><td>ONSS -13,07%</td><td>-"+f2(onssE)+"</td></tr><tr><td>PP</td><td>-"+f2(pp)+"</td></tr><tr class=total><td>Net</td><td>"+f2(net)+" EUR</td></tr></table><div class=foot>Aureus Social Pro - aureussocial.be</div><button onclick=window.print() style=display:block;margin:15px_auto;background:#c6a34e;color:#fff;border:none;padding:10px_30px;border-radius:6px;cursor:pointer>Imprimer</button></body></html>";var blob=new Blob([html],{type:"text/html;charset=utf-8"});previewHTML(html,'Simulation_'+brut+'EUR');if(clientEmail){var subject=encodeURIComponent("Simulation cout salarial - "+f2(brut)+" EUR");var body=encodeURIComponent("Bonjour,\n\nSimulation:\n- Brut: "+f2(brut)+" EUR\n- Cout employeur: "+f2(coutMens)+" EUR/mois\n- Net estime: "+f2(net)+" EUR\n- Ratio: "+ratio+"%\n\nCordialement,\n"+coName);setTimeout(function(){window.location.href="mailto:"+clientEmail+"?subject="+subject+"&body="+body},600)}}
function generateAttestationEmploi(emp,co){var coName=co?.name||"Aureus IA SPRL";var coVAT=co?.vat||"BE 1028.230.781";var name=(emp.first||emp.fn||"")+" "+(emp.last||emp.ln||"");var f2=function(v){return new Intl.NumberFormat("fr-BE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0)};var html="<!DOCTYPE html><html><head><meta charset=utf-8><title>Attestation "+name+"</title><style>*{margin:0;padding:0}body{font-family:Arial,sans-serif;font-size:12px;padding:40px;max-width:800px;margin:auto;line-height:1.6}@media print{button{display:none!important}}</style></head><body><h2 style=text-align:center;text-decoration:underline;margin:20px>ATTESTATION D EMPLOI</h2><p>"+coName+" ("+coVAT+") atteste que <b>"+escapeHtml(name)+"</b> (NISS: "+(emp.niss||"N/A")+") est employe(e) depuis le <b>"+(emp.startDate||emp.start||"N/A")+"</b> en qualite de <b>"+(emp.function||emp.job||"employe")+"</b>. Contrat: "+(emp.contractType||"CDI")+" - "+(emp.whWeek||38)+"h/sem. Brut: "+f2(+(emp.monthlySalary||emp.gross||0))+" EUR/mois.</p><p>Pour servir et valoir ce que de droit.</p><div style=text-align:center;margin-top:20px><button onclick=window.print()>Imprimer</button></div></body></html>";var blob=new Blob([html],{type:"text/html;charset=utf-8"});previewHTML(html,'Attestation_emploi_'+name);}
function generateAttestationSalaire(emp,co){var coName=co?.name||"Aureus IA SPRL";var name=(emp.first||emp.fn||"")+" "+(emp.last||emp.ln||"");var brut=+(emp.monthlySalary||emp.gross||0);var onss=Math.round(brut*TX_ONSS_W*100)/100;var pp=quickPP(brut);var net=Math.round((brut-onss-pp)*100)/100;var f2=function(v){return new Intl.NumberFormat("fr-BE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0)};var html="<!DOCTYPE html><html><head><meta charset=utf-8><style>*{margin:0;padding:0}body{font-family:Arial,sans-serif;font-size:12px;padding:40px;max-width:800px;margin:auto}table{width:100%;border-collapse:collapse;margin:15px 0}th,td{padding:6px 10px;border:1px solid #ccc}@media print{button{display:none!important}}</style></head><body><h2 style=text-align:center;text-decoration:underline>ATTESTATION DE REMUNERATION</h2><p>"+coName+" certifie que <b>"+escapeHtml(name)+"</b> percoit:</p><table><tr><th>Element</th><th>Mensuel</th><th>Annuel</th></tr><tr><td>Brut</td><td>"+f2(brut)+"</td><td>"+f2(brut*12)+"</td></tr><tr><td>ONSS</td><td>-"+f2(onss)+"</td><td>-"+f2(onss*12)+"</td></tr><tr><td>PP</td><td>-"+f2(pp)+"</td><td>-"+f2(pp*12)+"</td></tr><tr style=font-weight:700><td>Net</td><td>"+f2(net)+"</td><td>"+f2(net*12)+"</td></tr></table><div style=text-align:center;margin-top:20px><button onclick=window.print()>Imprimer</button></div></body></html>";var blob=new Blob([html],{type:"text/html;charset=utf-8"});previewHTML(html,'Attestation_salaire_'+name);}
function generateSoldeCompte(emp,co){var coName=co?.name||"Aureus IA SPRL";var name=(emp.first||emp.fn||"")+" "+(emp.last||emp.ln||"");var brut=+(emp.monthlySalary||emp.gross||0);var f2=function(v){return new Intl.NumberFormat("fr-BE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0)};var pro=Math.round(brut*15/22*100)/100;var pec=Math.round(brut*PV_SIMPLE*100)/100;var pre=brut;var tot=pro+pec+pre;var onss=Math.round(tot*TX_ONSS_W*100)/100;var pp=quickPP(tot);var net=Math.round((tot-onss-pp)*100)/100;var html="<!DOCTYPE html><html><head><meta charset=utf-8><style>*{margin:0;padding:0}body{font-family:Arial,sans-serif;font-size:12px;padding:40px;max-width:800px;margin:auto}table{width:100%;border-collapse:collapse;margin:15px 0}th,td{padding:6px 10px;border:1px solid #ccc}@media print{button{display:none!important}}</style></head><body><h2 style=text-align:center;text-decoration:underline>SOLDE DE TOUT COMPTE</h2><p>"+coName+" - Travailleur: <b>"+escapeHtml(name)+"</b></p><table><tr><th>Element</th><th>Montant</th></tr><tr><td>Prorata</td><td>"+f2(pro)+"</td></tr><tr><td>Pecule sortie</td><td>"+f2(pec)+"</td></tr><tr><td>Préavis</td><td>"+f2(pre)+"</td></tr><tr style=font-weight:700><td>Total brut</td><td>"+f2(tot)+"</td></tr><tr><td>ONSS</td><td>-"+f2(onss)+"</td></tr><tr><td>PP</td><td>-"+f2(pp)+"</td></tr><tr style=font-weight:700><td>NET</td><td>"+f2(net)+"</td></tr></table><p>Pour solde de tout compte.</p><div style=text-align:center;margin-top:20px><button onclick=window.print()>Imprimer</button></div></body></html>";var blob=new Blob([html],{type:"text/html;charset=utf-8"});previewHTML(html,'Solde_'+name);}
function getAlertes(emps,co){
  const now=new Date();const alerts=[];
  emps.forEach(e=>{
    const name=(e.first||e.fn||'')+" "+(e.last||e.ln||'');
    if(e.contractEnd||e.endDate){const end=new Date(e.contractEnd||e.endDate);const diff=Math.ceil((end-now)/(1000*60*60*24));if(diff>0&&diff<=30)alerts.push({type:"cdd",level:"warning",icon:"📋",msg:"CDD "+name+" expire dans "+diff+" jours ("+end.toLocaleDateString("fr-BE")+")",days:diff});if(diff<=0&&diff>-7)alerts.push({type:"cdd",level:"danger",icon:"🚨",msg:"CDD "+name+" EXPIRE! ("+end.toLocaleDateString("fr-BE")+")",days:diff});}
    if(e.lastMedical||e.medicalDate){const med=new Date(e.lastMedical||e.medicalDate);const diff=Math.ceil((now-med)/(1000*60*60*24));if(diff>335)alerts.push({type:"medical",level:diff>365?"danger":"warning",icon:"🏥",msg:"Visite medicale "+name+" : "+(diff>365?"DEPASSEE":"dans "+(365-diff)+"j")+" (derniere: "+med.toLocaleDateString("fr-BE")+")",days:diff});}
    if(e.startDate||e.start){const start=new Date(e.startDate||e.start);const diff=Math.ceil((now-start)/(1000*60*60*24));if(diff>=0&&diff<=7)alerts.push({type:"onboard",level:"info",icon:"👋",msg:"Nouvel employe "+name+" - onboarding en cours (J+"+diff+")",days:diff});}
    if(!e.niss&&(e.status==="active"||!e.status))alerts.push({type:"niss",level:"danger",icon:"⚠️",msg:"NISS manquant pour "+name,days:0});
    if(!e.iban&&(e.status==="active"||!e.status))alerts.push({type:"iban",level:"warning",icon:"🏦",msg:"IBAN manquant pour "+name,days:0});
    if(e.status==="active"||!e.status){const brut=+(e.monthlySalary||e.gross||0);if(brut>0&&brut<2029.88)alerts.push({type:"rmmmg",level:"warning",icon:"💰",msg:name+" sous le RMMMG ("+brut.toFixed(2)+" < 2.029,88 EUR)",days:0});}
  });
  const d=now.getDate();const m=now.getMonth()+1;
  if(d<=5)alerts.push({type:"deadline",level:"info",icon:"📅",msg:"Avant le 5: encodage prestations du mois",days:5-d});
  if(m===1||m===4||m===7||m===10){if(d<=15)alerts.push({type:"deadline",level:"warning",icon:"📤",msg:"Trimestre: DmfA a envoyer avant le "+((m===1||m===7)?31:30)+"/"+String(m).padStart(2,"0"),days:15-d});}
  return alerts.sort((a,b)=>a.level==="danger"?-1:b.level==="danger"?1:a.level==="warning"?-1:1);
}
function generateBelcotaxXML(emps,year,co){var coName=co?.name||"Aureus IA SPRL";var coVAT=(co?.vat||"1028230781").replace(/[^0-9]/g,"");var ae=emps.filter(function(e){return e.status==="active"||!e.status});var f2=function(v){return(Math.round(v*100)/100).toFixed(2)};var fiches=ae.map(function(e,i){var brut=+(e.monthlySalary||e.gross||0)*12;var onss=Math.round(brut*TX_ONSS_W*100)/100;var imp=brut-onss;var pp=quickPP(brut/12)*12;var net=Math.round((brut-onss-pp)*100)/100;var niss=(e.niss||"").replace(/[^0-9]/g,"");return"<Fiche281_10 seq=\""+(i+1)+"\"><Worker><INSS>"+niss+"</INSS><Name>"+(e.first||e.fn||"")+" "+(e.last||e.ln||"")+"</Name></Worker><Income><GrossRemuneration>"+f2(brut)+"</GrossRemuneration><SocialContributions>"+f2(onss)+"</SocialContributions><TaxableIncome>"+f2(imp)+"</TaxableIncome><WithholdingTax>"+f2(pp)+"</WithholdingTax><NetRemuneration>"+f2(net)+"</NetRemuneration></Income></Fiche281_10>"}).join("");var xml="<?xml version=\"1.0\" encoding=\"UTF-8\"?><Belcotax><Declarant><CompanyID>"+coVAT+"</CompanyID><Name>"+coName+"</Name><TaxYear>"+(year||2025)+"</TaxYear><IncomeYear>"+((year||2025)-1)+"</IncomeYear><NbFiches>"+ae.length+"</NbFiches></Declarant>"+fiches+"</Belcotax>";var blob=new Blob([xml],{type:"application/octet-stream"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="Belcotax_281_10_"+(year||2025)+".xml";document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);}
function generateDmfAXML(emps,trimestre,year,co){var coName=co?.name||"Aureus IA SPRL";var coVAT=(co?.vat||"1028230781").replace(/[^0-9]/g,"");var ae=emps.filter(function(e){return e.status==="active"||!e.status});var f2=function(v){return(Math.round(v*100)/100).toFixed(2)};var totalBrut=ae.reduce(function(a,e){return a+(+(e.monthlySalary||e.gross||0))*3},0);var totalONSS=Math.round(totalBrut*(TX_ONSS_W+TX_ONSS_E)*100)/100;var workers=ae.map(function(e){var brut3=(+(e.monthlySalary||e.gross||0))*3;var onss=Math.round(brut3*TX_ONSS_W*100)/100;var onssE=Math.round(brut3*TX_ONSS_E*100)/100;return"<WorkerRecord><INSS>"+(e.niss||"").replace(/[^0-9]/g,"")+"</INSS><Name>"+(e.first||e.fn||"")+" "+(e.last||e.ln||"")+"</Name><Category>"+(e.statut==="ouvrier"?"BC":"WC")+"</Category><JointCommittee>"+(e.cp||co?.cp||"200")+"</JointCommittee><GrossQuarter>"+f2(brut3)+"</GrossQuarter><WorkerONSS>"+f2(onss)+"</WorkerONSS><EmployerONSS>"+f2(onssE)+"</EmployerONSS></WorkerRecord>"}).join("");var xml="<?xml version=\"1.0\" encoding=\"UTF-8\"?><DmfAMessage><Header><Sender><CompanyID>"+coVAT+"</CompanyID><Name>"+coName+"</Name></Sender><Reference>DMFA-"+(year||2026)+"-Q"+(trimestre||1)+"</Reference><Quarter>"+(trimestre||1)+"</Quarter><Year>"+(year||2026)+"</Year></Header><Employer><CompanyID>"+coVAT+"</CompanyID><Name>"+coName+"</Name><NbWorkers>"+ae.length+"</NbWorkers><TotalGross>"+f2(totalBrut)+"</TotalGross><TotalONSS>"+f2(totalONSS)+"</TotalONSS>"+workers+"</Employer><Footer><TotalDue>"+f2(totalONSS)+"</TotalDue></Footer></DmfAMessage>";var blob=new Blob([xml],{type:"application/octet-stream"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="DmfA_Q"+(trimestre||1)+"_"+(year||2026)+".xml";document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);}
function generateC4PDF(emp,co){const coName=co?.name||"Aureus IA SPRL";const coVAT=co?.vat||"BE 1028.230.781";const name=(emp.first||emp.fn||"")+" "+(emp.last||emp.ln||"");const niss=emp.niss||"";const start=emp.startDate||emp.start||"";const end=emp.endDate||emp.contractEnd||new Date().toISOString().slice(0,10);const brut=+(emp.monthlySalary||emp.gross||0);const f2=v=>new Intl.NumberFormat("fr-BE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);const html="<!DOCTYPE html><html><head><meta charset=utf-8><title>C4 - "+name+"</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:11px;padding:30px;max-width:800px;margin:auto}.header{text-align:center;border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:15px}.title{font-size:16px;font-weight:700}.section{margin:10px 0;padding:8px;border:1px solid #ccc}.section-title{font-weight:700;font-size:12px;margin-bottom:6px;text-decoration:underline}.row{display:flex;justify-content:space-between;margin:3px 0;font-size:10px}.signature{margin-top:40px;display:flex;justify-content:space-between}.sig-box{width:45%;border-top:1px solid #000;padding-top:5px;text-align:center;font-size:10px}@media print{button{display:none!important}}</style></head><body><div class=header><div class=title>CERTIFICAT DE CHOMAGE C4</div><div>Formulaire C4</div></div><div class=section><div class=section-title>1. Employeur</div><div class=row><span>Denomination:</span><span>"+coName+"</span></div><div class=row><span>BCE/TVA:</span><span>"+coVAT+"</span></div><div class=row><span>CP:</span><span>"+(emp.cp||co?.cp||"200")+"</span></div></div><div class=section><div class=section-title>2. Travailleur</div><div class=row><span>Nom:</span><span>"+name+"</span></div><div class=row><span>NISS:</span><span>"+niss+"</span></div><div class=row><span>Statut:</span><span>"+(emp.statut||"Employe")+"</span></div></div><div class=section><div class=section-title>3. Occupation</div><div class=row><span>Debut:</span><span>"+start+"</span></div><div class=row><span>Fin:</span><span>"+end+"</span></div><div class=row><span>Regime:</span><span>"+(emp.whWeek||38)+"h/sem</span></div><div class=row><span>Brut:</span><span>"+f2(brut)+" EUR/mois</span></div></div><div class=section><div class=section-title>4. Motif</div><div class=row><span>Motif:</span><span>"+(emp.endReason||"Fin de contrat")+"</span></div><div class=row><span>Initiative:</span><span>"+(emp.endInitiative||"Employeur")+"</span></div></div><div class=signature><div class=sig-box>Signature employeur</div><div class=sig-box>Signature travailleur</div></div><div style=text-align:center;margin-top:20px><button onclick=window.print() style=background:#333;color:#fff;border:none;padding:10px_30px;border-radius:6px;cursor:pointer>Imprimer C4</button></div></body></html>";const blob=new Blob([html],{type:"text/html;charset=utf-8"});previewHTML(html,'C4_'+name);}
function generateSEPAXML(emps,period,co){var coName=co?.name||"Aureus IA SPRL";var coIBAN=co?.iban||"BE00000000000000";var coBIC=co?.bic||"GEBABEBB";var coVAT=(co?.vat||"BE1028230781").replace(/[^A-Z0-9]/g,"");var now=new Date();var msgId="SEPA-"+now.toISOString().replace(/[^0-9]/g,"").slice(0,14);var pmtId="PAY-"+(period?.month||now.getMonth()+1)+"-"+(period?.year||now.getFullYear());var mois=["Janvier","Fevrier","Mars","Avril","Mai","Juin","Juillet","Aout","Septembre","Octobre","Novembre","Decembre"];var periodeStr=(mois[(period?.month||1)-1]||"")+" "+(period?.year||2026);var ae=emps.filter(function(e){return(e.status==="active"||!e.status)&&e.iban});var payments=ae.map(function(e){var brut=+(e.monthlySalary||e.gross||0);var onss=Math.round(brut*TX_ONSS_W*100)/100;var imp=brut-onss;var pp=quickPP(brut);var net=Math.round((brut-onss-pp)*100)/100;return{name:(e.first||e.fn||"")+" "+(e.last||e.ln||""),iban:(e.iban||"").replace(/\s/g,""),bic:e.bic||"GEBABEBB",amount:net,ref:"SAL/"+pmtId+"/"+(e.id||"").slice(0,8)}}).filter(function(p){return p.amount>0});var totalAmount=payments.reduce(function(a,p){return a+p.amount},0);var f2=function(v){return(Math.round(v*100)/100).toFixed(2)};var txns=payments.map(function(p){return"<CdtTrfTxInf><PmtId><EndToEndId>"+p.ref+"</EndToEndId></PmtId><Amt><InstdAmt Ccy=\"EUR\">"+f2(p.amount)+"</InstdAmt></Amt><CdtrAgt><FinInstnId><BIC>"+p.bic+"</BIC></FinInstnId></CdtrAgt><Cdtr><Nm>"+p.name+"</Nm></Cdtr><CdtrAcct><Id><IBAN>"+p.iban+"</IBAN></Id></CdtrAcct><RmtInf><Ustrd>Salaire "+periodeStr+"</Ustrd></RmtInf></CdtTrfTxInf>"}).join("");var xml="<?xml version=\"1.0\" encoding=\"UTF-8\"?><Document xmlns=\"urn:iso:std:iso:20022:tech:xsd:pain.001.001.03\"><CstmrCdtTrfInitn><GrpHdr><MsgId>"+msgId+"</MsgId><CreDtTm>"+now.toISOString()+"</CreDtTm><NbOfTxs>"+payments.length+"</NbOfTxs><CtrlSum>"+f2(totalAmount)+"</CtrlSum><InitgPty><Nm>"+coName+"</Nm></InitgPty></GrpHdr><PmtInf><PmtInfId>"+pmtId+"</PmtInfId><PmtMtd>TRF</PmtMtd><NbOfTxs>"+payments.length+"</NbOfTxs><CtrlSum>"+f2(totalAmount)+"</CtrlSum><PmtTpInf><SvcLvl><Cd>SEPA</Cd></SvcLvl></PmtTpInf><ReqdExctnDt>"+now.toISOString().slice(0,10)+"</ReqdExctnDt><Dbtr><Nm>"+coName+"</Nm></Dbtr><DbtrAcct><Id><IBAN>"+coIBAN+"</IBAN></Id></DbtrAcct><DbtrAgt><FinInstnId><BIC>"+coBIC+"</BIC></FinInstnId></DbtrAgt><ChrgBr>SLEV</ChrgBr>"+txns+"</PmtInf></CstmrCdtTrfInitn></Document>";var blob=new Blob([xml],{type:"application/octet-stream"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="SEPA_Salaires_"+periodeStr.replace(/ /g,"_")+".xml";document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);}
function generateDimonaXML(emp,type,co){
  const coVAT=(co?.vat||'1028230781').replace(/[^0-9]/g,'');
  const empName=(emp.first||emp.fn||'')+" "+(emp.last||emp.ln||'');
  const niss=(emp.niss||emp.NISS||'').replace(/[^0-9]/g,'');
  const startD=(emp.startDate||emp.start||new Date().toISOString().slice(0,10)).replace(/-/g,'');
  const endD=(emp.endDate||emp.end||'').replace(/-/g,'')||startD;
  const now=new Date();
  const ts=now.toISOString().replace(/[-:T]/g,'').slice(0,14);
  const refNum='DIM'+ts+Math.floor(Math.random()*9999).toString().padStart(4,'0');
  const xml=`<?xml version="1.0" encoding="UTF-8"?>
<DIMONAMessage xmlns="http://www.smals-mvm.be/xml/ns/dimona" version="20240101">
  <Header>
    <Sender>
      <CompanyID origin="KBO">${coVAT}</CompanyID>
      <Name>${co?.name||'Aureus IA SPRL'}</Name>
    </Sender>
    <Reference>${refNum}</Reference>
    <CreationDate>${now.toISOString().slice(0,10)}</CreationDate>
    <CreationTime>${now.toTimeString().slice(0,8)}</CreationTime>
  </Header>
  <Declaration>
    <DeclarationType>${type==='OUT'?'DIMONAOUT':'DIMONAIN'}</DeclarationType>
    <Employer>
      <CompanyID origin="KBO">${coVAT}</CompanyID>
      <NOSS>${coVAT.slice(0,10)}</NOSS>
      <Name>${co?.name||'Aureus IA SPRL'}</Name>
      <JointCommittee>${emp.cp||co?.cp||'200'}</JointCommittee>
    </Employer>
    <Worker>
      <INSS>${niss}</INSS>
      <LastName>${emp.last||emp.ln||''}</LastName>
      <FirstName>${emp.first||emp.fn||''}</FirstName>
      <WorkerType>${emp.statut==='ouvrier'?'BC':'WC'}</WorkerType>
    </Worker>
    <EmploymentDetail>
      <StartDate>${startD}</StartDate>
      ${type==='OUT'?`<EndDate>${endD}</EndDate>
      <EndReason>${emp.endReason||'CONTRACT_END'}</EndReason>`:''}
      <WorkerCategory>${emp.category||'1'}</WorkerCategory>
      <JointCommittee>${emp.cp||co?.cp||'200'}</JointCommittee>
      <PlannedHoursPerWeek>${emp.whWeek||emp.regime||38}</PlannedHoursPerWeek>
      <ReferenceHoursPerWeek>38</ReferenceHoursPerWeek>
    </EmploymentDetail>
  </Declaration>
  <Footer>
    <TotalDeclarations>1</TotalDeclarations>
  </Footer>
</DIMONAMessage>`;
  const blob=new Blob([xml],{type:'application/octet-stream'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='DIMONA_'+type+'_'+empName.replace(/ /g,'_')+'_'+now.toISOString().slice(0,10)+'.xml';
  document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},3000);
  return{ref:refNum,xml};
}

async function generatePayslipPDF(emp,r,period,co){
  try{
  // Détection d'arguments décalés: generatePayslipPDF(emp,co) au lieu de (emp,r,period,co)
  if(r&&(r.name||r.vat)&&!period&&!co){co=r;r=null;period=null;}
  if(!r){const brut=+(emp.monthlySalary||emp.gross||0);r=typeof calc==='function'?calc(emp,{},co||{}):({brut,gross:brut,onssP:Math.round(brut*TX_ONSS_W*100)/100,pp:quickPP(brut),net:quickNet(brut),onssE:Math.round(brut*TX_ONSS_E*100)/100,coutTotal:Math.round(brut*(1+TX_ONSS_E)*100)/100});}
  if(!period){const d=new Date();period={month:d.getMonth()+1,year:d.getFullYear()};}
  const _payslipHTML=[];const w={document:{write:function(h){_payslipHTML.push(h)},close:function(){try{const html=_payslipHTML.join('');if(!html||html.length<100){alert('Erreur: HTML vide');return;}
  previewHTML(html, 'Fiche_paie_'+empName);
  }catch(err){alert('Erreur download: '+err.message);}}}};
  const coName=co?.name||'Entreprise';
  const coVAT=co?.vat||'BE XXXX.XXX.XXX';
  const coAddr=co?.address||'';
  const coCP=co?.cp||'CP 200';
  const empName=(emp.first||emp.fn||'')+" "+(emp.last||emp.ln||'');
  const empNISS=emp.niss||emp.NISS||'XX.XX.XX-XXX.XX';
  const empIBAN=emp.iban||emp.IBAN||'';
  const mois=["Janvier","Fevrier","Mars","Avril","Mai","Juin","Juillet","Aout","Septembre","Octobre","Novembre","Decembre"];
  const periodeStr=period?(mois[(period.month||1)-1]||"")+" "+(period.year||2026):"Fevrier 2026";
  const brut=r.gross||r.brut||0;
  const onssP=r.onssP||r.onss||Math.round(brut*TX_ONSS_W*100)/100;
  const imposable=r.imposable||Math.round((brut-onssP)*100)/100;
  const pp=r.pp||r.withholding||Math.round(imposable*PP_EST*100)/100;
  const csss=r.csss||r.specSS||0;
  const net=r.net||Math.round((brut-onssP-pp-csss)*100)/100;
  const onssE=r.onssE||r.empSS||Math.round(brut*TX_ONSS_E*100)/100;
  const coutTotal=r.coutTotal||Math.round((brut+onssE)*100)/100;
  const mealV=r.mealV||(emp.mealVoucher?emp.mealVoucher*22:0);
  const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
  w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Fiche de paie - ${empName} - ${periodeStr}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;font-size:11px;color:#1a1a1a;padding:30px;max-width:800px;margin:auto;background:#fff}
.header{display:flex;justify-content:space-between;border-bottom:3px solid #c6a34e;padding-bottom:15px;margin-bottom:15px}
.header-left{flex:1}
.header-right{text-align:right;flex:1}
.company{font-size:16px;font-weight:700;color:#1a1a1a}
.subtitle{font-size:10px;color:#666;margin-top:2px}
.gold{color:#c6a34e}
.period-badge{display:inline-block;background:#c6a34e;color:#fff;padding:4px 12px;border-radius:4px;font-weight:700;font-size:12px}
.section{margin:12px 0}
.section-title{font-size:11px;font-weight:700;color:#c6a34e;text-transform:uppercase;letter-spacing:1px;padding:4px 0;border-bottom:1px solid #e5e5e5;margin-bottom:6px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 20px}
.info-row{display:flex;justify-content:space-between;font-size:10px}
.info-label{color:#666}
.info-value{font-weight:600}
table{width:100%;border-collapse:collapse;margin:6px 0}
th{text-align:left;font-size:9px;text-transform:uppercase;color:#666;padding:4px 6px;border-bottom:2px solid #e5e5e5;letter-spacing:0.5px}
th.right{text-align:right}
td{padding:4px 6px;border-bottom:1px solid #f0f0f0;font-size:10px}
td.right{text-align:right;font-family:'Courier New',monospace}
td.bold{font-weight:700}
.total-row{background:#f8f6f0;font-weight:700}
.total-row td{border-top:2px solid #c6a34e;border-bottom:2px solid #c6a34e;padding:6px}
.net-row{background:#c6a34e;color:#fff;font-weight:800;font-size:12px}
.net-row td{padding:8px 6px;border:none}
.footer{margin-top:20px;padding-top:10px;border-top:1px solid #e5e5e5;display:flex;justify-content:space-between;font-size:9px;color:#999}
.employer-box{margin-top:12px;padding:8px;background:#fafafa;border:1px solid #e5e5e5;border-radius:4px}
.employer-box .title{font-size:9px;color:#c6a34e;font-weight:700;text-transform:uppercase;margin-bottom:4px}
@media print{body{padding:20px}button{display:none!important}}
</style></head><body>
<div class="header">
  <div class="header-left">
    <div class="company">${coName}</div>
    <div class="subtitle">${coVAT} | ${coCP}</div>
    <div class="subtitle">${coAddr}</div>
  </div>
  <div class="header-right">
    <div class="period-badge">${periodeStr}</div>
    <div style="margin-top:6px;font-size:10px;color:#666">FICHE DE PAIE</div>
    <div style="font-size:9px;color:#999">Document confidentiel</div>
  </div>
</div>
<div class="section">
  <div class="section-title">Identification travailleur</div>
  <div class="info-grid">
    <div class="info-row"><span class="info-label">Nom:</span><span class="info-value">${empName}</span></div>
    <div class="info-row"><span class="info-label">NISS:</span><span class="info-value">${empNISS}</span></div>
    <div class="info-row"><span class="info-label">Fonction:</span><span class="info-value">${emp.function||emp.job||'Employé'}</span></div>
    <div class="info-row"><span class="info-label">Statut:</span><span class="info-value">${emp.statut||'Employé'}</span></div>
    <div class="info-row"><span class="info-label">Entree:</span><span class="info-value">${emp.startDate||emp.start||'-'}</span></div>
    <div class="info-row"><span class="info-label">Regime:</span><span class="info-value">${emp.regime||emp.whWeek||38}h/sem</span></div>
  </div>
</div>
<div class="section">
  <div class="section-title">Remuneration brute</div>
  <table>
    <tr><th>Description</th><th class="right">Jours/Heures</th><th class="right">Taux</th><th class="right">Montant</th></tr>
    <tr><td>Salaire mensuel de base</td><td class="right">${r.workDays||22} j</td><td class="right">${f2(brut/22)}/j</td><td class="right bold">${f2(r.base||brut)}</td></tr>
    ${(r.overtime||0)>0?`<tr><td>Heures supplementaires (150%)</td><td class="right">${r.overtimeH||'-'}h</td><td class="right">150%</td><td class="right">${f2(r.overtime)}</td></tr>`:''}
    ${(r.sunday||0)>0?`<tr><td>Heures dimanche (200%)</td><td class="right">${r.sundayH||'-'}h</td><td class="right">200%</td><td class="right">${f2(r.sunday)}</td></tr>`:''}
    ${(r.night||0)>0?`<tr><td>Heures nuit (125%)</td><td class="right">${r.nightH||'-'}h</td><td class="right">125%</td><td class="right">${f2(r.night)}</td></tr>`:''}
    ${(r.bonus||0)>0?`<tr><td>Prime/Bonus</td><td class="right">-</td><td class="right">-</td><td class="right">${f2(r.bonus)}</td></tr>`:''}
    <tr class="total-row"><td colspan="3">TOTAL BRUT</td><td class="right">${f2(brut)}</td></tr>
  </table>
</div>
<div class="section">
  <div class="section-title">Retenues</div>
  <table>
    <tr><th>Description</th><th class="right">Base</th><th class="right">Taux</th><th class="right">Montant</th></tr>
    <tr><td>Cotisation ONSS personnelle</td><td class="right">${f2(brut)}</td><td class="right">13,07%</td><td class="right" style="color:#c0392b">-${f2(onssP)}</td></tr>
    <tr><td>Précompte professionnel</td><td class="right">${f2(imposable)}</td><td class="right">${imposable>0?(pp/imposable*100).toFixed(1)+'%':'-'}</td><td class="right" style="color:#c0392b">-${f2(pp)}</td></tr>
    <tr><td>Cotisation spéciale securite sociale</td><td class="right">-</td><td class="right">Bareme</td><td class="right" style="color:#c0392b">-${f2(csss)}</td></tr>
    <tr class="total-row"><td colspan="3">TOTAL RETENUES</td><td class="right" style="color:#c0392b">-${f2(onssP+pp+csss)}</td></tr>
  </table>
</div>
<div class="section">
  <table>
    <tr class="net-row"><td colspan="3" style="font-size:13px">NET A PAYER</td><td class="right" style="font-size:15px">${f2(net)} EUR</td></tr>
  </table>
</div>
${empIBAN?`<div style="font-size:10px;color:#666;margin-top:4px">Virement sur: <b>${empIBAN}</b></div>`:''}
<div class="employer-box">
  <div class="title">Charges patronales (pour information)</div>
  <div class="info-grid">
    <div class="info-row"><span class="info-label">ONSS patronal (25,07%):</span><span class="info-value">${f2(onssE)}</span></div>
    <div class="info-row"><span class="info-label">Coût total employeur:</span><span class="info-value" style="color:#c6a34e;font-weight:800">${f2(coutTotal)}</span></div>
  </div>
</div>
${mealV>0?`<div style="margin-top:6px;font-size:10px;color:#666">Cheques-repas: ${emp.mealVoucher||0} x 22j = ${f2(mealV)} EUR (part patronale ${f2((emp.mealVoucher||0)*22*0.83)})</div>`:''}
<div class="footer">
  <span>Généré par Aureus Social Pro | ${coName} | ${coVAT}</span>
  <span>Date edition: ${new Date().toLocaleDateString('fr-BE')}</span>
</div>
<div style="text-align:center;margin-top:15px"><button onclick="window.print()" style="background:#c6a34e;color:#fff;border:none;padding:10px 30px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600">Imprimer / Sauvegarder PDF</button></div>
</body></html>`);
  w.document.close();
  }catch(err){alert('Erreur génération fiche: '+err.message);console.error(err);}
}

// ═══ UNIVERSAL FILE HELPERS (Sprint 24 fix) ═══
function downloadFile(content, filename, mimeType) {
  try {
    const blob = new Blob([content], { type: mimeType || 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    // Try standard download
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { try { document.body.removeChild(a); } catch(e) {} URL.revokeObjectURL(url); }, 5000);
    return true;
  } catch(err) { 
    console.error('Download error:', err);
    alert('Erreur téléchargement: ' + err.message);
    return false;
  }
}

function previewHTML(html, title) {
  // Method 1: New window
  try {
    const win = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
    if (win && !win.closed) {
      win.document.write(html);
      win.document.close();
      win.document.title = title || 'Aureus Social Pro';
      win.focus();
      return;
    }
  } catch(e) {}
  // Method 2: Overlay with iframe (popup blocked fallback)
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.88);z-index:99999;display:flex;flex-direction:column;align-items:center;padding:16px';
  const bar = document.createElement('div');
  bar.style.cssText = 'display:flex;gap:8px;margin-bottom:12px';
  [
    { text: '🖨 Imprimer / PDF', bg: '#c6a34e', color: '#060810', fn: () => { try { iframe.contentWindow.print(); } catch(e) { alert('Utilisez Ctrl+P'); } } },
    { text: '📥 Télécharger', bg: '#22c55e', color: '#fff', fn: () => downloadFile(html, (title || 'document') + '.html', 'text/html;charset=utf-8') },
    { text: '✕ Fermer', bg: '#ef4444', color: '#fff', fn: () => document.body.removeChild(overlay) }
  ].forEach(b => {
    const btn = document.createElement('button');
    btn.textContent = b.text;
    btn.style.cssText = 'padding:10px 20px;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:13px;background:' + b.bg + ';color:' + b.color;
    btn.onclick = b.fn;
    bar.appendChild(btn);
  });
  const iframe = document.createElement('iframe');
  iframe.style.cssText = 'flex:1;width:100%;max-width:900px;border:2px solid rgba(198,163,78,.3);border-radius:10px;background:#fff';
  iframe.srcdoc = html;
  overlay.appendChild(bar);
  overlay.appendChild(iframe);
  document.body.appendChild(overlay);
}

function calcPayroll(brut,statut,familial,charges,regime){
  if(!brut||brut<=0)return{brut:0,onssP:0,imposable:0,pp:0,csss:0,bonusEmploi:0,net:0,onssE:0,coutTotal:0,details:{}};
  const r=(regime||100)/100;
  const brutR=brut*r;
  const onssP=Math.round(brutR*TX_ONSS_W*100)/100;
  const imposable=Math.round((brutR-onssP)*100)/100;
  const qe=statut==='independant'?0:880.83;
  const chDed=(charges||0)*175;
  const baseImp=Math.max(0,imposable-qe-chDed);
  let pp=0;
  if(baseImp>0){
    const t1=Math.min(baseImp,1128.33)*0.2675;
    const t2=baseImp>1128.33?Math.min(baseImp-1128.33,450)*0.3210:0;
    const t3=baseImp>1578.33?Math.min(baseImp-1578.33,1140)*0.4280:0;
    const t4=baseImp>2718.33?(baseImp-2718.33)*0.4815:0;
    pp=Math.round((t1+t2+t3+t4)*100)/100;
  }
  if(familial==='marie_1rev')pp=Math.round(pp*0.70*100)/100;
  if(familial==='marie_2rev')pp=Math.round(pp*PV_DOUBLE*100)/100;
  let csss=0;
  if(brutR<=1945.38)csss=0;
  else if(brutR<=2190.18)csss=brutR*0.076-147.87;
  else if(brutR<=6038.82)csss=brutR*0.011-5.25;
  else csss=60.94;
  csss=Math.round(Math.max(0,csss)*100)/100;
  let bonusEmploi=0;
  if(imposable<=1945.38)bonusEmploi=Math.min(pp,308.33);
  else if(imposable<=2721.56)bonusEmploi=Math.min(pp,Math.max(0,308.33-((imposable-1945.38)*0.3969)));
  bonusEmploi=Math.round(bonusEmploi*100)/100;
  const ppFinal=Math.round(Math.max(0,pp-bonusEmploi)*100)/100;
  const net=Math.round((brutR-onssP-ppFinal-csss)*100)/100;
  const onssE=Math.round(brutR*TX_ONSS_E*100)/100;
  const coutTotal=Math.round((brutR+onssE)*100)/100;
  return{brut:brutR,onssP,imposable,pp:ppFinal,csss,bonusEmploi,baseImp:Math.round(baseImp*100)/100,coutTotal,onssE,net,details:{qe,chDed,ppBrut:Math.round(pp*100)/100,tauxPP:imposable>0?Math.round(ppFinal/imposable*10000)/100:0,tauxNet:brutR>0?Math.round(net/brutR*10000)/100:0}};
}
function calcPeculeDouble(brutAnnuel){
  const base=Math.round(brutAnnuel*PV_DOUBLE*100)/100;
  const onss=Math.round(base*TX_ONSS_W*100)/100;
  const cotSpec=Math.round(base*TX_AT*100)/100;
  const imposable=Math.round((base-onss)*100)/100;
  const pp=Math.round(imposable*0.2315*100)/100;
  const net=Math.round((base-onss-cotSpec-pp)*100)/100;
  return{base,onss,cotSpec,imposable,pp,net};
}
function calcProrata(brut,joursPreste,joursMois){
  const jm=joursMois||22;
  const ratio=Math.min(joursPreste,jm)/jm;
  return Math.round(brut*ratio*100)/100;
}
function calc13eMois(brutMensuel){
  const brut=brutMensuel;
  const onss=Math.round(brut*TX_ONSS_W*100)/100;
  const imposable=Math.round((brut-onss)*100)/100;
  const pp=Math.round(imposable*0.2315*100)/100;
  const net=Math.round((brut-onss-pp)*100)/100;
  return{brut,onss,imposable,pp,net};
}

const CP_PRESETS_GLOBAL={"cp200":{id:"cp200",label:"CP 200 - CPNAE",barMin:2029.88},"cp100":{id:"cp100",label:"CP 100",barMin:RMMMG},"cp110":{id:"cp110",label:"CP 110 - Textile",barMin:RMMMG},"cp124":{id:"cp124",label:"CP 124 - Construction",barMin:2100},"cp140":{id:"cp140",label:"CP 140 - Transport",barMin:2050},"cp149":{id:"cp149",label:"CP 149.01 - Electriciens",barMin:2000},"cp200":{id:"cp200",label:"CP 200 - CPNAE",barMin:2029.88},"cp209":{id:"cp209",label:"CP 209 - Metal",barMin:2100},"cp218":{id:"cp218",label:"CP 218",barMin:2029.88},"cp302":{id:"cp302",label:"CP 302 - Horeca",barMin:RMMMG},"cp330":{id:"cp330",label:"CP 330 - Soins",barMin:2029.88}};


// ── SCORE SANTÉ DOSSIER ──

// ── MULTI-CURRENCY CONVERTER ──

// ── INTÉGRATIONS CONNECTEURS ──

// ── WEBHOOK MANAGER ──

// ═══════════════════════════════════════════════════════════════
//  SPRINT 8 — PRÉDICTIF: BUDGET AUTO + SIMULATEUR + KPI AVANCÉS
// ═══════════════════════════════════════════════════════════════

// ── BUDGET AUTOMATIQUE ──



// ── PLANIFICATEUR DE TÂCHES ──

// ── GESTION DES ABSENCES (PRÉ-PAIE) ──

// ═══════════════════════════════════════════════════════════════
//  ALERTES LÉGALES — Veille juridique et échéances
// ═══════════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════
// MODULE: DOCUMENTS JURIDIQUES — Phase 0 Fiduciaire Sociale
// Convention de Mandat, DPA RGPD, Registre RGPD, Politique Confidentialité
// Génération PDF côté client + envoi email en 1 clic
// ═══════════════════════════════════════════════════════════

function MoteurLoisBelges({s,d}){
const ae=s.emps||[];
const [tab,setTab]=useState("dashboard");
const [editMode,setEditMode]=useState(false);
const [customLois,setCustomLois]=useState(()=>{try{return (()=>{try{return JSON.parse(safeLS.get('aureus_lois_custom'))}catch(e){return null}})()||{};}catch(e){return {};}});
const [updateHistory,setUpdateHistory]=useState(()=>{try{return (()=>{try{return JSON.parse(safeLS.get('aureus_lois_history'))}catch(e){return null}})()||[];}catch(e){return [];}});
const [checking,setChecking]=useState(false);
const [lastCheck,setLastCheck]=useState(()=>safeLS.get('aureus_lois_lastcheck')||null);
const [editValues,setEditValues]=useState({});
const [importState,setImportState]=useState({step:'idle',data:null,validation:null,uploading:false,history:[]});
const handleJsonImport=async(file)=>{
  setImportState(p=>({...p,step:'reading'}));
  try{
    const text=await file.text();
    const json=(()=>{try{return JSON.parse(text)}catch(e){return null}})();
    setImportState(p=>({...p,step:'validating',data:json}));
    const resp=await fetch('/api/lois-update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'validate',payload:json})});
    const result=await resp.json();
    setImportState(p=>({...p,step:'validated',validation:result}));
  }catch(e){setImportState({step:'error',data:null,validation:{valid:false,errors:[e.message]},uploading:false,history:[]});}
};
const handleUploadToSupabase=async()=>{
  if(!importState.data||!importState.validation?.valid)return;
  setImportState(p=>({...p,uploading:true}));
  try{
    const resp=await fetch('/api/lois-update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'upload',payload:importState.data,source:'json_upload'})});
    const result=await resp.json();
    if(result.status==='pending'){
      setImportState(p=>({...p,step:'uploaded',uploading:false,uploadId:result.id}));
    }else if(result.status==='table_missing'){
      setImportState(p=>({...p,step:'migration_needed',uploading:false,migration:result.migration}));
    }else{
      setImportState(p=>({...p,step:'error',uploading:false,validation:result}));
    }
  }catch(e){setImportState(p=>({...p,step:'error',uploading:false,validation:{errors:[e.message]}}));}
};
const handleApproveAndApply=async(id)=>{
  try{
    await fetch('/api/lois-update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'approve',id})});
    const resp=await fetch('/api/lois-update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'apply',id})});
    const result=await resp.json();
    if(result.validated){
      applyUpdate(result.validated);
      setImportState(p=>({...p,step:'applied',appliedCount:result.changes_count}));
    }
  }catch(e){setImportState(p=>({...p,step:'error',validation:{errors:[e.message]}}));}
};
const loadSupabaseHistory=async()=>{
  try{
    const resp=await fetch('/api/lois-update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'list'})});
    const result=await resp.json();
    setImportState(p=>({...p,history:result.updates||[]}));
  }catch(e){}
};
const handleRollback=async(id)=>{
  if(!confirm('Annuler cet update et revenir aux valeurs par defaut?'))return;
  try{
    await fetch('/api/lois-update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'rollback',id})});
    setCustomLois({});
    safeLS.remove('aureus_lois_custom');
    loadSupabaseHistory();
  }catch(e){}
};

const L=LOIS_BELGES;
const fmt=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v);
const pct=v=>(v*100).toFixed(2)+'%';

// Catégories de paramètres
const categories=[
{id:'onss',nom:'ONSS / Cotisations',icon:'🏛',color:'#ef4444',params:[
  {k:'onss.travailleur',l:'ONSS travailleur',v:pct(L.onss.travailleur),t:'pct'},
  {k:'onss.employeur.total',l:'ONSS employeur total',v:pct(L.onss.employeur.total),t:'pct'},
  {k:'onss.employeur.detail.pension',l:'  └ Pension',v:pct(L.onss.employeur.detail.pension),t:'pct'},
  {k:'onss.employeur.detail.maladie',l:'  └ Maladie-invalidite',v:pct(L.onss.employeur.detail.maladie),t:'pct'},
  {k:'onss.employeur.detail.chomage',l:'  └ Chomage',v:pct(L.onss.employeur.detail.chomage),t:'pct'},
  {k:'onss.employeur.detail.moderation',l:'  └ Moderation salariale',v:pct(L.onss.employeur.detail.moderation),t:'pct'},
  {k:'onss.ouvrier108',l:'Majoration ouvriers',v:'x '+L.onss.ouvrier108,t:'num'},
]},
{id:'pp',nom:'Precompte Professionnel',icon:'💰',color:'#a855f7',params:[
  {k:'pp.tranches.0',l:'Tranche 1: 0-'+fmt(L.pp.tranches[0].max),v:pct(L.pp.tranches[0].taux),t:'pct'},
  {k:'pp.tranches.1',l:'Tranche 2: '+fmt(L.pp.tranches[1].min)+'-'+fmt(L.pp.tranches[1].max),v:pct(L.pp.tranches[1].taux),t:'pct'},
  {k:'pp.tranches.2',l:'Tranche 3: '+fmt(L.pp.tranches[2].min)+'-'+fmt(L.pp.tranches[2].max),v:pct(L.pp.tranches[2].taux),t:'pct'},
  {k:'pp.tranches.3',l:'Tranche 4: '+fmt(L.pp.tranches[3].min)+'+',v:pct(L.pp.tranches[3].taux),t:'pct'},
  {k:'pp.fraisPro.salarie.pct',l:'Frais pro salarie',v:pct(L.pp.fraisPro.salarie.pct)+' max '+fmt(L.pp.fraisPro.salarie.max),t:'txt'},
  {k:'pp.fraisPro.dirigeant.pct',l:'Frais pro dirigeant',v:pct(L.pp.fraisPro.dirigeant.pct)+' max '+fmt(L.pp.fraisPro.dirigeant.max),t:'txt'},
  {k:'pp.quotiteExemptee.bareme1',l:'Quotite exemptee (bareme 1)',v:fmt(L.pp.quotiteExemptee.bareme1)+' EUR/an',t:'num'},
  {k:'pp.quotiteExemptee.bareme2',l:'Quotite exemptee (bareme 2)',v:fmt(L.pp.quotiteExemptee.bareme2)+' EUR/an',t:'num'},
  {k:'pp.quotientConjugal.max',l:'Quotient conjugal max',v:fmt(L.pp.quotientConjugal.max)+' EUR/an',t:'num'},
  {k:'pp.reductionsEnfants',l:'Reductions enfants (1-8)',v:L.pp.reductionsEnfants.slice(1).map(v=>fmt(v)).join(' | '),t:'arr'},
  {k:'pp.bonusEmploi.maxMensuel',l:'Bonus emploi max',v:fmt(L.pp.bonusEmploi.maxMensuel)+' EUR/mois',t:'num'},
]},
{id:'csss',nom:'CSSS',icon:'🔒',color:'#f97316',params:[
  {k:'csss.isole.0.max',l:'Seuil exoneration',v:fmt(L.csss.isole[0].max)+' EUR/an',t:'num'},
  {k:'csss.isole.4.montantFixe',l:'Plafond isole',v:fmt(L.csss.isole[4].montantFixe)+' EUR/trim',t:'num'},
]},
{id:'rem',nom:'Remuneration',icon:'💶',color:'#22c55e',params:[
  {k:'rémunération.RMMMG.montant18ans',l:'RMMMG (18 ans)',v:fmt(L.rémunération.RMMMG.montant18ans)+' EUR/mois',t:'num'},
  {k:'rémunération.indexSante.coeff',l:'Coefficient index sante',v:L.rémunération.indexSante.coeff,t:'num'},
  {k:'rémunération.peculeVacances.simple.pct',l:'Pecule vacances simple',v:pct(L.rémunération.peculeVacances.simple.pct),t:'pct'},
  {k:'rémunération.peculeVacances.double.pct',l:'Pecule vacances double',v:pct(L.rémunération.peculeVacances.double.pct),t:'pct'},
  {k:'chequesRepas.partTravailleur.min',l:'Cheques-repas part travailleur min',v:fmt(L.chequesRepas.partTravailleur.min)+' EUR',t:'num'},
  {k:'chequesRepas.valeurFaciale.max',l:'Cheques-repas valeur faciale max',v:fmt(L.chequesRepas.valeurFaciale.max)+' EUR',t:'num'},
  {k:'fraisPropres.forfaitBureau.max',l:'Forfait bureau/teletravail',v:fmt(L.fraisPropres.forfaitBureau.max)+' EUR/mois',t:'num'},
  {k:'fraisPropres.forfaitDeplacement.voiture',l:'Indemnite km voiture',v:fmt(L.fraisPropres.forfaitDeplacement.voiture)+' EUR/km',t:'num'},
]},
{id:'atn',nom:'ATN / Avantages',icon:'🚗',color:'#3b82f6',params:[
  {k:'atn.voiture.min',l:'ATN voiture minimum',v:fmt(L.atn.voiture.min)+' EUR/an',t:'num'},
  {k:'atn.gsm.forfait',l:'ATN GSM/tablette',v:fmt(L.atn.gsm.forfait)+' EUR/mois',t:'num'},
  {k:'atn.pc.forfait',l:'ATN PC/laptop',v:fmt(L.atn.pc.forfait)+' EUR/mois',t:'num'},
  {k:'atn.internet.forfait',l:'ATN Internet',v:fmt(L.atn.internet.forfait)+' EUR/mois',t:'num'},
  {k:'atn.electricite.cadre',l:'ATN electricite (cadre)',v:fmt(L.atn.electricite.cadre)+' EUR/an',t:'num'},
  {k:'atn.chauffage.cadre',l:'ATN chauffage (cadre)',v:fmt(L.atn.chauffage.cadre)+' EUR/an',t:'num'},
]},
{id:'travail',nom:'Temps de travail',icon:'⏰',color:'#eab308',params:[
  {k:'tempsTravail.dureeHebdoLegale',l:'Duree hebdo legale',v:L.tempsTravail.dureeHebdoLegale+'h',t:'num'},
  {k:'tempsTravail.heuresSupp.majoration50',l:'Heures supp (+50%)',v:pct(L.tempsTravail.heuresSupp.majoration50),t:'pct'},
  {k:'tempsTravail.heuresSupp.plafondAnnuel',l:'Plafond heures supp/an',v:L.tempsTravail.heuresSupp.plafondAnnuel+'h',t:'num'},
  {k:'tempsTravail.jourFerie.nombre',l:'Jours fériés legaux',v:L.tempsTravail.jourFerie.nombre,t:'num'},
]},
{id:'assur',nom:'Assurances & Seuils',icon:'🛡',color:'#06b6d4',params:[
  {k:'assurances.accidentTravail.taux',l:'Assurance accident travail',v:pct(L.assurances.accidentTravail.taux),t:'pct'},
  {k:'assurances.medecineTravail.cout',l:'Medecine du travail',v:fmt(L.assurances.medecineTravail.cout)+' EUR/trav',t:'num'},
  {k:'seuils.electionsSociales.cppt',l:'Seuil elections CPPT',v:L.seuils.electionsSociales.cppt+' travailleurs',t:'num'},
  {k:'seuils.electionsSociales.ce',l:'Seuil elections CE',v:L.seuils.electionsSociales.ce+' travailleurs',t:'num'},
  {k:'seuils.planFormation',l:'Seuil plan formation',v:L.seuils.planFormation+' travailleurs',t:'num'},
]},
];

const totalParams=categories.reduce((a,c)=>a+c.params.length,0);

// Vérification auto
const doCheck=async()=>{
  setChecking(true);
  const now=new Date().toISOString();
  try{
    const resp=await fetch('/api/veille-juridique?manual=true');
    const data=await resp.json();
    const entry={
      date:now,
      version:L._meta.version,
      status:data.status==='UP_TO_DATE'?'A_JOUR':data.status==='CHANGES_DETECTED'?'CHANGEMENTS':'ALERTES',
      results:data.sources||[],
      changes:data.changes||[],
      alerts:data.alerts||[],
      summary:data.summary||{},
      duration:data.duration,
      trigger:'manual',
    };
    const hist=[entry,...updateHistory].slice(0,30);
    setUpdateHistory(hist);
    setLastCheck(now);
    safeLS.set('aureus_lois_history',JSON.stringify(hist));
    safeLS.set('aureus_lois_lastcheck',now);
  }catch(e){
    const entry={date:now,version:L._meta.version,status:'ERREUR',error:e.message,trigger:'manual'};
    const hist=[entry,...updateHistory].slice(0,30);
    setUpdateHistory(hist);
    setLastCheck(now);
    safeLS.set('aureus_lois_history',JSON.stringify(hist));
    safeLS.set('aureus_lois_lastcheck',now);
  }
  setChecking(false);
};

// MAJ en 1 clic
const applyUpdate=(newValues)=>{
  const merged={...customLois,...newValues,_updated:new Date().toISOString()};
  setCustomLois(merged);
  safeLS.set('aureus_lois_custom',JSON.stringify(merged));
  // Log
  const histEntry={date:new Date().toISOString(),action:'UPDATE',changes:Object.keys(newValues).length,detail:newValues};
  const hist=[histEntry,...updateHistory].slice(0,50);
  setUpdateHistory(hist);
  safeLS.set('aureus_lois_history',JSON.stringify(hist));
};

const resetAll=()=>{
  if(confirm('Reinitialiser toutes les valeurs personnalisees? Les valeurs par defaut 2026 seront restaurees.')){
    setCustomLois({});
    safeLS.remove('aureus_lois_custom');
  }
};

return <div>
<PH title="Moteur Lois Belges" sub={"Base centralisee — "+totalParams+" parametres legaux — Version "+L._meta.version+" — MAJ "+L._meta.dateMAJ}/>

{/* KPIs */}
<div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:10,marginBottom:18}}>
{[
  {l:"Parametres legaux",v:totalParams,c:"#c6a34e"},
  {l:"Categories",v:categories.length,c:"#60a5fa"},
  {l:"Sources surveillees",v:L.sources.length,c:"#a855f7"},
  {l:"Version",v:L._meta.version,c:"#4ade80"},
  {l:"Statut",v:checking?"Verification...":lastCheck?"A jour":"Non verifie",c:lastCheck?"#4ade80":"#fb923c"},
].map((k,i)=><div key={i} style={{padding:"12px 14px",background:"rgba(198,163,78,.04)",borderRadius:10,border:"1px solid rgba(198,163,78,.08)"}}>
  <div style={{fontSize:9,color:"#5e5c56",textTransform:"uppercase",letterSpacing:".5px"}}>{k.l}</div>
  <div style={{fontSize:17,fontWeight:700,color:k.c,marginTop:4}}>{k.v}</div>
</div>)}
</div>

{/* Actions rapides */}
<div style={{display:"flex",gap:8,marginBottom:16}}>
  <button onClick={doCheck} disabled={checking} style={{padding:"10px 20px",borderRadius:8,border:"none",cursor:"pointer",fontFamily:"inherit",fontWeight:700,fontSize:13,background:checking?"rgba(198,163,78,.1)":"linear-gradient(135deg,#c6a34e,#a8892e)",color:checking?"#9e9b93":"#000"}}>
    {checking?"⏳ Verification en cours...":"🔄 Verifier les mises a jour"}
  </button>
  <button onClick={resetAll} style={{padding:"10px 20px",borderRadius:8,border:"1px solid rgba(248,113,113,.3)",cursor:"pointer",fontFamily:"inherit",fontWeight:600,fontSize:13,background:"transparent",color:"#f87171"}}>
    ↺ Reinitialiser
  </button>
  <button onClick={()=>setEditMode(!editMode)} style={{padding:"10px 20px",borderRadius:8,border:"1px solid rgba(198,163,78,.3)",cursor:"pointer",fontFamily:"inherit",fontWeight:600,fontSize:13,background:editMode?"rgba(198,163,78,.15)":"transparent",color:"#c6a34e"}}>
    {editMode?"✓ Terminer":"✏ Mode edition"}
  </button>
</div>

{/* Tabs */}
<div style={{display:"flex",gap:6,marginBottom:16}}>
{[{v:"dashboard",l:"📊 Tableau de bord"},{v:"parametres",l:"⚙ Tous les parametres"},{v:"sources",l:"🌐 Sources"},{v:"historique",l:"📜 Historique"},{v:"impact",l:"📈 Impact sur paie"},{v:"export",l:"📤 Export"}].map(t=>
  <button key={t.v} onClick={()=>setTab(t.v)} style={{padding:"8px 16px",borderRadius:8,border:"none",cursor:"pointer",fontSize:12,fontWeight:tab===t.v?600:400,fontFamily:"inherit",background:tab===t.v?"rgba(198,163,78,.15)":"rgba(255,255,255,.03)",color:tab===t.v?"#c6a34e":"#9e9b93"}}>{t.l}</button>
)}
</div>

{/* DASHBOARD */}
{tab==="dashboard"&&<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
{categories.map(cat=><C key={cat.id}>
  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
    <ST><span style={{marginRight:6}}>{cat.icon}</span>{cat.nom}</ST>
    <span style={{fontSize:10,padding:"3px 8px",borderRadius:6,background:cat.color+"15",color:cat.color,fontWeight:600}}>{cat.params.length} params</span>
  </div>
  {cat.params.slice(0,5).map((p,j)=><div key={j} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",borderBottom:"1px solid rgba(255,255,255,.02)"}}>
    <span style={{fontSize:11,color:"#9e9b93"}}>{p.l}</span>
    <span style={{fontSize:11,fontWeight:600,color:cat.color}}>{typeof p.v==='string'?p.v.substring(0,30):p.v}</span>
  </div>)}
  {cat.params.length>5&&<div style={{fontSize:10,color:"#5e5c56",textAlign:"center",marginTop:6}}>+{cat.params.length-5} autres parametres</div>}
</C>)}
</div>}

{/* TOUS LES PARAMETRES */}
{tab==="parametres"&&<div>
{categories.map(cat=><C key={cat.id}>
  <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:12}}>
    <span style={{fontSize:18}}>{cat.icon}</span>
    <ST>{cat.nom}</ST>
    <div style={{flex:1}}/>
    <span style={{fontSize:10,padding:"3px 10px",borderRadius:6,background:cat.color+"15",color:cat.color,fontWeight:600}}>{cat.params.length}</span>
  </div>
  <div style={{display:"grid",gridTemplateColumns:"1fr auto",gap:"4px 12px"}}>
  {cat.params.map((p,j)=><div key={j} style={{display:"contents"}}>
    <div style={{fontSize:11,color:"#9e9b93",padding:"6px 0",borderBottom:"1px solid rgba(255,255,255,.02)"}}>{p.l}</div>
    <div style={{fontSize:11,fontWeight:600,color:"#e8e6e0",padding:"6px 0",borderBottom:"1px solid rgba(255,255,255,.02)",textAlign:"right"}}>
      {editMode?<input value={editValues[p.k]||p.v} onChange={e=>setEditValues({...editValues,[p.k]:e.target.value})} style={{width:160,padding:"3px 6px",borderRadius:4,border:"1px solid rgba(198,163,78,.3)",background:"rgba(198,163,78,.05)",color:"#c6a34e",fontSize:11,fontFamily:"inherit",textAlign:"right"}}/>:
      <span style={{color:customLois[p.k]?"#c6a34e":"#e8e6e0"}}>{customLois[p.k]||p.v}{customLois[p.k]&&<span style={{fontSize:8,marginLeft:4,color:"#c6a34e"}}>✏</span>}</span>}
    </div>
  </div>)}
  </div>
</C>)}
{editMode&&<div style={{textAlign:"center",marginTop:16}}>
  <button onClick={()=>{applyUpdate(editValues);setEditMode(false);setEditValues({});}} style={{padding:"12px 30px",borderRadius:8,border:"none",cursor:"pointer",fontFamily:"inherit",fontWeight:700,fontSize:14,background:"linear-gradient(135deg,#c6a34e,#a8892e)",color:"#000"}}>
    💾 Sauvegarder les modifications ({Object.keys(editValues).length} changes)
  </button>
</div>}
</div>}

{/* SOURCES */}
{tab==="sources"&&<C>
<ST>Sources officielles surveillees</ST>
<div style={{fontSize:11,color:"#9e9b93",marginBottom:12}}>Le systeme surveille {L.sources.length} sources officielles belges pour detecter les changements legislatifs</div>
{L.sources.map((src,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}>
  <div style={{width:8,height:8,borderRadius:"50%",background:"#4ade80",flexShrink:0}}/>
  <div style={{flex:1}}>
    <div style={{fontWeight:600,color:"#e8e6e0",fontSize:12}}>{src.nom}</div>
    <div style={{fontSize:10,color:"#5e5c56"}}>{src.url}</div>
  </div>
  <span style={{fontSize:10,padding:"3px 8px",borderRadius:4,background:"rgba(96,165,250,.1)",color:"#60a5fa"}}>{src.type}</span>
</div>)}
<div style={{marginTop:16,padding:12,background:"rgba(74,222,128,.04)",borderRadius:8,border:"1px solid rgba(74,222,128,.1)"}}>
  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
    <div style={{fontSize:11,color:"#4ade80",fontWeight:600}}>✅ Backend actif — Cron quotidien 06:30 CET</div>
    <div style={{fontSize:9,color:"#5e5c56"}}>{lastCheck?("Dernier scan: "+new Date(lastCheck).toLocaleString("fr-BE")):"Aucun scan effectue"}</div>
  </div>
  <div style={{fontSize:10,color:"#9e9b93",marginTop:4}}>Le service /api/veille-juridique scrape {L.sources.length} sources officielles, detecte les changements AR/CCT, et notifie l administrateur pour validation avant mise à jour.</div>
  {updateHistory.length>0&&updateHistory[0].changes?.length>0&&<div style={{marginTop:6,padding:"6px 8px",background:"rgba(248,113,113,.06)",borderRadius:6}}>
    <div style={{fontSize:10,color:"#f87171",fontWeight:600}}>⚠️ {updateHistory[0].changes.length} changement(s) detecte(s):</div>
    {updateHistory[0].changes.slice(0,3).map((c,i)=><div key={i} style={{fontSize:10,color:"#fb923c",marginTop:2}}>{c.label}: {c.current} → {c.detected}</div>)}
  </div>}
</div>
</C>}

{/* HISTORIQUE */}
{tab==="historique"&&<C>
<ST>Historique des verifications et mises a jour</ST>
{updateHistory.length===0?<div style={{textAlign:"center",padding:30,color:"#5e5c56"}}>Aucune verification effectuee. Cliquez sur "Verifier les mises a jour".</div>:
updateHistory.map((h,i)=><div key={i} style={{display:"flex",gap:10,padding:"10px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}>
  <div style={{width:8,height:8,borderRadius:"50%",background:h.action==='UPDATE'?"#c6a34e":h.status==='A_JOUR'?"#4ade80":h.status==='CHANGEMENTS'?"#f87171":h.status==='ERREUR'?"#ef4444":"#fb923c",marginTop:5,flexShrink:0}}/>
  <div style={{flex:1}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
      <div style={{fontSize:11,color:"#e8e6e0",fontWeight:600}}>{h.action==='UPDATE'?'✏ MAJ manuelle ('+h.changes+' param.)':h.status==='A_JOUR'?'✓ Verification OK — Aucun changement':h.status==='CHANGEMENTS'?'⚠ '+((h.changes||[]).length)+' changement(s) detecte(s)':h.status==='ERREUR'?'❌ Erreur: '+(h.error||'inconnue'):'⚠ A verifier'}</div>
      <span style={{fontSize:9,color:"#5e5c56"}}>{h.trigger==='manual'?'Manuel':'Auto'}{h.duration?' — '+h.duration:''}</span>
    </div>
    <div style={{fontSize:10,color:"#5e5c56"}}>{new Date(h.date).toLocaleString('fr-BE')}{h.version?' — v'+h.version:''}{h.summary?.sourcesReachable?' — '+h.summary.sourcesReachable+'/'+h.summary.sourcesChecked+' sources':''}</div>
    {h.changes?.length>0&&<div style={{marginTop:4}}>{h.changes.map((c,j)=><div key={j} style={{fontSize:10,color:"#f87171",padding:"2px 0"}}>↳ {c.label}: <b>{c.current}</b> → <b style={{color:"#fb923c"}}>{c.detected}</b> ({c.severity})</div>)}</div>}
    {h.alerts?.length>0&&<div style={{marginTop:2}}>{h.alerts.slice(0,2).map((a,j)=><div key={j} style={{fontSize:10,color:"#60a5fa",padding:"1px 0"}}>ℹ {a.text?.substring(0,100)}</div>)}</div>}
  </div>
</div>)}
</C>}

{/* IMPACT SUR PAIE */}
{tab==="impact"&&<C>
<ST>Impact des parametres sur la paie</ST>
<div style={{fontSize:11,color:"#9e9b93",marginBottom:16}}>Simulation pour un salaire brut de reference (3.500 EUR/mois, isole, 0 enfant)</div>
{(()=>{
  const brut=3500;
  const onssW=Math.round(brut*L.onss.travailleur*100)/100;
  const onssE=Math.round(brut*L.onss.employeur.total*100)/100;
  const pp=quickPP(brut);
  const csss=calcCSSS(brut,'isole');
  const net=Math.round((brut-onssW-pp-csss)*100)/100;
  const cout=Math.round((brut+onssE+brut*L.assurances.accidentTravail.taux+L.assurances.medecineTravail.cout)*100)/100;
  return <div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:10,marginBottom:16}}>
    {[{l:"Brut",v:fmt(brut),c:"#c6a34e"},{l:"Net",v:fmt(net),c:"#4ade80"},{l:"Cout employeur",v:fmt(cout),c:"#f87171"}].map((k,i)=>
      <div key={i} style={{padding:14,background:"rgba(198,163,78,.04)",borderRadius:10,border:"1px solid rgba(198,163,78,.08)",textAlign:"center"}}>
        <div style={{fontSize:9,color:"#5e5c56",textTransform:"uppercase"}}>{k.l}</div>
        <div style={{fontSize:20,fontWeight:700,color:k.c,marginTop:4}}>{k.v}</div>
      </div>)}
    </div>
    <Tbl cols={[{k:"r",l:"Rubrique",b:1},{k:"v",l:"Montant",a:"right",r:r=><span style={{color:r.c,fontWeight:600}}>{r.montant}</span>},{k:"s",l:"Source legale",r:r=><span style={{fontSize:10,color:"#5e5c56"}}>{r.source}</span>}]}
    data={[
      {r:"Salaire brut",montant:fmt(brut)+" EUR",c:"#c6a34e",source:"Contrat de travail"},
      {r:"ONSS travailleur ("+pct(L.onss.travailleur)+")",montant:"- "+fmt(onssW)+" EUR",c:"#f87171",source:"Loi 27/06/1969"},
      {r:"Précompte professionnel",montant:"- "+fmt(pp)+" EUR",c:"#f87171",source:"AR Annexe III - Formule-cle SPF"},
      {r:"CSSS",montant:"- "+fmt(csss)+" EUR",c:"#f87171",source:"AR 29/03/2012"},
      {r:"NET A PAYER",montant:fmt(net)+" EUR",c:"#4ade80",source:""},
      {r:"ONSS employeur ("+pct(L.onss.employeur.total)+")",montant:fmt(onssE)+" EUR",c:"#fb923c",source:"Loi 27/06/1969"},
      {r:"Assurance accident travail",montant:fmt(brut*L.assurances.accidentTravail.taux)+" EUR",c:"#fb923c",source:"Loi 10/04/1971"},
      {r:"Medecine du travail",montant:fmt(L.assurances.medecineTravail.cout)+" EUR",c:"#fb923c",source:"Code bien-etre au travail"},
      {r:"COUT TOTAL EMPLOYEUR",montant:fmt(cout)+" EUR",c:"#f87171",source:""},
    ]}/>
    <div style={{marginTop:16,padding:12,background:"rgba(74,222,128,.04)",borderRadius:8}}>
      <div style={{fontSize:11,color:"#4ade80",fontWeight:600}}>Taux effectif PP: {(pp/brut*100).toFixed(2)}% | Ratio net/brut: {(net/brut*100).toFixed(1)}% | Ratio net/cout: {(net/cout*100).toFixed(1)}%</div>
    </div>
  </div>;
})()}
</C>}

{/* EXPORT */}
{tab==="export"&&<C>
<ST>Export base legale</ST>
<div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10,marginTop:12}}>
  <button onClick={()=>{const blob=new Blob([JSON.stringify(LOIS_BELGES,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='lois_belges_'+L._meta.annee+'.json';a.click();}} style={{padding:16,borderRadius:10,border:"1px solid rgba(198,163,78,.2)",cursor:"pointer",fontFamily:"inherit",background:"rgba(198,163,78,.04)",color:"#c6a34e",textAlign:"center"}}>
    <div style={{fontSize:24}}>📋</div><div style={{fontWeight:600,fontSize:12,marginTop:6}}>JSON complet</div><div style={{fontSize:10,color:"#9e9b93"}}>Toute la base legale</div>
  </button>
  <button onClick={()=>{let csv='Categorie;Parametre;Valeur;Type\n';categories.forEach(cat=>cat.params.forEach(p=>{csv+=cat.nom+';'+p.l+';'+p.v+';'+p.t+'\n';}));const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='parametres_legaux_'+L._meta.annee+'.csv';a.click();}} style={{padding:16,borderRadius:10,border:"1px solid rgba(198,163,78,.2)",cursor:"pointer",fontFamily:"inherit",background:"rgba(198,163,78,.04)",color:"#c6a34e",textAlign:"center"}}>
    <div style={{fontSize:24}}>📊</div><div style={{fontWeight:600,fontSize:12,marginTop:6}}>CSV parametres</div><div style={{fontSize:10,color:"#9e9b93"}}>Pour Excel/Sheets</div>
  </button>
  <button onClick={()=>{const txt='LOIS BELGES '+L._meta.annee+'\nVersion: '+L._meta.version+'\n'+'='.repeat(50)+'\n\n'+categories.map(cat=>cat.icon+' '+cat.nom.toUpperCase()+'\n'+'-'.repeat(40)+'\n'+cat.params.map(p=>'  '+p.l+': '+p.v).join('\n')+'\n').join('\n');const blob=new Blob([txt],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='resume_lois_'+L._meta.annee+'.txt';a.click();}} style={{padding:16,borderRadius:10,border:"1px solid rgba(198,163,78,.2)",cursor:"pointer",fontFamily:"inherit",background:"rgba(198,163,78,.04)",color:"#c6a34e",textAlign:"center"}}>
    <div style={{fontSize:24}}>📄</div><div style={{fontWeight:600,fontSize:12,marginTop:6}}>Resume texte</div><div style={{fontSize:10,color:"#9e9b93"}}>Format lisible</div>
  </button>
</div>
<div style={{marginTop:16,padding:16,background:"rgba(198,163,78,.04)",borderRadius:10,border:"1px solid rgba(198,163,78,.12)"}}>
  <div style={{fontSize:12,color:"#c6a34e",fontWeight:700,marginBottom:10}}>📥 Import / MAJ en 1 clic</div>

  {/* STEP 1: Upload zone */}
  {(importState.step==='idle'||importState.step==='error'||importState.step==='applied')&&<div>
    <div
      onDragOver={e=>{e.preventDefault();e.currentTarget.style.borderColor='#c6a34e';}}
      onDragLeave={e=>{e.currentTarget.style.borderColor='rgba(198,163,78,.2)';}}
      onDrop={e=>{e.preventDefault();e.currentTarget.style.borderColor='rgba(198,163,78,.2)';const f=e.dataTransfer.files[0];if(f&&f.name.endsWith('.json'))handleJsonImport(f);}}
      style={{border:"2px dashed rgba(198,163,78,.2)",borderRadius:8,padding:"20px",textAlign:"center",cursor:"pointer",transition:"border-color .2s"}}
      onClick={()=>{const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=e=>{const f=e.target.files[0];if(f)handleJsonImport(f);};inp.click();}}
    >
      <div style={{fontSize:28}}>📋</div>
      <div style={{fontSize:11,color:"#c6a34e",fontWeight:600,marginTop:6}}>Glissez un fichier JSON ici</div>
      <div style={{fontSize:10,color:"#5e5c56",marginTop:2}}>ou cliquez pour parcourir — Format: {"{\"onss.travailleur\": 0.1307, ...}"}</div>
    </div>
    {importState.step==='error'&&<div style={{marginTop:8,padding:8,background:"rgba(248,113,113,.06)",borderRadius:6}}>
      <div style={{fontSize:10,color:"#f87171"}}>{importState.validation?.errors?.join(', ')||'Erreur inconnue'}</div>
    </div>}
    {importState.step==='applied'&&<div style={{marginTop:8,padding:8,background:"rgba(74,222,128,.06)",borderRadius:6}}>
      <div style={{fontSize:10,color:"#4ade80",fontWeight:600}}>✅ {importState.appliedCount} parametre(s) applique(s) avec succes!</div>
    </div>}
  </div>}

  {/* STEP 2: Validation preview */}
  {(importState.step==='validating'||importState.step==='validated')&&importState.validation&&<div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
      <div style={{fontSize:11,fontWeight:600,color:importState.validation.valid?"#4ade80":"#f87171"}}>
        {importState.validation.valid?"✅ Validation OK — "+importState.validation.count+" parametre(s)":"❌ Erreurs de validation"}
      </div>
      <button onClick={()=>setImportState({step:'idle',data:null,validation:null,uploading:false,history:[]})} style={{fontSize:10,padding:"4px 10px",borderRadius:4,border:"1px solid rgba(248,113,113,.3)",background:"transparent",color:"#f87171",cursor:"pointer",fontFamily:"inherit"}}>✕ Annuler</button>
    </div>
    {importState.validation.errors?.length>0&&<div style={{marginBottom:8}}>{importState.validation.errors.map((e,i)=><div key={i} style={{fontSize:10,color:"#f87171",padding:"2px 0"}}>❌ {e}</div>)}</div>}
    {importState.validation.warnings?.length>0&&<div style={{marginBottom:8}}>{importState.validation.warnings.map((w,i)=><div key={i} style={{fontSize:10,color:"#fb923c",padding:"2px 0"}}>⚠ {w}</div>)}</div>}
    {importState.validation.valid&&<div>
      <div style={{fontSize:10,color:"#9e9b93",marginBottom:6}}>Parametres valides:</div>
      <div style={{maxHeight:150,overflowY:"auto",marginBottom:8}}>{Object.entries(importState.validation.validated||{}).map(([k,v],i)=>
        <div key={i} style={{display:"flex",justifyContent:"space-between",padding:"3px 0",borderBottom:"1px solid rgba(255,255,255,.02)"}}>
          <span style={{fontSize:10,color:"#9e9b93"}}>{k}</span>
          <span style={{fontSize:10,fontWeight:600,color:"#c6a34e"}}>{v}</span>
        </div>
      )}</div>
      <div style={{display:"flex",gap:8}}>
        <button onClick={handleUploadToSupabase} disabled={importState.uploading} style={{flex:1,padding:"10px",borderRadius:8,border:"none",cursor:"pointer",fontFamily:"inherit",fontWeight:700,fontSize:12,background:importState.uploading?"rgba(198,163,78,.1)":"linear-gradient(135deg,#c6a34e,#a8892e)",color:importState.uploading?"#9e9b93":"#000"}}>
          {importState.uploading?"⏳ Envoi vers Supabase...":"📤 Stocker dans Supabase (en attente)"}
        </button>
        <button onClick={()=>{applyUpdate(importState.validation.validated);setImportState(p=>({...p,step:'applied',appliedCount:importState.validation.count}));}} style={{flex:1,padding:"10px",borderRadius:8,border:"none",cursor:"pointer",fontFamily:"inherit",fontWeight:700,fontSize:12,background:"linear-gradient(135deg,#22c55e,#16a34a)",color:"#fff"}}>
          ⚡ Appliquer directement
        </button>
      </div>
    </div>}
  </div>}

  {/* STEP 3: Uploaded to Supabase */}
  {importState.step==='uploaded'&&<div>
    <div style={{padding:12,background:"rgba(96,165,250,.06)",borderRadius:6,marginBottom:8}}>
      <div style={{fontSize:11,color:"#60a5fa",fontWeight:600}}>📦 Stocke dans Supabase — ID: {importState.uploadId?.substring(0,8)}...</div>
      <div style={{fontSize:10,color:"#9e9b93",marginTop:4}}>Statut: En attente d approbation admin</div>
    </div>
    <div style={{display:"flex",gap:8}}>
      <button onClick={()=>handleApproveAndApply(importState.uploadId)} style={{flex:1,padding:"10px",borderRadius:8,border:"none",cursor:"pointer",fontFamily:"inherit",fontWeight:700,fontSize:12,background:"linear-gradient(135deg,#c6a34e,#a8892e)",color:"#000"}}>
        ✅ Approuver et appliquer
      </button>
      <button onClick={()=>setImportState({step:'idle',data:null,validation:null,uploading:false,history:[]})} style={{padding:"10px 16px",borderRadius:8,border:"1px solid rgba(248,113,113,.3)",cursor:"pointer",fontFamily:"inherit",fontWeight:600,fontSize:12,background:"transparent",color:"#f87171"}}>
        ✕ Rejeter
      </button>
    </div>
  </div>}

  {/* Migration needed */}
  {importState.step==='migration_needed'&&<div style={{padding:12,background:"rgba(251,146,56,.06)",borderRadius:6}}>
    <div style={{fontSize:11,color:"#fb923c",fontWeight:600}}>⚠ Table Supabase manquante</div>
    <div style={{fontSize:10,color:"#9e9b93",marginTop:4}}>Executez ce SQL dans Supabase Dashboard → SQL Editor:</div>
    <pre style={{fontSize:9,color:"#60a5fa",background:"rgba(0,0,0,.3)",padding:8,borderRadius:4,marginTop:6,overflowX:"auto",maxHeight:120}}>{importState.migration}</pre>
    <button onClick={()=>setImportState({step:'idle',data:null,validation:null,uploading:false,history:[]})} style={{marginTop:8,padding:"6px 12px",borderRadius:4,border:"1px solid rgba(198,163,78,.3)",cursor:"pointer",fontFamily:"inherit",fontSize:10,background:"transparent",color:"#c6a34e"}}>
      OK, fait → Reessayer
    </button>
  </div>}

  {/* Supabase history */}
  <div style={{marginTop:12,borderTop:"1px solid rgba(255,255,255,.05)",paddingTop:10}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
      <div style={{fontSize:10,color:"#5e5c56",fontWeight:600}}>Historique Supabase</div>
      <button onClick={loadSupabaseHistory} style={{fontSize:9,padding:"3px 8px",borderRadius:4,border:"1px solid rgba(198,163,78,.2)",background:"transparent",color:"#c6a34e",cursor:"pointer",fontFamily:"inherit"}}>🔄 Charger</button>
    </div>
    {importState.history?.length>0&&<div style={{marginTop:6,maxHeight:120,overflowY:"auto"}}>{importState.history.map((h,i)=>
      <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 0",borderBottom:"1px solid rgba(255,255,255,.02)"}}>
        <div>
          <span style={{fontSize:9,padding:"1px 5px",borderRadius:3,marginRight:4,background:h.status==='applied'?"rgba(74,222,128,.1)":h.status==='pending'?"rgba(96,165,250,.1)":h.status==='approved'?"rgba(198,163,78,.1)":"rgba(248,113,113,.1)",color:h.status==='applied'?"#4ade80":h.status==='pending'?"#60a5fa":h.status==='approved'?"#c6a34e":"#f87171"}}>{h.status}</span>
          <span style={{fontSize:10,color:"#9e9b93"}}>{h.changes_count} params — v{h.version} — {new Date(h.created_at).toLocaleDateString('fr-BE')}</span>
        </div>
        {h.status==='applied'&&<button onClick={()=>handleRollback(h.id)} style={{fontSize:9,padding:"2px 6px",borderRadius:3,border:"1px solid rgba(248,113,113,.2)",background:"transparent",color:"#f87171",cursor:"pointer",fontFamily:"inherit"}}>↩ Rollback</button>}
        {h.status==='approved'&&<button onClick={()=>handleApproveAndApply(h.id)} style={{fontSize:9,padding:"2px 6px",borderRadius:3,border:"1px solid rgba(74,222,128,.2)",background:"transparent",color:"#4ade80",cursor:"pointer",fontFamily:"inherit"}}>▶ Appliquer</button>}
        {h.status==='pending'&&<button onClick={()=>handleApproveAndApply(h.id)} style={{fontSize:9,padding:"2px 6px",borderRadius:3,border:"1px solid rgba(198,163,78,.2)",background:"transparent",color:"#c6a34e",cursor:"pointer",fontFamily:"inherit"}}>✅ Approuver</button>}
      </div>
    )}</div>}
  </div>
</div>
</C>}

</div>;
}


// ═══════════════════════════════════════════════════════════════
//  AUREUS SUITE — Nos logiciels
// ═══════════════════════════════════════════════════════════════





export default function AureusSocialPro({ supabase, user, onLogout }) {
  return <LangProvider><AppInner supabase={supabase} user={user} onLogout={onLogout}/></LangProvider>;
}// clean