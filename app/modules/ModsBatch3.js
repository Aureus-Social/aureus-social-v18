'use client';
import { useState } from 'react';
import { C, ST, PH, Tbl, I } from '@/app/lib/shared-ui';
import { LOIS_BELGES, TX_ONSS_W, TX_ONSS_E, PV_SIMPLE, PV_DOUBLE } from '@/app/lib/lois-belges';
import { quickPP, quickNet, calcPayroll, calcPeculeDouble, calc13eMois, calcQuotiteSaisissable } from '@/app/lib/payroll-engine';
import { sendSimulationPDF, generateSEPAXML, generateC4PDF, generateAttestationEmploi, generateAttestationSalaire, generateSoldeCompte } from '@/app/lib/doc-generators';

const fmt = v => new Intl.NumberFormat('fr-BE', { minimumFractionDigits: 2 }).format(v || 0);

// ═══ ONSSDashMod ═══
export function ONSSDashMod({s,d}){const ae=s.emps||[];const n=ae.length;const [tab,setTab]=useState("dmfa");const [trim,setTrim]=useState("T1");const [brutSim,setBrutSim]=useState(3500);const [nbPers,setNbPers]=useState(1);const [dureeMois,setDureeMois]=useState(12);const mb=ae.reduce((a,e)=>a+(+e.gross||0),0);const onssP=mb*TX_ONSS_E;const onssT=mb*TX_ONSS_W;const totalONSS=onssP+onssT;const mbTrim=mb*3;const onssPTrim=onssP*3;const onssTTrim=onssT*3;const totalTrim=totalONSS*3;const redGC=ae.filter(e=>{const a=e.birthDate?Math.floor((Date.now()-new Date(e.birthDate))/(365.25*24*3600*1000)):35;return a<26;}).length;const redGCMontant=redGC*1500;const redStruct=n>0?n*480:0;const totalRed=redGCMontant+redStruct;
return <div><PH title="ONSS - Déclaration DmfA" sub={"Déclarations trimestrielles - "+n+" travailleurs - Cotisations "+fmt(totalONSS)+"/mois"}/>
<div style={{display:"grid",gridTemplateColumns:"repeat(6,1fr)",gap:10,marginBottom:18}}>{[{l:"ONSS patronal",v:fmt(onssP),c:"#f87171"},{l:"ONSS personnel",v:fmt(onssT),c:"#f87171"},{l:"Total mensuel",v:fmt(totalONSS),c:"#c6a34e"},{l:"Total trimestre",v:fmt(totalTrim),c:"#fb923c"},{l:"Réductions",v:fmt(totalRed),c:"#4ade80"},{l:"Net ONSS trim.",v:fmt(totalTrim-totalRed),c:"#c6a34e"}].map((k,i)=><div key={i} style={{padding:"12px 14px",background:"rgba(198,163,78,.04)",borderRadius:10,border:"1px solid rgba(198,163,78,.08)"}}><div style={{fontSize:9,color:"#5e5c56",textTransform:"uppercase",letterSpacing:".5px"}}>{k.l}</div><div style={{fontSize:17,fontWeight:700,color:k.c,marginTop:4}}>{k.v}</div></div>)}</div>
<div style={{display:"flex",gap:6,marginBottom:16}}>{[{v:"dmfa",l:"DmfA Résumé"},{v:"cotis",l:"Détail cotisations"},{v:"reductions",l:"Réductions"},{v:"dimona",l:"Dimona"},{v:"calendrier",l:"Calendrier"},{v:"controle",l:"Contrôle pré-envoi"}].map(t=><button key={t.v} onClick={()=>setTab(t.v)} style={{padding:"8px 16px",borderRadius:8,border:"none",cursor:"pointer",fontSize:12,fontWeight:tab===t.v?600:400,fontFamily:"inherit",background:tab===t.v?"rgba(198,163,78,.15)":"rgba(255,255,255,.03)",color:tab===t.v?"#c6a34e":"#9e9b93"}}>{t.l}</button>)}</div>
{tab==="dmfa"&&<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:18}}><C><ST>{"DmfA "+trim+" "+new Date().getFullYear()}</ST>
<div style={{display:"flex",gap:6,marginBottom:12}}>{["T1","T2","T3","T4"].map(t=><button key={t} onClick={()=>setTrim(t)} style={{padding:"6px 14px",borderRadius:6,border:"none",cursor:"pointer",fontSize:11,fontWeight:trim===t?600:400,fontFamily:"inherit",background:trim===t?"rgba(198,163,78,.15)":"rgba(255,255,255,.03)",color:trim===t?"#c6a34e":"#5e5c56"}}>{t}</button>)}</div>
<Tbl cols={[{k:"r",l:"Rubrique",b:1,r:r=>r.rub},{k:"m",l:"Mensuel",a:"right",r:r=><span style={{color:"#e8e6e0"}}>{fmt(r.mens)}</span>},{k:"t",l:"Trimestre",a:"right",r:r=><span style={{color:"#fb923c",fontWeight:600}}>{fmt(r.trim)}</span>}]} data={[{rub:"Masse salariale brute",mens:mb,trim:mbTrim},{rub:"ONSS patronal ("+(TX_ONSS_E*100).toFixed(2)+"%)",mens:onssP,trim:onssPTrim},{rub:"ONSS personnel ("+(TX_ONSS_W*100).toFixed(2)+"%)",mens:onssT,trim:onssTTrim},{rub:"Total cotisations",mens:totalONSS,trim:totalTrim},{rub:"Réductions groupes-cibles",mens:totalRed/3,trim:totalRed},{rub:"Réduction structurelle",mens:redStruct/3,trim:redStruct},{rub:"NET À PAYER ONSS",mens:(totalONSS*3-totalRed)/3,trim:totalTrim-totalRed}]}/>
</C><C><ST>Par travailleur</ST>
<Tbl cols={[{k:"n",l:"Nom",b:1,r:r=>(r.fn||"")+" "+(r.ln||"")},{k:"b",l:"Brut",a:"right",r:r=><span style={{color:"#c6a34e"}}>{fmt(+r.gross||0)}</span>},{k:"p",l:"ONSS P",a:"right",r:r=><span style={{color:"#f87171"}}>{fmt((+r.gross||0)*TX_ONSS_E)}</span>},{k:"t",l:"ONSS T",a:"right",r:r=><span style={{color:"#f87171"}}>{fmt((+r.gross||0)*TX_ONSS_W)}</span>},{k:"to",l:"Total",a:"right",r:r=><span style={{fontWeight:700,color:"#e8e6e0"}}>{fmt((+r.gross||0)*(TX_ONSS_W+TX_ONSS_E))}</span>}]} data={ae}/>
</C></div>}
{tab==="controle"&&<C><ST>Contrôle pré-envoi DmfA</ST>
{[].concat(ae.filter(e=>!e.niss).map(e=>({ok:false,t:"NISS manquant: "+(e.fn||"")+" "+(e.ln||""),d:"Numéro national obligatoire pour chaque ligne travailleur DmfA",c:"#f87171"}))).concat(ae.filter(e=>!e.startDate).map(e=>({ok:false,t:"Date entrée manquante: "+(e.fn||"")+" "+(e.ln||""),d:"Date début occupation requise",c:"#f87171"}))).concat(ae.filter(e=>(+e.gross||0)<=0).map(e=>({ok:false,t:"Salaire nul: "+(e.fn||"")+" "+(e.ln||""),d:"Rémunération brute obligatoire",c:"#f87171"}))).concat(n>0?[{ok:true,t:"Nombre travailleurs: "+n,d:"Au moins 1 travailleur déclaré",c:"#4ade80"}]:[{ok:false,t:"Aucun travailleur",d:"Minimum 1 travailleur requis",c:"#f87171"}]).concat([{ok:mb>0,t:"Masse salariale: "+fmt(mb),d:mb>0?"Masse salariale calculée":"Masse salariale nulle",c:mb>0?"#4ade80":"#f87171"},{ok:true,t:"ONSS patronal: "+fmt(onssP),d:""+(TX_ONSS_E*100).toFixed(2)+"% calculé automatiquement",c:"#4ade80"},{ok:true,t:"ONSS personnel: "+fmt(onssT),d:""+((LOIS_BELGES.onss.travailleur*100).toFixed(2))+"% calculé automatiquement",c:"#4ade80"},{ok:true,t:"Format XML DmfA",d:"Conforme schéma XSD ONSS v2024.1",c:"#4ade80"}]).map((r,i)=><div key={i} style={{display:"flex",gap:12,padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}><div style={{width:22,height:22,borderRadius:6,background:r.ok?"rgba(74,222,128,.1)":"rgba(248,113,113,.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:700,color:r.ok?"#4ade80":"#f87171",flexShrink:0}}>{r.ok?"V":"X"}</div><div><b style={{color:r.c,fontSize:12}}>{r.t}</b><div style={{fontSize:10,color:"#5e5c56"}}>{r.d}</div></div></div>)}
<div style={{display:"flex",gap:8,marginTop:12}}><button onClick={()=>sendSimulationPDF({brut:brutSim||3500,nb:nbPers||1,duree:dureeMois||12,cheqRepas:130.02,coName:s.co?.name},"")} style={{flex:1,padding:"10px",borderRadius:8,border:"1px solid rgba(198,163,78,.3)",background:"rgba(198,163,78,.08)",color:"#c6a34e",fontWeight:600,fontSize:11,cursor:"pointer"}}>Télécharger PDF</button><button onClick={()=>{var email=prompt("Email du client:");if(email)sendSimulationPDF({brut:brutSim||3500,nb:nbPers||1,duree:dureeMois||12,cheqRepas:130.02,coName:s.co?.name},email)}} style={{flex:1,padding:"10px",borderRadius:8,border:"none",background:"#c6a34e",color:"#fff",fontWeight:600,fontSize:11,cursor:"pointer"}}>Envoyer par email</button></div>
</C>}
{tab!=="dmfa"&&tab!=="controle"&&<C><ST>Onglet {tab}</ST><div style={{color:"#9e9b93",fontSize:12}}>Contenu détaillé disponible dans le module complet.</div></C>}
</div>;}

// ═══ SaisiesMod ═══
export function SaisiesMod({s,d}){const ae=(s.emps||[]).filter(e=>e.status==='active'||!e.status);const [tab,setTab]=useState("calc");const [testNet,setTestNet]=useState(2200);const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2}).format(v);const empData=ae.map(e=>{const brut=+(e.gross||e.monthlySalary||0);const net=quickNet(brut);const qs=calcQuotiteSaisissable(net);return {...e,brut,net,qs};});const testQS=calcQuotiteSaisissable(testNet);return <div><PH title="Saisies sur Salaire" sub="Quotité cessible/saisissable — Barèmes 2026"/><div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,marginBottom:18}}>{[{l:"Travailleurs",v:ae.length,c:"#c6a34e"},{l:"Avec saisie active",v:ae.filter(e=>e.saisie).length,c:"#ef4444"},{l:"Test: saisissable",v:f2(testQS.saisissable)+" EUR",c:"#a78bfa"},{l:"Test: protégé",v:f2(testQS.protege)+" EUR",c:"#22c55e"}].map((k,i)=><div key={i} style={{padding:"14px 16px",background:"rgba(198,163,78,.04)",borderRadius:10,border:"1px solid rgba(198,163,78,.08)"}}><div style={{fontSize:10,color:"#5e5c56",textTransform:"uppercase",letterSpacing:".5px"}}>{k.l}</div><div style={{fontSize:18,fontWeight:700,color:k.c,marginTop:4}}>{k.v}</div></div>)}</div><div style={{display:"flex",gap:6,marginBottom:16}}>{[{v:"calc",l:"Par employé"},{v:"sim",l:"Simulateur"},{v:"baremes",l:"Barèmes 2026"}].map(t=><button key={t.v} onClick={()=>setTab(t.v)} style={{padding:"8px 16px",borderRadius:8,border:"none",cursor:"pointer",fontSize:12,fontWeight:tab===t.v?600:400,fontFamily:"inherit",background:tab===t.v?"rgba(198,163,78,.15)":"rgba(255,255,255,.03)",color:tab===t.v?"#c6a34e":"#9e9b93"}}>{t.l}</button>)}</div>{tab==="calc"&&<C><ST>Quotité par travailleur</ST><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}><thead><tr style={{borderBottom:"2px solid rgba(198,163,78,.2)"}}>{["Nom","Net mensuel","Saisissable","Protégé","Saisie active"].map(h=><th key={h} style={{padding:"8px 6px",textAlign:"left",color:"#c6a34e",fontWeight:600,fontSize:10}}>{h}</th>)}</tr></thead><tbody>{empData.map((e,i)=><tr key={e.id||i} style={{borderBottom:"1px solid rgba(255,255,255,.03)"}}><td style={{padding:"6px"}}>{(e.first||e.fn||'')+" "+(e.last||e.ln||'')}</td><td style={{padding:"6px"}}>{f2(e.net)}</td><td style={{padding:"6px",color:"#a78bfa"}}>{f2(e.qs.saisissable)}</td><td style={{padding:"6px",color:"#22c55e"}}>{f2(e.qs.protege)}</td><td style={{padding:"6px"}}>{e.saisie?<span style={{color:"#ef4444",fontSize:10}}>Oui</span>:<span style={{color:"#5e5c56",fontSize:10}}>Non</span>}</td></tr>)}</tbody></table></div></C>}{tab==="sim"&&<C><ST>Simulateur saisie</ST><div style={{marginBottom:16}}><label style={{fontSize:10,color:"#888",display:"block",marginBottom:4}}>Salaire net mensuel</label><input type="number" value={testNet} onChange={e=>setTestNet(+e.target.value)} style={{padding:"8px 12px",borderRadius:8,border:"1px solid rgba(198,163,78,.2)",background:"rgba(0,0,0,.2)",color:"#e8e6e0",fontSize:13,width:180,fontFamily:"inherit"}}/></div>{[{l:"Partie protégée",v:testQS.protege,c:"#22c55e"},{l:"Partie saisissable",v:testQS.saisissable,c:"#a78bfa"}].map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"10px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}><b style={{color:r.c,fontSize:12}}>{r.l}</b><div style={{fontSize:16,fontWeight:700,color:r.c}}>{f2(r.v)} EUR</div></div>)}</C>}{tab==="baremes"&&<C><ST>Barèmes quotité saisissable 2026</ST>{[{tranche:"0 — 1.278 EUR",taux:"0% (insaisissable)",c:"#22c55e"},{tranche:"1.278 — 1.372 EUR",taux:"20%",c:"#60a5fa"},{tranche:"1.372 — 1.513 EUR",taux:"30%",c:"#60a5fa"},{tranche:"1.513 — 1.654 EUR",taux:"40%",c:"#a78bfa"},{tranche:"> 1.654 EUR",taux:"100% (saisissable en totalité)",c:"#ef4444"}].map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}><span style={{color:"#e8e6e0",fontSize:12}}>{r.tranche}</span><span style={{color:r.c,fontWeight:600,fontSize:12}}>{r.taux}</span></div>)}<div style={{marginTop:12,padding:10,background:"rgba(198,163,78,.04)",borderRadius:8,fontSize:10,color:"#9e9b93"}}>Majoration: +73 EUR/enfant à charge. Base: Art. 1409-1412 Code judiciaire. Indexation annuelle AR.</div></C>}</div>;}

// ═══ SEPAMod ═══
export function SEPAMod({s,d}){const ae=(s.emps||[]).filter(e=>e.status==='active'||!e.status);const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2}).format(v);const co=s.company||s.co||{};const totalNet=ae.reduce((a,e)=>a+quickNet(+(e.gross||0)),0);const obf={maskIBAN:(i)=>{if(!i||i.length<8)return i;return i.slice(0,4)+' **** **** '+i.slice(-4);}};return <div><PH title="SEPA Virements" sub="Générateur pain.001 — ISO 20022"/><div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,marginBottom:18}}>{[{l:"Travailleurs",v:ae.length,c:"#c6a34e"},{l:"Total net à virer",v:f2(totalNet)+" EUR",c:"#22c55e"},{l:"Format",v:"pain.001.001.03",c:"#60a5fa"},{l:"Banque",v:co.bic||"GEBABEBB",c:"#a78bfa"}].map((k,i)=><div key={i} style={{padding:"14px 16px",background:"rgba(198,163,78,.04)",borderRadius:10,border:"1px solid rgba(198,163,78,.08)"}}><div style={{fontSize:10,color:"#5e5c56",textTransform:"uppercase",letterSpacing:".5px"}}>{k.l}</div><div style={{fontSize:18,fontWeight:700,color:k.c,marginTop:4}}>{k.v}</div></div>)}</div><C><ST>Virements salaires</ST><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}><thead><tr style={{borderBottom:"2px solid rgba(198,163,78,.2)"}}>{["Nom","IBAN","BIC","Net mensuel"].map(h=><th key={h} style={{padding:"8px 6px",textAlign:"left",color:"#c6a34e",fontWeight:600,fontSize:10}}>{h}</th>)}</tr></thead><tbody>{ae.map((e,i)=>{const net=quickNet(+(e.gross||0));return <tr key={e.id||i} style={{borderBottom:"1px solid rgba(255,255,255,.03)"}}><td style={{padding:"6px"}}>{(e.first||e.fn||'')+" "+(e.last||e.ln||'')}</td><td style={{padding:"6px",fontFamily:"monospace",fontSize:10}}>{obf.maskIBAN(e.iban)||"Non renseigné"}</td><td style={{padding:"6px",fontSize:10}}>{e.bic||"—"}</td><td style={{padding:"6px",fontWeight:600,color:"#22c55e"}}>{f2(net)}</td></tr>;})}</tbody><tfoot><tr style={{borderTop:"2px solid rgba(198,163,78,.2)",fontWeight:700}}><td colSpan={3} style={{padding:"8px 6px"}}>TOTAL</td><td style={{padding:"8px 6px",color:"#22c55e"}}>{f2(totalNet)}</td></tr></tfoot></table></div><div style={{marginTop:16,display:"flex",gap:12}}><button onClick={()=>{try{generateSEPAXML(ae,{month:new Date().getMonth()+1,year:new Date().getFullYear()},co);}catch(e2){alert('Erreur SEPA: '+e2.message);}}} style={{padding:"10px 20px",borderRadius:8,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:"inherit",background:"linear-gradient(135deg,#c6a34e,#e2c878)",color:"#060810"}}>Générer fichier SEPA pain.001</button></div></C></div>;}

// ═══ SimulateurNetBrutMod ═══
export function SimulateurNetBrutMod({s,d}){
  const[brut,setBrut]=useState(3500);const[fam,setFam]=useState('isole');const[ch,setCh]=useState(0);const[reg,setReg]=useState(100);const p=calcPayroll(brut,null,fam,ch,reg);const pd=calcPeculeDouble(brut*12);const t13=calc13eMois(brut);const[tab,setTab]=useState("calcul");
  return <div><PH title="Simulateur Net/Brut" sub={"Brut "+fmt(brut)+" → Net "+fmt(p.net)+" ("+p.details.tauxNet+"%)"}/>
    <div style={{display:"flex",gap:6,marginBottom:16}}>{[{v:"calcul",l:"Calcul"},{v:"detail",l:"Détail"},{v:"annuel",l:"Annuel"},{v:"pecule",l:"Pécule & 13e"}].map(t2=><button key={t2.v} onClick={()=>setTab(t2.v)} style={{padding:"8px 16px",borderRadius:8,border:"none",cursor:"pointer",fontSize:12,fontWeight:tab===t2.v?600:400,fontFamily:"inherit",background:tab===t2.v?"rgba(198,163,78,.15)":"rgba(255,255,255,.03)",color:tab===t2.v?"#c6a34e":"#9e9b93"}}>{t2.l}</button>)}</div>
    {tab==="calcul"&&<C>
      <I label="Salaire brut mensuel (EUR)" type="number" value={brut} onChange={setBrut}/>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:12}}>
        <div><div style={{fontSize:10,color:"#5e5c56",marginBottom:4}}>Situation familiale</div>
          <select value={fam} onChange={e=>setFam(e.target.value)} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,.08)",background:"rgba(255,255,255,.03)",color:"#e8e6e0",fontSize:12}}>
            <option value="isole">Isolé</option><option value="marie_1rev">Marié - 1 revenu</option><option value="marie_2rev">Marié - 2 revenus</option>
          </select></div>
        <I label="Personnes à charge" type="number" value={ch} onChange={setCh}/>
      </div>
      <I label="Régime horaire (%)" type="number" value={reg} onChange={setReg}/>
      <div style={{marginTop:12,padding:16,borderRadius:8,background:"rgba(198,163,78,.05)",border:"1px solid rgba(198,163,78,.15)"}}>
        {[{l:"Salaire brut",v:p.brut,c:"#e8e6e0"},{l:"ONSS personnel (-"+((LOIS_BELGES.onss.travailleur*100).toFixed(2))+"%)",v:-p.onssP,c:"#f87171"},{l:"Revenu imposable",v:p.imposable,c:"#9e9b93"},{l:"Précompte professionnel",v:-p.pp,c:"#f87171"},{l:"Cotisation spéciale sécu",v:-p.csss,c:"#f87171"},{l:"Bonus à emploi",v:p.bonusEmploi,c:"#4ade80"},{l:"SALAIRE NET",v:p.net,c:"#4ade80"}].map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:i===6?"8px 0 0":"4px 0",borderTop:i===6?"2px solid rgba(198,163,78,.3)":"none",fontSize:i===6?13:12}}>
          <span style={{color:i===6?"#c6a34e":"#9e9b93"}}>{r.l}</span>
          <span style={{color:r.c,fontWeight:i===6?800:600}}>{r.v>=0?fmt(r.v):"-"+fmt(Math.abs(r.v))}</span>
        </div>)}
      </div>
      <div style={{marginTop:12,display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
        <div style={{padding:10,borderRadius:8,background:"rgba(248,113,113,.05)",border:"1px solid rgba(248,113,113,.1)"}}><div style={{fontSize:10,color:"#f87171"}}>ONSS patronal ({(TX_ONSS_E*100).toFixed(2)}%)</div><div style={{fontSize:16,fontWeight:700,color:"#f87171"}}>{fmt(p.onssE)}</div></div>
        <div style={{padding:10,borderRadius:8,background:"rgba(198,163,78,.05)",border:"1px solid rgba(198,163,78,.15)"}}><div style={{fontSize:10,color:"#c6a34e"}}>Coût total employeur</div><div style={{fontSize:16,fontWeight:700,color:"#c6a34e"}}>{fmt(p.coutTotal)}</div></div>
      </div>
    </C>}
    {tab==="detail"&&<C><ST>Détail calcul</ST>
      {[{l:"Quotité exemptée mensuelle",v:fmt(p.details.qe)},{l:"Déduction personnes à charge",v:fmt(p.details.chDed)},{l:"Base imposable PP",v:fmt(p.baseImp)},{l:"PP avant bonus",v:fmt(p.details.ppBrut)},{l:"Bonus à emploi",v:"-"+fmt(p.bonusEmploi)},{l:"PP final retenu",v:fmt(p.pp)},{l:"Taux PP effectif",v:p.details.tauxPP+"%"},{l:"Taux net/brut",v:p.details.tauxNet+"%"}].map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid rgba(255,255,255,.03)",fontSize:12}}><span style={{color:"#9e9b93"}}>{r.l}</span><span style={{color:"#c6a34e",fontWeight:600}}>{r.v}</span></div>)}
    </C>}
    {tab==="annuel"&&<C><ST>Projection annuelle</ST>
      {[{l:"Brut annuel",v:p.brut*(12+1+PV_DOUBLE)},{l:"Net annuel estimé",v:p.net*12+pd.net+t13.net},{l:"Coût total employeur/an",v:p.coutTotal*(12+1+PV_DOUBLE)}].map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}><span style={{color:"#9e9b93",fontSize:12}}>{r.l}</span><span style={{color:i===1?"#4ade80":i===2?"#c6a34e":"#e8e6e0",fontWeight:700}}>{fmt(r.v)}</span></div>)}</C>}
    {tab==="pecule"&&<C><ST>Pécule vacances double</ST>
      {[{l:"Base (92% du brut mensuel)",v:pd.base/12},{l:"ONSS",v:-pd.onss/12},{l:"PP 23.15%",v:-pd.pp/12},{l:"Net pécule double",v:pd.net/12}].map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:i===3?"2px solid rgba(74,222,128,.3)":"1px solid rgba(255,255,255,.03)",fontSize:12}}><span style={{color:"#9e9b93"}}>{r.l}</span><span style={{color:i===3?"#4ade80":r.v<0?"#f87171":"#e8e6e0",fontWeight:i===3?700:600}}>{r.v>=0?fmt(r.v):"-"+fmt(Math.abs(r.v))}</span></div>)}
      <ST>13ème mois</ST>
      {[{l:"Brut 13ème mois",v:t13.brut},{l:"ONSS",v:-t13.onss},{l:"PP 23.15%",v:-t13.pp},{l:"Net 13ème mois",v:t13.net}].map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:i===3?"2px solid rgba(74,222,128,.3)":"1px solid rgba(255,255,255,.03)",fontSize:12}}><span style={{color:"#9e9b93"}}>{r.l}</span><span style={{color:i===3?"#4ade80":r.v<0?"#f87171":"#e8e6e0",fontWeight:i===3?700:600}}>{r.v>=0?fmt(r.v):"-"+fmt(Math.abs(r.v))}</span></div>)}
    </C>}
  </div>;
}

// ═══ TreizMoisMod ═══
export function TreizMoisMod({s,d}){const ae=(s.emps||[]).filter(e=>e.status==='active'||!e.status);const n=ae.length;const empData=ae.map(e=>{const brut=+(e.gross||e.monthlySalary||0);const t13=calc13eMois(brut);return {...e,brut,treiz:t13.brut,onss:t13.onss,pp:t13.pp,net:t13.net};});const totalTreiz=empData.reduce((a,e)=>a+e.treiz,0);const totalNet=empData.reduce((a,e)=>a+e.net,0);const totalOnssP=Math.round(totalTreiz*TX_ONSS_E*100)/100;const f2=v=>new Intl.NumberFormat('fr-BE',{minimumFractionDigits:2}).format(v);return <div><PH title="13ème Mois et Prime de Fin d'Année" sub="Calcul réel via calc13eMois() — ONSS + PP formule-clé"/><div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,marginBottom:18}}>{[{l:"Travailleurs",v:n,c:"#c6a34e"},{l:"Total 13e brut",v:f2(totalTreiz)+" EUR",c:"#22c55e"},{l:"Coût employeur",v:f2(totalTreiz+totalOnssP)+" EUR",c:"#ef4444"},{l:"Total net",v:f2(totalNet)+" EUR",c:"#60a5fa"}].map((k,i)=><div key={i} style={{padding:"14px 16px",background:"rgba(198,163,78,.04)",borderRadius:10,border:"1px solid rgba(198,163,78,.08)"}}><div style={{fontSize:10,color:"#5e5c56",textTransform:"uppercase",letterSpacing:".5px"}}>{k.l}</div><div style={{fontSize:18,fontWeight:700,color:k.c,marginTop:4}}>{k.v}</div></div>)}</div><C><ST>Détail 13ème mois par travailleur</ST><div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}><thead><tr style={{borderBottom:"2px solid rgba(198,163,78,.2)"}}>{["Nom","Brut mensuel","13e brut","ONSS W","PP","Net 13e"].map(h=><th key={h} style={{padding:"8px 6px",textAlign:"left",color:"#c6a34e",fontWeight:600,fontSize:10}}>{h}</th>)}</tr></thead><tbody>{empData.map((e,i)=><tr key={e.id||i} style={{borderBottom:"1px solid rgba(255,255,255,.03)"}}><td style={{padding:"6px"}}>{(e.first||e.fn||'')+" "+(e.last||e.ln||'')}</td><td style={{padding:"6px"}}>{f2(e.brut)}</td><td style={{padding:"6px",fontWeight:600}}>{f2(e.treiz)}</td><td style={{padding:"6px",color:"#ef4444"}}>{f2(e.onss)}</td><td style={{padding:"6px",color:"#ef4444"}}>{f2(e.pp)}</td><td style={{padding:"6px",fontWeight:600,color:"#22c55e"}}>{f2(e.net)}</td></tr>)}</tbody></table></div></C></div>;}

// ═══ OffboardingMod ═══
export function OffboardingMod({s,d}){const ae=s.emps||[];const [tab,setTab]=useState("process");const [selEmp,setSelEmp]=useState(ae[0]?.id||"");const emp=ae.find(e=>e.id===selEmp)||ae[0]||{};const anc=emp.startDate?Math.max(0.25,((Date.now()-new Date(emp.startDate))/(365.25*24*3600*1000))):1;const brut=+emp.gross||3000;
const calcPreavis=(a,stat)=>{if(stat==="ouvrier"){if(a<0.25)return {sem:1,j:7};if(a<0.5)return {sem:2,j:14};if(a<1)return {sem:4,j:28};return {sem:Math.ceil(a*4),j:Math.ceil(a*4)*7};}if(a<0.25)return {sem:1,j:7};if(a<0.5)return {sem:3,j:21};if(a<1)return {sem:5,j:35};if(a<2)return {sem:7,j:49};if(a<3)return {sem:9,j:63};if(a<4)return {sem:12,j:84};if(a<5)return {sem:13,j:91};return {sem:Math.min(62,13+Math.ceil((a-5)*3)),j:Math.min(62,13+Math.ceil((a-5)*3))*7};};
const preavis=calcPreavis(anc,emp.statut||"employe");const indemnite=brut*preavis.sem/4.33;const coutLic=indemnite*1.35;
const [checks,setChecks]=useState({dimona:false,c4:false,soldeTout:false,attestation:false,vacances:false,materiel:false,access:false,exit:false});
const toggleCheck=(k2)=>setChecks(p2=>({...p2,[k2]:!p2[k2]}));const doneCount=Object.values(checks).filter(Boolean).length;
return <div><PH title="Offboarding" sub="Processus de sortie - Préavis - Solde de tout compte"/>
<div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:10,marginBottom:18}}>{[{l:"Ancienneté",v:anc.toFixed(1)+" ans",c:"#60a5fa"},{l:"Préavis",v:preavis.sem+" sem.",c:"#c6a34e"},{l:"Indemnité",v:fmt(indemnite),c:"#f87171"},{l:"Coût licenciement",v:fmt(coutLic),c:"#f87171"},{l:"Checklist",v:doneCount+"/8",c:doneCount===8?"#4ade80":"#fb923c"}].map((k,i)=><div key={i} style={{padding:"12px 14px",background:"rgba(198,163,78,.04)",borderRadius:10,border:"1px solid rgba(198,163,78,.08)"}}><div style={{fontSize:9,color:"#5e5c56",textTransform:"uppercase",letterSpacing:".5px"}}>{k.l}</div><div style={{fontSize:17,fontWeight:700,color:k.c,marginTop:4}}>{k.v}</div></div>)}</div>
<div style={{display:"flex",gap:6,marginBottom:16}}>{[{v:"process",l:"Processus"},{v:"preavis",l:"Calcul préavis"},{v:"solde",l:"Solde tout compte"},{v:"docs",l:"Documents"},{v:"checklist",l:"Checklist sortie"}].map(t=><button key={t.v} onClick={()=>setTab(t.v)} style={{padding:"8px 16px",borderRadius:8,border:"none",cursor:"pointer",fontSize:12,fontWeight:tab===t.v?600:400,fontFamily:"inherit",background:tab===t.v?"rgba(198,163,78,.15)":"rgba(255,255,255,.03)",color:tab===t.v?"#c6a34e":"#9e9b93"}}>{t.l}</button>)}</div>
{tab==="process"&&<C><ST>Processus de sortie en 8 étapes</ST>
{[{n:1,t:"Notification",d:"Lettre recommandée ou remise en main propre contre reçu.",c:"#f87171"},{n:2,t:"Dimona OUT",d:"Déclaration sortie via portail ONSS.",c:"#60a5fa"},{n:3,t:"Certificat C4",d:"Formulaire chômage obligatoire dans les 2 mois.",c:"#fb923c"},{n:4,t:"Solde de tout compte",d:"Calcul: salaire restant + préavis + vacances + 13e prorata.",c:"#c6a34e"},{n:5,t:"Attestation vacances",d:"Nombre jours pris/restants. Pécule vacances de sortie.",c:"#a78bfa"},{n:6,t:"Récupération matériel",d:"PC, GSM, voiture, badge, clés, cartes.",c:"#4ade80"},{n:7,t:"Coupure accès",d:"Email, VPN, logiciels, badges.",c:"#f87171"},{n:8,t:"Entretien de sortie",d:"Exit interview. Feedback, transfert connaissances.",c:"#60a5fa"}].map((r,i)=><div key={i} style={{display:"flex",gap:12,alignItems:"center",padding:"10px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}><div style={{width:32,height:32,borderRadius:"50%",background:r.c+"20",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14,fontWeight:700,color:r.c,flexShrink:0}}>{r.n}</div><div><b style={{color:r.c,fontSize:12}}>{r.t}</b><div style={{fontSize:10.5,color:"#9e9b93",marginTop:2}}>{r.d}</div></div></div>)}</C>}
{tab==="preavis"&&<C><ST>Calcul délai de préavis (Loi Statut Unique)</ST>
<div style={{marginBottom:12}}><div style={{fontSize:10,color:"#5e5c56",marginBottom:3}}>Travailleur</div><select value={selEmp} onChange={e2=>setSelEmp(e2.target.value)} style={{width:"100%",padding:"8px 10px",borderRadius:6,border:"1px solid rgba(198,163,78,.15)",background:"rgba(198,163,78,.04)",color:"#e8e6e0",fontSize:12,fontFamily:"inherit"}}>{ae.map(e2=><option key={e2.id} value={e2.id}>{(e2.fn||"")+" "+(e2.ln||"")}</option>)}</select></div>
{[{l:"Nom",v:(emp.fn||"")+" "+(emp.ln||"")},{l:"Ancienneté",v:anc.toFixed(1)+" ans"},{l:"Préavis employeur",v:preavis.sem+" semaines ("+preavis.j+" jours)"},{l:"Indemnité compensatoire",v:fmt(indemnite)},{l:"Coût total licenciement",v:fmt(coutLic)}].map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}><span style={{color:"#9e9b93"}}>{r.l}</span><span style={{fontWeight:600,color:"#e8e6e0"}}>{r.v}</span></div>)}</C>}
{tab==="solde"&&<C><ST>Solde de tout compte</ST>
{[{l:"Salaire restant (prorata)",v:brut*0.5,c:"#4ade80"},{l:"Indemnité compensatoire préavis",v:indemnite,c:"#fb923c"},{l:"Pécule vacances sortie",v:brut*PV_SIMPLE*(12-new Date().getMonth()),c:"#4ade80"},{l:"13ème mois prorata",v:brut*(new Date().getMonth()+1)/12,c:"#4ade80"},{l:"Retenue ONSS",v:-(brut*0.5+indemnite)*TX_ONSS_W,c:"#f87171"},{l:"Retenue précompte",v:-quickPP(brut*0.5+indemnite),c:"#f87171"}].map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}><span style={{color:"#9e9b93"}}>{r.l}</span><span style={{fontWeight:600,color:r.c}}>{r.v<0?"- "+fmt(Math.abs(r.v)):fmt(r.v)}</span></div>)}</C>}
{tab==="docs"&&<C><ST>Documents obligatoires sortie</ST>
{[{n:"C4 — Certificat de chômage",fn:()=>generateC4PDF(emp,s.co||s),col:"#ef4444"},{n:"Attestation d'emploi",fn:()=>generateAttestationEmploi(emp,s.co||s),col:"#60a5fa"},{n:"Attestation de salaire",fn:()=>generateAttestationSalaire(emp,s.co||s),col:"#60a5fa"},{n:"Solde de tout compte",fn:()=>generateSoldeCompte(emp,s.co||s),col:"#22c55e"}].map((doc,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}><span style={{color:"#e8e6e0",fontSize:12}}>{doc.n}</span><button onClick={doc.fn} style={{padding:"6px 14px",borderRadius:6,border:"none",background:"rgba(198,163,78,.1)",color:doc.col,fontSize:10,cursor:"pointer",fontWeight:600,fontFamily:"inherit"}}>Télécharger</button></div>)}</C>}
{tab==="checklist"&&<C><ST>Checklist de sortie ({doneCount}/8)</ST>
<div style={{height:6,background:"rgba(198,163,78,.1)",borderRadius:3,marginBottom:16,overflow:"hidden"}}><div style={{height:"100%",width:(doneCount/8*100)+"%",background:doneCount===8?"#4ade80":"#c6a34e",borderRadius:3,transition:"width .3s"}}/></div>
{[{k:"dimona",l:"Dimona OUT envoyée"},{k:"c4",l:"Certificat C4 remis"},{k:"soldeTout",l:"Solde tout compte calculé et versé"},{k:"attestation",l:"Attestation vacances remise"},{k:"vacances",l:"Pécule vacances de sortie versé"},{k:"materiel",l:"Matériel récupéré"},{k:"access",l:"Accès coupés"},{k:"exit",l:"Entretien de sortie réalisé"}].map((r,i)=><div key={i} onClick={()=>toggleCheck(r.k)} style={{display:"flex",gap:10,alignItems:"center",padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,.03)",cursor:"pointer"}}><div style={{width:20,height:20,borderRadius:5,border:"2px solid "+(checks[r.k]?"#4ade80":"#5e5c56"),background:checks[r.k]?"rgba(74,222,128,.15)":"transparent",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,color:"#4ade80"}}>{checks[r.k]?"V":""}</div><span style={{color:checks[r.k]?"#4ade80":"#e8e6e0",fontSize:12}}>{r.l}</span></div>)}</C>}
</div>;}
